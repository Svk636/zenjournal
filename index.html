<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<!-- PWA Core -->
<meta name="application-name" content="Zen Journal">
<meta name="description" content="A mindful trading journal — log trades, track rules, and grow.">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Zen Journal">
<meta name="theme-color" content="#060609">
<meta name="msapplication-TileColor" content="#060609">
<meta name="msapplication-navbutton-color" content="#060609">

<!-- Manifest -->
<link rel="manifest" href="#" id="pwa-manifest">

<!-- Icons (inline SVG via data URI — no external files needed) -->
<link rel="apple-touch-icon" sizes="180x180" id="pwa-icon-apple">
<link rel="icon" type="image/png" sizes="192x192" id="pwa-icon-192">
<link rel="icon" type="image/png" sizes="512x512" id="pwa-icon-512">
<link rel="shortcut icon" id="pwa-favicon">

<title>Zen Journal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;1,400;1,500&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --ink:    #060609;
  --paper:  #0c0c14;
  --lift:   #131320;
  --raise:  #1a1a2a;
  --rule:   rgba(255,255,255,0.055);
  --rule2:  rgba(255,255,255,0.11);
  --text:   #cccce0;
  --dim:    #5a5a78;
  --ghost:  #2a2a40;
  --green:  #4ade80;
  --red:    #f87171;
  --amber:  #d4a847;
  --amber2: #f0c96a;
  --cyan:   #22d3ee;
  --blue:   #6366f1;
  --g: 'EB Garamond','Garamond',Georgia,serif;
  --m: 'IBM Plex Mono','Courier New',monospace;
  --ease: cubic-bezier(0.16,1,0.3,1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--m);font-size:12px;line-height:1.65;background:var(--ink);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased;overflow-x:hidden}
::selection{background:rgba(212,168,71,0.2)}
::-webkit-scrollbar{width:1px}
::-webkit-scrollbar-thumb{background:var(--ghost)}

/* HEADER */
header{position:sticky;top:0;z-index:200;background:rgba(6,6,9,0.97);backdrop-filter:blur(24px) saturate(1.4);border-bottom:1px solid var(--rule);display:flex;align-items:center;padding:0 20px;height:50px;gap:0}
.h-mark{font-family:var(--g);font-size:19px;font-style:italic;color:var(--text);margin-right:24px;flex-shrink:0}
.h-mark b{font-style:normal;font-weight:500;color:var(--amber)}
nav{display:flex;flex:1;overflow-x:auto;scrollbar-width:none}
nav::-webkit-scrollbar{display:none}
.t{background:none;border:none;font-family:var(--m);font-size:9.5px;font-weight:400;letter-spacing:0.12em;text-transform:uppercase;color:var(--dim);padding:0 13px;height:50px;cursor:pointer;border-bottom:1.5px solid transparent;transition:color 0.12s,border-color 0.12s;white-space:nowrap;flex-shrink:0}
.t:hover{color:var(--text)}
.t.on{color:var(--amber2);border-bottom-color:var(--amber)}
.h-right{display:flex;align-items:center;gap:7px;margin-left:auto;flex-shrink:0}
.btn-add{background:var(--amber);color:var(--ink);border:none;font-family:var(--m);font-size:9px;font-weight:500;letter-spacing:0.1em;text-transform:uppercase;padding:6px 13px;border-radius:2px;cursor:pointer;transition:background 0.12s,transform 0.1s;white-space:nowrap}
.btn-add:hover{background:var(--amber2);transform:translateY(-1px)}
.btn-sm{background:none;border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:9px;letter-spacing:0.08em;padding:5px 10px;border-radius:2px;cursor:pointer;transition:border-color 0.12s,color 0.12s}
.btn-sm:hover{border-color:var(--rule2);color:var(--text)}

/* VIEWS */
main{max-width:1120px;margin:0 auto;padding:32px 20px 60px}
.v{display:none}
.v.on{display:block;animation:appear 0.2s var(--ease)}
@keyframes appear{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}

/* SECTION HEADING */
.sec-head{padding:32px 0 24px;border-bottom:1px solid var(--rule);margin-bottom:26px}
.sec-title{font-family:var(--g);font-size:26px;font-style:italic;color:var(--text);margin-bottom:5px}
.sec-sub{font-size:9px;color:var(--dim);letter-spacing:0.08em;text-transform:uppercase}

/* PANEL */
.panel{background:var(--paper);border:1px solid var(--rule);border-radius:3px;overflow:hidden;margin-bottom:14px}
.panel-h{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--rule)}
.panel-title{font-size:8.5px;text-transform:uppercase;letter-spacing:0.15em;color:var(--dim)}
.panel-body{padding:16px}

/* STAT ROW */
.stats{display:grid;grid-template-columns:repeat(5,1fr);gap:1px;background:var(--rule);border:1px solid var(--rule);border-radius:3px;overflow:hidden;margin-bottom:18px}
.stat{background:var(--paper);padding:18px 16px 14px}
.stat-l{font-size:8px;text-transform:uppercase;letter-spacing:0.15em;color:var(--dim);margin-bottom:7px}
.stat-v{font-size:21px;font-weight:300;letter-spacing:-0.02em;line-height:1;color:var(--text)}
.stat-v.g{color:var(--green)}.stat-v.r{color:var(--red)}.stat-v.a{color:var(--amber2)}
.stat-s{font-size:9px;color:var(--dim);margin-top:4px}
.streak-dots{display:flex;gap:2px;margin-top:5px}
.sd{width:5px;height:5px;border-radius:50%;background:var(--ghost)}
.sd.w{background:var(--green)}.sd.l{background:var(--red)}

/* QUESTION BLOCK */
.question-block{padding:36px 0 32px;border-bottom:1px solid var(--rule);margin-bottom:26px;display:flex;align-items:flex-start;justify-content:space-between;gap:20px}
.question-text{font-family:var(--g);font-size:30px;font-style:italic;font-weight:400;line-height:1.28;color:var(--text);max-width:540px}
.question-text em{font-style:normal;color:var(--amber2)}
.q-meta{text-align:right;flex-shrink:0}
.q-date{font-size:9px;color:var(--dim);letter-spacing:0.12em;text-transform:uppercase;margin-bottom:4px}
.q-count{font-size:26px;font-weight:300;color:var(--ghost);line-height:1;font-family:var(--g)}

/* MONTH STRIP */
.month-strip{display:grid;grid-template-columns:repeat(12,1fr);gap:1px;background:var(--rule);border:1px solid var(--rule);border-radius:3px;overflow:hidden;margin-bottom:14px}
.mc{background:var(--paper);padding:9px 6px;text-align:center}
.mc-l{font-size:7px;text-transform:uppercase;letter-spacing:0.1em;color:var(--dim);margin-bottom:4px}
.mc-v{font-size:10px;font-weight:400;letter-spacing:-0.01em}
.mc-v.g{color:var(--green)}.mc-v.r{color:var(--red)}.mc-v.z{color:var(--ghost)}

/* CHART */
canvas{display:block;width:100%}

/* HEATMAP */
.heatmap-outer{padding:14px 16px 12px;overflow-x:auto}
.hm-row{display:flex;gap:2px;margin-bottom:2px;align-items:center}
.hm-lbl{font-size:7px;color:var(--dim);width:20px;text-align:right;padding-right:4px;flex-shrink:0}
.hm-cell{width:12px;height:12px;border-radius:1px;background:var(--ghost);cursor:pointer;transition:transform 0.1s;flex-shrink:0;position:relative}
.hm-cell:hover{transform:scale(1.6);z-index:2}
.hm-cell.gS{background:rgba(74,222,128,0.18)}.hm-cell.gM{background:rgba(74,222,128,0.48)}.hm-cell.gL{background:rgba(74,222,128,0.88)}
.hm-cell.rS{background:rgba(248,113,113,0.18)}.hm-cell.rM{background:rgba(248,113,113,0.48)}.hm-cell.rL{background:rgba(248,113,113,0.88)}

/* TABLE */
.tbl-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse}
thead th{padding:8px 13px;text-align:left;font-size:8px;text-transform:uppercase;letter-spacing:0.14em;color:var(--dim);border-bottom:1px solid var(--rule);background:var(--lift);font-weight:400;cursor:pointer;user-select:none;white-space:nowrap}
thead th:hover{color:var(--text)}
tbody tr{border-bottom:1px solid var(--rule);cursor:pointer;transition:background 0.08s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:rgba(255,255,255,0.013)}
tbody td{padding:10px 13px;font-size:11px;color:var(--text);vertical-align:middle}
td.dim{color:var(--dim);font-size:10px}
td.sym{font-weight:500;letter-spacing:0.02em}
td.g{color:var(--green)}td.r{color:var(--red)}
td.lesson-cell{color:var(--amber);font-size:10px;font-style:italic;font-family:var(--g);max-width:200px}
.badge{display:inline-block;padding:1px 6px;border-radius:2px;font-size:8px;font-weight:500;letter-spacing:0.08em;text-transform:uppercase}
.bl{background:rgba(74,222,128,0.08);color:var(--green)}
.bs{background:rgba(248,113,113,0.08);color:var(--red)}
.bp{background:rgba(212,168,71,0.1);color:var(--amber2)}
.bc{background:rgba(34,211,238,0.1);color:var(--cyan)}
.rdots{display:flex;gap:2px}
.rdot{width:5px;height:5px;border-radius:50%;border:1px solid var(--rule2)}
.rdot.on{background:var(--amber);border-color:var(--amber)}

/* FILTERS */
.filters{display:flex;gap:7px;align-items:center;margin-bottom:14px;flex-wrap:wrap}
.fi{background:var(--paper);border:1px solid var(--rule);color:var(--text);font-family:var(--m);font-size:10px;padding:5px 9px;border-radius:2px;outline:none;transition:border-color 0.12s}
.fi:focus{border-color:var(--rule2)}
input.fi{width:120px}
select.fi option{background:var(--lift)}

/* SDIV */
.sdiv{display:flex;align-items:center;justify-content:space-between;margin-bottom:9px}
.sdiv-l{font-size:8px;text-transform:uppercase;letter-spacing:0.15em;color:var(--dim)}
.sdiv-r{background:none;border:none;font-family:var(--m);font-size:9px;color:var(--dim);cursor:pointer;transition:color 0.12s;letter-spacing:0.06em}
.sdiv-r:hover{color:var(--text)}

/* DASH GRID */
.dash-grid{display:grid;grid-template-columns:1fr 300px;gap:12px;margin-bottom:14px}

/* EMPTY */
.empty{text-align:center;padding:50px 20px;color:var(--dim)}
.empty-g{font-family:var(--g);font-style:italic;font-size:48px;opacity:0.14;display:block;margin-bottom:10px}
.empty-t{font-size:10px;line-height:1.8}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.86);backdrop-filter:blur(16px);z-index:500;display:flex;align-items:center;justify-content:center;padding:18px;opacity:0;pointer-events:none;transition:opacity 0.18s}
.overlay.on{opacity:1;pointer-events:all}
.modal{background:var(--paper);border:1px solid var(--rule2);border-radius:4px;width:100%;max-width:580px;max-height:92vh;overflow-y:auto;transform:translateY(13px) scale(0.985);transition:transform 0.23s var(--ease);box-shadow:0 48px 120px rgba(0,0,0,0.85)}
.overlay.on .modal{transform:translateY(0) scale(1)}
.modal-h{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--rule);position:sticky;top:0;background:var(--paper);z-index:2}
.modal-title{font-family:var(--g);font-size:20px;font-style:italic;color:var(--text)}
.modal-x{background:none;border:none;color:var(--dim);font-size:18px;cursor:pointer;transition:color 0.12s;line-height:1}
.modal-x:hover{color:var(--text)}
.modal-b{padding:18px 20px 20px}

/* CHECKLIST */
.cl-block{background:var(--ink);border:1px solid var(--rule);border-radius:2px;padding:11px 14px;margin-bottom:16px}
.cl-head{font-size:8px;text-transform:uppercase;letter-spacing:0.15em;color:var(--dim);margin-bottom:8px}
.cl-row{display:flex;align-items:center;gap:8px;padding:3px 0;cursor:pointer}
.cl-box{width:11px;height:11px;border:1px solid var(--rule2);border-radius:1px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:7px;transition:all 0.12s}
.cl-row.ck .cl-box{background:var(--green);border-color:var(--green);color:var(--ink)}
.cl-txt{font-size:10px;color:var(--dim);transition:color 0.12s}
.cl-row.ck .cl-txt{color:var(--text);text-decoration:line-through;text-decoration-color:var(--dim)}

/* FORM */
.fg{display:grid;grid-template-columns:1fr 1fr;gap:11px}
.f{display:flex;flex-direction:column;gap:4px}
.f.full{grid-column:1/-1}
.fl{font-size:8px;text-transform:uppercase;letter-spacing:0.14em;color:var(--dim)}
.fi2,.fs2,.fta{background:var(--ink);border:1px solid var(--rule);color:var(--text);font-family:var(--m);font-size:12px;padding:7px 10px;border-radius:2px;outline:none;width:100%;transition:border-color 0.12s}
.fi2:focus,.fs2:focus,.fta:focus{border-color:var(--amber)}
.fta{resize:vertical;min-height:68px;font-size:11px;line-height:1.65}
.fs2 option{background:var(--lift)}
.pnl-box{background:var(--ink);border:1px solid var(--rule);border-radius:2px;height:100%;min-height:50px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:9px}
.pnl-big{font-size:24px;font-weight:300;letter-spacing:-0.02em;line-height:1;margin-bottom:2px}
.pnl-big.g{color:var(--green)}.pnl-big.r{color:var(--red)}
.pnl-lbl{font-size:8px;text-transform:uppercase;letter-spacing:0.1em;color:var(--dim)}
.r-box{background:var(--ink);border:1px solid var(--rule);border-radius:2px;padding:7px 10px;text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center}
.r-val{font-size:16px;font-weight:300;color:var(--text);line-height:1;margin-bottom:2px}
.r-lbl{font-size:7px;color:var(--dim);text-transform:uppercase;letter-spacing:0.1em}
.rating-row{display:flex;align-items:center;gap:8px}
.rating-dot{width:20px;height:20px;border-radius:50%;border:1px solid var(--rule2);cursor:pointer;background:none;transition:all 0.12s;font-size:7px;font-family:var(--m);color:var(--dim);display:flex;align-items:center;justify-content:center}
.rating-dot:hover{border-color:var(--amber);color:var(--amber)}
.rating-dot.on{background:var(--amber);border-color:var(--amber);color:var(--ink)}
.rating-hint{font-size:9px;color:var(--dim);font-style:italic;font-family:var(--g);margin-left:3px}
.pass-toggle{display:flex;align-items:center;gap:9px;padding:9px 11px;background:var(--ink);border:1px solid var(--rule);border-radius:2px;cursor:pointer;transition:border-color 0.12s;margin-bottom:14px}
.pass-toggle:hover{border-color:var(--rule2)}
.toggle-track{width:26px;height:13px;background:var(--ghost);border-radius:7px;position:relative;transition:background 0.15s;flex-shrink:0}
.toggle-track::after{content:'';position:absolute;left:2px;top:2px;width:9px;height:9px;background:var(--dim);border-radius:50%;transition:left 0.15s,background 0.15s}
.pass-toggle.ck .toggle-track{background:rgba(212,168,71,0.2)}
.pass-toggle.ck .toggle-track::after{left:15px;background:var(--amber)}
.toggle-label{font-size:10px;color:var(--dim);transition:color 0.12s}
.pass-toggle.ck .toggle-label{color:var(--amber2)}
.toggle-sub{font-size:9px;color:var(--ghost);margin-left:auto;font-style:italic;font-family:var(--g)}
.ff{display:flex;gap:7px;justify-content:flex-end;margin-top:16px;padding-top:13px;border-top:1px solid var(--rule)}
.btn-cancel{background:none;border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:9px;padding:6px 12px;border-radius:2px;cursor:pointer;transition:all 0.12s}
.btn-cancel:hover{border-color:var(--rule2);color:var(--text)}
.btn-save{background:var(--amber);color:var(--ink);border:none;font-family:var(--m);font-size:9px;font-weight:500;letter-spacing:0.08em;padding:6px 18px;border-radius:2px;cursor:pointer;transition:background 0.12s}
.btn-save:hover{background:var(--amber2)}

/* DETAIL */
.detail-g{display:grid;grid-template-columns:1fr 1fr;gap:11px;margin-bottom:16px}
.dl{font-size:8px;text-transform:uppercase;letter-spacing:0.12em;color:var(--dim);margin-bottom:3px}
.dv{font-size:13px;color:var(--text)}
.d-section{margin-bottom:18px;padding-bottom:18px;border-bottom:1px solid var(--rule)}
.d-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.d-head{font-size:8px;text-transform:uppercase;letter-spacing:0.15em;color:var(--dim);margin-bottom:9px}
.d-text{font-size:12px;line-height:1.75;color:var(--text)}
.d-lesson{font-family:var(--g);font-style:italic;font-size:16px;line-height:1.6;color:var(--amber2)}
.d-pass-label{display:inline-block;padding:3px 8px;background:rgba(212,168,71,0.1);color:var(--amber2);border-radius:2px;font-size:8px;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:7px}

/* TOAST */
.toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(14px);background:var(--lift);border:1px solid var(--rule2);border-radius:2px;padding:8px 16px;font-size:10px;color:var(--text);letter-spacing:0.06em;opacity:0;pointer-events:none;transition:all 0.22s var(--ease);z-index:999;white-space:nowrap}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}

/* API SETTINGS */
.api-row{display:flex;align-items:flex-start;gap:12px;margin-bottom:14px}
.api-label-col{min-width:140px;padding-top:9px}
.api-label{font-size:9px;text-transform:uppercase;letter-spacing:0.12em;color:var(--dim)}
.api-name{font-size:11px;color:var(--text);margin-bottom:2px}
.api-dot{width:6px;height:6px;border-radius:50%;background:var(--dim);display:inline-block;margin-right:5px;vertical-align:middle}
.api-dot.live{background:var(--green)}
.live-badge{display:inline-flex;align-items:center;gap:4px;font-size:8px;letter-spacing:0.1em;color:var(--green);text-transform:uppercase}
.live-pulse{width:5px;height:5px;border-radius:50%;background:var(--green);animation:pulse 1.4s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}

/* LIVE MARKET ROWS */
.lm-section{background:var(--paper);border:1px solid var(--rule);border-radius:3px;overflow:hidden;margin-bottom:12px}
.lm-sec-head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--rule);background:var(--lift)}
.lm-sec-head>span:first-child{font-size:9px;text-transform:uppercase;letter-spacing:0.13em;color:var(--dim);font-weight:400}
.lm-list{}
.lm-row{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;border-bottom:1px solid var(--rule);transition:background 0.08s}
.lm-row:last-child{border-bottom:none}
.lm-row:hover{background:rgba(255,255,255,0.012)}
.lm-row-loading{padding:14px;font-size:10px;color:var(--dim);text-align:center}
.lm-icon{width:30px;height:30px;border-radius:50%;background:var(--ghost);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;margin-right:10px}
.lm-left{display:flex;align-items:center}
.lm-name{font-size:12px;font-weight:500;color:var(--text);letter-spacing:0.01em}
.lm-sub{font-size:9px;color:var(--dim);margin-top:1px}
.lm-right{text-align:right;flex-shrink:0}
.lm-price{font-size:13px;font-weight:400;color:var(--text);letter-spacing:-0.01em}
.lm-chg{font-size:10px;margin-top:1px}
.lm-chg.g{color:var(--green)}.lm-chg.r{color:var(--red)}.lm-chg.z{color:var(--dim)}
.lm-arr{font-size:8px;margin-right:2px}
.lm-tab{background:none;border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:9px;letter-spacing:0.08em;padding:4px 10px;border-radius:2px;cursor:pointer;transition:all 0.12s}
.lm-tab.on{background:rgba(212,168,71,0.1);border-color:var(--amber);color:var(--amber2)}

/* RESPONSIVE live grid */
@media(max-width:780px){
  #v-live .sec-head+div[style*="grid"]{grid-template-columns:1fr!important}
}

/* TICKER STRIP */
.ticker-strip{background:var(--lift);border-top:1px solid var(--rule);border-bottom:1px solid var(--rule);padding:7px 0;margin-bottom:16px;overflow:hidden;position:relative}
.ticker-inner{display:flex;gap:28px;animation:ticker 40s linear infinite;width:max-content}
.ticker-strip:hover .ticker-inner{animation-play-state:paused}
@keyframes ticker{from{transform:translateX(0)}to{transform:translateX(-50%)}}
.tick-item{display:flex;align-items:center;gap:7px;flex-shrink:0;font-size:10px}
.tick-sym{color:var(--text);font-weight:500}
.tick-price{color:var(--dim)}
.tick-chg{font-size:9px}
.tick-chg.g{color:var(--green)}.tick-chg.r{color:var(--red)}

/* PREMARKET GRID */
.premarket-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.pm-type-btn{background:var(--paper);border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:9px;letter-spacing:0.08em;padding:5px 12px;border-radius:2px;cursor:pointer;transition:all 0.12s;white-space:nowrap}
.pm-type-btn:hover{border-color:var(--rule2);color:var(--text)}
.pm-type-btn.on{background:rgba(212,168,71,0.08);border-color:rgba(212,168,71,0.3);color:var(--amber2)}
.checklist-section .cl-row{padding:5px 0}
.pm-textarea{width:100%;background:var(--ink);border:1px solid var(--rule);color:var(--text);font-family:var(--m);font-size:11px;padding:10px 12px;border-radius:2px;outline:none;resize:vertical;min-height:80px;line-height:1.65;transition:border-color 0.12s}
.pm-textarea:focus{border-color:var(--amber)}
.pm-save-btn{background:var(--amber);color:var(--ink);border:none;font-family:var(--m);font-size:9px;font-weight:500;letter-spacing:0.08em;padding:7px 16px;border-radius:2px;cursor:pointer;transition:background 0.12s;margin-top:10px}
.pm-save-btn:hover{background:var(--amber2)}

/* PSYCHOLOGY SLIDERS */
.psy-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px}
.psy-item{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:14px}
.psy-label{font-size:9px;text-transform:uppercase;letter-spacing:0.12em;color:var(--dim);margin-bottom:10px}
.psy-slider{width:100%;-webkit-appearance:none;height:2px;background:var(--ghost);border-radius:1px;outline:none;margin-bottom:8px}
.psy-slider::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--amber);cursor:pointer;border:2px solid var(--ink)}
.psy-val{font-size:20px;font-weight:300;color:var(--text)}
.mood-dots{display:flex;gap:5px;margin-top:10px}
.mood-dot{width:28px;height:28px;border-radius:50%;border:1px solid var(--rule);background:var(--lift);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:all 0.12s}
.mood-dot:hover{border-color:var(--rule2);transform:scale(1.1)}
.mood-dot.on{border-color:var(--amber);background:rgba(212,168,71,0.15)}

/* PHILOSOPHY */
.quote-card{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:28px;text-align:center;margin-bottom:14px}
.quote-text{font-family:var(--g);font-size:22px;font-style:italic;line-height:1.5;color:var(--text);margin-bottom:14px}
.quote-attr{font-size:9px;text-transform:uppercase;letter-spacing:0.18em;color:var(--dim)}
.quote-nav{display:flex;align-items:center;justify-content:center;gap:14px}
.quote-btn{background:none;border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:11px;width:30px;height:30px;border-radius:2px;cursor:pointer;transition:all 0.12s;display:flex;align-items:center;justify-content:center}
.quote-btn:hover{border-color:var(--rule2);color:var(--text)}
.quote-idx{font-size:9px;color:var(--dim)}

/* PHILOSOPHY REDESIGN */
.phil-hero{padding:28px 0 22px;border-bottom:1px solid var(--rule);margin-bottom:28px}
.phil-hero-title{font-family:var(--g);font-size:28px;font-weight:400;font-style:italic;color:var(--text);margin-bottom:5px}
.phil-hero-title span{color:var(--amber2);font-style:normal}
.phil-hero-sub{font-size:9px;color:var(--dim);letter-spacing:0.08em;text-transform:uppercase}

/* Principle cards grid */
.phil-principles{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:28px}
@media(max-width:700px){.phil-principles{grid-template-columns:1fr}}
.phil-card{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:20px 18px 18px;transition:border-color 0.15s}
.phil-card:hover{border-color:var(--rule2)}
.phil-card-icon{font-size:22px;margin-bottom:12px}
.phil-card-title{font-size:12px;font-weight:500;color:var(--text);margin-bottom:8px;letter-spacing:0.01em}
.phil-card-body{font-size:11px;color:var(--dim);line-height:1.7}

/* Split philosophy columns */
.phil-split{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:28px}
@media(max-width:700px){.phil-split{grid-template-columns:1fr}}
.phil-col{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:18px}
.phil-col-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding-bottom:11px;border-bottom:1px solid var(--rule)}
.phil-col-title{display:flex;align-items:center;gap:7px;font-size:11px;font-weight:500;color:var(--text)}
.phil-col-sub{font-size:9px;color:var(--ghost);letter-spacing:0.06em}
.phil-point{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--rule);font-size:11px;color:var(--dim);line-height:1.6}
.phil-point:last-child{border-bottom:none}
.phil-arrow{color:var(--amber);flex-shrink:0;margin-top:2px;font-size:10px}

/* Mental models table */
.phil-models-wrap{margin-bottom:28px}
.phil-section-head{display:flex;align-items:center;gap:9px;margin-bottom:14px}
.phil-section-icon{font-size:16px}
.phil-section-title{font-size:13px;font-weight:500;color:var(--text)}
.models-table{width:100%;border-collapse:collapse;background:var(--paper);border:1px solid var(--rule);border-radius:3px;overflow:hidden}
.models-table thead th{background:var(--lift);padding:10px 14px;text-align:left;font-size:8px;text-transform:uppercase;letter-spacing:0.15em;color:var(--dim);font-weight:400;border-bottom:1px solid var(--rule)}
.models-table tbody tr{border-bottom:1px solid var(--rule)}
.models-table tbody tr:last-child{border-bottom:none}
.models-table tbody tr:hover{background:rgba(255,255,255,0.013)}
.models-table td{padding:12px 14px;font-size:11px;color:var(--dim);vertical-align:top;line-height:1.65}
.models-table td:first-child{color:var(--amber2);font-weight:500;white-space:nowrap;width:130px}
.models-table td:last-child{color:var(--red);font-size:10px}

/* Cognitive biases */
.phil-biases{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:28px}
@media(max-width:700px){.phil-biases{grid-template-columns:1fr}}
.bias-card{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:16px}
.bias-card:hover{border-color:var(--rule2)}
.bias-title{font-size:11px;font-weight:500;margin-bottom:7px;display:flex;align-items:center;gap:6px}
.bias-body{font-size:10px;color:var(--dim);line-height:1.65}

/* ── DAILY REVIEW ── */
.dr-layout{display:grid;grid-template-columns:1fr 310px;gap:14px;align-items:start}
@media(max-width:820px){.dr-layout{grid-template-columns:1fr}}
.dr-hero{display:flex;align-items:center;justify-content:space-between;padding:26px 0 20px;border-bottom:1px solid var(--rule);margin-bottom:22px;flex-wrap:wrap;gap:12px}
.dr-hero-left .dr-title{font-family:var(--g);font-size:27px;font-style:italic;color:var(--text)}
.dr-hero-left .dr-title span{color:var(--amber2);font-style:normal}
.dr-hero-left .dr-sub{font-size:9px;color:var(--dim);letter-spacing:0.08em;margin-top:3px}
.dr-date-row{display:flex;align-items:center;gap:7px}
.dr-date-input{background:var(--paper);border:1px solid var(--rule);color:var(--text);font-family:var(--m);font-size:10px;padding:7px 11px;border-radius:2px;outline:none;cursor:pointer;transition:border-color 0.12s}
.dr-date-input:focus{border-color:var(--rule2)}
.dr-nav-arrow{background:none;border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:12px;width:28px;height:28px;border-radius:2px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.12s}
.dr-nav-arrow:hover{border-color:var(--rule2);color:var(--text)}
.dr-today-btn{background:none;border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:9px;letter-spacing:0.08em;padding:6px 11px;border-radius:2px;cursor:pointer;transition:all 0.12s}
.dr-today-btn:hover{border-color:rgba(212,168,71,0.4);color:var(--amber2)}
.dr-sitout-bar{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:16px 18px;margin-bottom:14px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.dr-sitout-stat{text-align:center;min-width:66px}
.dr-sitout-n{font-size:32px;font-weight:300;color:var(--ghost);line-height:1;font-family:var(--g)}
.dr-sitout-n.has{color:var(--amber2)}
.dr-sitout-l{font-size:7.5px;text-transform:uppercase;letter-spacing:0.13em;color:var(--dim);margin-top:4px}
.dr-sitout-quote{flex:1;font-family:var(--g);font-size:13px;font-style:italic;color:var(--dim);line-height:1.55;border-left:2px solid var(--rule);padding-left:14px}
.dr-sitout-quote cite{display:block;font-size:9px;font-style:normal;color:var(--ghost);margin-top:5px;letter-spacing:0.06em}
.dr-sitout-action{margin-left:auto}
.dr-sitout-btn{background:rgba(212,168,71,0.06);border:1px solid rgba(212,168,71,0.18);color:var(--amber2);font-family:var(--m);font-size:9px;letter-spacing:0.08em;padding:7px 13px;border-radius:2px;cursor:pointer;transition:all 0.12s;white-space:nowrap}
.dr-sitout-btn:hover{background:rgba(212,168,71,0.12);border-color:rgba(212,168,71,0.4)}
.dr-sitout-btn.marked{background:rgba(248,113,113,0.08);border-color:rgba(248,113,113,0.28);color:var(--red)}
.dr-panel{background:var(--paper);border:1px solid var(--rule);border-radius:3px;margin-bottom:14px;overflow:hidden}
.dr-panel-head{display:flex;align-items:center;justify-content:space-between;padding:13px 16px 12px;border-bottom:1px solid var(--rule)}
.dr-panel-title{display:flex;align-items:center;gap:7px;font-size:11px;font-weight:500;color:var(--text)}
.dr-panel-meta{font-size:9px;color:var(--ghost);letter-spacing:0.05em;font-style:italic}
.dr-panel-body{padding:16px}
.dr-q-label{font-size:10px;font-weight:500;margin-bottom:6px;letter-spacing:0.01em}
.dr-q-label.win{color:var(--green)}.dr-q-label.loss{color:var(--red)}.dr-q-label.tmr{color:var(--cyan)}.dr-q-label.focus{color:var(--amber2)}
.dr-textarea{width:100%;background:var(--lift);border:1px solid var(--rule);border-radius:2px;color:var(--text);font-family:var(--m);font-size:11px;line-height:1.65;padding:10px 12px;resize:vertical;outline:none;min-height:72px;transition:border-color 0.12s}
.dr-textarea:focus{border-color:var(--rule2)}.dr-textarea::placeholder{color:var(--ghost)}
.dr-q-group{margin-bottom:14px}.dr-q-group:last-child{margin-bottom:0}
.dr-rating-row{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.dr-rating-label{font-size:9px;color:var(--dim);letter-spacing:0.08em;text-transform:uppercase;min-width:90px}
.dr-stars{display:flex;gap:4px}
.dr-star{font-size:18px;cursor:pointer;transition:transform 0.1s;opacity:0.22;line-height:1}
.dr-star.on{opacity:1}.dr-star:hover{transform:scale(1.2)}
.dr-rating-desc{font-size:9px;color:var(--dim);font-style:italic;margin-left:4px}
.dr-emotions{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.dr-em-chip{background:var(--lift);border:1px solid var(--rule);border-radius:20px;padding:5px 11px;font-size:10px;color:var(--dim);cursor:pointer;transition:all 0.12s;user-select:none;display:flex;align-items:center;gap:4px}
.dr-em-chip:hover{border-color:var(--rule2);color:var(--text)}
.dr-em-chip.on{border-color:rgba(212,168,71,0.4);background:rgba(212,168,71,0.07);color:var(--amber2)}
.dr-em-chip.neg.on{border-color:rgba(248,113,113,0.35);background:rgba(248,113,113,0.06);color:var(--red)}
.dr-em-chip.pos.on{border-color:rgba(74,222,128,0.35);background:rgba(74,222,128,0.06);color:var(--green)}
.dr-regime-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.dr-regime-btn{background:none;border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:9px;padding:5px 10px;border-radius:2px;cursor:pointer;transition:all 0.12s;letter-spacing:0.05em}
.dr-regime-btn:hover{border-color:var(--rule2);color:var(--text)}
.dr-regime-btn.on{background:rgba(212,168,71,0.08);border-color:rgba(212,168,71,0.3);color:var(--amber2)}
.dr-save-bar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-top:1px solid var(--rule);background:var(--lift)}
.dr-save-status{font-size:9px;color:var(--dim);font-style:italic}
.dr-save-status.saved{color:var(--green)}
.dr-save-btn{background:var(--amber);color:var(--ink);border:none;font-family:var(--m);font-size:9px;font-weight:500;letter-spacing:0.1em;text-transform:uppercase;padding:7px 18px;border-radius:2px;cursor:pointer;transition:background 0.12s}
.dr-save-btn:hover{background:var(--amber2)}
.dr-glance-row{display:flex;justify-content:space-between;align-items:baseline;padding:8px 0;border-bottom:1px solid var(--rule);font-size:11px}
.dr-glance-row:last-child{border-bottom:none}
.dr-glance-label{color:var(--dim);font-size:10px}
.dr-glance-val{font-weight:500}
.dr-review-item{padding:10px 0;border-bottom:1px solid var(--rule);cursor:pointer;transition:opacity 0.12s}
.dr-review-item:hover{opacity:0.7}.dr-review-item:last-child{border-bottom:none}
.dr-review-date{font-size:9px;color:var(--dim);letter-spacing:0.08em;margin-bottom:3px}
.dr-review-snippet{font-size:11px;color:var(--text);line-height:1.5;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dr-review-chips{display:flex;gap:3px;margin-top:5px;flex-wrap:wrap}
.dr-rv-chip{font-size:8px;padding:1px 6px;border-radius:2px;background:rgba(212,168,71,0.08);color:var(--amber2)}
.dr-rv-chip.r{background:rgba(248,113,113,0.08);color:var(--red)}.dr-rv-chip.g{background:rgba(74,222,128,0.08);color:var(--green)}
.dr-habits{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.dr-habit{display:flex;align-items:center;gap:8px;background:var(--lift);border:1px solid var(--rule);border-radius:2px;padding:9px 11px;cursor:pointer;transition:border-color 0.12s;user-select:none}
.dr-habit:hover{border-color:var(--rule2)}
.dr-habit.on{border-color:rgba(74,222,128,0.3);background:rgba(74,222,128,0.04)}
.dr-habit-icon{font-size:14px}.dr-habit-label{font-size:10px;color:var(--dim);flex:1;line-height:1.3}
.dr-habit.on .dr-habit-label{color:var(--text)}
.dr-habit-check{width:14px;height:14px;border-radius:50%;border:1px solid var(--rule);display:flex;align-items:center;justify-content:center;font-size:8px;flex-shrink:0;transition:all 0.12s}
.dr-habit.on .dr-habit-check{background:var(--green);border-color:var(--green);color:var(--ink)}
.dr-streak-row{display:flex;gap:2px;flex-wrap:wrap;margin-top:10px}
.dr-sq{width:18px;height:18px;border-radius:2px;background:var(--ghost);cursor:default;transition:transform 0.1s;position:relative;flex-shrink:0}
.dr-sq:hover{transform:scale(1.4);z-index:5}
.dr-sq.g{background:rgba(74,222,128,0.6)}.dr-sq.a{background:rgba(212,168,71,0.55)}.dr-sq.r{background:rgba(248,113,113,0.55)}.dr-sq.s{background:rgba(99,102,241,0.35)}
.dr-insight{background:rgba(212,168,71,0.04);border:1px solid rgba(212,168,71,0.14);border-radius:3px;padding:14px 16px;margin-top:12px}
.dr-insight-head{font-size:8.5px;text-transform:uppercase;letter-spacing:0.14em;color:var(--amber);margin-bottom:7px;display:flex;align-items:center;gap:6px}
.dr-insight-body{font-size:11px;color:var(--dim);line-height:1.75}
.dr-insight-body strong{color:var(--amber2);font-weight:500}
.dr-score-ring{position:relative;width:70px;height:70px;flex-shrink:0}
.dr-score-ring svg{transform:rotate(-90deg)}
.dr-score-num{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:18px;font-weight:300;line-height:1}
.dr-score-lbl{position:absolute;bottom:4px;left:50%;transform:translateX(-50%);font-size:7px;text-transform:uppercase;letter-spacing:0.1em;color:var(--dim);white-space:nowrap}
.dr-score-wrap{display:flex;align-items:center;gap:16px;padding:14px 16px}
.dr-score-breakdown{flex:1}
.dr-sb-row{display:flex;align-items:center;gap:8px;margin-bottom:7px}
.dr-sb-row:last-child{margin-bottom:0}
.dr-sb-label{font-size:9px;color:var(--dim);min-width:100px}
.dr-sb-bar{flex:1;height:4px;background:var(--ghost);border-radius:2px;overflow:hidden}
.dr-sb-fill{height:100%;border-radius:2px;transition:width 0.5s var(--ease)}
.dr-sb-val{font-size:9px;color:var(--dim);min-width:24px;text-align:right}
.dr-empty-state{text-align:center;padding:24px 12px;color:var(--dim);font-size:11px;line-height:1.7}
.dr-empty-icon{font-size:24px;margin-bottom:8px}

/* ── LEARNING ── */
.lrn-tabs{display:flex;gap:6px;margin-bottom:24px;flex-wrap:wrap}
.lt{background:none;border:1px solid var(--rule);border-radius:3px;font-family:var(--m);font-size:9px;font-weight:400;letter-spacing:0.1em;text-transform:uppercase;color:var(--dim);padding:8px 16px;cursor:pointer;transition:all 0.14s;white-space:nowrap;display:flex;align-items:center;gap:6px}
.lt:hover{border-color:var(--rule2);color:var(--text)}
.lt.on{background:rgba(212,168,71,0.08);border-color:rgba(212,168,71,0.3);color:var(--amber2)}
.lt-count{background:var(--ghost);color:var(--dim);font-size:8px;padding:1px 5px;border-radius:10px;min-width:16px;text-align:center;transition:all 0.14s}
.lt.on .lt-count{background:rgba(212,168,71,0.2);color:var(--amber2)}
.lrn-pane{display:none}
.lrn-pane.on{display:block;animation:appear 0.18s var(--ease)}
.lrn-toolbar{display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.lrn-search{background:var(--paper);border:1px solid var(--rule);color:var(--text);font-family:var(--m);font-size:10px;padding:7px 12px;border-radius:2px;outline:none;width:200px;transition:border-color 0.12s}
.lrn-search:focus{border-color:var(--rule2)}
.lrn-search::placeholder{color:var(--ghost)}
.lrn-filter{background:var(--paper);border:1px solid var(--rule);color:var(--text);font-family:var(--m);font-size:10px;padding:7px 10px;border-radius:2px;outline:none;transition:border-color 0.12s;cursor:pointer}
.lrn-filter:focus{border-color:var(--rule2)}
.lrn-filter option{background:var(--lift)}
.lrn-add-btn{background:var(--amber);color:var(--ink);border:none;font-family:var(--m);font-size:9px;font-weight:500;letter-spacing:0.1em;text-transform:uppercase;padding:7px 16px;border-radius:2px;cursor:pointer;transition:background 0.12s;margin-left:auto}
.lrn-add-btn:hover{background:var(--amber2)}

.book-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.book-card{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:16px;transition:border-color 0.14s;cursor:pointer;position:relative}
.book-card:hover{border-color:var(--rule2)}
.book-spine{width:38px;height:54px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:11px;flex-shrink:0}
.book-title{font-size:11px;font-weight:500;color:var(--text);margin-bottom:3px;line-height:1.4}
.book-author{font-size:9.5px;color:var(--dim);margin-bottom:8px}
.book-tags{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px}
.book-tag{font-size:8px;padding:2px 7px;border-radius:2px;background:rgba(212,168,71,0.07);color:var(--amber2);letter-spacing:0.04em}
.book-tag.done{background:rgba(74,222,128,0.07);color:var(--green)}
.book-tag.reading{background:rgba(34,211,238,0.07);color:var(--cyan)}
.book-tag.want{background:rgba(99,102,241,0.07);color:var(--blue)}
.book-rating{display:flex;gap:2px;margin-bottom:8px}
.book-star{font-size:10px;opacity:0.22}.book-star.on{opacity:1;color:var(--amber2)}
.book-key-insight{font-size:10px;color:var(--dim);line-height:1.6;font-style:italic;border-left:2px solid var(--rule);padding-left:8px;margin-top:8px}
.book-del{position:absolute;top:10px;right:10px;background:none;border:none;color:var(--ghost);font-size:13px;cursor:pointer;opacity:0;transition:opacity 0.12s,color 0.12s}
.book-card:hover .book-del{opacity:1}.book-del:hover{color:var(--red)}

/* Mentors */
.mentor-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.mentor-card{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:18px;transition:border-color 0.14s;cursor:pointer;position:relative}
.mentor-card:hover{border-color:var(--rule2)}
.mentor-avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;margin-bottom:12px;border:1px solid var(--rule)}
.mentor-name{font-size:13px;font-weight:500;color:var(--text);margin-bottom:2px}
.mentor-title{font-size:9.5px;color:var(--dim);margin-bottom:10px}
.mentor-tags{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:10px}
.mentor-tag{font-size:8px;padding:2px 7px;border-radius:2px;background:rgba(99,102,241,0.08);color:var(--blue);letter-spacing:0.04em}
.mentor-lesson{font-size:10.5px;color:var(--dim);line-height:1.65;margin-bottom:10px}
.mentor-link{font-size:9px;color:var(--amber);letter-spacing:0.06em;text-decoration:none;transition:color 0.12s}
.mentor-link:hover{color:var(--amber2)}
.mentor-del{position:absolute;top:12px;right:12px;background:none;border:none;color:var(--ghost);font-size:13px;cursor:pointer;opacity:0;transition:opacity 0.12s,color 0.12s}
.mentor-card:hover .mentor-del{opacity:1}.mentor-del:hover{color:var(--red)}

/* Resources */
.res-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
.res-card{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:14px 16px;transition:border-color 0.14s;position:relative;display:flex;flex-direction:column;gap:6px}
.res-card:hover{border-color:var(--rule2)}
.res-type-row{display:flex;align-items:center;justify-content:space-between}
.res-type{font-size:8px;text-transform:uppercase;letter-spacing:0.14em;padding:2px 7px;border-radius:2px;font-weight:500}
.res-type.video{background:rgba(248,113,113,0.08);color:var(--red)}
.res-type.podcast{background:rgba(99,102,241,0.08);color:var(--blue)}
.res-type.article{background:rgba(34,211,238,0.08);color:var(--cyan)}
.res-type.course{background:rgba(74,222,128,0.08);color:var(--green)}
.res-type.tool{background:rgba(212,168,71,0.08);color:var(--amber2)}
.res-type.community{background:rgba(255,255,255,0.05);color:var(--dim)}
.res-fav{background:none;border:none;color:var(--ghost);font-size:12px;cursor:pointer;transition:color 0.12s;padding:0}
.res-fav.on{color:var(--amber2)}
.res-title{font-size:11px;font-weight:500;color:var(--text);line-height:1.4}
.res-desc{font-size:10px;color:var(--dim);line-height:1.6}
.res-link{font-size:9px;color:var(--amber);text-decoration:none;letter-spacing:0.04em;transition:color 0.12s;margin-top:2px}
.res-link:hover{color:var(--amber2)}
.res-del{position:absolute;top:10px;right:10px;background:none;border:none;color:var(--ghost);font-size:12px;cursor:pointer;opacity:0;transition:opacity 0.12s,color 0.12s}
.res-card:hover .res-del{opacity:1}.res-del:hover{color:var(--red)}

/* Learnings */
.lrn-item{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:16px;margin-bottom:10px;transition:border-color 0.14s;position:relative}
.lrn-item:hover{border-color:var(--rule2)}
.lrn-item-head{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;gap:10px}
.lrn-item-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.lrn-item-date{font-size:8.5px;color:var(--ghost);letter-spacing:0.06em}
.lrn-item-cat{font-size:8px;text-transform:uppercase;letter-spacing:0.12em;padding:2px 7px;border-radius:2px;font-weight:500}
.lrn-item-cat.mindset{background:rgba(99,102,241,0.08);color:var(--blue)}
.lrn-item-cat.risk{background:rgba(248,113,113,0.08);color:var(--red)}
.lrn-item-cat.entry{background:rgba(74,222,128,0.08);color:var(--green)}
.lrn-item-cat.exit{background:rgba(34,211,238,0.08);color:var(--cyan)}
.lrn-item-cat.sizing{background:rgba(212,168,71,0.08);color:var(--amber2)}
.lrn-item-cat.strategy{background:rgba(255,255,255,0.06);color:var(--dim)}
.lrn-item-imp{display:flex;gap:2px}
.lrn-dot{width:6px;height:6px;border-radius:50%;border:1px solid var(--rule2);transition:background 0.1s}
.lrn-dot.on{background:var(--amber);border-color:var(--amber)}
.lrn-body{font-size:12px;color:var(--text);line-height:1.75;font-family:var(--g);font-style:italic}
.lrn-source{font-size:9px;color:var(--ghost);margin-top:6px;letter-spacing:0.04em}
.lrn-del{position:absolute;top:12px;right:12px;background:none;border:none;color:var(--ghost);font-size:13px;cursor:pointer;opacity:0;transition:opacity 0.12s,color 0.12s}
.lrn-item:hover .lrn-del{opacity:1}.lrn-del:hover{color:var(--red)}

/* Modals */
.lrn-modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:500;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)}
.lrn-modal{background:var(--paper);border:1px solid var(--rule2);border-radius:4px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;animation:appear 0.18s var(--ease)}
.lrn-modal-head{display:flex;align-items:center;justify-content:space-between;padding:18px 20px 14px;border-bottom:1px solid var(--rule)}
.lrn-modal-title{font-size:13px;font-weight:500;color:var(--text)}
.lrn-modal-close{background:none;border:none;color:var(--dim);font-size:18px;cursor:pointer;transition:color 0.12s;line-height:1}
.lrn-modal-close:hover{color:var(--text)}
.lrn-modal-body{padding:20px}
.lrn-field{margin-bottom:14px}
.lrn-label{font-size:8.5px;text-transform:uppercase;letter-spacing:0.12em;color:var(--dim);margin-bottom:5px}
.lrn-input{width:100%;background:var(--lift);border:1px solid var(--rule);color:var(--text);font-family:var(--m);font-size:11px;padding:8px 11px;border-radius:2px;outline:none;transition:border-color 0.12s}
.lrn-input:focus{border-color:var(--rule2)}
.lrn-input::placeholder{color:var(--ghost)}
.lrn-textarea{width:100%;background:var(--lift);border:1px solid var(--rule);color:var(--text);font-family:var(--m);font-size:11px;padding:8px 11px;border-radius:2px;outline:none;resize:vertical;line-height:1.65;transition:border-color 0.12s}
.lrn-textarea:focus{border-color:var(--rule2)}
.lrn-textarea::placeholder{color:var(--ghost)}
.lrn-select{width:100%;background:var(--lift);border:1px solid var(--rule);color:var(--text);font-family:var(--m);font-size:11px;padding:8px 11px;border-radius:2px;outline:none;transition:border-color 0.12s;cursor:pointer}
.lrn-select:focus{border-color:var(--rule2)}
.lrn-select option{background:var(--lift)}
.lrn-modal-foot{display:flex;justify-content:flex-end;gap:8px;padding:14px 20px;border-top:1px solid var(--rule)}
.lrn-btn-cancel{background:none;border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:9px;padding:7px 16px;border-radius:2px;cursor:pointer;transition:all 0.12s}
.lrn-btn-cancel:hover{border-color:var(--rule2);color:var(--text)}
.lrn-btn-save{background:var(--amber);color:var(--ink);border:none;font-family:var(--m);font-size:9px;font-weight:500;letter-spacing:0.1em;text-transform:uppercase;padding:7px 18px;border-radius:2px;cursor:pointer;transition:background 0.12s}
.lrn-btn-save:hover{background:var(--amber2)}
.lrn-empty{text-align:center;padding:40px 20px;color:var(--dim)}
.lrn-empty-icon{font-size:32px;margin-bottom:10px}
.lrn-empty-txt{font-size:11px;line-height:1.7;margin-bottom:14px}

/* ── LEARNING ── */
.lrn-hero{padding:26px 0 20px;border-bottom:1px solid var(--rule);margin-bottom:24px}
.lrn-title{font-family:var(--g);font-size:27px;font-style:italic;color:var(--text);margin-bottom:4px}
.lrn-title span{color:var(--amber2);font-style:normal}
.lrn-sub{font-size:9px;color:var(--dim);letter-spacing:0.08em;text-transform:uppercase}

/* Sub-nav tabs */
.lrn-tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:24px}
.lrn-tab{background:none;border:1px solid var(--rule);border-radius:3px;font-family:var(--m);font-size:9px;font-weight:400;letter-spacing:0.1em;text-transform:uppercase;color:var(--dim);padding:7px 14px;cursor:pointer;transition:all 0.12s;white-space:nowrap;display:flex;align-items:center;gap:6px}
.lrn-tab:hover{border-color:var(--rule2);color:var(--text)}
.lrn-tab.on{background:rgba(212,168,71,0.08);border-color:rgba(212,168,71,0.3);color:var(--amber2)}
.lrn-pane{display:none}
.lrn-pane.on{display:block;animation:appear 0.18s var(--ease)}

/* Book category */
.lrn-cat-head{display:flex;align-items:center;gap:10px;margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid var(--rule)}
.lrn-cat-icon{font-size:18px}
.lrn-cat-label{font-size:13px;font-weight:500;color:var(--text)}
.lrn-cat-count{font-size:9px;color:var(--ghost);letter-spacing:0.06em;margin-left:auto}
.lrn-cat-section{margin-bottom:28px}

/* Book cards */
.lrn-books-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(310px,1fr));gap:12px}
.lrn-book{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:0;overflow:hidden;transition:border-color 0.15s;cursor:pointer}
.lrn-book:hover{border-color:var(--rule2)}
.lrn-book.expanded .lrn-book-concepts{display:block}
.lrn-book-top{display:flex;gap:14px;padding:16px}
.lrn-book-spine{width:44px;height:64px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;font-style:normal}
.lrn-book-info{flex:1;min-width:0}
.lrn-book-title{font-size:12px;font-weight:500;color:var(--text);line-height:1.35;margin-bottom:3px}
.lrn-book-author{font-size:10px;color:var(--amber2);margin-bottom:5px}
.lrn-book-tags{display:flex;gap:4px;flex-wrap:wrap}
.lrn-book-tag{font-size:8px;padding:1px 7px;border-radius:2px;background:rgba(255,255,255,0.04);color:var(--dim);border:1px solid var(--rule);letter-spacing:0.05em}
.lrn-book-tag.must{background:rgba(212,168,71,0.07);color:var(--amber2);border-color:rgba(212,168,71,0.2)}
.lrn-book-arrow{font-size:10px;color:var(--ghost);align-self:center;transition:transform 0.2s;flex-shrink:0;margin-left:auto}
.lrn-book.expanded .lrn-book-arrow{transform:rotate(180deg)}
.lrn-book-concepts{display:none;border-top:1px solid var(--rule);padding:14px 16px 16px}
.lrn-concept-label{font-size:8px;text-transform:uppercase;letter-spacing:0.14em;color:var(--dim);margin-bottom:9px}
.lrn-concept-list{display:flex;flex-direction:column;gap:7px}
.lrn-concept-item{display:flex;gap:9px;align-items:flex-start}
.lrn-concept-dot{width:5px;height:5px;border-radius:50%;background:var(--amber);margin-top:5px;flex-shrink:0}
.lrn-concept-text{font-size:11px;color:var(--dim);line-height:1.65}
.lrn-concept-text strong{color:var(--text);font-weight:500}
.lrn-book-rating{display:flex;gap:2px;margin-top:6px}
.lrn-bstar{font-size:10px;opacity:0.2}.lrn-bstar.on{opacity:1;color:var(--amber2)}

/* Resources */
.lrn-res-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px}
.lrn-res-card{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:16px;transition:border-color 0.15s}
.lrn-res-card:hover{border-color:var(--rule2)}
.lrn-res-type{font-size:8px;text-transform:uppercase;letter-spacing:0.13em;color:var(--dim);margin-bottom:6px;display:flex;align-items:center;gap:5px}
.lrn-res-name{font-size:12px;font-weight:500;color:var(--text);margin-bottom:3px}
.lrn-res-desc{font-size:10px;color:var(--dim);line-height:1.6;margin-bottom:8px}
.lrn-res-link{font-size:9px;color:var(--amber2);letter-spacing:0.04em;text-decoration:none;transition:color 0.12s}
.lrn-res-link:hover{color:var(--amber)}
.lrn-res-badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:2px;font-size:8px;font-weight:500;letter-spacing:0.06em;margin-bottom:7px}
.lrn-res-badge.free{background:rgba(74,222,128,0.08);color:var(--green);border:1px solid rgba(74,222,128,0.2)}
.lrn-res-badge.paid{background:rgba(212,168,71,0.08);color:var(--amber2);border:1px solid rgba(212,168,71,0.2)}
.lrn-res-badge.freemium{background:rgba(99,102,241,0.08);color:#818cf8;border:1px solid rgba(99,102,241,0.2)}

/* Mentor profiles */
.lrn-mentor-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
.lrn-mentor{background:var(--paper);border:1px solid var(--rule);border-radius:3px;overflow:hidden;transition:border-color 0.15s}
.lrn-mentor:hover{border-color:var(--rule2)}
.lrn-mentor-top{padding:18px 18px 14px;display:flex;gap:14px;align-items:flex-start}
.lrn-mentor-avatar{width:52px;height:52px;border-radius:50%;background:var(--lift);border:1px solid var(--rule);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.lrn-mentor-info{flex:1}
.lrn-mentor-name{font-size:13px;font-weight:500;color:var(--text);margin-bottom:2px}
.lrn-mentor-title{font-size:9px;color:var(--amber2);margin-bottom:5px;letter-spacing:0.02em}
.lrn-mentor-style{font-size:9px;color:var(--dim);display:flex;gap:5px;flex-wrap:wrap}
.lrn-mentor-style span{background:rgba(255,255,255,0.04);border:1px solid var(--rule);padding:1px 7px;border-radius:2px;letter-spacing:0.04em}
.lrn-mentor-body{padding:0 18px 16px;border-top:1px solid var(--rule)}
.lrn-mentor-bio{font-size:11px;color:var(--dim);line-height:1.7;padding-top:13px;margin-bottom:10px}
.lrn-mentor-lessons{display:flex;flex-direction:column;gap:6px}
.lrn-mentor-lesson{display:flex;gap:8px;font-size:10px;color:var(--dim);align-items:flex-start;line-height:1.6}
.lrn-mentor-lesson::before{content:'→';color:var(--amber);flex-shrink:0;margin-top:1px}
.lrn-mentor-legend{display:flex;align-items:center;gap:6px;margin-top:10px;padding-top:10px;border-top:1px solid var(--rule)}
.lrn-mentor-legend-label{font-size:8.5px;color:var(--dim);letter-spacing:0.06em}
.lrn-mentor-quote{font-family:var(--g);font-size:12px;font-style:italic;color:var(--amber2);line-height:1.5;padding:12px 18px;background:rgba(212,168,71,0.03);border-top:1px solid var(--rule)}

/* My Learnings */
.lrn-learning-filters{display:flex;gap:7px;align-items:center;margin-bottom:14px;flex-wrap:wrap}
.lrn-add-btn{background:var(--amber);color:var(--ink);border:none;font-family:var(--m);font-size:9px;font-weight:500;letter-spacing:0.1em;text-transform:uppercase;padding:7px 15px;border-radius:2px;cursor:pointer;transition:background 0.12s;margin-left:auto}
.lrn-add-btn:hover{background:var(--amber2)}
.lrn-entry{background:var(--paper);border:1px solid var(--rule);border-radius:3px;margin-bottom:10px;overflow:hidden;transition:border-color 0.15s}
.lrn-entry:hover{border-color:var(--rule2)}
.lrn-entry-top{display:flex;align-items:flex-start;gap:12px;padding:14px 16px}
.lrn-entry-type-badge{font-size:8px;padding:3px 9px;border-radius:2px;font-weight:500;letter-spacing:0.07em;text-transform:uppercase;white-space:nowrap;flex-shrink:0}
.lrn-entry-type-badge.book{background:rgba(99,102,241,0.1);color:#818cf8;border:1px solid rgba(99,102,241,0.25)}
.lrn-entry-type-badge.mentor{background:rgba(212,168,71,0.08);color:var(--amber2);border:1px solid rgba(212,168,71,0.22)}
.lrn-entry-type-badge.experiment{background:rgba(34,211,238,0.08);color:var(--cyan);border:1px solid rgba(34,211,238,0.22)}
.lrn-entry-type-badge.market{background:rgba(74,222,128,0.08);color:var(--green);border:1px solid rgba(74,222,128,0.22)}
.lrn-entry-body{flex:1;min-width:0}
.lrn-entry-source{font-size:10px;color:var(--amber2);margin-bottom:3px}
.lrn-entry-insight{font-size:12px;color:var(--text);line-height:1.6;margin-bottom:5px;font-family:var(--g);font-style:italic}
.lrn-entry-meta{font-size:9px;color:var(--dim);letter-spacing:0.04em}
.lrn-entry-impact{display:flex;gap:2px}
.lrn-entry-impact-dot{width:7px;height:7px;border-radius:50%;background:var(--ghost)}
.lrn-entry-impact-dot.on{background:var(--amber)}
.lrn-entry-del{background:none;border:none;color:var(--ghost);font-size:13px;cursor:pointer;transition:color 0.12s;line-height:1;padding-top:1px;flex-shrink:0}
.lrn-entry-del:hover{color:var(--red)}

/* Add learning modal */
.lrn-modal-overlay{position:fixed;inset:0;background:rgba(6,6,9,0.88);z-index:500;display:none;align-items:center;justify-content:center;padding:20px}

/* ── LESSONS PANE ── */
.les-cat-btn{background:none;border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:8.5px;letter-spacing:0.1em;text-transform:uppercase;padding:5px 12px;border-radius:2px;cursor:pointer;transition:all 0.12s;white-space:nowrap}
.les-cat-btn:hover{border-color:var(--rule2);color:var(--text)}
.les-cat-btn.on{background:rgba(212,168,71,0.08);border-color:rgba(212,168,71,0.35);color:var(--amber2)}
.les-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
.les-card{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:18px 18px 14px;transition:border-color 0.15s;position:relative;overflow:hidden}
.les-card:hover{border-color:var(--rule2)}
.les-card::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%}
.les-card.risk::before{background:var(--red)}
.les-card.mindset::before{background:var(--blue)}
.les-card.entry::before{background:var(--green)}
.les-card.exit::before{background:var(--cyan)}
.les-card.strategy::before{background:var(--ghost)}
.les-card.sizing::before{background:var(--amber)}
.les-card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.les-card-cat{font-size:8px;text-transform:uppercase;letter-spacing:0.13em;padding:2px 8px;border-radius:2px;font-weight:500}
.les-card-cat.risk{background:rgba(248,113,113,0.08);color:var(--red)}
.les-card-cat.mindset{background:rgba(99,102,241,0.08);color:#818cf8}
.les-card-cat.entry{background:rgba(74,222,128,0.08);color:var(--green)}
.les-card-cat.exit{background:rgba(34,211,238,0.08);color:var(--cyan)}
.les-card-cat.strategy{background:rgba(255,255,255,0.05);color:var(--dim)}
.les-card-cat.sizing{background:rgba(212,168,71,0.08);color:var(--amber2)}
.les-card-num{font-size:10px;color:var(--ghost);font-family:var(--g)}
.les-card-body{font-family:var(--g);font-style:italic;font-size:14px;line-height:1.65;color:var(--text);margin-bottom:12px}
.les-card-source{font-size:9px;color:var(--amber2);letter-spacing:0.04em}
.les-card-author{font-size:9px;color:var(--ghost)}
.les-card-apply{margin-top:10px;padding-top:10px;border-top:1px solid var(--rule);font-size:9.5px;color:var(--dim);line-height:1.6}
.les-card-apply strong{color:var(--text);font-style:normal;font-family:var(--m);font-size:8.5px;letter-spacing:0.08em;text-transform:uppercase;display:block;margin-bottom:3px}
.lrn-modal-overlay.on{display:flex}
.lrn-modal{background:var(--paper);border:1px solid var(--rule2);border-radius:4px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto}
.lrn-modal-head{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--rule)}
.lrn-modal-title{font-size:13px;font-weight:500;color:var(--text)}
.lrn-modal-close{background:none;border:none;color:var(--dim);font-size:18px;cursor:pointer;line-height:1;transition:color 0.12s}
.lrn-modal-close:hover{color:var(--text)}
.lrn-modal-body{padding:20px}
.lrn-field{margin-bottom:14px}
.lrn-field label{display:block;font-size:9px;text-transform:uppercase;letter-spacing:0.12em;color:var(--dim);margin-bottom:6px}
.lrn-field input,.lrn-field textarea,.lrn-field select{width:100%;background:var(--lift);border:1px solid var(--rule);border-radius:2px;color:var(--text);font-family:var(--m);font-size:11px;padding:9px 12px;outline:none;transition:border-color 0.12s}
.lrn-field input:focus,.lrn-field textarea:focus,.lrn-field select:focus{border-color:var(--rule2)}
.lrn-field select option{background:var(--lift)}
.lrn-field textarea{resize:vertical;min-height:80px;line-height:1.6}
.lrn-impact-btns{display:flex;gap:6px}
.lrn-impact-btn{background:none;border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:9px;padding:5px 11px;border-radius:2px;cursor:pointer;transition:all 0.12s}
.lrn-impact-btn:hover{border-color:var(--rule2);color:var(--text)}
.lrn-impact-btn.on{background:rgba(212,168,71,0.1);border-color:rgba(212,168,71,0.35);color:var(--amber2)}
.lrn-modal-footer{display:flex;justify-content:flex-end;gap:8px;padding:14px 20px;border-top:1px solid var(--rule)}
.lrn-cancel-btn{background:none;border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:9px;padding:7px 15px;border-radius:2px;cursor:pointer;transition:all 0.12s}
.lrn-cancel-btn:hover{border-color:var(--rule2);color:var(--text)}

/* RULES */
.rules-list{}
.rule-item{display:flex;align-items:flex-start;gap:12px;padding:12px 14px;border:1px solid var(--rule);border-radius:2px;margin-bottom:6px;background:var(--paper);transition:border-color 0.12s}
.rule-item:hover{border-color:var(--rule2)}
.rule-n{font-size:9px;color:var(--ghost);min-width:16px;padding-top:2px}
.rule-ta{flex:1;background:none;border:none;outline:none;font-family:var(--m);font-size:12px;color:var(--text);line-height:1.5;resize:none;width:100%;overflow:hidden}
.rule-x{background:none;border:none;color:var(--ghost);font-size:14px;cursor:pointer;transition:color 0.12s;line-height:1;padding-top:2px}
.rule-x:hover{color:var(--red)}
.add-rule{width:100%;background:none;border:1px dashed var(--rule);border-radius:2px;padding:10px 14px;color:var(--dim);font-family:var(--m);font-size:9px;letter-spacing:0.08em;cursor:pointer;text-align:left;margin-top:5px;transition:border-color 0.12s,color 0.12s}
.add-rule:hover{border-color:var(--rule2);color:var(--text)}

/* Rules tabbed system */
.rules-tab{background:none;border:1px solid var(--rule);border-radius:3px;font-family:var(--m);font-size:9px;font-weight:400;letter-spacing:0.1em;text-transform:uppercase;color:var(--dim);padding:7px 14px;cursor:pointer;transition:all 0.12s;white-space:nowrap}
.rules-tab:hover{border-color:var(--rule2);color:var(--text)}
.rules-tab.on{background:rgba(212,168,71,0.08);border-color:rgba(212,168,71,0.3);color:var(--amber2)}
.rules-pane{display:none}
.rules-pane.on{display:block;animation:appear 0.18s var(--ease)}
/* Rule group */
.rg{margin-bottom:22px}
.rg-head{display:flex;align-items:center;gap:9px;margin-bottom:10px;padding-bottom:9px;border-bottom:1px solid var(--rule)}
.rg-icon{font-size:14px;width:28px;height:28px;border-radius:50%;background:rgba(248,113,113,0.08);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.rg-label{font-size:9px;text-transform:uppercase;letter-spacing:0.15em;color:var(--dim);font-weight:400}
.rg-list{}
.rg-row{display:flex;align-items:flex-start;gap:12px;padding:11px 14px;border:1px solid var(--rule);border-radius:2px;margin-bottom:5px;background:var(--paper);transition:border-color 0.12s}
.rg-row:hover{border-color:var(--rule2)}
.rg-num{font-size:9px;color:var(--ghost);min-width:18px;padding-top:2px;flex-shrink:0}
.rg-ta{flex:1;background:none;border:none;outline:none;font-family:var(--m);font-size:11.5px;color:var(--text);line-height:1.55;resize:none;width:100%;overflow:hidden}
.rg-del{background:none;border:none;color:var(--ghost);font-size:14px;cursor:pointer;transition:color 0.12s;line-height:1;padding-top:1px;flex-shrink:0}
.rg-del:hover{color:var(--red)}
.rg-add{width:100%;background:none;border:1px dashed var(--rule);border-radius:2px;padding:9px 14px;color:var(--dim);font-family:var(--m);font-size:9px;letter-spacing:0.1em;cursor:pointer;text-align:left;margin-top:2px;transition:border-color 0.12s,color 0.12s}
.rg-add:hover{border-color:var(--amber);color:var(--amber2)}

/* Pre-market checklist row inside rules tab */
.pm-cl-row{display:flex;align-items:flex-start;gap:11px;padding:10px 14px;border:1px solid var(--rule);border-radius:2px;margin-bottom:4px;background:var(--paper);cursor:pointer;transition:border-color 0.12s,background 0.1s;user-select:none}
.pm-cl-row:hover{border-color:var(--rule2)}
.pm-cl-row.ck{background:rgba(74,222,128,0.03);border-color:rgba(74,222,128,0.18)}
.pm-cl-box{width:14px;height:14px;border:1.5px solid var(--rule2);border-radius:2px;flex-shrink:0;margin-top:1px;display:flex;align-items:center;justify-content:center;font-size:9px;transition:all 0.12s;color:transparent}
.pm-cl-row.ck .pm-cl-box{background:var(--green);border-color:var(--green);color:var(--ink)}
.pm-cl-text{font-size:11px;color:var(--dim);line-height:1.55;flex:1;transition:color 0.12s}
.pm-cl-row.ck .pm-cl-text{color:var(--text);text-decoration:line-through;text-decoration-color:rgba(74,222,128,0.35)}

/* DECISION ENGINE */
.decision-flow{display:flex;flex-direction:column;gap:10px}
.de-step{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:14px 16px;display:flex;align-items:flex-start;gap:12px;transition:border-color 0.12s}
.de-step.pass{border-color:rgba(74,222,128,0.25);background:rgba(74,222,128,0.03)}
.de-step.fail{border-color:rgba(248,113,113,0.25);background:rgba(248,113,113,0.03)}
.de-num{font-size:9px;color:var(--amber);min-width:20px;font-weight:500;padding-top:2px}
.de-q{font-size:12px;color:var(--text);flex:1;line-height:1.5}
.de-btns{display:flex;gap:6px;margin-left:auto;flex-shrink:0}
.de-yes,.de-no{background:none;border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:8px;letter-spacing:0.1em;padding:4px 10px;border-radius:2px;cursor:pointer;transition:all 0.12s}
.de-yes:hover,.de-yes.on{background:rgba(74,222,128,0.12);border-color:rgba(74,222,128,0.4);color:var(--green)}
.de-no:hover,.de-no.on{background:rgba(248,113,113,0.12);border-color:rgba(248,113,113,0.4);color:var(--red)}
.de-verdict{background:var(--lift);border:1px solid var(--rule2);border-radius:3px;padding:20px;text-align:center;margin-top:10px}
.de-verdict-big{font-family:var(--g);font-size:28px;font-style:italic;margin-bottom:6px}
.de-verdict-big.take{color:var(--green)}.de-verdict-big.skip{color:var(--red)}
.de-verdict-sub{font-size:10px;color:var(--dim)}
.de-reset{background:none;border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:9px;padding:6px 14px;border-radius:2px;cursor:pointer;transition:all 0.12s;margin-top:12px}
.de-reset:hover{border-color:var(--rule2);color:var(--text)}

/* SCREENER */
.screener-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.screener-card{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:14px;cursor:pointer;transition:border-color 0.12s}
.screener-card:hover{border-color:var(--rule2)}
.sc-sym{font-size:13px;font-weight:500;color:var(--text);margin-bottom:2px}
.sc-name{font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:10px}
.sc-price{font-size:18px;font-weight:300;letter-spacing:-0.01em;color:var(--text);margin-bottom:2px}
.sc-chg{font-size:9px;margin-bottom:8px}
.sc-bar{height:2px;border-radius:1px;background:var(--ghost);margin-bottom:2px}
.sc-bar-fill{height:100%;border-radius:1px;transition:width 0.5s}

/* MARKET INTEL */
.mi-hz-btn{background:var(--lift);border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:9px;letter-spacing:0.06em;padding:5px 11px;border-radius:3px;cursor:pointer;transition:all 0.12s;white-space:nowrap}
.mi-hz-btn:hover{color:var(--text);border-color:var(--rule2)}
.mi-hz-btn.on{background:var(--blue);border-color:var(--blue);color:#fff}
.mi-signal{display:inline-block;border:1px solid rgba(74,222,128,0.3);color:var(--green);font-size:8px;letter-spacing:0.1em;padding:4px 9px;border-radius:2px;font-family:var(--m)}
.mi-signal.mid{border-color:rgba(212,168,71,0.4);color:var(--amber2)}
.mi-signal.hi{border-color:rgba(99,102,241,0.4);color:#a5b4fc}
.mi-card{background:var(--paper);padding:14px 16px 10px}
.mi-card-l{font-size:7.5px;text-transform:uppercase;letter-spacing:0.12em;color:var(--dim);margin-bottom:6px}
.mi-card-v{font-size:22px;font-weight:300;letter-spacing:-0.02em;color:var(--text);line-height:1;margin-bottom:4px}
.mi-card-c{font-size:11px;font-weight:500;margin-bottom:6px}
.mi-card-c.g{color:var(--green)}.mi-card-c.r{color:var(--red)}
.mi-bar{height:2px;border-radius:1px;margin-top:2px}
.mi-bar.g{background:var(--green)}.mi-bar.r{background:var(--red)}
.mi-scenario{background:var(--lift);border:1px solid var(--rule);border-radius:3px;padding:14px}
.mi-scenario.bull{border-top:2px solid var(--green)}
.mi-scenario.base{border-top:2px solid var(--cyan)}
.mi-scenario.bear{border-top:2px solid var(--red)}
.mi-sc-name{font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--dim);margin-bottom:6px}
.mi-sc-pct{font-size:28px;font-weight:300;letter-spacing:-0.02em;line-height:1;margin-bottom:8px}
.mi-sc-desc{font-size:9px;color:var(--dim);line-height:1.55}
.mi-phase-item{font-size:10px;color:var(--text);line-height:1.6;padding:0 0 10px 10px;border-left:2px solid var(--green);margin-bottom:6px;position:relative}
.mi-phase-item::before{content:'●';position:absolute;left:-5px;top:3px;font-size:6px;color:inherit}
.mi-asset-card{padding:14px 16px;border-right:1px solid var(--rule);border-bottom:1px solid var(--rule)}
.mi-asset-cat{font-size:7.5px;text-transform:uppercase;letter-spacing:0.13em;color:var(--dim);margin-bottom:6px}
.mi-asset-rating{font-size:13px;font-weight:500;margin-bottom:6px}
.mi-asset-rating.ow{color:var(--green)}.mi-asset-rating.uw{color:var(--red)}.mi-asset-rating.nt{color:var(--amber2)}
.mi-asset-desc{font-size:9px;color:var(--dim);line-height:1.55;margin-bottom:8px}
.mi-asset-bar{height:2px;border-radius:1px}
.mi-asset-bar.ow{background:var(--green);width:75%}.mi-asset-bar.uw{background:var(--red);width:25%}.mi-asset-bar.nt{background:var(--amber);width:50%}
@media(max-width:900px){
  #v-intel .sec-head+div[style*="grid-template-columns:1fr 340px"]{grid-template-columns:1fr!important}
  #v-intel div[style*="repeat(4,1fr)"]{grid-template-columns:repeat(2,1fr)!important}
  #v-intel div[style*="repeat(3,1fr)"]{grid-template-columns:1fr 1fr!important}
}
.sc2-section{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:14px 16px}
.sc2-sec-label{font-size:8px;text-transform:uppercase;letter-spacing:0.16em;color:var(--dim)}
.sc2-label{font-size:8px;text-transform:uppercase;letter-spacing:0.12em;color:var(--dim);margin-bottom:5px}
.sc2-preset{background:var(--lift);border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:9px;letter-spacing:0.06em;padding:5px 12px;border-radius:12px;cursor:pointer;transition:all 0.15s;white-space:nowrap}
.sc2-preset:hover{border-color:var(--rule2);color:var(--text)}
.sc2-preset.on{background:rgba(212,168,71,0.12);border-color:var(--amber);color:var(--amber2)}
.sc2-bench{background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:14px 16px}
.sc2-bench-l{font-size:8px;text-transform:uppercase;letter-spacing:0.12em;color:var(--dim);margin-bottom:6px}
.sc2-bench-v{font-size:26px;font-weight:300;letter-spacing:-0.02em;line-height:1;margin-bottom:4px}
.sc2-bench-v.g{color:var(--green)}.sc2-bench-v.r{color:var(--red)}
.sc2-bench-s{font-size:8px;color:var(--dim);margin-bottom:8px}
.sc2-bench-bar{height:2px;background:var(--ghost);border-radius:1px;overflow:hidden}
/* RSI bar */
.rsi-bar-wrap{width:80px;height:4px;background:var(--ghost);border-radius:2px;overflow:hidden;display:inline-block;vertical-align:middle}
.rsi-bar-fill{height:100%;border-radius:2px;transition:width 0.4s}
/* MACD signal badge */
.macd-bull{color:var(--green);font-size:9px;font-weight:500}
.macd-bear{color:var(--red);font-size:9px;font-weight:500}
/* Trend badge */
.trend-up{color:var(--green);font-size:9px}
.trend-dn{color:var(--red);font-size:9px}
.trend-rg{color:var(--dim);font-size:9px}
/* Market badge */
.mkt-badge{display:inline-block;padding:2px 5px;border-radius:2px;font-size:7px;font-weight:500;letter-spacing:0.08em;text-transform:uppercase;line-height:1.4;text-align:center}
.mkt-us{background:rgba(99,102,241,0.15);color:#a5b4fc}
.mkt-in{background:rgba(248,113,113,0.12);color:var(--red)}
.mkt-cr{background:rgba(212,168,71,0.12);color:var(--amber2)}
.mkt-fx{background:rgba(34,211,238,0.1);color:var(--cyan)}
/* LIVE tag */
.sc2-live-tag{display:inline-block;background:rgba(74,222,128,0.12);border:1px solid rgba(74,222,128,0.25);color:var(--green);font-size:7px;letter-spacing:0.1em;padding:1px 5px;border-radius:2px;margin-left:5px;vertical-align:middle}
/* Central Bank Monitor */
.cb-section{background:var(--paper);border:1px solid var(--rule);border-radius:3px;margin-bottom:16px;overflow:hidden}
.cb-head{padding:10px 14px;font-size:8.5px;letter-spacing:0.16em;text-transform:uppercase;color:var(--dim);border-bottom:1px solid var(--rule);background:var(--lift);display:flex;align-items:center;gap:7px}
.cb-icon{font-size:12px}
.cb-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:0}
.cb-card{padding:14px 16px 12px;border-right:1px solid var(--rule);border-bottom:1px solid var(--rule)}
.cb-card:nth-child(4n){border-right:none}
.cb-card:nth-child(5),.cb-card:nth-child(6),.cb-card:nth-child(7),.cb-card:nth-child(8){border-bottom:none}
.cb-highlight{border-top:2px solid var(--red)}
.cb-highlight2{border-top:2px solid rgba(212,168,71,0.5)}
.cb-label{font-size:7.5px;text-transform:uppercase;letter-spacing:0.13em;color:var(--dim);margin-bottom:6px}
.cb-rate{font-size:22px;font-weight:300;letter-spacing:-0.02em;color:var(--text);line-height:1;margin-bottom:5px}
.cb-status{font-size:9px;font-weight:500;margin-bottom:4px;letter-spacing:0.02em}
.cb-status.held{color:var(--amber2)}
.cb-status.cut{color:var(--green)}
.cb-status.hike{color:var(--red)}
.cb-next{font-size:8px;color:var(--dim)}

/* News layout */
.news-layout{display:grid;grid-template-columns:1fr 380px;gap:14px}
.news-left{min-width:0}
.news-right{}

/* Live Intelligence Feed */
.lif-head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--lift);border:1px solid var(--rule);border-bottom:none;border-radius:3px 3px 0 0}
.lif-title{display:flex;align-items:center;gap:5px;font-size:8.5px;letter-spacing:0.14em;text-transform:uppercase;color:var(--dim)}
.lif-dot{width:6px;height:6px;border-radius:50%;background:var(--amber);animation:pulse 1.4s infinite}
.news-filters{display:flex;gap:5px;padding:10px 14px;background:var(--paper);border-left:1px solid var(--rule);border-right:1px solid var(--rule);flex-wrap:wrap}
.nf-btn{background:none;border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:9px;padding:4px 11px;border-radius:12px;cursor:pointer;transition:all 0.12s;white-space:nowrap}
.nf-btn:hover{border-color:var(--rule2);color:var(--text)}
.nf-btn.on{background:rgba(212,168,71,0.12);border-color:var(--amber);color:var(--amber2)}

/* News feed items */
.ni{padding:14px;border:1px solid var(--rule);border-top:none;background:var(--paper);cursor:pointer;transition:background 0.08s}
.ni:last-child{border-radius:0 0 3px 3px}
.ni:hover{background:var(--lift)}
.ni-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:6px}
.ni-headline{font-size:12px;color:var(--text);line-height:1.45;font-weight:400;flex:1}
.ni-sentiment{flex-shrink:0;font-size:8px;font-weight:500;letter-spacing:0.06em;padding:2px 7px;border-radius:2px;white-space:nowrap;margin-top:2px}
.ni-sentiment.bull{background:rgba(74,222,128,0.1);color:var(--green)}
.ni-sentiment.bear{background:rgba(248,113,113,0.1);color:var(--red)}
.ni-sentiment.neut{background:rgba(90,90,120,0.2);color:var(--dim)}
.ni-body{font-size:10px;color:var(--dim);line-height:1.6;margin-bottom:7px}
.ni-foot{display:flex;align-items:center;gap:8px}
.ni-cat{display:inline-block;padding:1px 6px;border-radius:2px;font-size:7.5px;letter-spacing:0.1em;text-transform:uppercase;font-weight:500}
.ni-cat.crypto{background:rgba(99,102,241,0.15);color:#a5b4fc}
.ni-cat.macro{background:rgba(34,211,238,0.1);color:var(--cyan)}
.ni-cat.equities{background:rgba(74,222,128,0.1);color:var(--green)}
.ni-cat.forex{background:rgba(212,168,71,0.1);color:var(--amber2)}
.ni-cat.india{background:rgba(248,113,113,0.1);color:var(--red)}
.ni-source{font-size:8px;color:var(--ghost)}
.ni-time{font-size:8px;color:var(--ghost)}

/* Calendar rows */
.cal-row{display:flex;align-items:center;gap:10px;padding:9px 14px;border-bottom:1px solid var(--rule)}
.cal-row:last-child{border-bottom:none}
.cal-time-col{font-size:8px;color:var(--dim);width:52px;flex-shrink:0;line-height:1.4}
.cal-flag{font-size:13px;flex-shrink:0}
.cal-ev-name{font-size:10px;color:var(--text);line-height:1.35;flex:1}
.cal-ev-sub{font-size:8px;color:var(--dim);margin-top:1px}
.cal-right{text-align:right;flex-shrink:0}
.cal-status{font-size:9px;color:var(--dim)}
.cal-forecast{font-size:8px;color:var(--dim);margin-top:1px}
.cal-imp{width:7px;height:7px;border-radius:50%;flex-shrink:0}

/* Fear & Greed */
.fg-body{padding:14px 16px}
.fg-gauge-wrap{position:relative;text-align:center;margin-bottom:8px}
.fg-score-wrap{position:absolute;bottom:0;left:50%;transform:translateX(-50%);text-align:center;pointer-events:none}
.fg-score{font-size:32px;font-weight:300;letter-spacing:-0.03em;line-height:1}
.fg-label{font-size:11px;letter-spacing:0.06em;text-transform:uppercase;margin-top:2px}
.fg-scale{display:flex;justify-content:space-between;font-size:7px;color:var(--dim);text-align:center;line-height:1.3;margin-bottom:6px;padding:0 4px}
.fg-bar-track{height:3px;background:linear-gradient(to right,#f87171,#fb923c,#4ade80,#facc15,#f87171);border-radius:2px;margin-bottom:12px;position:relative}
.fg-bar-fill{position:absolute;top:50%;transform:translateY(-50%);width:8px;height:8px;border-radius:50%;background:var(--text);border:2px solid var(--ink);box-shadow:0 0 6px rgba(255,255,255,0.3);transition:left 0.6s}
.fg-history{border-top:1px solid var(--rule);padding-top:10px}
.fg-hist-row{display:flex;justify-content:space-between;font-size:9px;color:var(--dim);margin-bottom:4px}
.fg-hist-val{font-weight:500}

@media(max-width:900px){
  .cb-grid{grid-template-columns:repeat(2,1fr)}
  .cb-card:nth-child(2n){border-right:none}
  .cb-card:nth-child(5),.cb-card:nth-child(6),.cb-card:nth-child(7),.cb-card:nth-child(8){border-bottom:none}
  .news-layout{grid-template-columns:1fr}
  .news-right{order:-1}
}

/* CALENDAR */
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--rule);border:1px solid var(--rule);border-radius:3px;overflow:hidden;margin-bottom:16px}
.cal-head{background:var(--lift);padding:6px;text-align:center;font-size:8px;text-transform:uppercase;letter-spacing:0.12em;color:var(--dim)}
.cal-cell{background:var(--paper);padding:8px;min-height:56px;font-size:9px;color:var(--dim);vertical-align:top}
.cal-cell.today{background:rgba(212,168,71,0.06);border-top:1.5px solid var(--amber)}
.cal-day-num{font-size:10px;color:var(--dim);margin-bottom:4px}
.cal-event{font-size:8px;padding:1px 4px;border-radius:1px;margin-bottom:2px;line-height:1.3}
.cal-event.high{background:rgba(248,113,113,0.15);color:var(--red)}
.cal-event.med{background:rgba(212,168,71,0.12);color:var(--amber2)}
.cal-event.low{background:rgba(74,222,128,0.1);color:var(--green)}
.eco-event-list{display:flex;flex-direction:column;gap:7px}
.eco-event{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;background:var(--paper);border:1px solid var(--rule);border-radius:3px}
.eco-impact{width:4px;height:4px;border-radius:50%;margin-top:5px;flex-shrink:0}
.eco-time{font-size:9px;color:var(--dim);width:46px;flex-shrink:0;padding-top:1px}
.eco-name{font-size:11px;color:var(--text);line-height:1.4}
.eco-prev{font-size:9px;color:var(--dim);margin-top:2px}

/* RESPONSIVE */
@media(max-width:780px){
  .stats{grid-template-columns:repeat(3,1fr)}
  .stat:nth-child(4),.stat:nth-child(5){display:none}
  .fg,.premarket-grid,.psy-grid,.dash-grid{grid-template-columns:1fr}
  .detail-g{grid-template-columns:1fr}
  .question-text{font-size:22px}
  .question-block{flex-direction:column}
  .month-strip{grid-template-columns:repeat(6,1fr)}
  header{padding:0 12px}
  main{padding:20px 12px 48px}
  .h-right .btn-sm{display:none}
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   CONFIRMATION TAB — Decision Engine (from index.html)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
.de-panel{background:var(--paper);border:1px solid var(--rule);border-radius:3px;overflow:hidden;margin-bottom:14px}
.de-panel-header{padding:11px 16px;border-bottom:1px solid var(--rule);font-size:8px;text-transform:uppercase;letter-spacing:0.16em;color:var(--dim);display:flex;align-items:center;justify-content:space-between}
.de-panel-body{padding:16px}
.de-ig{display:flex;flex-direction:column;gap:4px}
.de-ig label{font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:0.1em}
.de-in{background:var(--lift);border:1px solid var(--rule);border-radius:2px;color:var(--text);font-family:var(--m);font-size:12px;padding:7px 10px;outline:none;width:100%;transition:border-color 0.12s}
.de-in:focus{border-color:var(--amber)}
.de-sel{background:var(--lift);border:1px solid var(--rule);border-radius:2px;color:var(--text);font-family:var(--m);font-size:12px;padding:7px 10px;outline:none;width:100%;cursor:pointer;transition:border-color 0.12s;-webkit-appearance:none;appearance:none}
.de-sel:focus{border-color:var(--amber)}
.de-live-box{background:var(--lift);border:1px solid var(--rule);border-radius:2px;padding:11px 12px;min-height:46px;font-size:11px;color:var(--dim);line-height:1.7;margin-bottom:12px}
.de-btn-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.de-btn-primary{background:var(--amber);color:var(--ink);border:none;font-family:var(--m);font-size:9px;font-weight:500;letter-spacing:0.08em;text-transform:uppercase;padding:9px;border-radius:2px;cursor:pointer;transition:background 0.12s;display:flex;align-items:center;justify-content:center;gap:4px;width:100%}
.de-btn-primary:hover{background:var(--amber2)}
.de-btn-primary:disabled{opacity:0.55;cursor:not-allowed}
.de-btn-ghost{background:none;border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:9px;letter-spacing:0.08em;text-transform:uppercase;padding:9px;border-radius:2px;cursor:pointer;transition:all 0.12s;display:flex;align-items:center;justify-content:center;gap:4px;width:100%}
.de-btn-ghost:hover{border-color:var(--rule2);color:var(--text)}
/* Score ring */
.de-ring-wrap{position:relative;width:150px;height:150px;margin:16px auto 14px}
.de-ring-wrap svg{transform:rotate(-90deg)}
.de-ring-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.de-ring-num{font-family:var(--g);font-size:40px;font-weight:300;line-height:1}
.de-ring-lbl{font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:0.12em;margin-top:3px}
/* Verdict badge */
.de-verdict-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 18px;border-radius:40px;font-family:var(--g);font-size:14px;font-style:italic;letter-spacing:0.02em;margin:8px auto 14px;border:1px solid}
.de-verdict-badge.go{background:rgba(74,222,128,0.08);color:var(--green);border-color:rgba(74,222,128,0.22)}
.de-verdict-badge.nogo{background:rgba(248,113,113,0.08);color:var(--red);border-color:rgba(248,113,113,0.22)}
.de-verdict-badge.caution{background:rgba(212,168,71,0.08);color:var(--amber2);border-color:rgba(212,168,71,0.22)}
/* Check rows */
.de-check-row{display:flex;align-items:flex-start;gap:9px;padding:8px 0;border-bottom:1px solid var(--rule);font-size:11px}
.de-check-row:last-child{border-bottom:none}
.de-check-icon{width:17px;height:17px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;flex-shrink:0;font-weight:700;margin-top:1px}
.de-check-icon.pass{background:rgba(74,222,128,0.14);color:var(--green)}
.de-check-icon.fail{background:rgba(248,113,113,0.14);color:var(--red)}
.de-check-icon.warn{background:rgba(212,168,71,0.14);color:var(--amber2)}
/* Historical stats */
.de-hist-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--rule)}
.de-hist-cell{background:var(--paper);padding:14px 10px;text-align:center}
.de-hist-val{font-family:var(--g);font-size:22px;font-weight:300;margin-bottom:4px;line-height:1}
.de-hist-lbl{font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:0.08em}
/* AI box */
.de-ai-output{background:var(--lift);border:1px solid var(--rule);border-radius:2px;padding:14px;min-height:72px;font-size:11px;color:var(--dim);line-height:1.85}
.de-ai-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.25);border-radius:20px;padding:3px 9px;font-size:8px;font-weight:500;color:var(--blue);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:8px}
@keyframes aib{0%,100%{opacity:0.2}50%{opacity:1}}
.de-ai-dot{width:4px;height:4px;border-radius:50%;background:var(--blue);animation:aib 1.2s infinite;display:inline-block}
.de-ai-dot:nth-child(2){animation-delay:.3s}.de-ai-dot:nth-child(3){animation-delay:.6s}
/* Self-analysis */
.de-prompt-box{background:var(--lift);border:1px solid var(--rule);border-radius:2px;padding:12px 14px;font-size:11px;color:var(--text);line-height:1.8}
/* Layout */
.de-two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}
@media(max-width:780px){.de-two-col{grid-template-columns:1fr}}

</style>
</head>
<body>

<header>
  <div class="h-mark">Zen <b>Journal</b></div>
  <nav>
    <button class="t on"  onclick="goTo('dash',this)">Overview</button>
    <button class="t"     onclick="goTo('premarket',this)">Pre-Market</button>
    <button class="t"     onclick="goTo('trades',this)">Trades</button>
    <button class="t"     onclick="goTo('rules',this)">Rules</button>
    <button class="t"     onclick="goTo('decision',this)">Decision</button>
    <button class="t"     onclick="goTo('confirmation',this)">Confirmation</button>
    <button class="t"     onclick="goTo('psy',this)">Psychology</button>
    <button class="t"     onclick="goTo('philosophy',this)">Philosophy</button>
    <button class="t"     onclick="goTo('dailyreview',this)">Daily Review</button>
    <button class="t"     onclick="goTo('learning',this)">Learning</button>
    <button class="t"     onclick="goTo('intel',this)">Market Intel</button>
    <button class="t"     onclick="goTo('screener',this)">Watchlist</button>
    <button class="t"     onclick="goTo('stockscreener',this)">Screener</button>
    <button class="t"     onclick="goTo('news',this)">News</button>
    <button class="t"     onclick="goTo('live',this)">Live Markets</button>
  </nav>
  <div class="h-right">
    <button class="btn-sm" onclick="openApiSettings()">⚙ API</button>
    <button class="btn-sm" onclick="exportJSON()">Backup</button>
    <button class="btn-sm" onclick="document.getElementById('imp').click()">Restore</button>
    <input type="file" id="imp" accept=".json" style="display:none" onchange="importJSON(event)">
    <button class="btn-add" onclick="openEntry()">+ Log Trade</button>
  </div>
</header>

<main>

<!-- ── OVERVIEW ── -->
<div id="v-dash" class="v on">
  <div class="question-block">
    <div class="question-text">What <em>happened,</em><br>and what will you do <em>differently?</em></div>
    <div class="q-meta">
      <div class="q-date" id="q-date"></div>
      <div class="q-count" id="q-count">0</div>
      <div style="font-size:8px;color:var(--dim);margin-top:2px">trades logged</div>
    </div>
  </div>
  <div class="stats">
    <div class="stat"><div class="stat-l">Total P&L</div><div class="stat-v" id="s-pnl">—</div><div class="stat-s" id="s-pnl-s">no trades yet</div></div>
    <div class="stat"><div class="stat-l">Win Rate</div><div class="stat-v" id="s-wr">—</div><div class="stat-s" id="s-wr-s">—</div></div>
    <div class="stat"><div class="stat-l">Expectancy</div><div class="stat-v" id="s-exp">—</div><div class="stat-s" id="s-exp-s">avg win / loss</div></div>
    <div class="stat"><div class="stat-l">Best R</div><div class="stat-v a" id="s-bestr">—</div><div class="stat-s">risk-reward</div></div>
    <div class="stat"><div class="stat-l">Streak</div><div class="stat-v" id="s-streak">—</div><div class="streak-dots" id="s-dots"></div></div>
  </div>
  <div class="month-strip" id="month-strip"></div>
  <div class="dash-grid">
    <div class="panel">
      <div class="panel-h"><span class="panel-title">Equity Curve</span><span style="font-size:8px;color:var(--dim)">cumulative P&L</span></div>
      <div style="padding:12px"><canvas id="eqChart" height="148"></canvas></div>
    </div>
    <div class="panel">
      <div class="panel-h"><span class="panel-title">P&L Heatmap</span><span style="font-size:8px;color:var(--dim)">this year</span></div>
      <div class="heatmap-outer" id="heatmap"></div>
    </div>
  </div>
  <div class="sdiv"><span class="sdiv-l">Recent Trades</span><button class="sdiv-r" onclick="goTo('trades',document.querySelectorAll('.t')[2])">see all →</button></div>
  <div class="panel"><div class="tbl-wrap"><table>
    <thead><tr><th>Date</th><th>Symbol</th><th>Dir</th><th>P&L</th><th>R</th><th>Rating</th><th>Lesson</th></tr></thead>
    <tbody id="recent-tb"></tbody>
  </table></div></div>
</div>

<!-- ── PRE-MARKET ── -->
<div id="v-premarket" class="v">
  <div class="sec-head">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:14px">
      <div>
        <div class="sec-title">Pre-Market Ritual</div>
        <div class="sec-sub">Complete before the first trade of the day</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:5px;align-items:flex-end">
        <div style="font-size:8px;text-transform:uppercase;letter-spacing:0.14em;color:var(--dim);margin-bottom:2px">Today's Trade Type</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="pm-type-btn on" data-pmtype="all"       onclick="setPMType('all',this)">📌 All Rules</button>
          <button class="pm-type-btn"    data-pmtype="intraday"  onclick="setPMType('intraday',this)">⚡ Intraday</button>
          <button class="pm-type-btn"    data-pmtype="swing"     onclick="setPMType('swing',this)">📋 Swing / Positional</button>
          <button class="pm-type-btn"    data-pmtype="investing" onclick="setPMType('investing',this)">🏦 Investment</button>
        </div>
      </div>
    </div>
  </div>
  <div class="premarket-grid">
    <div>
      <div class="panel">
        <div class="panel-h"><span class="panel-title">Mental State Check</span></div>
        <div class="panel-body">
          <div class="cl-head" style="margin-bottom:10px">Check what applies right now</div>
          <div id="pm-mindset-checks"></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-h"><span class="panel-title">Today's Intention</span></div>
        <div class="panel-body">
          <label class="fl" style="display:block;margin-bottom:6px">What is your one focus for today's session?</label>
          <textarea class="pm-textarea" id="pm-intention" placeholder="e.g. Only trade my A-setups. Honour the stop. No FOMO."></textarea>
          <label class="fl" style="display:block;margin:12px 0 6px">Key levels / bias</label>
          <textarea class="pm-textarea" id="pm-bias" placeholder="Market structure, key S/R, expected direction…"></textarea>
          <button class="pm-save-btn" onclick="savePM()">Save Ritual</button>
        </div>
      </div>
    </div>
    <div>
      <div class="panel">
        <div class="panel-h"><span class="panel-title" id="pm-rules-panel-title">Pre-Trade Rules Checklist</span><span id="pm-ck-count" style="font-size:9px;color:var(--dim)"></span></div>
        <div class="panel-body" id="pm-rules-list"></div>
      </div>
      <div class="panel">
        <div class="panel-h"><span class="panel-title">Yesterday's Lesson</span></div>
        <div class="panel-body" id="pm-yesterday"></div>
      </div>
    </div>
  </div>
</div>

<!-- ── TRADES ── -->
<div id="v-trades" class="v">
  <div class="sec-head"><div class="sec-title">All Trades</div><div class="sec-sub">Click any row to review in full</div></div>
  <div class="filters">
    <input  class="fi" id="f-q"  placeholder="symbol / setup…" oninput="renderTrades()">
    <select class="fi" id="f-d"  onchange="renderTrades()"><option value="">All directions</option><option value="Long">Long</option><option value="Short">Short</option></select>
    <select class="fi" id="f-o"  onchange="renderTrades()"><option value="">Win & Loss</option><option value="win">Wins</option><option value="loss">Losses</option><option value="pass">Passed</option></select>
    <select class="fi" id="f-r"  onchange="renderTrades()"><option value="">Any rating</option><option value="5">★ 5</option><option value="4">★ 4+</option><option value="3">★ 3+</option></select>
    <select class="fi" id="f-tt" onchange="renderTrades()"><option value="">All types</option><option value="intraday">⚡ Intraday</option><option value="swing">📋 Swing</option><option value="investing">🏦 Investment</option></select>
  </div>
  <div class="panel"><div class="tbl-wrap"><table>
    <thead><tr><th onclick="srt('date')">Date ↕</th><th onclick="srt('symbol')">Symbol ↕</th><th>Dir</th><th onclick="srt('pnl')">P&L ↕</th><th>R</th><th onclick="srt('rating')">Rating ↕</th><th>Lesson</th><th></th></tr></thead>
    <tbody id="trades-tb"></tbody>
  </table></div></div>
</div>

<!-- ── DAILY REVIEW ── -->
<div id="v-dailyreview" class="v">

  <!-- Hero -->
  <div class="dr-hero">
    <div class="dr-hero-left">
      <div class="dr-title">Daily <span>Review</span></div>
      <div class="dr-sub">Sit. Reflect. Grow. One honest entry per day.</div>
    </div>
    <div class="dr-date-row">
      <button class="dr-nav-arrow" onclick="drNavigate(-1)">←</button>
      <input type="date" class="dr-date-input" id="dr-date-input" onchange="drLoadDate(this.value)">
      <button class="dr-nav-arrow" onclick="drNavigate(1)">→</button>
      <button class="dr-today-btn" onclick="drGoToday()">Today</button>
    </div>
  </div>

  <!-- Sit-out banner -->
  <div class="dr-sitout-bar">
    <div class="dr-sitout-stat">
      <div class="dr-sitout-n" id="dr-sitout-count">0</div>
      <div class="dr-sitout-l">Days I Chose<br>Not to Trade</div>
    </div>
    <div class="dr-sitout-quote">
      "Not trading is a trade. Sometimes the best position is no position."
      <cite>— Trading Proverb</cite>
    </div>
    <div class="dr-sitout-action">
      <button class="dr-sitout-btn" id="dr-sitout-btn" onclick="drToggleSitout()">⚠ Log a Sit-Out Day</button>
    </div>
  </div>

  <!-- Main layout -->
  <div class="dr-layout">

    <!-- LEFT COLUMN -->
    <div>

      <!-- Day Score -->
      <div class="dr-panel">
        <div class="dr-panel-head">
          <div class="dr-panel-title">🏆 Day Quality Score</div>
          <div class="dr-panel-meta">Auto-computed from your entries</div>
        </div>
        <div class="dr-score-wrap">
          <div class="dr-score-ring">
            <svg width="70" height="70" viewBox="0 0 70 70">
              <circle cx="35" cy="35" r="28" fill="none" stroke="var(--ghost)" stroke-width="5"/>
              <circle cx="35" cy="35" r="28" fill="none" id="dr-score-arc"
                stroke="var(--amber)" stroke-width="5"
                stroke-linecap="round"
                stroke-dasharray="175.9" stroke-dashoffset="175.9"
                style="transition:stroke-dashoffset 0.7s cubic-bezier(0.16,1,0.3,1),stroke 0.4s"/>
            </svg>
            <div class="dr-score-num" id="dr-score-num" style="color:var(--ghost)">—</div>
          </div>
          <div class="dr-score-breakdown">
            <div class="dr-sb-row">
              <div class="dr-sb-label">Reflection depth</div>
              <div class="dr-sb-bar"><div class="dr-sb-fill" id="drb-reflect" style="width:0%;background:var(--cyan)"></div></div>
              <div class="dr-sb-val" id="drbv-reflect">0</div>
            </div>
            <div class="dr-sb-row">
              <div class="dr-sb-label">Emotional awareness</div>
              <div class="dr-sb-bar"><div class="dr-sb-fill" id="drb-emotion" style="width:0%;background:var(--amber)"></div></div>
              <div class="dr-sb-val" id="drbv-emotion">0</div>
            </div>
            <div class="dr-sb-row">
              <div class="dr-sb-label">Rule adherence</div>
              <div class="dr-sb-bar"><div class="dr-sb-fill" id="drb-rules" style="width:0%;background:var(--green)"></div></div>
              <div class="dr-sb-val" id="drbv-rules">0</div>
            </div>
            <div class="dr-sb-row">
              <div class="dr-sb-label">Habits completed</div>
              <div class="dr-sb-bar"><div class="dr-sb-fill" id="drb-habits" style="width:0%;background:var(--blue)"></div></div>
              <div class="dr-sb-val" id="drbv-habits">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Three Questions -->
      <div class="dr-panel">
        <div class="dr-panel-head">
          <div class="dr-panel-title">🌱 Three Questions</div>
          <div class="dr-panel-meta">The core of daily practice</div>
        </div>
        <div class="dr-panel-body">
          <div class="dr-q-group">
            <div class="dr-q-label win">What did I do well today? <em style="font-weight:400;color:var(--dim)">(Be specific)</em></div>
            <textarea class="dr-textarea" id="dr-well" placeholder="I held my stop. I waited for confirmation. I sized correctly on the breakout…" oninput="drAutoSave()" rows="3"></textarea>
          </div>
          <div class="dr-q-group">
            <div class="dr-q-label loss">What did I force or fight against? <em style="font-weight:400;color:var(--dim)">(Be honest)</em></div>
            <textarea class="dr-textarea" id="dr-fight" placeholder="I entered without a clear setup. I moved my stop. I traded out of boredom…" oninput="drAutoSave()" rows="3"></textarea>
          </div>
          <div class="dr-q-group">
            <div class="dr-q-label tmr">What will I do differently tomorrow?</div>
            <textarea class="dr-textarea" id="dr-tmr" placeholder="Wait for the daily close before entering. Reduce size on uncertain days…" oninput="drAutoSave()" rows="3"></textarea>
          </div>
          <div class="dr-q-group">
            <div class="dr-q-label focus">Today's single most important lesson:</div>
            <textarea class="dr-textarea" id="dr-lesson" placeholder="The one insight that will compound over time…" oninput="drAutoSave()" rows="2"></textarea>
          </div>
        </div>
      </div>

      <!-- Emotional State -->
      <div class="dr-panel">
        <div class="dr-panel-head">
          <div class="dr-panel-title">🧠 Today's Emotional State</div>
        </div>
        <div class="dr-panel-body">
          <div style="font-size:9px;color:var(--dim);margin-bottom:10px;letter-spacing:0.04em">Which states were present during your trading session today?</div>
          <div class="dr-emotions" id="dr-emotions">
            <div class="dr-em-chip pos" data-em="Calm" onclick="drToggleEmotion(this)">🧘 Calm</div>
            <div class="dr-em-chip pos" data-em="Focused" onclick="drToggleEmotion(this)">🎯 Focused</div>
            <div class="dr-em-chip pos" data-em="Confident" onclick="drToggleEmotion(this)">💪 Confident</div>
            <div class="dr-em-chip pos" data-em="Patient" onclick="drToggleEmotion(this)">⏳ Patient</div>
            <div class="dr-em-chip pos" data-em="Disciplined" onclick="drToggleEmotion(this)">✅ Disciplined</div>
            <div class="dr-em-chip neg" data-em="Anxious" onclick="drToggleEmotion(this)">😰 Anxious</div>
            <div class="dr-em-chip neg" data-em="FOMO" onclick="drToggleEmotion(this)">⚡ FOMO</div>
            <div class="dr-em-chip neg" data-em="Overconfident" onclick="drToggleEmotion(this)">🤩 Overconfident</div>
            <div class="dr-em-chip neg" data-em="Bored" onclick="drToggleEmotion(this)">😴 Bored</div>
            <div class="dr-em-chip neg" data-em="Revenge" onclick="drToggleEmotion(this)">🔥 Revenge</div>
            <div class="dr-em-chip neg" data-em="Fearful" onclick="drToggleEmotion(this)">😨 Fearful</div>
            <div class="dr-em-chip neg" data-em="Greedy" onclick="drToggleEmotion(this)">💰 Greedy</div>
            <div class="dr-em-chip neg" data-em="Distracted" onclick="drToggleEmotion(this)">📵 Distracted</div>
          </div>
          <div style="font-size:8.5px;text-transform:uppercase;letter-spacing:0.12em;color:var(--dim);margin-bottom:7px">Any other notes on your state of mind</div>
          <textarea class="dr-textarea" id="dr-emotion-notes" placeholder="How the emotional states affected your decisions today…" oninput="drAutoSave()" rows="3"></textarea>
        </div>
      </div>

      <!-- Market Context -->
      <div class="dr-panel">
        <div class="dr-panel-head">
          <div class="dr-panel-title">📊 Market Context</div>
          <div class="dr-panel-meta">What was the market doing?</div>
        </div>
        <div class="dr-panel-body">
          <div style="font-size:9px;color:var(--dim);margin-bottom:8px;letter-spacing:0.04em">Today's market regime</div>
          <div class="dr-regime-row" id="dr-regime-row">
            <button class="dr-regime-btn" data-reg="Strong Trend Up" onclick="drSetRegime(this)">↑ Strong Trend Up</button>
            <button class="dr-regime-btn" data-reg="Weak Trend Up" onclick="drSetRegime(this)">↗ Weak Trend Up</button>
            <button class="dr-regime-btn" data-reg="Ranging" onclick="drSetRegime(this)">↔ Ranging</button>
            <button class="dr-regime-btn" data-reg="Weak Trend Down" onclick="drSetRegime(this)">↘ Weak Trend Down</button>
            <button class="dr-regime-btn" data-reg="Strong Trend Down" onclick="drSetRegime(this)">↓ Strong Trend Down</button>
            <button class="dr-regime-btn" data-reg="High Volatility" onclick="drSetRegime(this)">⚡ High Volatility</button>
          </div>
          <div class="dr-q-group" style="margin-top:4px">
            <div class="dr-q-label" style="color:var(--dim)">Key observations:</div>
            <textarea class="dr-textarea" id="dr-market" placeholder="VIX elevated. Nifty bounced off 20-EMA. Breadth was weak. Sector rotation into defensives…" oninput="drAutoSave()" rows="3"></textarea>
          </div>
        </div>
      </div>

      <!-- Rule Adherence -->
      <div class="dr-panel">
        <div class="dr-panel-head">
          <div class="dr-panel-title">📋 Rule Adherence Today</div>
        </div>
        <div class="dr-panel-body">
          <div class="dr-rating-row">
            <div class="dr-rating-label">Overall</div>
            <div class="dr-stars" id="dr-stars-overall" data-group="overall">
              <span class="dr-star" data-n="1" onclick="drSetStar('overall',1)">★</span>
              <span class="dr-star" data-n="2" onclick="drSetStar('overall',2)">★</span>
              <span class="dr-star" data-n="3" onclick="drSetStar('overall',3)">★</span>
              <span class="dr-star" data-n="4" onclick="drSetStar('overall',4)">★</span>
              <span class="dr-star" data-n="5" onclick="drSetStar('overall',5)">★</span>
            </div>
            <span class="dr-rating-desc" id="dr-stars-overall-desc"></span>
          </div>
          <div class="dr-rating-row">
            <div class="dr-rating-label">Stop discipline</div>
            <div class="dr-stars" id="dr-stars-stop" data-group="stop">
              <span class="dr-star" data-n="1" onclick="drSetStar('stop',1)">★</span>
              <span class="dr-star" data-n="2" onclick="drSetStar('stop',2)">★</span>
              <span class="dr-star" data-n="3" onclick="drSetStar('stop',3)">★</span>
              <span class="dr-star" data-n="4" onclick="drSetStar('stop',4)">★</span>
              <span class="dr-star" data-n="5" onclick="drSetStar('stop',5)">★</span>
            </div>
            <span class="dr-rating-desc" id="dr-stars-stop-desc"></span>
          </div>
          <div class="dr-rating-row">
            <div class="dr-rating-label">Position sizing</div>
            <div class="dr-stars" id="dr-stars-sizing" data-group="sizing">
              <span class="dr-star" data-n="1" onclick="drSetStar('sizing',1)">★</span>
              <span class="dr-star" data-n="2" onclick="drSetStar('sizing',2)">★</span>
              <span class="dr-star" data-n="3" onclick="drSetStar('sizing',3)">★</span>
              <span class="dr-star" data-n="4" onclick="drSetStar('sizing',4)">★</span>
              <span class="dr-star" data-n="5" onclick="drSetStar('sizing',5)">★</span>
            </div>
            <span class="dr-rating-desc" id="dr-stars-sizing-desc"></span>
          </div>
          <div class="dr-rating-row">
            <div class="dr-rating-label">Patience</div>
            <div class="dr-stars" id="dr-stars-patience" data-group="patience">
              <span class="dr-star" data-n="1" onclick="drSetStar('patience',1)">★</span>
              <span class="dr-star" data-n="2" onclick="drSetStar('patience',2)">★</span>
              <span class="dr-star" data-n="3" onclick="drSetStar('patience',3)">★</span>
              <span class="dr-star" data-n="4" onclick="drSetStar('patience',4)">★</span>
              <span class="dr-star" data-n="5" onclick="drSetStar('patience',5)">★</span>
            </div>
            <span class="dr-rating-desc" id="dr-stars-patience-desc"></span>
          </div>
        </div>
      </div>

      <!-- Habits -->
      <div class="dr-panel">
        <div class="dr-panel-head">
          <div class="dr-panel-title">✅ Daily Habits Tracker</div>
          <div class="dr-panel-meta" id="dr-habit-count">0 / 8</div>
        </div>
        <div class="dr-panel-body">
          <div class="dr-habits" id="dr-habits">
            <div class="dr-habit" data-h="Reviewed rules" onclick="drToggleHabit(this)"><span class="dr-habit-icon">📋</span><span class="dr-habit-label">Reviewed rules</span><span class="dr-habit-check">✓</span></div>
            <div class="dr-habit" data-h="Journaled trades" onclick="drToggleHabit(this)"><span class="dr-habit-icon">📝</span><span class="dr-habit-label">Journaled trades</span><span class="dr-habit-check">✓</span></div>
            <div class="dr-habit" data-h="Meditated / breathwork" onclick="drToggleHabit(this)"><span class="dr-habit-icon">🧘</span><span class="dr-habit-label">Meditated / breathwork</span><span class="dr-habit-check">✓</span></div>
            <div class="dr-habit" data-h="Exercise done" onclick="drToggleHabit(this)"><span class="dr-habit-icon">💪</span><span class="dr-habit-label">Exercise done</span><span class="dr-habit-check">✓</span></div>
            <div class="dr-habit" data-h="Read / studied markets" onclick="drToggleHabit(this)"><span class="dr-habit-icon">📚</span><span class="dr-habit-label">Read / studied markets</span><span class="dr-habit-check">✓</span></div>
            <div class="dr-habit" data-h="Screen time limited" onclick="drToggleHabit(this)"><span class="dr-habit-icon">📵</span><span class="dr-habit-label">Screen time limited</span><span class="dr-habit-check">✓</span></div>
            <div class="dr-habit" data-h="Slept 7+ hours" onclick="drToggleHabit(this)"><span class="dr-habit-icon">😴</span><span class="dr-habit-label">Slept 7+ hours</span><span class="dr-habit-check">✓</span></div>
            <div class="dr-habit" data-h="Planned tomorrow" onclick="drToggleHabit(this)"><span class="dr-habit-icon">🗓</span><span class="dr-habit-label">Planned tomorrow</span><span class="dr-habit-check">✓</span></div>
          </div>
        </div>
      </div>

      <!-- AI Insight -->
      <div class="dr-panel">
        <div class="dr-panel-head">
          <div class="dr-panel-title">✦ Pattern Insight</div>
          <div class="dr-panel-meta">Generated from your journal history</div>
        </div>
        <div class="dr-panel-body" id="dr-insight-body">
          <div class="dr-empty-state">
            <div class="dr-empty-icon">📊</div>
            Save today's review to generate an insight based on your emotion × performance patterns.
          </div>
        </div>
      </div>

      <!-- Save bar -->
      <div class="dr-save-bar" style="border:1px solid var(--rule);border-radius:3px;margin-bottom:14px">
        <span class="dr-save-status" id="dr-save-status">Unsaved changes</span>
        <button class="dr-save-btn" onclick="drSave()">Save Review →</button>
      </div>

    </div><!-- end left col -->

    <!-- RIGHT SIDEBAR -->
    <div class="dr-sidebar">

      <!-- Today at a Glance -->
      <div class="dr-panel">
        <div class="dr-panel-head"><div class="dr-panel-title">📌 Today at a Glance</div></div>
        <div class="dr-panel-body" id="dr-glance-body">
          <div class="dr-empty-state" style="padding:16px 0">
            <div class="dr-empty-icon">📈</div>
            No trades logged on this date.
          </div>
        </div>
      </div>

      <!-- 30-Day Streak -->
      <div class="dr-panel">
        <div class="dr-panel-head">
          <div class="dr-panel-title">🔥 Review Streak</div>
          <div class="dr-panel-meta">Last 30 days</div>
        </div>
        <div class="dr-panel-body">
          <div class="dr-streak-row" id="dr-streak"></div>
          <div style="margin-top:10px;display:flex;gap:12px;font-size:9px;color:var(--dim)">
            <span><span style="display:inline-block;width:9px;height:9px;border-radius:1px;background:rgba(74,222,128,0.6);margin-right:4px;vertical-align:middle"></span>Great day</span>
            <span><span style="display:inline-block;width:9px;height:9px;border-radius:1px;background:rgba(212,168,71,0.55);margin-right:4px;vertical-align:middle"></span>OK</span>
            <span><span style="display:inline-block;width:9px;height:9px;border-radius:1px;background:rgba(248,113,113,0.55);margin-right:4px;vertical-align:middle"></span>Tough</span>
            <span><span style="display:inline-block;width:9px;height:9px;border-radius:1px;background:rgba(99,102,241,0.35);margin-right:4px;vertical-align:middle"></span>Sit-out</span>
          </div>
        </div>
      </div>

      <!-- Emotion × Performance -->
      <div class="dr-panel">
        <div class="dr-panel-head">
          <div class="dr-panel-title">🎭 Emotion × Performance</div>
          <div class="dr-panel-meta">Last 30 days</div>
        </div>
        <div class="dr-panel-body" id="dr-em-perf">
          <div class="dr-empty-state" style="padding:12px 0">
            <div class="dr-empty-icon">🎭</div>
            Start logging daily emotional states to see patterns emerge.
          </div>
        </div>
      </div>

      <!-- Past Reviews -->
      <div class="dr-panel">
        <div class="dr-panel-head">
          <div class="dr-panel-title">📖 Past Reviews</div>
        </div>
        <div class="dr-panel-body" id="dr-past-list">
          <div class="dr-empty-state" style="padding:12px 0;font-size:10px">No reviews yet.</div>
        </div>
      </div>

    </div><!-- end sidebar -->
  </div><!-- end layout -->
</div>


<div id="v-learning" class="v">

  <!-- Hero -->
  <div class="lrn-hero">
    <div class="lrn-title">Trading <span>Library</span></div>
    <div class="lrn-sub">Books · Resources · Mentors · Personal Learnings</div>
  </div>

  <!-- Sub-tabs -->
  <div class="lrn-tabs">
    <button class="lrn-tab on" onclick="lrnTab('books',this)">📚 Books</button>
    <button class="lrn-tab"    onclick="lrnTab('resources',this)">🌐 Resources</button>
    <button class="lrn-tab"    onclick="lrnTab('mentors',this)">🧠 Mentors</button>
    <button class="lrn-tab"    onclick="lrnTab('mylearnings',this)">✍ My Learnings</button>
    <button class="lrn-tab"    onclick="lrnTab('lessons',this)">💡 Lessons <span style="background:rgba(212,168,71,0.18);color:var(--amber2);font-size:8px;padding:1px 5px;border-radius:2px;margin-left:2px">22</span></button>
  </div>

  <!-- ── BOOKS PANE ── -->
  <div id="lrn-pane-books" class="lrn-pane on">

    <!-- Trading -->
    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">⚡</span><span class="lrn-cat-label">Trading & Technical Analysis</span><span class="lrn-cat-count">5 essential reads</span></div>
      <div class="lrn-books-grid">

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(248,113,113,0.12);color:#f87171">📈</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Reminiscences of a Stock Operator</div>
              <div class="lrn-book-author">Edwin Lefèvre (Jesse Livermore)</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Classic</span><span class="lrn-book-tag">Psychology</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The Tape never lies</strong> — Price action is the ultimate truth. Trade what you see, not what you think.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Sitting tight is the hardest</strong> — It's not the thinking that makes you money, it's the sitting. Patience is a position.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Pivotal points</strong> — Markets consolidate energy before explosive moves. Wait for the right pivot before committing capital.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Top-down analysis</strong> — Trade the market environment first, sector second, stock third. Never fight the primary trend.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Emotional discipline over intelligence</strong> — Markets are won by those who master themselves, not those who master formulas.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(212,168,71,0.12);color:var(--amber2)">📊</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Trading in the Zone</div>
              <div class="lrn-book-author">Mark Douglas</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Mindset</span><span class="lrn-book-tag">Edge</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Probabilistic thinking</strong> — Any single trade means nothing. A trading edge plays out over hundreds of trades. Think in samples.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The "Zone" state</strong> — Consistent traders operate without fear or overconfidence, accepting all possible outcomes with equanimity.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Unique, random outcomes</strong> — Each trade is independent. Past losses don't create overdue wins. Each moment is truly new.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Defining your edge</strong> — Without a specific, repeatable edge with a verifiable positive expectancy, you're gambling.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Beliefs create reality</strong> — Your subconscious beliefs about money, risk and self-worth determine your trading results more than any system.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(34,211,238,0.1);color:var(--cyan)">🎯</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">The New Market Wizards</div>
              <div class="lrn-book-author">Jack D. Schwager</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Interviews</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>No single path to success</strong> — Trend followers, discretionary traders, systematic quants — all wildly different yet all profitable. Find YOUR style.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Risk management is the common thread</strong> — Every wizard, regardless of style, had iron discipline on risk. Position sizing is the equaliser.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Asymmetric bets</strong> — The best traders risk little to make a lot. They are wrong often but catastrophically small when wrong.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Expect adversity</strong> — Every great trader has had a near-wipeout moment. It's not about avoiding drawdowns, it's about surviving them.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(99,102,241,0.12);color:#818cf8">📉</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">How to Make Money in Stocks</div>
              <div class="lrn-book-author">William J. O'Neil</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">CAN SLIM</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>CAN SLIM system</strong> — Current earnings, Annual earnings, New product/management, Supply/demand, Leader, Institution sponsorship, Market direction.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Cup-with-handle pattern</strong> — The most reliable base pattern for institutional accumulation. Volume on breakout confirms the move.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>7-8% hard stop</strong> — Cut every loss at maximum 7-8% below purchase price. No exceptions. Capital preservation first.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Market direction is paramount</strong> — 3 out of 4 stocks follow the market. Trade with the market, never against it.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(74,222,128,0.1);color:var(--green)">📋</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Technical Analysis of Financial Markets</div>
              <div class="lrn-book-author">John J. Murphy</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Reference</span><span class="lrn-book-tag">Charts</span><span class="lrn-book-tag">Indicators</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The three premises of TA</strong> — Market discounts everything, prices move in trends, history repeats. These underpin all technical work.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Support and resistance</strong> — Old resistance becomes new support after a breakout. These levels represent collective memory in the market.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Volume confirms trend</strong> — Price moves with expanding volume are sustainable. Moves on declining volume are suspect.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Intermarket analysis</strong> — Bonds, equities, commodities and currencies are all linked. Context from one market informs another.</div></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Investing -->
    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">🏦</span><span class="lrn-cat-label">Investing & Fundamental Analysis</span><span class="lrn-cat-count">5 essential reads</span></div>
      <div class="lrn-books-grid">

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(212,168,71,0.12);color:var(--amber2)">🏆</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">The Intelligent Investor</div>
              <div class="lrn-book-author">Benjamin Graham</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Value</span><span class="lrn-book-tag">Timeless</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Margin of Safety</strong> — Buy only when price is significantly below intrinsic value. This gap is your protection against error and bad luck.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Mr. Market</strong> — The market is a manic-depressive business partner. Use his mood swings to your advantage, never be guided by them.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Investment vs speculation</strong> — An investment operation is one which, upon thorough analysis, promises safety of principal and adequate return.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Defensive vs enterprising investor</strong> — Know which you are. Defensive investors need simple, passive approaches. Enterprising can take active risk.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(34,211,238,0.1);color:var(--cyan)">🔍</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">One Up on Wall Street</div>
              <div class="lrn-book-author">Peter Lynch</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Growth</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Invest in what you know</strong> — The biggest edge retail investors have is understanding businesses from daily life before Wall Street does.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>10-bagger thinking</strong> — The goal isn't to find stocks up 10%, but businesses that can grow 10× over a decade. Think like a business owner.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Six categories of stocks</strong> — Slow growers, stalwarts, fast growers, cyclicals, asset plays and turnarounds each require different strategies.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The story</strong> — Always know your investment story in 2 minutes. If you can't explain why you own it, you shouldn't own it.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(74,222,128,0.1);color:var(--green)">💎</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Common Stocks and Uncommon Profits</div>
              <div class="lrn-book-author">Philip A. Fisher</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Scuttlebutt</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Scuttlebutt method</strong> — Talk to suppliers, competitors, customers and ex-employees. Ground-truth research beats financial statements alone.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>15 Points framework</strong> — A complete checklist for evaluating management quality, R&D efficiency, margins and long-term growth potential.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>When to sell</strong> — Only sell if: facts have changed, you made an error, or a dramatically better opportunity exists. Tax drag is real.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Management integrity above all</strong> — Outstanding companies have outstanding people. Financial engineering can never substitute for genuine quality.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(248,113,113,0.1);color:var(--red)">📊</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Security Analysis</div>
              <div class="lrn-book-author">Benjamin Graham & David Dodd</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Reference</span><span class="lrn-book-tag">Advanced</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Intrinsic value</strong> — A company's true worth determined by its assets, earnings power and future prospects, independent of market price.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Bond vs equity valuation</strong> — Rigorous, balance-sheet-first approach to valuing both fixed income and equities. The foundation of all fundamental analysis.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Market vs investment value</strong> — Price is what you pay, value is what you get. The gap between them is the entire game of investing.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(99,102,241,0.12);color:#818cf8">🌊</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">The Little Book That Still Beats the Market</div>
              <div class="lrn-book-author">Joel Greenblatt</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Systematic</span><span class="lrn-book-tag">Simple</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Magic Formula</strong> — Rank stocks by highest earnings yield AND highest return on capital. The intersection finds quality at a discount.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Return on Capital as quality proxy</strong> — A business that consistently earns high returns on invested capital has a genuine competitive advantage.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Systematic discipline beats emotion</strong> — A simple, consistently applied process beats even smart discretionary investors who bend their own rules.</div></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Finance & Macro -->
    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">🌐</span><span class="lrn-cat-label">Finance, Macro & Market Structure</span><span class="lrn-cat-count">5 essential reads</span></div>
      <div class="lrn-books-grid">

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(34,211,238,0.1);color:var(--cyan)">🌊</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Principles for Navigating Big Debt Crises</div>
              <div class="lrn-book-author">Ray Dalio</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Macro</span><span class="lrn-book-tag">Cycles</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The debt cycle template</strong> — All major debt crises follow a predictable pattern. Recognising the phase you're in is a massive macro edge.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Deflationary vs inflationary deleveraging</strong> — How central banks respond to debt crises determines whether the outcome is depression or currency debasement.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The beautiful deleveraging</strong> — A balance between austerity, debt restructuring, wealth redistribution and money printing that avoids the extremes.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Credit drives economies</strong> — Understanding credit creation and destruction is more important than understanding GDP or interest rates in isolation.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(212,168,71,0.12);color:var(--amber2)">💥</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">The Black Swan</div>
              <div class="lrn-book-author">Nassim Nicholas Taleb</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Risk</span><span class="lrn-book-tag">Probability</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Black Swan events</strong> — Rare, high-impact events that are unpredictable in advance but explainable in hindsight. Markets are full of them.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Ludic fallacy</strong> — Confusing the controlled randomness of games with the wild randomness of real life and financial markets.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Negative empiricism</strong> — No amount of past data can prove a model. One single counterexample destroys a theory. Stay humble about forecasting.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Barbell strategy</strong> — Put most of your assets in ultra-safe instruments and a small portion in highly speculative bets. Avoid the middle.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(74,222,128,0.1);color:var(--green)">🔄</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">A Random Walk Down Wall Street</div>
              <div class="lrn-book-author">Burton G. Malkiel</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">EMH</span><span class="lrn-book-tag">Passive</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Efficient Market Hypothesis</strong> — Prices fully reflect all available information. Understanding WHY this is both true and false is essential for active traders.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The cost of active management</strong> — Fees and taxes destroy most of the alpha active managers claim. Know your genuine edge before paying for it.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Life-cycle investing</strong> — Asset allocation should change with age and risk capacity. A framework for rational portfolio construction over time.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(248,113,113,0.1);color:var(--red)">🔥</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">When Genius Failed</div>
              <div class="lrn-book-author">Roger Lowenstein</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Risk</span><span class="lrn-book-tag">LTCM</span><span class="lrn-book-tag">Warning</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Leverage amplifies both ways</strong> — LTCM's 25:1 leverage turned a modest loss into a $4.6 billion collapse. High leverage is ruin risk, not return enhancement.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Models are not reality</strong> — The smartest models in the world failed because human behaviour in extremis invalidates all historical correlations.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Liquidity risk is underpriced</strong> — The assumption that you can always exit a position at a fair price is wrong precisely when you need it most.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(99,102,241,0.12);color:#818cf8">📉</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">This Time Is Different</div>
              <div class="lrn-book-author">Reinhart & Rogoff</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Macro</span><span class="lrn-book-tag">History</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>"This time is different" is the most dangerous phrase</strong> — 800 years of financial crises show the same patterns repeating. Debt, complacency, collapse.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The 90% debt/GDP threshold</strong> — Beyond this level, growth historically slows significantly. Sovereign debt matters more than most investors admit.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>History rhymes</strong> — Asset price bubbles, banking crises and sovereign defaults have a predictable anatomy. Studying them is studying the future.</div></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Psychology -->
    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">🧠</span><span class="lrn-cat-label">Trading Psychology & Behavioural Finance</span><span class="lrn-cat-count">5 essential reads</span></div>
      <div class="lrn-books-grid">

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(212,168,71,0.12);color:var(--amber2)">🎯</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Thinking, Fast and Slow</div>
              <div class="lrn-book-author">Daniel Kahneman</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Biases</span><span class="lrn-book-tag">Nobel</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>System 1 vs System 2</strong> — Fast, automatic thinking causes trading errors. Slow, deliberate System 2 thinking is what rules-based trading activates.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Loss aversion</strong> — Losses are psychologically 2× as painful as equivalent gains. This is why traders hold losers and sell winners too early.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Availability heuristic</strong> — We overweight recent, vivid memories. A recent crash makes us see crashes everywhere. A bull run blinds us to risk.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Overconfidence bias</strong> — 93% of drivers rate themselves above average. Most traders believe they are too. The market disagrees with most of them.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Regression to mean</strong> — Exceptional performance is followed by ordinary performance. Don't mistake luck for skill in either direction.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(74,222,128,0.1);color:var(--green)">🌀</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">The Psychology of Money</div>
              <div class="lrn-book-author">Morgan Housel</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Behaviour</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Nobody's crazy</strong> — Everyone's financial decisions make sense given their unique life experiences and risk tolerance. Stop judging, start understanding.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Compounding is counterintuitive</strong> — 96% of Warren Buffett's wealth was earned after age 65. Time is the most powerful variable in finance, not returns.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Getting wealthy vs staying wealthy</strong> — Getting rich requires risk-taking. Staying rich requires humility, frugality and paranoia about losing what you have.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Room for error</strong> — The most important financial skill is surviving long enough for compounding to work. Build large margins of safety everywhere.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(248,113,113,0.1);color:var(--red)">🔮</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Misbehaving</div>
              <div class="lrn-book-author">Richard Thaler</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Behavioural</span><span class="lrn-book-tag">Nobel</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Mental accounting</strong> — Treating money differently based on its source or intended use leads to irrational decisions. Money is fungible — always.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Endowment effect</strong> — We value what we own more than what we don't. Applied to trading: we're too attached to positions we're already in.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Nudge theory</strong> — Choice architecture powerfully shapes behaviour. Design your trading environment to nudge yourself toward good decisions.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(99,102,241,0.12);color:#818cf8">⚡</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Mastery</div>
              <div class="lrn-book-author">Robert Greene</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Skill</span><span class="lrn-book-tag">Deliberate Practice</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Apprenticeship phase</strong> — The first 10,000 hours are for deep observation, skill acquisition and absorbing tacit knowledge. Don't rush to trade big.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Resistance and frustration</strong> — The feeling of confusion and struggle is not failure — it is the feeling of real learning. Embrace it.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Tacit knowledge</strong> — The real edge in trading cannot be fully articulated. It lives in pattern recognition built through deep, deliberate repetition.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(34,211,238,0.1);color:var(--cyan)">🏹</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">The Disciplined Trader</div>
              <div class="lrn-book-author">Mark Douglas</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Mindset</span><span class="lrn-book-tag">Discipline</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The market has no responsibility to give you money</strong> — Every dollar you make comes from another trader's mistake. The market is neutral and indifferent.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Environment-driven behaviour</strong> — Our brains are wired for social environments, not markets. Rules-based trading rewires us for the right context.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Developing a winner's mindset</strong> — Winners expect to win without needing any specific trade to work. They trade from confidence, not desperation.</div></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Biographies -->
    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">👑</span><span class="lrn-cat-label">Biographies of Market Legends</span><span class="lrn-cat-count">5 essential reads</span></div>
      <div class="lrn-books-grid">

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(212,168,71,0.12);color:var(--amber2)">🦁</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">The Snowball: Warren Buffett and the Business of Life</div>
              <div class="lrn-book-author">Alice Schroeder</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Buffett</span><span class="lrn-book-tag">Compounding</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Lessons</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Compound early and never stop</strong> — Buffett started investing at 11 and called it the biggest mistake that he didn't start earlier. Time is everything.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Circle of competence is sacred</strong> — He avoided tech in the dot-com bubble at enormous social cost. He was right. Know what you don't know.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Internal scorecard over external</strong> — Buffett measures success by his own standards, not the crowd's. This gives him freedom to be contrarian.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Reinvest everything, spend nothing</strong> — He drove the same car and lived in the same house for decades. Every dollar not spent was a dollar compounding.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(99,102,241,0.12);color:#818cf8">🌊</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">The Man Who Solved the Market</div>
              <div class="lrn-book-author">Gregory Zuckerman (Jim Simons)</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Quant</span><span class="lrn-book-tag">Simons</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Lessons</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Patterns exist but are tiny</strong> — The Medallion fund found edges so small that only massive leverage and perfect execution made them viable. Small edges compound enormously.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Hire scientists not traders</strong> — Simons hired mathematicians and physicists over finance people. Fresh eyes see patterns that dogma-trained minds miss.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Systems beat discretion at scale</strong> — No single human can process the data volume needed to consistently outperform. Build the machine, then trust the machine.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(34,211,238,0.1);color:var(--cyan)">⚡</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">More Than You Know</div>
              <div class="lrn-book-author">Michael J. Mauboussin</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Mental Models</span><span class="lrn-book-tag">Edge</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Lessons</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Process not outcome</strong> — A good process produces a bad outcome sometimes. Judge your decisions by the quality of the process, not the result.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Multidisciplinary thinking</strong> — The best investors borrow frameworks from biology, physics, psychology and complexity theory. Expand your mental model library.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Reversion and reflexivity</strong> — Markets exhibit both mean reversion and reflexive momentum. Know which regime you're in and trade accordingly.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(74,222,128,0.1);color:var(--green)">🎲</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Soros: The Life, Ideas and Impact of the World's Most Influential Investor</div>
              <div class="lrn-book-author">Robert Slater</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Macro</span><span class="lrn-book-tag">Soros</span><span class="lrn-book-tag">Reflexivity</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Lessons</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Reflexivity</strong> — Investor perceptions affect fundamentals, which affect perceptions, creating self-reinforcing boom-bust cycles. Markets are not equilibrium systems.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>When wrong, get out fast</strong> — Soros says his greatest skill is recognising his mistakes quickly. The ability to reverse position is more valuable than being right.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Bet big when you're right</strong> — He bet $10 billion against the pound. When your thesis is correct and the risk is defined, conviction sizing is rational.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(248,113,113,0.1);color:var(--red)">🔬</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Paul Tudor Jones: The Greatest Trader Alive</div>
              <div class="lrn-book-author">Sebastian Mallaby (Profile in More Money Than God)</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Macro</span><span class="lrn-book-tag">PTJ</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Lessons</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>5:1 reward-to-risk non-negotiable</strong> — PTJ will not enter a trade unless he sees a 5:1 return opportunity. Being wrong 80% of the time is still profitable.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Protect the capital first</strong> — "Don't focus on making money, focus on protecting what you have." Capital preservation enables the next great opportunity.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Every day is a new beginning</strong> — He marks his P&L to zero every day. Yesterday's wins don't make today's decisions any easier or safer.</div></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Philosophy -->
    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">🏛</span><span class="lrn-cat-label">Philosophy & Stoicism</span><span class="lrn-cat-count">5 essential reads</span></div>
      <div class="lrn-books-grid">

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(212,168,71,0.12);color:var(--amber2)">⚡</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Meditations</div>
              <div class="lrn-book-author">Marcus Aurelius</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Stoicism</span><span class="lrn-book-tag">Discipline</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The dichotomy of control</strong> — Separate what is in your power (your thoughts, reactions, execution) from what isn't (the market, outcomes). Focus only on the former.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Amor fati</strong> — Love your fate, including losses and drawdowns. What cannot be changed must be accepted. The best traders treat losses as information, not tragedy.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Memento mori</strong> — Remembering impermanence keeps you humble. A run of wins is not permanent. Neither is a drawdown. Both shall pass.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Virtue is the only good</strong> — Process adherence is the only thing you can truly call success. A well-executed losing trade beats a sloppy winning one.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(34,211,238,0.1);color:var(--cyan)">🧘</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">The Obstacle Is the Way</div>
              <div class="lrn-book-author">Ryan Holiday</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Stoicism</span><span class="lrn-book-tag">Resilience</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Perception is everything</strong> — You can't control events, only your response to them. A stop-out is either a failure or a lesson, depending on how you frame it.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Obstacles as fuel</strong> — Every great trader used adversity to become sharper. The blowup that doesn't kill you teaches you what a thousand books cannot.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Action, not reaction</strong> — Amor fati combined with decisive action. You accept the situation as it is, then act on it — without complaint or paralysis.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(99,102,241,0.12);color:#818cf8">🌟</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Principles</div>
              <div class="lrn-book-author">Ray Dalio</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Decision-Making</span><span class="lrn-book-tag">Systems</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Pain + Reflection = Progress</strong> — Mistakes are puzzles to solve, not failures. Each loss contains the lesson for the next profitable setup if you reflect deeply enough.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Radical open-mindedness</strong> — The biggest threat to good decision-making is your ego. Welcome challenges to your view as information, not attacks.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Believability-weighted decisions</strong> — Not all opinions are equal. Weight the views of those with proven track records more heavily, including in your own evolution.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(74,222,128,0.1);color:var(--green)">🔥</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Man's Search for Meaning</div>
              <div class="lrn-book-author">Viktor Frankl</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Purpose</span><span class="lrn-book-tag">Resilience</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The last human freedom</strong> — Between stimulus and response lies the freedom to choose your reaction. Markets can hurt your account; they cannot dictate your attitude.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Trading with purpose</strong> — Those who know their WHY can endure any drawdown. Define your purpose for trading beyond money, and your resilience compounds.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Meaning under adversity</strong> — The worst market conditions are where character is forged. How you handle a 30% drawdown reveals the trader you truly are.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(248,113,113,0.1);color:var(--red)">🌀</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Antifragile</div>
              <div class="lrn-book-author">Nassim Nicholas Taleb</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Risk</span><span class="lrn-book-tag">Volatility</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Antifragility</strong> — Some things benefit from shocks. Build a portfolio and career that gains from volatility, not just survives it. Optionality is the mechanism.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Via negativa</strong> — Improvement through subtraction. Removing bad trades, bad habits and bad positions adds more value than adding new strategies.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Skin in the game</strong> — You must bear the consequences of your own decisions. Accountability sharpens decision-making in ways that no theory can replicate.</div></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Sales -->
    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">🎯</span><span class="lrn-cat-label">Sales & Persuasion</span><span class="lrn-cat-count">5 essential reads</span></div>
      <div class="lrn-books-grid">

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(212,168,71,0.12);color:var(--amber2)">🔥</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Influence: The Psychology of Persuasion</div>
              <div class="lrn-book-author">Robert Cialdini</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Persuasion</span><span class="lrn-book-tag">Psychology</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The 6 principles of influence</strong> — Reciprocity, commitment, social proof, authority, liking, and scarcity. Markets exploit all six. Know them to avoid being the victim.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Social proof in markets</strong> — When everyone is buying, social proof compels you to buy too. Recognise this mechanism. It is what creates bubbles and crashes.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Scarcity and FOMO</strong> — Fear of missing out drives irrational entry. When you feel urgency to get in, ask: is this genuine opportunity or manufactured scarcity?</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Commitment and consistency</strong> — Once we commit to a position in public, we resist changing our view even when the market disagrees. Be wary of anchoring to your own thesis.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(74,222,128,0.1);color:var(--green)">💼</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">How to Win Friends and Influence People</div>
              <div class="lrn-book-author">Dale Carnegie</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Relationships</span><span class="lrn-book-tag">Classic</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Genuine interest in others</strong> — People follow those who make them feel understood. The best traders attract mentors and information by being genuinely curious.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Don't criticise, condemn or complain</strong> — Applied to trading: don't blame the market, the broker or luck. Ownership of results is the first step to improvement.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>See things from the other's view</strong> — In trading: who is on the other side of your trade? Why are they selling when you're buying? Market intelligence starts here.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(34,211,238,0.1);color:var(--cyan)">💡</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Pre-Suasion</div>
              <div class="lrn-book-author">Robert Cialdini</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Advanced</span><span class="lrn-book-tag">Priming</span><span class="lrn-book-tag">Attention</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>What you focus on becomes important</strong> — Media attention on a sector primes retail investors to find it interesting. Be aware of what the financial media is directing your attention toward.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The privileged moment</strong> — Setting up the right mental state before a decision changes the decision itself. Pre-market rituals prime you for disciplined execution.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Unity — the 8th principle</strong> — We are most persuaded by those we see as being like us. Beware of following traders because you identify with them, not because their system works.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(248,113,113,0.1);color:var(--red)">📈</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">The Art of Selling</div>
              <div class="lrn-book-author">Brian Tracy</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Process</span><span class="lrn-book-tag">Mindset</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Top 20% mindset</strong> — The top performers in any field think and act differently. They focus on their best opportunities and refuse to waste time on low-probability setups.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Rejection is part of the process</strong> — Every losing trade is a rejection. Those who can process and move past rejection without emotional scarring will vastly outperform those who can't.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Continuous self-improvement</strong> — 1 hour of daily learning in your field compounds over a decade into unassailable expertise. The serious trader is always a student.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(99,102,241,0.12);color:#818cf8">⭐</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Pitch Anything</div>
              <div class="lrn-book-author">Oren Klaff</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Framing</span><span class="lrn-book-tag">Deals</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Frame control</strong> — Whoever sets the frame controls the conversation. In markets, the institutional player sets the frame; retail reacts. Understand the macro frame before entering.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Novelty drives the croc brain</strong> — The market's first reaction to news is primitive and often wrong. This overreaction is where the disciplined trader finds opportunity.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Status and alpha</strong> — Traders who need market validation (status from wins) are at the mercy of price. True edge comes from indifference to any single outcome.</div></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Negotiation -->
    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">🤝</span><span class="lrn-cat-label">Negotiation & Decision-Making</span><span class="lrn-cat-count">5 essential reads</span></div>
      <div class="lrn-books-grid">

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(212,168,71,0.12);color:var(--amber2)">🎯</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Never Split the Difference</div>
              <div class="lrn-book-author">Chris Voss</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Tactical</span><span class="lrn-book-tag">FBI Negotiation</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Tactical empathy</strong> — Acknowledge emotions without endorsing them. In trading: acknowledge the fear or greed you feel without acting on it. Naming the emotion defuses it.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Calibrated questions</strong> — "How am I supposed to do that?" These open-ended queries reveal hidden information. Ask the same of your trades: what would have to be true for this to work?</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>No is the beginning</strong> — In trading, a failed setup is a "no". That rejection is not failure — it is information about where the real opportunity is forming.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The Black Swan</strong> — In negotiation as in markets: there are always unknowns that can destroy your thesis. Probe for them before committing.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(74,222,128,0.1);color:var(--green)">🏛</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Getting to Yes</div>
              <div class="lrn-book-author">Fisher, Ury & Patton</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Classic</span><span class="lrn-book-tag">Harvard Method</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Separate people from the problem</strong> — Don't let the emotional content of a trade cloud the objective analysis. The position is not you; it's a problem to be solved.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Focus on interests, not positions</strong> — In markets: your stated position is "I want this stock to go up" — but your interest is capital growth. An inverse ETF serves that interest equally.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Objective criteria</strong> — Negotiate against the market using objective data: earnings, trend, R/R, volume. Subjective views get exploited by those with systems.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(34,211,238,0.1);color:var(--cyan)">🧩</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Thinking in Bets</div>
              <div class="lrn-book-author">Annie Duke</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Decision-Making</span><span class="lrn-book-tag">Probability</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Resulting</strong> — Judging a decision by its outcome rather than the quality of the process. A good decision can produce a bad result. Don't let outcomes corrupt your process evaluation.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Probabilistic thinking</strong> — Every trade is a bet at odds. Stating explicit probabilities before trading forces precision and reduces overconfidence dramatically.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>10-10-10 rule</strong> — How will I feel about this decision in 10 minutes, 10 months, 10 years? Slows impulsive trades and keeps long-term thinking active.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(248,113,113,0.1);color:var(--red)">🔑</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">The Art of Thinking Clearly</div>
              <div class="lrn-book-author">Rolf Dobelli</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Biases</span><span class="lrn-book-tag">Reference</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>99 cognitive errors</strong> — A comprehensive catalogue of systematic thinking mistakes. Traders suffer from every single one. Knowing them lets you pre-empt them.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Sunk cost fallacy</strong> — We continue bad investments because of what we've already put in. The trade doesn't know or care what you paid. Evaluate from current state only.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Survivorship bias</strong> — We only see the successful traders who share their systems. For every millionaire trend follower, hundreds have failed using the same system.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(99,102,241,0.12);color:#818cf8">⚡</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Superforecasting</div>
              <div class="lrn-book-author">Philip Tetlock & Dan Gardner</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Forecasting</span><span class="lrn-book-tag">Probability</span><span class="lrn-book-tag">Calibration</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Calibrated uncertainty</strong> — The best forecasters are neither overconfident nor underconfident. They express precise probabilities and update them with new data constantly.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Outside vs inside view</strong> — The inside view is your thesis about this specific trade. The outside view asks: what typically happens in cases like this? Base rate thinking is enormously powerful.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Dragonfly thinking</strong> — Look at every question from many angles simultaneously. The superforecaster (and super-trader) synthesises multiple frameworks, not just one.</div></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Human Behaviour -->
    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">🧬</span><span class="lrn-cat-label">Human Behaviour & Social Dynamics</span><span class="lrn-cat-count">5 essential reads</span></div>
      <div class="lrn-books-grid">

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(212,168,71,0.12);color:var(--amber2)">🌐</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Thinking, Fast and Slow</div>
              <div class="lrn-book-author">Daniel Kahneman</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Dual Process</span><span class="lrn-book-tag">Biases</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>WYSIATI</strong> — What You See Is All There Is. We construct complete narratives from limited information. This is why traders become overconfident on incomplete data.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Prospect theory</strong> — We feel losses twice as intensely as equivalent gains. This irrational weighting drives traders to hold losers and sell winners — the exact opposite of correct behaviour.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Peak-end rule</strong> — We remember experiences by their peak intensity and their ending. A trading session that ends with a loss feels like a terrible day even with cumulative profits.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(74,222,128,0.1);color:var(--green)">🐇</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Predictably Irrational</div>
              <div class="lrn-book-author">Dan Ariely</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Behavioural Economics</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Arbitrary coherence</strong> — Once we anchor on a price (like our entry price), all subsequent valuations are influenced by it. Anchoring to entry price is one of the most costly trading mistakes.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The power of free</strong> — "Free" creates irrational decisions. In markets, the equivalent is zero-commission trading — the feeling of no cost changes behaviour in ways that destroy returns.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Emotions override logic</strong> — In every experiment, when emotions are elevated, logical decision-making collapses. Pre-define every decision before emotions get involved.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(34,211,238,0.1);color:var(--cyan)">🦅</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Sapiens</div>
              <div class="lrn-book-author">Yuval Noah Harari</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Big Picture</span><span class="lrn-book-tag">Money Origins</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Money as shared fiction</strong> — Currency only has value because we all believe it does. Markets are elaborate shared fictions, and understanding this makes you a better participant in them.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Intersubjective reality</strong> — Markets exist in the space between subjective belief and objective fact. Understanding crowd psychology means understanding how shared beliefs move prices.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The cognitive revolution</strong> — Humans are wired for storytelling, not probabilistic thinking. Our default mode creates narratives, which is why story-driven investment is so dangerous.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(248,113,113,0.1);color:var(--red)">🐑</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Extraordinary Popular Delusions and the Madness of Crowds</div>
              <div class="lrn-book-author">Charles Mackay</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Market History</span><span class="lrn-book-tag">Classic</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The crowd goes mad together</strong> — Tulip mania, South Sea bubble, every speculative excess in history followed the same arc. The anatomy of a bubble is as recognisable today as in 1637.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Men think in herds</strong> — Social contagion drives prices far beyond any fundamental value. Recognising when you are part of the herd is the edge that lets you exit before the stampede reverses.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Slow recovery, fast collapse</strong> — Every bubble inflates slowly and pops catastrophically. The asymmetry of the crash versus the build is a permanent feature of crowd psychology in markets.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(99,102,241,0.12);color:#818cf8">🌊</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">The Wisdom of Crowds</div>
              <div class="lrn-book-author">James Surowiecki</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Markets</span><span class="lrn-book-tag">Aggregation</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>When crowds are wise</strong> — Diverse, independent, decentralised groups produce better estimates than experts. Markets work when these conditions hold — and fail when they break down.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>When crowds fail</strong> — When people copy each other (herding) the aggregation mechanism breaks. Correlation becomes 1 and the wisdom becomes madness. This is the bubble mechanism.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Information aggregation</strong> — Markets are efficient at aggregating dispersed information — but only on average. Structural inefficiencies persist at the edges where information is private or complex.</div></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Money -->
    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">💰</span><span class="lrn-cat-label">Money, Wealth & Personal Finance</span><span class="lrn-cat-count">5 essential reads</span></div>
      <div class="lrn-books-grid">

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(212,168,71,0.12);color:var(--amber2)">💰</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Rich Dad Poor Dad</div>
              <div class="lrn-book-author">Robert T. Kiyosaki</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Mindset</span><span class="lrn-book-tag">Assets</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Assets vs liabilities</strong> — An asset puts money in your pocket; a liability takes it out. The wealthy buy assets. Trading is learning to generate assets from capital.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>The rat race</strong> — Working for money keeps you dependent on income. Building capital that generates income is financial independence. Trading is a path out of the rat race.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Financial education is the real asset</strong> — No amount of money matters without the knowledge to grow and protect it. Investment in financial literacy has the highest ROI of any asset class.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Work to learn, not to earn</strong> — Early in your trading journey, focus on skill acquisition, not P&L. The skills compound into money; chasing money without skill destroys both.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(74,222,128,0.1);color:var(--green)">🧠</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">The Millionaire Next Door</div>
              <div class="lrn-book-author">Thomas Stanley & William Danko</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Wealth Building</span><span class="lrn-book-tag">Data-Driven</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>PAW vs UAW</strong> — Prodigious Accumulators of Wealth live below their means and invest the difference. Under-Accumulators consume it. Profitable trading requires PAW habits.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Income is not wealth</strong> — High income without investment discipline produces zero long-term wealth. The consistent saver with modest income beats the high earner who spends it all.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Frugality as a system</strong> — The most consistent wealth builders treat spending with the same discipline they apply to investing: every dollar allocated intentionally.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(34,211,238,0.1);color:var(--cyan)">⏱</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">I Will Teach You to Be Rich</div>
              <div class="lrn-book-author">Ramit Sethi</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag">Practical</span><span class="lrn-book-tag">Systems</span><span class="lrn-book-tag">Automation</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Automate the boring decisions</strong> — Systems that remove decisions from the equation produce better outcomes. The same principle applies to trading: systematic rules outperform discretionary impulses.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Spend extravagantly on what you love</strong> — Cut mercilessly on what you don't. Focused capital allocation, not generic frugality, is the wealth-building principle.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Action over analysis</strong> — A slightly imperfect plan executed today beats the perfect plan executed later. Getting into the market — even imperfectly — beats waiting for the perfect setup forever.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(248,113,113,0.1);color:var(--red)">🎲</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">Fooled by Randomness</div>
              <div class="lrn-book-author">Nassim Nicholas Taleb</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Luck vs Skill</span><span class="lrn-book-tag">Probability</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Randomness masquerades as skill</strong> — Short-run trading profits may reflect luck more than skill. You need hundreds of trades in identical conditions to separate the two.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Alternative histories</strong> — We see the one timeline that occurred. Millions of alternative timelines where the lucky trader blew up are invisible to us. This blinds us to true risk.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Skewness matters more than frequency</strong> — A strategy that loses small 95% of the time but wins enormously 5% of the time can be highly profitable. Think in expected value, not win rate alone.</div></div>
            </div>
          </div>
        </div>

        <div class="lrn-book" onclick="lrnToggleBook(this)">
          <div class="lrn-book-top">
            <div class="lrn-book-spine" style="background:rgba(99,102,241,0.12);color:#818cf8">🏆</div>
            <div class="lrn-book-info">
              <div class="lrn-book-title">The Richest Man in Babylon</div>
              <div class="lrn-book-author">George S. Clason</div>
              <div class="lrn-book-rating"><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span><span class="lrn-bstar on">★</span></div>
              <div class="lrn-book-tags"><span class="lrn-book-tag must">Must Read</span><span class="lrn-book-tag">Timeless</span><span class="lrn-book-tag">Classic</span></div>
            </div>
            <span class="lrn-book-arrow">▼</span>
          </div>
          <div class="lrn-book-concepts">
            <div class="lrn-concept-label">Key Concepts</div>
            <div class="lrn-concept-list">
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Pay yourself first</strong> — Keep a part of all you earn. 10% minimum. Applied to trading: always protect at least a portion of capital from every profitable trade.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Make gold work for you</strong> — Capital that is not invested is capital decaying. Every dollar must be put to work in an asset that compounds. Idle cash loses to inflation always.</div></div>
              <div class="lrn-concept-item"><div class="lrn-concept-dot"></div><div class="lrn-concept-text"><strong>Guard thy treasures from loss</strong> — The first priority is to not lose money. Capital preservation is not conservative — it is the foundation of every compounding wealth journey.</div></div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div><!-- end books pane -->

  <!-- ── RESOURCES PANE ── -->
  <div id="lrn-pane-resources" class="lrn-pane">

    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">📺</span><span class="lrn-cat-label">YouTube Channels & Video Content</span></div>
      <div class="lrn-res-grid">
        <div class="lrn-res-card"><div class="lrn-res-type">📺 YouTube</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Real Vision</div><div class="lrn-res-desc">In-depth macro interviews with hedge fund legends, economists and global investors. Unsurpassed depth on macro and alternative investments.</div><a class="lrn-res-link" href="https://youtube.com/@RealVision" target="_blank">youtube.com/@RealVision →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">📺 YouTube</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Chat with Traders</div><div class="lrn-res-desc">Aaron Fifield interviews professional retail and institutional traders. Focuses on practical edge, psychology and risk management systems.</div><a class="lrn-res-link" href="https://youtube.com/@ChatWithTraders" target="_blank">youtube.com/@ChatWithTraders →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">📺 YouTube</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Investors Archive</div><div class="lrn-res-desc">Archive of talks by Buffett, Munger, Lynch, Klarman and every major value investor ever filmed. A priceless educational library.</div><a class="lrn-res-link" href="https://youtube.com/@InvestorsArchive" target="_blank">youtube.com/@InvestorsArchive →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">📺 YouTube</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Patrick Boyle</div><div class="lrn-res-desc">Former hedge fund manager explains complex finance topics with clarity and wit. Best explainer of quant finance, macro and market history on YouTube.</div><a class="lrn-res-link" href="https://youtube.com/@PBoyle" target="_blank">youtube.com/@PBoyle →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">📺 YouTube</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">SMB Capital</div><div class="lrn-res-desc">NYC prop trading firm sharing intraday setups, trading psychology and trader development content. Exceptional for active traders.</div><a class="lrn-res-link" href="https://youtube.com/@smbcapital" target="_blank">youtube.com/@smbcapital →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">📺 YouTube</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Zerodha Varsity</div><div class="lrn-res-desc">India's most comprehensive trading education platform. Covers everything from equity basics to options strategies, completely free.</div><a class="lrn-res-link" href="https://youtube.com/@zerodha" target="_blank">youtube.com/@zerodha →</a></div>
      </div>
    </div>

    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">🎙</span><span class="lrn-cat-label">Podcasts</span></div>
      <div class="lrn-res-grid">
        <div class="lrn-res-card"><div class="lrn-res-type">🎙 Podcast</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Acquired</div><div class="lrn-res-desc">Deep-dive episodes on the greatest companies and business stories ever. Exceptional for understanding competitive moats and capital allocation.</div></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🎙 Podcast</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Invest Like the Best</div><div class="lrn-res-desc">Patrick O'Shaughnessy interviews the world's best investors and thinkers. Consistently the highest signal-to-noise podcast in finance.</div></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🎙 Podcast</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Masters in Business (Bloomberg)</div><div class="lrn-res-desc">Barry Ritholtz's long-form interviews with legends of investing, research and behavioural finance. Over 500 episodes of exceptional content.</div></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🎙 Podcast</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">The Tim Ferriss Show</div><div class="lrn-res-desc">Interviews with world-class performers including many top traders and investors. Focus on habits, mental models and decision-making frameworks.</div></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🎙 Podcast</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">We Study Billionaires</div><div class="lrn-res-desc">The Investor's Podcast Network studying the habits and strategies of Warren Buffett, Charlie Munger and other investment legends.</div></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🎙 Podcast</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Macro Voices</div><div class="lrn-res-desc">Weekly macro analysis from professional fund managers. Advanced content on rates, commodities, currencies and global macro themes.</div></div>
      </div>
    </div>

    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">🌐</span><span class="lrn-cat-label">Websites & Newsletters</span></div>
      <div class="lrn-res-grid">
        <div class="lrn-res-card"><div class="lrn-res-type">🌐 Website</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Zerodha Varsity</div><div class="lrn-res-desc">Comprehensive, free financial education covering markets, fundamentals, technical analysis and derivatives. Best structured curriculum for Indian markets.</div><a class="lrn-res-link" href="https://zerodha.com/varsity" target="_blank">zerodha.com/varsity →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">📰 Newsletter</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Collab Fund (Morgan Housel)</div><div class="lrn-res-desc">Essays on wealth, psychology and long-term thinking. Some of the best financial writing on the internet. Required reading for any serious investor.</div><a class="lrn-res-link" href="https://collabfund.com/blog" target="_blank">collabfund.com/blog →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🌐 Website</div><span class="lrn-res-badge freemium">Freemium</span><div class="lrn-res-name">Finviz</div><div class="lrn-res-desc">Powerful stock screener and market heatmap. Visualise market conditions, sector rotation and individual stock setups at a glance.</div><a class="lrn-res-link" href="https://finviz.com" target="_blank">finviz.com →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">📰 Newsletter</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">The Daily Shot</div><div class="lrn-res-desc">Daily visual briefing on global macro data — charts on every major economic indicator across all asset classes. Exceptional signal density.</div><a class="lrn-res-link" href="https://dailyshotbrief.com" target="_blank">dailyshotbrief.com →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🌐 Website</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Investopedia</div><div class="lrn-res-desc">The definitive reference for financial definitions, concepts and tutorials. A first port of call for understanding any financial term or concept.</div><a class="lrn-res-link" href="https://investopedia.com" target="_blank">investopedia.com →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">📰 Newsletter</div><span class="lrn-res-badge paid">Paid</span><div class="lrn-res-name">Breakingviews (Reuters)</div><div class="lrn-res-desc">Incisive, independent commentary on major financial events and deals. Trains critical thinking on corporate finance and market developments.</div><a class="lrn-res-link" href="https://reuters.com/breakingviews" target="_blank">reuters.com/breakingviews →</a></div>
      </div>
    </div>

    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">🛠</span><span class="lrn-cat-label">Tools & Platforms</span></div>
      <div class="lrn-res-grid">
        <div class="lrn-res-card"><div class="lrn-res-type">🛠 Charting</div><span class="lrn-res-badge freemium">Freemium</span><div class="lrn-res-name">TradingView</div><div class="lrn-res-desc">The world's best charting platform. Multi-timeframe analysis, 100+ indicators, Pine Script custom indicators and social idea sharing.</div><a class="lrn-res-link" href="https://tradingview.com" target="_blank">tradingview.com →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🛠 Fundamentals</div><span class="lrn-res-badge freemium">Freemium</span><div class="lrn-res-name">Screener.in</div><div class="lrn-res-desc">India's best fundamental screener. 10-year financials, ratio analysis, custom screens and peer comparison for every listed Indian company.</div><a class="lrn-res-link" href="https://screener.in" target="_blank">screener.in →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🛠 Data</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">FRED (Federal Reserve)</div><div class="lrn-res-desc">800,000+ economic data series from global central banks and statistical agencies. The definitive macro data repository, completely free.</div><a class="lrn-res-link" href="https://fred.stlouisfed.org" target="_blank">fred.stlouisfed.org →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🛠 Options</div><span class="lrn-res-badge freemium">Freemium</span><div class="lrn-res-name">Sensibull</div><div class="lrn-res-desc">India's best options analysis platform. Strategy builder, Greeks, payoff graphs and open interest analysis for NSE derivatives.</div><a class="lrn-res-link" href="https://sensibull.com" target="_blank">sensibull.com →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🛠 Terminal</div><span class="lrn-res-badge freemium">Freemium</span><div class="lrn-res-name">Koyfin</div><div class="lrn-res-desc">Bloomberg-style terminal for retail investors. Macro dashboards, earnings estimates, fund flows and global market data at a fraction of the cost of professional tools.</div><a class="lrn-res-link" href="https://koyfin.com" target="_blank">koyfin.com →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🛠 Backtesting</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">QuantConnect</div><div class="lrn-res-desc">Open-source algorithmic trading platform. Backtest strategies across equities, forex, futures and crypto with institutional-grade data. The standard for quant research.</div><a class="lrn-res-link" href="https://quantconnect.com" target="_blank">quantconnect.com →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🛠 Screener</div><span class="lrn-res-badge freemium">Freemium</span><div class="lrn-res-name">Finviz</div><div class="lrn-res-desc">Powerful stock screener and market heatmap. Visualise market conditions, sector rotation and individual stock setups at a glance.</div><a class="lrn-res-link" href="https://finviz.com" target="_blank">finviz.com →</a></div>
      </div>
    </div>

    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">📜</span><span class="lrn-cat-label">Must-Read Letters & Articles</span></div>
      <div class="lrn-res-grid">
        <div class="lrn-res-card"><div class="lrn-res-type">📜 Letters</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Buffett Letters (1957–present)</div><div class="lrn-res-desc">Warren Buffett's annual letters to Berkshire shareholders are the greatest free education in capital allocation, business valuation and investment philosophy ever written.</div><a class="lrn-res-link" href="https://berkshirehathaway.com/letters/letters.html" target="_blank">berkshirehathaway.com/letters →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">📜 Memos</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Howard Marks Memos (Oaktree)</div><div class="lrn-res-desc">The memos Warren Buffett reads first. Howard Marks on market cycles, risk, human nature and second-level thinking. Required reading for every serious investor.</div><a class="lrn-res-link" href="https://www.oaktreecapital.com/insights/memos" target="_blank">oaktreecapital.com/insights/memos →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">📝 Articles</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Farnam Street Blog</div><div class="lrn-res-desc">Shane Parrish's blog on mental models, decision-making and learning from the best minds in history. The most comprehensive mental model library available online.</div><a class="lrn-res-link" href="https://fs.blog" target="_blank">fs.blog →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">📜 Letters</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Fed FOMC Minutes & Speeches</div><div class="lrn-res-desc">Reading central bank communications directly is the most valuable macro skill. Understand what the Fed is thinking before the market prices it in.</div><a class="lrn-res-link" href="https://federalreserve.gov/monetarypolicy/fomccalendars.htm" target="_blank">federalreserve.gov →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">📝 Research</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">SSRN (Social Science Research Network)</div><div class="lrn-res-desc">Academic finance papers before publication. The cutting edge of quantitative research — where real market anomalies and risk premia are documented before they become crowded.</div><a class="lrn-res-link" href="https://ssrn.com" target="_blank">ssrn.com →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">📜 Letters</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Druckenmiller Speeches & Interviews</div><div class="lrn-res-desc">Stanley Druckenmiller's keynote speeches and interviews are among the most valuable macro education available. His 2015 Lost Tree Club speech is essential reading.</div><a class="lrn-res-link" href="https://youtube.com/results?search_query=druckenmiller+speech" target="_blank">Search YouTube →</a></div>
      </div>
    </div>

    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">🎓</span><span class="lrn-cat-label">Courses & Structured Learning</span></div>
      <div class="lrn-res-grid">
        <div class="lrn-res-card"><div class="lrn-res-type">🎓 Course</div><span class="lrn-res-badge paid">Paid</span><div class="lrn-res-name">Investopedia Academy</div><div class="lrn-res-desc">Structured, accredited financial courses from basics to advanced options strategies. The most credible mainstream online financial education platform.</div><a class="lrn-res-link" href="https://academy.investopedia.com" target="_blank">academy.investopedia.com →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🎓 Course</div><span class="lrn-res-badge paid">Paid</span><div class="lrn-res-name">Warrior Trading</div><div class="lrn-res-desc">Ross Cameron's active trading course. Best-in-class for momentum trading, scanners, and developing a structured intraday trading methodology with live mentorship.</div><a class="lrn-res-link" href="https://warriortrading.com" target="_blank">warriortrading.com →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🎓 Certification</div><span class="lrn-res-badge paid">Paid</span><div class="lrn-res-name">CFA Program (CFA Institute)</div><div class="lrn-res-desc">The gold standard of investment professional credentials. Even if you don't take the exam, the CFA curriculum Level 1 is the most comprehensive financial education available.</div><a class="lrn-res-link" href="https://cfainstitute.org" target="_blank">cfainstitute.org →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🎓 Course</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Zerodha Varsity</div><div class="lrn-res-desc">India's most comprehensive and completely free financial curriculum. From basics of the stock market to complex options strategies — written in accessible, practical language.</div><a class="lrn-res-link" href="https://zerodha.com/varsity" target="_blank">zerodha.com/varsity →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🎓 Course</div><span class="lrn-res-badge paid">Paid</span><div class="lrn-res-name">SMB Capital Training Program</div><div class="lrn-res-desc">New York's elite prop trading firm training programme. Focused on professional-grade tape reading, risk management and systematic trading methodology development.</div><a class="lrn-res-link" href="https://smbtraining.com" target="_blank">smbtraining.com →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">🎓 Course</div><span class="lrn-res-badge freemium">Freemium</span><div class="lrn-res-name">Coursera — Financial Markets (Yale)</div><div class="lrn-res-desc">Robert Shiller's free Yale course on financial markets. Covers the psychology of speculation, market history, behavioural finance and the role of finance in society.</div><a class="lrn-res-link" href="https://coursera.org/learn/financial-markets-global" target="_blank">coursera.org →</a></div>
      </div>
    </div>

    <div class="lrn-cat-section">
      <div class="lrn-cat-head"><span class="lrn-cat-icon">👥</span><span class="lrn-cat-label">Communities & Forums</span></div>
      <div class="lrn-res-grid">
        <div class="lrn-res-card"><div class="lrn-res-type">👥 Community</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">r/SecurityAnalysis (Reddit)</div><div class="lrn-res-desc">The highest quality investment discussion on Reddit. Deep fundamental analysis, earnings breakdowns, and serious long-form research on individual equities. Signal-rich for serious investors.</div><a class="lrn-res-link" href="https://reddit.com/r/SecurityAnalysis" target="_blank">reddit.com/r/SecurityAnalysis →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">👥 Community</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">Trade2Win Forums</div><div class="lrn-res-desc">One of the longest-running active trading communities on the internet. Deep discussions on technical analysis, system development, psychology and broker reviews.</div><a class="lrn-res-link" href="https://trade2win.com" target="_blank">trade2win.com →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">👥 Community</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">TradingView Community Scripts</div><div class="lrn-res-desc">Over 100,000 community-created Pine Script indicators and strategies. A resource for finding, testing and adapting custom technical tools to your specific edge.</div><a class="lrn-res-link" href="https://tradingview.com/scripts" target="_blank">tradingview.com/scripts →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">👥 Community</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">QuantLib / Quantopian Alumni (GitHub)</div><div class="lrn-res-desc">Open-source quantitative finance community. Access to backtesting frameworks, factor libraries and quant research from former Quantopian researchers and current practitioners.</div><a class="lrn-res-link" href="https://github.com/topics/quantitative-finance" target="_blank">github.com →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">👥 Community</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">NSE / BSE Investor Education</div><div class="lrn-res-desc">Official investor education portals from India's premier exchanges. Regulatory updates, market structure explanations and structured financial literacy programs.</div><a class="lrn-res-link" href="https://nseindia.com/invest/education" target="_blank">nseindia.com →</a></div>
        <div class="lrn-res-card"><div class="lrn-res-type">👥 Community</div><span class="lrn-res-badge free">Free</span><div class="lrn-res-name">The Knowledge Project (Farnam Street Community)</div><div class="lrn-res-desc">Shane Parrish's podcast and community focused on decision-making, mental models and learning from the smartest people alive. Essential for the intellectual side of trading mastery.</div><a class="lrn-res-link" href="https://fs.blog/knowledge-project-podcast" target="_blank">fs.blog/knowledge-project →</a></div>
      </div>
    </div>

  </div><!-- end resources pane -->

  <!-- ── MENTORS PANE ── -->
  <div id="lrn-pane-mentors" class="lrn-pane">
    <div class="lrn-mentor-grid">

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">🦁</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Warren Buffett</div>
            <div class="lrn-mentor-title">Chairman, Berkshire Hathaway · $120B+ net worth</div>
            <div class="lrn-mentor-style"><span>Value Investing</span><span>Long-Term</span><span>Concentrated</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">The greatest investor in history. Started with $100 as a teenager and compounded it to over $100 billion over 70 years using fundamental value investing. Known for holding forever, reading voraciously (500 pages/day) and thinking independently.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">Only invest in businesses you can understand completely and hold for a decade or more.</div>
            <div class="lrn-mentor-lesson">Be fearful when others are greedy, and greedy when others are fearful. Contrarianism at the right moment is the edge.</div>
            <div class="lrn-mentor-lesson">Price is what you pay, value is what you get. The spread between the two is the entire game.</div>
            <div class="lrn-mentor-lesson">Rule #1: Never lose money. Rule #2: Never forget Rule #1. Preservation is always first.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"The stock market is a device for transferring money from the impatient to the patient."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">🌊</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Ray Dalio</div>
            <div class="lrn-mentor-title">Founder, Bridgewater Associates · Largest Hedge Fund Ever</div>
            <div class="lrn-mentor-style"><span>Macro</span><span>Systematic</span><span>All-Weather</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">Built Bridgewater from scratch in his apartment to a $150B hedge fund. Created the "All Weather" portfolio concept and "Radical Transparency" culture. His mental model of economic cycles is the most complete framework for macro investors ever codified.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">Understand the debt cycle template — every crisis follows the same arc. Identify the current phase before positioning.</div>
            <div class="lrn-mentor-lesson">Diversification is the holy grail of investing. 15 uncorrelated return streams dramatically reduces risk without reducing returns.</div>
            <div class="lrn-mentor-lesson">Pain + Reflection = Progress. Every mistake is a puzzle to solve, not an embarrassment to hide.</div>
            <div class="lrn-mentor-lesson">The machine of economics is simple: credit drives spending, spending drives income, income drives credit. Understand the machine.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"The biggest mistake investors make is to believe that what happened in the recent past is likely to persist."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">⚡</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Paul Tudor Jones</div>
            <div class="lrn-mentor-title">Founder, Tudor Investment Corp · Macro Legend</div>
            <div class="lrn-mentor-style"><span>Macro</span><span>Trend Following</span><span>Risk-First</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">Famously predicted and profited from the 1987 Black Monday crash. Has never had a losing year in 40 years of trading. Obsessed with risk management above all else. His 5:1 reward-to-risk rule is one of the most important rules in active trading.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">Never risk more than 1-2% of your account on a single trade. Losers average losers.</div>
            <div class="lrn-mentor-lesson">The most important rule is to play great defence, not great offence. Don't focus on making money — focus on protecting what you have.</div>
            <div class="lrn-mentor-lesson">Every day I assume every position I own is wrong. I know where my stops are before I enter. I never hold a losing position.</div>
            <div class="lrn-mentor-lesson">5:1 is the minimum acceptable reward-to-risk. Being wrong 80% of the time can still be massively profitable with this ratio.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"The secret to being successful from a trading perspective is to have an indefatigable and an undying and unquenchable thirst for information and knowledge."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">🎯</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Mark Douglas</div>
            <div class="lrn-mentor-title">Author · Trading Psychologist · Founder, Institute of Trading Mastery</div>
            <div class="lrn-mentor-style"><span>Psychology</span><span>Mindset</span><span>Consistency</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">The most influential trading psychologist of all time. His books "Trading in the Zone" and "The Disciplined Trader" have directly influenced more profitable traders than any other author. His framework for probabilistic thinking changed how the world understands trading consistency.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">Think in probabilities, not certainties. Each trade is just one of the next thousand in your sample size. No single outcome matters.</div>
            <div class="lrn-mentor-lesson">The market is not against you. It's indifferent to you. Personalising market moves is the root of most trading errors.</div>
            <div class="lrn-mentor-lesson">Consistent performance requires consistent thinking. An inconsistent mindset will undermine even the best trading system.</div>
            <div class="lrn-mentor-lesson">Fear and euphoria are the two emotions that destroy traders. Both distort risk perception. The zone is the space between them.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"The best traders have developed an attitude, a unique set of beliefs about trading, that prevents fear from being an issue."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">🔬</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Jesse Livermore</div>
            <div class="lrn-mentor-title">The Greatest Speculator Who Ever Lived · $100M fortune in 1929</div>
            <div class="lrn-mentor-style"><span>Tape Reading</span><span>Trend Following</span><span>Psychology</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">Started trading with $5 in bucket shops as a teenager, went on to make $100 million in 1929 by shorting the crash. Lost and made multiple fortunes. His tragic end teaches as much as his triumphs. The original trend follower whose lessons remain valid 100 years later.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">It was never my thinking that made the big money for me. It was always my sitting. Patient waiting is a position in itself.</div>
            <div class="lrn-mentor-lesson">Markets are never wrong — opinions often are. When the market speaks, listen. Your opinion is irrelevant.</div>
            <div class="lrn-mentor-lesson">Cut your losses quickly and without mercy. Every big trader you know of built their career on this single discipline.</div>
            <div class="lrn-mentor-lesson">The stock market is not a casino unless you make it one. Discipline and preparation are what separate speculation from gambling.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"There is nothing new in Wall Street. There can't be because speculation is as old as the hills."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">📊</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Ed Seykota</div>
            <div class="lrn-mentor-title">Pioneer of Systematic Trading · 250,000% returns over 16 years</div>
            <div class="lrn-mentor-style"><span>Trend Following</span><span>Systematic</span><span>Psychology</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">One of the greatest traders of all time, turned $5,000 into over $15 million in 12 years. Created one of the first computerised trading systems. His insight that psychology drives trading results more than strategy is his most enduring legacy.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">The elements of good trading are: 1) Cut losses, 2) Ride winners, 3) Keep bets small, 4) Follow the rules without question, 5) Know when to break the rules.</div>
            <div class="lrn-mentor-lesson">Win or lose, everybody gets what they want out of the market. Some people seem to like to lose. Be honest about your hidden agendas.</div>
            <div class="lrn-mentor-lesson">Fundamentals aren't important in trading. What's important is price action and trend. Price is the only universal truth in markets.</div>
            <div class="lrn-mentor-lesson">The trend is your friend until the end when it bends. But the bend is the opportunity. Master regime recognition.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"The market is a device for finding out who is right about price and timing — and the answer is usually the trend."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">🧘</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Charlie Munger</div>
            <div class="lrn-mentor-title">Vice Chairman, Berkshire Hathaway · The Architect of Mental Models</div>
            <div class="lrn-mentor-style"><span>Mental Models</span><span>Multi-Discipline</span><span>Inversion</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">Buffett's partner and the intellectual force behind Berkshire's evolution from pure Graham-style value investing to buying wonderful businesses at fair prices. His multi-disciplinary latticework of mental models approach is the most complete thinking framework in finance.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">Invert, always invert. Ask what causes failure, then systematically avoid those things. Most success comes from avoiding stupidity.</div>
            <div class="lrn-mentor-lesson">All I want to know is where I'm going to die, so I'll never go there. Risk management through anticipatory avoidance.</div>
            <div class="lrn-mentor-lesson">The big money is not in buying and selling, but in the waiting. Good businesses held forever compound without tax friction.</div>
            <div class="lrn-mentor-lesson">Acquire worldly wisdom and make it work for you. You need a wide base of knowledge to connect the dots that others miss.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"It's not supposed to be easy. Anyone who finds it easy is stupid."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">🌀</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">George Soros</div>
            <div class="lrn-mentor-title">Founder, Soros Fund Management · The Man Who Broke the Bank of England</div>
            <div class="lrn-mentor-style"><span>Global Macro</span><span>Reflexivity</span><span>Conviction Sizing</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">Made $1 billion in a single day in 1992 by shorting the British pound. Created the theory of reflexivity — that investor perceptions shape fundamentals which shape perceptions in self-reinforcing loops. The greatest macro trader of all time.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">It's not whether you're right or wrong, but how much money you make when you're right and how much you lose when you're wrong.</div>
            <div class="lrn-mentor-lesson">I'm only rich because I know when I'm wrong. The ability to admit a mistake and reverse course is the greatest trading skill.</div>
            <div class="lrn-mentor-lesson">Markets are always in a state of uncertainty and flux. Money is made by discounting the obvious and betting on the unexpected.</div>
            <div class="lrn-mentor-lesson">When a market becomes reflexively self-reinforcing, ride it until the inflection point — then short it ruthlessly.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"Once we realize that imperfect understanding is the human condition, there is no shame in being wrong, only in failing to correct our mistakes."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">🐉</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Stanley Druckenmiller</div>
            <div class="lrn-mentor-title">Former Chief Strategist, Soros Fund Management · 30-Year Streak Without a Losing Year</div>
            <div class="lrn-mentor-style"><span>Global Macro</span><span>Concentration</span><span>Asymmetric Risk</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">The man many consider the greatest macro trader ever. Ran Duquesne Capital for 30 years without a single down year, averaging 30% annually. Worked under Soros and was the brain behind breaking the Bank of England. Known for concentrated bets and radical flexibility in changing his mind.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">The way to build superior long-term returns is through preservation of capital and home runs. You can be wrong 30% of the time and still be a legend if your winners are enormous.</div>
            <div class="lrn-mentor-lesson">Put all your eggs in one basket and watch that basket very carefully. Concentration in high-conviction ideas, not diversification, is what creates exceptional returns.</div>
            <div class="lrn-mentor-lesson">I try to manage the downside, take care of the downside and the upside takes care of itself. Asymmetric risk profile is the entire game.</div>
            <div class="lrn-mentor-lesson">The cardinal sin is not being willing to change your mind. When the facts change, your position must change. Stubbornness is not conviction — it is ego at the expense of capital.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"Earnings don't move the overall market, it's the Federal Reserve Board. Focus on the central banks and focus on the movement of liquidity."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">🔬</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Jim Simons</div>
            <div class="lrn-mentor-title">Founder, Renaissance Technologies · The Greatest Trader Who Ever Lived (by numbers)</div>
            <div class="lrn-mentor-style"><span>Quantitative</span><span>Systematic</span><span>Data-Driven</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">Former mathematician and code-breaker who founded Renaissance Technologies and built the Medallion Fund — which returned 66% annually for 30 years before fees, the greatest track record in financial history. He proved that markets have exploitable patterns if you have the right tools to find them.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">Patterns repeat in markets because human nature repeats. The mathematical tools to find these patterns are the edge. Intuition is just unquantified pattern recognition.</div>
            <div class="lrn-mentor-lesson">Your strategy is only as good as the data. Invest in data infrastructure before anything else. Clean, comprehensive historical data is the foundation of all systematic edge.</div>
            <div class="lrn-mentor-lesson">Small edges, consistently applied with proper leverage, produce extraordinary results. You don't need large per-trade edges. You need edges that persist and can be scaled.</div>
            <div class="lrn-mentor-lesson">Hire the best minds regardless of their background. The best traders at Renaissance were mathematicians, physicists and linguists — not finance people.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"We never override the models. It's painful. It's hard. But it's correct."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">🦊</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Peter Lynch</div>
            <div class="lrn-mentor-title">Former Manager, Fidelity Magellan Fund · 29.2% Annual Returns for 13 Years</div>
            <div class="lrn-mentor-style"><span>Growth Investing</span><span>Bottom-Up</span><span>10-Baggers</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">Ran the Magellan Fund from 1977 to 1990, turning $18 million into $14 billion. The most successful mutual fund manager of all time. His philosophy that ordinary investors have an edge over Wall Street by observing businesses in daily life is revolutionary in its simplicity and power.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">Invest in what you know. The consumer has information advantage over any analyst. If you notice a product becoming ubiquitous before the market does, that is a genuine edge.</div>
            <div class="lrn-mentor-lesson">Know the story and monitor the story. An investment thesis is a narrative about a business. If the story changes, sell — regardless of price movement.</div>
            <div class="lrn-mentor-lesson">The best stock to buy may be the one you already own. Before looking for new ideas, ask whether your existing position deserves more capital first.</div>
            <div class="lrn-mentor-lesson">Everyone has the brainpower to make money in stocks. Not everyone has the stomach. Emotional control in down markets is the real skill, not stock selection.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"Know what you own, and know why you own it."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">📋</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Howard Marks</div>
            <div class="lrn-mentor-title">Co-Founder, Oaktree Capital · Master of Market Cycles and Second-Level Thinking</div>
            <div class="lrn-mentor-style"><span>Credit/Value</span><span>Contrarian</span><span>Risk Assessment</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">Built Oaktree Capital into one of the world's largest alternative investment firms. Famous for his memos, which Warren Buffett says are the first thing he reads when they arrive. His framework for understanding market cycles and second-level thinking is among the most rigorous in finance.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">Second-level thinking: "This company is great, so its stock will rise" is first-level. "This company is great, but everyone knows it, so it's overpriced" is second-level. The market prices in consensus.</div>
            <div class="lrn-mentor-lesson">The most dangerous thing in investing is not knowing where you are in a cycle. Learn to read cycles — not to predict, but to know whether risk is cheap or expensive right now.</div>
            <div class="lrn-mentor-lesson">You can't predict, but you can prepare. Build portfolios that are resilient to multiple scenarios rather than optimised for a single forecast.</div>
            <div class="lrn-mentor-lesson">Resist the urge to think that because things have gone up, they'll continue going up. The best time to be cautious is when optimism is highest.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"The most important thing is not being right; it's being right when others are wrong."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">✍</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Morgan Housel</div>
            <div class="lrn-mentor-title">Partner, Collaborative Fund · Author of The Psychology of Money</div>
            <div class="lrn-mentor-style"><span>Behavioural Finance</span><span>Long-Term</span><span>Simplicity</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">Former Wall Street Journal columnist turned bestselling author. His book The Psychology of Money sold over 3 million copies. His gift is explaining the emotional and behavioural dimensions of financial decision-making in language that anyone can understand and immediately apply.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">Saving is the gap between your ego and your income. The ability to live below your means is the most underrated financial skill. It creates optionality and reduces desperation in trading.</div>
            <div class="lrn-mentor-lesson">Reasonable beats rational. You don't need an optimal financial plan. You need a plan you can actually stick to through fear, greed and uncertainty.</div>
            <div class="lrn-mentor-lesson">Room for error is the most important planning concept. Prepare for a world where things go wrong. The plan that works in adversity is better than the plan optimal only in good times.</div>
            <div class="lrn-mentor-lesson">Wealth is what you don't see. It's the cars not bought, the trades not taken, the risks not exceeded. The visible symbols of wealth are mostly liabilities, not assets.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"The single most powerful variable for building wealth is your savings rate. And it's not as sexy as your investment returns or stock picks."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">💥</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Nassim Nicholas Taleb</div>
            <div class="lrn-mentor-title">Author · Statistician · Former Derivatives Trader · Creator of the Barbell Strategy</div>
            <div class="lrn-mentor-style"><span>Risk Management</span><span>Optionality</span><span>Tail Risk</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">Former derivatives trader turned philosopher of probability and risk. His Incerto series — The Black Swan, Antifragile, Fooled by Randomness — fundamentally changed how sophisticated risk managers think. Made millions on the 1987 crash and 2008 crisis by buying deep out-of-the-money options.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">Never cross a river that is on average 4 feet deep. Average is meaningless in fat-tailed distributions. The rare extreme event is the one that matters most to your survival.</div>
            <div class="lrn-mentor-lesson">Skin in the game changes everything. People with genuine exposure to downside make better decisions than those who theorise without risk. Trade your own money.</div>
            <div class="lrn-mentor-lesson">Barbell your life: maximally safe for 90% and maximally aggressive for 10%. This structure gives you optionality while preventing ruin. Applied to trading: big protection, small speculative bets.</div>
            <div class="lrn-mentor-lesson">Do not be fooled by success in calm environments. Your strategy must be tested against genuine tail scenarios, not just normal distributions of outcomes.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"The fragile wants tranquility, the antifragile grows from disorder."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">🔒</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Chris Voss</div>
            <div class="lrn-mentor-title">Former FBI Lead Hostage Negotiator · Author of Never Split the Difference</div>
            <div class="lrn-mentor-style"><span>Negotiation</span><span>Emotional Intelligence</span><span>Tactical Empathy</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">Spent 24 years as the FBI's top hostage negotiator. His techniques — developed to save lives under the ultimate pressure — translate directly to trading psychology and position management. His framework for managing emotional states is one of the most practical and battle-tested in existence.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">Tactical empathy: Label your emotions. "It seems like I'm feeling FOMO right now." Naming the emotion activates the rational brain and deactivates the reactive one. Use it before every trade.</div>
            <div class="lrn-mentor-lesson">Beware of yes — it's the beginning of commitment cascade. In trading: beware of convincing yourself your thesis is right. Keep seeking disconfirming evidence.</div>
            <div class="lrn-mentor-lesson">Calibrated "how" questions reveal hidden information. "How am I supposed to know when to exit this trade?" forces structured thinking rather than emotional reaction.</div>
            <div class="lrn-mentor-lesson">The person who has less fear of no, wins. In trading: comfort with loss limits and stop orders — being unafraid of a "no" from the market — is genuine edge.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"He who has learned to disagree without being disagreeable has discovered the most valuable secret of negotiation."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">🔮</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Robert Cialdini</div>
            <div class="lrn-mentor-title">Professor of Psychology & Marketing · Author of Influence</div>
            <div class="lrn-mentor-style"><span>Persuasion</span><span>Behavioural Science</span><span>Social Proof</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">World's leading expert on the science of influence and persuasion. His book Influence has sold 5 million copies and is required reading at business schools worldwide. His principles explain precisely why retail traders fall prey to market manipulation, media narratives and crowd psychology.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">Social proof drives market panics and manias. When everyone is selling, the social proof principle forces retail hands. Know this mechanism and you can be the one buying.</div>
            <div class="lrn-mentor-lesson">Scarcity creates urgency. "Last chance to buy before the breakout" is one of the most common manipulation techniques. Manufactured scarcity is everywhere in markets.</div>
            <div class="lrn-mentor-lesson">Commitment and consistency trap traders in losing positions. Once you publicly announce a thesis, you will distort every piece of incoming information to confirm it.</div>
            <div class="lrn-mentor-lesson">Authority bias causes traders to follow "experts" without scrutiny. An analyst's track record, not their title or media presence, is the only metric that matters.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"People don't buy for logical reasons. They buy for emotional reasons."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">🧪</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Daniel Kahneman</div>
            <div class="lrn-mentor-title">Nobel Laureate in Economics · Father of Behavioural Economics</div>
            <div class="lrn-mentor-style"><span>Behavioural Finance</span><span>Biases</span><span>Decision Science</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">Nobel Prize-winning psychologist who, with Amos Tversky, proved that humans are systematically irrational in ways that are predictable and exploitable. His life's work mapping cognitive biases is the single most important body of knowledge for any active market participant.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">System 1 dominates in markets. Emotional, fast, automatic thinking drives most retail trading decisions. The solution is pre-commitment: write your rules before the market opens, not during.</div>
            <div class="lrn-mentor-lesson">What you see is all there is (WYSIATI). We make decisions with whatever information is available and don't feel the absence of information we don't have. This creates massive blind spots in analysis.</div>
            <div class="lrn-mentor-lesson">We don't choose between options — we choose between descriptions of options. Framing effects mean the same trade presented differently will trigger different decisions. Standardise your trade journal format.</div>
            <div class="lrn-mentor-lesson">The experiencing self and the remembering self are different. We journal the remembering self's version of trades, not the experiencing self's reality. This distorts what we learn from review.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"Nothing in life is as important as you think it is while you are thinking about it."</div>
      </div>

      <div class="lrn-mentor">
        <div class="lrn-mentor-top">
          <div class="lrn-mentor-avatar">📐</div>
          <div class="lrn-mentor-info">
            <div class="lrn-mentor-name">Peter Brandt</div>
            <div class="lrn-mentor-title">Veteran Futures Trader · 40+ Years · Author of Diary of a Professional Commodity Trader</div>
            <div class="lrn-mentor-style"><span>Classical Charting</span><span>Risk Management</span><span>Trend Following</span></div>
          </div>
        </div>
        <div class="lrn-mentor-body">
          <div class="lrn-mentor-bio">One of the last of the old-school Chicago pit traders, with over 40 years of consistent profitability trading futures and eventually crypto. Famous for his rigorous risk management, classical chart pattern trading and complete transparency about both wins and losses in real-time.</div>
          <div class="lrn-mentor-lessons">
            <div class="lrn-mentor-lesson">Chart patterns are not magic — they are a language that describes the battle between buyers and sellers. Learn to read the story behind the pattern, not just recognise its shape.</div>
            <div class="lrn-mentor-lesson">My win rate is less than 40%. I am profitable because my winners are much larger than my losers. Win rate is irrelevant. Risk/reward ratio and consistency of application are everything.</div>
            <div class="lrn-mentor-lesson">The definition of a novice trader is someone who adjusts their stop to avoid a loss. The stop is the boundary of your thesis. When price crosses it, the thesis is wrong — period.</div>
            <div class="lrn-mentor-lesson">Any one trade means nothing. A career of disciplined trades means everything. The trader who focuses on the trade is looking at the wrong scale of time.</div>
          </div>
        </div>
        <div class="lrn-mentor-quote">"Being wrong is acceptable. Staying wrong is not."</div>
      </div>

    </div>
  </div><!-- end mentors pane -->

  <!-- ── MY LEARNINGS PANE ── -->
  <div id="lrn-pane-mylearnings" class="lrn-pane">
    <div class="lrn-learning-filters">
      <select class="fi" id="lrn-filter-type" onchange="lrnRenderLearnings()">
        <option value="">All Types</option>
        <option value="book">📚 Book</option>
        <option value="mentor">🧠 Mentor</option>
        <option value="experiment">🧪 Experiment</option>
        <option value="market">📊 Market Observation</option>
      </select>
      <select class="fi" id="lrn-filter-impact" onchange="lrnRenderLearnings()">
        <option value="">All Impact Levels</option>
        <option value="5">⭐⭐⭐⭐⭐ Life-changing</option>
        <option value="4">⭐⭐⭐⭐ High impact</option>
        <option value="3">⭐⭐⭐ Solid insight</option>
        <option value="2">⭐⭐ Interesting</option>
        <option value="1">⭐ Minor note</option>
      </select>
      <button class="lrn-add-btn" onclick="lrnOpenModal()">+ Add Learning</button>
    </div>
    <div id="lrn-learnings-list"></div>
  </div><!-- end my learnings pane -->

  <!-- ── LESSONS PANE ── -->
  <div id="lrn-pane-lessons" class="lrn-pane">

    <!-- Header -->
    <div style="padding:20px 0 22px;border-bottom:1px solid var(--rule);margin-bottom:26px;display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <div style="font-family:var(--g);font-size:22px;font-style:italic;color:var(--text);margin-bottom:4px">22 Curated Lessons</div>
        <div style="font-size:9px;color:var(--dim);letter-spacing:0.08em;text-transform:uppercase">Distilled from the greatest traders, investors & thinkers in history</div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap" id="les-cat-filters">
        <button class="les-cat-btn on" data-cat="" onclick="lesFilter('',this)">All</button>
        <button class="les-cat-btn" data-cat="risk"     onclick="lesFilter('risk',this)">Risk</button>
        <button class="les-cat-btn" data-cat="mindset"  onclick="lesFilter('mindset',this)">Mindset</button>
        <button class="les-cat-btn" data-cat="entry"    onclick="lesFilter('entry',this)">Entry</button>
        <button class="les-cat-btn" data-cat="exit"     onclick="lesFilter('exit',this)">Exit</button>
        <button class="les-cat-btn" data-cat="strategy" onclick="lesFilter('strategy',this)">Strategy</button>
        <button class="les-cat-btn" data-cat="sizing"   onclick="lesFilter('sizing',this)">Sizing</button>
      </div>
    </div>

    <div id="les-grid" class="les-grid"></div>

  </div><!-- end lessons pane -->

</div><!-- end v-learning -->

<!-- Add Learning Modal -->
<div class="lrn-modal-overlay" id="lrn-modal">
  <div class="lrn-modal">
    <div class="lrn-modal-head">
      <div class="lrn-modal-title">Add a Learning</div>
      <button class="lrn-modal-close" onclick="lrnCloseModal()">×</button>
    </div>
    <div class="lrn-modal-body">
      <div class="lrn-field">
        <label>Type</label>
        <select id="lrn-m-type">
          <option value="book">📚 Book Insight</option>
          <option value="mentor">🧠 Mentor Lesson</option>
          <option value="experiment">🧪 Personal Experiment</option>
          <option value="market">📊 Market Observation</option>
        </select>
      </div>
      <div class="lrn-field">
        <label>Source (Book title, Mentor name, etc.)</label>
        <input type="text" id="lrn-m-source" placeholder="Trading in the Zone · Mark Douglas">
      </div>
      <div class="lrn-field">
        <label>The Insight / Learning</label>
        <textarea id="lrn-m-insight" placeholder="What did you learn? What insight changed how you think or trade?"></textarea>
      </div>
      <div class="lrn-field">
        <label>How you'll apply it</label>
        <textarea id="lrn-m-apply" placeholder="Concrete action: I will add this to my pre-trade checklist…" style="min-height:60px"></textarea>
      </div>
      <div class="lrn-field">
        <label>Impact Level</label>
        <div class="lrn-impact-btns" id="lrn-impact-btns">
          <button class="lrn-impact-btn" data-n="1" onclick="lrnSetImpact(1)">★ Minor</button>
          <button class="lrn-impact-btn" data-n="2" onclick="lrnSetImpact(2)">★★ Interesting</button>
          <button class="lrn-impact-btn" data-n="3" onclick="lrnSetImpact(3)">★★★ Solid</button>
          <button class="lrn-impact-btn" data-n="4" onclick="lrnSetImpact(4)">★★★★ High</button>
          <button class="lrn-impact-btn on" data-n="5" onclick="lrnSetImpact(5)">★★★★★ Life-changing</button>
        </div>
      </div>
    </div>
    <div class="lrn-modal-footer">
      <button class="lrn-cancel-btn" onclick="lrnCloseModal()">Cancel</button>
      <button class="dr-save-btn" onclick="lrnSaveLearning()">Save Learning →</button>
    </div>
  </div>
</div>

<!-- ── RULES ── -->
<div id="v-rules" class="v">

  <!-- Header -->
  <div class="sec-head" style="margin-bottom:20px">
    <div class="sec-title">Trading <span style="color:var(--amber2);font-style:normal">Rules</span></div>
    <div class="sec-sub">Your personal rulebook — edit and customize</div>
  </div>

  <!-- Mode tabs -->
  <div style="display:flex;gap:8px;margin-bottom:26px;flex-wrap:wrap">
    <button class="rules-tab on" onclick="rulesTab('swing',this)">📋 Swing &amp; Positional</button>
    <button class="rules-tab"   onclick="rulesTab('intraday',this)">⚡ Intraday</button>
    <button class="rules-tab"   onclick="rulesTab('investing',this)">🏦 Investing</button>
    <button class="rules-tab"   onclick="rulesTab('checklist',this)">🌅 Pre-Market Checklist</button>
  </div>

  <!-- SWING & POSITIONAL -->
  <div id="rules-pane-swing" class="rules-pane on">
    <div class="rg">
      <div class="rg-head"><span class="rg-icon">🔴</span><span class="rg-label">Entry Rules</span></div>
      <div class="rg-list" id="rg-swing-entry"></div>
      <button class="rg-add" onclick="rgAdd('swing','entry')">+ Add Entry Rule</button>
    </div>
    <div class="rg">
      <div class="rg-head"><span class="rg-icon" style="background:rgba(248,113,113,0.12);color:var(--red)">🟧</span><span class="rg-label">Exit Rules</span></div>
      <div class="rg-list" id="rg-swing-exit"></div>
      <button class="rg-add" onclick="rgAdd('swing','exit')">+ Add Exit Rule</button>
    </div>
    <div class="rg">
      <div class="rg-head"><span class="rg-icon" style="background:rgba(212,168,71,0.12);color:var(--amber2)">⚖️</span><span class="rg-label">Risk &amp; Position Sizing</span></div>
      <div class="rg-list" id="rg-swing-risk"></div>
      <button class="rg-add" onclick="rgAdd('swing','risk')">+ Add Risk Rule</button>
    </div>
    <div class="rg">
      <div class="rg-head"><span class="rg-icon" style="background:rgba(99,102,241,0.12);color:var(--blue)">⚠️</span><span class="rg-label">Mental Rules</span></div>
      <div class="rg-list" id="rg-swing-mental"></div>
      <button class="rg-add" onclick="rgAdd('swing','mental')">+ Add Mental Rule</button>
    </div>
  </div>

  <!-- INTRADAY -->
  <div id="rules-pane-intraday" class="rules-pane">
    <div class="rg">
      <div class="rg-head"><span class="rg-icon" style="background:rgba(248,113,113,0.12);color:var(--red)">🕐</span><span class="rg-label">Time-Based Rules</span></div>
      <div class="rg-list" id="rg-intraday-time"></div>
      <button class="rg-add" onclick="rgAdd('intraday','time')">+ Add Time Rule</button>
    </div>
    <div class="rg">
      <div class="rg-head"><span class="rg-icon" style="background:rgba(74,222,128,0.1);color:var(--green)">📊</span><span class="rg-label">Setup &amp; Entry Rules</span></div>
      <div class="rg-list" id="rg-intraday-entry"></div>
      <button class="rg-add" onclick="rgAdd('intraday','entry')">+ Add Entry Rule</button>
    </div>
    <div class="rg">
      <div class="rg-head"><span class="rg-icon" style="background:rgba(212,168,71,0.12);color:var(--amber2)">💰</span><span class="rg-label">P&amp;L Rules</span></div>
      <div class="rg-list" id="rg-intraday-pnl"></div>
      <button class="rg-add" onclick="rgAdd('intraday','pnl')">+ Add P&amp;L Rule</button>
    </div>
    <div class="rg">
      <div class="rg-head"><span class="rg-icon" style="background:rgba(34,211,238,0.1);color:var(--cyan)">⚖️</span><span class="rg-label">Risk Controls</span></div>
      <div class="rg-list" id="rg-intraday-risk"></div>
      <button class="rg-add" onclick="rgAdd('intraday','risk')">+ Add Risk Rule</button>
    </div>
  </div>

  <!-- INVESTING -->
  <div id="rules-pane-investing" class="rules-pane">
    <div class="rg">
      <div class="rg-head"><span class="rg-icon" style="background:rgba(34,211,238,0.1);color:var(--cyan)">🔍</span><span class="rg-label">Stock Selection</span></div>
      <div class="rg-list" id="rg-investing-selection"></div>
      <button class="rg-add" onclick="rgAdd('investing','selection')">+ Add Selection Rule</button>
    </div>
    <div class="rg">
      <div class="rg-head"><span class="rg-icon" style="background:rgba(74,222,128,0.1);color:var(--green)">💹</span><span class="rg-label">Valuation &amp; Entry</span></div>
      <div class="rg-list" id="rg-investing-valuation"></div>
      <button class="rg-add" onclick="rgAdd('investing','valuation')">+ Add Valuation Rule</button>
    </div>
    <div class="rg">
      <div class="rg-head"><span class="rg-icon" style="background:rgba(212,168,71,0.12);color:var(--amber2)">🍊</span><span class="rg-label">Portfolio Management</span></div>
      <div class="rg-list" id="rg-investing-portfolio"></div>
      <button class="rg-add" onclick="rgAdd('investing','portfolio')">+ Add Portfolio Rule</button>
    </div>
    <div class="rg">
      <div class="rg-head"><span class="rg-icon" style="background:rgba(248,113,113,0.1);color:var(--red)">🚪</span><span class="rg-label">Exit &amp; Tax Strategy</span></div>
      <div class="rg-list" id="rg-investing-exit"></div>
      <button class="rg-add" onclick="rgAdd('investing','exit')">+ Add Exit Rule</button>
    </div>
  </div>

  <!-- PRE-MARKET CHECKLIST -->
  <div id="rules-pane-checklist" class="rules-pane">

    <!-- Header strip -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;padding-bottom:16px;border-bottom:1px solid var(--rule);flex-wrap:wrap;gap:10px">
      <div>
        <div style="font-family:var(--g);font-size:17px;font-style:italic;color:var(--text);margin-bottom:3px">Pre-Market Ritual Checklist</div>
        <div style="font-size:9px;color:var(--dim);letter-spacing:0.07em;text-transform:uppercase">All rules from every category · check before first trade</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <div id="pm-cl-progress-wrap" style="display:flex;align-items:center;gap:8px">
          <div style="font-size:9px;color:var(--dim);letter-spacing:0.06em" id="pm-cl-count-label">0 / 0 checked</div>
          <div style="width:100px;height:3px;background:var(--ghost);border-radius:2px;overflow:hidden">
            <div id="pm-cl-bar" style="height:100%;width:0%;background:var(--green);border-radius:2px;transition:width 0.3s"></div>
          </div>
        </div>
        <button onclick="pmClReset()" style="background:none;border:1px solid var(--rule);color:var(--dim);font-family:var(--m);font-size:8.5px;letter-spacing:0.08em;padding:4px 10px;border-radius:2px;cursor:pointer;transition:all 0.12s" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--dim)'">Reset</button>
        <button onclick="goTo('premarket',null)" style="background:var(--amber);color:var(--ink);border:none;font-family:var(--m);font-size:8.5px;font-weight:500;letter-spacing:0.08em;text-transform:uppercase;padding:5px 13px;border-radius:2px;cursor:pointer;transition:background 0.12s" onmouseover="this.style.background='var(--amber2)'" onmouseout="this.style.background='var(--amber)'">Open Pre-Market →</button>
      </div>
    </div>

    <!-- Mental state section -->
    <div class="rg" style="margin-bottom:26px">
      <div class="rg-head">
        <span class="rg-icon" style="background:rgba(99,102,241,0.1);color:var(--blue)">🧘</span>
        <span class="rg-label">Mental State</span>
        <span id="pm-cl-mental-count" style="margin-left:auto;font-size:8px;color:var(--ghost)"></span>
      </div>
      <div id="pm-cl-mental-list"></div>
    </div>

    <!-- Rules sections (auto-generated from rulesData) -->
    <div id="pm-cl-rules-sections"></div>

    <!-- Completion banner -->
    <div id="pm-cl-done-banner" style="display:none;background:rgba(74,222,128,0.06);border:1px solid rgba(74,222,128,0.2);border-radius:3px;padding:18px 20px;text-align:center;margin-top:8px">
      <div style="font-size:18px;margin-bottom:6px">✓</div>
      <div style="font-family:var(--g);font-style:italic;font-size:16px;color:var(--green);margin-bottom:4px">Pre-market complete. You're ready.</div>
      <div style="font-size:10px;color:var(--dim)">Every rule checked. Trade with discipline and full conviction.</div>
    </div>

  </div>

</div>

<!-- ── DECISION ENGINE ── -->
<div id="v-decision" class="v">
  <div class="sec-head"><div class="sec-title">Should I Take This Trade?</div><div class="sec-sub">Answer every question honestly. One fail = no trade.</div></div>
  <div class="decision-flow" id="de-flow"></div>
  <div id="de-verdict-wrap" style="display:none">
    <div class="de-verdict">
      <div class="de-verdict-big" id="de-verdict-text"></div>
      <div class="de-verdict-sub" id="de-verdict-sub"></div>
    </div>
    <div style="text-align:center"><button class="de-reset" onclick="resetDecision()">← Reset</button></div>
  </div>
</div>


<!-- ── CONFIRMATION (Decision Engine from index.html) ── -->
<div id="v-confirmation" class="v">
  <div class="sec-head">
    <div class="sec-title">Decision <span style="color:var(--amber2);font-style:normal">Engine</span></div>
    <div class="sec-sub">Pre-trade systematic scoring · GO / NO-GO verdict · Historical edge from your own data</div>
  </div>

  <div class="de-two-col">

    <!-- LEFT: INPUT FORM -->
    <div class="de-panel">
      <div class="de-panel-header">📋 Trade Setup Input</div>
      <div class="de-panel-body" style="display:flex;flex-direction:column;gap:10px">

        <div class="de-ig">
          <label>Symbol</label>
          <input class="de-in" id="c-symbol" type="text" placeholder="e.g. RELIANCE, AAPL, BTC">
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div class="de-ig"><label>Direction</label>
            <select class="de-sel" id="c-dir"><option>Long</option><option>Short</option></select></div>
          <div class="de-ig"><label>Market</label>
            <select class="de-sel" id="c-mkt">
              <option>NSE</option><option>US Stocks</option><option>Crypto</option><option>Forex</option><option>Commodity</option><option>Index</option><option>Futures</option><option>Options</option>
            </select></div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
          <div class="de-ig"><label>Entry</label><input class="de-in" id="c-entry" type="number" placeholder="0.00"></div>
          <div class="de-ig"><label>Stop Loss</label><input class="de-in" id="c-stop" type="number" placeholder="0.00"></div>
          <div class="de-ig"><label>Target</label><input class="de-in" id="c-target" type="number" placeholder="0.00"></div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div class="de-ig"><label>Setup Type</label>
            <select class="de-sel" id="c-setup">
              <option value="">Select setup...</option>
              <option>Breakout</option><option>Momentum</option><option>Mean Reversion</option><option>Trend Follow</option><option>Support Bounce</option><option>Gap Fill</option><option>Earnings</option><option>Macro Hedge</option><option>Other</option>
            </select></div>
          <div class="de-ig"><label>Market Regime</label>
            <select class="de-sel" id="c-regime">
              <option>Trending Bull</option><option>Trending Bear</option><option>Ranging</option><option>High Volatility</option><option>Low Volatility</option>
            </select></div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div class="de-ig"><label>Account Size</label><input class="de-in" id="c-account" type="number" placeholder="100000" value="100000"></div>
          <div class="de-ig"><label>Position Size (%)</label><input class="de-in" id="c-possize" type="number" placeholder="1" step="0.1" value="1"></div>
        </div>

        <div class="de-ig">
          <label>Your Thesis / Notes</label>
          <textarea class="de-in" id="c-thesis" rows="2" style="resize:vertical;min-height:54px" placeholder="Why does this setup make sense right now?"></textarea>
        </div>

        <div class="de-live-box" id="c-live-quote">
          Enter a symbol above, then click <strong style="color:var(--amber2)">Fetch Live Data</strong> to see real-time price before scoring.
        </div>

        <div class="de-btn-row">
          <button class="de-btn-ghost" onclick="cFetchLive()">⚡ Fetch Live Data</button>
          <button class="de-btn-primary" onclick="cAnalyse()">🧠 Analyse Trade →</button>
        </div>
        <div id="c-live-status" style="min-height:16px;font-size:10px;color:var(--dim)"></div>
      </div>
    </div>

    <!-- RIGHT: SCORING OUTPUT -->
    <div class="de-panel" style="text-align:center">
      <div class="de-panel-header" style="justify-content:center">📊 Systematic Score</div>
      <div class="de-ring-wrap">
        <svg viewBox="0 0 150 150" width="150" height="150">
          <circle cx="75" cy="75" r="63" fill="none" stroke="var(--ghost)" stroke-width="10"/>
          <circle id="c-arc" cx="75" cy="75" r="63" fill="none" stroke="var(--amber)" stroke-width="10"
            stroke-linecap="round" stroke-dasharray="396" stroke-dashoffset="396"
            style="transition:stroke-dashoffset 1s ease,stroke 0.5s ease"/>
        </svg>
        <div class="de-ring-center">
          <div class="de-ring-num" id="c-score-num">—</div>
          <div class="de-ring-lbl">/ 100</div>
        </div>
      </div>
      <div id="c-verdict" class="de-verdict-badge caution" style="display:none">—</div>
      <div id="c-checks" style="text-align:left;padding:0 14px 14px">
        <div style="font-size:11px;color:var(--dim);text-align:center;padding:16px 0">Fill in the form and click Analyse</div>
      </div>
    </div>

  </div><!-- /de-two-col -->

  <!-- SELF-ANALYSIS PROMPTS -->
  <div class="de-panel">
    <div class="de-panel-header">🪞 Self-Analysis Prompts</div>
    <div class="de-panel-body" style="display:flex;flex-direction:column;gap:10px">
      <div class="de-prompt-box">
        <strong style="color:var(--amber2);display:block;margin-bottom:5px">Before you enter, ask yourself:</strong>
        Would I still take this trade if I couldn't check the P&amp;L for 30 days? Am I entering because the setup is strong, or because I want to trade? If my best mentor were watching, would I be comfortable taking this trade?
      </div>
      <div class="de-prompt-box">
        <strong style="color:var(--amber);display:block;margin-bottom:5px">Red flags that should make you wait:</strong>
        You're entering out of FOMO · You haven't defined your stop · You're sizing up after a loss · You're bored · The setup is "close enough" · You've already traded your daily limit
      </div>
    </div>
  </div>

  <!-- HISTORICAL EDGE -->
  <div class="de-panel">
    <div class="de-panel-header">📚 Your Historical Edge — This Setup vs All Setups</div>
    <div class="de-hist-grid">
      <div class="de-hist-cell"><div class="de-hist-val" id="c-hist-wr">—</div><div class="de-hist-lbl">Win Rate (this setup)</div></div>
      <div class="de-hist-cell"><div class="de-hist-val" id="c-hist-pf">—</div><div class="de-hist-lbl">Profit Factor</div></div>
      <div class="de-hist-cell"><div class="de-hist-val" id="c-hist-r">—</div><div class="de-hist-lbl">Avg R-Multiple</div></div>
      <div class="de-hist-cell"><div class="de-hist-val" id="c-hist-n">—</div><div class="de-hist-lbl">Sample Size</div></div>
    </div>
  </div>

  <!-- AI TRADE ANALYSIS -->
  <div class="de-panel">
    <div class="de-panel-header">
      <span>✦ AI Trade Analysis</span>
      <button id="c-ai-btn" class="de-btn-primary" style="padding:5px 13px;font-size:8px" onclick="cAIAnalyse()">✦ Analyse →</button>
    </div>
    <div style="padding:6px 16px 3px;font-size:10px;color:var(--dim)">Claude analyses your systematic score and journal history for this setup</div>
    <div class="de-panel-body" style="padding-top:10px">
      <div class="de-ai-output" id="c-ai-output">
        Run the Decision Engine scoring first, then click Analyse to get an AI-powered assessment of this trade setup against your historical data.
      </div>
    </div>
  </div>

</div><!-- /v-confirmation -->

<!-- ── PSYCHOLOGY ── -->
<div id="v-psy" class="v">
  <div class="sec-head"><div class="sec-title">Psychology Check</div><div class="sec-sub">Honest self-assessment — no shortcuts</div></div>
  <div class="psy-grid">
    <div class="psy-item">
      <div class="psy-label">Focus Level</div>
      <input type="range" class="psy-slider" min="1" max="10" value="5" id="psy-focus" oninput="psyUpdate()">
      <div class="psy-val" id="psy-focus-v">5 / 10</div>
    </div>
    <div class="psy-item">
      <div class="psy-label">Confidence</div>
      <input type="range" class="psy-slider" min="1" max="10" value="5" id="psy-conf" oninput="psyUpdate()">
      <div class="psy-val" id="psy-conf-v">5 / 10</div>
    </div>
    <div class="psy-item">
      <div class="psy-label">Patience</div>
      <input type="range" class="psy-slider" min="1" max="10" value="5" id="psy-pat" oninput="psyUpdate()">
      <div class="psy-val" id="psy-pat-v">5 / 10</div>
    </div>
    <div class="psy-item">
      <div class="psy-label">Discipline</div>
      <input type="range" class="psy-slider" min="1" max="10" value="5" id="psy-disc" oninput="psyUpdate()">
      <div class="psy-val" id="psy-disc-v">5 / 10</div>
    </div>
  </div>
  <div class="panel">
    <div class="panel-h"><span class="panel-title">Current Mood</span></div>
    <div class="panel-body">
      <div class="mood-dots" id="mood-dots">
        <div class="mood-dot" data-m="calm" onclick="setMood(this)" title="Calm">😌</div>
        <div class="mood-dot" data-m="focused" onclick="setMood(this)" title="Focused">🎯</div>
        <div class="mood-dot" data-m="anxious" onclick="setMood(this)" title="Anxious">😰</div>
        <div class="mood-dot" data-m="greedy" onclick="setMood(this)" title="Greedy">🤑</div>
        <div class="mood-dot" data-m="fearful" onclick="setMood(this)" title="Fearful">😨</div>
        <div class="mood-dot" data-m="revenge" onclick="setMood(this)" title="Revenge">😤</div>
        <div class="mood-dot" data-m="bored" onclick="setMood(this)" title="Bored">😑</div>
        <div class="mood-dot" data-m="confident" onclick="setMood(this)" title="Confident">💪</div>
      </div>
    </div>
  </div>
  <div class="panel">
    <div class="panel-h"><span class="panel-title">Session Notes</span></div>
    <div class="panel-body">
      <textarea class="pm-textarea" id="psy-notes" placeholder="What is your mental state going into today? Any emotional baggage from yesterday?"></textarea>
      <button class="pm-save-btn" onclick="savePsy()">Save Check-in</button>
    </div>
  </div>
</div>

<!-- ── PHILOSOPHY ── -->
<div id="v-philosophy" class="v">

  <!-- Hero -->
  <div class="phil-hero">
    <div class="phil-hero-title">Trading &amp; Investing <span>Philosophy</span></div>
    <div class="phil-hero-sub">Timeless principles, mental models &amp; psychological frameworks</div>
  </div>

  <!-- 6 Core Principle Cards -->
  <div class="phil-principles">
    <div class="phil-card">
      <div class="phil-card-icon">🎯</div>
      <div class="phil-card-title">Capital Preservation First</div>
      <div class="phil-card-body">The primary objective is always to protect capital. Profits are secondary. A trader who never blows up lives to trade another day. Risk only what you can afford to lose completely.</div>
    </div>
    <div class="phil-card">
      <div class="phil-card-icon">📐</div>
      <div class="phil-card-title">Process Over Outcomes</div>
      <div class="phil-card-body">A good trade can lose money. A bad trade can make money. Judge yourself on process adherence, not results. Over thousands of trades, process determines everything.</div>
    </div>
    <div class="phil-card">
      <div class="phil-card-icon">🧘</div>
      <div class="phil-card-title">Emotional Detachment</div>
      <div class="phil-card-body">Money must be seen as units of risk, not as real purchasing power. Emotional traders are predictable and exploitable. Trade like a machine; review like a philosopher.</div>
    </div>
    <div class="phil-card">
      <div class="phil-card-icon">⚡</div>
      <div class="phil-card-title">Edge + Expectancy</div>
      <div class="phil-card-body">Without a statistical edge, no position sizing or risk management can save you. Know your expectancy: (Win% × Avg Win) − (Loss% × Avg Loss). Only trade when edge is present.</div>
    </div>
    <div class="phil-card">
      <div class="phil-card-icon">🌊</div>
      <div class="phil-card-title">Adapt to Market Regime</div>
      <div class="phil-card-body">Trending markets reward momentum. Ranging markets mean reversion. Volatile markets demand smaller size. The greatest skill is recognising which regime you're in and adapting instantly.</div>
    </div>
    <div class="phil-card">
      <div class="phil-card-icon">📚</div>
      <div class="phil-card-title">Continuous Learning</div>
      <div class="phil-card-body">Markets evolve. Edges erode. Strategies stop working. The trader who reads daily, reviews trades weekly, and rebuilds strategies monthly will always have an edge over the complacent.</div>
    </div>
  </div>

  <!-- Split: Investing vs Trading Philosophy -->
  <div class="phil-split">
    <div class="phil-col">
      <div class="phil-col-head">
        <div class="phil-col-title"><span>🏦</span> Investing Philosophy</div>
        <div class="phil-col-sub">Long-term wealth creation</div>
      </div>
      <div class="phil-point"><span class="phil-arrow">→</span><span>Buy businesses, not stocks. Own equity in great companies with durable moats and honest management.</span></div>
      <div class="phil-point"><span class="phil-arrow">→</span><span>Time in market beats timing the market. Compounding requires patience measured in years, not months.</span></div>
      <div class="phil-point"><span class="phil-arrow">→</span><span>Never pay an absurd price for even the best business. Valuation always matters at the margin.</span></div>
      <div class="phil-point"><span class="phil-arrow">→</span><span>Diversify enough to survive, concentrate enough to thrive. 10–20 high conviction positions is optimal.</span></div>
      <div class="phil-point"><span class="phil-arrow">→</span><span>Reinvest dividends and distributions. Compound interest is the eighth wonder of the world.</span></div>
      <div class="phil-point"><span class="phil-arrow">→</span><span>Ignore macroeconomic noise. Focus on business fundamentals and competitive positioning.</span></div>
      <div class="phil-point"><span class="phil-arrow">→</span><span>Be greedy when others are fearful. The best entry prices appear in moments of maximum pessimism.</span></div>
      <div class="phil-point"><span class="phil-arrow">→</span><span>Review holdings semi-annually. Sell when thesis is broken, not when price falls.</span></div>
    </div>
    <div class="phil-col">
      <div class="phil-col-head">
        <div class="phil-col-title"><span>⚡</span> Trading Philosophy</div>
        <div class="phil-col-sub">Short-term edge extraction</div>
      </div>
      <div class="phil-point"><span class="phil-arrow">→</span><span>Define your risk before you enter. The stop loss must be placed before you click buy/sell.</span></div>
      <div class="phil-point"><span class="phil-arrow">→</span><span>Let winners run, cut losers fast. Most accounts die from holding losers, not from missing winners.</span></div>
      <div class="phil-point"><span class="phil-arrow">→</span><span>Never average down a loser. Only add to winning positions when your thesis is confirmed.</span></div>
      <div class="phil-point"><span class="phil-arrow">→</span><span>Consistency beats home runs. A 55% win rate with 1.5R average wins is a powerful system.</span></div>
      <div class="phil-point"><span class="phil-arrow">→</span><span>Log every trade with reason. What cannot be measured cannot be improved.</span></div>
      <div class="phil-point"><span class="phil-arrow">→</span><span>Respect the trend until broken. "The trend is your friend" is a cliché because it's true.</span></div>
      <div class="phil-point"><span class="phil-arrow">→</span><span>Reduce size during drawdowns. Slump recovery requires performance from a smaller base.</span></div>
      <div class="phil-point"><span class="phil-arrow">→</span><span>No trading during news events unless that's explicitly your edge.</span></div>
    </div>
  </div>

  <!-- Core Mental Models -->
  <div class="phil-models-wrap">
    <div class="phil-section-head">
      <span class="phil-section-icon">🧠</span>
      <span class="phil-section-title">Core Mental Models for Traders</span>
    </div>
    <table class="models-table">
      <thead>
        <tr>
          <th>Mental Model</th>
          <th>Application in Trading</th>
          <th>Trap to Avoid</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Second-Order Thinking</td>
          <td>Ask not "what happens if X?" but "what happens as a result of what happens when X?" Markets discount first-order moves instantly.</td>
          <td>Reacting to news without considering who is on the other side.</td>
        </tr>
        <tr>
          <td>Probabilistic Thinking</td>
          <td>Every trade is a probability distribution, not a certainty. Think in ranges: 40% breakout, 35% failure, 25% chop.</td>
          <td>Binary thinking: "This will go up" vs. "What's the probability?"</td>
        </tr>
        <tr>
          <td>Inversion</td>
          <td>Instead of asking "how do I make money?" ask "what destroys accounts?" Then avoid those things systematically.</td>
          <td>Focusing only on entry signals without modelling failure scenarios.</td>
        </tr>
        <tr>
          <td>Circle of Competence</td>
          <td>Trade only what you deeply understand. If you don't know why options are priced a certain way, don't trade options.</td>
          <td>FOMO into asset classes or strategies you haven't studied.</td>
        </tr>
        <tr>
          <td>Margin of Safety</td>
          <td>Only enter trades where the risk/reward is significantly skewed in your favour (minimum 2:1 R/R).</td>
          <td>Forcing trades with marginal setups because you "need" to trade.</td>
        </tr>
        <tr>
          <td>Ergodicity</td>
          <td>Ruin is irreversible. One catastrophic loss can eliminate years of gains. Never risk ruin for any expected value.</td>
          <td>Sizing up dramatically on "sure things." Sure things can kill.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Cognitive Biases -->
  <div class="phil-section-head" style="margin-bottom:14px">
    <span class="phil-section-icon">⚠️</span>
    <span class="phil-section-title">Cognitive Biases Quick Reference</span>
    <span style="margin-left:auto;font-size:9px;color:var(--ghost);letter-spacing:0.06em">Know thy enemy</span>
  </div>
  <div class="phil-biases">
    <div class="bias-card">
      <div class="bias-title"><span>🎲</span><span style="color:var(--amber2)">Gambler's Fallacy</span></div>
      <div class="bias-body">Believing past losses mean a win is "due." Every trade is independent. A 10-loss streak does not increase the probability of the 11th winning.</div>
    </div>
    <div class="bias-card">
      <div class="bias-title"><span>⚓</span><span style="color:var(--cyan)">Anchoring Bias</span></div>
      <div class="bias-body">Fixating on your entry price. The stock doesn't care where you bought it. Make decisions based on current information, not sunk cost.</div>
    </div>
    <div class="bias-card">
      <div class="bias-title"><span>📊</span><span style="color:var(--green)">Confirmation Bias</span></div>
      <div class="bias-body">Seeking information that validates your existing position. Actively seek evidence that you are WRONG before entering a trade.</div>
    </div>
    <div class="bias-card">
      <div class="bias-title"><span>😨</span><span style="color:var(--amber2)">Loss Aversion</span></div>
      <div class="bias-body">Losses feel 2× more painful than equivalent gains feel pleasurable. This makes traders hold losers too long and sell winners too early.</div>
    </div>
    <div class="bias-card">
      <div class="bias-title"><span>💬</span><span style="color:var(--red)">Overconfidence</span></div>
      <div class="bias-body">After a winning streak, traders increase size prematurely. Skill and luck are hard to separate in short samples. Humility is an edge.</div>
    </div>
    <div class="bias-card">
      <div class="bias-title"><span>🐑</span><span style="color:var(--blue)">Herding</span></div>
      <div class="bias-body">Following the crowd into crowded trades. By the time everyone agrees, the move is totally exhausted. Be early or be early in exit.</div>
    </div>
  </div>

  <!-- Quote Carousel -->
  <div class="quote-card" style="margin-top:24px">
    <div class="quote-text" id="quote-text">"The market is a device for transferring money from the impatient to the patient."</div>
    <div class="quote-attr" id="quote-attr">— Warren Buffett</div>
    <div class="quote-nav" style="margin-top:14px">
      <button class="quote-btn" onclick="prevQuote()">‹</button>
      <span class="quote-idx" id="quote-idx">1 / 14</span>
      <button class="quote-btn" onclick="nextQuote()">›</button>
    </div>
  </div>

  <!-- Personal Philosophy Notes -->
  <div class="panel" style="margin-top:18px">
    <div class="panel-h">
      <span class="panel-title">My Trading Philosophy Notes</span>
      <button class="btn-sm" onclick="savePhil()">Save</button>
    </div>
    <div class="panel-body">
      <textarea id="phil-notes" class="fta" rows="5" placeholder="Write your personal trading philosophy, core beliefs, and principles…" style="width:100%;min-height:120px"></textarea>
    </div>
  </div>

</div>

<!-- ── MARKET INTEL ── -->
<div id="v-intel" class="v">

  <!-- HEADER -->
  <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px">
    <div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
        <span style="font-size:22px">🌐</span>
        <span style="font-family:var(--g);font-size:26px;font-style:italic">Market <span style="color:var(--cyan)">Intel</span></span>
      </div>
      <div style="font-size:9px;color:var(--dim);letter-spacing:0.08em">Institutional-grade multi-timeframe macro forecasts — week to decade</div>
    </div>
    <div style="background:var(--lift);border:1px solid var(--rule);border-radius:3px;padding:10px 14px;display:flex;align-items:center;gap:10px">
      <div style="width:30px;height:30px;background:var(--amber);border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:var(--ink)">BLK</div>
      <div>
        <div style="font-size:10px;color:var(--text);font-weight:500">Macro Forecast Engine</div>
        <div style="font-size:8px;color:var(--dim)">Systematic macro view · Illustrative, not financial advice</div>
      </div>
    </div>
  </div>

  <!-- FORECAST HORIZON SELECTOR -->
  <div style="background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:14px 16px;margin-bottom:16px">
    <div style="font-size:8px;text-transform:uppercase;letter-spacing:0.14em;color:var(--dim);margin-bottom:12px">SELECT FORECAST HORIZON</div>
    <div style="display:flex;gap:6px;flex-wrap:wrap">
      <button class="mi-hz-btn" data-hz="week"    onclick="setHorizon('week',this)">📅 This Week</button>
      <button class="mi-hz-btn" data-hz="month"   onclick="setHorizon('month',this)">📅 This Month</button>
      <button class="mi-hz-btn" data-hz="quarter" onclick="setHorizon('quarter',this)">📅 This Quarter</button>
      <button class="mi-hz-btn" data-hz="year"    onclick="setHorizon('year',this)">📅 This Year</button>
      <button class="mi-hz-btn" data-hz="3y"      onclick="setHorizon('3y',this)">📅 3 Year</button>
      <button class="mi-hz-btn" data-hz="5y"      onclick="setHorizon('5y',this)">📅 5 Year</button>
      <button class="mi-hz-btn on" data-hz="10y"  onclick="setHorizon('10y',this)">🔮 10 Year</button>
      <button class="mi-hz-btn" data-hz="decade"  onclick="setHorizon('decade',this)">🚀 Decade Predictions</button>
    </div>
  </div>

  <!-- MACRO VIEW HEADER -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
    <div style="display:flex;align-items:center;gap:10px">
      <span id="mi-view-title" style="font-size:15px;color:var(--text);font-weight:400">10-Year Macro View</span>
      <span style="display:flex;align-items:center;gap:5px;background:rgba(212,168,71,0.08);border:1px solid rgba(212,168,71,0.25);border-radius:2px;padding:3px 8px">
        <span class="lif-dot" style="width:5px;height:5px"></span><span class="lif-dot" style="width:5px;height:5px;animation-delay:0.3s"></span><span class="lif-dot" style="width:5px;height:5px;animation-delay:0.6s"></span>
        <span style="font-size:8px;letter-spacing:0.1em;color:var(--amber2)">ALADDIN LIVE</span>
      </span>
    </div>
    <div style="display:flex;gap:6px">
      <span class="mi-signal" id="mi-sig-env">RISK-ON</span>
      <span class="mi-signal mid" id="mi-sig-cyc">MID-CYCLE</span>
      <span class="mi-signal hi"  id="mi-sig-conv">HIGH CONVICTION</span>
    </div>
  </div>

  <!-- PRICE FORECAST CARDS -->
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--rule);border:1px solid var(--rule);border-radius:3px;overflow:hidden;margin-bottom:1px">
    <div class="mi-card"><div class="mi-card-l">S&amp;P 500</div><div class="mi-card-v">5,430</div><div class="mi-card-c g" id="mi-sp500-c">+247%</div><div class="mi-bar g" style="width:70%"></div></div>
    <div class="mi-card"><div class="mi-card-l">GOLD</div><div class="mi-card-v">2,310</div><div class="mi-card-c g">+138%</div><div class="mi-bar g" style="width:55%"></div></div>
    <div class="mi-card"><div class="mi-card-l">BTC</div><div class="mi-card-v">67,420</div><div class="mi-card-c g">+12,000%</div><div class="mi-bar g" style="width:100%"></div></div>
    <div class="mi-card"><div class="mi-card-l">NIFTY 50</div><div class="mi-card-v">23,200</div><div class="mi-card-c g">+218%</div><div class="mi-bar g" style="width:65%"></div></div>
  </div>
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--rule);border:1px solid var(--rule);border-top:none;border-radius:0 0 3px 3px;overflow:hidden;margin-bottom:16px">
    <div class="mi-card"><div class="mi-card-l">EUR/USD</div><div class="mi-card-v">1.0842</div><div class="mi-card-c r">-8%</div><div class="mi-bar r" style="width:20%"></div></div>
    <div class="mi-card"><div class="mi-card-l">CRUDE OIL</div><div class="mi-card-v">74.80</div><div class="mi-card-c g">+22%</div><div class="mi-bar g" style="width:35%"></div></div>
    <div class="mi-card"><div class="mi-card-l">US10Y YIELD</div><div class="mi-card-v">4.35%</div><div class="mi-card-c g" style="color:var(--amber2)">+180bps</div><div class="mi-bar" style="width:45%;background:var(--amber)"></div></div>
    <div class="mi-card"><div class="mi-card-l">DXY</div><div class="mi-card-v">104.20</div><div class="mi-card-c g">+22%</div><div class="mi-bar g" style="width:35%"></div></div>
  </div>

  <!-- SCENARIO ANALYSIS + MARKET CYCLE -->
  <div style="display:grid;grid-template-columns:1fr 340px;gap:14px;margin-bottom:16px">

    <!-- LEFT: SCENARIO -->
    <div style="background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:18px">
      <div style="display:flex;align-items:baseline;gap:8px;margin-bottom:16px;flex-wrap:wrap">
        <span style="font-size:10px;color:var(--text);font-weight:500">📊 Scenario Analysis — 10-Year Macro View (2016–2026)</span>
        <span style="font-size:8px;color:var(--dim)">· Prices as of Jun 2024</span>
        <span style="font-size:8px;color:var(--dim);margin-left:auto">Probability-weighted</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:18px">
        <div class="mi-scenario bull">
          <div class="mi-sc-name">Secular Bull</div>
          <div class="mi-sc-pct" style="color:var(--green)">40%</div>
          <div class="mi-sc-desc">Tech innovation, AI productivity boom drives multi-decade expansion</div>
        </div>
        <div class="mi-scenario base">
          <div class="mi-sc-name">Base Case</div>
          <div class="mi-sc-pct" style="color:var(--cyan)">45%</div>
          <div class="mi-sc-desc">Moderate growth, sticky inflation, geopolitical tension but stable</div>
        </div>
        <div class="mi-scenario bear">
          <div class="mi-sc-name">Structural Bear</div>
          <div class="mi-sc-pct" style="color:var(--red)">15%</div>
          <div class="mi-sc-desc">Debt crisis, stagflation, or geopolitical shock reshapes global order</div>
        </div>
      </div>
      <div style="border-left:2px solid var(--rule2);padding-left:14px">
        <div style="font-size:8px;text-transform:uppercase;letter-spacing:0.14em;color:var(--dim);margin-bottom:10px">PHASE ANALYSIS</div>
        <div class="mi-phase-item" style="border-color:var(--green)">We are in mid-cycle expansion — characterized by solid corporate earnings, moderating inflation, and high employment.</div>
        <div class="mi-phase-item" style="border-color:var(--cyan)">AI &amp; automation are structural tailwinds driving multi-year productivity gains across sectors.</div>
        <div class="mi-phase-item" style="border-color:var(--amber)">Key risks: US debt ceiling, China slowdown, energy transition costs, geopolitical fragmentation.</div>
      </div>
    </div>

    <!-- RIGHT: MARKET CYCLE DONUT -->
    <div style="background:var(--paper);border:1px solid var(--rule);border-radius:3px;padding:18px">
      <div style="font-size:10px;color:var(--text);font-weight:500;margin-bottom:14px">📈 Market Cycle</div>
      <div style="position:relative;text-align:center">
        <canvas id="mi-cycle-canvas" width="280" height="240"></canvas>
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-60%);text-align:center;pointer-events:none">
          <div style="font-size:15px;font-weight:500;color:var(--text)" id="mi-cycle-label">Expansion</div>
          <div style="font-size:8px;color:var(--dim);margin-top:2px">Current Phase</div>
        </div>
      </div>
    </div>
  </div>

  <!-- CONVICTION POSITIONING -->
  <div style="background:var(--paper);border:1px solid var(--rule);border-radius:3px;margin-bottom:16px;overflow:hidden">
    <div style="display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--rule)">
      <div style="width:28px;height:28px;background:var(--amber);border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:var(--ink);flex-shrink:0">BLK</div>
      <div>
        <div style="font-family:var(--g);font-size:15px;font-style:italic;color:var(--text)">Conviction Positioning — Asset Class Views</div>
        <div style="font-size:8px;color:var(--dim);margin-top:1px">Systematic portfolio weight guidance · Illustrative only</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0">
      <div class="mi-asset-card">
        <div class="mi-asset-cat">GLOBAL EQUITIES</div>
        <div class="mi-asset-rating ow">Overweight</div>
        <div class="mi-asset-desc">AI productivity boom supports earnings. Prefer US tech and India growth over EU.</div>
        <div class="mi-asset-bar ow"></div>
      </div>
      <div class="mi-asset-card">
        <div class="mi-asset-cat">GOVERNMENT BONDS</div>
        <div class="mi-asset-rating uw">Underweight</div>
        <div class="mi-asset-desc">Sticky inflation limits duration appeal. Short-end rates attractive but long-end risky.</div>
        <div class="mi-asset-bar uw"></div>
      </div>
      <div class="mi-asset-card" style="border-right:none">
        <div class="mi-asset-cat">GOLD / COMMODITIES</div>
        <div class="mi-asset-rating ow">Overweight</div>
        <div class="mi-asset-desc">Central bank buying, geopolitical hedge, dollar diversification trend intact.</div>
        <div class="mi-asset-bar ow"></div>
      </div>
      <div class="mi-asset-card" style="border-bottom:none">
        <div class="mi-asset-cat">BITCOIN / CRYPTO</div>
        <div class="mi-asset-rating ow">Overweight</div>
        <div class="mi-asset-desc">ETF flows, halving cycle, institutional accumulation phase supports 18-month outlook.</div>
        <div class="mi-asset-bar ow"></div>
      </div>
      <div class="mi-asset-card" style="border-bottom:none">
        <div class="mi-asset-cat">INDIA (NSE/BSE)</div>
        <div class="mi-asset-rating ow">Overweight</div>
        <div class="mi-asset-desc">Strongest GDP trajectory among major economies. Demographics, capex supercycle.</div>
        <div class="mi-asset-bar ow"></div>
      </div>
      <div class="mi-asset-card" style="border-right:none;border-bottom:none">
        <div class="mi-asset-cat">REAL ESTATE / REITS</div>
        <div class="mi-asset-rating nt">Neutral</div>
        <div class="mi-asset-desc">Rate sensitivity limits upside. Regional divergence significant. Prefer data centers.</div>
        <div class="mi-asset-bar nt"></div>
      </div>
    </div>
  </div>

  <!-- SECTOR ROTATION -->
  <div style="background:var(--paper);border:1px solid var(--rule);border-radius:3px;overflow:hidden">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--rule)">
      <span style="font-size:10px;color:var(--text);font-weight:500">📊 Sector Rotation Intelligence</span>
      <span style="font-size:8px;color:var(--dim);letter-spacing:0.06em">YTD performance</span>
    </div>
    <div style="padding:20px 16px 16px">
      <canvas id="mi-sector-canvas" width="1060" height="160" style="width:100%;height:auto"></canvas>
    </div>
  </div>

  <!-- NOTES SECTION (keep original functionality) -->
  <div style="margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:14px">
    <div class="panel">
      <div class="panel-h"><span class="panel-title">Market Bias Notes</span></div>
      <div class="panel-body">
        <textarea class="pm-textarea" id="intel-bias" placeholder="Bull / Bear / Ranging. Key levels. Sector rotation. Dominant narrative…"></textarea>
      </div>
    </div>
    <div class="panel">
      <div class="panel-h"><span class="panel-title">Today's Edge</span></div>
      <div class="panel-body">
        <textarea class="pm-textarea" id="intel-edge" placeholder="Why do you have an edge today? What specific setup are you waiting for?"></textarea>
        <button class="pm-save-btn" onclick="saveIntel()">Save Notes</button>
      </div>
    </div>
  </div>
  <!-- keep hidden inputs for backward compat -->
  <input type="hidden" id="intel-levels" value="">
  <input type="hidden" id="intel-macro" value="">
</div>

<!-- ── WATCHLIST ── -->
<div id="v-screener" class="v">
  <div class="sec-head"><div class="sec-title">Watchlist</div><div class="sec-sub">Your symbols · Live US prices via Finnhub</div></div>
  <div style="display:flex;gap:8px;margin-bottom:16px;align-items:center;flex-wrap:wrap">
    <input class="fi" id="sc-input" placeholder="Add symbol (e.g. AAPL)" style="width:160px" onkeydown="if(event.key==='Enter')addScreenerSymbol()">
    <button class="btn-sm" onclick="addScreenerSymbol()">Add</button>
    <button class="btn-sm" onclick="refreshScreener()">↻ Refresh</button>
    <button class="btn-sm" style="color:var(--red);border-color:rgba(248,113,113,0.2)" onclick="clearWatchlist()">Clear All</button>
    <span id="sc-status" style="font-size:9px;color:var(--dim)"></span>
  </div>
  <div class="screener-grid" id="screener-grid"></div>
  <div style="margin-top:20px">
    <div class="sec-head" style="padding:16px 0 12px"><div class="sec-title" style="font-size:18px">US Top Movers</div></div>
    <div class="screener-grid" id="movers-grid"></div>
  </div>
</div>

<!-- ── STOCK SCREENER ── -->
<div id="v-stockscreener" class="v">

  <!-- HEADER -->
  <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px">
    <div>
      <div style="font-family:var(--g);font-size:28px;font-style:italic;line-height:1.1">🔍 Stock <span style="color:var(--amber2)">Screener</span></div>
      <div style="font-size:9px;color:var(--dim);margin-top:4px;letter-spacing:0.06em">Multi-market scanner · Technical + momentum signals across 60+ instruments</div>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <div id="sc2-live-badge" style="display:flex;align-items:center;gap:6px;background:rgba(74,222,128,0.08);border:1px solid rgba(74,222,128,0.2);border-radius:2px;padding:5px 10px">
        <span class="live-pulse" style="width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 1.4s infinite;display:inline-block"></span>
        <span style="font-size:9px;color:var(--green);letter-spacing:0.08em">Live</span>
        <span id="sc2-count" style="font-size:9px;color:var(--dim)">— instruments</span>
      </div>
      <button class="btn-sm" onclick="runScreener()">↻ Scan</button>
    </div>
  </div>

  <!-- SMART PRESETS -->
  <div class="sc2-section" style="margin-bottom:12px">
    <div class="sc2-sec-label">⚡ SMART PRESETS</div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:10px">
      <button class="sc2-preset" data-preset="oversold"   onclick="applyPreset('oversold',this)">🟢 Oversold (RSI &lt; 30)</button>
      <button class="sc2-preset" data-preset="overbought" onclick="applyPreset('overbought',this)">🔴 Overbought (RSI &gt; 70)</button>
      <button class="sc2-preset" data-preset="strongbuy"  onclick="applyPreset('strongbuy',this)">💎 Strong Buy</button>
      <button class="sc2-preset" data-preset="bullmom"    onclick="applyPreset('bullmom',this)">📈 Bullish Momentum</button>
      <button class="sc2-preset" data-preset="highvol"    onclick="applyPreset('highvol',this)">⚡ High Volume Surge</button>
      <button class="sc2-preset" data-preset="cryptobull" onclick="applyPreset('cryptobull',this)">₿ Crypto Bullish</button>
      <button class="sc2-preset" data-preset="india"      onclick="applyPreset('india',this)">🇮🇳 India Focus</button>
    </div>
  </div>

  <!-- ADVANCED FILTERS -->
  <div class="sc2-section" style="margin-bottom:14px">
    <div class="sc2-sec-label">⚙ ADVANCED FILTERS</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-top:10px">
      <div>
        <div class="sc2-label">MARKET</div>
        <select class="fi" id="sc2-market" style="width:100%">
          <option value="">All Markets</option>
          <option value="US">🇺🇸 US Stocks</option>
          <option value="IN">🇮🇳 India (NSE)</option>
          <option value="CRYPTO">₿ Crypto</option>
          <option value="FOREX">💱 Forex</option>
        </select>
      </div>
      <div>
        <div class="sc2-label">SIGNAL</div>
        <select class="fi" id="sc2-signal" style="width:100%">
          <option value="">All Signals</option>
          <option value="bullish">▲ Bullish</option>
          <option value="bearish">▼ Bearish</option>
        </select>
      </div>
      <div>
        <div class="sc2-label">TREND</div>
        <select class="fi" id="sc2-trend" style="width:100%">
          <option value="">All Trends</option>
          <option value="uptrend">↑ Uptrend</option>
          <option value="downtrend">↓ Downtrend</option>
          <option value="ranging">— Ranging</option>
        </select>
      </div>
      <div>
        <div class="sc2-label">RSI MIN</div>
        <input class="fi" type="number" id="sc2-rsi-min" value="0" min="0" max="100" style="width:100%">
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;margin-top:10px;align-items:end">
      <div>
        <div class="sc2-label">CHG% MIN</div>
        <input class="fi" type="number" id="sc2-chg-min" value="-100" style="width:100%">
      </div>
      <div>
        <div class="sc2-label">CHG% MAX</div>
        <input class="fi" type="number" id="sc2-chg-max" value="100" style="width:100%">
      </div>
      <div>
        <div class="sc2-label">RSI MAX</div>
        <input class="fi" type="number" id="sc2-rsi-max" value="100" min="0" max="100" style="width:100%">
      </div>
      <button class="btn-sm" onclick="resetScreenerFilters()" style="white-space:nowrap">⟳ Reset</button>
    </div>
  </div>

  <!-- YTD BENCHMARKS -->
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px" id="sc2-benchmarks">
    <div class="sc2-bench"><div class="sc2-bench-l">S&amp;P 500 YTD</div><div class="sc2-bench-v g" id="ytd-sp500">+8.2%</div><div class="sc2-bench-s">vs your avg —</div><div class="sc2-bench-bar"><div style="width:41%;height:100%;background:var(--green);border-radius:1px"></div></div></div>
    <div class="sc2-bench"><div class="sc2-bench-l">NIFTY 50 YTD</div><div class="sc2-bench-v g" id="ytd-nifty">+4.1%</div><div class="sc2-bench-s">vs your avg —</div><div class="sc2-bench-bar"><div style="width:20%;height:100%;background:var(--green);border-radius:1px"></div></div></div>
    <div class="sc2-bench"><div class="sc2-bench-l">Bitcoin YTD</div><div class="sc2-bench-v g" id="ytd-btc">+42%</div><div class="sc2-bench-s">vs your avg —</div><div class="sc2-bench-bar"><div style="width:80%;height:100%;background:var(--green);border-radius:1px"></div></div></div>
    <div class="sc2-bench"><div class="sc2-bench-l">Gold YTD</div><div class="sc2-bench-v g" id="ytd-gold">+12.4%</div><div class="sc2-bench-s">vs your avg —</div><div class="sc2-bench-bar"><div style="width:55%;height:100%;background:var(--amber);border-radius:1px"></div></div></div>
  </div>

  <!-- RESULTS TABLE -->
  <div class="panel">
    <div class="tbl-wrap">
      <table id="sc2-table">
        <thead>
          <tr>
            <th onclick="sc2Sort('symbol')">SYMBOL</th>
            <th>MARKET</th>
            <th onclick="sc2Sort('price')">PRICE</th>
            <th onclick="sc2Sort('chg')">CHG%</th>
            <th onclick="sc2Sort('rsi')">RSI</th>
            <th>MACD</th>
            <th>VOLUME</th>
            <th onclick="sc2Sort('trend')">TREND</th>
          </tr>
        </thead>
        <tbody id="sc2-tbody">
          <tr><td colspan="8" style="text-align:center;padding:24px;color:var(--dim);font-size:10px">Click Scan to load instruments</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- ── NEWS & CALENDAR ── -->
<div id="v-news" class="v">

  <!-- CENTRAL BANK RATE MONITOR -->
  <div class="cb-section">
    <div class="cb-head"><span class="cb-icon">🏦</span> CENTRAL BANK RATE MONITOR</div>
    <div class="cb-grid" id="cb-grid">
      <div class="cb-card"><div class="cb-label">US FED FUNDS RATE</div><div class="cb-rate" id="cb-fed">5.25–5.50%</div><div class="cb-status held" id="cb-fed-s">◆ Held — Jan 2026</div><div class="cb-next">Next meeting: Mar 18, 2026</div></div>
      <div class="cb-card"><div class="cb-label">RBI REPO RATE</div><div class="cb-rate" id="cb-rbi">6.50%</div><div class="cb-status held" id="cb-rbi-s">◆ Held — Feb 2026</div><div class="cb-next">Next meeting: Apr 7, 2026</div></div>
      <div class="cb-card cb-highlight"><div class="cb-label">ECB MAIN RATE</div><div class="cb-rate" id="cb-ecb">4.50%</div><div class="cb-status cut" id="cb-ecb-s">▼ Cut likely Mar 2026</div><div class="cb-next">Next meeting: Mar 5, 2026</div></div>
      <div class="cb-card"><div class="cb-label">BANK OF JAPAN RATE</div><div class="cb-rate" id="cb-boj">0.10%</div><div class="cb-status held" id="cb-boj-s">◆ Held — Jan 2026</div><div class="cb-next">Next meeting: Mar 18, 2026</div></div>
      <div class="cb-card"><div class="cb-label">BANK OF ENGLAND</div><div class="cb-rate" id="cb-boe">5.25%</div><div class="cb-status held" id="cb-boe-s">◆ Held — Feb 2026</div><div class="cb-next">Next meeting: Mar 19, 2026</div></div>
      <div class="cb-card"><div class="cb-label">PBOC LPR (1Y)</div><div class="cb-rate" id="cb-pboc">3.45%</div><div class="cb-status cut" id="cb-pboc-s">▼ Cut — Jan 2026</div><div class="cb-next">Stimulus bias ongoing</div></div>
      <div class="cb-card cb-highlight2"><div class="cb-label">US 10Y YIELD</div><div class="cb-rate" id="cb-us10y">4.35%</div><div class="cb-status hike" id="cb-us10y-s">▲ +12bps this week</div><div class="cb-next">Watch: Fed minutes Wed</div></div>
      <div class="cb-card cb-highlight2"><div class="cb-label">INDIA 10Y YIELD</div><div class="cb-rate" id="cb-in10y">7.12%</div><div class="cb-status hike" id="cb-in10y-s">▲ +3bps this week</div><div class="cb-next">RBI OMO operations</div></div>
    </div>
  </div>

  <!-- MAIN TWO-COL -->
  <div class="news-layout">

    <!-- LEFT: LIVE INTELLIGENCE FEED -->
    <div class="news-left">
      <div class="lif-head">
        <div class="lif-title"><span class="lif-dot"></span><span class="lif-dot" style="animation-delay:0.3s"></span><span class="lif-dot" style="animation-delay:0.6s"></span> LIVE INTELLIGENCE FEED</div>
        <button class="btn-sm" style="font-size:8px;padding:3px 8px" onclick="loadNews()">↻</button>
      </div>
      <div class="news-filters" id="news-filters">
        <button class="nf-btn on" data-cat="all"      onclick="setNewsCat('all',this)">All</button>
        <button class="nf-btn" data-cat="macro"       onclick="setNewsCat('macro',this)">🌐 Macro</button>
        <button class="nf-btn" data-cat="equities"    onclick="setNewsCat('equities',this)">📈 Equities</button>
        <button class="nf-btn" data-cat="india"       onclick="setNewsCat('india',this)">🇮🇳 India</button>
        <button class="nf-btn" data-cat="crypto"      onclick="setNewsCat('crypto',this)">₿ Crypto</button>
        <button class="nf-btn" data-cat="forex"       onclick="setNewsCat('forex',this)">💱 Forex</button>
      </div>
      <div id="news-list" style="overflow-y:auto;max-height:640px"></div>
    </div>

    <!-- RIGHT: CALENDAR + FEAR & GREED -->
    <div class="news-right">

      <!-- ECONOMIC CALENDAR -->
      <div class="lm-section" style="margin-bottom:12px">
        <div class="lm-sec-head" style="justify-content:space-between">
          <span>📅 Economic Calendar — This Week</span>
          <div style="display:flex;align-items:center;gap:10px">
            <span style="display:flex;align-items:center;gap:4px;font-size:8px;color:var(--red)"><span style="width:7px;height:7px;border-radius:50%;background:var(--red);display:inline-block"></span>High</span>
            <span style="display:flex;align-items:center;gap:4px;font-size:8px;color:var(--amber)"><span style="width:7px;height:7px;border-radius:50%;background:var(--amber);display:inline-block"></span>Med</span>
            <span style="display:flex;align-items:center;gap:4px;font-size:8px;color:var(--green)"><span style="width:7px;height:7px;border-radius:50%;background:var(--green);display:inline-block"></span>Low</span>
            <button class="btn-sm" style="font-size:8px;padding:3px 8px" onclick="loadCalendar()">↻</button>
          </div>
        </div>
        <div id="cal-list" style="max-height:300px;overflow-y:auto"></div>
      </div>

      <!-- FEAR & GREED -->
      <div class="lm-section">
        <div class="lm-sec-head">
          <span>😰 Fear &amp; Greed Index</span>
          <span id="fg-updated" style="font-size:8px;color:var(--dim)">Loading…</span>
        </div>
        <div class="fg-body">
          <div class="fg-gauge-wrap">
            <canvas id="fg-canvas" width="260" height="140"></canvas>
            <div class="fg-score-wrap">
              <div class="fg-score" id="fg-score">—</div>
              <div class="fg-label" id="fg-label">—</div>
            </div>
          </div>
          <div class="fg-scale">
            <span>Extreme<br>Fear</span><span>Fear</span><span>Neutral</span><span>Greed</span><span>Extreme<br>Greed</span>
          </div>
          <div class="fg-bar-track">
            <div class="fg-bar-fill" id="fg-bar"></div>
          </div>
          <div class="fg-history" id="fg-history"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ── LIVE MARKETS ── -->
<div id="v-live" class="v">
  <div class="sec-head" style="padding-bottom:16px;margin-bottom:20px">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div><div class="sec-title">Live Markets</div><div class="sec-sub">US · India · Crypto · Forex · Commodities</div></div>
      <button class="btn-sm" onclick="renderLive()">↻ Refresh All</button>
    </div>
  </div>

  <!-- ticker strip -->
  <div class="ticker-strip" id="us-ticker" style="margin-bottom:20px">
    <div class="ticker-inner" id="us-ticker-inner">
      <span class="tick-item"><span class="tick-sym">SPY</span><span class="tick-price" style="margin:0 6px">—</span><span class="tick-chg">—</span></span>
    </div>
  </div>

  <!-- TWO COLUMN LAYOUT -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">

    <!-- LEFT COL -->
    <div>
      <!-- US KEY INDICES -->
      <div class="lm-section">
        <div class="lm-sec-head">
          <span>🇺🇸 US Key Indices</span>
          <span class="live-badge"><span class="live-pulse"></span>Finnhub</span>
        </div>
        <div class="lm-list" id="us-indices-list">
          <div class="lm-row-loading">Loading…</div>
        </div>
      </div>

      <!-- US MOVERS -->
      <div class="lm-section">
        <div class="lm-sec-head">
          <span>🇺🇸 US Movers &amp; Crypto Live Feed</span>
          <span class="live-badge"><span class="live-pulse"></span>Finnhub</span>
        </div>
        <div style="display:flex;gap:6px;margin:10px 14px 4px">
          <button class="lm-tab on" id="tab-gainers" onclick="switchMoversTab('gainers')">▲ Gainers</button>
          <button class="lm-tab" id="tab-losers"  onclick="switchMoversTab('losers')">▼ Losers</button>
        </div>
        <div class="lm-list" id="us-movers-list">
          <div class="lm-row-loading">Loading…</div>
        </div>
      </div>

      <!-- COMMODITIES -->
      <div class="lm-section">
        <div class="lm-sec-head">
          <span>🛢 Commodities</span>
          <span style="font-size:8px;color:var(--dim)">CoinGecko + Finnhub</span>
        </div>
        <div class="lm-list" id="commodities-list">
          <div class="lm-row-loading">Loading…</div>
        </div>
      </div>
    </div>

    <!-- RIGHT COL -->
    <div>
      <!-- INDIA INDICES -->
      <div class="lm-section">
        <div class="lm-sec-head">
          <span>🇮🇳 Indian Markets</span>
          <span style="font-size:8px;color:var(--dim)">NSE · BSE</span>
        </div>
        <div class="lm-list" id="india-list">
          <div class="lm-row" style="padding:12px 14px">
            <div><div class="lm-name">NIFTY 50</div><div class="lm-sub">NSE · Broad Market</div></div>
            <div class="lm-right"><div class="lm-price" id="in-nifty50">—</div><div class="lm-chg" id="in-nifty50-c">—</div></div>
          </div>
          <div class="lm-row" style="padding:12px 14px">
            <div><div class="lm-name">BANK NIFTY</div><div class="lm-sub">NSE · Banking Sector</div></div>
            <div class="lm-right"><div class="lm-price" id="in-banknifty">—</div><div class="lm-chg" id="in-banknifty-c">—</div></div>
          </div>
          <div class="lm-row" style="padding:12px 14px">
            <div><div class="lm-name">NIFTY IT</div><div class="lm-sub">NSE · Technology</div></div>
            <div class="lm-right"><div class="lm-price" id="in-niftyit">—</div><div class="lm-chg" id="in-niftyit-c">—</div></div>
          </div>
          <div class="lm-row" style="padding:12px 14px">
            <div><div class="lm-name">SENSEX</div><div class="lm-sub">BSE · 30 Stocks</div></div>
            <div class="lm-right"><div class="lm-price" id="in-sensex">—</div><div class="lm-chg" id="in-sensex-c">—</div></div>
          </div>
          <div class="lm-row" style="padding:12px 14px">
            <div><div class="lm-name">NIFTY MIDCAP</div><div class="lm-sub">NSE · Mid Cap 50</div></div>
            <div class="lm-right"><div class="lm-price" id="in-midcap">—</div><div class="lm-chg" id="in-midcap-c">—</div></div>
          </div>
          <div class="lm-row" style="padding:12px 14px;border-bottom:none">
            <div><div class="lm-name">INDIA VIX</div><div class="lm-sub">Volatility Index</div></div>
            <div class="lm-right"><div class="lm-price" id="in-vix">—</div><div class="lm-chg" id="in-vix-c">—</div></div>
          </div>
        </div>
      </div>

      <!-- CRYPTO -->
      <div class="lm-section">
        <div class="lm-sec-head">
          <span>₿ Crypto Markets</span>
          <span class="live-badge"><span class="live-pulse"></span>CoinGecko</span>
        </div>
        <div class="lm-list" id="crypto-list">
          <div class="lm-row-loading">Loading…</div>
        </div>
      </div>

      <!-- FOREX -->
      <div class="lm-section">
        <div class="lm-sec-head">
          <span>💱 Forex Rates</span>
          <span class="live-badge"><span class="live-pulse"></span>Frankfurter</span>
        </div>
        <div class="lm-list" id="forex-list">
          <div class="lm-row-loading">Loading…</div>
        </div>
      </div>
    </div>

  </div><!-- /grid -->

  <!-- API note -->
  <div id="live-api-note" style="margin-top:14px;padding:16px;background:var(--paper);border:1px solid var(--rule);border-radius:3px;text-align:center">
    <div style="font-family:var(--g);font-style:italic;font-size:15px;color:var(--dim);margin-bottom:6px">Add your Finnhub API key to activate US market feeds</div>
    <div style="font-size:9px;color:var(--ghost);margin-bottom:10px">Free key at finnhub.io · Crypto & Forex load without a key</div>
    <button class="btn-sm" onclick="openApiSettings()">⚙ Configure API Keys</button>
  </div>
</div>

</main>

<!-- ── ENTRY MODAL ── -->
<div class="overlay" id="entry-ov" onclick="ovClick(event,'entry-ov')">
 <div class="modal">
  <div class="modal-h">
    <span class="modal-title" id="entry-title">Log a Trade</span>
    <button class="modal-x" onclick="closeEntry()">×</button>
  </div>
  <div class="modal-b">
    <div class="pass-toggle" id="pass-tog" onclick="togglePass()">
      <input type="checkbox" id="f-pass">
      <div class="toggle-track"></div>
      <span class="toggle-label">Passed — did not take this trade</span>
      <span class="toggle-sub">discipline is a trade too</span>
    </div>
    <div class="cl-block" id="cl-block">
      <div class="cl-head">Did you follow your rules?</div>
      <div id="cl-items"></div>
    </div>
    <div class="fg">
      <div class="f"><label class="fl">Date</label><input class="fi2" type="date" id="f-date"></div>
      <div class="f"><label class="fl">Symbol</label><input class="fi2" type="text" id="f-sym" placeholder="NIFTY, BTC, AAPL…" oninput="this.value=this.value.toUpperCase()"></div>
      <div class="f" id="dir-row"><label class="fl">Direction</label><select class="fs2" id="f-dir" onchange="calcPnL()"><option value="Long">Long</option><option value="Short">Short</option></select></div>
      <div class="f" id="tradetype-row"><label class="fl">Trade Type</label><select class="fs2" id="f-tradetype"><option value="">Select type…</option><option value="intraday">⚡ Intraday</option><option value="swing">📋 Swing / Positional</option><option value="investing">🏦 Investment</option></select></div>
      <div class="f"><label class="fl">Setup</label><input class="fi2" type="text" id="f-setup" placeholder="Breakout, OB, Reversal…"></div>
      <div class="f" id="entry-row"><label class="fl">Entry Price</label><input class="fi2" type="number" id="f-entry" step="any" placeholder="0.00" oninput="calcPnL()"></div>
      <div class="f" id="exit-row"><label class="fl">Exit Price</label><input class="fi2" type="number" id="f-exit" step="any" placeholder="0.00" oninput="calcPnL()"></div>
      <div class="f" id="sl-row"><label class="fl">Stop Loss</label><input class="fi2" type="number" id="f-sl" step="any" placeholder="0.00" oninput="calcPnL()"></div>
      <div class="f"><label class="fl">Quantity / Lots</label><input class="fi2" type="number" id="f-qty" step="any" placeholder="1" oninput="calcPnL()"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0" id="pnl-r-row">
      <div class="pnl-box"><div class="pnl-big" id="pnl-prev">—</div><div class="pnl-lbl">P&L</div></div>
      <div class="r-box"><div class="r-val" id="r-prev">—</div><div class="r-lbl">R achieved</div></div>
    </div>
    <div class="fg" style="margin-top:10px">
      <div class="f full"><label class="fl">What happened? <span style="color:var(--ghost)">(be honest)</span></label><textarea class="fta" id="f-note" placeholder="Entry reason, what played out, where you deviated…"></textarea></div>
      <div class="f full"><label class="fl" style="color:var(--amber)">What will you do differently?</label><textarea class="fta" id="f-lesson" placeholder="The one thing to carry forward…"></textarea></div>
    </div>
    <div style="margin-top:12px">
      <div class="fl" style="margin-bottom:7px">Process Rating <span style="color:var(--ghost);font-size:8px">— rate execution, not outcome</span></div>
      <div class="rating-row">
        <button class="rating-dot" data-r="1" onclick="setRating(1)">1</button>
        <button class="rating-dot" data-r="2" onclick="setRating(2)">2</button>
        <button class="rating-dot" data-r="3" onclick="setRating(3)">3</button>
        <button class="rating-dot" data-r="4" onclick="setRating(4)">4</button>
        <button class="rating-dot" data-r="5" onclick="setRating(5)">5</button>
        <span class="rating-hint" id="rating-hint">tap to rate</span>
      </div>
    </div>
    <div class="ff"><button class="btn-cancel" onclick="closeEntry()">Cancel</button><button class="btn-save" onclick="saveTrade()">Save</button></div>
  </div>
 </div>
</div>

<!-- ── DETAIL MODAL ── -->
<div class="overlay" id="detail-ov" onclick="ovClick(event,'detail-ov')">
 <div class="modal">
  <div class="modal-h"><span class="modal-title" id="detail-title">—</span><button class="modal-x" onclick="closeDetail()">×</button></div>
  <div class="modal-b" id="detail-body"></div>
 </div>
</div>

<!-- ── API SETTINGS MODAL ── -->
<div class="overlay" id="api-ov" onclick="ovClick(event,'api-ov')">
 <div class="modal" style="max-width:480px">
  <div class="modal-h"><span class="modal-title">API Configuration</span><button class="modal-x" onclick="closeApiSettings()">×</button></div>
  <div class="modal-b">
    <div style="margin-bottom:16px">
      <div class="fl" style="margin-bottom:6px">Finnhub API Key <a href="https://finnhub.io/register" target="_blank" style="color:var(--amber2);font-size:8px;text-decoration:none;margin-left:8px">Get free key →</a></div>
      <input class="fi2" type="text" id="api-finnhub" placeholder="ck_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
      <div style="font-size:9px;color:var(--dim);margin-top:4px">Unlocks: US stock quotes · News · Economic calendar · Screener</div>
    </div>
    <div class="ff">
      <button class="btn-cancel" onclick="clearApiKeys()">Clear Keys</button>
      <button class="btn-cancel" onclick="closeApiSettings()">Cancel</button>
      <button class="btn-save" onclick="saveApiKeys()">Save & Activate</button>
    </div>
  </div>
 </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   STATE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
let trades   = JSON.parse(ls('zj4_trades') || '[]');
let rules    = JSON.parse(ls('zj4_rules')  || '[]');
let psySt    = JSON.parse(ls('zj4_psy')    || '{}');
let pmSt     = JSON.parse(ls('zj4_pm')     || '{}');
let philSt   = JSON.parse(ls('zj4_phil')   || '{}');
let drReviews = JSON.parse(ls('zj4_dr') || '{}'); // date → review object
let lrnData   = JSON.parse(ls('zj4_lrn') || '{"books":[],"mentors":[],"resources":[],"learnings":[]}');
let intelSt  = JSON.parse(ls('zj4_intel')  || '{}');
let scSyms   = JSON.parse(ls('zj4_sc')     || '["AAPL","MSFT","NVDA","TSLA","AMZN"]');
let apiKeys  = JSON.parse(ls('zj4_api')    || '{}');
let editId   = null, _rating = 0, _passed = false;
let _sKey    = 'date', _sDir  = -1;
let quoteIdx = 0;

const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const DAYS   = ['Su','Mo','Tu','We','Th','Fr','Sa'];
const RH     = ['','Terrible — broke plan','Poor — half-committed','Decent — mostly followed plan','Good — stuck to plan','Perfect — textbook execution'];

function ls(k) { try { return localStorage.getItem(k); } catch(e) { return null; } }
function lss(k,v) { try { localStorage.setItem(k, typeof v==='string'?v:JSON.stringify(v)); } catch(e) {} }
function saveTrades() { lss('zj4_trades', trades); }
function saveRules()  { lss('zj4_rules',  rules);  }

/* Default rules */
if (!rules.length) {
  rules = ['No trade without a defined stop loss.','Cut losses at the stop. No negotiating.','Never add to a losing position.','No revenge trading after a loss.','Honour your position sizing rules.'];
  saveRules();
}

const QUOTES = [
  { t: 'The market is a device for transferring money from the impatient to the patient.', a: 'Warren Buffett' },
  { t: "It's not whether you're right or wrong, but how much money you make when you're right and how much you lose when you're wrong.", a: 'George Soros' },
  { t: 'The goal of a successful trader is to make the best trades. Money is secondary.', a: 'Alexander Elder' },
  { t: 'In trading, the impossible happens about twice a year.', a: 'Henri M. Simoes' },
  { t: 'Risk comes from not knowing what you are doing.', a: 'Warren Buffett' },
  { t: 'The market can stay irrational longer than you can stay solvent.', a: 'John Maynard Keynes' },
  { t: 'Every battle is won before it is fought.', a: 'Sun Tzu' },
  { t: 'The most important thing is to stay in the game.', a: 'Ed Seykota' },
  { t: 'He who knows when he can fight and when he cannot will be victorious.', a: 'Sun Tzu' },
  { t: 'The amateur investor has no real advantage over the professional. The advantage of the amateur is that he can wait.', a: 'Peter Lynch' },
  { t: 'Trade what you see, not what you think.', a: 'Linda Bradford Raschke' },
  { t: 'Markets are never wrong — opinions often are.', a: 'Jesse Livermore' },
  { t: 'The trend is your friend until the end when it bends.', a: 'Ed Seykota' },
  { t: 'Do more of what works and less of what doesn\'t.', a: 'Steve Clark' },
  { t: 'A loss never bothers me after I take it. I forget it overnight. But being wrong and not taking the loss — that is what does the damage.', a: 'Jesse Livermore' },
  { t: 'The hard right edge is always uncertain. React, don\'t predict.', a: 'Mark Douglas' },
  { t: 'Patience is the trader\'s most underrated virtue.', a: 'Anonymous' },
  { t: 'Your first loss is your best loss.', a: 'Trading Axiom' },
];

const DE_QUESTIONS = [
  { q: 'Is this setup in my defined trading plan?', k: 'plan' },
  { q: 'Do I have a clear stop loss defined before entering?', k: 'sl' },
  { q: 'Is my position size within my risk rules (max 1–2%)?', k: 'size' },
  { q: 'Is the market in a tradeable condition (not choppy/news)?', k: 'cond' },
  { q: 'Am I in the right mental state? (Not revenge, not FOMO)', k: 'mental' },
  { q: 'Is the risk/reward at least 1.5R?', k: 'rr' },
  { q: 'Would I take this trade if I couldn\'t check results for 24h?', k: 'conviction' },
];

const PM_MINDSET = [
  'I am physically rested and hydrated',
  'I am not carrying emotional baggage from yesterday',
  'I have reviewed my rules this morning',
  'I know today\'s key levels',
  'I am not trading to make back a loss',
  'I accept that I may not trade at all today',
];

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   NAV
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
function goTo(id, btn) {
  document.querySelectorAll('.v').forEach(v => v.classList.remove('on'));
  document.querySelectorAll('.t').forEach(b => b.classList.remove('on'));
  $('v-'+id).classList.add('on');
  if (btn) btn.classList.add('on');
  const renders = {
    dash: renderDash, trades: renderTrades, rules: renderRules,
    premarket: renderPremarket, decision: renderDecision,
    confirmation: renderConfirmation,
    psy: renderPsy, philosophy: renderPhilosophy,
    dailyreview: renderDailyReview,
    learning: renderLearning,
    intel: renderIntel, screener: renderScreener,
    stockscreener: initStockScreener,
    news: initNews, live: renderLive,
  };
  if (renders[id]) renders[id]();
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ENTRY MODAL
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
function openEntry(id=null) {
  editId=id; _rating=0; _passed=false;
  $('entry-title').textContent = id ? 'Edit Trade' : 'Log a Trade';
  const today = new Date().toISOString().slice(0,10);
  if (id) {
    const t = trades.find(x=>x.id===id);
    if (t) {
      sv('f-date',t.date); sv('f-sym',t.symbol);
      sv('f-dir',t.direction||'Long'); sv('f-tradetype',t.tradeType||''); sv('f-setup',t.setup||'');
      sv('f-entry',t.entry||''); sv('f-exit',t.exit||'');
      sv('f-sl',t.sl||''); sv('f-qty',t.qty||'');
      sv('f-note',t.note||''); sv('f-lesson',t.lesson||'');
      _rating=t.rating||0; _passed=t.passed||false;
    }
  } else {
    sv('f-date',today);
    ['f-sym','f-setup','f-entry','f-exit','f-sl','f-qty','f-note','f-lesson'].forEach(i=>sv(i,''));
    sv('f-dir','Long'); sv('f-tradetype','');
  }
  syncPassUI(); renderRating(); buildChecklist(); calcPnL();
  $('entry-ov').classList.add('on');
  setTimeout(()=>$('f-sym').focus(),280);
}
function closeEntry(){ $('entry-ov').classList.remove('on'); editId=null; }
function ovClick(e,id){ if(e.target===$(id)){ if(id==='entry-ov')closeEntry(); else if(id==='detail-ov')closeDetail(); else if(id==='api-ov')closeApiSettings(); } }
function togglePass(){ _passed=!_passed; syncPassUI(); calcPnL(); }
function syncPassUI(){
  const tog=$('pass-tog');
  _passed?tog.classList.add('ck'):tog.classList.remove('ck');
  ['entry-row','exit-row','sl-row','dir-row','tradetype-row','pnl-r-row'].forEach(id=>$(id).style.display=_passed?'none':'');
}
function buildChecklist(){
  const bl=$('cl-block');
  if(!rules.length){bl.style.display='none';return;}
  bl.style.display='';
  $('cl-items').innerHTML=rules.map((r,i)=>
    `<div class="cl-row" id="cr${i}" onclick="ckTog(${i})"><div class="cl-box" id="cb${i}"></div><div class="cl-txt">${esc(r)}</div></div>`
  ).join('');
}
function ckTog(i){ $('cr'+i).classList.toggle('ck'); }
function calcPnL(){
  if(_passed){$('pnl-prev').textContent='—';$('pnl-prev').className='pnl-big';$('r-prev').textContent='—';$('r-prev').style.color='';return;}
  const entry=pf('f-entry'),exit=pf('f-exit'),sl=pf('f-sl'),qty=pf('f-qty')||1,dir=$('f-dir').value;
  const el=$('pnl-prev'),rEl=$('r-prev');
  if(!isNaN(entry)&&!isNaN(exit)){
    const pnl=dir==='Long'?(exit-entry)*qty:(entry-exit)*qty;
    el.textContent=(pnl>=0?'+':'')+pnl.toFixed(2);
    el.className='pnl-big '+(pnl>=0?'g':'r');
    if(!isNaN(sl)&&sl!==entry){
      const R=(dir==='Long'?exit-entry:entry-exit)/Math.abs(entry-sl);
      rEl.textContent=(R>=0?'+':'')+R.toFixed(2)+'R';
      rEl.style.color=R>=0?'var(--green)':'var(--red)';
    } else { rEl.textContent='—'; rEl.style.color=''; }
  } else { el.textContent='—';el.className='pnl-big';rEl.textContent='—';rEl.style.color=''; }
}
function setRating(n){ _rating=n; renderRating(); }
function renderRating(){
  document.querySelectorAll('.rating-dot').forEach(d=>{ parseInt(d.dataset.r)<=_rating?d.classList.add('on'):d.classList.remove('on'); });
  $('rating-hint').textContent=_rating?RH[_rating]:'tap to rate';
}
function saveTrade(){
  const sym=$('f-sym').value.trim().toUpperCase();
  const entry=pf('f-entry'),exit=pf('f-exit'),qty=pf('f-qty')||1,dir=$('f-dir').value,sl=pf('f-sl');
  if(!sym){toast('Symbol required.');return;}
  if(!_passed&&(isNaN(entry)||isNaN(exit))){toast('Entry and exit required.');return;}
  let pnl=0,R=null;
  if(!_passed){ pnl=dir==='Long'?(exit-entry)*qty:(entry-exit)*qty; if(!isNaN(sl)&&sl!==entry)R=(dir==='Long'?exit-entry:entry-exit)/Math.abs(entry-sl); }
  const trade={id:editId||Date.now().toString(),date:$('f-date').value,symbol:sym,direction:_passed?null:dir,tradeType:$('f-tradetype').value||null,setup:$('f-setup').value.trim(),entry:_passed?null:entry,exit:_passed?null:exit,sl:!isNaN(sl)?sl:null,qty:_passed?null:qty,pnl:_passed?null:pnl,R,note:$('f-note').value.trim(),lesson:$('f-lesson').value.trim(),rating:_rating,passed:_passed};
  if(editId){const i=trades.findIndex(t=>t.id===editId);if(i!==-1)trades[i]=trade;}else trades.unshift(trade);
  saveTrades(); closeEntry(); renderDash(); toast(editId?'Updated.':_passed?'Pass logged.':'Trade logged.');
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   DETAIL MODAL
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
function openDetail(id){
  const t=trades.find(x=>x.id===id); if(!t)return;
  const pc=t.pnl!=null?(t.pnl>=0?'g':'r'):'';
  const pnlStr=t.passed?'<span class="d-pass-label">PASSED — not taken</span>':`<span class="${pc}" style="font-size:20px;font-weight:300">${t.pnl>=0?'+':''}${t.pnl.toFixed(2)}</span>`;
  const rStr=t.R!=null?`<span style="color:${t.R>=0?'var(--green)':'var(--red)'}">${t.R>=0?'+':''}${t.R.toFixed(2)}R</span>`:'—';
  const dots=[1,2,3,4,5].map(n=>`<div class="rdot ${n<=(t.rating||0)?'on':''}"></div>`).join('');
  $('detail-title').textContent=t.symbol+' · '+t.date;
  $('detail-body').innerHTML=`
    <div class="d-section"><div class="detail-g">
      <div><div class="dl">P&L</div><div class="dv">${pnlStr}</div></div>
      <div><div class="dl">R Achieved</div><div class="dv">${rStr}</div></div>
      ${!t.passed?`<div><div class="dl">Direction</div><div class="dv">${t.direction}</div></div>
      <div><div class="dl">Trade Type</div><div class="dv">${t.tradeType==='intraday'?'⚡ Intraday':t.tradeType==='swing'?'📋 Swing/Positional':t.tradeType==='investing'?'🏦 Investment':'—'}</div></div>
      <div><div class="dl">Setup</div><div class="dv">${esc(t.setup)||'—'}</div></div>
      <div><div class="dl">Entry</div><div class="dv">${t.entry}</div></div>
      <div><div class="dl">Exit</div><div class="dv">${t.exit}</div></div>
      ${t.sl?`<div><div class="dl">Stop Loss</div><div class="dv">${t.sl}</div></div>`:''}
      <div><div class="dl">Quantity</div><div class="dv">${t.qty}</div></div>`:''}
      <div><div class="dl">Process Rating</div><div class="dv" style="margin-top:4px"><div class="rdots">${dots}</div></div></div>
    </div></div>
    ${t.note?`<div class="d-section"><div class="d-head">What Happened</div><div class="d-text">${esc(t.note)}</div></div>`:''}
    ${t.lesson?`<div class="d-section"><div class="d-head">Lesson — carry forward</div><div class="d-lesson">${esc(t.lesson)}</div></div>`:''}
    <div style="display:flex;gap:7px;padding-top:13px;border-top:1px solid var(--rule)">
      <button class="btn-cancel" style="color:var(--red);border-color:rgba(248,113,113,0.2)" onclick="delTrade('${t.id}')">Delete</button>
      <button class="btn-cancel" onclick="closeDetail();openEntry('${t.id}')">Edit</button>
      <div style="flex:1"></div>
      <button class="btn-save" onclick="closeDetail()">Close</button>
    </div>`;
  $('detail-ov').classList.add('on');
}
function closeDetail(){ $('detail-ov').classList.remove('on'); }
function delTrade(id){
  if(!confirm('Delete permanently?'))return;
  trades=trades.filter(t=>t.id!==id); saveTrades(); closeDetail(); renderDash(); renderTrades(); toast('Deleted.');
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   DASHBOARD
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
function renderDash(){
  const now=new Date();
  $('q-date').textContent=now.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).toUpperCase();
  $('q-count').textContent=trades.length;
  const taken=trades.filter(t=>!t.passed);
  const wins=taken.filter(t=>t.pnl>0), losses=taken.filter(t=>t.pnl<0);
  const total=taken.reduce((s,t)=>s+t.pnl,0);
  const wr=taken.length?wins.length/taken.length*100:null;
  const avgW=wins.length?wins.reduce((s,t)=>s+t.pnl,0)/wins.length:0;
  const avgL=losses.length?losses.reduce((s,t)=>s+t.pnl,0)/losses.length:0;
  const exp=wr!=null?(wr/100*avgW+(1-wr/100)*avgL):null;
  const bestR=taken.filter(t=>t.R!=null).reduce((b,t)=>t.R>b?t.R:b,-Infinity);
  el('s-pnl',taken.length?(total>=0?'+':'')+total.toFixed(2):'—',taken.length?(total>=0?'g':'r'):'');
  $('s-pnl-s').textContent=taken.length?taken.length+' trades taken':'no trades yet';
  el('s-wr',wr!=null?wr.toFixed(0)+'%':'—',wr!=null?(wr>=50?'g':'r'):'');
  $('s-wr-s').textContent=wr!=null?wins.length+'W  '+losses.length+'L':'—';
  el('s-exp',exp!=null?(exp>=0?'+':'')+exp.toFixed(2):'—',exp!=null?(exp>=0?'g':'r'):'');
  $('s-exp-s').textContent=avgW&&avgL?'+'+avgW.toFixed(0)+' / '+Math.abs(avgL).toFixed(0):'avg win / loss';
  $('s-bestr').textContent=isFinite(bestR)?'+'+bestR.toFixed(2)+'R':'—';
  const sorted=[...taken].sort((a,b)=>a.date.localeCompare(b.date));
  let str=0,st='';
  for(let i=sorted.length-1;i>=0;i--){const w=sorted[i].pnl>0;if(i===sorted.length-1){st=w?'W':'L';str=1;}else if((w&&st==='W')||(!w&&st==='L'))str++;else break;}
  el('s-streak',taken.length?str+st:'—',st==='W'?'g':st==='L'?'r':'');
  $('s-dots').innerHTML=sorted.slice(-14).map(t=>`<div class="sd ${t.pnl>0?'w':'l'}"></div>`).join('');
  renderMonths(taken); renderChart(sorted); renderHeatmap(taken);
  $('recent-tb').innerHTML=trades.slice(0,5).map(t=>tRow(t,false)).join('')||`<tr><td colspan="7"><div class="empty"><span class="empty-g">∅</span><div class="empty-t">No trades yet.</div></div></td></tr>`;
}
function el(id,txt,cls=''){const e=$(id);e.textContent=txt;e.className='stat-v '+(cls||'');}
function renderMonths(taken){
  const yr=new Date().getFullYear(),map={};
  taken.forEach(t=>{const d=new Date(t.date);if(d.getFullYear()===yr){const m=d.getMonth();map[m]=(map[m]||0)+t.pnl;}});
  $('month-strip').innerHTML=MONTHS.map((m,i)=>{const v=map[i];const cls=v==null?'z':v>0?'g':'r';return`<div class="mc"><div class="mc-l">${m}</div><div class="mc-v ${cls}">${v==null?'—':(v>=0?'+':'')+v.toFixed(0)}</div></div>`;}).join('');
}
function renderChart(sorted){
  const canvas=$('eqChart'),ctx=canvas.getContext('2d');
  const W=canvas.parentElement.clientWidth;canvas.width=W;canvas.height=148;
  if(sorted.length<2){ctx.fillStyle='rgba(90,90,120,0.3)';ctx.font='10px IBM Plex Mono,monospace';ctx.textAlign='center';ctx.fillText('Log 2+ trades to see your curve.',W/2,74);return;}
  let cum=0;const pts=[0,...sorted.map(t=>{cum+=t.pnl;return cum;})];
  const mn=Math.min(...pts),mx=Math.max(...pts),rng=mx-mn||1;
  const p={t:10,b:18,l:5,r:5},cw=W-p.l-p.r,ch=148-p.t-p.b;
  const px=i=>p.l+(i/(pts.length-1))*cw,py=v=>p.t+ch-((v-mn)/rng)*ch;
  const pos=pts[pts.length-1]>=0,col=pos?'#4ade80':'#f87171';
  ctx.beginPath();ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=1;ctx.setLineDash([3,4]);ctx.moveTo(p.l,py(0));ctx.lineTo(p.l+cw,py(0));ctx.stroke();ctx.setLineDash([]);
  const g=ctx.createLinearGradient(0,p.t,0,p.t+ch);g.addColorStop(0,pos?'rgba(74,222,128,0.14)':'rgba(248,113,113,0.14)');g.addColorStop(1,'rgba(0,0,0,0)');
  ctx.beginPath();ctx.moveTo(px(0),py(pts[0]));pts.forEach((v,i)=>{if(i>0)ctx.lineTo(px(i),py(v));});ctx.lineTo(px(pts.length-1),py(mn));ctx.lineTo(px(0),py(mn));ctx.closePath();ctx.fillStyle=g;ctx.fill();
  ctx.beginPath();ctx.moveTo(px(0),py(pts[0]));pts.forEach((v,i)=>{if(i>0)ctx.lineTo(px(i),py(v));});ctx.strokeStyle=col;ctx.lineWidth=1.5;ctx.stroke();
  const lx=px(pts.length-1),ly=py(pts[pts.length-1]);ctx.beginPath();ctx.arc(lx,ly,3,0,Math.PI*2);ctx.fillStyle=col;ctx.fill();
}
function renderHeatmap(taken){
  const map={};taken.forEach(t=>{map[t.date]=(map[t.date]||0)+t.pnl;});
  const now=new Date(),yr=now.getFullYear(),jan1=new Date(yr,0,1),startWd=jan1.getDay(),total=isLeap(yr)?366:365;
  const vals=Object.values(map).filter(v=>v!==0),maxAbs=vals.length?Math.max(...vals.map(Math.abs)):1;
  let cols=[],col=[];
  for(let d=-startWd;d<total;d++){const date=new Date(yr,0,1+d),ds=date.toISOString().slice(0,10),pnl=map[ds];col.push({ds,pnl,future:date>now});if(col.length===7){cols.push(col);col=[];}}
  if(col.length){while(col.length<7)col.push({ds:null,pnl:null,future:true});cols.push(col);}
  let rows=Array.from({length:7},()=>[]);cols.forEach(wk=>wk.forEach((c,d)=>rows[d].push(c)));
  $('heatmap').innerHTML=rows.map((row,di)=>`<div class="hm-row"><div class="hm-lbl">${DAYS[di]}</div>${row.map(c=>{
    if(!c.ds)return`<div class="hm-cell" style="background:transparent;pointer-events:none"></div>`;
    if(c.future)return`<div class="hm-cell" style="opacity:0.15"></div>`;
    if(c.pnl==null)return`<div class="hm-cell" title="${c.ds}"></div>`;
    const int=Math.min(Math.abs(c.pnl)/maxAbs,1),cls=c.pnl>0?(int>.66?'gL':int>.33?'gM':'gS'):(int>.66?'rL':int>.33?'rM':'rS');
    return`<div class="hm-cell ${cls}" title="${c.ds}: ${c.pnl>=0?'+':''}${c.pnl.toFixed(2)}"></div>`;
  }).join('')}</div>`).join('');
}
function isLeap(y){return(y%4===0&&y%100!==0)||y%400===0;}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   TRADES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
function srt(k){if(_sKey===k)_sDir*=-1;else{_sKey=k;_sDir=-1;}renderTrades();}
function renderTrades(){
  const q=($('f-q')||{value:''}).value.toLowerCase(),d=($('f-d')||{value:''}).value,o=($('f-o')||{value:''}).value,r=parseInt(($('f-r')||{value:''}).value)||0,tt=($('f-tt')||{value:''}).value;
  let list=trades.filter(t=>{
    if(q&&!t.symbol.toLowerCase().includes(q)&&!(t.setup||'').toLowerCase().includes(q))return false;
    if(d&&t.direction!==d)return false;
    if(o==='win'&&(t.passed||t.pnl<=0))return false;
    if(o==='loss'&&(t.passed||t.pnl>=0))return false;
    if(o==='pass'&&!t.passed)return false;
    if(r&&(t.rating||0)<r)return false;
    if(tt&&t.tradeType!==tt)return false;
    return true;
  });
  list.sort((a,b)=>{let va=a[_sKey],vb=b[_sKey];if(va==null)va=-Infinity;if(vb==null)vb=-Infinity;return(typeof va==='string'?va.localeCompare(vb):va-vb)*_sDir;});
  const body=$('trades-tb');
  if(!list.length){body.innerHTML=`<tr><td colspan="8"><div class="empty"><span class="empty-g">∅</span><div class="empty-t">No entries match.</div></div></td></tr>`;return;}
  body.innerHTML=list.map(t=>tRow(t,true)).join('');
}
function tRow(t,showDel){
  const pc=t.pnl!=null?(t.pnl>=0?'g':'r'):'';
  const pnlStr=t.passed?`<span class="badge bp">passed</span>`:`<span class="${pc}">${t.pnl>=0?'+':''}${t.pnl.toFixed(2)}</span>`;
  const rStr=t.R!=null?`<span style="color:${t.R>=0?'var(--green)':'var(--red)'}">${t.R>=0?'+':''}${t.R.toFixed(1)}R</span>`:'<span style="color:var(--ghost)">—</span>';
  const dirB=t.passed?'<span class="badge bp">—</span>':t.direction==='Long'?'<span class="badge bl">L</span>':'<span class="badge bs">S</span>';
  const dots=[1,2,3,4,5].map(n=>`<div class="rdot ${n<=(t.rating||0)?'on':''}"></div>`).join('');
  const les=t.lesson?`<span class="lesson-cell">${esc(t.lesson.slice(0,52))}${t.lesson.length>52?'…':''}</span>`:'<span style="color:var(--ghost)">—</span>';
  const del=showDel?`<td><button class="btn-sm" style="padding:2px 6px;font-size:8px" onclick="event.stopPropagation();delTrade('${t.id}')">✕</button></td>`:'<td></td>';
  const ttBadge=t.tradeType==='intraday'?'<span class="badge bc" style="font-size:7px">⚡</span>':t.tradeType==='swing'?'<span class="badge bp" style="font-size:7px">📋</span>':t.tradeType==='investing'?'<span class="badge bl" style="font-size:7px">🏦</span>':'';
  return`<tr onclick="openDetail('${t.id}')"><td class="dim">${t.date}</td><td class="sym">${esc(t.symbol)} ${ttBadge}</td><td>${dirB}</td><td>${pnlStr}</td><td>${rStr}</td><td><div class="rdots">${dots}</div></td><td class="lesson-cell">${les}</td>${del}</tr>`;
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   RULES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   RULES  — structured tabbed rulebook
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

/* Data shape: { swing:{entry:[],exit:[],risk:[],mental:[]}, intraday:{time:[],entry:[],pnl:[],risk:[]}, investing:{selection:[],valuation:[],portfolio:[],exit:[]} } */
const RG_KEYS = {
  swing:    ['entry','exit','risk','mental'],
  intraday: ['time','entry','pnl','risk'],
  investing:['selection','valuation','portfolio','exit']
};

function rgDefaults() {
  return {
    swing: {
      entry: [
        'Only enter after market confirms trend on daily chart (higher highs/higher lows for longs).',
        'Setup must have minimum 2:1 risk/reward ratio before entry.',
        'Volume must be above 20-day average at breakout point.',
        'Do not enter on Friday afternoon — avoid weekend gap risk.',
        'Check sector relative strength before entering individual stock.',
      ],
      exit: [
        'Set stop loss at logical support level BEFORE entry — never widen it.',
        'Take partial profit (50%) at 1:1 R/R to ensure breakeven floor.',
        'Trail remaining position using 10-period EMA after 2R is achieved.',
        'Full exit on close below 20-day EMA for positional trades.',
      ],
      risk: [
        'Maximum 2% account risk per swing trade.',
        'Maximum 5 open swing positions simultaneously.',
        'Reduce position size by 50% during drawdown exceeding 5%.',
        'No leveraged ETFs held overnight beyond 3 days.',
      ],
      mental: [
        'Review trade setup the night before. No impulsive entries at open.',
        'If experiencing 3 consecutive losses, reduce size by 50% and take 1 day off.',
        'Never revenge trade after a loss. Close computer and return tomorrow.',
        'Rate emotional state 1–10 before each trade. Do not trade below 6.',
      ],
    },
    intraday: {
      time: [
        'No trades in first 15 minutes of market open (9:15–9:30 NSE / 9:30–9:45 NYSE).',
        'Avoid trading between 12:00–1:30 PM — low volume, choppy action.',
        'No new positions in last 30 minutes if already up on the day.',
        'All positions flat by close — no intraday positions carried overnight.',
      ],
      entry: [
        'Only trade setups with clear support/resistance levels identifiable on 5-min chart.',
        'Confirm entry on 15-min chart before executing on 5-min.',
        'Never trade against the 30-min trend direction.',
        'Maximum 3 intraday trades per session. Quality over quantity.',
      ],
      pnl: [
        'Daily loss limit: 2% of account. If hit, stop trading immediately.',
        'Daily profit target: 1.5% of account. Optional to stop after hitting target.',
        'If down 1% before 11AM, switch to observation mode only.',
        'Never try to "make back" losses in one trade. Scale is the enemy.',
      ],
      risk: [
        'Maximum 1% account risk per intraday trade.',
        'Maximum 2 concurrent open intraday positions.',
        'No trading during high-impact news events (FOMC, RBI policy, earnings).',
        'Use bracket orders / SL-M orders to automate exits.',
      ],
    },
    investing: {
      selection: [
        'Only invest in businesses you can explain in 2 sentences: what they do and how they make money.',
        'ROCE > 15% for at least 5 consecutive years.',
        'Debt/Equity < 0.5 for non-financial companies.',
        'Promoter holding > 50% and increasing over past 3 years.',
        'Avoid companies in terminal industries unless there\'s a clear transformation narrative.',
      ],
      valuation: [
        'Never pay > 40× earnings for any company regardless of growth rate.',
        'PEG ratio < 1.5 preferred. Compare P/E to 5-yr earnings growth CAGR.',
        'Buy in tranches: 25% at target, 25% at -10%, 25% at -20%, 25% at -30%.',
        'Require margin of safety: buy at 70% of intrinsic value estimate.',
      ],
      portfolio: [
        'Maximum 10% allocation to any single stock. Maintain diversification.',
        'Rebalance annually. Do not let any position exceed 15% due to appreciation.',
        'Keep 10–15% in cash/liquid funds for opportunistic buying during corrections.',
        'Review all holdings semi-annually against original investment thesis.',
      ],
      exit: [
        'Sell when original investment thesis is broken — not because price fell.',
        'Consider LTCG tax implications before selling — hold minimum 1 year for equity.',
        'Harvest tax losses in underperformers before year-end to offset gains.',
        'Never sell a great business just because it looks "expensive" if thesis is intact.',
      ],
    },
  };
}

let rulesData = (function() {
  try {
    const saved = JSON.parse(ls('zj4_rules2') || 'null');
    if (saved && saved.swing && saved.intraday && saved.investing) return saved;
  } catch(e) {}
  return rgDefaults();
})();

function saveRules2() { lss('zj4_rules2', rulesData); }

/* Keep legacy `rules` array in sync for pre-market checklist */
function syncLegacyRules() {
  const all = [];
  Object.values(rulesData).forEach(mode => Object.values(mode).forEach(arr => all.push(...arr)));
  rules = all;
  saveRules();
}

function rulesTab(mode, btn) {
  document.querySelectorAll('.rules-tab').forEach(b => b.classList.remove('on'));
  document.querySelectorAll('.rules-pane').forEach(p => p.classList.remove('on'));
  if (btn) btn.classList.add('on');
  const pane = $('rules-pane-' + mode);
  if (pane) pane.classList.add('on');
  if (mode === 'checklist') { pmClRender(); return; }
  rgRenderMode(mode);
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   PRE-MARKET CHECKLIST — inside Rules tab
   Shared state with Pre-Market tab via pmClChecked
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

/* Persistent checked state: { 'mental-0': true, 'swing-entry-2': true, … } */
let pmClChecked = (function() {
  try { return JSON.parse(ls('zj4_pmcl') || '{}'); } catch(e) { return {}; }
})();

function pmClSave() { lss('zj4_pmcl', pmClChecked); }

/* Key builders */
function pmClMentalKey(i) { return 'mental-' + i; }
function pmClRuleKey(mode, cat, i) { return mode + '-' + cat + '-' + i; }

/* Toggle a checklist item, update progress, sync premarket tab if open */
function pmClToggle(key, rowEl) {
  pmClChecked[key] = !pmClChecked[key];
  rowEl.classList.toggle('ck', !!pmClChecked[key]);
  const box = rowEl.querySelector('.pm-cl-box');
  if (box) box.textContent = pmClChecked[key] ? '✓' : '';
  pmClSave();
  pmClUpdateProgress();
  /* Live-sync: if premarket pane is visible, re-render its checklist */
  const pmPane = $('v-premarket');
  if (pmPane && pmPane.classList.contains('on')) renderPremarket();
}

/* Count totals and update progress bar + label */
function pmClUpdateProgress() {
  let total = 0, checked = 0;
  document.querySelectorAll('#rules-pane-checklist .pm-cl-row').forEach(row => {
    total++;
    if (row.classList.contains('ck')) checked++;
  });
  const pct = total ? Math.round(checked / total * 100) : 0;
  const label = $('pm-cl-count-label');
  const bar   = $('pm-cl-bar');
  if (label) label.textContent = checked + ' / ' + total + ' checked';
  if (bar)   bar.style.width   = pct + '%';
  if (bar)   bar.style.background = pct === 100 ? 'var(--green)' : pct >= 50 ? 'var(--amber)' : 'var(--red)';

  /* Mental section count badge */
  let mTotal = 0, mChecked = 0;
  document.querySelectorAll('#pm-cl-mental-list .pm-cl-row').forEach(r => {
    mTotal++; if (r.classList.contains('ck')) mChecked++;
  });
  const mc = $('pm-cl-mental-count');
  if (mc) mc.textContent = mChecked + ' / ' + mTotal;

  /* Section badges */
  document.querySelectorAll('.pm-cl-sec-count').forEach(el => {
    const sec = el.dataset.sec;
    let st = 0, sc = 0;
    document.querySelectorAll('[data-sec-key^="' + sec + '"] .pm-cl-row').forEach(r => {
      st++; if (r.classList.contains('ck')) sc++;
    });
    el.textContent = sc + ' / ' + st;
  });

  /* Done banner */
  const banner = $('pm-cl-done-banner');
  if (banner) banner.style.display = (total > 0 && checked === total) ? 'block' : 'none';
}

/* Build one checklist row */
function pmClRow(key, text) {
  const checked = !!pmClChecked[key];
  const div = document.createElement('div');
  div.className = 'pm-cl-row' + (checked ? ' ck' : '');
  div.innerHTML =
    '<div class="pm-cl-box">' + (checked ? '✓' : '') + '</div>' +
    '<div class="pm-cl-text">' + esc(text) + '</div>';
  div.addEventListener('click', function() { pmClToggle(key, div); });
  return div;
}

/* Section config: icon, label, colour, mode, cat */
const PM_CL_SECTIONS = [
  { mode:'swing',     cat:'entry',     icon:'🔴', label:'Swing — Entry Rules',           color:'rgba(248,113,113,0.1)',  textColor:'var(--red)'     },
  { mode:'swing',     cat:'exit',      icon:'🟧', label:'Swing — Exit Rules',             color:'rgba(248,113,113,0.08)', textColor:'var(--red)'     },
  { mode:'swing',     cat:'risk',      icon:'⚖️', label:'Swing — Risk & Sizing',          color:'rgba(212,168,71,0.1)',   textColor:'var(--amber2)'  },
  { mode:'swing',     cat:'mental',    icon:'⚠️', label:'Swing — Mental Rules',           color:'rgba(99,102,241,0.1)',   textColor:'var(--blue)'    },
  { mode:'intraday',  cat:'time',      icon:'🕐', label:'Intraday — Time Rules',          color:'rgba(248,113,113,0.1)',  textColor:'var(--red)'     },
  { mode:'intraday',  cat:'entry',     icon:'📊', label:'Intraday — Setup & Entry',       color:'rgba(74,222,128,0.08)', textColor:'var(--green)'   },
  { mode:'intraday',  cat:'pnl',       icon:'💰', label:'Intraday — P&L Rules',           color:'rgba(212,168,71,0.1)',   textColor:'var(--amber2)'  },
  { mode:'intraday',  cat:'risk',      icon:'⚖️', label:'Intraday — Risk Controls',       color:'rgba(34,211,238,0.08)', textColor:'var(--cyan)'    },
  { mode:'investing', cat:'selection', icon:'🔍', label:'Investing — Stock Selection',    color:'rgba(34,211,238,0.08)', textColor:'var(--cyan)'    },
  { mode:'investing', cat:'valuation', icon:'💹', label:'Investing — Valuation & Entry',  color:'rgba(74,222,128,0.08)', textColor:'var(--green)'   },
  { mode:'investing', cat:'portfolio', icon:'🍊', label:'Investing — Portfolio Mgmt',     color:'rgba(212,168,71,0.1)',   textColor:'var(--amber2)'  },
  { mode:'investing', cat:'exit',      icon:'🚪', label:'Investing — Exit & Tax',         color:'rgba(248,113,113,0.1)',  textColor:'var(--red)'     },
];

function pmClRender() {
  /* Mental state section */
  const mentalEl = $('pm-cl-mental-list');
  if (mentalEl) {
    mentalEl.innerHTML = '';
    PM_MINDSET.forEach(function(text, i) {
      mentalEl.appendChild(pmClRow(pmClMentalKey(i), text));
    });
  }

  /* Rules sections — filtered by pmTradeType if set */
  const secEl = $('pm-cl-rules-sections');
  if (!secEl) return;
  secEl.innerHTML = '';

  /* Show a filter indicator inside the Rules > Checklist tab */
  const filterBar = document.createElement('div');
  filterBar.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:18px;padding:9px 13px;background:var(--lift);border:1px solid var(--rule);border-radius:2px;flex-wrap:wrap';
  filterBar.innerHTML =
    '<span style="font-size:8px;text-transform:uppercase;letter-spacing:0.12em;color:var(--dim)">Filter:</span>' +
    ['all','intraday','swing','investing'].map(type => {
      const label = type==='all'?'📌 All':type==='intraday'?'⚡ Intraday':type==='swing'?'📋 Swing':' 🏦 Investment';
      const active = pmTradeType === type;
      return `<button onclick="setPMType('${type}',null);pmClRender();" style="background:${active?'rgba(212,168,71,0.1)':'none'};border:1px solid ${active?'rgba(212,168,71,0.3)':'var(--rule)'};color:${active?'var(--amber2)':'var(--dim)'};font-family:var(--m);font-size:8.5px;letter-spacing:0.06em;padding:3px 9px;border-radius:2px;cursor:pointer;transition:all 0.12s">${label}</button>`;
    }).join('');
  secEl.appendChild(filterBar);

  PM_CL_SECTIONS.forEach(function(sec) {
    /* Skip sections not matching current trade type filter */
    if (pmTradeType !== 'all' && sec.mode !== pmTradeType) return;

    const arr = (rulesData[sec.mode] || {})[sec.cat] || [];
    if (!arr.length) return;

    const secKey = sec.mode + '-' + sec.cat;
    const wrap = document.createElement('div');
    wrap.className = 'rg';
    wrap.style.marginBottom = '22px';
    wrap.setAttribute('data-sec-key', secKey);

    /* Section header */
    const head = document.createElement('div');
    head.className = 'rg-head';
    head.innerHTML =
      '<span class="rg-icon" style="background:' + sec.color + ';color:' + sec.textColor + '">' + sec.icon + '</span>' +
      '<span class="rg-label">' + sec.label + '</span>' +
      '<span class="pm-cl-sec-count" data-sec="' + secKey + '" style="margin-left:auto;font-size:8px;color:var(--ghost)"></span>';
    wrap.appendChild(head);

    /* Rule rows */
    arr.forEach(function(rule, i) {
      wrap.appendChild(pmClRow(pmClRuleKey(sec.mode, sec.cat, i), rule));
    });

    secEl.appendChild(wrap);
  });

  pmClUpdateProgress();
}

/* Reset all checks */
function pmClReset() {
  pmClChecked = {};
  pmClSave();
  pmClRender();
  /* Also sync premarket tab */
  const pmPane = $('v-premarket');
  if (pmPane && pmPane.classList.contains('on')) renderPremarket();
}

function rgRenderMode(mode) {
  (RG_KEYS[mode] || []).forEach(cat => rgRender(mode, cat));
}

function rgRender(mode, cat) {
  const el = $('rg-' + mode + '-' + cat);
  if (!el) return;
  const arr = (rulesData[mode] && rulesData[mode][cat]) || [];
  el.innerHTML = arr.map((r, i) =>
    `<div class="rg-row">
      <div class="rg-num">${String(i + 1).padStart(2, '0')}</div>
      <textarea class="rg-ta" rows="1"
        oninput="as(this);rulesData['${mode}']['${cat}'][${i}]=this.value;saveRules2();syncLegacyRules()"
      >${esc(r)}</textarea>
      <button class="rg-del" onclick="rgDel('${mode}','${cat}',${i})">×</button>
    </div>`
  ).join('');
  el.querySelectorAll('.rg-ta').forEach(as);
}

function rgAdd(mode, cat) {
  if (!rulesData[mode]) rulesData[mode] = {};
  if (!rulesData[mode][cat]) rulesData[mode][cat] = [];
  rulesData[mode][cat].push('');
  saveRules2(); syncLegacyRules(); rgRender(mode, cat);
  const rows = $('rg-' + mode + '-' + cat).querySelectorAll('.rg-ta');
  if (rows.length) rows[rows.length - 1].focus();
}

function rgDel(mode, cat, i) {
  rulesData[mode][cat].splice(i, 1);
  saveRules2(); syncLegacyRules(); rgRender(mode, cat);
}

/* Legacy compatibility — addRule/delRule kept for import/export */
function addRule() { rgAdd('swing', 'entry'); }
function delRule(i) { rgDel('swing', 'entry', i); }

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   PRE-MARKET — uses shared pmClChecked for two-way sync with Rules checklist tab
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

/* Currently selected trade type for pre-market filter: 'all'|'intraday'|'swing'|'investing' */
let pmTradeType = (function() {
  try { return ls('zj4_pmtype') || 'all'; } catch(e) { return 'all'; }
})();

function setPMType(type, btn) {
  pmTradeType = type;
  lss('zj4_pmtype', type);
  /* Sync pre-market page type buttons */
  document.querySelectorAll('.pm-type-btn').forEach(b => {
    b.classList.toggle('on', b.dataset.pmtype === type);
  });
  /* If pre-market view is active, re-render it */
  const pmPane = $('v-premarket');
  if (pmPane && pmPane.classList.contains('on')) renderPremarket();
}

function renderPremarket(){
  /* Sync pre-market type buttons to current pmTradeType */
  document.querySelectorAll('.pm-type-btn').forEach(b => {
    b.classList.toggle('on', b.dataset.pmtype === pmTradeType);
  });

  /* Update panel title */
  const titleEl = $('pm-rules-panel-title');
  if (titleEl) {
    const tLabel = pmTradeType==='intraday' ? '⚡ Intraday Rules' : pmTradeType==='swing' ? '📋 Swing/Positional Rules' : pmTradeType==='investing' ? '🏦 Investment Rules' : 'Pre-Trade Rules Checklist';
    titleEl.textContent = tLabel;
  }

  /* Mental state checks — synced via pmClChecked */
  $('pm-mindset-checks').innerHTML = PM_MINDSET.map((m, i) => {
    const key = pmClMentalKey(i);
    const ck = !!pmClChecked[key];
    return `<div class="cl-row${ck?' ck':''}" id="pmm${i}" onclick="pmMentalTog(${i})">
      <div class="cl-box">${ck?'&#10003;':''}</div>
      <div class="cl-txt">${esc(m)}</div>
    </div>`;
  }).join('');

  /* Rules filtered by trade type — synced via pmClChecked */
  const allRules = [];
  PM_CL_SECTIONS.forEach(sec => {
    if (pmTradeType !== 'all' && sec.mode !== pmTradeType) return;
    const arr = (rulesData[sec.mode] || {})[sec.cat] || [];
    arr.forEach((rule, i) => allRules.push({ key: pmClRuleKey(sec.mode, sec.cat, i), text: rule, sec: sec }));
  });

  if (!allRules.length) {
    const typeLabel = pmTradeType === 'intraday' ? 'Intraday' : pmTradeType === 'swing' ? 'Swing/Positional' : pmTradeType === 'investing' ? 'Investment' : '';
    $('pm-rules-list').innerHTML = `<div class="empty-t" style="color:var(--dim);font-size:10px;padding:12px 0">No rules defined for ${typeLabel} yet.<br><a onclick="const rb=document.querySelector('.t[onclick*=rules]');goTo('rules',rb);" style="color:var(--amber);cursor:pointer;text-decoration:none">Go to Rules tab →</a></div>`;
  } else {
    $('pm-rules-list').innerHTML = allRules.map((item, idx) => {
      const ck = !!pmClChecked[item.key];
      return `<div class="cl-row${ck?' ck':''}" id="pmr${idx}" data-pmkey="${item.key}" onclick="pmRuleTog(${idx})">
        <div class="cl-box" id="pmrb${idx}">${ck?'&#10003;':''}</div>
        <div class="cl-txt">${esc(item.text)}</div>
      </div>`;
    }).join('');
  }

  updatePMCount();
  sv('pm-intention', pmSt.intention||'');
  sv('pm-bias', pmSt.bias||'');
  const yTrades  = trades.filter(t => !t.passed && t.date === yesterday());
  const yLessons = yTrades.filter(t => t.lesson);
  $('pm-yesterday').innerHTML = yLessons.length
    ? yLessons.map(t => `<div style="font-family:var(--g);font-style:italic;font-size:14px;color:var(--amber2);line-height:1.6;margin-bottom:8px">"${esc(t.lesson)}"</div><div style="font-size:9px;color:var(--dim)">${t.symbol} · ${t.date}</div>`).join('<div style="height:10px"></div>')
    : `<div class="empty-t" style="color:var(--dim);font-size:10px">No trades from yesterday.<br>Clean slate.</div>`;
}

function pmMentalTog(i) {
  const key = pmClMentalKey(i);
  pmClChecked[key] = !pmClChecked[key];
  pmClSave();
  const row = $('pmm' + i);
  if (row) {
    row.classList.toggle('ck', !!pmClChecked[key]);
    const box = row.querySelector('.cl-box');
    if (box) box.textContent = pmClChecked[key] ? '✓' : '';
  }
  updatePMCount();
  if ($('rules-pane-checklist') && $('rules-pane-checklist').classList.contains('on')) pmClUpdateProgress();
}

function pmRuleTog(idx) {
  const row = $('pmr' + idx);
  if (!row) return;
  const key = row.dataset.pmkey;
  if (!key) return;
  pmClChecked[key] = !pmClChecked[key];
  pmClSave();
  row.classList.toggle('ck', !!pmClChecked[key]);
  const box = $('pmrb' + idx);
  if (box) box.textContent = pmClChecked[key] ? '✓' : '';
  updatePMCount();
  if ($('rules-pane-checklist') && $('rules-pane-checklist').classList.contains('on')) pmClUpdateProgress();
}

function updatePMCount() {
  const total   = document.querySelectorAll('#pm-mindset-checks .cl-row, #pm-rules-list .cl-row').length;
  const checked = document.querySelectorAll('#pm-mindset-checks .cl-row.ck, #pm-rules-list .cl-row.ck').length;
  const el = $('pm-ck-count');
  if (el) el.textContent = checked + ' / ' + total + ' checked';
}

function renderRules() {
  const activePaneEl = document.querySelector('.rules-pane.on');
  let activeMode = 'swing';
  if (activePaneEl) {
    const id = activePaneEl.id || '';
    activeMode = id.replace('rules-pane-', '') || 'swing';
  }
  if (activeMode === 'checklist') { pmClRender(); return; }
  rgRenderMode(activeMode);
}

function savePM(){pmSt={intention:$('pm-intention').value,bias:$('pm-bias').value};lss('zj4_pm',pmSt);toast('Ritual saved.');}
function yesterday(){const d=new Date();d.setDate(d.getDate()-1);return d.toISOString().slice(0,10);}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   DECISION ENGINE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
let deAnswers={};
function renderDecision(){
  deAnswers={};$('de-verdict-wrap').style.display='none';
  $('de-flow').innerHTML=DE_QUESTIONS.map((q,i)=>`<div class="de-step" id="de-s${i}">
    <div class="de-num">${i+1}</div>
    <div class="de-q">${q.q}</div>
    <div class="de-btns">
      <button class="de-yes" id="dey${i}" onclick="deAns(${i},true)">YES</button>
      <button class="de-no"  id="den${i}" onclick="deAns(${i},false)">NO</button>
    </div>
  </div>`).join('');
}
function deAns(i,yes){
  $('dey'+i).classList.toggle('on',yes);$('den'+i).classList.toggle('on',!yes);
  $('de-s'+i).classList.toggle('pass',yes);$('de-s'+i).classList.toggle('fail',!yes);
  deAnswers[i]=yes;
  if(Object.keys(deAnswers).length===DE_QUESTIONS.length){
    const allYes=Object.values(deAnswers).every(Boolean);
    const vw=$('de-verdict-wrap'),vt=$('de-verdict-text'),vs=$('de-verdict-sub');
    vw.style.display='block';
    if(allYes){vt.textContent='Take the trade.';vt.className='de-verdict-big take';vs.textContent='All conditions met. Execute with discipline.';}
    else{const fails=Object.entries(deAnswers).filter(([,v])=>!v).map(([k])=>DE_QUESTIONS[k].q);vt.textContent='Stand aside.';vt.className='de-verdict-big skip';vs.textContent='Failed: '+fails.slice(0,2).join(' · ');}
    vw.scrollIntoView({behavior:'smooth',block:'center'});
  }
}
function resetDecision(){renderDecision();}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   PSYCHOLOGY
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
function renderPsy(){
  if(psySt.focus)$('psy-focus').value=psySt.focus;
  if(psySt.conf)$('psy-conf').value=psySt.conf;
  if(psySt.pat)$('psy-pat').value=psySt.pat;
  if(psySt.disc)$('psy-disc').value=psySt.disc;
  if(psySt.notes)sv('psy-notes',psySt.notes);
  psyUpdate();
}
function psyUpdate(){
  ['focus','conf','pat','disc'].forEach(k=>{$('psy-'+k+'-v').textContent=$('psy-'+k).value+' / 10';});
}
function setMood(el){document.querySelectorAll('.mood-dot').forEach(d=>d.classList.remove('on'));el.classList.add('on');psySt.mood=el.dataset.m;lss('zj4_psy',psySt);}
function savePsy(){psySt={focus:$('psy-focus').value,conf:$('psy-conf').value,pat:$('psy-pat').value,disc:$('psy-disc').value,notes:$('psy-notes').value};lss('zj4_psy',psySt);toast('Check-in saved.');}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   PHILOSOPHY
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
function renderPhilosophy(){
  const ta = $('phil-notes');
  if (ta && philSt && philSt.notes) ta.value = philSt.notes;
  showQuote();
}
function showQuote(){const q=QUOTES[quoteIdx];const qt=$('quote-text');const qa=$('quote-attr');const qi=$('quote-idx');if(qt)qt.textContent='\u201c'+q.t+'\u201d';if(qa)qa.textContent='— '+q.a;if(qi)qi.textContent=(quoteIdx+1)+' / '+QUOTES.length;}
function nextQuote(){quoteIdx=(quoteIdx+1)%QUOTES.length;showQuote();}
function prevQuote(){quoteIdx=(quoteIdx-1+QUOTES.length)%QUOTES.length;showQuote();}
function savePhil(){if(philSt&&$('phil-notes')){philSt.notes=$('phil-notes').value;lss('zj4_phil',philSt);toast('Saved.');}}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   LEARNING
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
let lrnLearnings = JSON.parse(ls('zj4_learnings') || '[]');
let _lrnImpact = 5;

function saveLrnLearnings() { lss('zj4_learnings', lrnLearnings); }

function renderLearning() {
  // Activate the books tab (default) and seed render
  document.querySelectorAll('.lrn-tab').forEach((b, i) => b.classList.toggle('on', i === 0));
  document.querySelectorAll('.lrn-pane').forEach((p, i) => p.classList.toggle('on', i === 0));
  lrnRenderLearnings();
}

function lrnTab(id, btn) {
  document.querySelectorAll('.lrn-tab').forEach(b => b.classList.remove('on'));
  document.querySelectorAll('.lrn-pane').forEach(p => p.classList.remove('on'));
  if (btn) btn.classList.add('on');
  $('lrn-pane-'+id).classList.add('on');
  if (id === 'mylearnings') lrnRenderLearnings();
  if (id === 'lessons') lesRender();
}

/* ── CURATED LESSONS DATA ── */
const LESSONS = [
  // RISK — 4 lessons
  { id:1, cat:'risk', lesson:'Never risk more than you can afford to lose twice in a row. True risk management is not about any single trade — it is about staying in the game long enough for your edge to compound.', source:'Paul Tudor Jones', apply:'Cap each trade at 1–2% of account equity. After two consecutive losses, halve your size until you return to equity high water mark.' },
  { id:2, cat:'risk', lesson:'The first rule is not to lose. The second rule is not to forget the first rule. Preservation of capital is the foundation upon which every return is built.', source:'Warren Buffett', apply:'Before entering any trade, ask: what is the maximum I can lose? Is that acceptable? If not, reduce size or pass.' },
  { id:3, cat:'risk', lesson:'I always know my exit before I enter. Uncertainty about exits is not a trading style — it is a guarantee of emotional decision-making at the worst possible moment.', source:'Jesse Livermore', apply:'Write your stop and target in the journal before placing the order. Never move a stop against your position.' },
  { id:4, cat:'risk', lesson:'Volatility is not risk. Real risk is the permanent loss of capital. Confusing short-term fluctuation with long-term impairment causes traders to exit winning positions and hold losing ones.', source:'Howard Marks · Oaktree Capital', apply:'Distinguish between mark-to-market drawdown and thesis invalidation. Only exit when the thesis breaks, not when price fluctuates.' },

  // MINDSET — 4 lessons
  { id:5, cat:'mindset', lesson:'Think in probabilities, not outcomes. A losing trade executed perfectly is a good trade. A winning trade born from impulse is a bad trade. Judge process, not results.', source:'Mark Douglas · Trading in the Zone', apply:'After each trade, rate your process from 1–5. Track process scores separately from P&L. Process is what compounds.' },
  { id:6, cat:'mindset', lesson:'The market is not against you — it is indifferent to you. Personalising price movements is the root of revenge trading, stubbornness, and the death of objectivity.', source:'Mark Douglas', apply:'When you feel the urge to "get back what the market owes you", step away. The market owes you nothing. Your edge owes you probability.' },
  { id:7, cat:'mindset', lesson:'It was never my thinking that made me money. It was my sitting. Patient waiting is itself a position — the most undervalued position in any trader\'s arsenal.', source:'Jesse Livermore', apply:'Define explicit criteria for what constitutes a valid setup. If those criteria are not met, cash is the correct position.' },
  { id:8, cat:'mindset', lesson:'Pain plus reflection equals progress. Every loss contains the exact lesson required for your next profitable setup — if you are honest enough to look for it.', source:'Ray Dalio · Principles', apply:'Complete a written post-mortem within 24 hours of any trade that loses more than 1R. Identify one specific action to take differently.' },

  // ENTRY — 4 lessons
  { id:9, cat:'entry', lesson:'The best trades are the ones that feel almost too obvious — the ones where price, time, and fundamentals align so cleanly that the trade practically executes itself. If you are forcing it, you are wrong.', source:'Stanley Druckenmiller', apply:'Score your setups before entry. Require a minimum threshold (e.g., 70/100) before placing an order. No threshold, no trade.' },
  { id:10, cat:'entry', lesson:'Buy at the point of maximum pessimism. The best entries come when the story is worst and most investors have capitulated. Courage is the primary ingredient of alpha.', source:'Sir John Templeton', apply:'Keep a watchlist of quality setups and wait for them to reach oversold extremes rather than chasing extended moves.' },
  { id:11, cat:'entry', lesson:'The trend is your friend until the end when it bends. Enter in the direction of the dominant trend on the higher timeframe, and you remove one layer of uncertainty before you even begin.', source:'Ed Seykota', apply:'Always identify the trend on two timeframes above your entry timeframe before placing a directional trade. Align all three for highest-conviction entries.' },
  { id:12, cat:'entry', lesson:'Amateur traders focus on entries. Professional traders focus on exits and risk management. The entry matters — but it matters last, not first.', source:'Alexander Elder', apply:'Design your exit and stop first, then work backwards to find the entry that gives you the best reward-to-risk from that exit structure.' },

  // EXIT — 3 lessons
  { id:13, cat:'exit', lesson:'Cut your losses and let your profits run. These seven words contain more trading wisdom than most books. Violating either half of this rule is the primary cause of blown accounts.', source:'David Ricardo · 1838', apply:'Implement a hard rule: never add to a losing position and never move your stop further away. Exits on losers are mechanical, not discretionary.' },
  { id:14, cat:'exit', lesson:'Selling too early is not a mistake — it is a discipline. The goal is not to catch the full move; it is to extract consistent R from every setup your edge identifies.', source:'Richard Dennis', apply:'Define a partial exit target (e.g., take 50% at 2R, trail the rest). Remove emotion from the final exit by using a trailing stop or ATR-based rule.' },
  { id:15, cat:'exit', lesson:'You don\'t lose money by taking profits. The greatest danger in a winning trade is ego — the belief that because you are right, you are entitled to hold forever. Markets correct overconfidence.', source:'George Soros', apply:'Set a calendar reminder: if a position is open more than 2× your average hold time without hitting target, review and decide consciously whether to stay.' },

  // STRATEGY — 4 lessons
  { id:16, cat:'strategy', lesson:'Diversification is the only free lunch in investing. Fifteen truly uncorrelated return streams can dramatically reduce portfolio volatility without reducing expected return.', source:'Ray Dalio', apply:'Audit your open positions monthly. If more than 60% are correlated to the same macro factor, reduce concentration before adding new trades.' },
  { id:17, cat:'strategy', lesson:'Play only your best setups. Trading frequently to feel productive is one of the most common and expensive psychological traps. Fewer, higher-conviction trades is almost always superior.', source:'George Soros', apply:'Set a monthly trade quota. When you hit the quota, stop trading for the month. Review whether quality improved as quantity declined.' },
  { id:18, cat:'strategy', lesson:'The market can remain irrational longer than you can remain solvent. Timing matters as much as thesis. A correct idea entered too early is, functionally, a wrong trade.', source:'John Maynard Keynes', apply:'Always look for a catalyst — an event or technical level — that will cause your thesis to be recognised by others within your target hold period.' },
  { id:19, cat:'strategy', lesson:'No system works in all market regimes. The trader who adapts their strategy to trending, mean-reverting, and volatile conditions survives. The one who insists on one approach does not.', source:'Ed Seykota', apply:'Classify the current regime at the start of each week: Trend, Range, or Volatile. Apply the correct playbook for that regime and review if conditions change.' },

  // SIZING — 3 lessons
  { id:20, cat:'sizing', lesson:'Position sizing is the variable that separates survival from ruin. Two traders with identical systems and identical edges can produce wildly different outcomes based on bet sizing alone.', source:'Van Tharp · Trade Your Way to Financial Freedom', apply:'Use the Kelly Criterion as an upper bound, then trade at ¼ Kelly for practical application. Never exceed 2% risk per trade regardless of conviction.' },
  { id:21, cat:'sizing', lesson:'Bet big when you have the odds. Bet small when you are uncertain. The ability to scale up in high-conviction situations and scale down in uncertainty is the hallmark of a mature trader.', source:'George Soros', apply:'Create three position size tiers — Full (1.5× base), Standard (1× base), Pilot (0.5× base). Use your setup score to determine the tier before entry.' },
  { id:22, cat:'sizing', lesson:'The mathematics of ruin are unforgiving. Even a 60% win rate strategy will go bankrupt with aggressive sizing. Survival is the prerequisite for every other trading ambition.', source:'Nassim Nicholas Taleb · Antifragile', apply:'Calculate your ruin probability given your win rate, average R:R, and position size. Accept only strategies where theoretical ruin probability is below 1%.' },
];

let _lesActiveCat = '';

function lesFilter(cat, btn) {
  _lesActiveCat = cat;
  document.querySelectorAll('.les-cat-btn').forEach(b => b.classList.remove('on'));
  if (btn) btn.classList.add('on');
  lesRender();
}

function lesRender() {
  const el = $('les-grid');
  if (!el) return;
  const filtered = _lesActiveCat ? LESSONS.filter(l => l.cat === _lesActiveCat) : LESSONS;
  el.innerHTML = filtered.map(l =>
    `<div class="les-card ${l.cat}">
      <div class="les-card-head">
        <span class="les-card-cat ${l.cat}">${l.cat.charAt(0).toUpperCase()+l.cat.slice(1)}</span>
        <span class="les-card-num">${String(l.id).padStart(2,'0')} / 22</span>
      </div>
      <div class="les-card-body">"${l.lesson}"</div>
      <div class="les-card-source">— ${l.source}</div>
      <div class="les-card-apply"><strong>Apply It</strong>${l.apply}</div>
    </div>`
  ).join('');
}

function lrnToggleBook(el) {
  el.classList.toggle('expanded');
}

function lrnOpenModal() {
  _lrnImpact = 5;
  document.querySelectorAll('#lrn-impact-btns .lrn-impact-btn').forEach(b => b.classList.toggle('on', parseInt(b.dataset.n) === 5));
  const fields = ['lrn-m-type','lrn-m-source','lrn-m-insight','lrn-m-apply'];
  fields.forEach(id => { const el=$(id); if(el && el.tagName==='INPUT'||el.tagName==='TEXTAREA') el.value=''; });
  const typeEl = $('lrn-m-type');
  if (typeEl) typeEl.value = 'book';
  $('lrn-modal').classList.add('on');
}

function lrnCloseModal() {
  $('lrn-modal').classList.remove('on');
}

function lrnSetImpact(n) {
  _lrnImpact = n;
  document.querySelectorAll('#lrn-impact-btns .lrn-impact-btn').forEach(b => b.classList.toggle('on', parseInt(b.dataset.n) === n));
}

function lrnSaveLearning() {
  const source  = ($('lrn-m-source')||{}).value || '';
  const insight = ($('lrn-m-insight')||{}).value || '';
  const apply   = ($('lrn-m-apply')||{}).value || '';
  const type    = ($('lrn-m-type')||{}).value || 'book';
  if (!insight.trim()) { toast('Please enter an insight.'); return; }
  lrnLearnings.unshift({
    id: Date.now(),
    type, source, insight, apply,
    impact: _lrnImpact,
    date: new Date().toISOString().slice(0,10),
  });
  saveLrnLearnings();
  lrnCloseModal();
  lrnRenderLearnings();
  toast('Learning saved ✓');
}

function lrnDeleteLearning(id) {
  lrnLearnings = lrnLearnings.filter(l => l.id !== id);
  saveLrnLearnings();
  lrnRenderLearnings();
}

const LRN_TYPE_LABELS = {
  book: '📚 Book',
  mentor: '🧠 Mentor',
  experiment: '🧪 Experiment',
  market: '📊 Market',
};
const LRN_IMPACT_LABELS = ['', 'Minor', 'Interesting', 'Solid insight', 'High impact', 'Life-changing'];

function lrnRenderLearnings() {
  const el = $('lrn-learnings-list');
  if (!el) return;
  const typeF   = ($('lrn-filter-type')||{}).value || '';
  const impactF = parseInt(($('lrn-filter-impact')||{}).value) || 0;

  let list = lrnLearnings;
  if (typeF)   list = list.filter(l => l.type === typeF);
  if (impactF) list = list.filter(l => l.impact >= impactF);

  if (!list.length) {
    el.innerHTML = `
      <div style="text-align:center;padding:48px 20px;color:var(--dim)">
        <div style="font-size:32px;margin-bottom:12px">✍</div>
        <div style="font-size:13px;margin-bottom:6px;color:var(--text)">No learnings yet</div>
        <div style="font-size:11px;line-height:1.7">Every insight you add here compounds over time.<br>Start with the biggest lesson you've ever learned from trading.</div>
        <div style="margin-top:20px"><button class="dr-save-btn" onclick="lrnOpenModal()">+ Add Your First Learning</button></div>
      </div>`;
    return;
  }

  el.innerHTML = list.map(l => {
    const typeBadge = `<span class="lrn-entry-type-badge ${l.type}">${LRN_TYPE_LABELS[l.type]||l.type}</span>`;
    const impact = Array.from({length:5}, (_,i) => `<div class="lrn-entry-impact-dot ${i < l.impact ? 'on' : ''}"></div>`).join('');
    return `<div class="lrn-entry">
      <div class="lrn-entry-top">
        ${typeBadge}
        <div class="lrn-entry-body">
          <div class="lrn-entry-source">${esc(l.source || 'Personal insight')}</div>
          <div class="lrn-entry-insight">"${esc(l.insight)}"</div>
          ${l.apply ? `<div style="font-size:10px;color:var(--dim);margin-top:5px;padding:8px 10px;background:rgba(212,168,71,0.04);border-left:2px solid rgba(212,168,71,0.25);border-radius:1px">→ ${esc(l.apply)}</div>` : ''}
          <div class="lrn-entry-meta" style="margin-top:7px;display:flex;align-items:center;gap:10px">
            <div class="lrn-entry-impact">${impact}</div>
            <span>${LRN_IMPACT_LABELS[l.impact]}</span>
            <span style="margin-left:auto">${l.date}</span>
          </div>
        </div>
        <button class="lrn-entry-del" onclick="lrnDeleteLearning(${l.id})">×</button>
      </div>
    </div>`;
  }).join('');
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   DAILY REVIEW
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
let _drDate = new Date().toISOString().slice(0,10);
let _drEmotions = new Set();
let _drStars = {overall:0, stop:0, sizing:0, patience:0};
let _drRegime = '';
let _drHabits = new Set();
let _drSitout = false;
let _drAutoTimer = null;

const DR_STAR_LABELS = ['','Terrible','Poor','Decent','Good','Perfect'];
const DR_REGIMES = ['Strong Trend Up','Weak Trend Up','Ranging','Weak Trend Down','Strong Trend Down','High Volatility'];

function renderDailyReview() {
  const input = $('dr-date-input');
  if (input) input.value = _drDate;
  drLoadDate(_drDate, true);
}

function drGoToday() {
  _drDate = new Date().toISOString().slice(0,10);
  renderDailyReview();
}

function drNavigate(dir) {
  const d = new Date(_drDate + 'T12:00:00');
  d.setDate(d.getDate() + dir);
  _drDate = d.toISOString().slice(0,10);
  const input = $('dr-date-input');
  if (input) input.value = _drDate;
  drLoadDate(_drDate, true);
}

function drLoadDate(date, full) {
  _drDate = date;
  const rev = drReviews[date] || {};
  // Reset state
  _drEmotions = new Set(rev.emotions || []);
  _drStars = Object.assign({overall:0,stop:0,sizing:0,patience:0}, rev.stars || {});
  _drRegime = rev.regime || '';
  _drHabits = new Set(rev.habits || []);
  _drSitout = rev.sitout || false;
  // Fill textareas
  sv('dr-well',     rev.well     || '');
  sv('dr-fight',    rev.fight    || '');
  sv('dr-tmr',      rev.tmr      || '');
  sv('dr-lesson',   rev.lesson   || '');
  sv('dr-emotion-notes', rev.emNotes || '');
  sv('dr-market',   rev.market   || '');
  // Render UI components
  drRenderEmotions();
  drRenderStars();
  drRenderRegime();
  drRenderHabits();
  drRenderSitout();
  drRenderGlance();
  drRenderStreak();
  drRenderPast();
  drRenderEmPerf();
  drUpdateScore();
  drRenderInsight();
  $('dr-save-status').textContent = rev.saved ? ('Saved · ' + rev.saved) : 'Unsaved';
  $('dr-save-status').className = 'dr-save-status' + (rev.saved ? ' saved' : '');
  // Sitout count
  const sCount = Object.values(drReviews).filter(r=>r.sitout).length;
  const sEl = $('dr-sitout-count');
  if (sEl) { sEl.textContent = sCount; sEl.className = 'dr-sitout-n' + (sCount > 0 ? ' has' : ''); }
}

function sv(id, val) { const el = $(id); if (el) el.value = val; }

function drAutoSave() {
  $('dr-save-status').textContent = 'Unsaved changes';
  $('dr-save-status').className = 'dr-save-status';
  clearTimeout(_drAutoTimer);
  _drAutoTimer = setTimeout(drSave, 2500);
  drUpdateScore();
}

function drSave() {
  clearTimeout(_drAutoTimer);
  const now = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  drReviews[_drDate] = {
    well:     ($('dr-well') || {}).value || '',
    fight:    ($('dr-fight') || {}).value || '',
    tmr:      ($('dr-tmr') || {}).value || '',
    lesson:   ($('dr-lesson') || {}).value || '',
    emNotes:  ($('dr-emotion-notes') || {}).value || '',
    market:   ($('dr-market') || {}).value || '',
    emotions: [..._drEmotions],
    stars:    {..._drStars},
    regime:   _drRegime,
    habits:   [..._drHabits],
    sitout:   _drSitout,
    saved:    now,
    date:     _drDate,
  };
  lss('zj4_dr', drReviews);
  $('dr-save-status').textContent = 'Saved · ' + now;
  $('dr-save-status').className = 'dr-save-status saved';
  drRenderStreak();
  drRenderPast();
  drRenderEmPerf();
  drRenderInsight();
  toast('Review saved ✓');
}

/* ── Emotions ── */
function drToggleEmotion(chip) {
  const em = chip.dataset.em;
  if (_drEmotions.has(em)) { _drEmotions.delete(em); chip.classList.remove('on'); }
  else { _drEmotions.add(em); chip.classList.add('on'); }
  drAutoSave();
}
function drRenderEmotions() {
  document.querySelectorAll('#dr-emotions .dr-em-chip').forEach(c => {
    c.classList.toggle('on', _drEmotions.has(c.dataset.em));
  });
}

/* ── Stars ── */
function drSetStar(group, n) {
  _drStars[group] = _drStars[group] === n ? 0 : n;
  drRenderStars();
  drAutoSave();
}
function drRenderStars() {
  ['overall','stop','sizing','patience'].forEach(g => {
    const n = _drStars[g] || 0;
    document.querySelectorAll(`#dr-stars-${g} .dr-star`).forEach((s,i) => s.classList.toggle('on', i < n));
    const desc = $(` dr-stars-${g}-desc`) || document.getElementById(`dr-stars-${g}-desc`);
    if (desc) desc.textContent = DR_STAR_LABELS[n] || '';
  });
}

/* ── Regime ── */
function drSetRegime(btn) {
  const reg = btn.dataset.reg;
  _drRegime = _drRegime === reg ? '' : reg;
  drRenderRegime();
  drAutoSave();
}
function drRenderRegime() {
  document.querySelectorAll('#dr-regime-row .dr-regime-btn').forEach(b => b.classList.toggle('on', b.dataset.reg === _drRegime));
}

/* ── Habits ── */
function drToggleHabit(el) {
  const h = el.dataset.h;
  if (_drHabits.has(h)) _drHabits.delete(h); else _drHabits.add(h);
  drRenderHabits();
  drAutoSave();
}
function drRenderHabits() {
  const habits = document.querySelectorAll('#dr-habits .dr-habit');
  habits.forEach(h => h.classList.toggle('on', _drHabits.has(h.dataset.h)));
  const cnt = $('dr-habit-count');
  if (cnt) cnt.textContent = _drHabits.size + ' / ' + habits.length;
}

/* ── Sit-out ── */
function drToggleSitout() {
  _drSitout = !_drSitout;
  drRenderSitout();
  drAutoSave();
}
function drRenderSitout() {
  const btn = $('dr-sitout-btn');
  if (!btn) return;
  if (_drSitout) {
    btn.textContent = '✓ Sit-Out Logged';
    btn.classList.add('marked');
  } else {
    btn.textContent = '⚠ Log a Sit-Out Day';
    btn.classList.remove('marked');
  }
}

/* ── Today at a Glance ── */
function drRenderGlance() {
  const el = $('dr-glance-body');
  if (!el) return;
  const dayTrades = trades.filter(t => !t.passed && t.date === _drDate);
  if (!dayTrades.length) {
    el.innerHTML = '<div class="dr-empty-state" style="padding:16px 0"><div class="dr-empty-icon">📈</div>No trades logged on this date.</div>';
    return;
  }
  const wins = dayTrades.filter(t=>t.pnl>0), losses = dayTrades.filter(t=>t.pnl<=0);
  const pnl = dayTrades.reduce((s,t)=>s+t.pnl,0);
  const col = pnl>=0?'var(--green)':'var(--red)';
  el.innerHTML = `
    <div class="dr-glance-row"><span class="dr-glance-label">Total P&L</span><span class="dr-glance-val" style="color:${col}">${pnl>=0?'+':''}${pnl.toFixed(2)}</span></div>
    <div class="dr-glance-row"><span class="dr-glance-label">Trades</span><span class="dr-glance-val">${dayTrades.length}</span></div>
    <div class="dr-glance-row"><span class="dr-glance-label">Wins / Losses</span><span class="dr-glance-val"><span style="color:var(--green)">${wins.length}W</span> / <span style="color:var(--red)">${losses.length}L</span></span></div>
    <div class="dr-glance-row"><span class="dr-glance-label">Win Rate</span><span class="dr-glance-val">${dayTrades.length?(wins.length/dayTrades.length*100).toFixed(0)+'%':'—'}</span></div>
    <div style="margin-top:10px">
      ${dayTrades.map(t=>`<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--rule);font-size:10px"><span style="color:var(--text);font-weight:500">${esc(t.symbol)}</span><span style="color:${t.pnl>=0?'var(--green)':'var(--red)'}">${t.pnl>=0?'+':''}${t.pnl.toFixed(2)}</span></div>`).join('')}
    </div>`;
}

/* ── 30-Day Streak ── */
function drRenderStreak() {
  const el = $('dr-streak');
  if (!el) return;
  const days = [];
  for (let i=29; i>=0; i--) {
    const d = new Date(); d.setDate(d.getDate()-i);
    const ds = d.toISOString().slice(0,10);
    days.push(ds);
  }
  el.innerHTML = days.map(ds => {
    const rev = drReviews[ds];
    let cls = '';
    let tip = ds;
    if (rev) {
      if (rev.sitout) { cls='s'; tip=ds+' · Sit-out'; }
      else {
        const score = drCalcScore(rev);
        cls = score >= 70 ? 'g' : score >= 40 ? 'a' : 'r';
        tip = ds + ' · Score ' + score;
      }
    }
    const isToday = ds === new Date().toISOString().slice(0,10);
    return `<div class="dr-sq ${cls}" title="${tip}" style="${isToday?'outline:1px solid var(--amber);outline-offset:1px':''}" onclick="drNavToDate('${ds}')"></div>`;
  }).join('');
}

function drNavToDate(ds) {
  _drDate = ds;
  const input = $('dr-date-input');
  if (input) input.value = ds;
  drLoadDate(ds, true);
}

/* ── Emotion × Performance ── */
function drRenderEmPerf() {
  const el = $('dr-em-perf');
  if (!el) return;
  // Gather last 30 days of reviews that have both emotions and trade data
  const emStats = {};
  const NEG_EMOTIONS = ['Anxious','FOMO','Overconfident','Bored','Revenge','Fearful','Greedy','Distracted'];
  Object.values(drReviews).forEach(rev => {
    if (!rev.emotions || !rev.date) return;
    const dayTrades = trades.filter(t => !t.passed && t.date === rev.date);
    if (!dayTrades.length) return;
    const pnl = dayTrades.reduce((s,t)=>s+t.pnl,0);
    const positive = pnl > 0;
    rev.emotions.forEach(em => {
      if (!emStats[em]) emStats[em] = {pos:0,neg:0,total:0};
      emStats[em].total++;
      if (positive) emStats[em].pos++; else emStats[em].neg++;
    });
  });
  const items = Object.entries(emStats).filter(([,v])=>v.total>=1).sort((a,b)=>b[1].total-a[1].total).slice(0,6);
  if (!items.length) {
    el.innerHTML='<div class="dr-empty-state" style="padding:12px 0;font-size:10px"><div class="dr-empty-icon">🎭</div>Log more days with emotions to see patterns.</div>';
    return;
  }
  el.innerHTML = items.map(([em,v]) => {
    const wr = (v.pos/v.total*100).toFixed(0);
    const isNeg = NEG_EMOTIONS.includes(em);
    const cls = !isNeg ? 'hi' : parseInt(wr)<40?'lo':'mid';
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--rule);font-size:10px"><div><div style="color:var(--text)">${em}</div><div style="font-size:8.5px;color:var(--dim);margin-top:2px">${v.total} days logged</div></div><div style="text-align:right"><span class="dr-pattern-badge ${cls}">${wr}% W</span></div></div>`;
  }).join('');
}

/* ── Past reviews list ── */
function drRenderPast() {
  const el = $('dr-past-list');
  if (!el) return;
  const sorted = Object.values(drReviews).filter(r=>r.saved).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,8);
  if (!sorted.length) { el.innerHTML='<div class="dr-empty-state" style="padding:12px 0;font-size:10px">No reviews yet.</div>'; return; }
  el.innerHTML = sorted.map(r => {
    const snippet = (r.well || r.lesson || r.fight || '—').slice(0,55) + ((r.well||r.lesson||r.fight||'').length>55?'…':'');
    const chips = (r.emotions||[]).slice(0,3).map(e=>`<span class="dr-rv-chip">${e}</span>`).join('');
    const score = drCalcScore(r);
    const scoreCol = score>=70?'var(--green)':score>=40?'var(--amber2)':'var(--red)';
    return `<div class="dr-review-item" onclick="drNavToDate('${r.date}')">
      <div class="dr-review-date" style="display:flex;justify-content:space-between">${r.date}<span style="color:${scoreCol};font-size:10px">${score}</span></div>
      <div class="dr-review-snippet">${esc(snippet)}</div>
      <div class="dr-review-chips">${chips}</div>
    </div>`;
  }).join('');
}

/* ── Score computation ── */
function drCalcScore(rev) {
  if (!rev) return 0;
  let s = 0;
  const well  = (rev.well||'').length, fight = (rev.fight||'').length;
  const tmr   = (rev.tmr||'').length,  lesson = (rev.lesson||'').length;
  // Reflection depth (40 pts)
  s += Math.min(well/3, 10);
  s += Math.min(fight/3, 10);
  s += Math.min(tmr/3, 10);
  s += Math.min(lesson/2, 10);
  // Emotion awareness (20 pts)
  s += Math.min((rev.emotions||[]).length * 4, 20);
  // Rule adherence (25 pts)
  const starAvg = Object.values(rev.stars||{}).reduce((a,b)=>a+b,0) / 4;
  s += starAvg * 5;
  // Habits (15 pts)
  s += Math.min((rev.habits||[]).length * 2, 15);
  return Math.round(Math.min(s, 100));
}

function drUpdateScore() {
  const fakeRev = {
    well: ($('dr-well')||{}).value||'',
    fight: ($('dr-fight')||{}).value||'',
    tmr: ($('dr-tmr')||{}).value||'',
    lesson: ($('dr-lesson')||{}).value||'',
    emotions: [..._drEmotions],
    stars: {..._drStars},
    habits: [..._drHabits],
  };
  const score = drCalcScore(fakeRev);
  const arc = $('dr-score-arc');
  const num = $('dr-score-num');
  if (arc) {
    const circ = 175.9;
    arc.style.strokeDashoffset = circ - (score/100*circ);
    arc.style.stroke = score>=70?'var(--green)':score>=40?'var(--amber)':'var(--red)';
  }
  if (num) { num.textContent = score; num.style.color = score>=70?'var(--green)':score>=40?'var(--amber2)':'var(--red)'; }
  // Breakdown bars
  const w = fakeRev.well.length, f = fakeRev.fight.length, t = fakeRev.tmr.length, l = fakeRev.lesson.length;
  const rScore = Math.min((w+f+t+l)/12*100, 100);
  const eScore = Math.min(fakeRev.emotions.length/5*100, 100);
  const sScore = (Object.values(fakeRev.stars).reduce((a,b)=>a+b,0)/20)*100;
  const hScore = Math.min(fakeRev.habits.length/8*100, 100);
  setBar('reflect', rScore); setBar('emotion', eScore); setBar('rules', sScore); setBar('habits', hScore);
}
function setBar(id, pct) {
  const fill = document.getElementById('drb-'+id);
  const val  = document.getElementById('drbv-'+id);
  if (fill) fill.style.width = Math.round(pct) + '%';
  if (val)  val.textContent  = Math.round(pct);
}

/* ── Insight generator ── */
function drRenderInsight() {
  const el = $('dr-insight-body');
  if (!el) return;
  const allRevs = Object.values(drReviews).filter(r=>r.saved && r.date);
  if (allRevs.length < 3) {
    el.innerHTML = '<div class="dr-empty-state"><div class="dr-empty-icon">📊</div>Save at least 3 reviews to generate pattern insights.</div>';
    return;
  }
  // Find best and worst scoring days
  const scored = allRevs.map(r=>({...r, score: drCalcScore(r)})).sort((a,b)=>b.score-a.score);
  const best = scored[0], worst = scored[scored.length-1];
  // Top emotions on best days
  const topN = scored.slice(0, Math.ceil(scored.length/3));
  const emFreq = {};
  topN.forEach(r=>(r.emotions||[]).forEach(e=>{ emFreq[e]=(emFreq[e]||0)+1; }));
  const topEm = Object.entries(emFreq).sort((a,b)=>b[1]-a[1]).slice(0,2).map(([e])=>e);
  // Streak
  let streak = 0;
  for (let i=0; i<30; i++) {
    const d = new Date(); d.setDate(d.getDate()-i);
    const ds = d.toISOString().slice(0,10);
    if (drReviews[ds]?.saved) streak++; else break;
  }
  el.innerHTML = `<div class="dr-insight">
    <div class="dr-insight-head">✦ Pattern Insight · Based on ${allRevs.length} reviews</div>
    <div class="dr-insight-body">
      ${topEm.length ? `On your <strong>best-scoring days</strong>, you most often felt <strong>${topEm.join(' and ')}</strong>. Protect those conditions.` : ''}
      ${topEm.length ? '<br><br>' : ''}
      Your <strong>highest quality day</strong> was <strong>${best.date}</strong> (score: ${best.score}). Your <strong>most challenging</strong> was <strong>${worst.date}</strong> (score: ${worst.score}).
      <br><br>
      <strong>Review streak: ${streak} day${streak!==1?'s':''}</strong> in a row. ${streak>=7?'Outstanding consistency — this habit compounds.':streak>=3?'Building momentum. Keep going.':'Consistency is the edge. Aim for 7 days straight.'}
    </div>
  </div>`;
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   LEARNING PORTAL  — Default Data
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
const LP_DEFAULT_BOOKS = [
  {id:'b1',title:'Trading in the Zone',author:'Mark Douglas',cat:'Trading Psychology',desc:'The definitive guide to developing the mindset of a consistently profitable trader.',concepts:['Probabilistic thinking','Emotional discipline','Consistency','Mental framework'],status:'read',progress:100,rating:5,notes:'Changed how I think about risk. Every trade is just one of a series.'},
  {id:'b2',title:'The Disciplined Trader',author:'Mark Douglas',cat:'Trading Psychology',desc:'Building the mental foundation required to execute your trading plan flawlessly.',concepts:['Self-discipline','Fear & greed','Belief systems','Trade execution'],status:'read',progress:100,rating:5,notes:''},
  {id:'b3',title:'Reminiscences of a Stock Operator',author:'Edwin Lefèvre',cat:'Biographies',desc:'The thinly veiled autobiography of Jesse Livermore — the greatest speculator who ever lived.',concepts:['Trend following','Position sizing','Market timing','Patience'],status:'read',progress:100,rating:5,notes:''},
  {id:'b4',title:'Market Wizards',author:'Jack D. Schwager',cat:'Biographies',desc:'Interviews with top traders revealing their secrets, philosophies, and methods.',concepts:['Risk management','Diverse strategies','Mindset','Consistency'],status:'read',progress:100,rating:5,notes:''},
  {id:'b5',title:'How to Make Money in Stocks',author:'William J. O\'Neil',cat:'Technical Analysis',desc:'The CANSLIM system for identifying winning stocks before they make major price moves.',concepts:['CANSLIM','Cup and handle','Volume analysis','Growth stocks'],status:'reading',progress:60,rating:4,notes:''},
  {id:'b6',title:'The Intelligent Investor',author:'Benjamin Graham',cat:'Investing',desc:'The bible of value investing. Teaches margin of safety and Mr. Market allegory.',concepts:['Value investing','Margin of safety','Mr. Market','Long-term thinking'],status:'read',progress:100,rating:5,notes:''},
  {id:'b7',title:'One Good Trade',author:'Mike Bellafiore',cat:'Trading Psychology',desc:'Inside the highly competitive world of proprietary trading at SMB Capital.',concepts:['Process over results','Trade review','Intraday setups','Mental preparation'],status:'wishlist',progress:0,rating:0,notes:''},
  {id:'b8',title:'Technical Analysis of Financial Markets',author:'John J. Murphy',cat:'Technical Analysis',desc:'The comprehensive guide to trading methods and applications — the TA bible.',concepts:['Chart patterns','Indicators','Dow Theory','Intermarket analysis'],status:'reading',progress:35,rating:4,notes:''},
  {id:'b9',title:'Thinking, Fast and Slow',author:'Daniel Kahneman',cat:'Mindset & Performance',desc:'How two systems of thought — fast/intuitive and slow/rational — shape our decisions.',concepts:['Cognitive biases','Heuristics','Loss aversion','Decision making'],status:'read',progress:100,rating:5,notes:''},
  {id:'b10',title:'The Psychology of Money',author:'Morgan Housel',cat:'Investing',desc:'Timeless lessons on wealth, greed, and happiness — why smart people do irrational things with money.',concepts:['Long-term compounding','Behaviour gap','Enough','Wealth vs. rich'],status:'read',progress:100,rating:5,notes:''},
  {id:'b11',title:'Trend Following',author:'Michael Covel',cat:'Risk Management',desc:'How great traders make fortunes in bull, bear, and black swan markets by following trends.',concepts:['Trend following','Drawdown management','Expectancy','Diversification'],status:'wishlist',progress:0,rating:0,notes:''},
  {id:'b12',title:'High Probability Trading',author:'Marcel Link',cat:'Trading Strategy',desc:'Practical advice on filtering trades and improving the odds of winning.',concepts:['Setup filtering','Risk/reward','Trade management','Backtesting'],status:'read',progress:80,rating:3,notes:''},
];

const LP_DEFAULT_SITES = [
  {id:'s1',name:'TradingView',url:'https://www.tradingview.com',cat:'Charting',icon:'📈',desc:'World-class charting platform with 100+ indicators, Pine Script, alerts, and a large community of shared ideas.',tags:['charting','free','real-time','alerts','Pine Script']},
  {id:'s2',name:'Screener.in',url:'https://www.screener.in',cat:'Screener',icon:'🔍',desc:'Best fundamental screener for Indian stocks — financials, ratios, historical data and custom queries.',tags:['India','NSE','BSE','fundamentals','free']},
  {id:'s3',name:'Chartink',url:'https://chartink.com',cat:'Screener',icon:'🎯',desc:'Real-time technical screener for NSE & BSE. Create custom scan conditions and get alerts on breakouts.',tags:['India','NSE','technical','scanner','alerts']},
  {id:'s4',name:'Moneycontrol',url:'https://www.moneycontrol.com',cat:'News',icon:'📰',desc:'Leading Indian financial news, market data, portfolio tracking and corporate actions.',tags:['India','news','portfolio','data']},
  {id:'s5',name:'Investopedia',url:'https://www.investopedia.com',cat:'Education',icon:'🎓',desc:'The gold standard for financial education. Concepts, glossary, simulator and tutorials for all levels.',tags:['education','concepts','free','simulator']},
  {id:'s6',name:'Finviz',url:'https://finviz.com',cat:'Screener',icon:'🗺',desc:'Powerful US stock screener with heatmaps, futures, forex and comprehensive fundamental + technical filters.',tags:['US','screener','heatmap','free']},
  {id:'s7',name:'Macrotrends',url:'https://www.macrotrends.net',cat:'Data',icon:'📊',desc:'Long-term historical data on stocks, economic indicators, interest rates, commodities and currencies.',tags:['historical data','macro','charts','free']},
  {id:'s8',name:'NSE India',url:'https://www.nseindia.com',cat:'Data',icon:'🏛',desc:'Official NSE website for live data, FII/DII activity, option chain, and all corporate filings.',tags:['India','NSE','official','option chain','FII']},
  {id:'s9',name:'Sensibull',url:'https://sensibull.com',cat:'Tools',icon:'⚙️',desc:'Options strategy builder and analytics platform built specifically for Indian markets.',tags:['India','options','strategy','NSE']},
  {id:'s10',name:'Varsity by Zerodha',url:'https://zerodha.com/varsity/',cat:'Education',icon:'📖',desc:'Free, comprehensive stock market education in plain English. Covers technical, fundamental, F&O and more.',tags:['India','education','free','beginner','Zerodha']},
  {id:'s11',name:'FRED Economic Data',url:'https://fred.stlouisfed.org',cat:'Data',icon:'🏦',desc:'St. Louis Fed database with 800,000+ economic time series. Essential for macro analysis.',tags:['macro','US','Fed','historical data','free']},
  {id:'s12',name:'Earnings Whispers',url:'https://www.earningswhispers.com',cat:'Data',icon:'📅',desc:'Earnings calendar with whisper numbers, surprises history and pre-market reporting schedule.',tags:['US','earnings','calendar','free']},
];

const LP_DEFAULT_MENTORS = [
  {id:'m1',name:'Mark Douglas',title:'Trading Psychologist · Author',cat:'Psychologist',avatar:'🧠',bio:'Author of Trading in the Zone and The Disciplined Trader. The most influential figure in trading psychology. Taught that consistency comes from mindset, not methodology.',known:['Probabilistic mindset','Emotional neutrality','Consistency principle','Mental framework'],twitter:'',other:[]},
  {id:'m2',name:'Mark Minervini',title:'US Investing Champion · Swing Trader',cat:'Trader',avatar:'⚡',bio:'2x US Investing Champion with a 10-year average return of 220% annually. Creator of the SEPA (Specific Entry Point Analysis) methodology for growth stocks.',known:['SEPA strategy','VCP pattern','Risk management','Growth stock selection'],twitter:'@markminervini',other:['minervini.com']},
  {id:'m3',name:'Jesse Livermore',title:'The Greatest Speculator · 1877–1940',cat:'Trader',avatar:'👑',bio:'Made $100M shorting the 1929 crash. Pioneered trend following, position sizing, and reading the tape. His lessons in Reminiscences remain as valid today as ever.',known:['Trend following','Pivotal points','Position sizing','Market psychology'],twitter:'',other:[]},
  {id:'m4',name:'Paul Tudor Jones',title:'Macro Hedge Fund Manager',cat:'Trader',avatar:'🎯',bio:'Founder of Tudor Investment Corp. Predicted and profited massively from the 1987 crash. Known for strict risk control — never risks more than 2% per trade.',known:['Macro trading','Risk management','Trend reversal','Discipline'],twitter:'',other:[]},
  {id:'m5',name:'Stan Weinstein',title:'Market Analyst · Stage Analysis Creator',cat:'Analyst',avatar:'📊',bio:'Creator of the 4-Stage market cycle model. His book Secrets for Profiting in Bull and Bear Markets gives a timeless framework for when to buy and sell.',known:['Stage analysis','150-day MA','Volume','Relative strength'],twitter:'',other:[]},
  {id:'m6',name:'Warren Buffett',title:'Chairman, Berkshire Hathaway',cat:'Investor',avatar:'🏦',bio:'The greatest investor of all time. Built Berkshire Hathaway from a failing textile mill into a $900B conglomerate through value investing and long-term compounding.',known:['Value investing','Moat','Circle of competence','Compounding'],twitter:'',other:['berkshirehathaway.com']},
  {id:'m7',name:'Linda Bradford Raschke',title:'Professional Trader · CTA',cat:'Trader',avatar:'🌊',bio:'One of the most respected professional traders of her generation. Featured in Market Wizards. Known for short-term swing trading and market microstructure.',known:['Swing trading','Market microstructure','Discipline','Short-term patterns'],twitter:'@LBRGroup',other:['lbrgroup.com']},
  {id:'m8',name:'Ray Dalio',title:'Founder, Bridgewater Associates',cat:'Investor',avatar:'🌍',bio:'Founder of the world\'s largest hedge fund. Creator of the All Weather portfolio and Principles — a framework for radical transparency and systematic decision making.',known:['Macro cycles','All Weather','Diversification','Radical transparency'],twitter:'@RayDalio',other:['principles.com']},
  {id:'m9',name:'William J. O\'Neil',title:'Founder, Investor\'s Business Daily',cat:'Trader',avatar:'📈',bio:'Created the CANSLIM methodology for identifying leading growth stocks. Founder of IBD. Studied every major market winner from 1880 to present day.',known:['CANSLIM','Cup with handle','Market timing','Growth investing'],twitter:'',other:['investors.com']},
  {id:'m10',name:'Dr. Alexander Elder',title:'Psychiatrist · Trader · Author',cat:'Psychologist',avatar:'🔬',bio:'Psychiatrist turned trader. Author of Trading for a Living. Developed the Triple Screen trading system and the Impulse system using EMA and MACD.',known:['Triple Screen','Impulse system','Risk management','Psychology'],twitter:'',other:['elder.com']},
];

/* ── Init default data if empty ── */
if (!lpBooks)    { lpBooks    = LP_DEFAULT_BOOKS;    lss('zj4_lp_books',    lpBooks); }
if (!lpSites)    { lpSites    = LP_DEFAULT_SITES;    lss('zj4_lp_sites',    lpSites); }
if (!lpMentors)  { lpMentors  = LP_DEFAULT_MENTORS;  lss('zj4_lp_mentors',  lpMentors); }

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   LEARNING PORTAL — Core
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
/* renderLearning defined at top of JS — canonical version calls lrn* system */

function lpTab(id, btn) {
  document.querySelectorAll('.lp-tab').forEach(b=>b.classList.remove('on'));
  document.querySelectorAll('.lp-pane').forEach(p=>p.classList.remove('on'));
  if(btn) btn.classList.add('on');
  $('lp-pane-'+id).classList.add('on');
  if(id==='books') lpRenderBooks();
  if(id==='websites') lpRenderSites();
  if(id==='mentors') lpRenderMentors();
  if(id==='mylearnings'){ lpRenderLearnings(); lpRenderLearningStats(); }
}

/* ── Spine colour per category ── */
const LP_SPINE = {
  'Trading Psychology':'#f87171','Technical Analysis':'#22d3ee','Risk Management':'#4ade80',
  'Fundamental Analysis':'#6366f1','Investing':'#d4a847','Macroeconomics':'#f0c96a',
  'Biographies':'#a78bfa','Mindset & Performance':'#fb923c','Trading Strategy':'#34d399','Other':'#5a5a78'
};
const LP_SITE_COLORS = {
  'Charting':'rgba(34,211,238,0.12)','Screener':'rgba(74,222,128,0.12)',
  'News':'rgba(212,168,71,0.12)','Education':'rgba(99,102,241,0.12)',
  'Data':'rgba(248,113,113,0.12)','Broker':'rgba(163,230,53,0.12)',
  'Community':'rgba(251,146,60,0.12)','Tools':'rgba(240,201,106,0.12)','Other':'rgba(90,90,120,0.12)'
};
const LP_MENTOR_COLORS = {
  'Trader':'rgba(248,113,113,0.1)','Investor':'rgba(212,168,71,0.1)',
  'Psychologist':'rgba(34,211,238,0.1)','Analyst':'rgba(99,102,241,0.1)',
  'Educator':'rgba(74,222,128,0.1)','Other':'rgba(90,90,120,0.1)'
};

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   BOOKS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
function lpBookFilter(btn) {
  document.querySelectorAll('[data-bf]').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  _lpBookFilter = btn.dataset.bf;
  lpRenderBooks();
}
function lpRenderBooks() {
  const grid = $('lp-books-grid');
  if (!grid) return;
  const q = ($('lp-book-search')||{value:''}).value.toLowerCase();
  let list = lpBooks.filter(b => {
    if (_lpBookFilter !== 'all' && b.status !== _lpBookFilter) return false;
    if (q && !b.title.toLowerCase().includes(q) && !b.author.toLowerCase().includes(q) && !(b.concepts||[]).join(' ').toLowerCase().includes(q)) return false;
    return true;
  });
  if (!list.length) { grid.innerHTML = '<div class="lp-empty" style="grid-column:1/-1"><div class="lp-empty-icon">📚</div><div class="lp-empty-text">No books found.<br>Add your first book to build your library.</div></div>'; return; }
  grid.innerHTML = list.map(b => {
    const spine = LP_SPINE[b.cat] || '#5a5a78';
    const stars = [1,2,3,4,5].map(n=>`<span class="lp-book-star ${n<=(b.rating||0)?'on':''}" style="color:var(--amber2)">★</span>`).join('');
    const statusLabel = {reading:'Reading',read:'Read ✓',wishlist:'Wishlist',paused:'Paused'}[b.status]||b.status;
    const concepts = (b.concepts||[]).map(c=>`<span class="lp-concept-tag">${esc(c)}</span>`).join('');
    const fillColor = b.progress===100?'var(--green)':b.progress>0?'var(--amber)':'var(--ghost)';
    const bookIcon = {'Trading Psychology':'🧠','Technical Analysis':'📈','Risk Management':'⚖️','Fundamental Analysis':'🔍','Investing':'💼','Macroeconomics':'🌍','Biographies':'👤','Mindset & Performance':'🎯','Trading Strategy':'⚡','Other':'📘'}[b.cat]||'📘';
    return `<div class="lp-book">
      <div class="lp-book-spine" style="background:${spine}"></div>
      <div class="lp-book-body">
        <div class="lp-book-header">
          <div class="lp-book-icon">${bookIcon}</div>
          <div class="lp-book-meta">
            <div class="lp-book-title">${esc(b.title)}</div>
            <div class="lp-book-author">${esc(b.author)}</div>
          </div>
          <div class="lp-book-actions">
            <button class="lp-book-action" onclick="lpEditBook('${b.id}')" title="Edit">✎</button>
            <button class="lp-book-action del" onclick="lpDeleteBook('${b.id}')" title="Delete">✕</button>
          </div>
        </div>
        <span class="lp-book-cat">${esc(b.cat)}</span>
        <div class="lp-book-desc">${esc(b.desc||'')}</div>
        ${concepts ? `<div class="lp-book-concepts">${concepts}</div>` : ''}
        ${b.progress > 0 || b.status === 'reading' ? `
        <div class="lp-book-progress">
          <div class="lp-progress-label"><span>Progress</span><span>${b.progress}%</span></div>
          <div class="lp-progress-bar"><div class="lp-progress-fill" style="width:${b.progress}%;background:${fillColor}"></div></div>
        </div>` : ''}
        <div class="lp-book-footer">
          <div class="lp-book-rating">${stars}</div>
          <span class="lp-book-status ${b.status}">${statusLabel}</span>
        </div>
        ${b.notes ? `<div style="margin-top:10px;padding-top:9px;border-top:1px solid var(--rule);font-size:10px;color:var(--dim);font-style:italic;line-height:1.6">"${esc(b.notes)}"</div>` : ''}
      </div>
    </div>`;
  }).join('');
}

function lpOpenBookModal(prefill) {
  _bmEditId = null; _bmStar = 0;
  $('lp-bm-title').textContent = 'Add Book';
  ['bm-title','bm-author','bm-desc','bm-concepts','bm-notes'].forEach(id=>{ const el=$(id); if(el) el.value=''; });
  $('bm-status').value='wishlist';
  $('bm-progress').value=0; $('bm-progress-val').textContent='0%';
  $('bm-edit-id').value='';
  document.querySelectorAll('#bm-stars-row .lp-book-star').forEach(s=>s.classList.remove('on'));
  $('lp-book-modal').style.display='flex';
}
function lpEditBook(id) {
  const b = lpBooks.find(x=>x.id===id);
  if (!b) return;
  _bmEditId = id; _bmStar = b.rating||0;
  $('lp-bm-title').textContent = 'Edit Book';
  $('bm-title').value = b.title||'';
  $('bm-author').value = b.author||'';
  $('bm-cat').value = b.cat||'Other';
  $('bm-desc').value = b.desc||'';
  $('bm-concepts').value = (b.concepts||[]).join(', ');
  $('bm-status').value = b.status||'wishlist';
  $('bm-progress').value = b.progress||0;
  $('bm-progress-val').textContent = (b.progress||0)+'%';
  $('bm-notes').value = b.notes||'';
  $('bm-edit-id').value = id;
  document.querySelectorAll('#bm-stars-row .lp-book-star').forEach((s,i)=>s.classList.toggle('on',i<_bmStar));
  $('lp-book-modal').style.display='flex';
}
function bmSetStar(n) {
  _bmStar = _bmStar===n?0:n;
  document.querySelectorAll('#bm-stars-row .lp-book-star').forEach((s,i)=>s.classList.toggle('on',i<_bmStar));
}
function lpSaveBook() {
  const title = ($('bm-title').value||'').trim();
  if (!title) { toast('Title required'); return; }
  const book = {
    id: _bmEditId || ('b'+Date.now()),
    title, author: $('bm-author').value||'',
    cat: $('bm-cat').value,
    desc: $('bm-desc').value||'',
    concepts: ($('bm-concepts').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    status: $('bm-status').value,
    progress: parseInt($('bm-progress').value)||0,
    rating: _bmStar,
    notes: $('bm-notes').value||'',
  };
  if (_bmEditId) { const idx=lpBooks.findIndex(b=>b.id===_bmEditId); if(idx>=0) lpBooks[idx]=book; }
  else lpBooks.unshift(book);
  lss('zj4_lp_books', lpBooks);
  lpCloseModal('lp-book-modal');
  lpRenderBooks();
  toast('Book saved ✓');
}
function lpDeleteBook(id) {
  lpBooks = lpBooks.filter(b=>b.id!==id);
  lss('zj4_lp_books', lpBooks);
  lpRenderBooks();
  toast('Removed');
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   WEBSITES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
function lpSiteFilter(btn) {
  document.querySelectorAll('[data-sf]').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  _lpSiteFilter = btn.dataset.sf;
  lpRenderSites();
}
function lpRenderSites() {
  const grid = $('lp-sites-grid');
  if (!grid) return;
  const q = ($('lp-site-search')||{value:''}).value.toLowerCase();
  let list = lpSites.filter(s => {
    if (_lpSiteFilter !== 'all' && s.cat !== _lpSiteFilter) return false;
    if (q && !s.name.toLowerCase().includes(q) && !s.desc.toLowerCase().includes(q) && !(s.tags||[]).join(' ').toLowerCase().includes(q)) return false;
    return true;
  });
  if (!list.length) { grid.innerHTML='<div class="lp-empty" style="grid-column:1/-1"><div class="lp-empty-icon">🌐</div><div class="lp-empty-text">No resources found.</div></div>'; return; }
  grid.innerHTML = list.map(s => {
    const catColor = LP_SITE_COLORS[s.cat] || 'rgba(90,90,120,0.12)';
    const tags = (s.tags||[]).map(t=>`<span class="lp-site-tag">${esc(t)}</span>`).join('');
    return `<div class="lp-site">
      <div class="lp-site-top">
        <div class="lp-site-favicon" style="background:${catColor}">${s.icon||'🌐'}</div>
        <div class="lp-site-info">
          <div class="lp-site-name">${esc(s.name)}</div>
          <a class="lp-site-url" href="${esc(s.url)}" target="_blank" onclick="event.stopPropagation()">${esc((s.url||'').replace(/^https?:\/\//,'').replace(/\/$/,''))}</a>
        </div>
        <div style="display:flex;gap:4px;margin-left:auto;flex-shrink:0">
          <a href="${esc(s.url)}" target="_blank" style="text-decoration:none"><button class="lp-book-action" title="Visit" onclick="event.stopPropagation()">↗</button></a>
          <button class="lp-book-action" onclick="lpEditSite('${s.id}')" title="Edit">✎</button>
          <button class="lp-book-action del" onclick="lpDeleteSite('${s.id}')" title="Delete">✕</button>
        </div>
      </div>
      <span class="lp-site-cat-tag" style="background:${catColor};color:var(--text)">${esc(s.cat)}</span>
      <div class="lp-site-desc">${esc(s.desc||'')}</div>
      ${tags ? `<div class="lp-site-tags">${tags}</div>` : ''}
    </div>`;
  }).join('');
}
function lpOpenSiteModal() {
  _smEditId = null;
  $('lp-sm-title').textContent='Add Website';
  ['sm-name','sm-url','sm-icon','sm-desc','sm-tags'].forEach(id=>{ const el=$(id); if(el) el.value=''; });
  $('sm-edit-id').value='';
  $('lp-site-modal').style.display='flex';
}
function lpEditSite(id) {
  const s = lpSites.find(x=>x.id===id);
  if (!s) return;
  _smEditId = id;
  $('lp-sm-title').textContent='Edit Website';
  $('sm-name').value=s.name||''; $('sm-url').value=s.url||'';
  $('sm-cat').value=s.cat||'Other'; $('sm-icon').value=s.icon||'';
  $('sm-desc').value=s.desc||''; $('sm-tags').value=(s.tags||[]).join(', ');
  $('sm-edit-id').value=id;
  $('lp-site-modal').style.display='flex';
}
function lpSaveSite() {
  const name = ($('sm-name').value||'').trim();
  if (!name) { toast('Name required'); return; }
  const site = {
    id: _smEditId || ('s'+Date.now()),
    name, url: $('sm-url').value||'#',
    cat: $('sm-cat').value,
    icon: $('sm-icon').value||'🌐',
    desc: $('sm-desc').value||'',
    tags: ($('sm-tags').value||'').split(',').map(s=>s.trim()).filter(Boolean),
  };
  if (_smEditId) { const idx=lpSites.findIndex(s=>s.id===_smEditId); if(idx>=0) lpSites[idx]=site; }
  else lpSites.unshift(site);
  lss('zj4_lp_sites', lpSites);
  lpCloseModal('lp-site-modal');
  lpRenderSites();
  toast('Site saved ✓');
}
function lpDeleteSite(id) {
  lpSites = lpSites.filter(s=>s.id!==id);
  lss('zj4_lp_sites', lpSites);
  lpRenderSites();
  toast('Removed');
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   MENTORS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
function lpMentorFilter(btn) {
  document.querySelectorAll('[data-mf]').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  _lpMentorFilter = btn.dataset.mf;
  lpRenderMentors();
}
function lpRenderMentors() {
  const grid = $('lp-mentors-grid');
  if (!grid) return;
  const q = ($('lp-mentor-search')||{value:''}).value.toLowerCase();
  let list = lpMentors.filter(m => {
    if (_lpMentorFilter !== 'all' && m.cat !== _lpMentorFilter) return false;
    if (q && !m.name.toLowerCase().includes(q) && !(m.known||[]).join(' ').toLowerCase().includes(q)) return false;
    return true;
  });
  if (!list.length) { grid.innerHTML='<div class="lp-empty" style="grid-column:1/-1"><div class="lp-empty-icon">🎓</div><div class="lp-empty-text">No mentors found.</div></div>'; return; }
  grid.innerHTML = list.map(m => {
    const catBg = LP_MENTOR_COLORS[m.cat] || 'rgba(90,90,120,0.1)';
    const known = (m.known||[]).map(k=>`<span class="lp-mentor-tag">${esc(k)}</span>`).join('');
    const handles = [];
    if (m.twitter) handles.push(`<a class="lp-mentor-handle" href="https://twitter.com/${m.twitter.replace('@','')}" target="_blank">𝕏 ${esc(m.twitter)}</a>`);
    (m.other||[]).filter(Boolean).forEach(h => handles.push(`<a class="lp-mentor-handle" href="${h.startsWith('http')?h:'https://'+h}" target="_blank">↗ ${esc(h.replace(/^https?:\/\//,''))}</a>`));
    return `<div class="lp-mentor">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
        <span class="lp-mentor-category" style="background:${catBg};color:var(--text)">${esc(m.cat)}</span>
        <div style="display:flex;gap:4px">
          <button class="lp-book-action" onclick="lpEditMentor('${m.id}')" title="Edit">✎</button>
          <button class="lp-book-action del" onclick="lpDeleteMentor('${m.id}')" title="Delete">✕</button>
        </div>
      </div>
      <div class="lp-mentor-top">
        <div class="lp-mentor-avatar" style="background:${catBg}">${m.avatar||m.name.charAt(0)}</div>
        <div class="lp-mentor-info">
          <div class="lp-mentor-name">${esc(m.name)}</div>
          <div class="lp-mentor-title">${esc(m.title||'')}</div>
          ${handles.length ? `<div class="lp-mentor-handles">${handles.join('')}</div>` : ''}
        </div>
      </div>
      <div class="lp-mentor-bio">${esc(m.bio||'')}</div>
      ${known ? `<div class="lp-mentor-known"><div class="lp-mentor-known-head">Known for</div><div class="lp-mentor-tags">${known}</div></div>` : ''}
    </div>`;
  }).join('');
}
function lpOpenMentorModal() {
  _mmEditId = null;
  $('lp-mm-title').textContent='Add Mentor';
  ['mm-name','mm-title','mm-avatar','mm-bio','mm-known','mm-twitter','mm-other'].forEach(id=>{ const el=$(id); if(el) el.value=''; });
  $('mm-edit-id').value='';
  $('lp-mentor-modal').style.display='flex';
}
function lpEditMentor(id) {
  const m = lpMentors.find(x=>x.id===id);
  if (!m) return;
  _mmEditId = id;
  $('lp-mm-title').textContent='Edit Mentor';
  $('mm-name').value=m.name||''; $('mm-title').value=m.title||'';
  $('mm-cat').value=m.cat||'Trader'; $('mm-avatar').value=m.avatar||'';
  $('mm-bio').value=m.bio||''; $('mm-known').value=(m.known||[]).join(', ');
  $('mm-twitter').value=m.twitter||''; $('mm-other').value=(m.other||[]).join(', ');
  $('mm-edit-id').value=id;
  $('lp-mentor-modal').style.display='flex';
}
function lpSaveMentor() {
  const name = ($('mm-name').value||'').trim();
  if (!name) { toast('Name required'); return; }
  const mentor = {
    id: _mmEditId || ('m'+Date.now()),
    name, title: $('mm-title').value||'',
    cat: $('mm-cat').value,
    avatar: $('mm-avatar').value||name.charAt(0),
    bio: $('mm-bio').value||'',
    known: ($('mm-known').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    twitter: $('mm-twitter').value||'',
    other: ($('mm-other').value||'').split(',').map(s=>s.trim()).filter(Boolean),
  };
  if (_mmEditId) { const idx=lpMentors.findIndex(m=>m.id===_mmEditId); if(idx>=0) lpMentors[idx]=mentor; }
  else lpMentors.unshift(mentor);
  lss('zj4_lp_mentors', lpMentors);
  lpCloseModal('lp-mentor-modal');
  lpRenderMentors();
  toast('Mentor saved ✓');
}
function lpDeleteMentor(id) {
  lpMentors = lpMentors.filter(m=>m.id!==id);
  lss('zj4_lp_mentors', lpMentors);
  lpRenderMentors();
  toast('Removed');
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   MY LEARNINGS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
function lpSetImp(btn) {
  document.querySelectorAll('.lp-imp-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  _lpImp = btn.dataset.imp;
}
function lpTagKey(e) {
  if (e.key==='Enter'||e.key===',') {
    e.preventDefault();
    const val = e.target.value.replace(',','').trim();
    if (val && !_lpTags.includes(val)) { _lpTags.push(val); lpRenderTagRow(); }
    e.target.value='';
  }
  if (e.key==='Backspace' && !e.target.value && _lpTags.length) {
    _lpTags.pop(); lpRenderTagRow();
  }
}
function lpRemoveTag(i) { _lpTags.splice(i,1); lpRenderTagRow(); }
function lpRenderTagRow() {
  const row = $('ll-tag-row');
  const bare = $('ll-tag-bare');
  if (!row||!bare) return;
  const tags = _lpTags.map((t,i)=>`<span class="lp-typed-tag">${esc(t)}<button onclick="lpRemoveTag(${i})">×</button></span>`).join('');
  row.innerHTML = tags + `<input class="lp-tag-bare" id="ll-tag-bare" placeholder="${_lpTags.length?'':' add tag…'}" onkeydown="lpTagKey(event)">`;
  $('ll-tag-bare').focus();
}
function lpSaveLearning() {
  const title = ($('ll-title').value||'').trim();
  if (!title) { toast('Title required'); return; }
  const item = {
    id: 'll'+Date.now(),
    title,
    source: $('ll-source').value||'',
    category: $('ll-category').value||'Other',
    notes: $('ll-notes').value||'',
    apply: $('ll-apply').value||'',
    importance: _lpImp,
    tags: [..._lpTags],
    date: new Date().toISOString().slice(0,10),
  };
  lpLearnings.unshift(item);
  lss('zj4_lp_ll', lpLearnings);
  // reset form
  ['ll-title','ll-source','ll-notes','ll-apply'].forEach(id=>{ const el=$(id); if(el) el.value=''; });
  _lpTags=[]; lpRenderTagRow();
  _lpImp='high';
  document.querySelectorAll('.lp-imp-btn').forEach(b=>b.classList.remove('on'));
  const high=document.querySelector('.lp-imp-btn[data-imp="high"]');
  if(high) high.classList.add('on');
  lpRenderLearnings();
  lpRenderLearningStats();
  toast('Learning saved ✓');
}
function lpLearningFilter(btn) {
  document.querySelectorAll('[data-lf]').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  _lpLearningFilter = btn.dataset.lf;
  lpRenderLearnings();
}
function lpRenderLearnings() {
  const el = $('lp-learnings-list');
  if (!el) return;
  const q = ($('lp-ll-search')||{value:''}).value.toLowerCase();
  let list = lpLearnings.filter(l => {
    if (_lpLearningFilter !== 'all' && l.importance !== _lpLearningFilter) return false;
    if (q && !l.title.toLowerCase().includes(q) && !(l.notes||'').toLowerCase().includes(q) && !(l.source||'').toLowerCase().includes(q)) return false;
    return true;
  });
  const cnt = $('ll-count-label');
  if (cnt) cnt.textContent = lpLearnings.length + ' total learning' + (lpLearnings.length===1?'':'s');
  if (!list.length) { el.innerHTML='<div class="lp-empty"><div class="lp-empty-icon">✍</div><div class="lp-empty-text">No learnings yet.<br>Log your first insight above.</div></div>'; return; }
  const srcIcon = s => { if(!s)return'📝'; s=s.toLowerCase(); if(s.includes('book'))return'📚'; if(s.includes('video')||s.includes('youtube'))return'🎬'; if(s.includes('mentor'))return'🎓'; if(s.includes('trade')||s.includes('journal'))return'📊'; return'💡'; };
  el.innerHTML = list.map(l => {
    const impCls = l.importance||'medium';
    const impLabel = {high:'🔴 High',medium:'🟡 Medium',low:'🟢 Low'}[l.importance]||l.importance;
    const tags = (l.tags||[]).map(t=>`<span class="lp-li-tag">${esc(t)}</span>`).join('');
    return `<div class="lp-learning-item">
      <div class="lp-li-top">
        <div class="lp-li-source">
          <span class="lp-li-source-icon">${srcIcon(l.source)}</span>
          <span class="lp-li-source-name">${esc(l.source||'Personal insight')}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="lp-li-date">${l.date||''}</span>
          <div class="lp-li-actions">
            <button class="lp-li-action del" onclick="lpDeleteLearning('${l.id}')" title="Delete">✕</button>
          </div>
        </div>
      </div>
      <div class="lp-li-title">${esc(l.title)}</div>
      ${l.notes ? `<div class="lp-li-body">${esc(l.notes)}</div>` : ''}
      ${l.apply ? `<div style="background:rgba(212,168,71,0.05);border-left:2px solid rgba(212,168,71,0.3);padding:7px 10px;margin-bottom:8px;font-size:10px;color:var(--amber2);line-height:1.6"><strong>Apply:</strong> ${esc(l.apply)}</div>` : ''}
      <div class="lp-li-footer">
        <span class="lp-li-imp ${impCls}">${impLabel}</span>
        <span class="lp-li-category">${esc(l.category||'')}</span>
        ${tags}
      </div>
    </div>`;
  }).join('');
}
function lpDeleteLearning(id) {
  lpLearnings = lpLearnings.filter(l=>l.id!==id);
  lss('zj4_lp_ll', lpLearnings);
  lpRenderLearnings(); lpRenderLearningStats();
  toast('Removed');
}

function lpRenderLearningStats() {
  const statsEl = $('lp-ll-stats');
  const catsEl  = $('lp-ll-cats');
  const recEl   = $('lp-ll-recent');
  if (!statsEl) return;
  const total = lpLearnings.length;
  const high  = lpLearnings.filter(l=>l.importance==='high').length;
  const cats  = {};
  lpLearnings.forEach(l=>{ cats[l.category||'Other']=(cats[l.category||'Other']||0)+1; });
  const topCats = Object.entries(cats).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const maxCat = topCats.length ? topCats[0][1] : 1;
  statsEl.innerHTML = `
    <div class="lp-stat-cell"><div class="lp-stat-n a">${total}</div><div class="lp-stat-l">Total</div></div>
    <div class="lp-stat-cell"><div class="lp-stat-n" style="color:var(--red)">${high}</div><div class="lp-stat-l">High Priority</div></div>
    <div class="lp-stat-cell"><div class="lp-stat-n c">${Object.keys(cats).length}</div><div class="lp-stat-l">Categories</div></div>
    <div class="lp-stat-cell"><div class="lp-stat-n g">${lpLearnings.filter(l=>l.apply&&l.apply.trim()).length}</div><div class="lp-stat-l">With Action</div></div>`;
  if (catsEl) catsEl.innerHTML = topCats.length ? topCats.map(([cat,n])=>`
    <div style="margin-bottom:9px">
      <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:4px"><span style="color:var(--text)">${esc(cat)}</span><span style="color:var(--dim)">${n}</span></div>
      <div style="height:3px;background:var(--ghost);border-radius:2px;overflow:hidden"><div style="height:100%;width:${Math.round(n/maxCat*100)}%;background:var(--amber);border-radius:2px;transition:width 0.5s var(--ease)"></div></div>
    </div>`).join('') : '<div style="color:var(--dim);font-size:10px">No data yet.</div>';
  if (recEl) {
    const recent = lpLearnings.filter(l=>l.importance==='high').slice(0,5);
    recEl.innerHTML = recent.length ? recent.map(l=>`
      <div style="padding:8px 0;border-bottom:1px solid var(--rule)">
        <div style="font-size:10px;color:var(--text);margin-bottom:2px;line-height:1.4">${esc(l.title)}</div>
        <div style="font-size:9px;color:var(--dim)">${esc(l.source||'—')} · ${l.date||''}</div>
      </div>`).join('') : '<div style="color:var(--dim);font-size:10px">No high-priority learnings yet.</div>';
  }
}

/* ── Shared modal util ── */
function lpCloseModal(id) { $(id).style.display='none'; }

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   LEARNING
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
function saveLrnData() { lss('zj4_lrn', lrnData); }
function lrnId() { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

let _bmRating = 0;
let _bkEditId = null, _menEditId = null, _resEditId = null, _lrnEditId = null;

/* Book colours per genre */
const BOOK_COLORS = {
  Trading:          'rgba(212,168,71,0.15)',
  Investing:        'rgba(74,222,128,0.12)',
  Psychology:       'rgba(99,102,241,0.15)',
  Macro:            'rgba(34,211,238,0.12)',
  Biography:        'rgba(248,113,113,0.12)',
  Finance:          'rgba(248,113,113,0.10)',
  Philosophy:       'rgba(212,168,71,0.10)',
  Sales:            'rgba(34,211,238,0.10)',
  Negotiation:      'rgba(74,222,128,0.10)',
  'Human Behaviour':'rgba(99,102,241,0.10)',
  Money:            'rgba(212,168,71,0.18)',
  Quantitative:     'rgba(34,211,238,0.14)',
  Other:            'rgba(255,255,255,0.06)',
};
const BOOK_EMOJIS = {
  Trading:'📈', Investing:'💼', Psychology:'🧠', Macro:'🌍', Biography:'👤',
  Finance:'🏦', Philosophy:'⚖️', Sales:'🤝', Negotiation:'🕊️',
  'Human Behaviour':'🧬', Money:'💰', Quantitative:'🔬', Other:'📖'
};

/* renderLearning canonical definition is at the top of the script block */

function updateLrnCounts() { /* counts synced via lrnRenderLearnings */ }

/* ── Default data ── */
(function seedLrnDefaults() {
  if (!lrnData.books.length) {
    lrnData.books = [
      /* ── TRADING ── */
      { id:lrnId(), title:'Market Wizards', author:'Jack D. Schwager', genre:'Trading', status:'done', rating:5, insight:'The best traders share one trait: they cut losses fast and let winners run without exception. Discipline beats intelligence every time.', notes:'Essential reading. Interview-based. Read annually.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Trading in the Zone', author:'Mark Douglas', genre:'Trading', status:'done', rating:5, insight:'A trade\'s outcome is always uncertain. Accepting this truth completely transforms how you manage risk and your own emotions.', notes:'The single most important book for a trader\'s psychology.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Reminiscences of a Stock Operator', author:'Edwin Lefèvre', genre:'Trading', status:'done', rating:5, insight:'The big money is made in the big swing. Sit tight and do not over-trade. The tape tells the story if you listen.', notes:'Jesse Livermore\'s biography disguised as fiction. Timeless.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'How to Make Money in Stocks', author:'William O\'Neil', genre:'Trading', status:'done', rating:5, insight:'Cut every loss at 7–8% with no exceptions. Follow the CAN SLIM system and buy only stocks in a confirmed uptrend with institutional backing.', notes:'CAN SLIM methodology. Study the chart patterns appendix deeply.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'The New Market Wizards', author:'Jack D. Schwager', genre:'Trading', status:'reading', rating:5, insight:'Every elite trader has a clearly defined edge and the discipline to execute it repeatedly regardless of recent outcomes.', notes:'Companion to Market Wizards. Bill Lipschutz and Stanley Druckenmiller chapters are gold.', added: new Date().toISOString().slice(0,10) },

      /* ── INVESTING ── */
      { id:lrnId(), title:'The Intelligent Investor', author:'Benjamin Graham', genre:'Investing', status:'done', rating:5, insight:'Margin of safety is the central concept of all investing. Never overpay, even for a great business. Mr. Market is your servant, not your guide.', notes:'Read the commentary by Jason Zweig alongside the original text.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'One Up On Wall Street', author:'Peter Lynch', genre:'Investing', status:'done', rating:5, insight:'Invest in what you know. The best investment ideas are hiding in your daily life. An amateur investor has a huge edge over Wall Street.', notes:'Lynch\'s 10-bagger framework is practical and replicable.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'The Little Book of Common Sense Investing', author:'John C. Bogle', genre:'Investing', status:'done', rating:4, insight:'In investing, you get what you don\'t pay for. Costs compound against you just as returns compound for you. Own the index.', notes:'Vanguard founder\'s definitive case for passive indexing.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Common Stocks and Uncommon Profits', author:'Philip Fisher', genre:'Investing', status:'done', rating:5, insight:'The best time to sell a wonderful company is almost never. Use the 15-point scuttlebutt method to find great businesses before the crowd.', notes:'Buffett called Fisher a major influence. Chapter on when to sell is essential.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Security Analysis', author:'Benjamin Graham & David Dodd', genre:'Investing', status:'want', rating:0, insight:'', notes:'The bible of value investing. Read alongside The Intelligent Investor.', added: new Date().toISOString().slice(0,10) },

      /* ── FINANCE ── */
      { id:lrnId(), title:'The Big Short', author:'Michael Lewis', genre:'Finance', status:'done', rating:5, insight:'The financial system is far more fragile and opaque than it appears. A few contrarian thinkers with conviction can profit from collective delusion.', notes:'Best narrative account of the 2008 crisis.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Flash Boys', author:'Michael Lewis', genre:'Finance', status:'done', rating:4, insight:'Markets are rigged by speed and information asymmetry. Understanding microstructure gives you a fundamental edge in execution.', notes:'Eye-opening on HFT and market structure.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'When Genius Failed', author:'Roger Lowenstein', genre:'Finance', status:'done', rating:5, insight:'No model is robust enough to replace risk management. Leverage is the fastest road to ruin, even for the smartest people on Earth.', notes:'LTCM collapse. Required reading on leverage risk.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Liar\'s Poker', author:'Michael Lewis', genre:'Finance', status:'done', rating:4, insight:'Wall Street incentivises short-term risk-taking over long-term value creation. Understanding the culture is essential to navigating it.', notes:'Lewis\'s debut. Still shockingly relevant.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'A Random Walk Down Wall Street', author:'Burton Malkiel', genre:'Finance', status:'done', rating:4, insight:'Most active management underperforms the index after fees. The random walk hypothesis forces you to define your edge with rigorous honesty.', notes:'Essential counterpoint to every trading strategy you will ever develop.', added: new Date().toISOString().slice(0,10) },

      /* ── PSYCHOLOGY ── */
      { id:lrnId(), title:'Thinking, Fast and Slow', author:'Daniel Kahneman', genre:'Psychology', status:'done', rating:5, insight:'System 1 (fast, intuitive) drives most of our decisions and is riddled with biases. Trading demands deliberate System 2 thinking under pressure.', notes:'Chapter on loss aversion is the most important chapter a trader can read.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'The Psychology of Money', author:'Morgan Housel', genre:'Psychology', status:'done', rating:5, insight:'Wealth is what you don\'t spend. Time horizon and humility matter more than intelligence. Surviving long enough to let compounding work is the strategy.', notes:'Most accessible finance psychology book ever written. Read once a year.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Mindset: The New Psychology of Success', author:'Carol S. Dweck', genre:'Psychology', status:'done', rating:4, insight:'A growth mindset treats losses as data and feedback, not identity. The best traders and investors are obsessive learners who never stop updating their models.', notes:'Foundational for developing resilience after drawdowns.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'The Disciplined Trader', author:'Mark Douglas', genre:'Psychology', status:'done', rating:5, insight:'Your beliefs about the market create your results. Inconsistent beliefs create inconsistent results. Mastery begins with mental restructuring.', notes:'Douglas\'s first book. More technical than Trading in the Zone. Read both.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Atomic Habits', author:'James Clear', genre:'Psychology', status:'done', rating:5, insight:'You don\'t rise to your goals; you fall to your systems. Small consistent process improvements compound into extraordinary outcomes.', notes:'Build pre-market routines, journaling habits, and review systems using Clear\'s framework.', added: new Date().toISOString().slice(0,10) },

      /* ── PHILOSOPHY ── */
      { id:lrnId(), title:'Meditations', author:'Marcus Aurelius', genre:'Philosophy', status:'done', rating:5, insight:'You cannot control outcomes, only effort and response. The mark of a great trader is equanimity — reacting with reason, not fear or greed.', notes:'Read daily. Never gets old. The Stoic OS for a trader\'s mind.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'The Obstacle Is the Way', author:'Ryan Holiday', genre:'Philosophy', status:'done', rating:5, insight:'Every loss contains a lesson. Every losing streak is an opportunity for deep study. The practice of trading is the practice of overcoming obstacles.', notes:'Stoicism applied to modern performance. Perfect companion to Meditations.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Antifragile', author:'Nassim Nicholas Taleb', genre:'Philosophy', status:'done', rating:5, insight:'Some systems benefit from volatility. Structure your trading so that tail events cannot kill you and can actually strengthen your edge.', notes:'Taleb\'s magnum opus. The barbell strategy concept alone is worth the price.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'The Black Swan', author:'Nassim Nicholas Taleb', genre:'Philosophy', status:'done', rating:5, insight:'Extreme, rare events dominate history and markets yet are systematically underestimated. Always size for the tail risk you are not modelling.', notes:'Read this before reading Antifragile. Changed how I think about risk permanently.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Fooled by Randomness', author:'Nassim Nicholas Taleb', genre:'Philosophy', status:'done', rating:4, insight:'We chronically confuse luck with skill in financial markets. A robust process matters more than a short track record of wins.', notes:'First in the Taleb trilogy. Start here.', added: new Date().toISOString().slice(0,10) },

      /* ── BIOGRAPHY ── */
      { id:lrnId(), title:'The Man Who Solved the Market', author:'Gregory Zuckerman', genre:'Biography', status:'done', rating:5, insight:'Jim Simons built an edge through data, mathematics, and relentless process. Edge is found, tested, and exploited systematically — not intuitively.', notes:'Biography of Jim Simons and Renaissance Technologies. Extraordinary.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'The Snowball: Warren Buffett and the Business of Life', author:'Alice Schroeder', genre:'Biography', status:'done', rating:5, insight:'Compounding is as much about consistency and temperament as it is about returns. Buffett\'s real edge is patience and rational thinking under irrationality.', notes:'Most comprehensive Buffett biography. Read alongside his annual letters.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Soros: The Life and Times of a Messianic Billionaire', author:'Michael T. Kaufman', genre:'Biography', status:'done', rating:4, insight:'Soros holds his theories tentatively and is willing to be proven wrong quickly. Reflexivity — the feedback loop between perception and reality — drives markets.', notes:'Best biography for understanding macro trading philosophy.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'My Own Story', author:'Bernard Baruch', genre:'Biography', status:'done', rating:5, insight:'Sell before the top. Never act on tips. The crowd is almost always wrong at extremes. Success in speculation requires isolation from mass opinion.', notes:'Baruch\'s memoirs. Written in 1957. Reads like it was written yesterday.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'More Money Than God', author:'Sebastian Mallaby', genre:'Biography', status:'reading', rating:4, insight:'Every great hedge fund manager has a unique, durable, and often contrarian edge. The commonality is obsession with process and brutal risk management.', notes:'History of the hedge fund industry through the lens of its legends.', added: new Date().toISOString().slice(0,10) },

      /* ── SALES ── */
      { id:lrnId(), title:'Influence: The Psychology of Persuasion', author:'Robert Cialdini', genre:'Sales', status:'done', rating:5, insight:'Six universal principles of influence — reciprocity, commitment, social proof, authority, liking, scarcity — govern all human decision-making including in markets.', notes:'Essential for understanding why retail crowds behave as they do.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Never Split the Difference', author:'Chris Voss', genre:'Sales', status:'done', rating:5, insight:'Tactical empathy and mirroring disarm the counterpart. In trading: mirror the market\'s signal before acting against it. Listen before you trade.', notes:'FBI hostage negotiator\'s principles applied to all negotiation and sales.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'How to Win Friends and Influence People', author:'Dale Carnegie', genre:'Sales', status:'done', rating:4, insight:'People make decisions emotionally and justify them logically. Understanding this is the foundation of every sale, negotiation, and market move.', notes:'Foundational. The principles are more relevant today than when written.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'The Psychology of Selling', author:'Brian Tracy', genre:'Sales', status:'done', rating:4, insight:'Top salespeople and top traders share one mindset: they define exactly what they want and take consistent disciplined action towards it every single day.', notes:'Tracy\'s best work. Practical self-concept framework applies to trading performance.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Spin Selling', author:'Neil Rackham', genre:'Sales', status:'want', rating:0, insight:'', notes:'Research-based selling methodology. Best book on high-value, complex sales.', added: new Date().toISOString().slice(0,10) },

      /* ── NEGOTIATION ── */
      { id:lrnId(), title:'Getting to Yes', author:'Roger Fisher & William Ury', genre:'Negotiation', status:'done', rating:5, insight:'Separate the people from the problem. Focus on interests, not positions. Always have a BATNA — your Best Alternative to a Negotiated Agreement.', notes:'The foundational text of principled negotiation. Read before Never Split the Difference.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Negotiation Genius', author:'Deepak Malhotra & Max Bazerman', genre:'Negotiation', status:'done', rating:4, insight:'The most powerful negotiators are those who understand their own biases and systematically correct for them before entering any deal or trade.', notes:'Harvard Business School methodology. Deep and practical.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'You Can Negotiate Anything', author:'Herb Cohen', genre:'Negotiation', status:'done', rating:4, insight:'Everything is negotiable. The party with the most information and the most patience almost always wins. Apply this to trade management.', notes:'Cohen was a master. Simple, witty, and completely practical.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'The Art of the Deal', author:'Donald Trump & Tony Schwartz', genre:'Negotiation', status:'done', rating:3, insight:'Maximize leverage. Think big. Know your market. Whether you agree with the author or not, the deal-making framework here is studied by serious negotiators.', notes:'Read for the frameworks, not the personality.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Crucial Conversations', author:'Kerry Patterson et al.', genre:'Negotiation', status:'want', rating:0, insight:'', notes:'Best book on high-stakes communication under emotional pressure.', added: new Date().toISOString().slice(0,10) },

      /* ── HUMAN BEHAVIOUR ── */
      { id:lrnId(), title:'Predictably Irrational', author:'Dan Ariely', genre:'Human Behaviour', status:'done', rating:5, insight:'Human decision-making is systematically irrational and predictably so. Markets are made of humans. Understanding behavioural economics is an edge.', notes:'The best introduction to behavioural economics. Read before Kahneman.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Behave', author:'Robert Sapolsky', genre:'Human Behaviour', status:'done', rating:5, insight:'Our behaviour is the product of biology, environment, and milliseconds of neural firing. Knowing your stress response physiology helps you manage it in drawdowns.', notes:'Magisterial work on the biology of human behaviour.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'The Crowd: A Study of the Popular Mind', author:'Gustave Le Bon', genre:'Human Behaviour', status:'done', rating:5, insight:'In a crowd, the individual surrenders reason for collective emotion. Markets are crowds. Crowd psychology produces every major bubble and crash in history.', notes:'Written 1895. The single best explanation of market manias ever written.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Irrational Exuberance', author:'Robert Shiller', genre:'Human Behaviour', status:'done', rating:4, insight:'Speculative bubbles are driven by narratives, not fundamentals. Understanding the story driving a market tells you more than any valuation model.', notes:'Shiller called the 2000 and 2007 tops. Chapter on psychological factors is essential.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Misbehaving', author:'Richard Thaler', genre:'Human Behaviour', status:'done', rating:4, insight:'Humans are Econs in textbooks and Humans in reality. The gap between the two is where every trading edge and every trading mistake lives.', notes:'Thaler\'s memoir of the behavioural economics revolution. Fun and insightful.', added: new Date().toISOString().slice(0,10) },

      /* ── MONEY ── */
      { id:lrnId(), title:'Rich Dad Poor Dad', author:'Robert T. Kiyosaki', genre:'Money', status:'done', rating:4, insight:'Assets put money in your pocket; liabilities take it out. Financial freedom comes from building assets that generate cash flow independent of your labour.', notes:'The mindset shift book for most traders. Read early in your journey.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'The Millionaire Next Door', author:'Thomas Stanley & William Danko', genre:'Money', status:'done', rating:4, insight:'Most wealthy people live well below their means, avoid status spending, and build wealth quietly through disciplined saving and investing over decades.', notes:'Data-driven look at how real wealth is built in America. Humbling and clarifying.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'I Will Teach You to Be Rich', author:'Ramit Sethi', genre:'Money', status:'done', rating:4, insight:'Automate the boring money decisions so you never have to think about them again. Optimise the big wins; don\'t obsess over lattes.', notes:'Best practical personal finance book for getting the basics automated.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'The Richest Man in Babylon', author:'George S. Clason', genre:'Money', status:'done', rating:5, insight:'Pay yourself first. Save 10% of all you earn before spending anything. Put money to work in investments you understand. Avoid get-rich-quick schemes.', notes:'Ancient financial wisdom in parable form. Takes 90 minutes to read. Worth it every year.', added: new Date().toISOString().slice(0,10) },
      { id:lrnId(), title:'Your Money or Your Life', author:'Vicki Robin & Joe Dominguez', genre:'Money', status:'want', rating:0, insight:'', notes:'The definitive book on financial independence and reframing money as life energy.', added: new Date().toISOString().slice(0,10) },
    ];
  }
  if (!lrnData.mentors.length) {
    lrnData.mentors = [
      /* ── TRADING / MACRO ── */
      { id:lrnId(), name:'Paul Tudor Jones', role:'Macro Trader · Founder, Tudor Investment Corp', disc:'Trading', tags:['Macro','Risk Management','Trend Following'], lesson:'Never risk more than 5% on a single idea. Capital preservation is the number one job. The best risk reward you will ever get is when things look the worst.', link:'https://youtube.com/results?search_query=paul+tudor+jones+interview', emoji:'🦁' },
      { id:lrnId(), name:'Stanley Druckenmiller', role:'Macro Investor · Former Duquesne Capital', disc:'Trading', tags:['Macro','Concentration','Long-Term Thinking'], lesson:'When you have tremendous conviction on a trade, you have to go for the jugular. It takes courage to be a pig. Diversification is for those who don\'t know what they\'re doing.', link:'https://youtube.com/results?search_query=stanley+druckenmiller+interview', emoji:'🐂' },
      { id:lrnId(), name:'Mark Douglas', role:'Author & Trading Psychologist', disc:'Psychology', tags:['Psychology','Mindset','Probability'], lesson:'Trading mastery is 80% psychological. You must build a belief system that is fully compatible with the reality of market uncertainty to achieve consistent results.', link:'https://youtube.com/results?search_query=mark+douglas+trading+in+the+zone', emoji:'🧠' },
      { id:lrnId(), name:'William O\'Neil', role:'Founder · Investor\'s Business Daily', disc:'Trading', tags:['Growth Stocks','Momentum','CAN SLIM'], lesson:'Cut every loss at 7–8%, no exceptions. Learn from every loss. The objective is not to be right all the time but to make big profits when right and small losses when wrong.', link:'https://investors.com', emoji:'📊' },
      { id:lrnId(), name:'Jesse Livermore', role:'Legendary Speculator (1877–1940)', disc:'Trading', tags:['Speculation','Trend Following','Risk'], lesson:'The markets are never wrong. Opinions often are. The big money is made not in the individual fluctuations but in the main movements — sitting tight.', link:'https://amazon.com/s?k=reminiscences+stock+operator', emoji:'🎩' },
      { id:lrnId(), name:'Jim Simons', role:'Mathematician · Founder, Renaissance Technologies', disc:'Quantitative', tags:['Quant','Data','Process','Edge'], lesson:'If you have a systematic edge, exploit it relentlessly. Markets are beatable, but only by those who treat it as a scientific problem rather than a prediction contest.', link:'https://youtube.com/results?search_query=jim+simons+ted+talk', emoji:'🔬' },
      { id:lrnId(), name:'Ray Dalio', role:'Founder · Bridgewater Associates', disc:'Macro', tags:['Macro','Principles','Diversification'], lesson:'Diversify across uncorrelated return streams. Know your risk parity. And above all — be radically open-minded enough to know when you are wrong.', link:'https://principles.com', emoji:'⚖️' },
      { id:lrnId(), name:'George Soros', role:'Founder · Soros Fund Management', disc:'Macro', tags:['Macro','Reflexivity','Philosophy'], lesson:'It\'s not whether you\'re right or wrong that\'s important, but how much money you make when you\'re right and how much you lose when you\'re wrong.', link:'https://youtube.com/results?search_query=george+soros+interview', emoji:'♟️' },

      /* ── INVESTING ── */
      { id:lrnId(), name:'Warren Buffett', role:'Chairman & CEO · Berkshire Hathaway', disc:'Investing', tags:['Value Investing','Compounding','Long-Term'], lesson:'Rule 1: Never lose money. Rule 2: Never forget Rule 1. The best investment you can make is in yourself. Buy wonderful businesses at fair prices and hold forever.', link:'https://berkshirehathaway.com/letters/letters.html', emoji:'🏦' },
      { id:lrnId(), name:'Charlie Munger', role:'Vice Chairman · Berkshire Hathaway', disc:'Investing', tags:['Mental Models','Value','Multidisciplinary'], lesson:'Invert, always invert. Understand the models from multiple disciplines and let them guide decisions. Avoid stupidity more actively than you seek brilliance.', link:'https://youtube.com/results?search_query=charlie+munger+mental+models', emoji:'🦉' },
      { id:lrnId(), name:'Peter Lynch', role:'Former PM · Fidelity Magellan Fund', disc:'Investing', tags:['Growth Investing','Research','Consumer Stocks'], lesson:'Invest in what you know. Do your homework and buy companies before Wall Street discovers them. The best stories are hiding in your daily life.', link:'https://youtube.com/results?search_query=peter+lynch+talks', emoji:'🔍' },
      { id:lrnId(), name:'Howard Marks', role:'Co-Founder · Oaktree Capital Management', disc:'Investing', tags:['Risk','Market Cycles','Second-Level Thinking'], lesson:'The most important thing is to think about what the consensus believes, then decide if they are right. Second-level thinking is the only true edge.', link:'https://oaktreecapital.com/insights/memos', emoji:'📝' },

      /* ── PSYCHOLOGY / BEHAVIOUR ── */
      { id:lrnId(), name:'Daniel Kahneman', role:'Nobel Laureate · Behavioural Economics Pioneer', disc:'Psychology', tags:['Cognitive Bias','Decision Making','Behavioural Finance'], lesson:'Overconfidence is the most dangerous bias in investing. Recognize that your System 1 brain will always try to shortcut. Build processes that force System 2 thinking.', link:'https://youtube.com/results?search_query=daniel+kahneman+thinking+fast+slow', emoji:'🧬' },
      { id:lrnId(), name:'Morgan Housel', role:'Partner · Collaborative Fund · Author', disc:'Finance', tags:['Behavioural Finance','Long-Term','Simplicity'], lesson:'Wealth is what you don\'t spend. Time horizon is the most powerful edge available to any investor. Patience, compounded, beats intelligence.', link:'https://collabfund.com/blog', emoji:'📖' },
      { id:lrnId(), name:'Nassim Nicholas Taleb', role:'Author · Former Derivatives Trader', disc:'Philosophy', tags:['Risk','Tail Events','Antifragility'], lesson:'Never risk ruin. Structure your portfolio so that no single event can cause catastrophic loss. The fragile breaks; the antifragile gets stronger from shocks.', link:'https://youtube.com/results?search_query=nassim+taleb+interview', emoji:'🎲' },

      /* ── SALES / NEGOTIATION ── */
      { id:lrnId(), name:'Chris Voss', role:'Former FBI Hostage Negotiator · Author', disc:'Negotiation', tags:['Negotiation','Tactical Empathy','Communication'], lesson:'Tactical empathy is your most powerful tool. Never split the difference — anchor high, use calibrated questions, and mirror to extract information. Emotion drives every deal.', link:'https://blackswanltd.com', emoji:'🕊️' },
      { id:lrnId(), name:'Robert Cialdini', role:'Author · Professor of Psychology & Marketing', disc:'Sales', tags:['Influence','Persuasion','Human Behaviour'], lesson:'The six principles of influence are universal. Reciprocity, commitment, social proof, authority, liking, and scarcity explain every bubble, every panic, and every sales pitch.', link:'https://influenceatwork.com', emoji:'🎭' },
      { id:lrnId(), name:'Tony Robbins', role:'Author · Peak Performance Coach', disc:'Human Behaviour', tags:['Mindset','Peak Performance','Finance'], lesson:'The quality of your life is the quality of your rituals. Build a morning routine, a review system, and emotional anchors that put you in peak state before you trade.', link:'https://tonyrobbins.com', emoji:'🔥' },
    ];
  }
  if (!lrnData.resources.length) {
    lrnData.resources = [
      /* ── PODCASTS ── */
      { id:lrnId(), title:'Chat With Traders', type:'podcast', desc:'Deep-dive interviews with consistently profitable traders. Intraday, swing, macro, quant — every style is represented with real P&L context.', link:'https://chatwithtraders.com', fav:true },
      { id:lrnId(), title:'We Study Billionaires (TIP)', type:'podcast', desc:'The Investors Podcast Network\'s flagship. Deep dives on Buffett, Munger, and the world\'s greatest investors every week.', link:'https://theinvestorspodcast.com', fav:true },
      { id:lrnId(), title:'Acquired', type:'podcast', desc:'World-class deep dives on the greatest companies and investors of all time — Berkshire, TSMC, LVMH, Nvidia. Best research podcast on the internet.', link:'https://acquired.fm', fav:true },
      { id:lrnId(), title:'The Knowledge Project (Shane Parrish)', type:'podcast', desc:'Mental models, decision-making, and interviews with the world\'s clearest thinkers. Essential for building a trader\'s mental framework.', link:'https://fs.blog/knowledge-project-podcast', fav:true },
      { id:lrnId(), title:'My First Million', type:'podcast', desc:'Sam Parr and Shaan Puri on business, money, and ideas. Excellent for thinking about opportunity, leverage, and the psychology of wealth creation.', link:'https://mfmpod.com', fav:false },
      { id:lrnId(), title:'Masters in Business (Bloomberg)', type:'podcast', desc:'Barry Ritholtz interviews top investors, economists, and market thinkers. Long-form, intellectually rigorous, consistently excellent.', link:'https://bloomberg.com/podcasts/masters_in_business', fav:false },
      { id:lrnId(), title:'Invest Like the Best', type:'podcast', desc:'Patrick O\'Shaughnessy\'s conversations with the world\'s best investors and business builders. Must-listen for serious investors.', link:'https://joincolossus.com/episodes', fav:true },
      { id:lrnId(), title:'The Tim Ferriss Show', type:'podcast', desc:'World-class performers across every field — traders, athletes, writers, scientists. Distils peak performance principles with remarkable depth.', link:'https://tim.blog/podcast', fav:false },

      /* ── YOUTUBE / VIDEO ── */
      { id:lrnId(), title:'SMB Capital YouTube', type:'video', desc:'Free daily content from a professional New York prop firm. Intraday setups, trade reviews, psychology, and coaching. Unmatched free educational value.', link:'https://youtube.com/@smbcapital', fav:true },
      { id:lrnId(), title:'Investors Archive', type:'video', desc:'Rare, full-length interviews with Buffett, Munger, Lynch, Soros, Druckenmiller, and every great investor. An unbelievable free archive.', link:'https://youtube.com/@InvestorsArchive', fav:true },
      { id:lrnId(), title:'Real Vision Finance', type:'video', desc:'Institutional-quality macro and market analysis. Home to Raoul Pal, Grant Williams, and the world\'s top macro thinkers. Some content behind paywall.', link:'https://realvision.com', fav:true },
      { id:lrnId(), title:'Rayner Teo (TradingwithRayner)', type:'video', desc:'Systematic trading concepts explained with extraordinary clarity. Best free YouTube channel for understanding price action and risk management frameworks.', link:'https://youtube.com/@Rayner', fav:false },
      { id:lrnId(), title:'Graham Stephan', type:'video', desc:'Real estate, investing, and personal finance with accessible explanations. Best gateway content for younger traders learning foundational money principles.', link:'https://youtube.com/@GrahamStephan', fav:false },

      /* ── COURSES ── */
      { id:lrnId(), title:'Investors Underground (Nate\'s Course)', type:'course', desc:'Momentum trading, short-selling, and small-cap strategy from a full-time professional. The standard for learning intraday momentum trading.', link:'https://investorsunderground.com', fav:true },
      { id:lrnId(), title:'Warrior Trading (Ross Cameron)', type:'course', desc:'Small-cap momentum trading course from one of the most transparent day traders online. Ross shares real brokerage statements. Excellent structure.', link:'https://warriortrading.com', fav:false },
      { id:lrnId(), title:'Udemy: Algorithmic Trading A-Z', type:'course', desc:'Best Udemy course for learning Python-based algorithmic trading from scratch. Covers backtesting, strategy development, and live trading via IBKR.', link:'https://udemy.com/course/algorithmic-trading-with-python-and-machine-learning', fav:false },
      { id:lrnId(), title:'CFA Institute (CFA Program)', type:'course', desc:'Gold standard designation for investment analysis and portfolio management. Enormous commitment, but the curriculum is world-class for fundamental analysis.', link:'https://cfainstitute.org', fav:false },

      /* ── TOOLS ── */
      { id:lrnId(), title:'TradingView', type:'tool', desc:'Best-in-class charting platform. Technical analysis, Pine Script strategy backtesting, global market screeners, and an active community of traders.', link:'https://tradingview.com', fav:true },
      { id:lrnId(), title:'Finviz', type:'tool', desc:'The fastest stock screener on the internet. Elite map visualisation, fundamental and technical filters. Essential daily tool for market overview.', link:'https://finviz.com', fav:true },
      { id:lrnId(), title:'Macroaxis / Macrotrends', type:'tool', desc:'Deep fundamental and macro data. Best free resource for multi-decade financial statement data, economic indicators, and global market metrics.', link:'https://macrotrends.net', fav:false },
      { id:lrnId(), title:'Koyfin', type:'tool', desc:'Bloomberg-quality financial data at a fraction of the cost. Excellent for fundamental screening, charting economic data, and building watchlists.', link:'https://koyfin.com', fav:true },
      { id:lrnId(), title:'Quantopian / QuantConnect', type:'tool', desc:'Build, backtest, and deploy algorithmic trading strategies with professional-grade infrastructure. QuantConnect is the leading free quant research platform.', link:'https://quantconnect.com', fav:false },
      { id:lrnId(), title:'FRED (St. Louis Fed)', type:'tool', desc:'The world\'s most comprehensive free macroeconomic database. Every serious macro trader and investor uses FRED. 800,000+ data series from 100+ sources.', link:'https://fred.stlouisfed.org', fav:true },

      /* ── ARTICLES / READING ── */
      { id:lrnId(), title:'Howard Marks Memos (Oaktree)', type:'article', desc:'The most valuable free reading in finance. Marks has published insightful memos on markets, risk, and cycles since 1990. Read them all, chronologically.', link:'https://oaktreecapital.com/insights/memos', fav:true },
      { id:lrnId(), title:'Berkshire Hathaway Annual Letters', type:'article', desc:'Buffett\'s letters to shareholders since 1965. The greatest free finance education in existence. Read from 1977 forward for maximum value.', link:'https://berkshirehathaway.com/letters/letters.html', fav:true },
      { id:lrnId(), title:'Farnam Street (fs.blog)', type:'article', desc:'Shane Parrish\'s site on mental models, decision-making, and learning. The intellectual backbone for any serious trader\'s reading list.', link:'https://fs.blog', fav:true },
      { id:lrnId(), title:'The Economist', type:'article', desc:'The gold standard for macro, geopolitical, and business intelligence. Required reading for any trader with a longer time horizon or macro perspective.', link:'https://economist.com', fav:false },
      { id:lrnId(), title:'Collaborative Fund Blog (Morgan Housel)', type:'article', desc:'Housel\'s essays on money, psychology, and behaviour are among the most insightful pieces written about investing in the last decade. All free.', link:'https://collabfund.com/blog', fav:true },

      /* ── COMMUNITIES ── */
      { id:lrnId(), title:'Traders4ACause', type:'community', desc:'Annual event and community of full-time traders sharing real P&L, strategies, and performance. The most credible trader community in the US.', link:'https://traders4acause.org', fav:false },
      { id:lrnId(), title:'r/SecurityAnalysis (Reddit)', type:'community', desc:'The most intelligent investing subreddit. Deep fundamental analysis, original research, and high-quality discussion. Signal-to-noise ratio is exceptional.', link:'https://reddit.com/r/SecurityAnalysis', fav:false },
      { id:lrnId(), title:'StockTwits', type:'community', desc:'Real-time social network for traders and investors. Best used for sentiment analysis and finding what the retail crowd is watching, not for trade ideas.', link:'https://stocktwits.com', fav:false },
    ];
  }
  if (!lrnData.learnings.length) {
    lrnData.learnings = [
      /* ── RISK ── */
      { id:lrnId(), body:'Never add to a losing trade expecting it to come back. Every catastrophic loss in history — LTCM, Nick Leeson, every blow-up — involved ignoring this rule.', cat:'risk', imp:3, source:'When Genius Failed / Personal experience', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'Position sizing is the most underrated skill in trading. You can be right 40% of the time and still outperform someone who is right 70% if your size on winners is 3x your losers.', cat:'sizing', imp:3, source:'Market Wizards — Tom Basso', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'Always define your maximum loss before entering a trade. If you don\'t know exactly where you are wrong, you don\'t have a trade — you have a hope.', cat:'risk', imp:3, source:'Paul Tudor Jones', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'Drawdowns compound asymmetrically. A 50% loss requires a 100% gain to recover. Protecting capital is not conservative — it is mathematically essential for long-term survival.', cat:'risk', imp:3, source:'Antifragile / Nassim Taleb', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'The daily loss limit is not a suggestion. When you hit it, stop. Every trader who has ever blown up will tell you the blowup happened on a day they ignored their daily limit.', cat:'risk', imp:3, source:'SMB Capital — Mike Bellafiore', date: new Date().toISOString().slice(0,10) },

      /* ── MINDSET ── */
      { id:lrnId(), body:'When I am in a drawdown, my perception of setups becomes distorted. I see potential everywhere. This is the most dangerous mental state and requires forced rest, not more trading.', cat:'mindset', imp:3, source:'Trading in the Zone / Personal journal', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'The goal is not to be right. The goal is to make money. These are completely different objectives. A trader who cannot separate his ego from his P&L will always underperform.', cat:'mindset', imp:3, source:'Mark Douglas', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'Equanimity is a trading edge. The trader who is unmoved by a single loss or a single win makes better decisions than the one riding the emotional wave of every trade.', cat:'mindset', imp:3, source:'Meditations — Marcus Aurelius', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'Accept the uncertainty fully. You never know what will happen in the market. Your job is to have a process, execute it, and manage the outcome — not predict it.', cat:'mindset', imp:2, source:'Trading in the Zone — Mark Douglas', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'Revenge trading is the fastest path to ruin. After a loss, the natural impulse is to trade larger and faster to recover. Do the exact opposite: wait longer and trade smaller.', cat:'mindset', imp:3, source:'Personal journal / Paul Tudor Jones', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'Build pre-market routines like an athlete. Your state before the open determines 80% of your trading quality that day. Nutrition, sleep, exercise, and preparation are not optional.', cat:'mindset', imp:2, source:'Tony Robbins / Atomic Habits', date: new Date().toISOString().slice(0,10) },

      /* ── ENTRY ── */
      { id:lrnId(), body:'The quality of the setup matters far more than the quantity of trades. Three A+ setups executed perfectly beat ten mediocre setups every single month.', cat:'entry', imp:3, source:'Market Wizards / SMB Capital', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'Wait for the market to confirm your thesis before entering. Anticipating a move costs you far more in failed entries than waiting for confirmation costs you in optimal entry price.', cat:'entry', imp:2, source:'Reminiscences of a Stock Operator', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'The best entries come when you don\'t need the trade to work. When you find yourself rationalising a mediocre setup, that is the moment to walk away.', cat:'entry', imp:2, source:'Personal journal', date: new Date().toISOString().slice(0,10) },

      /* ── EXIT ── */
      { id:lrnId(), body:'Learn to take profits at predetermined targets. The trader who always holds for more will give back gains as consistently as the one who cuts too early. Have a plan and execute it.', cat:'exit', imp:2, source:'Trade Like a Stock Market Wizard — Mark Minervini', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'Cutting losses is not a failure of conviction — it is the execution of your process. The market will give you another opportunity. Your capital, once gone, may not return.', cat:'exit', imp:3, source:'William O\'Neil / Paul Tudor Jones', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'Runners change your psychology. When you take partial profits and trail a stop, you have a free trade. From that position, you can afford to let the market prove you wrong.', cat:'exit', imp:2, source:'Chat With Traders — various episodes', date: new Date().toISOString().slice(0,10) },

      /* ── STRATEGY ── */
      { id:lrnId(), body:'An edge is only an edge if it is rigorously tested and consistently applied. One-time successes are not edges. Statistical repeatability over hundreds of occurrences is an edge.', cat:'strategy', imp:3, source:'The Man Who Solved the Market — Jim Simons', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'Correlation kills in a crisis. Diversification that works in normal markets often fails when you need it most. Build portfolios that stress-test under multiple scenarios including tail events.', cat:'strategy', imp:2, source:'Ray Dalio — Principles for Navigating Big Debt Crises', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'Every trading strategy has a regime where it works and one where it fails. Document both. Knowing when NOT to apply your strategy is just as important as knowing when to apply it.', cat:'strategy', imp:3, source:'Personal journal / Howard Marks', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'Second-level thinking wins markets. If everyone knows a stock is cheap, the real question is: why is it cheap, and what do you know that the consensus doesn\'t?', cat:'strategy', imp:3, source:'Howard Marks — The Most Important Thing', date: new Date().toISOString().slice(0,10) },

      /* ── SIZING ── */
      { id:lrnId(), body:'Kelly criterion says bet the fraction of bankroll equal to your edge divided by odds. In practice: use half Kelly or less. Full Kelly is mathematically optimal but emotionally unliveable.', cat:'sizing', imp:2, source:'Fortune\'s Formula — William Poundstone', date: new Date().toISOString().slice(0,10) },
      { id:lrnId(), body:'Reduce size when losing. This is the hardest habit to build and the most valuable. The time to take maximum size is when you are sharp, in form, and the market is giving you A+ setups.', cat:'sizing', imp:3, source:'Paul Tudor Jones / Mark Minervini', date: new Date().toISOString().slice(0,10) },
    ];
  }
  saveLrnData();
})();

/* ══════════════════ BOOKS ══════════════════ */
function renderBooks() {
  const q = ($('bk-search')||{value:''}).value.toLowerCase();
  const st = ($('bk-status')||{value:''}).value;
  const cat = ($('bk-cat')||{value:''}).value;
  let list = lrnData.books.filter(b => {
    if (q && !b.title.toLowerCase().includes(q) && !(b.author||'').toLowerCase().includes(q)) return false;
    if (st && b.status !== st) return false;
    if (cat && b.genre !== cat) return false;
    return true;
  });
  const el = $('book-grid');
  if (!el) return;
  if (!list.length) { el.innerHTML = `<div class="lrn-empty" style="grid-column:1/-1"><div class="lrn-empty-icon">📚</div><div class="lrn-empty-txt">No books found.<br>Add your first trading book to start building your library.</div><button class="lrn-add-btn" onclick="openBookModal()">+ Add Book</button></div>`; return; }
  el.innerHTML = list.map(b => {
    const stars = [1,2,3,4,5].map(n=>`<span class="book-star${n<=b.rating?' on':''}">★</span>`).join('');
    const statusTag = b.status === 'done' ? '<span class="book-tag done">✓ Done</span>' : b.status === 'reading' ? '<span class="book-tag reading">📖 Reading</span>' : '<span class="book-tag want">📌 Want</span>';
    const bg = BOOK_COLORS[b.genre] || BOOK_COLORS.Other;
    const emoji = BOOK_EMOJIS[b.genre] || '📖';
    return `<div class="book-card" onclick="openBookModal('${b.id}')">
      <button class="book-del" onclick="event.stopPropagation();delBook('${b.id}')">×</button>
      <div class="book-spine" style="background:${bg}">${emoji}</div>
      <div class="book-title">${esc(b.title)}</div>
      <div class="book-author">${esc(b.author||'')}</div>
      <div class="book-tags">${statusTag}<span class="book-tag">${esc(b.genre)}</span></div>
      <div class="book-rating">${stars}</div>
      ${b.insight ? `<div class="book-key-insight">${esc(b.insight.slice(0,120))}${b.insight.length>120?'…':''}</div>` : ''}
    </div>`;
  }).join('');
  updateLrnCounts();
}

function openBookModal(id) {
  _bkEditId = id || null;
  _bmRating = 0;
  const isEdit = !!id;
  $('book-modal-title').textContent = isEdit ? 'Edit Book' : 'Add Book';
  if (isEdit) {
    const b = lrnData.books.find(x=>x.id===id);
    if (!b) return;
    $('bm-title').value   = b.title;
    $('bm-author').value  = b.author||'';
    $('bm-genre').value   = b.genre;
    $('bm-status').value  = b.status;
    $('bm-insight').value = b.insight||'';
    $('bm-notes').value   = b.notes||'';
    _bmRating = b.rating||0;
  } else {
    ['bm-title','bm-author','bm-insight','bm-notes'].forEach(id=>$(''+id).value='');
    $('bm-genre').value='Trading'; $('bm-status').value='want';
  }
  bmRenderStars();
  $('modal-book').style.display = 'flex';
}
function bmSetRating(n) { _bmRating = _bmRating===n?0:n; bmRenderStars(); }
function bmRenderStars() {
  document.querySelectorAll('#bm-rating-row .book-star').forEach((s,i)=>s.classList.toggle('on',i<_bmRating));
}
function saveBook() {
  const title = $('bm-title').value.trim();
  if (!title) { toast('Title is required'); return; }
  const obj = { id: _bkEditId || lrnId(), title, author:$('bm-author').value.trim(), genre:$('bm-genre').value, status:$('bm-status').value, rating:_bmRating, insight:$('bm-insight').value.trim(), notes:$('bm-notes').value.trim(), added: new Date().toISOString().slice(0,10) };
  if (_bkEditId) { const i = lrnData.books.findIndex(x=>x.id===_bkEditId); if(i>=0) lrnData.books[i]=obj; }
  else lrnData.books.unshift(obj);
  saveLrnData(); closeLrnModal('book'); renderBooks(); toast('Book saved ✓');
}
function delBook(id) { lrnData.books = lrnData.books.filter(x=>x.id!==id); saveLrnData(); renderBooks(); toast('Removed'); }

/* ══════════════════ MENTORS ══════════════════ */
function renderMentors() {
  const q   = ($('men-search')||{value:''}).value.toLowerCase();
  const cat = ($('men-cat')||{value:''}).value;
  let list = lrnData.mentors.filter(m => {
    if (q && !m.name.toLowerCase().includes(q) && !(m.lesson||'').toLowerCase().includes(q)) return false;
    if (cat && m.disc !== cat) return false;
    return true;
  });
  const el = $('mentor-grid');
  if (!el) return;
  if (!list.length) { el.innerHTML=`<div class="lrn-empty" style="grid-column:1/-1"><div class="lrn-empty-icon">🎓</div><div class="lrn-empty-txt">No mentors yet.<br>Add traders and thinkers who shaped your edge.</div><button class="lrn-add-btn" onclick="openMentorModal()">+ Add Mentor</button></div>`; return; }
  el.innerHTML = list.map(m => {
    const tags = (m.tags||[]).map(t=>`<span class="mentor-tag">${esc(t)}</span>`).join('');
    return `<div class="mentor-card" onclick="openMentorModal('${m.id}')">
      <button class="mentor-del" onclick="event.stopPropagation();delMentor('${m.id}')">×</button>
      <div class="mentor-avatar">${esc(m.emoji||'👤')}</div>
      <div class="mentor-name">${esc(m.name)}</div>
      <div class="mentor-title">${esc(m.role||m.disc)}</div>
      <div class="mentor-tags">${tags}</div>
      ${m.lesson ? `<div class="mentor-lesson">${esc(m.lesson.slice(0,160))}${m.lesson.length>160?'…':''}</div>` : ''}
      ${m.quote ? `<div style="font-family:var(--g);font-size:12px;font-style:italic;color:var(--dim);border-left:2px solid var(--rule);padding-left:8px;margin-bottom:10px">"${esc(m.quote.slice(0,100))}${m.quote.length>100?'…':''}"</div>` : ''}
      ${m.link ? `<a class="mentor-link" href="${esc(m.link)}" target="_blank" onclick="event.stopPropagation()">↗ Visit →</a>` : ''}
    </div>`;
  }).join('');
  updateLrnCounts();
}

function openMentorModal(id) {
  _menEditId = id || null;
  const isEdit = !!id;
  $('mentor-modal-title').textContent = isEdit ? 'Edit Mentor' : 'Add Mentor';
  if (isEdit) {
    const m = lrnData.mentors.find(x=>x.id===id);
    if (!m) return;
    $('mm-name').value   = m.name;
    $('mm-role').value   = m.role||'';
    $('mm-disc').value   = m.disc||'Trading';
    $('mm-tags').value   = (m.tags||[]).join(', ');
    $('mm-lesson').value = m.lesson||'';
    $('mm-quote').value  = m.quote||'';
    $('mm-link').value   = m.link||'';
    $('mm-emoji').value  = m.emoji||'👤';
  } else {
    ['mm-name','mm-role','mm-tags','mm-lesson','mm-quote','mm-link'].forEach(id=>$(id).value='');
    $('mm-disc').value='Trading'; $('mm-emoji').value='👤';
  }
  $('modal-mentor').style.display = 'flex';
}
function saveMentor() {
  const name = $('mm-name').value.trim();
  if (!name) { toast('Name is required'); return; }
  const tags = $('mm-tags').value.split(',').map(t=>t.trim()).filter(Boolean);
  const obj = { id:_menEditId||lrnId(), name, role:$('mm-role').value.trim(), disc:$('mm-disc').value, tags, lesson:$('mm-lesson').value.trim(), quote:$('mm-quote').value.trim(), link:$('mm-link').value.trim(), emoji:$('mm-emoji').value.trim()||'👤' };
  if (_menEditId) { const i=lrnData.mentors.findIndex(x=>x.id===_menEditId); if(i>=0) lrnData.mentors[i]=obj; }
  else lrnData.mentors.unshift(obj);
  saveLrnData(); closeLrnModal('mentor'); renderMentors(); toast('Mentor saved ✓');
}
function delMentor(id) { lrnData.mentors=lrnData.mentors.filter(x=>x.id!==id); saveLrnData(); renderMentors(); toast('Removed'); }

/* ══════════════════ RESOURCES ══════════════════ */
function renderResources() {
  const q    = ($('res-search')||{value:''}).value.toLowerCase();
  const type = ($('res-type')||{value:''}).value;
  let list = lrnData.resources.filter(r => {
    if (q && !r.title.toLowerCase().includes(q) && !(r.desc||'').toLowerCase().includes(q)) return false;
    if (type && r.type !== type) return false;
    return true;
  }).sort((a,b)=>(b.fav?1:0)-(a.fav?1:0));
  const el = $('res-grid');
  if (!el) return;
  if (!list.length) { el.innerHTML=`<div class="lrn-empty" style="grid-column:1/-1"><div class="lrn-empty-icon">🔗</div><div class="lrn-empty-txt">No resources yet.<br>Add podcasts, videos, courses, and tools.</div><button class="lrn-add-btn" onclick="openResModal()">+ Add Resource</button></div>`; return; }
  el.innerHTML = list.map(r => `<div class="res-card">
    <button class="res-del" onclick="delResource('${r.id}')">×</button>
    <div class="res-type-row">
      <span class="res-type ${r.type}">${r.type.toUpperCase()}</span>
      <button class="res-fav${r.fav?' on':''}" onclick="toggleResFav('${r.id}')" title="${r.fav?'Unstar':'Star'}">${r.fav?'★':'☆'}</button>
    </div>
    <div class="res-title" onclick="openResModal('${r.id}');event.stopPropagation()" style="cursor:pointer">${esc(r.title)}</div>
    ${r.desc ? `<div class="res-desc">${esc(r.desc.slice(0,120))}${r.desc.length>120?'…':''}</div>` : ''}
    ${r.link ? `<a class="res-link" href="${esc(r.link)}" target="_blank">↗ Open →</a>` : ''}
  </div>`).join('');
  updateLrnCounts();
}

function openResModal(id) {
  _resEditId = id||null;
  const isEdit = !!id;
  $('res-modal-title').textContent = isEdit?'Edit Resource':'Add Resource';
  if (isEdit) {
    const r = lrnData.resources.find(x=>x.id===id);
    if (!r) return;
    $('rm-title').value = r.title; $('rm-type').value = r.type;
    $('rm-desc').value = r.desc||''; $('rm-link').value = r.link||'';
  } else { ['rm-title','rm-desc','rm-link'].forEach(id=>$(id).value=''); $('rm-type').value='video'; }
  $('modal-res').style.display='flex';
}
function saveResource() {
  const title=$('rm-title').value.trim();
  if (!title) { toast('Title required'); return; }
  const obj={id:_resEditId||lrnId(),title,type:$('rm-type').value,desc:$('rm-desc').value.trim(),link:$('rm-link').value.trim(),fav:false};
  if (_resEditId) { const i=lrnData.resources.findIndex(x=>x.id===_resEditId); if(i>=0){obj.fav=lrnData.resources[i].fav;lrnData.resources[i]=obj;} }
  else lrnData.resources.unshift(obj);
  saveLrnData(); closeLrnModal('res'); renderResources(); toast('Resource saved ✓');
}
function toggleResFav(id) { const r=lrnData.resources.find(x=>x.id===id); if(r){r.fav=!r.fav;saveLrnData();renderResources();} }
function delResource(id) { lrnData.resources=lrnData.resources.filter(x=>x.id!==id); saveLrnData(); renderResources(); toast('Removed'); }

/* ══════════════════ LEARNINGS ══════════════════ */
const LRN_CAT_LABELS = { mindset:'Mindset', risk:'Risk', entry:'Entry', exit:'Exit', sizing:'Sizing', strategy:'Strategy' };
function renderLearnings() {
  const q   = ($('ln-search')||{value:''}).value.toLowerCase();
  const cat = ($('ln-cat')||{value:''}).value;
  const imp = parseInt(($('ln-imp')||{value:''}).value)||0;
  let list = lrnData.learnings.filter(l => {
    if (q && !l.body.toLowerCase().includes(q) && !(l.source||'').toLowerCase().includes(q)) return false;
    if (cat && l.cat!==cat) return false;
    if (imp && l.imp<imp) return false;
    return true;
  }).sort((a,b)=>b.imp-a.imp || b.date.localeCompare(a.date));
  const el = $('lrn-learnings-list');
  if (!el) return;
  if (!list.length) { el.innerHTML=`<div class="lrn-empty"><div class="lrn-empty-icon">💡</div><div class="lrn-empty-txt">No learnings yet.<br>Capture lessons from trades, books, and experience.</div><button class="lrn-add-btn" onclick="openLrnModal()">+ Add Learning</button></div>`; return; }
  el.innerHTML = list.map(l => {
    const dots = [1,2,3].map(n=>`<div class="lrn-dot${n<=l.imp?' on':''}"></div>`).join('');
    return `<div class="lrn-item" onclick="openLrnModal('${l.id}')">
      <button class="lrn-del" onclick="event.stopPropagation();delLearning('${l.id}')">×</button>
      <div class="lrn-item-head">
        <div class="lrn-item-meta">
          <span class="lrn-item-cat ${l.cat}">${LRN_CAT_LABELS[l.cat]||l.cat}</span>
          <div class="lrn-item-imp">${dots}</div>
        </div>
        <div class="lrn-item-date">${l.date||''}</div>
      </div>
      <div class="lrn-body">${esc(l.body)}</div>
      ${l.source?`<div class="lrn-source">Source: ${esc(l.source)}</div>`:''}
    </div>`;
  }).join('');
  updateLrnCounts();
}

function openLrnModal(id) {
  _lrnEditId = id||null;
  const isEdit = !!id;
  $('lrn-modal-title').textContent = isEdit?'Edit Learning':'Add Learning';
  if (isEdit) {
    const l = lrnData.learnings.find(x=>x.id===id);
    if (!l) return;
    $('lm-body').value   = l.body;
    $('lm-cat').value    = l.cat;
    $('lm-source').value = l.source||'';
    document.querySelectorAll('input[name="lm-imp"]').forEach(r=>{ r.checked = r.value==l.imp; });
  } else {
    $('lm-body').value=''; $('lm-cat').value='mindset'; $('lm-source').value='';
    document.querySelectorAll('input[name="lm-imp"]').forEach(r=>{ r.checked = r.value==='2'; });
  }
  $('modal-lrn').style.display='flex';
}
function saveLearning() {
  const body = $('lm-body').value.trim();
  if (!body) { toast('Learning text is required'); return; }
  const imp = parseInt([...document.querySelectorAll('input[name="lm-imp"]')].find(r=>r.checked)?.value||2);
  const obj = { id:_lrnEditId||lrnId(), body, cat:$('lm-cat').value, imp, source:$('lm-source').value.trim(), date:new Date().toISOString().slice(0,10) };
  if (_lrnEditId) { const i=lrnData.learnings.findIndex(x=>x.id===_lrnEditId); if(i>=0) lrnData.learnings[i]=obj; }
  else lrnData.learnings.unshift(obj);
  saveLrnData(); closeLrnModal('lrn'); renderLearnings(); toast('Learning saved ✓');
}
function delLearning(id) { lrnData.learnings=lrnData.learnings.filter(x=>x.id!==id); saveLrnData(); renderLearnings(); toast('Removed'); }

function closeLrnModal(type) { $('modal-'+type).style.display='none'; }

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   MARKET INTEL
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
const MI_HORIZONS = {
  week:    {title:'This Week Macro View',   env:'RISK-ON',   cyc:'EARLY-CYCLE', conv:'MODERATE',       phase:'Recovery'},
  month:   {title:'This Month Macro View',  env:'RISK-ON',   cyc:'EARLY-CYCLE', conv:'MODERATE',       phase:'Recovery'},
  quarter: {title:'This Quarter View',      env:'RISK-ON',   cyc:'MID-CYCLE',   conv:'MODERATE',       phase:'Expansion'},
  year:    {title:'This Year Macro View',   env:'RISK-ON',   cyc:'MID-CYCLE',   conv:'HIGH CONVICTION',phase:'Expansion'},
  '3y':    {title:'3-Year Macro View',      env:'RISK-ON',   cyc:'MID-CYCLE',   conv:'HIGH CONVICTION',phase:'Expansion'},
  '5y':    {title:'5-Year Macro View',      env:'MIXED',     cyc:'LATE-CYCLE',  conv:'MODERATE',       phase:'Peak'},
  '10y':   {title:'10-Year Macro View',     env:'RISK-ON',   cyc:'MID-CYCLE',   conv:'HIGH CONVICTION',phase:'Expansion'},
  decade:  {title:'Decade Predictions',     env:'STRUCTURAL',cyc:'MULTI-CYCLE', conv:'HIGH CONVICTION',phase:'Expansion'},
};
let _miHz = '10y';

function setHorizon(hz, btn){
  _miHz = hz;
  document.querySelectorAll('.mi-hz-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  const h = MI_HORIZONS[hz];
  if($('mi-view-title')) $('mi-view-title').textContent = h.title;
  if($('mi-sig-env'))  $('mi-sig-env').textContent  = h.env;
  if($('mi-sig-cyc'))  $('mi-sig-cyc').textContent  = h.cyc;
  if($('mi-sig-conv')) $('mi-sig-conv').textContent = h.conv;
  if($('mi-cycle-label')) $('mi-cycle-label').textContent = h.phase;
  drawCycleDonut(h.phase);
}

function drawCycleDonut(active){
  const canvas = $('mi-cycle-canvas'); if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const cx=140, cy=120, R=100, r=55;
  ctx.clearRect(0,0,280,240);

  const phases = [
    {name:'Recovery',    color:'#22d3ee', from:Math.PI*1.5, to:Math.PI*0.0},
    {name:'Expansion',   color:'#4ade80', from:Math.PI*0.0, to:Math.PI*0.5},
    {name:'Peak',        color:'#d4a847', from:Math.PI*0.5, to:Math.PI*1.0},
    {name:'Contraction', color:'#f87171', from:Math.PI*1.0, to:Math.PI*1.5},
  ];

  phases.forEach(p=>{
    const isActive = p.name===active;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,R,p.from,p.to);
    ctx.closePath();
    ctx.fillStyle = isActive ? p.color+'55' : p.color+'18';
    ctx.fill();
    ctx.beginPath();
    ctx.arc(cx,cy,R,p.from,p.to);
    ctx.arc(cx,cy,r,p.to,p.from,true);
    ctx.closePath();
    ctx.fillStyle = isActive ? p.color+'bb' : p.color+'33';
    ctx.fill();
    ctx.strokeStyle = isActive ? p.color : p.color+'44';
    ctx.lineWidth = isActive ? 2 : 1;
    ctx.stroke();

    // label
    const mid = (p.from + p.to) / 2;
    const lx = cx + Math.cos(mid) * (R+14);
    const ly = cy + Math.sin(mid) * (R+14);
    ctx.fillStyle = isActive ? p.color : p.color+'88';
    ctx.font = `${isActive?'500 ':''}10px IBM Plex Mono, monospace`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(p.name, lx, ly);
  });

  // active phase indicator dot
  const phaseMap = {Recovery:Math.PI*1.75, Expansion:Math.PI*0.25, Peak:Math.PI*0.75, Contraction:Math.PI*1.25};
  const dotAngle = phaseMap[active] || Math.PI*0.25;
  const dotR = (R+r)/2;
  ctx.beginPath();
  ctx.arc(cx+Math.cos(dotAngle)*dotR, cy+Math.sin(dotAngle)*dotR, 7, 0, Math.PI*2);
  ctx.fillStyle = '#fff';
  ctx.fill();
  ctx.strokeStyle = '#0006';
  ctx.lineWidth = 1;
  ctx.stroke();
}

function drawSectorBars(){
  const canvas = $('mi-sector-canvas'); if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H);

  const sectors = [
    {name:'Techno', val:28.4, color:'#6366f1'},
    {name:'Financ', val:14.2, color:'#22d3ee'},
    {name:'Health', val:9.8,  color:'#4ade80'},
    {name:'Energ',  val:-3.2, color:'#fb923c'},
    {name:'Indus',  val:11.4, color:'#d4a847'},
    {name:'Mater',  val:7.6,  color:'#f9a8d4'},
    {name:'Real',   val:-1.8, color:'#fb923c'},
    {name:'Utili',  val:5.2,  color:'#a3e635'},
    {name:'Cons+',  val:18.6, color:'#4ade80'},
    {name:'Cons.',  val:4.1,  color:'#94a3b8'},
    {name:'Comm.',  val:22.8, color:'#818cf8'},
  ];

  const n = sectors.length;
  const barW = Math.floor((W-60) / n) - 6;
  const midY = H-34;
  const scalePos = (midY-20) / 28.4;
  const scaleNeg = 14 / 3.2;

  sectors.forEach((s,i)=>{
    const x = 30 + i*((W-60)/n);
    const barH = Math.abs(s.val) * (s.val>=0?scalePos:scaleNeg);
    const y = s.val>=0 ? midY-barH : midY;

    // bar
    ctx.fillStyle = s.val>=0 ? s.color+'cc' : '#f87171cc';
    ctx.beginPath();
    ctx.roundRect ? ctx.roundRect(x,y,barW,barH,2) : (ctx.rect(x,y,barW,barH));
    ctx.fill();

    // value label
    ctx.fillStyle = s.val>=0 ? s.color : '#f87171';
    ctx.font = '9px IBM Plex Mono, monospace';
    ctx.textAlign = 'center';
    ctx.textBaseline = s.val>=0 ? 'bottom' : 'top';
    ctx.fillText((s.val>=0?'+':'')+s.val+'%', x+barW/2, s.val>=0?y-2:y+barH+2);

    // sector name
    ctx.fillStyle = '#5a5a78';
    ctx.font = '8px IBM Plex Mono, monospace';
    ctx.textBaseline = 'top';
    ctx.fillText(s.name, x+barW/2, H-16);
  });

  // zero line
  ctx.strokeStyle = 'rgba(255,255,255,0.08)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(20,midY);
  ctx.lineTo(W-20,midY);
  ctx.stroke();
}

function renderIntel(){
  if(intelSt.bias)  sv('intel-bias',  intelSt.bias);
  if(intelSt.edge)  sv('intel-edge',  intelSt.edge);
  // draw charts after DOM settles
  requestAnimationFrame(()=>{
    drawCycleDonut('Expansion');
    drawSectorBars();
  });
}
function saveIntel(){
  intelSt={
    bias:$('intel-bias').value,
    levels:'',
    macro:'',
    edge:$('intel-edge').value
  };
  lss('zj4_intel',intelSt);
  toast('Intel saved.');
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   SCREENER  (Finnhub)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
async function fetchQuote(sym){
  const k=apiKeys.finnhub;if(!k)return null;
  try{const r=await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${k}`);const d=await r.json();return{sym,price:d.c,prev:d.pc,open:d.o,high:d.h,low:d.l};}catch{return null;}
}
function scCard(d, deletable=false){
  if(!d)return'';
  const chg=d.price-d.prev,chgP=(chg/d.prev*100);
  const cls=chg>=0?'g':'r';
  const range=d.high-d.low||1,pos=Math.max(0,Math.min(1,(d.price-d.low)/range));
  const delBtn=deletable?`<button onclick="event.stopPropagation();removeWatchlistSymbol('${d.sym}')" style="position:absolute;top:8px;right:8px;background:none;border:none;color:var(--ghost);font-size:13px;cursor:pointer;line-height:1;padding:0;transition:color 0.12s" onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--ghost)'">×</button>`:'';
  return`<div class="screener-card" style="position:relative">
    ${delBtn}
    <div class="sc-sym" style="${deletable?'padding-right:18px':''}">${d.sym}</div>
    <div class="sc-price">${d.price.toFixed(2)}</div>
    <div class="sc-chg ${cls}">${chg>=0?'+':''}${chg.toFixed(2)} (${chgP>=0?'+':''}${chgP.toFixed(2)}%)</div>
    <div class="sc-bar"><div class="sc-bar-fill" style="width:${pos*100}%;background:${cls==='g'?'var(--green)':'var(--red)'}"></div></div>
    <div style="font-size:8px;color:var(--dim)">L ${d.low.toFixed(2)} · H ${d.high.toFixed(2)}</div>
  </div>`;
}
function addScreenerSymbol(){
  const s=$('sc-input').value.trim().toUpperCase();
  if(!s)return;
  if(scSyms.includes(s)){toast(s+' already in watchlist.');return;}
  scSyms.push(s);lss('zj4_sc',scSyms);$('sc-input').value='';renderScreener();
}
function removeWatchlistSymbol(sym){
  scSyms=scSyms.filter(s=>s!==sym);lss('zj4_sc',scSyms);renderScreener();toast(sym+' removed.');
}
function clearWatchlist(){
  if(!scSyms.length){toast('Watchlist is already empty.');return;}
  if(!confirm('Clear entire watchlist?'))return;
  scSyms=[];lss('zj4_sc',scSyms);renderScreener();toast('Watchlist cleared.');
}
function refreshScreener(){renderScreener();}
async function renderScreener(){
  $('sc-status').textContent='Loading…';
  if(!scSyms.length){
    $('screener-grid').innerHTML=`<div style="color:var(--dim);font-size:10px;padding:4px">No symbols in watchlist. Add one above.</div>`;
    $('sc-status').textContent='';loadMovers();return;
  }
  if(!apiKeys.finnhub){
    $('sc-status').textContent='Add Finnhub key in ⚙ API';
    $('screener-grid').innerHTML=scSyms.map(s=>`<div class="screener-card" style="position:relative"><button onclick="event.stopPropagation();removeWatchlistSymbol('${s}')" style="position:absolute;top:8px;right:8px;background:none;border:none;color:var(--ghost);font-size:13px;cursor:pointer;line-height:1;padding:0;transition:color 0.12s" onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--ghost)'">×</button><div class="sc-sym" style="padding-right:18px">${s}</div><div class="sc-price" style="color:var(--dim)">—</div></div>`).join('');
    loadMovers();return;
  }
  const results=await Promise.allSettled(scSyms.map(sym=>fetchQuote(sym)));
  const cards=results.map((r,i)=>{
    if(r.status==='fulfilled'&&r.value)return scCard(r.value,true);
    return`<div class="screener-card" style="position:relative"><button onclick="event.stopPropagation();removeWatchlistSymbol('${scSyms[i]}')" style="position:absolute;top:8px;right:8px;background:none;border:none;color:var(--ghost);font-size:13px;cursor:pointer;line-height:1;padding:0;transition:color 0.12s" onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--ghost)'">×</button><div class="sc-sym" style="padding-right:18px">${scSyms[i]}</div><div class="sc-price" style="color:var(--dim)">—</div></div>`;
  });
  $('screener-grid').innerHTML=cards.join('');
  $('sc-status').textContent='Updated '+new Date().toLocaleTimeString();
  loadMovers();
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   NEWS & CALENDAR & FEAR/GREED
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
let _newsCat='all';
let _allNews=[];

function setNewsCat(cat,btn){
  _newsCat=cat;
  document.querySelectorAll('.nf-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  renderNewsFeed();
}

function catFromNews(n){
  const h=(n.headline||'').toLowerCase()+(n.category||'');
  if(/bitcoin|ethereum|crypto|btc|eth|solana|defi|nft|blockchain/.test(h)) return 'crypto';
  if(/india|nifty|sensex|rbi|rupee|bse|nse/.test(h)) return 'india';
  if(/forex|eur|usd|gbp|currency|exchange rate/.test(h)) return 'forex';
  if(/stock|equity|earnings|ipo|shares|nasdaq|s&p/.test(h)) return 'equities';
  return 'macro';
}

function sentimentFromNews(n){
  const h=(n.headline||'').toLowerCase();
  if(/surges|rallies|jumps|gains|bullish|up|rises|breakout|record/.test(h)) return 'bull';
  if(/drops|falls|plunges|bearish|down|declines|crash|fear|selloff/.test(h)) return 'bear';
  return 'neut';
}

function sentimentLabel(s){
  if(s==='bull') return '▲ Bullish';
  if(s==='bear') return '▼ Bearish';
  return '◆ Neutral';
}

function timeAgo(ts){
  const diff=Math.floor((Date.now()-ts*1000)/1000);
  if(diff<3600) return Math.floor(diff/60)+'m ago';
  if(diff<86400) return Math.floor(diff/3600)+'h ago';
  return Math.floor(diff/86400)+'d ago';
}

function renderNewsFeed(){
  const el=$('news-list');
  if(!_allNews.length){
    el.innerHTML=`<div class="ni" style="text-align:center;padding:24px;color:var(--dim);font-size:10px;border:1px solid var(--rule);border-top:none;background:var(--paper)">No news loaded yet. Click ↻ to refresh.</div>`;
    return;
  }
  const filtered=_newsCat==='all'?_allNews:_allNews.filter(n=>n._cat===_newsCat);
  if(!filtered.length){
    el.innerHTML=`<div class="ni" style="text-align:center;padding:24px;color:var(--dim);font-size:10px;border:1px solid var(--rule);border-top:none;background:var(--paper)">No ${_newsCat} news found.</div>`;
    return;
  }
  el.innerHTML=filtered.slice(0,15).map(n=>{
    const s=sentimentFromNews(n),cat=n._cat;
    return`<div class="ni" onclick="window.open('${n.url}','_blank')">
      <div class="ni-top">
        <div class="ni-headline">${esc(n.headline)}</div>
        <span class="ni-sentiment ${s}">${sentimentLabel(s)}</span>
      </div>
      ${n.summary?`<div class="ni-body">${esc(n.summary.slice(0,180))}${n.summary.length>180?'…':''}</div>`:''}
      <div class="ni-foot">
        <span class="ni-cat ${cat}">${cat.toUpperCase()}</span>
        <span class="ni-source">${esc(n.source||'')}</span>
        <span class="ni-time">${timeAgo(n.datetime)}</span>
      </div>
    </div>`;
  }).join('');
}

async function loadNews(){
  const el=$('news-list');
  if(!apiKeys.finnhub){
    _allNews=DEMO_NEWS;
    _allNews.forEach(n=>{n._cat=catFromNews(n);});
    renderNewsFeed();
    return;
  }
  el.innerHTML=`<div class="ni" style="text-align:center;padding:20px;color:var(--dim);font-size:10px;border:1px solid var(--rule);border-top:none;background:var(--paper)">Loading…</div>`;
  try{
    const r=await fetch(`https://finnhub.io/api/v1/news?category=general&token=${apiKeys.finnhub}`);
    const data=await r.json();
    _allNews=(data||[]).slice(0,40);
    _allNews.forEach(n=>{n._cat=catFromNews(n);});
    renderNewsFeed();
  }catch{
    el.innerHTML=`<div class="ni" style="text-align:center;padding:20px;color:var(--red);font-size:10px;border:1px solid var(--rule);border-top:none;background:var(--paper)">Failed to load. Try again.</div>`;
  }
}

/* Calendar */
const COUNTRY_FLAGS={'US':'🇺🇸','GB':'🇬🇧','EU':'🇪🇺','IN':'🇮🇳','JP':'🇯🇵','CN':'🇨🇳','CA':'🇨🇦','AU':'🇦🇺','DE':'🇩🇪','FR':'🇫🇷'};

async function loadCalendar(){
  const el=$('cal-list');
  if(!apiKeys.finnhub){
    el.innerHTML=renderDemoCalendar();
    return;
  }
  el.innerHTML=`<div style="padding:14px;font-size:10px;color:var(--dim);text-align:center">Loading…</div>`;
  try{
    const now=new Date(),from=now.toISOString().slice(0,10),to=new Date(now.getTime()+7*86400000).toISOString().slice(0,10);
    const r=await fetch(`https://finnhub.io/api/v1/calendar/economic?from=${from}&to=${to}&token=${apiKeys.finnhub}`);
    const data=await r.json();
    const events=(data.economicCalendar||[]).slice(0,20);
    if(!events.length){el.innerHTML=`<div style="padding:14px;font-size:10px;color:var(--dim);text-align:center">No events for next 7 days.</div>`;return;}
    el.innerHTML=events.map(e=>{
      const imp=e.impact==='high'?'var(--red)':e.impact==='medium'?'var(--amber)':'var(--green)';
      const flag=COUNTRY_FLAGS[e.country]||'🌐';
      const dt=e.time?e.time.slice(0,10)+'\n'+e.time.slice(11,16):'—';
      return`<div class="cal-row">
        <div class="cal-time-col">${esc(e.time||'—').slice(0,10)}<br><span style="font-size:9px">${esc(e.time||'').slice(11,16)||''}</span></div>
        <div class="cal-imp" style="background:${imp}"></div>
        <span class="cal-flag">${flag}</span>
        <div style="flex:1"><div class="cal-ev-name">${esc(e.event||'')}</div><div class="cal-ev-sub">${esc(e.country||'')} · ${esc(e.unit||'')}</div></div>
        <div class="cal-right"><div class="cal-status">Pending</div><div class="cal-forecast">F: ${e.estimate||'—'}</div></div>
      </div>`;
    }).join('');
  }catch{el.innerHTML=`<div style="padding:14px;font-size:10px;color:var(--red);text-align:center">Failed. Try again.</div>`;}
}

function renderDemoCalendar(){
  const events=[
    {dt:'Mon 16/02',time:'08:30',flag:'🇮🇳',imp:'var(--amber)',name:'India WPI Inflation',sub:'February 2026',forecast:'3.2%'},
    {dt:'Tue 17/02',time:'08:30',flag:'🇺🇸',imp:'var(--amber)',name:'US Producer Price Index (PPI)',sub:'MoM February 2026',forecast:'0.3%'},
    {dt:'Tue 17/02',time:'19:00',flag:'🇺🇸',imp:'var(--red)',name:'FOMC Meeting Minutes',sub:'February 2026',forecast:'Hawkish hold'},
    {dt:'Wed 18/02',time:'09:30',flag:'🇬🇧',imp:'var(--amber)',name:'UK CPI YoY',sub:'February 2026',forecast:'2.8%'},
    {dt:'Wed 18/02',time:'14:30',flag:'🇪🇺',imp:'var(--amber)',name:'ECB Meeting Accounts',sub:'February 2026',forecast:'—'},
    {dt:'Thu 19/02',time:'08:30',flag:'🇺🇸',imp:'var(--green)',name:'US Initial Jobless Claims',sub:'Weekly',forecast:'218K'},
    {dt:'Thu 19/02',time:'10:00',flag:'🇮🇳',imp:'var(--amber)',name:'India Balance of Trade',sub:'February 2026',forecast:'-$23B'},
    {dt:'Fri 20/02',time:'08:30',flag:'🇺🇸',imp:'var(--amber)',name:'S&P Global US Manufacturing PMI',sub:'February 2026 Flash',forecast:'51.2'},
    {dt:'Fri 20/02',time:'09:45',flag:'🇺🇸',imp:'var(--green)',name:'US Services PMI',sub:'February 2026 Flash',forecast:'53.0'},
  ];
  return events.map(e=>`<div class="cal-row">
    <div class="cal-time-col">${e.dt}<br><span style="font-size:9px">${e.time}</span></div>
    <div class="cal-imp" style="background:${e.imp}"></div>
    <span class="cal-flag">${e.flag}</span>
    <div style="flex:1"><div class="cal-ev-name">${e.name}</div><div class="cal-ev-sub">${e.sub}</div></div>
    <div class="cal-right"><div class="cal-status">Pending</div><div class="cal-forecast">F: ${e.forecast}</div></div>
  </div>`).join('');
}

/* Fear & Greed */
async function loadFearGreed(){
  try{
    const r=await fetch('https://api.alternative.me/fng/?limit=4');
    const d=await r.json();
    const latest=d.data[0];
    const score=parseInt(latest.value);
    const label=latest.value_classification;
    const ts=new Date(latest.timestamp*1000).toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit',year:'numeric'});
    $('fg-score').textContent=score;
    $('fg-label').textContent=label;
    $('fg-score').style.color=fgColor(score);
    $('fg-label').style.color=fgColor(score);
    $('fg-updated').textContent='Updated '+ts;
    $('fg-bar').style.left=`calc(${score}% - 4px)`;
    drawFgGauge(score);
    // history
    const hist=d.data.slice(1,4);
    const labels=['Previous','1 Week Ago','1 Month Ago'];
    $('fg-history').innerHTML=hist.map((h,i)=>`<div class="fg-hist-row"><span>${labels[i]}</span><span class="fg-hist-val" style="color:${fgColor(parseInt(h.value))}">${h.value} (${h.value_classification})</span></div>`).join('');
  }catch{
    $('fg-updated').textContent='Unavailable';
    drawFgGauge(50);
  }
}

function fgColor(v){
  if(v<=25) return 'var(--red)';
  if(v<=45) return '#fb923c';
  if(v<=55) return 'var(--dim)';
  if(v<=75) return 'var(--amber2)';
  return 'var(--green)';
}

function drawFgGauge(score){
  const canvas=$('fg-canvas');if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const cx=130,cy=120,r=95;
  ctx.clearRect(0,0,260,140);
  // background arc
  const segments=[
    {from:Math.PI,to:Math.PI*1.2,color:'#f87171'},
    {from:Math.PI*1.2,to:Math.PI*1.4,color:'#fb923c'},
    {from:Math.PI*1.4,to:Math.PI*1.6,color:'#94a3b8'},
    {from:Math.PI*1.6,to:Math.PI*1.8,color:'#facc15'},
    {from:Math.PI*1.8,to:Math.PI*2,color:'#4ade80'},
  ];
  segments.forEach(s=>{
    ctx.beginPath();
    ctx.arc(cx,cy,r,s.from,s.to);
    ctx.arc(cx,cy,r-18,s.to,s.from,true);
    ctx.fillStyle=s.color+'33';
    ctx.fill();
    ctx.beginPath();
    ctx.arc(cx,cy,r,s.from,s.to);
    ctx.strokeStyle=s.color;
    ctx.lineWidth=3;
    ctx.stroke();
  });
  // needle
  const angle=Math.PI+(score/100)*Math.PI;
  const nx=cx+Math.cos(angle)*(r-10);
  const ny=cy+Math.sin(angle)*(r-10);
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.lineTo(nx,ny);
  ctx.strokeStyle=fgColor(score);
  ctx.lineWidth=2.5;
  ctx.lineCap='round';
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(cx,cy,5,0,Math.PI*2);
  ctx.fillStyle=fgColor(score);
  ctx.fill();
}

/* Demo news data for when no API key */
const DEMO_NEWS=[
  {headline:'Bitcoin consolidates near $95K after breaking above $100K for first time in months',summary:'BTC touched $101,200 on strong ETF inflows before retracing. Total ETF AUM now exceeds $110B. Options market shows $120K call as the next major target for March expiry.',source:'CoinDesk',datetime:Math.floor(Date.now()/1000)-25200,url:'#',category:'crypto'},
  {headline:'Ethereum Pectra upgrade scheduled for March — gas fee improvements expected',summary:'Ethereum dev team confirmed Pectra hard fork targeting March 2026. EIP-7702 account abstraction and blob fee improvements key highlights. ETH up 8% this week in anticipation.',source:'The Block',datetime:Math.floor(Date.now()/1000)-86400,url:'#',category:'crypto'},
  {headline:'Solana ecosystem TVL hits $15B — meme coins and DePIN drive activity surge',summary:'SOL DeFi TVL crossed $15B for first time. Decentralized Physical Infrastructure (DePIN) projects gaining traction. SOL up 22% YTD, outperforming ETH and BTC on a 3-month basis.',source:'DeFiLlama',datetime:Math.floor(Date.now()/1000)-259200,url:'#',category:'crypto'},
  {headline:'Federal Reserve signals two rate cuts in 2026 amid easing inflation data',summary:'Fed Chair comments suggest the committee is increasingly confident inflation is on track. Market now pricing 65% probability of June cut. US 10Y yield fell 8bps on the news.',source:'Reuters',datetime:Math.floor(Date.now()/1000)-43200,url:'#',category:'macro'},
  {headline:'RBI holds repo rate at 6.50% — signals accommodative stance going forward',summary:'Reserve Bank of India held rates for the fourth consecutive meeting. Governor noted India CPI eased to 4.8% in January. Next policy review scheduled April 7.',source:'Economic Times',datetime:Math.floor(Date.now()/1000)-72000,url:'#',category:'india'},
  {headline:'Nifty 50 hits record high as FII inflows return after three months of selling',summary:'Foreign institutional investors turned net buyers for the first time since October. IT and financial sectors led gains. Nifty closed above 23,500 for the first time.',source:'Moneycontrol',datetime:Math.floor(Date.now()/1000)-108000,url:'#',category:'india'},
  {headline:'EUR/USD breaks above 1.08 as ECB rate cut expectations recede',summary:'Euro strengthened after German IFO business climate surprised to the upside. EUR/USD now at 5-week high. ECB March cut probability dropped from 78% to 52%.',source:'FX Street',datetime:Math.floor(Date.now()/1000)-14400,url:'#',category:'forex'},
  {headline:'NVDA earnings beat sends chipmaker to $900B market cap — AI demand remains robust',summary:'Nvidia Q4 revenue came in at $22.1B, up 265% YoY. Data center segment alone contributed $18.4B. Management guided Q1 2026 revenue at $24B, above consensus.',source:'Bloomberg',datetime:Math.floor(Date.now()/1000)-36000,url:'#',category:'equities'},
];

/* Init news tab on load */
function initNews(){
  _allNews=DEMO_NEWS;
  _allNews.forEach(n=>{n._cat=catFromNews(n);});
  renderNewsFeed();
  loadCalendar();
  loadFearGreed();
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   LIVE MARKETS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
const US_INDICES=[
  {sym:'SPY', name:'S&P 500',     sub:'SPY ETF · Broad Market'},
  {sym:'QQQ', name:'NASDAQ 100',  sub:'QQQ ETF · Tech Heavy'},
  {sym:'DIA', name:'DOW JONES',   sub:'DIA ETF · Blue Chip'},
  {sym:'IWM', name:'RUSSELL 2000',sub:'IWM ETF · Small Cap'},
  {sym:'VIXY',name:'VIX',         sub:'CBOE Volatility'},
  {sym:'GLD', name:'GOLD',        sub:'GLD ETF'},
];
const US_MOVERS_SYMS=['AAPL','MSFT','NVDA','TSLA','AMZN','META','GOOGL','NFLX','AMD','PLTR','COIN','SPY','QQQ'];
const CRYPTO_IDS=['bitcoin','ethereum','binancecoin','solana','ripple','cardano','polkadot','chainlink'];
const CRYPTO_ICONS={bitcoin:'₿',ethereum:'Ξ',binancecoin:'B',solana:'◎',ripple:'✕',cardano:'₳',polkadot:'●',chainlink:'⬡'};
const FOREX_PAIRS=[
  {to:'INR',flag:'🇮🇳',name:'Indian Rupee'},
  {to:'EUR',flag:'🇪🇺',name:'Euro'},
  {to:'GBP',flag:'🇬🇧',name:'British Pound'},
  {to:'JPY',flag:'🇯🇵',name:'Japanese Yen'},
  {to:'AUD',flag:'🇦🇺',name:'Aus Dollar'},
  {to:'CAD',flag:'🇨🇦',name:'Canadian Dollar'},
  {to:'CHF',flag:'🇨🇭',name:'Swiss Franc'},
  {to:'SGD',flag:'🇸🇬',name:'Singapore Dollar'},
];
const COMMODITIES_IDS=['bitcoin','ethereum']; // placeholders; real commodities via CoinGecko commodity ids
const COMMOD_LIST=[
  {id:'gold',     name:'GOLD',      sub:'XAU · $/oz',  icon:'🥇'},
  {id:'silver',   name:'SILVER',    sub:'XAG · $/oz',  icon:'🥈'},
  {id:'crude-oil',name:'CRUDE OIL', sub:'WTI · $/bbl', icon:'🛢'},
  {id:'natural-gas',name:'NAT GAS', sub:'$/MMBtu',     icon:'💨'},
];

let _moversData={gainers:[],losers:[]};
let _moversTab='gainers';

async function renderLive(){
  $('live-api-note').style.display=apiKeys.finnhub?'none':'';
  loadCrypto();
  loadForex();
  loadCommodities();
  if(apiKeys.finnhub){loadUSIndices();loadUSMovers();}
  else{
    $('us-indices-list').innerHTML=`<div class="lm-row-loading">Add Finnhub key in ⚙ API</div>`;
    $('us-movers-list').innerHTML=`<div class="lm-row-loading">Add Finnhub key in ⚙ API</div>`;
  }
}

/* ── US INDICES ── */
async function loadUSIndices(){
  const list=$('us-indices-list');
  list.innerHTML=`<div class="lm-row-loading">Loading…</div>`;
  const results=await Promise.allSettled(US_INDICES.map(x=>fetchQuote(x.sym)));
  let tickerItems=[];
  list.innerHTML=US_INDICES.map((x,i)=>{
    const r=results[i];
    let priceStr='—',chgStr='—',chgCls='z';
    if(r.status==='fulfilled'&&r.value){
      const d=r.value,chg=d.price-d.prev,chgP=d.prev?chg/d.prev*100:0;
      chgCls=chg>=0?'g':'r';
      priceStr='$'+d.price.toFixed(2);
      chgStr=(chg>=0?'▲ +':'▼ ')+Math.abs(chgP).toFixed(2)+'%';
      tickerItems.push(`<span class="tick-item"><span class="tick-sym">${x.name}</span><span class="tick-price" style="margin:0 6px">${priceStr}</span><span class="tick-chg ${chgCls}">${chgStr}</span></span>`);
    }
    return`<div class="lm-row"><div><div class="lm-name">${x.name}</div><div class="lm-sub">${x.sub}</div></div><div class="lm-right"><div class="lm-price">${priceStr}</div><div class="lm-chg ${chgCls}">${chgStr}</div></div></div>`;
  }).join('');
  if(tickerItems.length){const d=tickerItems.concat(tickerItems);$('us-ticker-inner').innerHTML=d.join('');}
}

/* ── US MOVERS ── */
async function loadUSMovers(){
  $('us-movers-list').innerHTML=`<div class="lm-row-loading">Loading…</div>`;
  const results=await Promise.allSettled(US_MOVERS_SYMS.map(s=>fetchQuote(s)));
  const items=[];
  results.forEach((r,i)=>{
    if(r.status==='fulfilled'&&r.value){
      const d=r.value,chg=d.price-d.prev,chgP=d.prev?chg/d.prev*100:0;
      items.push({sym:US_MOVERS_SYMS[i],price:d.price,chg,chgP});
    }
  });
  _moversData.gainers=[...items].sort((a,b)=>b.chgP-a.chgP);
  _moversData.losers=[...items].sort((a,b)=>a.chgP-b.chgP);
  renderMoversTab();
}

function switchMoversTab(t){
  _moversTab=t;
  $('tab-gainers').classList.toggle('on',t==='gainers');
  $('tab-losers').classList.toggle('on',t==='losers');
  renderMoversTab();
}

function renderMoversTab(){
  const data=_moversData[_moversTab].slice(0,8);
  if(!data.length){$('us-movers-list').innerHTML=`<div class="lm-row-loading">No data yet.</div>`;return;}
  $('us-movers-list').innerHTML=data.map(d=>{
    const cls=d.chg>=0?'g':'r';
    const arr=d.chg>=0?'▲':'▼';
    return`<div class="lm-row"><div><div class="lm-name">${d.sym}</div><div class="lm-sub">NASDAQ · US</div></div><div class="lm-right"><div class="lm-price">$${d.price.toFixed(2)}</div><div class="lm-chg ${cls}">${arr} ${d.chg>=0?'+':''}${d.chgP.toFixed(2)}%</div></div></div>`;
  }).join('');
}

/* ── CRYPTO ── */
async function loadCrypto(){
  $('crypto-list').innerHTML=`<div class="lm-row-loading">Loading…</div>`;
  try{
    const ids=CRYPTO_IDS.join(',');
    const r=await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${ids}&order=market_cap_desc&sparkline=false&price_change_percentage=24h`);
    const data=await r.json();
    $('crypto-list').innerHTML=data.map(c=>{
      const chg=c.price_change_percentage_24h||0,cls=chg>=0?'g':'r';
      const icon=CRYPTO_ICONS[c.id]||'●';
      const arr=chg>=0?'▲':'▼';
      return`<div class="lm-row">
        <div class="lm-left"><div class="lm-icon" style="font-family:monospace;font-size:11px;color:var(--amber)">${icon}</div><div><div class="lm-name">${c.name}</div><div class="lm-sub">${c.symbol.toUpperCase()} · MCap $${fmtBig(c.market_cap)}</div></div></div>
        <div class="lm-right"><div class="lm-price">$${fmtPrice(c.current_price)}</div><div class="lm-chg ${cls}">${arr} ${chg>=0?'+':''}${chg.toFixed(2)}%</div></div>
      </div>`;
    }).join('');
  }catch{$('crypto-list').innerHTML=`<div class="lm-row-loading" style="color:var(--red)">Failed. Try again.</div>`;}
}

/* ── FOREX ── */
async function loadForex(){
  $('forex-list').innerHTML=`<div class="lm-row-loading">Loading…</div>`;
  try{
    const tos=FOREX_PAIRS.map(p=>p.to).join(',');
    const r=await fetch(`https://api.frankfurter.app/latest?from=USD&to=${tos}`);
    const data=await r.json();
    $('forex-list').innerHTML=FOREX_PAIRS.map(p=>{
      const rate=data.rates[p.to];
      const rateStr=rate!=null?rate.toFixed(p.to==='JPY'?2:4):'—';
      return`<div class="lm-row">
        <div class="lm-left"><div class="lm-icon" style="font-size:16px;background:none">${p.flag}</div><div><div class="lm-name">USD/${p.to}</div><div class="lm-sub">${p.name}</div></div></div>
        <div class="lm-right"><div class="lm-price">${rateStr}</div><div class="lm-chg z">Base: USD</div></div>
      </div>`;
    }).join('');
  }catch{$('forex-list').innerHTML=`<div class="lm-row-loading" style="color:var(--red)">Failed. Try again.</div>`;}
}

/* ── COMMODITIES ── */
async function loadCommodities(){
  $('commodities-list').innerHTML=`<div class="lm-row-loading">Loading…</div>`;
  try{
    const r=await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=gold,silver,crude-oil,natural-gas&order=market_cap_desc&sparkline=false&price_change_percentage=24h');
    const raw=await r.json();
    // Map what CoinGecko returns (may be empty for commodities), show static + dynamic
    const cgMap={};raw.forEach(x=>{cgMap[x.id]=x;});
    $('commodities-list').innerHTML=COMMOD_LIST.map(c=>{
      const d=cgMap[c.id];
      let priceStr='—',chgStr='—',cls='z';
      if(d){const chg=d.price_change_percentage_24h||0;cls=chg>=0?'g':'r';priceStr='$'+fmtPrice(d.current_price);chgStr=(chg>=0?'▲ +':'▼ ')+Math.abs(chg).toFixed(2)+'%';}
      return`<div class="lm-row">
        <div class="lm-left"><div class="lm-icon" style="background:none;font-size:16px">${c.icon}</div><div><div class="lm-name">${c.name}</div><div class="lm-sub">${c.sub}</div></div></div>
        <div class="lm-right"><div class="lm-price">${priceStr}</div><div class="lm-chg ${cls}">${chgStr}</div></div>
      </div>`;
    }).join('');
  }catch{
    // fallback: show rows with dashes
    $('commodities-list').innerHTML=COMMOD_LIST.map(c=>`<div class="lm-row"><div class="lm-left"><div class="lm-icon" style="background:none;font-size:16px">${c.icon}</div><div><div class="lm-name">${c.name}</div><div class="lm-sub">${c.sub}</div></div></div><div class="lm-right"><div class="lm-price">—</div><div class="lm-chg z">—</div></div></div>`).join('');
  }
}

function fmtPrice(p){if(!p)return'0.00';if(p>=1)return p.toFixed(2);if(p>=0.01)return p.toFixed(4);return p.toFixed(6);}
function fmtBig(n){if(!n)return'—';if(n>=1e12)return(n/1e12).toFixed(1)+'T';if(n>=1e9)return(n/1e9).toFixed(1)+'B';if(n>=1e6)return(n/1e6).toFixed(1)+'M';return n.toString();}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   STOCK SCREENER
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
const SC2_UNIVERSE = [
  // US Stocks
  {sym:'AAPL', name:'Apple',           market:'US', mktCls:'mkt-us'},
  {sym:'MSFT', name:'Microsoft',       market:'US', mktCls:'mkt-us'},
  {sym:'NVDA', name:'NVIDIA',          market:'US', mktCls:'mkt-us'},
  {sym:'TSLA', name:'Tesla',           market:'US', mktCls:'mkt-us'},
  {sym:'AMZN', name:'Amazon',          market:'US', mktCls:'mkt-us'},
  {sym:'META', name:'Meta',            market:'US', mktCls:'mkt-us'},
  {sym:'GOOGL',name:'Alphabet',        market:'US', mktCls:'mkt-us'},
  {sym:'NFLX', name:'Netflix',         market:'US', mktCls:'mkt-us'},
  {sym:'AMD',  name:'AMD',             market:'US', mktCls:'mkt-us'},
  {sym:'JPM',  name:'JPMorgan',        market:'US', mktCls:'mkt-us'},
  {sym:'CRWD', name:'CrowdStrike',     market:'US', mktCls:'mkt-us'},
  {sym:'PLTR', name:'Palantir',        market:'US', mktCls:'mkt-us'},
  {sym:'CRM',  name:'Salesforce',      market:'US', mktCls:'mkt-us'},
  {sym:'PANW', name:'Palo Alto Ntwks', market:'US', mktCls:'mkt-us'},
  {sym:'SPY',  name:'S&P 500 ETF',     market:'US', mktCls:'mkt-us'},
  {sym:'QQQ',  name:'NASDAQ 100 ETF',  market:'US', mktCls:'mkt-us'},
  // Crypto (via CoinGecko IDs for price, synthetic RSI)
  {sym:'BTC',  name:'Bitcoin',         market:'CRYPTO', mktCls:'mkt-cr', cgId:'bitcoin'},
  {sym:'ETH',  name:'Ethereum',        market:'CRYPTO', mktCls:'mkt-cr', cgId:'ethereum'},
  {sym:'SOL',  name:'Solana',          market:'CRYPTO', mktCls:'mkt-cr', cgId:'solana'},
  {sym:'BNB',  name:'BNB',            market:'CRYPTO', mktCls:'mkt-cr', cgId:'binancecoin'},
  {sym:'XRP',  name:'XRP',            market:'CRYPTO', mktCls:'mkt-cr', cgId:'ripple'},
  {sym:'ADA',  name:'Cardano',        market:'CRYPTO', mktCls:'mkt-cr', cgId:'cardano'},
  // Forex
  {sym:'EUR/USD',name:'Euro / USD',   market:'FOREX', mktCls:'mkt-fx'},
  {sym:'GBP/USD',name:'Pound / USD',  market:'FOREX', mktCls:'mkt-fx'},
  {sym:'USD/JPY',name:'USD / Yen',    market:'FOREX', mktCls:'mkt-fx'},
  {sym:'USD/INR',name:'USD / Rupee',  market:'FOREX', mktCls:'mkt-fx'},
];

let sc2Data = [];
let sc2SortKey = 'chg';
let sc2SortDir = -1;
let sc2ActivePreset = null;

const SC2_PRESETS = {
  oversold:   {rsiMin:0,   rsiMax:30,  chgMin:-100,chgMax:100, signal:'',         trend:'',          market:''},
  overbought: {rsiMin:70,  rsiMax:100, chgMin:-100,chgMax:100, signal:'',         trend:'',          market:''},
  strongbuy:  {rsiMin:50,  rsiMax:70,  chgMin:1,   chgMax:100, signal:'bullish',  trend:'uptrend',   market:''},
  bullmom:    {rsiMin:55,  rsiMax:80,  chgMin:0.5, chgMax:100, signal:'bullish',  trend:'',          market:''},
  highvol:    {rsiMin:0,   rsiMax:100, chgMin:2,   chgMax:100, signal:'',         trend:'',          market:''},
  cryptobull: {rsiMin:50,  rsiMax:100, chgMin:0,   chgMax:100, signal:'bullish',  trend:'',          market:'CRYPTO'},
  india:      {rsiMin:0,   rsiMax:100, chgMin:-100,chgMax:100, signal:'',         trend:'',          market:'IN'},
};

function initStockScreener(){
  if(sc2Data.length) renderSc2Table();
  else runScreener();
}

async function runScreener(){
  $('sc2-tbody').innerHTML=`<tr><td colspan="8" style="text-align:center;padding:24px;color:var(--dim);font-size:10px">Scanning…</td></tr>`;
  const items = [...SC2_UNIVERSE];
  // fetch Finnhub quotes for US stocks
  const usItems = items.filter(x=>x.market==='US');
  const cryptoItems = items.filter(x=>x.market==='CRYPTO');
  const forexItems = items.filter(x=>x.market==='FOREX');

  // US via Finnhub
  let usResults = [];
  if(apiKeys.finnhub){
    const res = await Promise.allSettled(usItems.map(x=>fetchQuote(x.sym)));
    usResults = res.map((r,i)=>{
      const base = usItems[i];
      if(r.status==='fulfilled'&&r.value&&r.value.price){
        const d=r.value, chg=d.price&&d.prev?(d.price-d.prev)/d.prev*100:0;
        const rsi = syntheticRSI(chg);
        return {...base, price:d.price, chg, rsi, live:true};
      }
      return {...base, price:null, chg:0, rsi:50, live:false};
    });
  } else {
    usResults = usItems.map(x=>({...x, price:null, chg:(Math.random()-0.4)*6, rsi:Math.floor(Math.random()*60+20), live:false}));
  }

  // Crypto via CoinGecko
  let cryptoResults = [];
  try{
    const cgIds = cryptoItems.map(x=>x.cgId).join(',');
    const r = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${cgIds}&order=market_cap_desc&sparkline=false&price_change_percentage=24h`);
    const data = await r.json();
    const cgMap = {};
    data.forEach(c=>{cgMap[c.id]=c;});
    cryptoResults = cryptoItems.map(x=>{
      const d = cgMap[x.cgId];
      if(d){const chg=d.price_change_percentage_24h||0; return {...x,price:d.current_price,chg,rsi:syntheticRSI(chg),live:true};}
      return {...x,price:null,chg:0,rsi:50,live:false};
    });
  }catch{
    cryptoResults = cryptoItems.map(x=>({...x,price:null,chg:(Math.random()-0.3)*8,rsi:Math.floor(Math.random()*60+20),live:false}));
  }

  // Forex via Frankfurter
  let forexResults = [];
  try{
    const r = await fetch('https://api.frankfurter.app/latest?from=USD&to=EUR,GBP,JPY,INR');
    const data = await r.json();
    forexResults = forexItems.map(x=>{
      const parts = x.sym.split('/');
      const base = parts[0], quote = parts[1];
      let rate = null;
      if(base==='USD' && data.rates[quote]) rate=data.rates[quote];
      else if(quote==='USD' && data.rates[base]) rate=1/data.rates[base];
      const chg = (Math.random()-0.5)*0.8; // forex has small daily moves
      return {...x, price:rate, chg, rsi:syntheticRSI(chg), live:!!rate};
    });
  }catch{
    forexResults = forexItems.map(x=>({...x,price:null,chg:(Math.random()-0.5)*0.5,rsi:Math.floor(Math.random()*30+40),live:false}));
  }

  sc2Data = [...usResults, ...cryptoResults, ...forexResults].map(x=>({
    ...x,
    macd: x.chg>0.5?'bullish':x.chg<-0.5?'bearish':'neutral',
    trend: x.chg>1?'uptrend':x.chg<-1?'downtrend':'ranging',
    vol: Math.random()>0.5?'High':'—',
  }));

  $('sc2-count').textContent=`— ${sc2Data.filter(x=>x.live).length} live`;
  renderSc2Table();
}

function syntheticRSI(chgPct){
  // map chg% to RSI: -5%=20, 0=50, +5%=80, clamp 10-90
  return Math.max(10, Math.min(90, Math.round(50 + chgPct*6)));
}

function applyPreset(key, btn){
  document.querySelectorAll('.sc2-preset').forEach(b=>b.classList.remove('on'));
  if(sc2ActivePreset===key){sc2ActivePreset=null;resetScreenerFilters();return;}
  sc2ActivePreset=key;
  btn.classList.add('on');
  const p=SC2_PRESETS[key];
  $('sc2-rsi-min').value=p.rsiMin;
  $('sc2-rsi-max').value=p.rsiMax;
  $('sc2-chg-min').value=p.chgMin;
  $('sc2-chg-max').value=p.chgMax;
  $('sc2-signal').value=p.signal;
  $('sc2-trend').value=p.trend;
  $('sc2-market').value=p.market;
  renderSc2Table();
}

function resetScreenerFilters(){
  sc2ActivePreset=null;
  document.querySelectorAll('.sc2-preset').forEach(b=>b.classList.remove('on'));
  $('sc2-rsi-min').value=0; $('sc2-rsi-max').value=100;
  $('sc2-chg-min').value=-100; $('sc2-chg-max').value=100;
  $('sc2-signal').value=''; $('sc2-trend').value=''; $('sc2-market').value='';
  renderSc2Table();
}

function sc2Sort(key){
  if(sc2SortKey===key) sc2SortDir*=-1;
  else{sc2SortKey=key; sc2SortDir=-1;}
  renderSc2Table();
}

function getFilters(){
  return {
    market:  $('sc2-market').value,
    signal:  $('sc2-signal').value,
    trend:   $('sc2-trend').value,
    rsiMin:  parseFloat($('sc2-rsi-min').value)||0,
    rsiMax:  parseFloat($('sc2-rsi-max').value)||100,
    chgMin:  parseFloat($('sc2-chg-min').value)||-100,
    chgMax:  parseFloat($('sc2-chg-max').value)||100,
  };
}

function renderSc2Table(){
  const f=getFilters();
  let rows=[...sc2Data];

  // filter
  rows=rows.filter(x=>{
    if(f.market && x.market!==f.market) return false;
    if(f.signal && x.macd!==f.signal) return false;
    if(f.trend  && x.trend!==f.trend)  return false;
    if(x.rsi<f.rsiMin||x.rsi>f.rsiMax) return false;
    if(x.chg<f.chgMin||x.chg>f.chgMax) return false;
    return true;
  });

  // sort
  rows.sort((a,b)=>{
    let va=a[sc2SortKey]??0, vb=b[sc2SortKey]??0;
    if(typeof va==='string') return va.localeCompare(vb)*sc2SortDir;
    return (va-vb)*sc2SortDir;
  });

  const tbody=$('sc2-tbody');
  if(!rows.length){
    tbody.innerHTML=`<tr><td colspan="8" style="text-align:center;padding:24px;color:var(--dim);font-size:10px">No instruments match the current filters.</td></tr>`;
    return;
  }

  tbody.innerHTML=rows.map(x=>{
    const chgCls=x.chg>=0?'g':'r';
    const rsiColor=x.rsi<=30?'var(--green)':x.rsi>=70?'var(--red)':'var(--blue)';
    const rsiW=Math.round(x.rsi);
    const macdHtml=x.macd==='bullish'?`<div class="macd-bull">▲<br>Bullish</div>`:x.macd==='bearish'?`<div class="macd-bear">▼<br>Bearish</div>`:`<div style="color:var(--dim);font-size:9px">—<br>Neutral</div>`;
    const trendHtml=x.trend==='uptrend'?`<span class="trend-up">↑ Uptrend</span>`:x.trend==='downtrend'?`<span class="trend-dn">↓ Downtrend</span>`:`<span class="trend-rg">— Ranging</span>`;
    const priceStr=x.price!=null?'$'+fmtPrice(x.price):'—';
    const livePill=x.live?`<span class="sc2-live-tag">LIVE</span>`:'';
    return`<tr>
      <td><span style="font-weight:500;font-size:11px;letter-spacing:0.02em">${esc(x.sym)}</span>${livePill}</td>
      <td><span class="mkt-badge ${x.mktCls}">${x.market}<br>STOCKS</span></td>
      <td style="font-size:11px">${priceStr}</td>
      <td class="${chgCls}" style="font-size:11px">${x.chg>=0?'+':''}${x.chg.toFixed(2)}%</td>
      <td>
        <span style="font-size:11px;margin-right:6px">${Math.round(x.rsi)}</span>
        <div class="rsi-bar-wrap"><div class="rsi-bar-fill" style="width:${rsiW}%;background:${rsiColor}"></div></div>
      </td>
      <td>${macdHtml}</td>
      <td style="color:var(--dim);font-size:9px">${x.vol||'—'}</td>
      <td>${trendHtml}</td>
    </tr>`;
  }).join('');
}


function openApiSettings(){sv('api-finnhub',apiKeys.finnhub||'');$('api-ov').classList.add('on');}
function closeApiSettings(){$('api-ov').classList.remove('on');}
function saveApiKeys(){apiKeys={finnhub:$('api-finnhub').value.trim()};lss('zj4_api',apiKeys);closeApiSettings();toast('API keys saved.');$('live-api-note').style.display=apiKeys.finnhub?'none':'';}
function clearApiKeys(){apiKeys={};lss('zj4_api',apiKeys);sv('api-finnhub','');toast('Keys cleared.');}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   BACKUP / RESTORE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
function exportJSON(){
  if(!trades.length){toast('Nothing to back up.');return;}
  const d={version:4,trades,rules,exported:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='zen-journal-'+new Date().toISOString().slice(0,10)+'.json';a.click();toast('Backed up.');
}
function importJSON(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.trades){trades=d.trades;saveTrades();}if(d.rules){rules=d.rules;saveRules();}renderDash();renderRules();toast('Restored.');}catch{toast('Could not read file.');}};
  r.readAsText(file);e.target.value='';
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   UTILS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
function $(id){return document.getElementById(id);}
function toggleCl(id){const e=$(id);if(e)e.classList.toggle('ck');}
function pf(id){return parseFloat($(id).value);}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function as(el){el.style.height='auto';el.style.height=el.scrollHeight+'px';}
let _tt;
function toast(msg){const el=$('toast');el.textContent=msg;el.classList.add('on');clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove('on'),2400);}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   KEYBOARD
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){closeEntry();closeDetail();closeApiSettings();}
  if((e.metaKey||e.ctrlKey)&&e.key==='Enter')saveTrade();
  if(e.key==='n'&&!e.metaKey&&!e.ctrlKey&&document.activeElement.tagName!=='INPUT'&&document.activeElement.tagName!=='TEXTAREA')openEntry();
});

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   INIT
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
renderDash();
window.addEventListener('resize',()=>{const s=[...trades.filter(t=>!t.passed)].sort((a,b)=>a.date.localeCompare(b.date));renderChart(s);});

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   CONFIRMATION TAB — Decision Engine (ported from index.html)
   Uses 010.html's `trades` array (zj4_trades) and styling.
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

/* helpers that mirror index.html's calcPnL/calcR/getStats/clamp */
function cPnL(t) {
  if (t.passed || t.pnl === null) return 0;
  return typeof t.pnl === 'number' ? t.pnl : 0;
}
function cCalcR(t) {
  if (!t.sl || t.entry === null || t.sl === t.entry) return null;
  const dir = t.direction === 'Long' ? 1 : -1;
  const risk = Math.abs(t.entry - t.sl) * (t.qty || 1);
  if (risk === 0) return null;
  return cPnL(t) / risk;
}
function cStats(arr) {
  const taken = arr.filter(t => !t.passed && t.pnl !== null);
  if (!taken.length) return { wr: 0, pf: 0, r: 0, total: 0 };
  const wins = taken.filter(t => t.pnl > 0);
  const losses = taken.filter(t => t.pnl <= 0);
  const gW = wins.reduce((s, t) => s + t.pnl, 0);
  const gL = Math.abs(losses.reduce((s, t) => s + t.pnl, 0));
  const rs = taken.map(cCalcR).filter(r => r !== null);
  return {
    wr:  taken.length ? wins.length / taken.length * 100 : 0,
    pf:  gL > 0 ? gW / gL : gW > 0 ? Infinity : 0,
    r:   rs.length ? rs.reduce((a, b) => a + b, 0) / rs.length : 0,
    total: taken.length
  };
}
function cConsecLoss() {
  const sorted = [...trades]
    .filter(t => !t.passed && t.pnl !== null)
    .sort((a, b) => b.date.localeCompare(a.date));
  let c = 0;
  for (const t of sorted) { if (t.pnl < 0) c++; else break; }
  return c;
}
function cClamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

/* ── renderConfirmation: called by goTo ────────────────────────────── */
function renderConfirmation() {
  /* pre-fill account with first sensible value found */
  const acc = $('c-account');
  if (acc && !acc.value) acc.value = '100000';
}

/* ── Fetch live quote (crypto via CoinGecko, stocks via stored Finnhub key) */
async function cFetchLive() {
  const symbol = ($('c-symbol').value || '').trim().toUpperCase();
  const mkt    = $('c-mkt').value;
  if (!symbol) { toast('Enter a symbol first'); return; }

  const liveBox = $('c-live-quote');
  liveBox.innerHTML = '<span style="color:var(--amber2)">🟡 Fetching live data for ' + symbol + '…</span>';
  $('c-live-status').textContent = '';

  /* Crypto via CoinGecko (no key needed) */
  if (mkt === 'Crypto') {
    const cgMap = { BTC:'bitcoin',ETH:'ethereum',SOL:'solana',BNB:'binancecoin',
                    XRP:'ripple',ADA:'cardano',AVAX:'avalanche-2',MATIC:'matic-network' };
    const base = symbol.replace('/USDT','').replace('/USD','');
    const cid  = cgMap[base];
    if (cid) {
      try {
        const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=' + cid +
          '&vs_currencies=usd&include_24hr_change=true');
        const d = await r.json();
        if (d[cid]) {
          const p   = d[cid].usd;
          const chg = (d[cid].usd_24h_change || 0).toFixed(2);
          liveBox.innerHTML =
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">' +
            '<div style="background:var(--raise);border-radius:2px;padding:8px;text-align:center"><div style="font-size:16px;font-weight:300;color:var(--amber2)">$' + p.toFixed(2) + '</div><div style="font-size:8px;color:var(--dim);margin-top:2px;text-transform:uppercase;letter-spacing:0.1em">Live Price</div></div>' +
            '<div style="background:var(--raise);border-radius:2px;padding:8px;text-align:center"><div style="font-size:16px;font-weight:300;color:' + (chg >= 0 ? 'var(--green)' : 'var(--red)') + '">' + (chg >= 0 ? '+' : '') + chg + '%</div><div style="font-size:8px;color:var(--dim);margin-top:2px;text-transform:uppercase;letter-spacing:0.1em">24h Change</div></div>' +
            '</div>';
          const en = $('c-entry'); if (en && !en.value) en.value = p.toFixed(2);
          return;
        }
      } catch(e) {}
    }
  }

  /* Stocks via stored Finnhub key */
  const fhKey = apiKeys.finnhub || '';
  if (fhKey && (mkt === 'NSE' || mkt === 'US Stocks')) {
    try {
      const r = await fetch('https://finnhub.io/api/v1/quote?symbol=' + encodeURIComponent(symbol) + '&token=' + fhKey);
      const q = await r.json();
      if (q && q.c) {
        const chg = q.pc ? ((q.c - q.pc) / q.pc * 100).toFixed(2) : '—';
        liveBox.innerHTML =
          '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px">' +
          '<div style="background:var(--raise);border-radius:2px;padding:8px;text-align:center"><div style="font-size:15px;font-weight:300;color:var(--amber2)">' + q.c.toFixed(2) + '</div><div style="font-size:8px;color:var(--dim);margin-top:2px;text-transform:uppercase;letter-spacing:0.1em">Live Price</div></div>' +
          '<div style="background:var(--raise);border-radius:2px;padding:8px;text-align:center"><div style="font-size:15px;font-weight:300;color:' + (parseFloat(chg) >= 0 ? 'var(--green)' : 'var(--red)') + '">' + (parseFloat(chg) >= 0 ? '+' : '') + chg + '%</div><div style="font-size:8px;color:var(--dim);margin-top:2px;text-transform:uppercase;letter-spacing:0.1em">Day Change</div></div>' +
          '<div style="background:var(--raise);border-radius:2px;padding:8px;text-align:center"><div style="font-size:12px;font-weight:300;color:var(--text)">' + q.h.toFixed(2) + ' / ' + q.l.toFixed(2) + '</div><div style="font-size:8px;color:var(--dim);margin-top:2px;text-transform:uppercase;letter-spacing:0.1em">H / L</div></div>' +
          '</div>';
        const en = $('c-entry'); if (en && !en.value) en.value = q.c.toFixed(2);
        return;
      }
    } catch(e) {}
  }

  liveBox.innerHTML = '<span style="color:var(--dim)">💡 Crypto works without a key · For stocks, add a Finnhub key via ⚙ API in the header</span>';
}

/* ── Main scoring engine (mirrors index.html runDecisionEngine exactly) */
function cAnalyse() {
  const symbol   = ($('c-symbol').value || '').trim();
  const dir      = $('c-dir').value;
  const mkt      = $('c-mkt').value;
  const entry    = parseFloat($('c-entry').value);
  const stop     = parseFloat($('c-stop').value);
  const target   = parseFloat($('c-target').value);
  const setup    = $('c-setup').value;
  const regime   = $('c-regime').value;
  const posSize  = parseFloat($('c-possize').value) || 1;
  const thesis   = ($('c-thesis').value || '').trim();

  if (!symbol) { toast('Enter a symbol first'); return; }

  const checks = [];
  let score = 0;

  /* Check 1 — Symbol */
  checks.push({ label: 'Symbol identified', status: 'pass', detail: symbol.toUpperCase() });
  score += 5;

  /* Check 2 — Entry & Stop */
  if (!isNaN(entry) && !isNaN(stop) && entry !== 0 && stop !== 0) {
    checks.push({ label: 'Entry & stop loss defined', status: 'pass', detail: 'Entry ' + entry + ' · Stop ' + stop });
    score += 15;
  } else {
    checks.push({ label: 'Entry & stop loss defined', status: 'fail', detail: 'Required for position sizing' });
  }

  /* Check 3 — Risk-Reward */
  let rr = null;
  if (!isNaN(entry) && !isNaN(stop) && !isNaN(target) && entry && stop) {
    const risk   = Math.abs(entry - stop);
    const reward = Math.abs(target - entry);
    rr = reward / (risk || 1);
    if (rr >= 2) {
      checks.push({ label: 'Risk-Reward ≥ 2:1', status: 'pass', detail: rr.toFixed(1) + ':1 — Acceptable edge' });
      score += 20;
    } else if (rr >= 1) {
      checks.push({ label: 'Risk-Reward < 2:1', status: 'warn', detail: rr.toFixed(1) + ':1 — Marginal (aim for 2:1+)' });
      score += 8;
    } else {
      checks.push({ label: 'Risk-Reward < 1:1', status: 'fail', detail: rr.toFixed(1) + ':1 — Do not take this trade' });
    }
  } else {
    checks.push({ label: 'Risk-Reward', status: 'warn', detail: 'Enter target price to calculate R:R' });
  }

  /* Check 4 — Position Sizing */
  if (posSize <= 1) {
    checks.push({ label: 'Position size ≤ 1% risk', status: 'pass', detail: posSize + '% of capital (within rules)' });
    score += 10;
  } else if (posSize <= 2) {
    checks.push({ label: 'Position size elevated', status: 'warn', detail: posSize + '% — exceeds 1% default risk rule' });
    score += 4;
  } else {
    checks.push({ label: 'Oversized position', status: 'fail', detail: posSize + '% — dangerously large. Scale down.' });
  }

  /* Check 5 — Setup historical edge */
  if (setup) {
    const st = trades.filter(t => !t.passed && t.setup === setup);
    if (st.length >= 5) {
      const wr5 = st.filter(t => t.pnl > 0).length / st.length * 100;
      if (wr5 >= 50) {
        checks.push({ label: 'Setup: ' + setup, status: 'pass', detail: wr5.toFixed(0) + '% win rate over ' + st.length + ' historical trades' });
        score += 15;
      } else {
        checks.push({ label: 'Setup: ' + setup, status: 'warn', detail: wr5.toFixed(0) + '% win rate — below 50% historically for you' });
        score += 5;
      }
    } else {
      checks.push({ label: 'Setup: ' + setup, status: 'warn', detail: 'Only ' + st.length + ' historical trades — sample too small to assess edge' });
      score += 8;
    }
  } else {
    checks.push({ label: 'Setup type not selected', status: 'fail', detail: 'Always know WHY you are taking a trade' });
  }

  /* Check 6 — Market Regime alignment */
  const regMap = {
    'Trending Bull':   { Long: 'pass', Short: 'warn' },
    'Trending Bear':   { Long: 'warn', Short: 'pass' },
    'Ranging':         { Long: 'warn', Short: 'warn' },
    'High Volatility': { Long: 'warn', Short: 'warn' },
    'Low Volatility':  { Long: 'pass', Short: 'pass' },
  };
  const regSt = (regMap[regime] || {})[dir] || 'warn';
  if (regSt === 'pass') {
    checks.push({ label: dir + ' in ' + regime, status: 'pass', detail: 'Direction aligns with market regime' });
    score += 10;
  } else {
    checks.push({ label: dir + ' in ' + regime, status: 'warn', detail: 'Counter-regime — requires stronger justification' });
    score += 3;
  }

  /* Check 7 — Consecutive losses */
  const consecLoss = cConsecLoss();
  if (consecLoss >= 3) {
    checks.push({ label: 'Revenge trade risk', status: 'fail', detail: consecLoss + ' consecutive losses — consider pausing. Rules say stop at 2.' });
    score -= 10;
  } else if (consecLoss === 2) {
    checks.push({ label: 'Consecutive loss warning', status: 'warn', detail: '2 losses in a row — review your edge before proceeding' });
  } else {
    checks.push({ label: 'Loss streak OK', status: 'pass', detail: consecLoss === 0 ? 'No recent losses' : consecLoss + ' recent loss — within acceptable range' });
    score += 10;
  }

  /* Check 8 — Trade thesis */
  if (thesis && thesis.length >= 20) {
    checks.push({ label: 'Trade thesis written', status: 'pass', detail: 'Structured thinking = better discipline' });
    score += 15;
  } else {
    checks.push({ label: 'Trade thesis missing', status: 'warn', detail: 'Write your reason — it forces clarity and accountability' });
    score += 4;
  }

  score = cClamp(score, 0, 100);

  /* Verdict */
  const verdict      = score >= 70 ? 'GO' : score >= 45 ? 'CAUTION' : 'NO-GO';
  const verdictClass = verdict === 'GO' ? 'go' : verdict === 'CAUTION' ? 'caution' : 'nogo';
  const verdictEmoji = verdict === 'GO' ? '🟢' : verdict === 'CAUTION' ? '🟡' : '🔴';
  const scoreColor   = score >= 70 ? '#4ade80' : score >= 45 ? '#d4a847' : '#f87171';

  /* Animate ring */
  const arc = $('c-arc');
  if (arc) {
    const circumference = 396;
    arc.style.strokeDashoffset = circumference - (score / 100) * circumference;
    arc.style.stroke = scoreColor;
  }
  const numEl = $('c-score-num');
  if (numEl) { numEl.textContent = score; numEl.style.color = scoreColor; }

  const vEl = $('c-verdict');
  if (vEl) {
    vEl.textContent = verdictEmoji + ' ' + verdict;
    vEl.className = 'de-verdict-badge ' + verdictClass;
    vEl.style.display = 'inline-flex';
  }

  $('c-checks').innerHTML = checks.map(c =>
    '<div class="de-check-row">' +
      '<div class="de-check-icon ' + c.status + '">' + (c.status === 'pass' ? '✓' : c.status === 'fail' ? '✗' : '!') + '</div>' +
      '<div><div style="font-weight:600;margin-bottom:2px">' + c.label + '</div>' +
      '<div style="font-size:10px;color:var(--dim)">' + c.detail + '</div></div>' +
    '</div>'
  ).join('');

  /* Historical setup stats */
  if (setup) {
    const st  = trades.filter(t => !t.passed && t.setup === setup);
    const sw  = st.filter(t => t.pnl > 0);
    const sl  = st.filter(t => t.pnl <= 0);
    const gW  = sw.reduce((s, t) => s + t.pnl, 0);
    const gL  = Math.abs(sl.reduce((s, t) => s + t.pnl, 0));
    const spf = gL > 0 ? (gW / gL).toFixed(2) : gW > 0 ? '∞' : '—';
    const rs  = st.map(cCalcR).filter(r => r !== null);
    const sr  = rs.length ? (rs.reduce((a, b) => a + b, 0) / rs.length).toFixed(2) : '—';
    const wrPct = st.length ? (sw.length / st.length * 100).toFixed(0) : null;

    const histWr = $('c-hist-wr');
    if (histWr) {
      histWr.textContent = wrPct !== null ? wrPct + '%' : '—';
      histWr.style.color = wrPct !== null ? (parseFloat(wrPct) >= 50 ? 'var(--green)' : 'var(--red)') : '';
    }
    const histPf = $('c-hist-pf');
    if (histPf) { histPf.textContent = st.length ? spf : '—'; }
    const histR = $('c-hist-r');
    if (histR) { histR.textContent = sr; histR.style.color = parseFloat(sr) > 0 ? 'var(--green)' : parseFloat(sr) < 0 ? 'var(--red)' : ''; }
    const histN = $('c-hist-n');
    if (histN) { histN.textContent = st.length; }
  }

  /* Store context for AI analysis */
  window._cCtx = { symbol, dir, mkt, entry, stop, target, setup, regime, rr, score, verdict, thesis, consecLoss };
  toast(verdictEmoji + ' ' + verdict + ' — ' + score + '/100');
}

/* ── AI Analysis (Claude API — matches index.html runAIAnalysis exactly) */
async function cAIAnalyse() {
  const ctx = window._cCtx;
  if (!ctx) { toast('Run the Decision Engine scoring first'); return; }

  const box = $('c-ai-output');
  const btn = $('c-ai-btn');
  if (btn) { btn.disabled = true; btn.textContent = 'Analysing…'; }

  box.innerHTML =
    '<div class="de-ai-badge"><span class="de-ai-dot"></span><span class="de-ai-dot"></span><span class="de-ai-dot"></span> Claude AI · Analysing</div>' +
    '<div style="margin-top:8px;font-size:11px;color:var(--dim)">Running structured trade analysis…</div>';

  const s = cStats(trades);
  const setupTrades = ctx.setup ? trades.filter(t => !t.passed && t.setup === ctx.setup) : [];
  const setupWR = setupTrades.length
    ? (setupTrades.filter(t => t.pnl > 0).length / setupTrades.length * 100).toFixed(0)
    : 'unknown';

  const prompt =
    'You are a systematic trading analyst using an institutional-grade risk framework. ' +
    'Analyse this specific trade setup concisely and precisely.\n\n' +
    'TRADER PROFILE:\n' +
    '- Total trades: ' + s.total + '\n' +
    '- Overall win rate: ' + s.wr.toFixed(1) + '%\n' +
    '- Profit factor: ' + s.pf.toFixed(2) + '\n' +
    '- Avg R-multiple: ' + s.r.toFixed(2) + 'R\n' +
    '- Consecutive losses: ' + ctx.consecLoss + '\n\n' +
    'PROPOSED TRADE:\n' +
    '- Symbol: ' + ctx.symbol + ' | Market: ' + ctx.mkt + ' | Direction: ' + ctx.dir + '\n' +
    '- Entry: ' + (ctx.entry || 'not specified') + ' | Stop: ' + (ctx.stop || 'not specified') + ' | Target: ' + (ctx.target || 'not specified') + '\n' +
    '- Risk-Reward: ' + (ctx.rr ? ctx.rr.toFixed(1) + ':1' : 'not calculated') + '\n' +
    '- Setup: ' + (ctx.setup || 'not specified') + '\n' +
    '- Market regime: ' + ctx.regime + '\n' +
    '- Systematic score: ' + ctx.score + '/100 → ' + ctx.verdict + '\n' +
    '- Thesis: "' + (ctx.thesis || 'none provided') + '"\n' +
    '- Historical win rate for this setup: ' + setupWR + '% (' + setupTrades.length + ' trades)\n\n' +
    'Provide a structured analysis with these EXACT sections:\n' +
    '1. **Setup Quality** (2-3 sentences: is the setup well-defined? Is the thesis clear?)\n' +
    '2. **Risk Assessment** (2-3 sentences: R:R adequacy, position sizing, stop placement logic)\n' +
    '3. **Edge Evaluation** (2-3 sentences: does historical data support this setup in this regime?)\n' +
    '4. **Psychological Flags** (1-2 sentences: any revenge trading, FOMO, or bias signals?)\n' +
    '5. **Improvement Suggestions** (2-3 specific, actionable improvements)\n' +
    '6. **Final Verdict** (1 sentence: GO / CAUTION / NO-GO with the single most important reason)\n\n' +
    'Be direct, specific, and institutional — no generic advice. Reference the actual numbers provided.';

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-6',
        max_tokens: 1000,
        messages: [{ role: 'user', content: prompt }],
      }),
    });
    const data = await response.json();
    if (data.error) throw new Error(data.error.message);

    const text = data.content?.map(b => b.text || '').join('') || 'No analysis returned.';
    const formatted = text
      .replace(/\*\*(.+?)\*\*/g, '<strong style="color:var(--text)">$1</strong>')
      .replace(/^(\d+\.\s)/gm, '<span style="color:var(--amber2);font-weight:600">$1</span>')
      .split('\n').filter(l => l.trim()).join('<br>');

    box.innerHTML =
      '<div class="de-ai-badge">✦ Claude AI Analysis</div>' +
      '<div style="margin-top:10px;line-height:1.9">' + formatted + '</div>' +
      '<div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--rule);font-size:9px;color:var(--dim)">' +
        'Analysis based on ' + s.total + ' journal trades · Score ' + ctx.score + '/100 · Generated ' + new Date().toLocaleTimeString() +
      '</div>';

  } catch(err) {
    box.innerHTML =
      '<div class="de-ai-badge" style="background:rgba(248,113,113,0.08);border-color:rgba(248,113,113,0.22);color:var(--red)">⚠ AI Unavailable</div>' +
      '<div style="margin-top:10px;font-size:11px;color:var(--text);line-height:1.8">' +
        '<strong>Systematic Score: ' + ctx.score + '/100 → ' + ctx.verdict + '</strong><br><br>' +
        'AI analysis requires an active Anthropic API connection. Your systematic score and checklist above provide the same framework.<br><br>' +
        '<strong>Key findings from your ' + s.total + ' trade history:</strong><br>' +
        '· Win rate: ' + s.wr.toFixed(1) + '% · Profit factor: ' + s.pf.toFixed(2) + '<br>' +
        '· This setup (' + (ctx.setup || 'unspecified') + '): ' + setupWR + '% win rate over ' + setupTrades.length + ' trades<br>' +
        '· Consecutive losses: ' + ctx.consecLoss + ' · R:R: ' + (ctx.rr ? ctx.rr.toFixed(1) + 'x' : 'not set') +
      '</div>';
  }

  if (btn) { btn.disabled = false; btn.textContent = '✦ Analyse →'; }
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   PWA BOOTSTRAP
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
(function() {
  /* ── 1. Generate icon PNGs via Canvas (no external files needed) ── */
  function makeIconDataURL(size) {
    const c = document.createElement('canvas');
    c.width = c.height = size;
    const ctx = c.getContext('2d');
    // Background
    ctx.fillStyle = '#060609';
    ctx.beginPath();
    ctx.roundRect(0, 0, size, size, size * 0.18);
    ctx.fill();
    // Amber circle accent
    const r = size * 0.38;
    ctx.beginPath();
    ctx.arc(size / 2, size / 2, r, 0, Math.PI * 2);
    ctx.strokeStyle = '#d4a847';
    ctx.lineWidth = size * 0.04;
    ctx.stroke();
    // "Z" letter
    ctx.fillStyle = '#f0c96a';
    ctx.font = `${size * 0.38}px EB Garamond, Georgia, serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fontStyle = 'italic';
    ctx.fillText('Z', size / 2 + size * 0.02, size / 2 + size * 0.03);
    return c.toDataURL('image/png');
  }

  /* Set icons once fonts may have loaded (slight delay is fine for icons) */
  function injectIcons() {
    const icon512 = makeIconDataURL(512);
    const icon192 = makeIconDataURL(192);
    const icon180 = makeIconDataURL(180);
    const icon32  = makeIconDataURL(32);
    document.getElementById('pwa-icon-apple').href  = icon180;
    document.getElementById('pwa-icon-192').href    = icon192;
    document.getElementById('pwa-icon-512').href    = icon512;
    document.getElementById('pwa-favicon').href     = icon32;

    /* ── 2. Inject Web App Manifest as Blob URL ── */
    const manifest = {
      name: 'Zen Journal',
      short_name: 'Zen Journal',
      description: 'A mindful trading journal — log trades, track rules, and grow.',
      start_url: './',
      display: 'standalone',
      orientation: 'portrait-primary',
      background_color: '#060609',
      theme_color: '#060609',
      categories: ['finance', 'productivity'],
      icons: [
        { src: icon192, sizes: '192x192', type: 'image/png', purpose: 'any maskable' },
        { src: icon512, sizes: '512x512', type: 'image/png', purpose: 'any maskable' }
      ],
      shortcuts: [
        { name: 'Log a Trade',    short_name: 'Log Trade',    description: 'Quickly log a new trade',        url: './#log',      icons: [{ src: icon192, sizes: '192x192' }] },
        { name: 'Pre-Market',     short_name: 'Pre-Market',   description: 'Open pre-market ritual',         url: './#premarket',icons: [{ src: icon192, sizes: '192x192' }] },
        { name: 'Daily Review',   short_name: 'Review',       description: 'Open daily review',              url: './#review',   icons: [{ src: icon192, sizes: '192x192' }] }
      ]
    };
    const blob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
    document.getElementById('pwa-manifest').href = URL.createObjectURL(blob);
  }

  /* Run after a short delay so canvas fonts are available */
  if (document.fonts) {
    document.fonts.ready.then(injectIcons);
  } else {
    setTimeout(injectIcons, 600);
  }

  /* ── 3. Register Service Worker (inline via Blob URL) ── */
  if ('serviceWorker' in navigator) {
    const CACHE  = 'zen-journal-v1';
    const swCode = `
const CACHE_NAME = '${CACHE}';
const OFFLINE_URLS = ['./'];

self.addEventListener('install', e => {
  self.skipWaiting();
  e.waitUntil(
    caches.open(CACHE_NAME).then(cache => cache.addAll(OFFLINE_URLS))
  );
});

self.addEventListener('activate', e => {
  e.waitUntil(
    caches.keys().then(keys =>
      Promise.all(keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k)))
    ).then(() => self.clients.claim())
  );
});

self.addEventListener('fetch', e => {
  /* Network-first for Google Fonts & APIs; cache-first for everything else */
  const url = e.request.url;
  if (url.includes('fonts.googleapis') || url.includes('fonts.gstatic') || url.includes('api.anthropic')) {
    e.respondWith(
      fetch(e.request).catch(() => caches.match(e.request))
    );
    return;
  }
  e.respondWith(
    caches.match(e.request).then(cached => {
      if (cached) return cached;
      return fetch(e.request).then(response => {
        if (!response || response.status !== 200 || response.type === 'opaque') return response;
        const clone = response.clone();
        caches.open(CACHE_NAME).then(cache => cache.put(e.request, clone));
        return response;
      }).catch(() => caches.match('./'));
    })
  );
});

/* Handle shortcut URL hash navigation via message */
self.addEventListener('message', e => {
  if (e.data && e.data.type === 'SKIP_WAITING') self.skipWaiting();
});
`;
    const swBlob = new Blob([swCode], { type: 'application/javascript' });
    const swURL  = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swURL, { scope: './' })
      .then(reg => {
        console.log('[PWA] Service Worker registered:', reg.scope);
        /* Check for updates on each visit */
        reg.addEventListener('updatefound', () => {
          const nw = reg.installing;
          nw.addEventListener('statechange', () => {
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              showUpdateBanner();
            }
          });
        });
      })
      .catch(err => console.warn('[PWA] SW registration failed:', err));
  }

  /* ── 4. Install Prompt ── */
  let _deferredInstall = null;
  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    _deferredInstall = e;
    showInstallBanner();
  });
  window.addEventListener('appinstalled', () => {
    hideInstallBanner();
    _deferredInstall = null;
    toast('✓ Zen Journal installed to home screen');
  });

  function showInstallBanner() {
    if (document.getElementById('pwa-install-bar')) return;
    const bar = document.createElement('div');
    bar.id = 'pwa-install-bar';
    bar.style.cssText = [
      'position:fixed','bottom:0','left:0','right:0','z-index:9999',
      'background:#0c0c14','border-top:1px solid rgba(212,168,71,0.25)',
      'display:flex','align-items:center','gap:12px','padding:11px 18px',
      'font-family:IBM Plex Mono,monospace','font-size:11px','color:#cccce0',
      'animation:pwa-slide-up 0.3s cubic-bezier(0.16,1,0.3,1)'
    ].join(';');
    bar.innerHTML =
      '<span style="flex:1">📲 Add <strong style="color:#f0c96a">Zen Journal</strong> to your home screen for offline access</span>' +
      '<button onclick="window._pwaInstall()" style="background:#d4a847;color:#060609;border:none;font-family:inherit;font-size:9px;font-weight:500;letter-spacing:0.1em;text-transform:uppercase;padding:6px 14px;border-radius:2px;cursor:pointer;white-space:nowrap">Install</button>' +
      '<button onclick="document.getElementById(\'pwa-install-bar\').remove()" style="background:none;border:none;color:#5a5a78;font-size:16px;cursor:pointer;padding:0 4px;line-height:1">×</button>';
    document.body.appendChild(bar);

    /* Inject animation keyframe once */
    if (!document.getElementById('pwa-anim-style')) {
      const s = document.createElement('style');
      s.id = 'pwa-anim-style';
      s.textContent = '@keyframes pwa-slide-up{from{transform:translateY(100%)}to{transform:translateY(0)}}';
      document.head.appendChild(s);
    }
  }

  function hideInstallBanner() {
    const b = document.getElementById('pwa-install-bar');
    if (b) b.remove();
  }

  window._pwaInstall = async function() {
    if (!_deferredInstall) return;
    _deferredInstall.prompt();
    const { outcome } = await _deferredInstall.userChoice;
    if (outcome === 'accepted') hideInstallBanner();
    _deferredInstall = null;
  };

  /* ── 5. Update available banner ── */
  function showUpdateBanner() {
    if (document.getElementById('pwa-update-bar')) return;
    const bar = document.createElement('div');
    bar.id = 'pwa-update-bar';
    bar.style.cssText = [
      'position:fixed','top:50px','left:0','right:0','z-index:9998',
      'background:#131320','border-bottom:1px solid rgba(212,168,71,0.2)',
      'display:flex','align-items:center','gap:12px','padding:9px 18px',
      'font-family:IBM Plex Mono,monospace','font-size:10px','color:#5a5a78'
    ].join(';');
    bar.innerHTML =
      '<span style="flex:1">⟳ A new version of Zen Journal is ready</span>' +
      '<button onclick="window.location.reload()" style="background:none;border:1px solid rgba(212,168,71,0.3);color:#d4a847;font-family:inherit;font-size:9px;padding:4px 12px;border-radius:2px;cursor:pointer;letter-spacing:0.08em">Reload</button>' +
      '<button onclick="this.parentElement.remove()" style="background:none;border:none;color:#5a5a78;font-size:16px;cursor:pointer;line-height:1">×</button>';
    document.body.appendChild(bar);
  }

  /* ── 6. Handle offline / online events ── */
  function onOffline() { toast('⚠ You are offline — data is saved locally'); }
  function onOnline()  { toast('✓ Back online'); }
  window.addEventListener('offline', onOffline);
  window.addEventListener('online',  onOnline);

})();
</script>
</body>
</html>
