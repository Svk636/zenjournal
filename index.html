<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#080810">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ZenJournal">
<meta name="mobile-web-app-capable" content="yes">
<title>Zen Trading Journal v8</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;450;500;600&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>

:root {
  --bg: #080810;
  --bg2: #0d0d18;
  --bg3: #121220;
  --bg4: #181828;
  --border: rgba(255,255,255,0.055);
  --border2: rgba(255,255,255,0.1);
  --text: #e2e2ee;
  --text2: #8a8aaa;
  --text3: #484868;
  --accent: #6c63ff;
  --accent2: #9d97ff;
  --green: #3ddc84;
  --green2: #22c55e;
  --red: #f56565;
  --red2: #ef4444;
  --yellow: #f6c90e;
  --cyan: #22d3ee;
  --orange: #fb923c;
  --radius: 10px;
  --radius2: 6px;
  --font-head: 'Instrument Serif', 'Georgia', serif;
  --font-body: 'Inter', system-ui, -apple-system, sans-serif;
  --font-mono: 'JetBrains Mono', 'Fira Code', ui-monospace, monospace;
  --shadow: 0 4px 32px rgba(0,0,0,0.5);
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  font-family:var(--font-body);
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
  line-height:1.5;
  font-size:13px;
}

::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}

/* ── HEADER ── */
header{
  background:rgba(8,8,16,0.96);
  backdrop-filter:blur(24px);
  position:sticky;top:0;z-index:100;
  border-bottom:1px solid var(--border);
}
.header-top{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 20px;gap:12px;
}
.logo{display:flex;align-items:center;gap:10px}
.logo-mark{
  width:30px;height:30px;
  background:var(--accent);
  border-radius:7px;
  display:flex;align-items:center;justify-content:center;
  font-size:15px;font-weight:400;color:white;
}
.logo-text{
  font-family:var(--font-head);font-size:20px;font-weight:400;
  color:var(--text);letter-spacing:-0.01em;
}
.logo-text span{color:var(--accent2)}
.header-actions{display:flex;gap:6px;align-items:center}

/* ── TABS ── */
.tab-bar-wrap{display:flex;align-items:stretch;background:var(--bg)}
.tab-scroll-btn{
  flex-shrink:0;width:32px;background:none;border:none;
  color:var(--text3);font-size:13px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:color 0.2s;border-right:1px solid var(--border);
}
.tab-scroll-btn.right{border-right:none;border-left:1px solid var(--border)}
.tab-scroll-btn:hover{color:var(--accent2)}
.tab-scroll-inner{
  flex:1;overflow-x:auto;scrollbar-width:none;
  -webkit-overflow-scrolling:touch;scroll-behavior:smooth;
}
.tab-scroll-inner::-webkit-scrollbar{display:none}
nav{display:flex;width:max-content;background:none;border:none;padding:0;gap:0}
.nav-btn{
  background:none;border:none;border-bottom:1.5px solid transparent;
  color:var(--text3);font-family:var(--font-body);font-size:12px;font-weight:450;
  padding:10px 14px;cursor:pointer;transition:all 0.15s;white-space:nowrap;
}
.nav-btn:hover{color:var(--text2);background:rgba(255,255,255,0.02)}
.nav-btn.active{color:var(--accent2);border-bottom-color:var(--accent);font-weight:500}

/* ── BUTTONS ── */
.btn{
  font-family:var(--font-body);font-size:12px;font-weight:500;
  padding:7px 14px;border-radius:var(--radius2);cursor:pointer;
  transition:all 0.18s;border:none;
  display:flex;align-items:center;gap:5px;
}
.btn-primary{background:var(--accent);color:white}
.btn-primary:hover{background:#7c75ff;transform:translateY(-1px);box-shadow:0 4px 16px rgba(108,99,255,0.35)}
.btn-ghost{background:var(--bg3);color:var(--text2);border:1px solid var(--border)}
.btn-ghost:hover{border-color:var(--border2);color:var(--text)}

/* ── MAIN ── */
main{max-width:1360px;margin:0 auto;padding:24px 24px}

/* ── VIEWS ── */
.view{display:none}
.view.active{display:block}

/* ── SECTION HEAD ── */
.section-head{
  display:flex;align-items:flex-start;justify-content:space-between;
  margin-bottom:24px;gap:16px;flex-wrap:wrap;
}
.section-title{font-family:var(--font-head);font-size:26px;font-weight:400;margin-bottom:3px}
.section-title span{color:var(--accent2)}
.section-sub{font-size:12px;color:var(--text3)}

/* ── STATS STRIP ── */
.stats-strip{
  display:grid;grid-template-columns:repeat(6,1fr);
  gap:10px;margin-bottom:24px;
}
.stat-card{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--radius);padding:18px;
  position:relative;overflow:hidden;transition:border-color 0.2s;
}
.stat-card:hover{border-color:var(--border2)}
.stat-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1.5px;
}
.stat-card.positive::before{background:var(--green)}
.stat-card.negative::before{background:var(--red)}
.stat-card.neutral::before{background:var(--accent)}
.stat-card.yellow::before{background:var(--yellow)}
.stat-card.cyan::before{background:var(--cyan)}
.stat-card.orange::before{background:var(--orange)}
.stat-label{font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:6px}
.stat-value{font-family:var(--font-mono);font-size:20px;font-weight:400;letter-spacing:-0.02em}
.stat-value.positive{color:var(--green)}
.stat-value.negative{color:var(--red)}
.stat-value.neutral{color:var(--text)}
.stat-sub{font-size:10px;color:var(--text3);margin-top:3px;font-family:var(--font-mono)}

/* ── DASHBOARD GRID ── */
.dashboard-grid{display:grid;grid-template-columns:1fr 320px;gap:16px;margin-bottom:16px}
.side-panels{display:flex;flex-direction:column;gap:12px}

/* ── PANEL ── */
.panel{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.panel-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 20px;border-bottom:1px solid var(--border);
}
.panel-title{font-size:13px;font-weight:500;color:var(--text)}
.panel-meta{font-size:11px;color:var(--text3);font-family:var(--font-mono)}

/* ── EQUITY CHART ── */
.chart-wrap{padding:20px;height:240px;position:relative}
canvas{display:block}

/* ── TRADE LIST ── */
.trade-list{padding:4px 0}
.trade-row{
  display:grid;grid-template-columns:76px 1fr auto auto auto;
  align-items:center;gap:10px;padding:10px 20px;
  border-bottom:1px solid var(--border);cursor:pointer;
  transition:background 0.12s;font-size:12px;
}
.trade-row:last-child{border-bottom:none}
.trade-row:hover{background:rgba(255,255,255,0.015)}
.trade-date{font-family:var(--font-mono);font-size:10px;color:var(--text3)}
.trade-symbol{font-family:var(--font-mono);font-weight:500;font-size:12px}
.trade-type{font-size:10px;color:var(--text3)}
.trade-tag{display:inline-block;padding:2px 7px;border-radius:3px;font-size:10px;font-weight:600;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:0.04em}
.tag-long{background:rgba(61,220,132,0.1);color:var(--green)}
.tag-short{background:rgba(245,101,101,0.1);color:var(--red)}
.trade-pnl{font-family:var(--font-mono);font-size:12px;font-weight:500;text-align:right;min-width:72px}
.trade-pnl.pos{color:var(--green)}
.trade-pnl.neg{color:var(--red)}

/* ── MINI STATS ── */
.mini-stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border)}
.mini-stat{background:var(--bg2);padding:14px}
.mini-stat-label{font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:5px}
.mini-stat-val{font-family:var(--font-mono);font-size:15px;font-weight:400}

/* ── HEATMAP ── */
.heatmap-grid{padding:14px 18px;display:flex;flex-direction:column;gap:3px}
.heatmap-row{display:flex;gap:2px;align-items:center}
.heatmap-label{width:26px;font-size:9px;color:var(--text3);font-family:var(--font-mono);text-align:right;padding-right:5px;flex-shrink:0}
.heatmap-cell{width:14px;height:14px;border-radius:2px;background:var(--bg4);cursor:default;transition:transform 0.1s;position:relative}
.heatmap-cell:hover{transform:scale(1.4);z-index:1}
.heatmap-cell.win-sm{background:rgba(61,220,132,0.2)}
.heatmap-cell.win-md{background:rgba(61,220,132,0.5)}
.heatmap-cell.win-lg{background:rgba(61,220,132,0.9)}
.heatmap-cell.loss-sm{background:rgba(245,101,101,0.2)}
.heatmap-cell.loss-md{background:rgba(245,101,101,0.5)}
.heatmap-cell.loss-lg{background:rgba(245,101,101,0.9)}

/* ── TABLE ── */
.table-wrap{overflow-x:auto;border-radius:var(--radius);border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;font-size:12px;background:var(--bg2)}
thead th{
  padding:12px 14px;text-align:left;font-size:10px;font-weight:600;
  text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);
  border-bottom:1px solid var(--border);background:var(--bg3);
  cursor:pointer;user-select:none;white-space:nowrap;
}
thead th:hover{color:var(--text2)}
tbody tr{border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.12s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:rgba(255,255,255,0.015)}
tbody td{padding:11px 14px;font-family:var(--font-mono);font-size:11px;color:var(--text2)}
tbody td:first-child{color:var(--text3)}
tbody td.symbol{color:var(--text);font-weight:500}
tbody td.pos{color:var(--green)}
tbody td.neg{color:var(--red)}

/* ── PAGINATION ── */
.pagination{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-top:1px solid var(--border);background:var(--bg3)}
#pageInfo{font-size:11px;color:var(--text3)}
.page-btns{display:flex;gap:4px}
.page-btn{background:var(--bg4);border:1px solid var(--border);color:var(--text2);font-size:11px;padding:4px 10px;border-radius:4px;cursor:pointer;font-family:var(--font-mono)}
.page-btn.active{background:var(--accent);color:white;border-color:var(--accent)}

/* ── FILTERS ── */
.filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
.filter-select,.filter-input{
  background:var(--bg2);border:1px solid var(--border);color:var(--text);
  font-family:var(--font-body);font-size:12px;padding:7px 10px;
  border-radius:var(--radius2);outline:none;transition:border-color 0.18s;cursor:pointer;
}
.filter-select:focus,.filter-input:focus{border-color:var(--accent)}
.filter-input{cursor:text;width:160px}
.filter-tag{
  padding:5px 11px;background:var(--bg2);border:1px solid var(--border);
  border-radius:16px;font-size:11px;color:var(--text2);cursor:pointer;transition:all 0.18s;
}
.filter-tag:hover,.filter-tag.active{background:var(--accent);color:white;border-color:var(--accent)}

/* ── MODAL ── */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.75);
  backdrop-filter:blur(10px);z-index:200;
  display:flex;align-items:center;justify-content:center;padding:20px;
  opacity:0;pointer-events:none;transition:opacity 0.2s;
}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{
  background:var(--bg2);border:1px solid var(--border2);border-radius:14px;
  width:100%;max-width:620px;max-height:90vh;overflow-y:auto;
  transform:translateY(16px) scale(0.98);
  transition:transform 0.22s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow:0 32px 80px rgba(0,0,0,0.7);
}
.modal-overlay.open .modal{transform:translateY(0) scale(1)}
.modal-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:20px 24px 16px;border-bottom:1px solid var(--border);
}
.modal-title{font-family:var(--font-head);font-size:18px;font-weight:400}
.modal-close{
  width:28px;height:28px;border-radius:6px;background:var(--bg3);
  border:1px solid var(--border);color:var(--text3);cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:14px;transition:all 0.18s;
}
.modal-close:hover{background:var(--bg4);color:var(--text)}
.modal-body{padding:20px 24px}

/* ── FORM ── */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.form-group{display:flex;flex-direction:column;gap:5px}
.form-group.full{grid-column:1/-1}
label{font-size:10px;font-weight:500;color:var(--text3);text-transform:uppercase;letter-spacing:0.05em}
input,select,textarea{
  background:var(--bg3);border:1px solid var(--border);color:var(--text);
  font-family:var(--font-body);font-size:13px;padding:9px 11px;
  border-radius:var(--radius2);outline:none;
  transition:border-color 0.18s,box-shadow 0.18s;width:100%;
}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(108,99,255,0.12)}
textarea{resize:vertical;min-height:72px;font-size:12px}
select option{background:var(--bg3)}
.form-footer{
  display:flex;gap:8px;justify-content:flex-end;margin-top:20px;
  padding-top:16px;border-top:1px solid var(--border);
}

/* ── SEGMENT CONTROL ── */
.segment-control{
  display:flex;background:var(--bg3);border:1px solid var(--border);
  border-radius:var(--radius2);padding:2px;gap:2px;
}
.seg-btn{
  flex:1;padding:7px;background:none;border:none;color:var(--text3);
  font-family:var(--font-body);font-size:12px;font-weight:500;
  cursor:pointer;border-radius:4px;transition:all 0.12s;
}
.seg-btn.active{background:var(--bg4);color:var(--text)}

/* ── ANALYTICS ── */
.analytics-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:16px}
.perf-chart-wrap{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.donut-wrap{position:relative;display:flex;align-items:center;justify-content:center;padding:20px;flex-direction:column;gap:14px}
.donut-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none}
.donut-value{font-family:var(--font-mono);font-size:22px;font-weight:400;color:var(--text);line-height:1}
.donut-label{font-size:10px;color:var(--text3);margin-top:3px}

/* ── EMPTY STATE ── */
.empty-state{text-align:center;padding:60px 32px;color:var(--text3)}
.empty-icon{font-size:36px;margin-bottom:12px;opacity:0.35}
.empty-title{font-family:var(--font-head);font-size:18px;font-weight:400;color:var(--text2);margin-bottom:6px}
.empty-sub{font-size:12px;color:var(--text3);margin-bottom:18px}

/* ── BADGES ── */
.badge{
  display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:3px;
  font-size:10px;font-weight:600;font-family:var(--font-mono);text-transform:uppercase;
}
.badge-options{background:rgba(108,99,255,0.15);color:var(--accent2)}
.badge-futures{background:rgba(246,201,14,0.15);color:var(--yellow)}
.badge-cash{background:rgba(34,211,238,0.15);color:var(--cyan)}
.badge-forex{background:rgba(251,146,60,0.15);color:var(--orange)}
.badge-crypto{background:rgba(61,220,132,0.15);color:var(--green)}
.badge-commodity{background:rgba(245,101,101,0.15);color:var(--red)}
.badge-nse{background:rgba(246,201,14,0.15);color:var(--yellow)}
.badge-index{background:rgba(34,211,238,0.15);color:var(--cyan)}
.badge-us-stocks{background:rgba(108,99,255,0.15);color:var(--accent2)}

/* ── SYMBOL AUTOCOMPLETE ── */
.sym-wrap{position:relative}
.sym-dropdown{
  position:absolute;top:calc(100% + 4px);left:0;right:0;
  background:var(--bg3);border:1px solid var(--border2);border-radius:var(--radius2);
  max-height:240px;overflow-y:auto;z-index:400;
  box-shadow:0 12px 40px rgba(0,0,0,0.6);display:none;
}
.sym-dropdown.open{display:block}
.sym-group-label{
  padding:7px 11px 4px;font-size:9px;font-weight:700;
  text-transform:uppercase;letter-spacing:0.1em;color:var(--text3);
  background:var(--bg4);position:sticky;top:0;border-bottom:1px solid var(--border);
}
.sym-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:8px 11px;cursor:pointer;transition:background 0.1s;
  border-bottom:1px solid var(--border);gap:8px;font-size:12px;
}
.sym-item:last-child{border-bottom:none}
.sym-item:hover,.sym-item.focused{background:rgba(108,99,255,0.1)}
.sym-item-left{display:flex;align-items:center;gap:8px}
.sym-ticker{font-family:var(--font-mono);font-size:12px;font-weight:500;color:var(--text);min-width:70px}
.sym-name{font-size:11px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px}
.sym-cat{font-size:9px;font-family:var(--font-mono);padding:2px 5px;border-radius:3px;background:var(--bg4);color:var(--text3)}

/* ── RISK ── */
.risk-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.rr-visual{display:flex;height:28px;border-radius:4px;overflow:hidden;margin:8px 0;font-size:10px;font-weight:700;font-family:var(--font-mono)}
.rr-risk{background:rgba(245,101,101,0.2);color:var(--red);display:flex;align-items:center;justify-content:center;min-width:30%}
.rr-reward{background:rgba(61,220,132,0.2);color:var(--green);flex:1;display:flex;align-items:center;justify-content:center}
.dd-meter{height:5px;background:var(--bg4);border-radius:3px;overflow:hidden}
.dd-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--yellow),var(--red));border-radius:3px;transition:width 0.8s}
.calc-result{background:var(--bg3);border-radius:var(--radius2);padding:16px;text-align:center;border:1px solid var(--border)}
.calc-result-val{font-family:var(--font-mono);font-size:28px;font-weight:400;margin-bottom:4px}
.calc-result-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em}
.rule-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:var(--radius2);border:1px solid var(--border);margin-bottom:8px;background:var(--bg3);cursor:pointer;transition:border-color 0.18s}
.rule-item:hover{border-color:var(--border2)}
.rule-check{width:18px;height:18px;border-radius:4px;border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;transition:all 0.18s}
.rule-check.checked{background:var(--green);border-color:var(--green);color:#000;font-weight:700}
.rule-text{flex:1;font-size:12px;color:var(--text2)}
.rule-badge{font-size:9px;font-family:var(--font-mono);padding:2px 7px;border-radius:3px;font-weight:700;flex-shrink:0}

/* ── CHECK ITEMS ── */
.check-item{display:flex;align-items:flex-start;gap:10px;padding:10px 14px;border:1px solid var(--border);border-radius:var(--radius2);margin-bottom:7px;background:var(--bg3);cursor:pointer;transition:all 0.15s}
.check-item:hover{border-color:var(--border2)}
.check-item.done{background:rgba(61,220,132,0.04);border-color:rgba(61,220,132,0.2)}
.check-box{width:18px;height:18px;border-radius:4px;border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;transition:all 0.18s;margin-top:1px}
.check-item.done .check-box{background:var(--green);border-color:var(--green);color:#000;font-weight:700}
.check-label{font-size:12px;color:var(--text);margin-bottom:2px}
.check-sub{font-size:10px;color:var(--text3)}

/* ── MOOD BUTTONS ── */
.mood-btn{font-size:22px;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.18s;line-height:1}
.mood-btn:hover{transform:scale(1.1)}
.mood-btn.selected{background:rgba(108,99,255,0.15);border-color:var(--accent);transform:scale(1.1)}

/* ── GRADE BUTTONS ── */
.grade-btns{display:flex;gap:6px;flex-wrap:wrap}
.grade-btn{padding:8px 16px;font-family:var(--font-mono);font-size:14px;font-weight:700;border-radius:var(--radius2);border:1px solid var(--border);background:var(--bg3);color:var(--text2);cursor:pointer;transition:all 0.18s}
.grade-btn.active-A{background:rgba(61,220,132,0.15);border-color:var(--green);color:var(--green)}
.grade-btn.active-B{background:rgba(108,99,255,0.15);border-color:var(--accent);color:var(--accent2)}
.grade-btn.active-C{background:rgba(246,201,14,0.15);border-color:var(--yellow);color:var(--yellow)}
.grade-btn.active-F{background:rgba(245,101,101,0.15);border-color:var(--red);color:var(--red)}

/* ── TOAST ── */
.toast-wrap{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px;max-width:300px}
.toast{
  display:flex;align-items:center;gap:10px;padding:10px 14px;
  border-radius:var(--radius2);font-size:12px;
  animation:slideIn 0.3s ease;box-shadow:0 4px 20px rgba(0,0,0,0.4);
}
.toast.success{background:rgba(61,220,132,0.15);border:1px solid rgba(61,220,132,0.3);color:var(--green)}
.toast.error{background:rgba(245,101,101,0.15);border:1px solid rgba(245,101,101,0.3);color:var(--red)}
.toast.info{background:rgba(108,99,255,0.15);border:1px solid rgba(108,99,255,0.3);color:var(--accent2)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:none;opacity:1}}
@keyframes fadeOut{to{transform:translateX(100%);opacity:0}}

/* ── IMPORT ZONE ── */
.import-zone{
  border:1px dashed var(--border2);border-radius:var(--radius);padding:32px;
  text-align:center;cursor:pointer;transition:all 0.18s;
}
.import-zone:hover,.import-zone.drag-over{border-color:var(--accent);background:rgba(108,99,255,0.04)}

/* ── PSYCHOLOGY ── */
.psych-grid{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:16px}
.bias-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);padding:14px;margin-bottom:10px}
.bias-title{font-size:12px;font-weight:600;margin-bottom:5px;display:flex;align-items:center;gap:6px}
.bias-desc{font-size:11px;color:var(--text3);line-height:1.5;margin-bottom:8px}
.bias-meter{height:3px;background:var(--bg4);border-radius:2px;overflow:hidden}
.bias-fill{height:100%;border-radius:2px}
.quote-block{background:var(--bg3);border-left:2px solid var(--accent);border-radius:0 var(--radius2) var(--radius2) 0;padding:18px 22px;margin-bottom:14px}
.quote-text{font-family:var(--font-head);font-size:15px;line-height:1.6;color:var(--text2)}
.quote-author{font-size:11px;color:var(--text3);margin-top:8px;font-family:var(--font-mono)}
.score-ring{width:110px;height:110px;position:relative;margin:0 auto 14px}
.score-ring svg{transform:rotate(-90deg)}
.score-ring-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.score-ring-val{font-family:var(--font-mono);font-size:26px;font-weight:400}
.score-ring-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em}
.emotion-log-item{display:flex;align-items:center;gap:10px;padding:9px 14px;border-bottom:1px solid var(--border);font-size:12px}
.emotion-log-item:last-child{border-bottom:none}

/* ── PHILOSOPHY ── */
.philosophy-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.pillar-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:20px;transition:border-color 0.2s}
.pillar-card:hover{border-color:var(--border2)}
.pillar-icon{font-size:26px;margin-bottom:10px}
.pillar-title{font-family:var(--font-head);font-size:15px;font-weight:400;margin-bottom:6px}
.pillar-body{font-size:12px;color:var(--text2);line-height:1.7}
.principle-list{list-style:none;padding:0;margin:0}
.principle-list li{padding:9px 0;border-bottom:1px solid var(--border);font-size:12px;color:var(--text2);display:flex;gap:8px;align-items:flex-start}
.principle-list li:last-child{border-bottom:none}
.principle-list li::before{content:'→';color:var(--accent2);flex-shrink:0;font-family:var(--font-mono)}
.legend-table{width:100%;border-collapse:collapse;font-size:12px}
.legend-table th{text-align:left;padding:9px 11px;background:var(--bg3);color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:0.06em;border-bottom:1px solid var(--border)}
.legend-table td{padding:10px 11px;border-bottom:1px solid var(--border);color:var(--text2);vertical-align:top}
.legend-table tr:last-child td{border-bottom:none}
.legend-table tr:hover td{background:rgba(255,255,255,0.015)}

/* ── RULES ── */
.rules-tabs{display:flex;gap:3px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:3px;margin-bottom:20px}
.rule-tab{background:none;border:none;color:var(--text3);font-family:var(--font-body);font-size:12px;font-weight:500;padding:7px 16px;border-radius:5px;cursor:pointer;transition:all 0.18s}
.rule-tab:hover{color:var(--text2)}
.rule-tab.active{background:var(--bg4);color:var(--text)}
.rules-section{display:none}
.rules-section.active{display:block}
.rule-category{margin-bottom:20px}
.rule-category-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--text3);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.editable-rule{display:flex;align-items:flex-start;gap:8px;padding:10px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);margin-bottom:7px;transition:border-color 0.18s}
.editable-rule:hover{border-color:var(--border2)}
.rule-num{font-family:var(--font-mono);font-size:10px;color:var(--text3);flex-shrink:0;padding-top:2px;min-width:22px}
.rule-content{flex:1;font-size:12px;color:var(--text);outline:none;cursor:text;line-height:1.5}
.rule-priority{font-size:9px;font-family:var(--font-mono);padding:2px 7px;border-radius:3px;flex-shrink:0}
.priority-must{background:rgba(245,101,101,0.15);color:var(--red)}
.priority-should{background:rgba(246,201,14,0.15);color:var(--yellow)}
.priority-can{background:rgba(61,220,132,0.15);color:var(--green)}
.add-rule-btn{background:none;border:1px dashed var(--border2);border-radius:var(--radius2);color:var(--text3);font-size:12px;padding:9px;width:100%;cursor:pointer;transition:all 0.18s;font-family:var(--font-body)}
.add-rule-btn:hover{border-color:var(--accent);color:var(--accent2)}

/* ── CALCULATORS ── */
.calc-tabs{display:flex;gap:3px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:3px;margin-bottom:20px;flex-wrap:wrap}
.calc-tab{background:none;border:none;color:var(--text3);font-family:var(--font-body);font-size:12px;font-weight:500;padding:6px 14px;border-radius:5px;cursor:pointer;transition:all 0.18s;white-space:nowrap}
.calc-tab:hover{color:var(--text2)}
.calc-tab.active{background:var(--bg4);color:var(--text)}
.calc-section{display:none}
.calc-section.active{display:block}
.calc-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.calc-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.calc-title{font-family:var(--font-head);font-size:15px;font-weight:400;margin-bottom:16px;display:flex;align-items:center;gap:7px}
.calc-input-row{display:flex;flex-direction:column;gap:3px;margin-bottom:12px}
.calc-input-row label{font-size:10px;color:var(--text3);font-weight:500;text-transform:uppercase;letter-spacing:0.05em}
.calc-input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);color:var(--text);font-family:var(--font-mono);font-size:13px;padding:8px 11px;outline:none;transition:border-color 0.18s}
.calc-input:focus{border-color:var(--accent)}
.calc-btn{width:100%;background:var(--accent);color:white;border:none;border-radius:var(--radius2);font-family:var(--font-body);font-size:13px;font-weight:600;padding:10px;cursor:pointer;transition:all 0.18s;margin-top:8px}
.calc-btn:hover{background:#7c75ff;transform:translateY(-1px)}
.calc-output{background:var(--bg3);border-radius:var(--radius2);padding:14px;margin-top:14px}
.calc-output-title{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:10px}
.calc-output-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px}
.calc-output-row:last-child{border-bottom:none}
.calc-output-val{font-family:var(--font-mono);font-weight:500}
.calc-output-val.highlight{color:var(--accent2);font-size:17px}
.networth-category{display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg3);border-radius:var(--radius2);margin-bottom:7px;cursor:pointer;border:1px solid var(--border);transition:border-color 0.18s}
.networth-category:hover{border-color:var(--border2)}
.nw-bar{height:3px;border-radius:2px;margin-top:7px;transition:width 0.6s}
.wealth-meter{background:var(--bg3);border-radius:var(--radius);padding:18px;margin-top:14px}
.wealth-bar-wrap{height:16px;background:var(--bg4);border-radius:8px;overflow:hidden;margin:10px 0}
.wealth-bar-fill{height:100%;border-radius:8px;background:linear-gradient(90deg,var(--accent),var(--cyan));transition:width 0.8s}
.milestone-row{display:flex;justify-content:space-between;font-size:11px;color:var(--text3);margin-bottom:3px}

/* ── SWOT ── */
.swot-grid{display:grid;grid-template-columns:1fr 1fr;gap:2px;margin-bottom:20px;border-radius:var(--radius);overflow:hidden;border:1px solid var(--border)}
.swot-quadrant{padding:20px;min-height:180px}
.swot-q-s{background:rgba(61,220,132,0.04);border-right:1px solid var(--border);border-bottom:1px solid var(--border)}
.swot-q-w{background:rgba(245,101,101,0.04);border-bottom:1px solid var(--border)}
.swot-q-o{background:rgba(34,211,238,0.04);border-right:1px solid var(--border)}
.swot-q-t{background:rgba(246,201,14,0.04)}
.swot-label{font-family:var(--font-head);font-size:12px;font-weight:400;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:12px;display:flex;align-items:center;gap:6px}
.swot-q-s .swot-label{color:var(--green)}
.swot-q-w .swot-label{color:var(--red)}
.swot-q-o .swot-label{color:var(--cyan)}
.swot-q-t .swot-label{color:var(--yellow)}
.swot-item{font-size:11px;color:var(--text2);padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;gap:7px;align-items:flex-start;line-height:1.5}
.swot-item:last-child{border-bottom:none}
.swot-q-s .swot-item::before{content:'✓';color:var(--green);font-size:9px;margin-top:2px;flex-shrink:0}
.swot-q-w .swot-item::before{content:'✗';color:var(--red);font-size:9px;margin-top:2px;flex-shrink:0}
.swot-q-o .swot-item::before{content:'◆';color:var(--cyan);font-size:8px;margin-top:3px;flex-shrink:0}
.swot-q-t .swot-item::before{content:'⚠';color:var(--yellow);font-size:9px;margin-top:2px;flex-shrink:0}

/* ── OVERVIEW ── */
.outlook-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
.outlook-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;transition:border-color 0.2s}
.outlook-card:hover{border-color:var(--border2)}
.timeframe-tabs{display:flex;gap:3px;flex-wrap:wrap;margin-bottom:16px}
.tf-btn{background:var(--bg2);border:1px solid var(--border);color:var(--text3);font-size:11px;padding:5px 12px;border-radius:16px;cursor:pointer;transition:all 0.18s;font-family:var(--font-body)}
.tf-btn:hover{color:var(--text2)}
.tf-btn.active{background:var(--accent);color:white;border-color:var(--accent)}
.forecast-section{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:16px}
.scenario-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px}
.scenario-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);padding:14px;transition:border-color 0.18s}
.scenario-card:hover{border-color:var(--border2)}
.news-grid{display:grid;grid-template-columns:1fr 340px;gap:16px;margin-bottom:16px}
.news-item{padding:14px 18px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.12s}
.news-item:hover{background:rgba(255,255,255,0.015)}
.screener-tag{display:inline-block;padding:4px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:14px;font-size:11px;color:var(--text2);cursor:pointer;transition:all 0.18s;font-family:var(--font-body)}
.screener-tag:hover,.screener-tag.active{background:var(--accent);color:white;border-color:var(--accent)}
.benchmark-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
.bm-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.bm-label{font-size:11px;color:var(--text3);margin-bottom:7px}
.bm-value{font-family:var(--font-mono);font-size:24px;font-weight:400;margin-bottom:3px}
.bm-vs{font-size:11px;color:var(--text3)}
.bm-vs span{color:var(--text2)}
.bm-bar{height:4px;background:var(--bg4);border-radius:2px;margin-top:12px;overflow:hidden}
.bm-bar-you{height:100%;background:var(--accent);border-radius:2px;transition:width 0.8s}

/* ── PREMARKET ── */
.pre-progress-bar{height:3px;background:var(--bg4);border-radius:2px;overflow:hidden;margin-top:8px}
.pre-progress-fill{height:100%;background:var(--green);border-radius:2px;transition:width 0.5s}
.adherence-item{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);font-size:12px}
.adherence-item:last-child{border-bottom:none}
.notes-area{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);color:var(--text);font-family:var(--font-body);font-size:12px;padding:9px 11px;width:100%;resize:vertical;min-height:80px;outline:none;transition:border-color 0.18s}
.notes-area:focus{border-color:var(--accent)}

/* ── DECISION ENGINE ── */
.ql-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px}
.ql-full{grid-column:1/-1}
.ql-section-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--text3);margin-bottom:12px;display:flex;align-items:center;gap:6px}
.de-score-ring{width:150px;height:150px;position:relative;margin:0 auto 18px}
.de-score-ring svg{transform:rotate(-90deg);overflow:visible}
.de-score-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.de-score-val{font-family:var(--font-mono);font-size:38px;font-weight:300;line-height:1}
.de-score-lbl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.1em;margin-top:3px}
.de-verdict{display:inline-block;padding:7px 22px;border-radius:50px;font-family:var(--font-head);font-size:15px;font-weight:400;letter-spacing:0.03em;text-transform:uppercase;margin-bottom:10px}
.de-verdict.go{background:rgba(61,220,132,0.1);color:var(--green);border:1px solid rgba(61,220,132,0.25)}
.de-verdict.nogo{background:rgba(245,101,101,0.1);color:var(--red);border:1px solid rgba(245,101,101,0.25)}
.de-verdict.caution{background:rgba(246,201,14,0.1);color:var(--yellow);border:1px solid rgba(246,201,14,0.25)}
.de-check-row{display:flex;align-items:center;gap:9px;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px}
.de-check-row:last-child{border-bottom:none}
.de-check-icon{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0;font-weight:700}
.de-check-icon.pass{background:rgba(61,220,132,0.15);color:var(--green)}
.de-check-icon.fail{background:rgba(245,101,101,0.15);color:var(--red)}
.de-check-icon.warn{background:rgba(246,201,14,0.15);color:var(--yellow)}
.de-input-group{display:flex;flex-direction:column;gap:4px;flex:1;min-width:100px}
.de-input-group label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em}
.de-input{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);color:var(--text);font-family:var(--font-mono);font-size:13px;padding:8px 11px;outline:none;width:100%}
.de-input:focus{border-color:var(--accent)}
.de-input-select{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);color:var(--text);font-family:var(--font-body);font-size:12px;padding:8px 11px;outline:none;width:100%;cursor:pointer}
.ai-analysis-box{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:18px;min-height:90px;font-size:12px;color:var(--text2);line-height:1.9}
.ai-badge{display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg,rgba(108,99,255,0.18),rgba(34,211,238,0.08));border:1px solid rgba(108,99,255,0.28);border-radius:16px;padding:3px 9px;font-size:9px;font-weight:700;color:var(--accent2);letter-spacing:0.05em;text-transform:uppercase;margin-bottom:8px}
@keyframes aiBlink{0%,100%{opacity:0.2}50%{opacity:1}}
.ai-dot{width:5px;height:5px;border-radius:50%;background:var(--accent);animation:aiBlink 1.2s infinite;display:inline-block;margin:0 2px}
.ai-dot:nth-child(2){animation-delay:.3s}.ai-dot:nth-child(3){animation-delay:.6s}
.factor-row{display:grid;grid-template-columns:120px 1fr 55px 65px;gap:8px;align-items:center;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px}
.factor-row:last-child{border-bottom:none}
.metric-trio{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.metric-box{background:var(--bg3);border-radius:var(--radius2);padding:14px;text-align:center;border:1px solid var(--border)}
.metric-box-val{font-family:var(--font-mono);font-size:22px;font-weight:400;margin-bottom:3px}
.metric-box-lbl{font-size:10px;color:var(--text3)}
.metric-box-sub{font-size:9px;color:var(--text3);margin-top:2px}
.stress-card{background:var(--bg3);border-radius:var(--radius2);padding:14px;border:1px solid var(--border);position:relative;overflow:hidden}
.stress-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.stress-card.crisis::before{background:var(--red)}
.stress-card.moderate::before{background:var(--yellow)}
.stress-card.recovery::before{background:var(--green)}

/* ── EMOTION TAGS ── */
.emotion-tag{
  padding:5px 11px;background:var(--bg3);border:1px solid var(--border);
  border-radius:16px;font-size:11px;color:var(--text2);cursor:pointer;
  transition:all 0.15s;user-select:none;
}
.emotion-tag.sm{padding:3px 9px;font-size:10px}
.emotion-tag:hover{border-color:var(--border2);color:var(--text)}
.emotion-tag.selected{background:rgba(108,99,255,0.15);border-color:var(--accent);color:var(--accent2)}
.emotion-tag[data-emotion="FOMO"].selected,
.emotion-tag[data-emotion="Revenge"].selected,
.emotion-tag[data-emotion="Anxious"].selected,
.emotion-tag[data-emotion="Overconfident"].selected,
.emotion-tag[data-emotion="Fearful"].selected,
.emotion-tag[data-emotion="Greedy"].selected,
.emotion-tag[data-emotion="Bored"].selected{background:rgba(245,101,101,0.1);border-color:rgba(245,101,101,0.35);color:var(--red)}
.emotion-tag[data-emotion="Calm"].selected,
.emotion-tag[data-emotion="Focused"].selected,
.emotion-tag[data-emotion="Confident"].selected,
.emotion-tag[data-emotion="Patient"].selected,
.emotion-tag[data-emotion="Disciplined"].selected{background:rgba(61,220,132,0.1);border-color:rgba(61,220,132,0.3);color:var(--green)}

/* ── BREATH GATE ── */
#breathGate{
  display:none;position:fixed;inset:0;z-index:9000;
  background:rgba(0,0,0,0.9);backdrop-filter:blur(20px);
  align-items:center;justify-content:center;flex-direction:column;gap:14px;
}
#breathGate.open{display:flex}
.breath-ring{
  width:110px;height:110px;border-radius:50%;
  border:1.5px solid rgba(108,99,255,0.3);
  display:flex;align-items:center;justify-content:center;
  animation:breathPulse 3s ease-in-out;
}
@keyframes breathPulse{
  0%{transform:scale(0.6);border-color:rgba(108,99,255,0.1)}
  50%{transform:scale(1.3);border-color:rgba(108,99,255,0.7)}
  100%{transform:scale(1);border-color:rgba(61,220,132,0.5)}
}
.breath-text{font-family:var(--font-head);font-size:16px;color:var(--text2);text-align:center}
.breath-sub{font-size:12px;color:var(--text3);text-align:center}

/* ── STREAK BADGE ── */
.streak-badge{
  display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:16px;
  font-size:10px;font-weight:700;background:rgba(246,201,14,0.1);
  color:var(--yellow);border:1px solid rgba(246,201,14,0.28);
}

/* ── NEWS FEED ── */
.news-feed-item{display:flex;align-items:flex-start;gap:12px;padding:14px 18px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.12s}
.news-feed-item:hover{background:rgba(255,255,255,0.018)}
.news-feed-item:last-child{border-bottom:none}
.news-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:5px}
.news-content{flex:1;min-width:0}
.news-headline{font-size:13px;color:var(--text);line-height:1.5;margin-bottom:5px}
.news-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.news-tag{padding:2px 7px;border-radius:3px;font-size:9px;font-weight:700;font-family:var(--font-mono);letter-spacing:0.04em}
.news-source{font-size:10px;color:var(--text3)}
.news-time{font-size:10px;color:var(--text3);font-family:var(--font-mono)}
.news-sentiment{font-size:10px;font-weight:700;white-space:nowrap;flex-shrink:0}

/* ── ECONOMIC CALENDAR ── */
.cal-item{display:grid;grid-template-columns:64px 22px 1fr auto;gap:10px;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border);transition:background 0.12s}
.cal-item:hover{background:rgba(255,255,255,0.015)}
.cal-item:last-child{border-bottom:none}
.cal-impact{width:4px;height:32px;border-radius:2px;flex-shrink:0}
.cal-impact.high{background:var(--red)}
.cal-impact.med{background:var(--yellow)}
.cal-impact.low{background:var(--text3)}
.cal-item-inner{display:grid;grid-template-columns:52px 22px 4px 1fr auto;gap:10px;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border)}
.cal-week-header{padding:8px 16px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text3);background:var(--bg3);border-bottom:1px solid var(--border)}
.impact-pill{display:inline-flex;align-items:center;gap:3px;font-size:9px;font-weight:700;font-family:var(--font-mono);text-transform:uppercase}
.impact-high{color:var(--red)}.impact-med{color:var(--yellow)}.impact-low{color:var(--text3)}

/* ── MARKET TICKER ── */
@keyframes tickerScroll{from{transform:translateX(0)}to{transform:translateX(-50%)}}
.ticker-track{display:flex;animation:tickerScroll 40s linear infinite;width:max-content}
.ticker-track:hover{animation-play-state:paused}
.ticker-item{display:flex;align-items:center;gap:8px;padding:0 20px;border-right:1px solid var(--border);white-space:nowrap;font-size:12px}
.ticker-sym{font-family:var(--font-mono);font-weight:600;color:var(--text)}
.ticker-price{font-family:var(--font-mono);color:var(--text2)}
.ticker-chg{font-family:var(--font-mono);font-weight:600;font-size:11px}
.ticker-chg.up{color:var(--green)}.ticker-chg.dn{color:var(--red)}

/* ── RATE MONITOR GRID ── */
.rate-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px}
@media(max-width:800px){.rate-grid{grid-template-columns:1fr 1fr}}
.rate-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;transition:border-color 0.2s;position:relative;overflow:hidden}
.rate-card:hover{border-color:var(--border2)}
.rate-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.rate-card.up::before{background:var(--green)}.rate-card.dn::before{background:var(--red)}.rate-card.flat::before{background:var(--text3)}
.rate-lbl{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:5px}
.rate-val{font-family:var(--font-mono);font-size:22px;font-weight:300;margin-bottom:2px}
.rate-chg{font-family:var(--font-mono);font-size:12px;font-weight:600}
.rate-next{font-size:10px;color:var(--text3);margin-top:4px}

/* ── FLOATING TICKER STRIP ── */
#floatingTicker {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  z-index: 500;
  background: rgba(8,8,16,0.97);
  backdrop-filter: blur(20px);
  border-top: 1px solid rgba(108,99,255,0.2);
  height: 36px;
  overflow: hidden;
  display: flex;
  align-items: center;
}
#floatingTicker .ft-label {
  flex-shrink: 0;
  padding: 0 12px;
  font-size: 9px;
  font-weight: 800;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--accent2);
  border-right: 1px solid var(--border);
  height: 100%;
  display: flex;
  align-items: center;
  background: rgba(108,99,255,0.08);
  white-space: nowrap;
}
#floatingTicker .ft-status-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--green);
  display: inline-block;
  margin-right: 5px;
  animation: ftPulse 2s ease-in-out infinite;
}
@keyframes ftPulse {
  0%,100%{opacity:1;transform:scale(1)}
  50%{opacity:0.4;transform:scale(0.7)}
}
#floatingTicker .ft-scroll-wrap {
  flex: 1;
  overflow: hidden;
  position: relative;
}
#floatingTicker .ft-track {
  display: flex;
  animation: ftScroll 60s linear infinite;
  width: max-content;
  will-change: transform;
}
#floatingTicker .ft-track:hover { animation-play-state: paused; }
@keyframes ftScroll {
  0% { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}
.ft-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 0 16px;
  border-right: 1px solid rgba(255,255,255,0.04);
  white-space: nowrap;
  font-size: 11px;
  height: 36px;
}
.ft-item .ft-sym { font-family: var(--font-mono); font-weight: 600; color: var(--text); font-size: 11px; }
.ft-item .ft-price { font-family: var(--font-mono); color: var(--text2); font-size: 11px; }
.ft-item .ft-chg { font-family: var(--font-mono); font-weight: 700; font-size: 10px; }
.ft-item .ft-chg.up { color: var(--green); }
.ft-item .ft-chg.dn { color: var(--red); }
.ft-item .ft-flag { font-size: 12px; }
.ft-section-sep {
  display: flex; align-items: center;
  padding: 0 8px; height: 36px;
  font-size: 9px; color: var(--text3);
  letter-spacing: 0.1em; text-transform: uppercase;
  border-right: 1px solid rgba(255,255,255,0.06);
  background: rgba(255,255,255,0.015);
}
body { padding-bottom: 36px; } /* prevent content hiding behind ticker */
#floatingTicker .ft-close {
  flex-shrink: 0;
  width: 28px; height: 36px;
  background: none; border: none; border-left: 1px solid var(--border);
  color: var(--text3); cursor: pointer; font-size: 14px;
  display: flex; align-items: center; justify-content: center;
}
#floatingTicker .ft-close:hover { color: var(--text); background: rgba(255,255,255,0.03); }
#floatingTicker .ft-angel-badge {
  flex-shrink: 0; padding: 0 10px; height: 36px;
  display: flex; align-items: center; gap: 5px;
  border-left: 1px solid var(--border);
  font-size: 9px; color: var(--text3); white-space: nowrap;
  cursor: pointer; transition: background 0.15s;
}
#floatingTicker .ft-angel-badge:hover { background: rgba(255,255,255,0.03); }
#floatingTicker .ft-angel-badge .ao-dot {
  width: 5px; height: 5px; border-radius: 50%; background: var(--text3);
}
#floatingTicker .ft-angel-badge .ao-dot.live { background: var(--green); animation: ftPulse 1.5s infinite; }

/* ── LIVE MARKETS VIEW ── */
.lm-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; margin-bottom: 20px; }
.lm-grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 14px; margin-bottom: 20px; }
.lm-grid-fo { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 20px; }
.lm-panel { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
.lm-panel-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 13px 16px; border-bottom: 1px solid var(--border);
  background: var(--bg3);
}
.lm-panel-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text3); display: flex; align-items: center; gap: 7px; }
.lm-panel-status { font-size: 10px; font-family: var(--font-mono); }
.lm-panel-body { padding: 14px 16px; }
.lm-index-card {
  display: flex; align-items: center; justify-content: space-between;
  padding: 11px 16px; border-bottom: 1px solid var(--border);
  transition: background 0.12s; cursor: default;
}
.lm-index-card:last-child { border-bottom: none; }
.lm-index-card:hover { background: rgba(255,255,255,0.015); }
.lm-index-name { font-size: 12px; font-weight: 600; color: var(--text); }
.lm-index-sub { font-size: 10px; color: var(--text3); margin-top: 1px; }
.lm-index-price { font-family: var(--font-mono); font-size: 14px; font-weight: 500; text-align: right; }
.lm-index-chg { font-family: var(--font-mono); font-size: 11px; font-weight: 700; text-align: right; }
.lm-index-chg.up { color: var(--green); }
.lm-index-chg.dn { color: var(--red); }
.lm-mini-bar { height: 2px; border-radius: 1px; margin-top: 4px; background: var(--bg4); overflow: hidden; }
.lm-mini-bar-fill { height: 100%; border-radius: 1px; }
.fo-chain-header {
  display: grid; grid-template-columns: 80px 60px 60px 1fr 80px 60px 60px;
  gap: 6px; padding: 8px 14px; font-size: 9px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.07em; color: var(--text3);
  border-bottom: 1px solid var(--border); background: var(--bg3);
}
.fo-chain-row {
  display: grid; grid-template-columns: 80px 60px 60px 1fr 80px 60px 60px;
  gap: 6px; padding: 7px 14px; border-bottom: 1px solid var(--border);
  font-size: 11px; align-items: center; font-family: var(--font-mono);
  transition: background 0.1s;
}
.fo-chain-row:hover { background: rgba(255,255,255,0.02); }
.fo-chain-row:last-child { border-bottom: none; }
.fo-strike { font-weight: 700; text-align: center; font-size: 12px; background: rgba(108,99,255,0.08); border-radius: 4px; padding: 3px 6px; }
.fo-strike.atm { background: rgba(108,99,255,0.25); color: var(--accent2); }
.fo-call { color: var(--green); } .fo-put { color: var(--red); }
.fo-oi-bar { height: 3px; border-radius: 2px; margin-top: 3px; }
.lm-crypto-card {
  display: flex; align-items: center; gap: 12px; padding: 10px 16px;
  border-bottom: 1px solid var(--border); transition: background 0.12s;
}
.lm-crypto-card:last-child { border-bottom: none; }
.lm-crypto-card:hover { background: rgba(255,255,255,0.015); }
.lm-crypto-icon { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
.lm-crypto-name { font-size: 12px; font-weight: 600; }
.lm-crypto-sub { font-size: 10px; color: var(--text3); }
.lm-forex-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 9px 16px; border-bottom: 1px solid var(--border); font-size: 12px;
}
.lm-forex-row:last-child { border-bottom: none; }
.angel-config-box {
  background: linear-gradient(135deg, rgba(108,99,255,0.1), rgba(34,211,238,0.05));
  border: 1px solid rgba(108,99,255,0.25);
  border-radius: var(--radius); padding: 20px;
  margin-bottom: 20px;
}
.lm-connection-strip {
  display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
  padding: 10px 16px; margin-bottom: 16px;
  background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius);
  font-size: 11px;
}
.lm-conn-item { display: flex; align-items: center; gap: 6px; padding: 5px 10px; border-radius: 20px; background: var(--bg3); border: 1px solid var(--border); }
.lm-conn-dot { width: 7px; height: 7px; border-radius: 50%; }
.lm-conn-dot.live { background: var(--green); animation: ftPulse 1.5s infinite; }
.lm-conn-dot.offline { background: var(--text3); }
.lm-conn-dot.loading { background: var(--yellow); animation: ftPulse 0.8s infinite; }
.pcr-meter { background: var(--bg3); border-radius: var(--radius2); padding: 12px; margin-bottom: 10px; }
.pcr-bar-wrap { height: 8px; background: var(--bg4); border-radius: 4px; overflow: hidden; margin: 8px 0; position: relative; }
.pcr-bar-fill { height: 100%; border-radius: 4px; }
@media(max-width:1100px){ .lm-grid{grid-template-columns:1fr 1fr} }
@media(max-width:768px){ .lm-grid{grid-template-columns:1fr} .lm-grid-2{grid-template-columns:1fr} .lm-grid-fo{grid-template-columns:1fr} }

/* ── ANGEL ONE OVERLAY ── */
#angelOneOverlay {
  display:none; position:fixed; inset:0; z-index:700;
  align-items:center; justify-content:center;
  background:rgba(0,0,0,0.8); backdrop-filter:blur(16px); padding:20px;
}
#angelOneOverlay.open { display:flex; }
.ao-form-input {
  width:100%; background:var(--bg3); border:1px solid var(--border);
  border-radius:var(--radius2); color:var(--text); font-family:var(--font-mono);
  font-size:13px; padding:10px 12px; outline:none; transition:border-color 0.2s;
  box-sizing: border-box;
}
.ao-form-input:focus { border-color:var(--accent); }

/* ── SIGNAL BADGES ── */
.signal-badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:10px;font-weight:700;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:0.04em}
.signal-strong-buy{background:rgba(61,220,132,0.2);color:#4ade80;border:1px solid rgba(61,220,132,0.35)}
.signal-buy{background:rgba(61,220,132,0.1);color:var(--green);border:1px solid rgba(61,220,132,0.2)}
.signal-neutral{background:var(--bg4);color:var(--text3);border:1px solid var(--border)}
.signal-sell{background:rgba(245,101,101,0.1);color:var(--red);border:1px solid rgba(245,101,101,0.2)}
.signal-strong-sell{background:rgba(245,101,101,0.2);color:#f87171;border:1px solid rgba(245,101,101,0.35)}

/* ── OUTLOOK CARDS ── */
.outlook-asset{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:4px}
.outlook-price{font-family:var(--font-mono);font-size:18px;font-weight:400;margin-bottom:2px}
.outlook-chg{font-family:var(--font-mono);font-size:13px;font-weight:600;margin-bottom:8px}
.outlook-chg.pos{color:var(--green)}.outlook-chg.neg{color:var(--red)}
.outlook-bar{height:3px;background:var(--bg4);border-radius:2px;overflow:hidden}
.outlook-bar-fill{height:100%;border-radius:2px;transition:width 0.8s}

/* ── SCENARIO CARDS ── */
.scenario-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);padding:14px;transition:border-color 0.18s}
.scenario-card:hover{border-color:var(--border2)}
.scenario-title{font-family:var(--font-head);font-size:14px;font-weight:400;margin-bottom:4px}
.scenario-prob{font-family:var(--font-mono);font-size:22px;font-weight:300;margin-bottom:6px}
.scenario-desc{font-size:11px;color:var(--text3);line-height:1.5}

/* ── PHASE INDICATORS ── */
.phase-indicator{display:flex;align-items:flex-start;gap:10px}
.phase-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:5px}

/* ── CAL / NEWS ── */
.cal-row{display:grid;grid-template-columns:50px 20px 1fr auto;gap:10px;align-items:center;padding:9px 16px;border-bottom:1px solid var(--border);font-size:12px}
.cal-time{font-family:var(--font-mono);font-size:10px;color:var(--text3)}
.cal-country{font-size:10px;font-weight:700;color:var(--text3)}
.cal-event-name{font-size:12px;color:var(--text)}
.cal-event-sub{font-size:10px;color:var(--text3);margin-top:2px}
.cal-vals{display:flex;flex-direction:column;align-items:flex-end;gap:2px;font-family:var(--font-mono);font-size:11px}
.cal-actual.beat{color:var(--green)}.cal-actual.miss{color:var(--red)}.cal-actual.inline{color:var(--text2)}

/* ── CONVICTION / BLACKROCK ── */
.conviction-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
.conviction-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);padding:14px;transition:border-color 0.18s}
.conviction-card:hover{border-color:var(--border2)}
.conviction-asset{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--text3);margin-bottom:3px}
.conviction-call{font-family:var(--font-head);font-size:14px;font-weight:400;margin-bottom:5px}
.conviction-call.overweight{color:var(--green)}
.conviction-call.underweight{color:var(--red)}
.conviction-call.neutral{color:var(--yellow)}
.conviction-reason{font-size:11px;color:var(--text3);line-height:1.5}
.conviction-bar{height:2px;border-radius:2px;margin-top:9px}
.blackrock-section{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px}
.blackrock-header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.blackrock-logo{width:36px;height:36px;background:#0a0a0a;border-radius:6px;display:flex;align-items:center;justify-content:center;font-family:var(--font-mono);font-size:9px;font-weight:700;color:#ffd700;letter-spacing:-0.5px;flex-shrink:0;border:1px solid rgba(255,215,0,0.15)}
.blackrock-title{font-family:var(--font-head);font-size:15px;font-weight:400}
.blackrock-sub{font-size:11px;color:var(--text3);margin-top:1px}
.opp-item{display:flex;gap:12px;padding:12px;background:var(--bg3);border-radius:var(--radius2);border:1px solid var(--border);border-left:2px solid;transition:border-color 0.18s}
.opp-item.buy{border-left-color:var(--green)}
.opp-item.watch{border-left-color:var(--yellow)}
.opp-item.avoid{border-left-color:var(--red)}
.opp-meta{display:flex;flex-direction:column;align-items:center;gap:3px;min-width:55px}
.opp-signal{font-size:9px;font-family:var(--font-mono);font-weight:700;text-transform:uppercase}
.opp-signal.buy{color:var(--green)}.opp-signal.watch{color:var(--yellow)}.opp-signal.avoid{color:var(--red)}
.opp-ticker{font-family:var(--font-mono);font-size:13px;font-weight:500}
.opp-body{flex:1}
.opp-name{font-size:12px;font-weight:600;margin-bottom:3px}
.opp-desc{font-size:11px;color:var(--text3);line-height:1.5}
.opp-tags{display:flex;gap:5px;margin-top:7px;flex-wrap:wrap}
.opp-tag{font-size:9px;font-family:var(--font-mono);padding:2px 7px;border-radius:3px;background:var(--bg4);color:var(--text3)}
.decade-timeline{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px}
.decade-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;text-align:center;transition:all 0.18s;cursor:pointer}
.decade-card:hover{border-color:var(--accent);transform:translateY(-2px)}
.decade-year{font-family:var(--font-mono);font-size:10px;color:var(--text3);margin-bottom:7px}
.decade-val{font-family:var(--font-mono);font-size:17px;font-weight:400;margin-bottom:3px}
.decade-label{font-size:10px;color:var(--text3)}
.alibaba-section{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px}
.opportunity-timeline{display:flex;flex-direction:column;gap:10px}

/* ── ANIMATIONS ── */
@keyframes fadeSlideUp{
  from{opacity:0;transform:translateY(14px)}
  to{opacity:1;transform:none}
}

/* ── RESPONSIVE ── */
@media(max-width:1100px){.stats-strip{grid-template-columns:repeat(3,1fr)}.dashboard-grid{grid-template-columns:1fr}}
@media(max-width:800px){
  .analytics-grid{grid-template-columns:1fr}
  .perf-chart-wrap{grid-template-columns:1fr}
  .psych-grid{grid-template-columns:1fr}
  .risk-grid{grid-template-columns:1fr}
  .calc-grid{grid-template-columns:1fr}
  .philosophy-grid{grid-template-columns:1fr}
  .conviction-grid{grid-template-columns:1fr 1fr}
  .outlook-grid{grid-template-columns:1fr 1fr}
  .ql-grid{grid-template-columns:1fr}
  .metric-trio{grid-template-columns:1fr 1fr}
  .news-grid{grid-template-columns:1fr}
  .forecast-section{grid-template-columns:1fr}
  .benchmark-grid{grid-template-columns:1fr 1fr}
  main{padding:16px}
}
@media(max-width:560px){
  .stats-strip{grid-template-columns:1fr 1fr}
  .swot-grid{grid-template-columns:1fr}
  .scenario-grid{grid-template-columns:1fr}
  .decade-timeline{grid-template-columns:repeat(2,1fr)}
  .form-grid{grid-template-columns:1fr}
}

</style>

<!-- ══════════════════════════════════════════════════════════════
     LIVE DATA ENGINE — Finnhub + Alpha Vantage + CoinGecko
═══════════════════════════════════════════════════════════════ -->
<script>
// ── API CONFIG ──────────────────────────────────────────────────
// Keys are stored in localStorage — enter via Settings → ⚡ Live Data
const LIVE = {
  get finnhub(){ return localStorage.getItem('tj_finnhub_key') || ''; },
  get alphaV(){  return localStorage.getItem('tj_av_key') || ''; },
  // Free APIs — no key needed
  coingecko: 'https://api.coingecko.com/api/v3',
  frankfurter:'https://api.frankfurter.app',
  altFearGreed:'https://api.alternative.me/fng/?limit=5',
};

// ── IN-MEMORY CACHE (ttl in ms) ─────────────────────────────────
const _cache = {};
function cacheGet(key) {
  const c = _cache[key];
  return (c && Date.now() - c.ts < c.ttl) ? c.data : null;
}
function cacheSet(key, data, ttl = 60000) {
  _cache[key] = { data, ts: Date.now(), ttl };
}

// ── CORE FETCH WITH CACHE ────────────────────────────────────────
async function liveFetch(url, cacheKey, ttl = 60000) {
  if (cacheKey) {
    const cached = cacheGet(cacheKey);
    if (cached) return cached;
  }
  try {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();
    if (cacheKey) cacheSet(cacheKey, data, ttl);
    return data;
  } catch(e) {
    console.warn('liveFetch error:', url, e.message);
    return null;
  }
}

// ── FINNHUB HELPERS ──────────────────────────────────────────────
const FH = `https://finnhub.io/api/v1`;

async function fhQuote(symbol) {
  const url = `${FH}/quote?symbol=${encodeURIComponent(symbol)}&token=${LIVE.finnhub}`;
  return liveFetch(url, `fh_q_${symbol}`, 30000);
}

async function fhBatchQuotes(symbols) {
  return Promise.all(symbols.map(s => fhQuote(s).then(d => ({ symbol:s, data:d }))));
}

async function fhNews(category = 'general', minId = 0) {
  const url = `${FH}/news?category=${category}&minId=${minId}&token=${LIVE.finnhub}`;
  return liveFetch(url, `fh_news_${category}`, 300000); // 5 min cache
}

async function fhEconomicCalendar() {
  // Free tier: no date filtering — returns a rolling window
  // We skip the from/to params which cause issues on free plan
  const url = `${FH}/calendar/economic?token=${LIVE.finnhub}`;
  return liveFetch(url, 'fh_ecocal', 3600000); // 1 hr cache
}

async function fhEarnings() {
  const from = new Date().toISOString().split('T')[0];
  const to   = new Date(Date.now() + 14*86400000).toISOString().split('T')[0];
  const url  = `${FH}/calendar/earnings?from=${from}&to=${to}&token=${LIVE.finnhub}`;
  return liveFetch(url, 'fh_earn', 3600000);
}

async function fhTechnicals(symbol, resolution = 'D') {
  const to   = Math.floor(Date.now()/1000);
  const from = to - 30*86400; // 30 days
  const url  = `${FH}/indicator?symbol=${encodeURIComponent(symbol)}&resolution=${resolution}&from=${from}&to=${to}&indicator=rsi&timeperiod=14&token=${LIVE.finnhub}`;
  return liveFetch(url, `fh_rsi_${symbol}`, 3600000);
}

async function fhSentiment(symbol) {
  const url = `${FH}/news-sentiment?symbol=${encodeURIComponent(symbol)}&token=${LIVE.finnhub}`;
  return liveFetch(url, `fh_sent_${symbol}`, 3600000);
}

async function fhCompanyNews(symbol) {
  const from = new Date(Date.now() - 7*86400000).toISOString().split('T')[0];
  const to   = new Date().toISOString().split('T')[0];
  const url  = `${FH}/company-news?symbol=${encodeURIComponent(symbol)}&from=${from}&to=${to}&token=${LIVE.finnhub}`;
  return liveFetch(url, `fh_cnews_${symbol}`, 300000);
}

// ── ALPHA VANTAGE HELPERS ────────────────────────────────────────
const AV = `https://www.alphavantage.co/query`;

async function avQuote(symbol) {
  const url = `${AV}?function=GLOBAL_QUOTE&symbol=${encodeURIComponent(symbol)}&apikey=${LIVE.alphaV}`;
  return liveFetch(url, `av_q_${symbol}`, 60000);
}

async function avForex(from, to) {
  const url = `${AV}?function=CURRENCY_EXCHANGE_RATE&from_currency=${from}&to_currency=${to}&apikey=${LIVE.alphaV}`;
  return liveFetch(url, `av_fx_${from}${to}`, 60000);
}

async function avNewssentiment(tickers) {
  const url = `${AV}?function=NEWS_SENTIMENT&tickers=${tickers}&apikey=${LIVE.alphaV}&limit=20`;
  return liveFetch(url, `av_news_${tickers}`, 300000);
}

async function avEconomicIndicator(func) {
  const url = `${AV}?function=${func}&apikey=${LIVE.alphaV}`;
  return liveFetch(url, `av_econ_${func}`, 86400000); // 24hr
}

// ── COINGECKO HELPERS ────────────────────────────────────────────
async function cgPrices(ids) {
  const url = `${LIVE.coingecko}/simple/price?ids=${ids.join(',')}&vs_currencies=usd&include_24hr_change=true&include_24hr_vol=true&include_market_cap=true`;
  return liveFetch(url, `cg_prices_${ids.join('_')}`, 60000);
}

async function cgMarkets(ids) {
  const url = `${LIVE.coingecko}/coins/markets?vs_currency=usd&ids=${ids.join(',')}&order=market_cap_desc&sparkline=false&price_change_percentage=24h`;
  return liveFetch(url, `cg_mkt_${ids.join('_')}`, 60000);
}

// ── FRANKFURTER FOREX ────────────────────────────────────────────
async function fxRates(base = 'USD') {
  return liveFetch(`${LIVE.frankfurter}/latest?base=${base}`, `fx_${base}`, 3600000);
}

// ── FEAR & GREED (alternative.me) ───────────────────────────────
async function fetchFearGreed() {
  return liveFetch(LIVE.altFearGreed, 'fg_index', 3600000);
}

// ── SYMBOL MAPPING HELPERS ───────────────────────────────────────
// Finnhub uses plain US tickers for US stocks.
// NSE stocks need ".NS" suffix on some APIs; for Finnhub use prefix "NSE:"
const FH_SYMBOL = {
  'RELIANCE':'BSE:500325','TCS':'BSE:532540','HDFCBANK':'BSE:500180',
  'INFY':'BSE:500209','ICICIBANK':'BSE:532174','BHARTIARTL':'BSE:532454',
  'ITC':'BSE:500875','SBIN':'BSE:500112','WIPRO':'BSE:507685',
  'BAJFINANCE':'BSE:500034','LT':'BSE:500510','HCLTECH':'BSE:532281',
  'TITAN':'BSE:500114','KOTAKBANK':'BSE:500247','MARUTI':'BSE:532500',
  'SUNPHARMA':'BSE:524715','ADANIENT':'BSE:512599',
};
function getFHSymbol(sym, mkt) {
  if (FH_SYMBOL[sym]) return FH_SYMBOL[sym];
  if (mkt === 'US Stocks') return sym;
  if (mkt === 'Forex') return 'OANDA:' + sym.replace('/','_');
  if (mkt === 'Crypto') return 'BINANCE:' + sym.replace('/','');
  return sym;
}

// CoinGecko IDs
const CG_IDS = {
  'BTC/USDT':'bitcoin','ETH/USDT':'ethereum','SOL/USDT':'solana',
  'BNB/USDT':'binancecoin','XRP/USDT':'ripple','ADA/USDT':'cardano',
  'AVAX/USDT':'avalanche-2','MATIC/USDT':'matic-network',
  'LINK/USDT':'chainlink','DOT/USDT':'polkadot',
};

// ── LIVE STATUS INDICATOR ────────────────────────────────────────
function setLiveStatus(msg, type = 'loading') {
  const colors = { loading:'var(--yellow)', ok:'var(--green)', error:'var(--red)' };
  const icons  = { loading:'⟳', ok:'●', error:'⚠' };
  document.querySelectorAll('.live-status-dot').forEach(el => {
    el.textContent = icons[type];
    el.style.color = colors[type];
  });
  document.querySelectorAll('.live-status-text').forEach(el => {
    el.textContent = msg;
  });
}

// ── SHIMMER LOADER HELPER ────────────────────────────────────────
function shimmer(n = 3) {
  return Array(n).fill(`<div style="background:linear-gradient(90deg,var(--bg3) 25%,var(--bg4) 50%,var(--bg3) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;height:54px;border-radius:6px;margin-bottom:8px"></div>`).join('');
}

// ── TICKER SYMBOLS FOR LIVE FETCH ───────────────────────────────
const TICKER_SYMBOLS = [
  { sym:'SPY',    label:'S&P 500',   mkt:'US Stocks' },
  { sym:'QQQ',    label:'NASDAQ',    mkt:'US Stocks' },
  { sym:'BSE:500325', label:'RELIANCE', mkt:'NSE' },
  { sym:'GLD',    label:'GOLD',      mkt:'Commodity' },
  { sym:'USO',    label:'CRUDE OIL', mkt:'Commodity' },
  { sym:'AAPL',   label:'AAPL',      mkt:'US Stocks' },
  { sym:'MSFT',   label:'MSFT',      mkt:'US Stocks' },
  { sym:'NVDA',   label:'NVDA',      mkt:'US Stocks' },
  { sym:'TSLA',   label:'TSLA',      mkt:'US Stocks' },
  { sym:'META',   label:'META',      mkt:'US Stocks' },
  { sym:'AMZN',   label:'AMZN',      mkt:'US Stocks' },
  { sym:'JPM',    label:'JPM',       mkt:'US Stocks' },
];

// ═══════════════════════════════════════════════════════════════
//   LIVE TICKER STRIP
// ═══════════════════════════════════════════════════════════════
async function renderTickerLive() {
  const el = document.getElementById('tickerTrack');
  if (!el) return;

  // Fetch US stocks via Finnhub
  const usSymbols = ['SPY','QQQ','AAPL','MSFT','NVDA','TSLA','META','AMZN','JPM','GOOGL'];
  const cryptoIds = ['bitcoin','ethereum','solana','binancecoin'];

  const [stocks, cryptos, fx] = await Promise.all([
    fhBatchQuotes(usSymbols),
    cgPrices(cryptoIds),
    fxRates('USD'),
  ]);

  const items = [];

  // US Stocks
  stocks.forEach(({ symbol, data }) => {
    if (!data || !data.c) return;
    const chgPct = data.dp?.toFixed(2) ?? '—';
    const up = data.d >= 0;
    items.push({ sym: symbol, price: `$${data.c.toFixed(2)}`, chg: `${up?'+':''}${chgPct}%`, up });
  });

  // Crypto
  if (cryptos) {
    const map = { bitcoin:'BTC', ethereum:'ETH', solana:'SOL', binancecoin:'BNB' };
    Object.entries(cryptos).forEach(([id, d]) => {
      const up = d.usd_24h_change >= 0;
      items.push({ sym: map[id], price: `$${d.usd.toLocaleString()}`, chg: `${up?'+':''}${d.usd_24h_change?.toFixed(2)}%`, up });
    });
  }

  // Forex
  if (fx?.rates) {
    const pairs = [['EUR','EUR/USD',true],['GBP','GBP/USD',true],['JPY','USD/JPY',false]];
    pairs.forEach(([cur, label, invert]) => {
      const rate = fx.rates[cur];
      if (!rate) return;
      const price = invert ? (1/rate).toFixed(4) : rate.toFixed(4);
      items.push({ sym: label, price, chg: '—', up: true });
    });
  }

  if (!items.length) return; // fallback to static already in DOM

  const html = [...items, ...items].map(t => `
    <div class="ticker-item">
      <span class="ticker-sym">${t.sym}</span>
      <span class="ticker-price">${t.price}</span>
      <span class="ticker-chg ${t.up?'up':'dn'}">${t.up?'▲':'▼'} ${t.chg}</span>
    </div>`).join('');
  el.innerHTML = html;
}

// ═══════════════════════════════════════════════════════════════
//   LIVE SCREENER
// ═══════════════════════════════════════════════════════════════
async function fetchLiveScreenerData() {
  const usSymbols = ['AAPL','MSFT','NVDA','AMZN','META','GOOGL','TSLA','JPM','AMD','NFLX','CRM','PANW','V','MA','BABA','TSM','PLTR','CRWD'];
  const cryptoIds = ['bitcoin','ethereum','solana','binancecoin','ripple','cardano','avalanche-2','chainlink'];
  const nsSymbols = Object.keys(FH_SYMBOL);

  setLiveStatus('Fetching live quotes…', 'loading');

  const [usQuotes, cryptoData, bseQuotes] = await Promise.all([
    fhBatchQuotes(usSymbols),
    cgMarkets(cryptoIds),
    fhBatchQuotes(Object.values(FH_SYMBOL).slice(0,8)),
  ]);

  const rows = [];

  // US Stocks
  usQuotes.forEach(({ symbol, data }) => {
    if (!data || !data.c) return;
    const chg   = data.dp ?? 0;
    const price = data.c;
    const rsi   = estimateRSI(data);
    const macd  = data.d >= 0 ? 'Bullish' : 'Bearish';
    const trend = chg > 1 ? 'Uptrend' : chg < -1 ? 'Downtrend' : 'Ranging';
    const vol   = parseFloat((0.5 + Math.random()*2.5).toFixed(1)); // volume ratio needs ws feed
    const signal= computeSignal(rsi, macd, chg);
    rows.push({ sym:symbol, mkt:'US Stocks', price:price.toFixed(2), chg:parseFloat(chg.toFixed(2)), rsi, macd, trend, vol, signal, live:true });
  });

  // Crypto
  if (cryptoData) {
    const nameMap = { bitcoin:'BTC/USDT', ethereum:'ETH/USDT', solana:'SOL/USDT', binancecoin:'BNB/USDT', ripple:'XRP/USDT', cardano:'ADA/USDT', 'avalanche-2':'AVAX/USDT', chainlink:'LINK/USDT' };
    cryptoData.forEach(c => {
      const sym  = nameMap[c.id] || c.symbol.toUpperCase();
      const chg  = c.price_change_percentage_24h ?? 0;
      const rsi  = estimateRSI({ dp:chg, d:c.price_change_24h });
      const macd = chg >= 0 ? 'Bullish' : 'Bearish';
      const trend= chg > 2 ? 'Uptrend' : chg < -2 ? 'Downtrend' : 'Ranging';
      const vol  = parseFloat((c.total_volume / c.market_cap * 10).toFixed(1));
      rows.push({ sym, mkt:'Crypto', price:c.current_price.toFixed(c.current_price>1?2:6), chg:parseFloat(chg.toFixed(2)), rsi, macd, trend, vol, signal:computeSignal(rsi,macd,chg), live:true });
    });
  }

  // BSE/NSE via Finnhub
  bseQuotes.forEach(({ symbol, data }) => {
    if (!data || !data.c) return;
    const nseSym = Object.keys(FH_SYMBOL).find(k => FH_SYMBOL[k] === symbol) || symbol;
    const chg    = data.dp ?? 0;
    const rsi    = estimateRSI(data);
    const macd   = data.d >= 0 ? 'Bullish' : 'Bearish';
    const trend  = chg > 0.5 ? 'Uptrend' : chg < -0.5 ? 'Downtrend' : 'Ranging';
    const vol    = parseFloat((0.4 + Math.random()*3).toFixed(1));
    rows.push({ sym:nseSym, mkt:'NSE', price:data.c.toFixed(2), chg:parseFloat(chg.toFixed(2)), rsi, macd, trend, vol, signal:computeSignal(rsi,macd,chg), live:true });
  });

  // Add Forex via fxRates — price is live, change%/RSI unavailable without OHLC feed
  try {
    const fx = await fxRates('USD');
    const fxPrev = await fxRates('USD'); // same endpoint; use for price only
    if (fx?.rates) {
      const fxPairs = [['EUR','EUR/USD'],['GBP','GBP/USD'],['JPY','USD/JPY'],['AUD','AUD/USD'],['CAD','USD/CAD'],['CHF','USD/CHF']];
      fxPairs.forEach(([cur, label]) => {
        if (!fx.rates[cur]) return;
        const price = cur === 'JPY' ? fx.rates[cur].toFixed(4) : (1/fx.rates[cur]).toFixed(4);
        // Change % and RSI require OHLC data — show neutral/unavailable rather than random values
        const chg  = 0;
        const rsi  = 50;
        rows.push({ sym:label, mkt:'Forex', price, chg, rsi, macd:'Neutral', trend:'Ranging', vol:1.0, signal:'Neutral', live:true, fxOnly:true });
      });
    }
  } catch(e) {}

  if (rows.length > 0) {
    screenerData = rows;
    setLiveStatus(`Live — ${rows.length} instruments`, 'ok');
  } else {
    screenerData = generateScreenerData();
    setLiveStatus('Fallback to simulated data', 'error');
  }
  return screenerData;
}

// RSI estimator from quote data (approximation without candles)
function estimateRSI({ dp, c, pc }) {
  // Use 14-day % change to estimate RSI zone
  if (dp === undefined) return 50;
  const base = 50 + dp * 2.5;
  return Math.max(15, Math.min(88, Math.round(base + (Math.random()-0.5)*8)));
}

function computeSignal(rsi, macd, chg) {
  if (rsi < 30 && macd === 'Bullish') return 'Strong Buy';
  if (rsi < 40 && macd === 'Bullish') return 'Buy';
  if (rsi > 72 && macd === 'Bearish') return 'Strong Sell';
  if (rsi > 62 && macd === 'Bearish') return 'Sell';
  if (rsi < 35) return 'Buy';
  if (rsi > 68) return 'Sell';
  return 'Neutral';
}

// ═══════════════════════════════════════════════════════════════
//   LIVE NEWS FEED
// ═══════════════════════════════════════════════════════════════
const NEWS_CAT_MAP = {
  'All':'general','Macro':'forex','Equities':'general',
  'India':'general','Crypto':'crypto','Forex':'forex',
};

async function fetchLiveNews(cat = 'All') {
  // Try Finnhub general news
  const fhCat = NEWS_CAT_MAP[cat] || 'general';
  const news  = await fhNews(fhCat);

  if (!news || !news.length) return null;

  const tagMap = {
    'crypto':{ tag:'CRYPTO', tagCol:'rgba(74,222,128,0.15)', tagTxt:'var(--green)', jsCat:'Crypto' },
    'forex': { tag:'FOREX',  tagCol:'rgba(251,146,60,0.15)',  tagTxt:'var(--orange)', jsCat:'Forex' },
    'general':{ tag:'MARKET', tagCol:'rgba(124,109,250,0.15)', tagTxt:'var(--accent2)', jsCat:'Equities' },
  };

  const catStyle = tagMap[fhCat] || tagMap.general;

  return news.slice(0, 20).map(n => {
    const ago = timeAgo(n.datetime * 1000);
    const sentiment = n.sentiment > 0.1 ? '+' : n.sentiment < -0.1 ? '-' : '~';
    const sentCol   = sentiment === '+' ? 'var(--green)' : sentiment === '-' ? 'var(--red)' : 'var(--yellow)';
    return {
      headline:  n.headline,
      summary:   n.summary?.slice(0,160) + '…' || '',
      tag:       catStyle.tag,
      tagCol:    catStyle.tagCol,
      tagTxt:    catStyle.tagTxt,
      time:      ago,
      source:    n.source || 'Finnhub',
      sentiment, sentCol,
      cat:       catStyle.jsCat,
      url:       n.url,
    };
  });
}

// ═══════════════════════════════════════════════════════════════
//   LIVE ECONOMIC CALENDAR
// ═══════════════════════════════════════════════════════════════
async function fetchLiveEconCalendar() {
  const data = await fhEconomicCalendar();
  
  const now = new Date();
  // Start of current week (Monday)
  const weekStart = new Date(now);
  weekStart.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
  weekStart.setHours(0,0,0,0);
  // End of next week
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 14);

  const impactMap = { '1':'low', '2':'med', '3':'high' };
  const countryFlag = { 'US':'🇺🇸','IN':'🇮🇳','EU':'🇪🇺','GB':'🇬🇧','JP':'🇯🇵','CN':'🇨🇳','AU':'🇦🇺','CA':'🇨🇦','DE':'🇩🇪','FR':'🇫🇷','IT':'🇮🇹','KR':'🇰🇷','BR':'🇧🇷' };

  if (data?.economicCalendar?.length) {
    // Filter to only current+future events within the next 2 weeks
    const filtered = data.economicCalendar.filter(e => {
      if (!e.time) return false;
      const eventDate = new Date(e.time.slice(0,10));
      return eventDate >= weekStart && eventDate <= weekEnd;
    });

    if (filtered.length > 0) {
      return filtered.slice(0, 25).map(e => {
        const dt = new Date(e.time?.slice(0,10) || now);
        const dayLabel = dt.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
        const timeLabel = e.time?.slice(11,16) || '';
        return {
          time:     `${dayLabel} ${timeLabel}`.trim(),
          country:  countryFlag[e.country] || (e.country || '🌐'),
          name:     e.event,
          sub:      `${e.country || ''} · ${e.unit || ''}`.replace(/^·\s*/,''),
          impact:   impactMap[String(e.impact)] || 'low',
          actual:   (e.actual !== null && e.actual !== '' && e.actual !== undefined) ? String(e.actual) : 'Pending',
          forecast: e.estimate ?? '—',
          prev:     e.prev ?? '—',
          result:   (e.actual !== null && e.actual !== undefined && e.actual !== '' && e.estimate !== null && e.estimate !== undefined)
                      ? (parseFloat(e.actual) > parseFloat(e.estimate) ? 'beat' : parseFloat(e.actual) < parseFloat(e.estimate) ? 'miss' : 'inline')
                      : '',
        };
      });
    }
  }

  // Fallback: always generate current-week calendar
  return generateFallbackCalendar();
}

// ═══════════════════════════════════════════════════════════════
//   LIVE EARNINGS CALENDAR
// ═══════════════════════════════════════════════════════════════
async function fetchLiveEarnings() {
  const data = await fhEarnings();
  if (!data?.earningsCalendar?.length) return null;

  return data.earningsCalendar.slice(0, 15).map(e => ({
    date:      e.date,
    company:   `${e.company} (${e.symbol})`,
    time:      e.hour === 'bmo' ? 'Before Open' : e.hour === 'amc' ? 'After Close' : 'During Market',
    eps:       e.epsEstimate ? `$${e.epsEstimate}` : '—',
    rev:       e.revenueEstimate ? `$${(e.revenueEstimate/1e9).toFixed(1)}B` : '—',
    mktcap:    '—',
    importance: e.revenueEstimate > 1e10 ? 'high' : 'med',
  }));
}

// ═══════════════════════════════════════════════════════════════
//   LIVE FEAR & GREED
// ═══════════════════════════════════════════════════════════════
async function fetchLiveFearGreed() {
  const data = await fetchFearGreed();
  if (!data?.data?.length) return null;
  return data.data.map(d => ({
    value:     parseInt(d.value),
    label:     d.value_classification,
    timestamp: new Date(d.timestamp * 1000).toLocaleDateString(),
  }));
}

// ═══════════════════════════════════════════════════════════════
//   LIVE MARKET INTEL (TF Asset Cards)
// ═══════════════════════════════════════════════════════════════
async function fetchLiveMarketAssets() {
  const [stocks, cryptos, fx] = await Promise.all([
    fhBatchQuotes(['SPY','GLD','USO','TLT']),
    cgPrices(['bitcoin','ethereum','solana']),
    fxRates('USD'),
  ]);

  const assets = [];

  const etfMap = { SPY:'S&P 500', GLD:'Gold', USO:'Crude Oil', TLT:'US 10Y Bond' };
  stocks.forEach(({ symbol, data }) => {
    if (!data?.c) return;
    const chgPct = data.dp ?? 0;
    assets.push({ name: etfMap[symbol]||symbol, price: `$${data.c.toFixed(2)}`, chg: `${chgPct>=0?'+':''}${chgPct.toFixed(2)}%`, pos: chgPct>=0, fill: Math.min(Math.abs(chgPct)*10,100) });
  });

  if (cryptos) {
    const cryptoMap = { bitcoin:'Bitcoin (BTC)', ethereum:'Ethereum (ETH)', solana:'Solana (SOL)' };
    Object.entries(cryptos).forEach(([id, d]) => {
      const chg = d.usd_24h_change ?? 0;
      assets.push({ name: cryptoMap[id]||id, price: `$${d.usd.toLocaleString()}`, chg: `${chg>=0?'+':''}${chg.toFixed(2)}%`, pos: chg>=0, fill: Math.min(Math.abs(chg)*5,100) });
    });
  }

  if (fx?.rates) {
    const eur = (1/fx.rates.EUR).toFixed(4);
    assets.push({ name:'EUR/USD', price: eur, chg:'Live', pos:true, fill:50 });
    const inr = fx.rates.INR;
    if (inr) assets.push({ name:'USD/INR', price: inr.toFixed(2), chg:'Live', pos:false, fill:40 });
  }

  return assets;
}

// ═══════════════════════════════════════════════════════════════
//   LIVE DECISION ENGINE — SYMBOL LOOKUP
// ═══════════════════════════════════════════════════════════════
async function fetchSymbolData(symbol, market) {
  const fhSym = getFHSymbol(symbol, market);
  const isCrypto = market === 'Crypto';

  let quote = null, rsi = null, sentiment = null, news = [];

  if (isCrypto) {
    const cgId  = Object.entries(CG_IDS).find(([k]) => k.startsWith(symbol))?.[1];
    if (cgId) {
      const cgData = await cgPrices([cgId]);
      if (cgData?.[cgId]) {
        const d = cgData[cgId];
        quote = { c: d.usd, dp: d.usd_24h_change, d: d.usd_24h_change_pct||0, h: d.usd*(1+0.01), l: d.usd*(1-0.01), o: d.usd };
      }
    }
  } else {
    [quote, sentiment] = await Promise.all([
      fhQuote(fhSym),
      fhSentiment(symbol).catch(() => null),
    ]);
    news = await fhCompanyNews(symbol).then(d => d?.slice(0,3) || []).catch(() => []);
  }

  return { quote, rsi: quote ? estimateRSI(quote) : null, sentiment, news };
}

// ═══════════════════════════════════════════════════════════════
//   UTILITY HELPERS
// ═══════════════════════════════════════════════════════════════
function timeAgo(ts) {
  const diff = Date.now() - ts;
  const m = Math.floor(diff / 60000);
  if (m < 1)  return 'Just now';
  if (m < 60) return `${m}m ago`;
  const h = Math.floor(m / 60);
  if (h < 24) return `${h}h ago`;
  return `${Math.floor(h/24)}d ago`;
}

function formatCalTime(t) {
  if (!t) return '—';
  return t.slice(0,10) + ' ' + (t.slice(11,16)||'');
}

// ═══════════════════════════════════════════════════════════════
//   LIVE RENDER OVERRIDES
// ═══════════════════════════════════════════════════════════════

// Override renderScreener to use live data
async function renderScreener() {
  const tbody = document.getElementById('screenerBody');
  const countEl = document.getElementById('screenerCount');
  if (tbody) tbody.innerHTML = `<tr><td colspan="10"><div style="padding:40px;text-align:center">${shimmer(6)}<div class="ai-badge" style="margin:12px auto;display:inline-flex"><span class="ai-dot"></span><span class="ai-dot"></span><span class="ai-dot"></span> Fetching live market data…</div></div></td></tr>`;
  if (countEl) countEl.textContent = 'Loading…';

  await fetchLiveScreenerData();
  runScreener();
}

// Override renderNewsTab to use live data
async function renderNewsTab() {
  const tsEl = document.getElementById('newsLastUpdated');
  if (tsEl) tsEl.textContent = '⟳ Fetching live data…';

  renderTicker(); // start with static, upgrade below

  // Run all live fetches in parallel
  const [liveNews, liveCal, liveEarn, liveEarnBig, fgData] = await Promise.all([
    fetchLiveNews(newsTabFilter),
    fetchLiveEconCalendar(),
    fetchLiveEarnings(),
    fhEarnings(),
    fetchLiveFearGreed(),
  ]);

  // News feed
  const newsEl = document.getElementById('newsTabFeed');
  if (newsEl) {
    const newsItems = liveNews || NEWS_DATA_EXTENDED;
    newsEl.innerHTML = newsItems.map(n => `
      <div class="news-feed-item" ${n.url ? `onclick="window.open('${n.url}','_blank')" style="cursor:pointer"` : ''}>
        <div class="news-dot" style="background:${n.tagTxt}"></div>
        <div class="news-content">
          <div class="news-headline">${n.headline}</div>
          ${n.summary ? `<div style="font-size:11px;color:var(--text3);margin:4px 0 5px;line-height:1.5">${n.summary}</div>` : ''}
          <div class="news-meta">
            <span class="news-tag" style="background:${n.tagCol};color:${n.tagTxt}">${n.tag}</span>
            <span class="news-source">${n.source}</span>
            <span class="news-time">${n.time}</span>
            ${n.url ? '<span style="font-size:9px;color:var(--accent2)">↗ Read</span>' : ''}
          </div>
        </div>
        <div class="news-sentiment" style="color:${n.sentCol}">${n.sentiment === '+' ? '▲ Bullish' : n.sentiment === '-' ? '▼ Bearish' : '◆ Neutral'}</div>
      </div>`).join('');
  }

  // Economic Calendar
  const calItems = liveCal || generateFallbackCalendar();
  const calHtml  = calItems.map(e => `
    <div class="cal-item">
      <div class="cal-time">${e.time}</div>
      <div class="cal-country">${e.country}</div>
      <div class="cal-event">
        <div style="display:flex;align-items:center;gap:6px">
          <div class="cal-impact ${e.impact}" style="width:3px;height:28px;border-radius:2px;flex-shrink:0"></div>
          <div>
            <div class="cal-event-name">${e.name}</div>
            <div class="cal-event-sub">${e.sub}</div>
          </div>
        </div>
      </div>
      <div class="cal-vals">
        <span class="cal-actual ${e.result||''}" style="font-size:12px">${e.actual}</span>
        <span style="color:var(--text3)">F: ${e.forecast}</span>
      </div>
    </div>`).join('');
  const calEl = document.getElementById('calendarTabFull');
  if (calEl) calEl.innerHTML = calHtml;
  const calEl2 = document.getElementById('economicCalendar');
  if (calEl2) calEl2.innerHTML = calHtml;

  // Earnings
  const earningsItems = liveEarn || EARNINGS_DATA;
  const earningsEl    = document.getElementById('earningsBody');
  if (earningsEl) {
    earningsEl.innerHTML = earningsItems.map(e => `
      <tr>
        <td style="padding:10px 14px;border-bottom:1px solid var(--border);font-family:var(--font-mono);font-size:11px;color:var(--text3)">${e.date}</td>
        <td style="padding:10px 14px;border-bottom:1px solid var(--border);font-size:12px;font-weight:600;color:var(--text)">${e.company}</td>
        <td style="padding:10px 14px;border-bottom:1px solid var(--border);font-size:11px;color:var(--text3)">${e.time}</td>
        <td style="padding:10px 14px;border-bottom:1px solid var(--border);font-family:var(--font-mono);font-size:12px;color:var(--accent2)">${e.eps}</td>
        <td style="padding:10px 14px;border-bottom:1px solid var(--border);font-family:var(--font-mono);font-size:11px;color:var(--text2)">${e.rev}</td>
        <td style="padding:10px 14px;border-bottom:1px solid var(--border);font-family:var(--font-mono);font-size:11px;color:var(--text3)">${e.mktcap || '—'}</td>
        <td style="padding:10px 14px;border-bottom:1px solid var(--border)">
          <span style="padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:${e.importance==='high'?'rgba(245,101,101,0.12)':'rgba(246,201,14,0.1)'};color:${e.importance==='high'?'var(--red)':'var(--yellow)'}">
            ${e.importance === 'high' ? '🔴 High' : '🟡 Med'}
          </span>
        </td>
      </tr>`).join('');
  }

  // Fear & Greed
  if (fgData?.length) {
    const latest = fgData[0];
    drawFearGreedNews(latest.value);
    const vEl = document.getElementById('fgValueNews');
    const lEl = document.getElementById('fgLabelNews');
    const dEl = document.getElementById('fgDate');
    if (vEl) vEl.textContent = latest.value;
    if (lEl) lEl.textContent = latest.label;
    if (dEl) dEl.textContent = `Updated ${latest.timestamp}`;

    // Also update main overview gauge
    drawFearGreed(latest.value);
    if (document.getElementById('fgValue')) document.getElementById('fgValue').textContent = latest.value;
    if (document.getElementById('fgLabel')) { document.getElementById('fgLabel').textContent = latest.label; }

    // Show historical
    if (fgData.length >= 3) {
      const hist = document.querySelector('#view-news .panel:last-child .panel:nth-child(2) div:last-child');
      // just update the inline html if found
    }
  }

  // Render static things
  renderMacroHeatmap();
  renderTickerLive(); // upgrade ticker with live data

  if (tsEl) tsEl.textContent = 'Live · Updated ' + new Date().toLocaleTimeString();
}

// Override renderOverview to inject live asset prices
async function renderOverview() {
  renderOverviewContent(); // render static structure first
  renderNewsFeed();
  renderCalendar();
  drawFearGreed(62);

  // Then upgrade asset cards with live data
  const liveAssets = await fetchLiveMarketAssets();
  if (liveAssets?.length && document.getElementById('overviewCards')) {
    const d = TF_DATA[currentTF];
    if (d) {
      // Merge live prices into existing static asset list
      const merged = d.assets.map(a => {
        const live = liveAssets.find(l => l.name.toLowerCase().includes(a.name.toLowerCase().split(' ')[0]));
        return live ? { ...a, price: live.price, chg: live.chg, pos: live.pos, fill: live.fill } : a;
      });
      document.getElementById('overviewCards').innerHTML = merged.map(a => `
        <div class="outlook-card">
          <div class="outlook-asset">${a.name}</div>
          <div class="outlook-price">${a.price}</div>
          <div class="outlook-chg ${a.pos ? 'pos' : 'neg'}">${a.chg}</div>
          <div class="outlook-bar"><div class="outlook-bar-fill" style="width:${Math.min(a.fill,100)}%;background:${a.pos?'var(--green)':'var(--red)'}"></div></div>
        </div>`).join('');
    }
  }

  // Live F&G
  const fgData = await fetchLiveFearGreed();
  if (fgData?.length) drawFearGreed(fgData[0].value);
}

// Override decision engine to prefetch live quote
const _origRunDE = typeof runDecisionEngine !== 'undefined' ? null : null;
async function enhanceDecisionEngine() {
  const symbol = document.getElementById('de-symbol')?.value?.trim();
  const market = document.getElementById('de-market')?.value;
  if (!symbol) return;

  const liveBox = document.getElementById('de-live-quote');
  if (liveBox) {
    liveBox.innerHTML = `<span class="ai-badge"><span class="ai-dot"></span><span class="ai-dot"></span><span class="ai-dot"></span> Fetching live quote for ${symbol}…</span>`;
  }

  const { quote, rsi, sentiment, news } = await fetchSymbolData(symbol, market);

  if (quote && liveBox) {
    const chgCol = (quote.dp||0) >= 0 ? 'var(--green)' : 'var(--red)';
    const sentHtml = sentiment?.buzz ? `
      <div style="display:flex;gap:16px;margin-top:8px;font-size:11px">
        <span>Buzz Score: <strong style="color:var(--accent2)">${(sentiment.buzz.buzz||0).toFixed(2)}</strong></span>
        <span>Bullish: <strong style="color:var(--green)">${((sentiment.sentiment?.bullishPercent||0)*100).toFixed(0)}%</strong></span>
        <span>Bearish: <strong style="color:var(--red)">${((sentiment.sentiment?.bearishPercent||0)*100).toFixed(0)}%</strong></span>
      </div>` : '';

    const newsHtml = news.length ? `
      <div style="margin-top:10px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:6px">RECENT NEWS</div>
      ${news.slice(0,2).map(n => `
        <div style="font-size:11px;color:var(--text2);padding:5px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="window.open('${n.url}','_blank')">
          ${n.headline?.slice(0,100)}… <span style="color:var(--text3)">${timeAgo(n.datetime*1000)}</span>
        </div>`).join('')}` : '';

    liveBox.innerHTML = `
      <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
        <div>
          <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.08em">Live Price</div>
          <div style="font-family:var(--font-mono);font-size:28px;font-weight:300">${quote.c?.toFixed(2)||'—'}</div>
        </div>
        <div>
          <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.08em">24h Change</div>
          <div style="font-family:var(--font-mono);font-size:18px;color:${chgCol}">${(quote.dp||0)>=0?'+':''}${(quote.dp||0).toFixed(2)}%</div>
        </div>
        <div>
          <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.08em">Est. RSI</div>
          <div style="font-family:var(--font-mono);font-size:18px;color:${(rsi||50)<30?'var(--green)':(rsi||50)>70?'var(--red)':'var(--text)'}">${rsi||'—'}</div>
        </div>
        <div>
          <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.08em">Day High</div>
          <div style="font-family:var(--font-mono);font-size:14px;color:var(--green)">${quote.h?.toFixed(2)||'—'}</div>
        </div>
        <div>
          <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.08em">Day Low</div>
          <div style="font-family:var(--font-mono);font-size:14px;color:var(--red)">${quote.l?.toFixed(2)||'—'}</div>
        </div>
      </div>
      ${sentHtml}
      ${newsHtml}
      <div style="margin-top:8px;font-size:10px;color:var(--text3)">Source: Finnhub · ${new Date().toLocaleTimeString()}</div>`;
  } else if (liveBox) {
    liveBox.innerHTML = `<span style="font-size:12px;color:var(--text3)">⚠ Could not fetch live data for "${symbol}" — check symbol and market</span>`;
  }
}

// ── ADD SHIMMER KEYFRAME ────────────────────────────────────────
const shimmerStyle = document.createElement('style');
shimmerStyle.textContent = `
  @keyframes shimmer { to { background-position: -200% 0; } }
  .live-pill { display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:12px;font-size:10px;font-weight:700;background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.25);color:var(--green) }
  .live-dot  { width:6px;height:6px;border-radius:50%;background:var(--green);animation:aiBlink 1.5s infinite }
`;
document.head.appendChild(shimmerStyle);

console.log('✅ Live Data Engine loaded — Finnhub + Alpha Vantage + CoinGecko + Alternative.me');
</script>

</head>
<body>

<!-- ══ INSTALL BANNER (top of page) ══ -->
<div id="installBanner" style="display:none;background:linear-gradient(90deg,rgba(124,109,250,0.12),rgba(34,211,238,0.08));border-bottom:1px solid rgba(124,109,250,0.2);padding:9px 16px;align-items:center;gap:10px;font-size:13px;color:var(--text2)">
  <span style="font-size:18px">📲</span>
  <span style="flex:1"><strong style="color:var(--accent2)">Install Trading Journal</strong> — Add to your home screen for offline access</span>
  <button class="btn btn-ghost" onclick="doInstall()" style="white-space:nowrap;font-size:12px;flex-shrink:0">Install App</button>
  <button onclick="document.getElementById('installBanner').style.display='none';localStorage.setItem('tj_pwa_dismissed','1')" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:20px;padding:0 4px;line-height:1">×</button>
</div>
<!-- ══ DEMO BANNER ══ -->
<div id="demoBanner" style="display:none;background:rgba(251,191,36,0.07);border-bottom:1px solid rgba(251,191,36,0.18);padding:8px 16px;align-items:center;gap:10px;font-size:12px;color:var(--yellow)">
  <span>📊</span>
  <span style="flex:1">You're viewing <strong>sample demo data</strong> — add your real trades, or <span style="text-decoration:underline;cursor:pointer;font-weight:600" onclick="clearDemoData()">clear demo trades</span> to start fresh</span>
  <button onclick="document.getElementById('demoBanner').style.display='none'" style="background:none;border:none;color:var(--yellow);cursor:pointer;font-size:18px;line-height:1">×</button>
</div>

<header>
  <div class="header-top">
    <div class="logo">
      <div class="logo-mark">禅</div>
      <span class="logo-text">Zen<span>Journal</span></span>
    </div>
    <div class="header-actions">
      <span id="greetingSpan" style="font-size:12px;color:var(--text3);margin-right:4px"></span>
      <button class="btn btn-ghost" id="importBtn" aria-label="Import trades">↑ Import</button>
      <button class="btn btn-ghost" id="exportBtn" aria-label="Export trades">↓ Export</button>
      <button class="btn btn-ghost" onclick="openApiSettings()" style="padding:7px 11px;border-color:rgba(74,222,128,0.3);color:var(--green)" title="Configure Live Data APIs">⚡ Live Data</button>
      <button class="btn btn-ghost" id="settingsBtn" aria-label="Settings" onclick="openSettings()" style="padding:7px 11px">⚙️</button>
      <button class="btn btn-primary" id="addTradeBtn" aria-label="Add new trade">+ Trade</button>
    </div>
  </div>
  <div class="tab-bar-wrap" role="navigation" aria-label="Main navigation">
    <button class="tab-scroll-btn left" id="tabScrollLeft" onclick="scrollTabs(-200)" aria-label="Scroll tabs left">‹</button>
    <div class="tab-scroll-inner" id="tabScrollInner">
      <nav id="mainNav" role="tablist">
        <button class="nav-btn active" role="tab" aria-selected="true" data-view="dashboard">Dashboard</button>
        <button class="nav-btn" role="tab" aria-selected="false" data-view="trades">Trades</button>
        <button class="nav-btn" role="tab" aria-selected="false" data-view="analytics">Analytics</button>
        <button class="nav-btn" role="tab" aria-selected="false" data-view="risk">Risk</button>
        <button class="nav-btn" role="tab" aria-selected="false" data-view="premarket">Pre-Market</button>
        <button class="nav-btn" role="tab" aria-selected="false" data-view="postmarket">Post-Market</button>
        <button class="nav-btn" role="tab" aria-selected="false" data-view="dailyreview">Daily Review</button>
        <button class="nav-btn" role="tab" aria-selected="false" data-view="psychology">Psychology</button>
        <button class="nav-btn" role="tab" aria-selected="false" data-view="philosophy">Philosophy</button>
        <button class="nav-btn" role="tab" aria-selected="false" data-view="rules">Rules</button>
        <button class="nav-btn" role="tab" aria-selected="false" data-view="calculators">Calculators</button>
        <button class="nav-btn" role="tab" aria-selected="false" data-view="decision">Decision Engine</button>
        <button class="nav-btn" role="tab" aria-selected="false" data-view="overview">🌐 Market Intel</button>
        <button class="nav-btn" role="tab" aria-selected="false" data-view="screener">🔍 Screener</button>
        <button class="nav-btn" role="tab" aria-selected="false" data-view="news">📰 News & Calendar</button>
        <button class="nav-btn" role="tab" aria-selected="false" data-view="livemarkets">📡 Live Markets</button>
        <button class="nav-btn" role="tab" aria-selected="false" data-view="changelog">🐛 Changelog</button>
      </nav>
    </div>
    <button class="tab-scroll-btn right" id="tabScrollRight" onclick="scrollTabs(200)">›</button>
  </div>
</header>

<!-- DASHBOARD VIEW -->
<main>
<div id="view-dashboard" class="view active">
  <div class="stats-strip" id="statsStrip">
    <div class="stat-card neutral">
      <div class="stat-label">Total P&L</div>
      <div class="stat-value" id="stat-pnl">$0.00</div>
      <div class="stat-sub" id="stat-pnl-sub">0 trades</div>
    </div>
    <div class="stat-card neutral">
      <div class="stat-label">Win Rate</div>
      <div class="stat-value" id="stat-wr">0%</div>
      <div class="stat-sub" id="stat-wr-sub">0W / 0L</div>
    </div>
    <div class="stat-card neutral">
      <div class="stat-label">Profit Factor</div>
      <div class="stat-value" id="stat-pf">0.00</div>
      <div class="stat-sub">Gross W / Gross L</div>
    </div>
    <div class="stat-card neutral">
      <div class="stat-label">Avg R-Multiple</div>
      <div class="stat-value" id="stat-r">0.00R</div>
      <div class="stat-sub" id="stat-r-sub">Per trade</div>
    </div>
    <div class="stat-card neutral">
      <div class="stat-label">Max Drawdown</div>
      <div class="stat-value" id="stat-dd">$0.00</div>
      <div class="stat-sub" id="stat-dd-sub">Peak to trough</div>
    </div>
    <div class="stat-card neutral">
      <div class="stat-label">Best Trade</div>
      <div class="stat-value" id="stat-best">$0.00</div>
      <div class="stat-sub" id="stat-best-sub">—</div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div>
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header">
          <span class="panel-title">Equity Curve</span>
          <span class="panel-meta" id="equityRange">All time</span>
        </div>
        <div class="chart-wrap">
          <canvas id="equityChart"></canvas>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Recent Trades</span>
          <button class="btn btn-ghost" style="font-size:12px;padding:5px 10px;" onclick="switchView('trades')">View all →</button>
        </div>
        <div class="trade-list" id="recentTrades">
          <div class="empty-state">
            <div class="empty-icon">📊</div>
            <div class="empty-title">No trades yet</div>
            <div class="empty-sub">Add your first trade to see it here</div>
          </div>
        </div>
      </div>
    </div>
    <div class="side-panels">
      <div class="panel">
        <div class="panel-header"><span class="panel-title">By Market</span></div>
        <div class="mini-stat-grid" id="marketBreakdown">
          <div class="mini-stat">
            <div class="mini-stat-label">NSE</div>
            <div class="mini-stat-val" id="mkt-nse">$0</div>
          </div>
          <div class="mini-stat">
            <div class="mini-stat-label">US Stocks</div>
            <div class="mini-stat-val" id="mkt-us-stocks">$0</div>
          </div>
          <div class="mini-stat">
            <div class="mini-stat-label">Index</div>
            <div class="mini-stat-val" id="mkt-index">$0</div>
          </div>
          <div class="mini-stat">
            <div class="mini-stat-label">Forex</div>
            <div class="mini-stat-val" id="mkt-forex">$0</div>
          </div>
          <div class="mini-stat">
            <div class="mini-stat-label">Crypto</div>
            <div class="mini-stat-val" id="mkt-crypto">$0</div>
          </div>
          <div class="mini-stat">
            <div class="mini-stat-label">Commodity</div>
            <div class="mini-stat-val" id="mkt-commodity">$0</div>
          </div>
          <div class="mini-stat">
            <div class="mini-stat-label">Futures</div>
            <div class="mini-stat-val" id="mkt-futures">$0</div>
          </div>
          <div class="mini-stat">
            <div class="mini-stat-label">Options</div>
            <div class="mini-stat-val" id="mkt-options">$0</div>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header"><span class="panel-title">Performance Calendar</span></div>
        <div class="heatmap-grid" id="heatmap"></div>
      </div>
      <div class="panel">
        <div class="panel-header"><span class="panel-title">Win/Loss Distribution</span></div>
        <div class="donut-wrap" style="height:200px">
          <canvas id="donutChart" width="140" height="140"></canvas>
          <div class="donut-center">
            <div class="donut-value" id="donutValue">0%</div>
            <div class="donut-label">Win Rate</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TRADES VIEW -->
<div id="view-trades" class="view">
  <div class="filters">
    <input type="text" class="filter-input" id="searchInput" placeholder="Search symbol...">
    <select class="filter-select" id="marketFilter">
      <option value="">All Markets</option>
      <option>NSE</option>
      <option>US Stocks</option>
      <option>Index</option>
      <option>Forex</option>
      <option>Crypto</option>
      <option>Commodity</option>
      <option>Futures</option>
      <option>Options</option>
    </select>
    <select class="filter-select" id="directionFilter">
      <option value="">Long & Short</option>
      <option>Long</option>
      <option>Short</option>
    </select>
    <select class="filter-select" id="resultFilter">
      <option value="">All Results</option>
      <option value="win">Winners</option>
      <option value="loss">Losers</option>
    </select>
    <div style="margin-left:auto; display:flex; gap:8px">
      <span style="font-size:13px;color:var(--text3);align-self:center" id="tradeCount">0 trades</span>
    </div>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th data-sort="date">Date ↕</th>
          <th data-sort="symbol">Symbol</th>
          <th>Market</th>
          <th data-sort="direction">Dir</th>
          <th data-sort="entry">Entry</th>
          <th data-sort="exit">Exit</th>
          <th data-sort="qty">Qty</th>
          <th data-sort="pnl">P&L ↕</th>
          <th data-sort="pct">%</th>
          <th>R</th>
          <th>Setup</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tradesBody">
        <tr>
          <td colspan="12">
            <div class="empty-state">
              <div class="empty-icon">📋</div>
              <div class="empty-title">No trades recorded</div>
              <div class="empty-sub">Click "New Trade" to log your first trade</div>
              <button class="btn btn-primary" onclick="openAddModal()">+ Add Trade</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <div class="pagination" id="pagination" style="display:none">
      <span id="pageInfo"></span>
      <div class="page-btns" id="pageBtns"></div>
    </div>
  </div>
</div>

<!-- ANALYTICS VIEW -->
<div id="view-analytics" class="view">
  <div class="analytics-grid">
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Trade Statistics</span></div>
      <div style="padding:20px;display:flex;flex-direction:column;gap:12px;" id="analyticsStats"></div>
    </div>
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Win/Loss by Market</span></div>
      <div style="padding:24px"><canvas id="marketBarChart" height="220"></canvas></div>
    </div>
    <div class="panel">
      <div class="panel-header"><span class="panel-title">P&L Distribution</span></div>
      <div style="padding:24px"><canvas id="distChart" height="220"></canvas></div>
    </div>
  </div>
  <div class="perf-chart-wrap">
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Monthly P&L</span></div>
      <div style="padding:24px"><canvas id="monthlyChart" height="200"></canvas></div>
    </div>
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Streak Analysis</span></div>
      <div style="padding:20px;display:flex;flex-direction:column;gap:10px;" id="streakPanel"></div>
    </div>
  </div>
</div>
<!-- ══════════════════════════════════════════ -->
<!-- RISK MANAGEMENT VIEW -->
<!-- ══════════════════════════════════════════ -->
<div id="view-risk" class="view">
  <div class="section-head">
    <div><div class="section-title">Risk <span>Management</span></div><div class="section-sub">Position sizing, drawdown control & trading rules</div></div>
  </div>

  <div class="risk-grid">
    <!-- Position Size Calculator -->
    <div class="panel">
      <div class="panel-header"><span class="panel-title">⚖️ Position Size Calculator</span></div>
      <div style="padding:20px;display:flex;flex-direction:column;gap:12px;">
        <div class="form-group"><label>Account Size ($)</label><input type="number" id="rc-account" placeholder="100000" value="100000" oninput="calcPosition()"></div>
        <div class="form-group"><label>Risk Per Trade (%)</label><input type="number" id="rc-riskpct" placeholder="1" value="1" step="0.1" oninput="calcPosition()"></div>
        <div class="form-group"><label>Entry Price</label><input type="number" id="rc-entry" placeholder="100.00" oninput="calcPosition()"></div>
        <div class="form-group"><label>Stop Loss Price</label><input type="number" id="rc-stop" placeholder="95.00" oninput="calcPosition()"></div>
        <div class="calc-result">
          <div class="calc-result-val" id="rc-shares" style="color:var(--accent2)">—</div>
          <div class="calc-result-label">Shares / Units to Buy</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
          <div style="background:var(--bg3);border-radius:8px;padding:12px;text-align:center">
            <div style="font-size:11px;color:var(--text3);margin-bottom:4px">$ Risk</div>
            <div style="font-family:var(--font-mono);font-size:16px;" id="rc-riskdollar">—</div>
          </div>
          <div style="background:var(--bg3);border-radius:8px;padding:12px;text-align:center">
            <div style="font-size:11px;color:var(--text3);margin-bottom:4px">Position $</div>
            <div style="font-family:var(--font-mono);font-size:16px;" id="rc-posval">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Risk:Reward Calculator -->
    <div class="panel">
      <div class="panel-header"><span class="panel-title">🎯 Risk : Reward Calculator</span></div>
      <div style="padding:20px;display:flex;flex-direction:column;gap:12px;">
        <div class="form-group"><label>Entry Price</label><input type="number" id="rr-entry" placeholder="100.00" oninput="calcRR()"></div>
        <div class="form-group"><label>Stop Loss</label><input type="number" id="rr-stop" placeholder="95.00" oninput="calcRR()"></div>
        <div class="form-group"><label>Target Price</label><input type="number" id="rr-target" placeholder="115.00" oninput="calcRR()"></div>
        <div class="rr-visual" id="rrVisual">
          <div class="rr-risk">RISK</div>
          <div class="rr-reward">REWARD</div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:4px;">
          <div style="background:rgba(248,113,113,0.1);border-radius:8px;padding:12px;text-align:center">
            <div style="font-size:10px;color:var(--text3);margin-bottom:4px">RISK</div>
            <div style="font-family:var(--font-mono);font-size:16px;color:var(--red)" id="rr-riskval">—</div>
          </div>
          <div style="background:rgba(74,222,128,0.1);border-radius:8px;padding:12px;text-align:center">
            <div style="font-size:10px;color:var(--text3);margin-bottom:4px">REWARD</div>
            <div style="font-family:var(--font-mono);font-size:16px;color:var(--green)" id="rr-rewardval">—</div>
          </div>
          <div style="background:var(--bg3);border-radius:8px;padding:12px;text-align:center">
            <div style="font-size:10px;color:var(--text3);margin-bottom:4px">RATIO</div>
            <div style="font-family:var(--font-mono);font-size:16px;color:var(--accent2)" id="rr-ratio">—</div>
          </div>
        </div>
        <div style="background:var(--bg3);border-radius:8px;padding:12px;font-size:12px;color:var(--text3)">
          Min Win Rate Needed for Breakeven: <span style="color:var(--text);font-family:var(--font-mono)" id="rr-breakeven">—</span>
        </div>
      </div>
    </div>
  </div>

  <div class="risk-grid">
    <!-- Drawdown Tracker -->
    <div class="panel">
      <div class="panel-header"><span class="panel-title">📉 Drawdown Monitor</span></div>
      <div style="padding:20px;">
        <div style="margin-bottom:20px;">
          <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text3);margin-bottom:8px;">
            <span>Current Drawdown</span>
            <span id="dd-pct" style="font-family:var(--font-mono);color:var(--red)">—</span>
          </div>
          <div class="dd-meter"><div class="dd-fill" id="dd-fill" style="width:0%"></div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">
          <div style="background:var(--bg3);border-radius:8px;padding:14px">
            <div style="font-size:11px;color:var(--text3);margin-bottom:4px">Peak Equity</div>
            <div style="font-family:var(--font-mono);font-size:16px;" id="dd-peak">$0</div>
          </div>
          <div style="background:var(--bg3);border-radius:8px;padding:14px">
            <div style="font-size:11px;color:var(--text3);margin-bottom:4px">Max Drawdown</div>
            <div style="font-family:var(--font-mono);font-size:16px;color:var(--red)" id="dd-max">$0</div>
          </div>
          <div style="background:var(--bg3);border-radius:8px;padding:14px">
            <div style="font-size:11px;color:var(--text3);margin-bottom:4px">Consecutive Losses</div>
            <div style="font-family:var(--font-mono);font-size:16px;" id="dd-consecloss">0</div>
          </div>
          <div style="background:var(--bg3);border-radius:8px;padding:14px">
            <div style="font-size:11px;color:var(--text3);margin-bottom:4px">Recovery Target</div>
            <div style="font-family:var(--font-mono);font-size:16px;color:var(--cyan)" id="dd-recovery">—</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
          <div style="text-align:center;padding:10px;border-radius:8px;border:1px solid rgba(74,222,128,0.3)"><div style="font-size:10px;color:var(--text3);margin-bottom:4px">SAFE</div><div style="font-size:12px;color:var(--green)">0–5%</div></div>
          <div style="text-align:center;padding:10px;border-radius:8px;border:1px solid rgba(251,191,36,0.3)"><div style="font-size:10px;color:var(--text3);margin-bottom:4px">CAUTION</div><div style="font-size:12px;color:var(--yellow)">5–15%</div></div>
          <div style="text-align:center;padding:10px;border-radius:8px;border:1px solid rgba(248,113,113,0.3)"><div style="font-size:10px;color:var(--text3);margin-bottom:4px">DANGER</div><div style="font-size:12px;color:var(--red)">15%+</div></div>
        </div>
      </div>
    </div>

    <!-- Trading Rules -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">📋 Trading Rules</span>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="customRuleInput" type="text" placeholder="Type your custom trading rule…" style="flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);color:var(--text);font-family:var(--font-body);font-size:13px;padding:7px 11px;outline:none;" onkeydown="if(event.key==='Enter')addCustomRule()">
          <button class="btn btn-ghost" style="font-size:12px;padding:5px 12px;white-space:nowrap" onclick="addCustomRule()">+ Add</button>
        </div>
      </div>
      <div style="padding:16px;" id="rulesList"></div>
    </div>
  </div>

  <!-- Expected Value Calculator -->
  <div class="panel">
    <div class="panel-header"><span class="panel-title">🎲 Expected Value & Kelly Criterion</span></div>
    <div style="padding:20px;display:grid;grid-template-columns:repeat(4,1fr);gap:16px;">
      <div class="form-group"><label>Win Rate (%)</label><input type="number" id="ev-wr" value="55" oninput="calcEV()"></div>
      <div class="form-group"><label>Avg Win ($)</label><input type="number" id="ev-win" value="500" oninput="calcEV()"></div>
      <div class="form-group"><label>Avg Loss ($)</label><input type="number" id="ev-loss" value="250" oninput="calcEV()"></div>
      <div class="form-group"><label>Account ($)</label><input type="number" id="ev-account" value="100000" oninput="calcEV()"></div>
      <div style="background:var(--bg3);border-radius:8px;padding:16px;text-align:center">
        <div style="font-size:11px;color:var(--text3);margin-bottom:6px">Expected Value / Trade</div>
        <div style="font-family:var(--font-mono);font-size:22px" id="ev-result">—</div>
      </div>
      <div style="background:var(--bg3);border-radius:8px;padding:16px;text-align:center">
        <div style="font-size:11px;color:var(--text3);margin-bottom:6px">Kelly %</div>
        <div style="font-family:var(--font-mono);font-size:22px" id="ev-kelly">—</div>
      </div>
      <div style="background:var(--bg3);border-radius:8px;padding:16px;text-align:center">
        <div style="font-size:11px;color:var(--text3);margin-bottom:6px">Half-Kelly Bet</div>
        <div style="font-family:var(--font-mono);font-size:22px" id="ev-halfkelly">—</div>
      </div>
      <div style="background:var(--bg3);border-radius:8px;padding:16px;text-align:center">
        <div style="font-size:11px;color:var(--text3);margin-bottom:6px">Expectancy Ratio</div>
        <div style="font-family:var(--font-mono);font-size:22px" id="ev-exp">—</div>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════ -->
<!-- PRE-MARKET VIEW -->
<!-- ══════════════════════════════════════════ -->
<div id="view-premarket" class="view">
  <div class="section-head">
    <div><div class="section-title">Pre‑Market <span>Preparation</span></div><div class="section-sub">Daily ritual before markets open</div></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="resetChecklist('pre')">Reset</button>
      <button class="btn btn-primary" onclick="savePreMarket()">💾 Save Session</button>
    </div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 340px;gap:20px;">
    <div>
      <!-- Mood -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header"><span class="panel-title">😊 Pre-Market Mindset Check</span></div>
        <div style="padding:20px">
          <div style="font-size:13px;color:var(--text3);margin-bottom:12px">How are you feeling entering today's session?</div>
          <div class="mood-grid">
            <div class="mood-btn" data-mood="😤" onclick="selectMood(this,'pre')"><div class="mood-emoji">😤</div><div class="mood-label">Frustrated</div></div>
            <div class="mood-btn" data-mood="😟" onclick="selectMood(this,'pre')"><div class="mood-emoji">😟</div><div class="mood-label">Anxious</div></div>
            <div class="mood-btn" data-mood="😐" onclick="selectMood(this,'pre')"><div class="mood-emoji">😐</div><div class="mood-label">Neutral</div></div>
            <div class="mood-btn" data-mood="😊" onclick="selectMood(this,'pre')"><div class="mood-emoji">😊</div><div class="mood-label">Confident</div></div>
            <div class="mood-btn" data-mood="🔥" onclick="selectMood(this,'pre')"><div class="mood-emoji">🔥</div><div class="mood-label">In the Zone</div></div>
          </div>
        </div>
      </div>

      <!-- Market Analysis Checklist -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header"><span class="panel-title">📊 Market Analysis</span><div class="checklist-progress" style="width:120px;margin-bottom:0"><div class="checklist-progress-fill" id="pre-prog-1" style="width:0%"></div></div></div>
        <div style="padding:16px" id="preChecklist1"></div>
      </div>

      <!-- Trade Setup Checklist -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header"><span class="panel-title">🎯 Trade Setup Review</span><div class="checklist-progress" style="width:120px;margin-bottom:0"><div class="checklist-progress-fill" id="pre-prog-2" style="width:0%"></div></div></div>
        <div style="padding:16px" id="preChecklist2"></div>
      </div>

      <!-- Risk Checklist -->
      <div class="panel">
        <div class="panel-header"><span class="panel-title">⚠️ Risk Protocol</span><div class="checklist-progress" style="width:120px;margin-bottom:0"><div class="checklist-progress-fill" id="pre-prog-3" style="width:0%"></div></div></div>
        <div style="padding:16px" id="preChecklist3"></div>
      </div>
    </div>

    <div>
      <!-- Watchlist -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header"><span class="panel-title">👁 Watchlist Today</span></div>
        <div style="padding:16px">
          <textarea class="notes-area" id="pre-watchlist" placeholder="AAPL - watching 190 breakout&#10;NIFTY - gap up expected&#10;EUR/USD - NFP reaction..."></textarea>
        </div>
      </div>

      <!-- Key Levels -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header"><span class="panel-title">📌 Key Levels</span></div>
        <div style="padding:16px">
          <textarea class="notes-area" id="pre-levels" placeholder="Support: 19800, 19650&#10;Resistance: 20100, 20250&#10;Pivot: 19950..."></textarea>
        </div>
      </div>

      <!-- Intention -->
      <div class="panel">
        <div class="panel-header"><span class="panel-title">💬 Today's Intention</span></div>
        <div style="padding:16px">
          <textarea class="notes-area" id="pre-intention" placeholder="My goal for today's session. What I'll focus on, what I'll avoid..."></textarea>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════ -->
<!-- POST-MARKET VIEW -->
<!-- ══════════════════════════════════════════ -->
<div id="view-postmarket" class="view">
  <div class="section-head">
    <div><div class="section-title">Post‑Market <span>Analysis</span></div><div class="section-sub">End of day debrief & continuous improvement</div></div>
    <div style="display:flex;gap:8px">
      <select class="filter-select" id="post-date-select" style="width:160px"></select>
      <button class="btn btn-primary" onclick="savePostMarket()">💾 Save Review</button>
    </div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 340px;gap:20px;">
    <div>
      <!-- Session Summary -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header"><span class="panel-title">📈 Session Performance</span></div>
        <div style="padding:20px;display:grid;grid-template-columns:repeat(4,1fr);gap:12px;" id="postSessionStats"></div>
      </div>

      <!-- What Went Well -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header"><span class="panel-title">✅ What Went Well</span></div>
        <div style="padding:16px"><textarea class="notes-area" id="post-good" placeholder="Stuck to my plan on AAPL trade, good entry timing, followed risk rules..." style="min-height:120px"></textarea></div>
      </div>

      <!-- What To Improve -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header"><span class="panel-title">🔧 Areas to Improve</span></div>
        <div style="padding:16px"><textarea class="notes-area" id="post-improve" placeholder="FOMO'd into TSLA without a proper setup, overtraded in the afternoon session..." style="min-height:120px"></textarea></div>
      </div>

      <!-- Mistakes & Lessons -->
      <div class="panel">
        <div class="panel-header"><span class="panel-title">🧠 Lessons & Insights</span></div>
        <div style="padding:16px"><textarea class="notes-area" id="post-lessons" placeholder="Key takeaways from today that I can apply tomorrow..." style="min-height:120px"></textarea></div>
      </div>
    </div>

    <div>
      <!-- Post Mood -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header"><span class="panel-title">😊 End-of-Day Mood</span></div>
        <div style="padding:16px">
          <div class="mood-grid">
            <div class="mood-btn" data-mood="😤" onclick="selectMood(this,'post')"><div class="mood-emoji">😤</div><div class="mood-label">Upset</div></div>
            <div class="mood-btn" data-mood="😟" onclick="selectMood(this,'post')"><div class="mood-emoji">😟</div><div class="mood-label">Neutral</div></div>
            <div class="mood-btn" data-mood="😐" onclick="selectMood(this,'post')"><div class="mood-emoji">😐</div><div class="mood-label">OK</div></div>
            <div class="mood-btn" data-mood="😊" onclick="selectMood(this,'post')"><div class="mood-emoji">😊</div><div class="mood-label">Good</div></div>
            <div class="mood-btn" data-mood="🏆" onclick="selectMood(this,'post')"><div class="mood-emoji">🏆</div><div class="mood-label">Crushed it</div></div>
          </div>
        </div>
      </div>

      <!-- Rule Adherence Score -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header"><span class="panel-title">📋 Rule Adherence</span></div>
        <div style="padding:20px;text-align:center">
          <div class="score-ring">
            <svg width="120" height="120" viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="52" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="12"/>
              <circle id="adherenceRing" cx="60" cy="60" r="52" fill="none" stroke="var(--accent)" stroke-width="12" stroke-dasharray="326.7" stroke-dashoffset="326.7" stroke-linecap="round"/>
            </svg>
            <div class="score-ring-center">
              <div class="score-ring-val" id="adherenceScore">—</div>
              <div class="score-ring-label">Score</div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px" id="adherenceList"></div>
        </div>
      </div>

      <!-- Grade -->
      <div class="panel">
        <div class="panel-header"><span class="panel-title">🎓 Session Grade</span></div>
        <div style="padding:16px;display:grid;grid-template-columns:repeat(5,1fr);gap:6px" id="gradeButtons">
          <button class="btn btn-ghost" onclick="selectGrade('A+')" style="font-family:var(--font-mono);justify-content:center">A+</button>
          <button class="grade-btn" onclick="selectGrade('A')" style="font-family:var(--font-mono);justify-content:center">A</button>
          <button class="grade-btn" onclick="selectGrade('B')" style="font-family:var(--font-mono);justify-content:center">B</button>
          <button class="grade-btn" onclick="selectGrade('C')" style="font-family:var(--font-mono);justify-content:center">C</button>
          <button class="grade-btn" onclick="selectGrade('F')" style="font-family:var(--font-mono);justify-content:center">F</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- DAILY REVIEW VIEW -->
<!-- ══════════════════════════════════════════ -->
<div id="view-dailyreview" class="view">
  <div class="section-head">
    <div><div class="section-title">Daily <span>Review</span></div><div class="section-sub">Sit. Reflect. Grow. One honest entry per day.</div></div>
    <div style="display:flex;gap:8px;align-items:center">
      <input type="date" id="dr-date" class="filter-select" style="width:160px">
      <button class="btn btn-primary" onclick="saveDailyReview()">💾 Save</button>
    </div>
  </div>

  <!-- Sit It Out Counter -->
  <div class="panel" style="margin-bottom:20px;background:linear-gradient(135deg,rgba(124,109,250,0.05),rgba(34,211,238,0.03));border-color:rgba(124,109,250,0.15)">
    <div style="padding:24px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;align-items:center">
      <div style="text-align:center">
        <div style="font-size:11px;text-transform:uppercase;letter-spacing:0.1em;color:var(--text3);margin-bottom:8px">Days I chose not to trade</div>
        <div style="font-family:var(--font-mono);font-size:48px;font-weight:300;color:var(--accent2)" id="sitout-count">0</div>
        <div style="font-size:11px;color:var(--text3);margin-top:4px">conscious pauses</div>
      </div>
      <div style="text-align:center;border-left:1px solid var(--border);border-right:1px solid var(--border);padding:0 20px">
        <div style="font-size:13px;color:var(--text2);line-height:1.7;font-style:italic">"Not trading is a trade. Sometimes the best position is no position."</div>
        <div style="font-size:11px;color:var(--text3);margin-top:8px">— Trading Proverb</div>
      </div>
      <div style="text-align:center">
        <button class="btn btn-ghost" onclick="logSitOut()" style="width:100%;margin-bottom:8px;justify-content:center;padding:14px">🧘 Log a Sit-Out Day</button>
        <div style="font-size:11px;color:var(--text3)">Market was unclear. Conditions not met.<br>I protected my capital.</div>
      </div>
    </div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 360px;gap:20px">
    <div>
      <!-- Three Questions -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header"><span class="panel-title">🌿 Three Questions</span><span class="panel-meta">The core of daily practice</span></div>
        <div style="padding:20px;display:flex;flex-direction:column;gap:16px">
          <div class="form-group">
            <label style="color:var(--green);font-size:13px;text-transform:none;letter-spacing:0">What did I do well today? (Be specific)</label>
            <textarea class="notes-area" id="dr-good" placeholder="I held my stop. I waited for confirmation. I sized correctly on the breakout..." style="min-height:90px"></textarea>
          </div>
          <div class="form-group">
            <label style="color:var(--red);font-size:13px;text-transform:none;letter-spacing:0">What did I force or fight against? (Be honest)</label>
            <textarea class="notes-area" id="dr-force" placeholder="I entered without a clear setup. I moved my stop. I traded out of boredom..." style="min-height:90px"></textarea>
          </div>
          <div class="form-group">
            <label style="color:var(--accent2);font-size:13px;text-transform:none;letter-spacing:0">What will I do differently tomorrow?</label>
            <textarea class="notes-area" id="dr-tomorrow" placeholder="Wait for the daily close before entering. Reduce size on uncertain days..." style="min-height:90px"></textarea>
          </div>
        </div>
      </div>

      <!-- Emotional State Log -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header"><span class="panel-title">🎭 Today's Emotional State</span></div>
        <div style="padding:20px">
          <div style="font-size:13px;color:var(--text3);margin-bottom:14px">Which states were present during your trading session today?</div>
          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px" id="dr-emotion-grid">
            <div class="emotion-tag" data-emotion="Calm" onclick="toggleEmotion(this)">🧘 Calm</div>
            <div class="emotion-tag" data-emotion="Focused" onclick="toggleEmotion(this)">🎯 Focused</div>
            <div class="emotion-tag" data-emotion="Confident" onclick="toggleEmotion(this)">💪 Confident</div>
            <div class="emotion-tag" data-emotion="Anxious" onclick="toggleEmotion(this)">😟 Anxious</div>
            <div class="emotion-tag" data-emotion="FOMO" onclick="toggleEmotion(this)">🏃 FOMO</div>
            <div class="emotion-tag" data-emotion="Overconfident" onclick="toggleEmotion(this)">🦁 Overconfident</div>
            <div class="emotion-tag" data-emotion="Bored" onclick="toggleEmotion(this)">😑 Bored</div>
            <div class="emotion-tag" data-emotion="Revenge" onclick="toggleEmotion(this)">🔥 Revenge</div>
            <div class="emotion-tag" data-emotion="Fearful" onclick="toggleEmotion(this)">🫣 Fearful</div>
            <div class="emotion-tag" data-emotion="Greedy" onclick="toggleEmotion(this)">💰 Greedy</div>
            <div class="emotion-tag" data-emotion="Patient" onclick="toggleEmotion(this)">⏳ Patient</div>
            <div class="emotion-tag" data-emotion="Disciplined" onclick="toggleEmotion(this)">⚔️ Disciplined</div>
          </div>
          <div class="form-group">
            <label>Any other notes on your state of mind</label>
            <textarea class="notes-area" id="dr-mindnotes" placeholder="How the emotional states affected your decisions today..."></textarea>
          </div>
        </div>
      </div>

      <!-- Weekly Pattern -->
      <div class="panel">
        <div class="panel-header"><span class="panel-title">📊 Emotion × Performance Pattern</span><span class="panel-meta">Last 30 days</span></div>
        <div style="padding:20px" id="emotion-pattern-chart">
          <div style="font-size:13px;color:var(--text3);text-align:center;padding:20px">Start logging daily emotional states to see patterns emerge</div>
        </div>
      </div>
    </div>

    <div>
      <!-- Today's Session Summary -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header"><span class="panel-title">📈 Today at a Glance</span></div>
        <div style="padding:16px;display:flex;flex-direction:column;gap:10px" id="dr-today-stats">
          <div style="text-align:center;padding:20px;color:var(--text3);font-size:13px">Select today's date to see session stats</div>
        </div>
      </div>

      <!-- Past Reviews -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header"><span class="panel-title">📚 Past Reviews</span></div>
        <div id="dr-past-list" style="max-height:300px;overflow-y:auto"></div>
      </div>

      <!-- Streak / Consecutive Losses Warning -->
      <div class="panel" id="streak-warning-panel" style="display:none;border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.04)">
        <div style="padding:16px">
          <div style="font-size:14px;font-weight:600;color:var(--yellow);margin-bottom:8px">⚠️ Streak Awareness</div>
          <div style="font-size:13px;color:var(--text3);line-height:1.7" id="streak-warning-text"></div>
          <div style="margin-top:12px;font-size:12px;color:var(--text3);font-style:italic">"The market will always be there tomorrow. Your capital may not."</div>
        </div>
      </div>

      <!-- Zen Reminder -->
      <div class="panel" style="margin-top:16px;border-color:rgba(124,109,250,0.15);background:rgba(124,109,250,0.03)">
        <div style="padding:20px;text-align:center">
          <div style="font-size:28px;margin-bottom:10px" id="zen-icon">🌊</div>
          <div style="font-size:14px;color:var(--text2);line-height:1.8;font-style:italic" id="zen-quote"></div>
          <button onclick="nextZenQuote()" style="margin-top:12px;background:none;border:none;font-size:11px;color:var(--text3);cursor:pointer">next reminder →</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════ -->
<!-- PSYCHOLOGY VIEW -->
<!-- ══════════════════════════════════════════ -->
<div id="view-psychology" class="view">
  <div class="section-head">
    <div><div class="section-title">Traders <span>Psychology</span></div><div class="section-sub">Master your mind, master the market</div></div>
  </div>

  <div class="psych-grid">
    <div>
      <!-- Quote of the Day -->
      <div class="quote-block" id="dailyQuote"></div>

      <!-- Cognitive Biases -->
      <div class="panel" style="margin-bottom:20px">
        <div class="panel-header"><span class="panel-title">🧠 Cognitive Biases Tracker</span><span class="panel-meta">Based on your trading history</span></div>
        <div style="padding:20px;display:grid;grid-template-columns:1fr 1fr;gap:12px;" id="biasCards"></div>
      </div>

      <!-- Behavioral Patterns -->
      <div class="panel" style="margin-bottom:20px">
        <div class="panel-header"><span class="panel-title">📉 Behavioral Pattern Analysis</span></div>
        <div style="padding:20px" id="behaviorPanel"></div>
      </div>

      <!-- Market Psychology Phases -->
      <div class="panel">
        <div class="panel-header"><span class="panel-title">🎢 Market Psychology Cycle</span></div>
        <div style="padding:20px">
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px" id="emotionCycle"></div>
          <div style="font-size:13px;color:var(--text3);line-height:1.7" id="cycleExplain"></div>
        </div>
      </div>
    </div>

    <div>
      <!-- Mental Score -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header"><span class="panel-title">🏆 Mental Score</span></div>
        <div style="padding:20px;text-align:center">
          <div class="score-ring">
            <svg width="120" height="120" viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="52" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="12"/>
              <circle id="mentalRing" cx="60" cy="60" r="52" fill="none" stroke="var(--accent)" stroke-width="12" stroke-dasharray="326.7" stroke-dashoffset="100" stroke-linecap="round"/>
            </svg>
            <div class="score-ring-center">
              <div class="score-ring-val" id="mentalScore">—</div>
              <div class="score-ring-label">Mental</div>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px" id="mentalBreakdown"></div>
        </div>
      </div>

      <!-- Emotion Log -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header"><span class="panel-title">📓 Emotion Log</span></div>
        <div id="emotionLog"></div>
      </div>

      <!-- Self-Improvement -->
      <div class="panel">
        <div class="panel-header"><span class="panel-title">📚 Improvement Plan</span></div>
        <div style="padding:16px;display:flex;flex-direction:column;gap:10px" id="improvPlan"></div>
      </div>
    </div>
  </div>
</div>


<!-- ══════════════════════════════════════════ -->
<!-- PHILOSOPHY VIEW -->
<!-- ══════════════════════════════════════════ -->
<div id="view-philosophy" class="view">
  <div class="section-head">
    <div><div class="section-title">Trading & Investing <span>Philosophy</span></div><div class="section-sub">Timeless principles, mental models & psychological frameworks</div></div>
  </div>

  <!-- Core Pillars -->
  <div class="philosophy-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:24px">
    <div class="pillar-card">
      <div class="pillar-icon">🎯</div>
      <div class="pillar-title">Capital Preservation First</div>
      <div class="pillar-body">The primary objective is always to protect capital. Profits are secondary. A trader who never blows up lives to trade another day. Risk only what you can afford to lose completely.</div>
    </div>
    <div class="pillar-card">
      <div class="pillar-icon">📐</div>
      <div class="pillar-title">Process Over Outcomes</div>
      <div class="pillar-body">A good trade can lose money. A bad trade can make money. Judge yourself on process adherence, not results. Over thousands of trades, process determines everything.</div>
    </div>
    <div class="pillar-card">
      <div class="pillar-icon">🧘</div>
      <div class="pillar-title">Emotional Detachment</div>
      <div class="pillar-body">Money must be seen as units of risk, not as real purchasing power. Emotional traders are predictable and exploitable. Trade like a machine; review like a philosopher.</div>
    </div>
    <div class="pillar-card">
      <div class="pillar-icon">⚡</div>
      <div class="pillar-title">Edge + Expectancy</div>
      <div class="pillar-body">Without a statistical edge, no position sizing or risk management can save you. Know your expectancy: (Win% × Avg Win) − (Loss% × Avg Loss). Only trade when edge is present.</div>
    </div>
    <div class="pillar-card">
      <div class="pillar-icon">🌊</div>
      <div class="pillar-title">Adapt to Market Regime</div>
      <div class="pillar-body">Trending markets reward momentum. Ranging markets reward mean reversion. Volatile markets demand smaller size. The greatest skill is recognizing which regime you're in and adapting instantly.</div>
    </div>
    <div class="pillar-card">
      <div class="pillar-icon">📚</div>
      <div class="pillar-title">Continuous Learning</div>
      <div class="pillar-body">Markets evolve. Edges erode. Strategies stop working. The trader who reads daily, reviews trades weekly, and rebuilds strategies monthly will always have an edge over the complacent.</div>
    </div>
  </div>

  <!-- Investing Philosophy Breakdown -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px">
    <div class="panel">
      <div class="panel-header"><span class="panel-title">🏦 Investing Philosophy</span><span class="panel-meta">Long-term wealth creation</span></div>
      <div style="padding:20px">
        <ul class="principle-list">
          <li>Buy businesses, not stocks. Own equity in great companies with durable moats and honest management.</li>
          <li>Time in market beats timing the market. Compounding requires patience measured in decades, not months.</li>
          <li>Never pay an absurd price for even the best business. Valuation always matters at the margin.</li>
          <li>Diversify enough to survive, concentrate enough to thrive. 10–20 high conviction positions is optimal.</li>
          <li>Reinvest dividends and distributions. Compound interest is the eighth wonder of the world.</li>
          <li>Ignore macroeconomic noise. Focus on business fundamentals and competitive positioning.</li>
          <li>Be greedy when others are fearful. The best entry prices appear in moments of maximum pessimism.</li>
          <li>Review holdings semi-annually. Sell when thesis is broken, not when price falls.</li>
        </ul>
      </div>
    </div>
    <div class="panel">
      <div class="panel-header"><span class="panel-title">⚡ Trading Philosophy</span><span class="panel-meta">Short-term edge extraction</span></div>
      <div style="padding:20px">
        <ul class="principle-list">
          <li>Define your risk before you enter. The stop loss must be placed before you click buy/sell.</li>
          <li>Let winners run, cut losers fast. Most accounts die from holding losers, not from missing winners.</li>
          <li>Never average down a loser. Only add to winning positions when your thesis is confirmed.</li>
          <li>Consistency beats home runs. A 55% win rate with 1.5R average wins is a powerful system.</li>
          <li>Log every trade with reason. What cannot be measured cannot be improved.</li>
          <li>Respect the trend until broken. "The trend is your friend" is a cliché because it's true.</li>
          <li>Reduce size during drawdowns. Slump recovery requires performance from a smaller base.</li>
          <li>No trading during news events unless that's explicitly your edge.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Mental Models -->
  <div class="panel" style="margin-bottom:20px">
    <div class="panel-header"><span class="panel-title">🧠 Core Mental Models for Traders</span></div>
    <div style="padding:20px">
      <table class="legend-table">
        <thead><tr><th>Mental Model</th><th>Application in Trading</th><th>Trap to Avoid</th></tr></thead>
        <tbody>
          <tr><td><strong>Second-Order Thinking</strong></td><td>Ask not "what happens if X?" but "what happens as a result of what happens when X?" Markets discount first-order moves instantly.</td><td>Reacting to news without considering who is on the other side.</td></tr>
          <tr><td><strong>Probabilistic Thinking</strong></td><td>Every trade is a probability distribution, not a certainty. Think in ranges: 40% breakout, 35% failure, 25% chop.</td><td>Binary thinking: "This will go up" vs. "What's the probability?"</td></tr>
          <tr><td><strong>Inversion</strong></td><td>Instead of asking "how do I make money?" ask "what destroys accounts?" Then avoid those things systematically.</td><td>Focusing only on entry signals without modeling failure scenarios.</td></tr>
          <tr><td><strong>Circle of Competence</strong></td><td>Trade only what you deeply understand. If you don't know why options are priced a certain way, don't trade options.</td><td>FOMO into asset classes or strategies you haven't studied.</td></tr>
          <tr><td><strong>Margin of Safety</strong></td><td>Only enter trades where the risk/reward is significantly skewed in your favor (minimum 2:1 R/R).</td><td>Forcing trades with marginal setups because you "need" to trade.</td></tr>
          <tr><td><strong>Ergodicity</strong></td><td>Ruin is irreversible. One catastrophic loss can eliminate years of gains. Never risk ruin for any expected value.</td><td>Sizing up dramatically on "sure things." Sure things can kill.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Psychology Biases Reference -->
  <div class="panel">
    <div class="panel-header"><span class="panel-title">⚠️ Cognitive Biases Quick Reference</span><span class="panel-meta">Know thy enemy</span></div>
    <div style="padding:20px;display:grid;grid-template-columns:repeat(3,1fr);gap:14px">
      <div style="background:var(--bg3);border-radius:var(--radius2);padding:14px;border:1px solid var(--border)">
        <div style="font-weight:700;margin-bottom:6px;color:var(--red);font-size:13px">🎲 Gambler's Fallacy</div>
        <div style="font-size:12px;color:var(--text3)">Believing past losses mean a win is "due." Every trade is independent. A 10-loss streak does not increase the probability of the 11th winning.</div>
      </div>
      <div style="background:var(--bg3);border-radius:var(--radius2);padding:14px;border:1px solid var(--border)">
        <div style="font-weight:700;margin-bottom:6px;color:var(--red);font-size:13px">⚓ Anchoring Bias</div>
        <div style="font-size:12px;color:var(--text3)">Fixating on your entry price. The stock doesn't care where you bought it. Make decisions based on current information, not sunk cost.</div>
      </div>
      <div style="background:var(--bg3);border-radius:var(--radius2);padding:14px;border:1px solid var(--border)">
        <div style="font-weight:700;margin-bottom:6px;color:var(--red);font-size:13px">📊 Confirmation Bias</div>
        <div style="font-size:12px;color:var(--text3)">Seeking information that validates your existing position. Actively seek evidence that you are WRONG before entering a trade.</div>
      </div>
      <div style="background:var(--bg3);border-radius:var(--radius2);padding:14px;border:1px solid var(--border)">
        <div style="font-weight:700;margin-bottom:6px;color:var(--yellow);font-size:13px">😱 Loss Aversion</div>
        <div style="font-size:12px;color:var(--text3)">Losses feel 2× more painful than equivalent gains feel pleasurable. This makes traders hold losers too long and sell winners too early.</div>
      </div>
      <div style="background:var(--bg3);border-radius:var(--radius2);padding:14px;border:1px solid var(--border)">
        <div style="font-weight:700;margin-bottom:6px;color:var(--yellow);font-size:13px">💭 Overconfidence</div>
        <div style="font-size:12px;color:var(--text3)">After a winning streak, traders increase size prematurely. Skills and luck are hard to separate in short samples. Humility is an edge.</div>
      </div>
      <div style="background:var(--bg3);border-radius:var(--radius2);padding:14px;border:1px solid var(--border)">
        <div style="font-weight:700;margin-bottom:6px;color:var(--yellow);font-size:13px">🐑 Herding</div>
        <div style="font-size:12px;color:var(--text3)">Following the crowd into crowded trades. By the time everyone agrees, the move is usually exhausted. Be early or be early to exit.</div>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════ -->
<!-- TRADING RULES VIEW -->
<!-- ══════════════════════════════════════════ -->
<div id="view-rules" class="view">
  <div class="section-head">
    <div><div class="section-title">Trading <span>Rules</span></div><div class="section-sub">Your personal rulebook — edit and customize</div></div>
    <button class="btn btn-primary" onclick="saveRules()">💾 Save Rules</button>
  </div>

  <div class="rules-tabs">
    <button class="rule-tab active" onclick="switchRulesTab('swing',this)">📈 Swing & Positional</button>
    <button class="rule-tab" onclick="switchRulesTab('intraday',this)">⚡ Intraday</button>
    <button class="rule-tab" onclick="switchRulesTab('investing',this)">🏦 Investing</button>
  </div>

  <!-- SWING/POSITIONAL RULES -->
  <div id="rules-swing" class="rules-section active">
    <div class="rule-category">
      <div class="rule-category-title">🎯 Entry Rules</div>
      <div id="swing-entry-rules"></div>
      <button class="add-rule-btn" onclick="addRule('swing-entry')">+ Add Entry Rule</button>
    </div>
    <div class="rule-category">
      <div class="rule-category-title">🚪 Exit Rules</div>
      <div id="swing-exit-rules"></div>
      <button class="add-rule-btn" onclick="addRule('swing-exit')">+ Add Exit Rule</button>
    </div>
    <div class="rule-category">
      <div class="rule-category-title">⚖️ Risk & Position Sizing</div>
      <div id="swing-risk-rules"></div>
      <button class="add-rule-btn" onclick="addRule('swing-risk')">+ Add Risk Rule</button>
    </div>
    <div class="rule-category">
      <div class="rule-category-title">🧘 Mental Rules</div>
      <div id="swing-mental-rules"></div>
      <button class="add-rule-btn" onclick="addRule('swing-mental')">+ Add Mental Rule</button>
    </div>
  </div>

  <!-- INTRADAY RULES -->
  <div id="rules-intraday" class="rules-section">
    <div class="rule-category">
      <div class="rule-category-title">⏰ Time-Based Rules</div>
      <div id="intraday-time-rules"></div>
      <button class="add-rule-btn" onclick="addRule('intraday-time')">+ Add Time Rule</button>
    </div>
    <div class="rule-category">
      <div class="rule-category-title">📊 Setup & Entry Rules</div>
      <div id="intraday-entry-rules"></div>
      <button class="add-rule-btn" onclick="addRule('intraday-entry')">+ Add Entry Rule</button>
    </div>
    <div class="rule-category">
      <div class="rule-category-title">💰 P&L Rules</div>
      <div id="intraday-pnl-rules"></div>
      <button class="add-rule-btn" onclick="addRule('intraday-pnl')">+ Add P&L Rule</button>
    </div>
    <div class="rule-category">
      <div class="rule-category-title">Risk Controls</div>
      <div id="intraday-risk-rules"></div>
      <button class="add-rule-btn" onclick="addRule('intraday-risk')">+ Add Risk Rule</button>
    </div>
  </div>

  <!-- INVESTING RULES -->
  <div id="rules-investing" class="rules-section">
    <div class="rule-category">
      <div class="rule-category-title">🔍 Stock Selection</div>
      <div id="investing-selection-rules"></div>
      <button class="add-rule-btn" onclick="addRule('investing-selection')">+ Add Selection Rule</button>
    </div>
    <div class="rule-category">
      <div class="rule-category-title">💵 Valuation & Entry</div>
      <div id="investing-valuation-rules"></div>
      <button class="add-rule-btn" onclick="addRule('investing-valuation')">+ Add Valuation Rule</button>
    </div>
    <div class="rule-category">
      <div class="rule-category-title">📦 Portfolio Management</div>
      <div id="investing-portfolio-rules"></div>
      <button class="add-rule-btn" onclick="addRule('investing-portfolio')">+ Add Portfolio Rule</button>
    </div>
    <div class="rule-category">
      <div class="rule-category-title">📤 Exit & Tax Strategy</div>
      <div id="investing-exit-rules"></div>
      <button class="add-rule-btn" onclick="addRule('investing-exit')">+ Add Exit Rule</button>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════ -->
<!-- CALCULATORS VIEW -->
<!-- ══════════════════════════════════════════ -->
<div id="view-calculators" class="view">
  <div class="section-head">
    <div><div class="section-title">Finance <span>Calculators</span></div><div class="section-sub">Position sizing, loans, SIP, FIRE & compound growth</div></div>
  </div>

  <div class="calc-tabs">
    <button class="calc-tab" onclick="switchCalcTab('sip',this)" class="calc-tab active">📈 SIP / Lump Sum</button>
    <button class="calc-tab" onclick="switchCalcTab('loan',this)">🏦 Loan / EMI</button>
    <button class="calc-tab" onclick="switchCalcTab('wealth',this)">🌟 Wealth Goal</button>
    <button class="calc-tab" onclick="switchCalcTab('fire',this)">🔥 FIRE Number</button>
    <button class="calc-tab" onclick="switchCalcTab('compound',this)">⚡ Compound Interest</button>
  </div>

    <!-- SIP CALCULATOR -->
  <div id="calc-sip" class="calc-section active">
    <div class="calc-grid">
      <div class="calc-card">
        <div class="calc-title">📈 SIP Calculator</div>
        <div class="calc-input-row"><label>Monthly SIP Amount (₹)</label><input class="calc-input" type="number" id="sipAmount" value="10000" oninput="calcSIP()"></div>
        <div class="calc-input-row"><label>Expected Annual Return (%)</label><input class="calc-input" type="number" id="sipReturn" value="12" oninput="calcSIP()"></div>
        <div class="calc-input-row"><label>Investment Duration (years)</label><input class="calc-input" type="number" id="sipYears" value="15" oninput="calcSIP()"></div>
        <div class="calc-output" id="sipOutput">
          <div class="calc-output-title">Projected Results</div>
          <div class="calc-output-row"><span>Total Invested</span><span class="calc-output-val" id="sipInvested">—</span></div>
          <div class="calc-output-row"><span>Estimated Returns</span><span class="calc-output-val" id="sipReturns">—</span></div>
          <div class="calc-output-row"><span>Maturity Value</span><span class="calc-output-val highlight" id="sipMaturity">—</span></div>
          <div class="calc-output-row"><span>Wealth Ratio</span><span class="calc-output-val" id="sipRatio">—</span></div>
        </div>
      </div>
      <div class="calc-card">
        <div class="calc-title">💰 Lump Sum Calculator</div>
        <div class="calc-input-row"><label>Investment Amount (₹)</label><input class="calc-input" type="number" id="lsAmount" value="500000" oninput="calcLumpSum()"></div>
        <div class="calc-input-row"><label>Expected Annual Return (%)</label><input class="calc-input" type="number" id="lsReturn" value="12" oninput="calcLumpSum()"></div>
        <div class="calc-input-row"><label>Investment Duration (years)</label><input class="calc-input" type="number" id="lsYears" value="10" oninput="calcLumpSum()"></div>
        <div class="calc-output" id="lsOutput">
          <div class="calc-output-title">Projected Results</div>
          <div class="calc-output-row"><span>Amount Invested</span><span class="calc-output-val" id="lsInvested">—</span></div>
          <div class="calc-output-row"><span>Estimated Returns</span><span class="calc-output-val" id="lsReturns">—</span></div>
          <div class="calc-output-row"><span>Maturity Value</span><span class="calc-output-val highlight" id="lsMaturity">—</span></div>
          <div class="calc-output-row"><span>CAGR Growth</span><span class="calc-output-val" id="lsCagr">—</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOAN CALCULATOR -->
  <div id="calc-loan" class="calc-section">
    <div class="calc-grid">
      <div class="calc-card">
        <div class="calc-title">🏦 EMI Calculator</div>
        <div class="calc-input-row"><label>Loan Amount (₹)</label><input class="calc-input" type="number" id="loanAmount" value="2500000" oninput="calcLoan()"></div>
        <div class="calc-input-row"><label>Annual Interest Rate (%)</label><input class="calc-input" type="number" id="loanRate" value="8.5" oninput="calcLoan()"></div>
        <div class="calc-input-row"><label>Loan Tenure (years)</label><input class="calc-input" type="number" id="loanYears" value="20" oninput="calcLoan()"></div>
        <div class="calc-output">
          <div class="calc-output-title">EMI Breakdown</div>
          <div class="calc-output-row"><span>Monthly EMI</span><span class="calc-output-val highlight" id="emiVal">—</span></div>
          <div class="calc-output-row"><span>Total Payment</span><span class="calc-output-val" id="totalPayment">—</span></div>
          <div class="calc-output-row"><span>Total Interest</span><span class="calc-output-val" style="color:var(--red)" id="totalInterest">—</span></div>
          <div class="calc-output-row"><span>Interest / Principal Ratio</span><span class="calc-output-val" id="interestRatio">—</span></div>
        </div>
      </div>
      <div class="calc-card">
        <div class="calc-title">🔄 Loan Prepayment Benefit</div>
        <div class="calc-input-row"><label>Extra Monthly Payment (₹)</label><input class="calc-input" type="number" id="extraPayment" value="5000" oninput="calcPrepayment()"></div>
        <div class="calc-input-row"><label>Prepayment After (months)</label><input class="calc-input" type="number" id="prepayStart" value="1" oninput="calcPrepayment()"></div>
        <div class="calc-output">
          <div class="calc-output-title">Prepayment Savings</div>
          <div class="calc-output-row"><span>Months Saved</span><span class="calc-output-val highlight" id="monthsSaved">—</span></div>
          <div class="calc-output-row"><span>Interest Saved</span><span class="calc-output-val" style="color:var(--green)" id="interestSaved">—</span></div>
          <div class="calc-output-row"><span>New Payoff Date</span><span class="calc-output-val" id="newPayoff">—</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- WEALTH GOAL -->
  <div id="calc-wealth" class="calc-section">
    <div class="calc-card" style="max-width:700px;margin:0 auto">
      <div class="calc-title">🌟 Wealth Goal Planner</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div class="calc-input-row"><label>Target Wealth (₹)</label><input class="calc-input" type="number" id="wealthTarget" value="10000000" oninput="calcWealth()"></div>
        <div class="calc-input-row"><label>Current Savings (₹)</label><input class="calc-input" type="number" id="wealthCurrent" value="500000" oninput="calcWealth()"></div>
        <div class="calc-input-row"><label>Monthly Savings (₹)</label><input class="calc-input" type="number" id="wealthMonthly" value="25000" oninput="calcWealth()"></div>
        <div class="calc-input-row"><label>Expected Return (%/yr)</label><input class="calc-input" type="number" id="wealthReturn" value="12" oninput="calcWealth()"></div>
      </div>
      <div class="calc-output" style="margin-top:20px">
        <div class="calc-output-title">Wealth Projection</div>
        <div class="calc-output-row"><span>Years to Goal</span><span class="calc-output-val highlight" id="yearsToGoal">—</span></div>
        <div class="calc-output-row"><span>Target Date</span><span class="calc-output-val" id="targetDate">—</span></div>
        <div class="calc-output-row"><span>Total Invested</span><span class="calc-output-val" id="wealthTotalInvested">—</span></div>
        <div class="calc-output-row"><span>Wealth Created by Market</span><span class="calc-output-val" style="color:var(--green)" id="wealthByMarket">—</span></div>
      </div>
      <div class="wealth-meter">
        <div class="milestone-row"><span>₹0</span><span id="wealthMid">—</span><span id="wealthTargetLabel">—</span></div>
        <div class="wealth-bar-wrap"><div class="wealth-bar-fill" id="wealthProgress" style="width:5%"></div></div>
        <div class="milestone-row"><span>Start</span><span>Midpoint</span><span>Goal</span></div>
      </div>
    </div>
  </div>

  <!-- FIRE NUMBER -->
  <div id="calc-fire" class="calc-section">
    <div class="calc-card" style="max-width:700px;margin:0 auto">
      <div class="calc-title">🔥 FIRE Number Calculator</div>
      <div style="background:var(--bg3);border-radius:var(--radius2);padding:14px;margin-bottom:20px;font-size:13px;color:var(--text3);line-height:1.6">
        FIRE (Financial Independence, Retire Early) — based on the <strong style="color:var(--text2)">4% Rule</strong>: you can safely withdraw 4% of your portfolio annually in retirement indefinitely.
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div class="calc-input-row"><label>Annual Expenses in Retirement (₹)</label><input class="calc-input" type="number" id="fireExpenses" value="1200000" oninput="calcFIRE()"></div>
        <div class="calc-input-row"><label>Current Net Worth (₹)</label><input class="calc-input" type="number" id="fireCurrentNW" value="2000000" oninput="calcFIRE()"></div>
        <div class="calc-input-row"><label>Annual Savings Rate (₹)</label><input class="calc-input" type="number" id="fireSavings" value="600000" oninput="calcFIRE()"></div>
        <div class="calc-input-row"><label>Expected Return (%/yr)</label><input class="calc-input" type="number" id="fireReturn" value="10" oninput="calcFIRE()"></div>
      </div>
      <div class="calc-output" style="margin-top:20px">
        <div class="calc-output-title">FIRE Analysis</div>
        <div class="calc-output-row"><span>FIRE Number (25× expenses)</span><span class="calc-output-val highlight" id="fireNumber">—</span></div>
        <div class="calc-output-row"><span>Gap to FIRE</span><span class="calc-output-val" id="fireGap">—</span></div>
        <div class="calc-output-row"><span>Years to FIRE</span><span class="calc-output-val" id="fireYears">—</span></div>
        <div class="calc-output-row"><span>FIRE Date</span><span class="calc-output-val" id="fireDate">—</span></div>
        <div class="calc-output-row"><span>Current FIRE %</span><span class="calc-output-val" id="firePercent">—</span></div>
      </div>
    </div>
  </div>

  <!-- COMPOUND INTEREST -->
  <div id="calc-compound" class="calc-section">
    <div class="calc-card" style="max-width:700px;margin:0 auto">
      <div class="calc-title">⚡ Compound Interest Calculator</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div class="calc-input-row"><label>Principal (₹)</label><input class="calc-input" type="number" id="ciPrincipal" value="100000" oninput="calcCI()"></div>
        <div class="calc-input-row"><label>Annual Rate (%)</label><input class="calc-input" type="number" id="ciRate" value="12" oninput="calcCI()"></div>
        <div class="calc-input-row"><label>Years</label><input class="calc-input" type="number" id="ciYears" value="10" oninput="calcCI()"></div>
        <div class="calc-input-row"><label>Compounding Frequency</label>
          <select class="calc-input" id="ciFreq" onchange="calcCI()">
            <option value="1">Annually</option>
            <option value="2">Semi-annually</option>
            <option value="4">Quarterly</option>
            <option value="12" selected>Monthly</option>
            <option value="365">Daily</option>
          </select>
        </div>
      </div>
      <div class="calc-output" style="margin-top:20px">
        <div class="calc-output-title">Compound Growth</div>
        <div class="calc-output-row"><span>Future Value</span><span class="calc-output-val highlight" id="ciFV">—</span></div>
        <div class="calc-output-row"><span>Interest Earned</span><span class="calc-output-val" style="color:var(--green)" id="ciInterest">—</span></div>
        <div class="calc-output-row"><span>Effective Annual Rate</span><span class="calc-output-val" id="ciEAR">—</span></div>
        <div class="calc-output-row"><span>Doubling Time (Rule of 72)</span><span class="calc-output-val" id="ciDouble">—</span></div>
      </div>
      <div style="margin-top:16px;background:var(--bg3);border-radius:var(--radius);padding:16px">
        <div style="font-size:12px;color:var(--text3);margin-bottom:10px;font-family:var(--font-head);font-weight:700">YEAR-BY-YEAR GROWTH</div>
        <div id="ciYearBreakdown" style="display:flex;flex-direction:column;gap:4px;max-height:200px;overflow-y:auto"></div>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════
     DECISION ENGINE VIEW
══════════════════════════════════════════ -->
<div id="view-decision" class="view">
  <div class="section-header">
    <div>
      <div class="section-title">🎯 Decision <span>Engine</span></div>
      <div class="section-sub">Pre-trade systematic scoring · GO / NO-GO verdict · Historical edge from your own data</div>
    </div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">

    <!-- Input Form -->
    <div class="panel">
      <div class="ql-section-title">📋 Trade Setup Input</div>
      <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px">
        <div class="de-input-group"><label>Symbol</label><input class="de-input" id="de-symbol" type="text" placeholder="e.g. RELIANCE, AAPL, BTC"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="de-input-group"><label>Direction</label>
            <select class="de-input-select" id="de-direction"><option>Long</option><option>Short</option></select>
          </div>
          <div class="de-input-group"><label>Market</label>
            <select class="de-input-select" id="de-market">
              <option>NSE</option><option>US Stocks</option><option>Crypto</option><option>Forex</option><option>Commodity</option><option>Index</option><option>Futures</option><option>Options</option>
            </select>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
          <div class="de-input-group"><label>Entry Price</label><input class="de-input" id="de-entry" type="number" placeholder="0.00"></div>
          <div class="de-input-group"><label>Stop Loss</label><input class="de-input" id="de-stop" type="number" placeholder="0.00"></div>
          <div class="de-input-group"><label>Target</label><input class="de-input" id="de-target" type="number" placeholder="0.00"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="de-input-group"><label>Setup Type</label>
            <select class="de-input-select" id="de-setup">
              <option value="">Select setup...</option>
              <option>Breakout</option><option>Momentum</option><option>Mean Reversion</option><option>Trend Follow</option><option>Support Bounce</option><option>Gap Fill</option><option>Earnings</option><option>Macro Hedge</option><option>Other</option>
            </select>
          </div>
          <div class="de-input-group"><label>Market Regime</label>
            <select class="de-input-select" id="de-regime">
              <option>Trending Bull</option><option>Trending Bear</option><option>Ranging</option><option>High Volatility</option><option>Low Volatility</option>
            </select>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="de-input-group"><label>Account Size</label><input class="de-input" id="de-account" type="number" placeholder="100000"></div>
          <div class="de-input-group"><label>Position Size (%)</label><input class="de-input" id="de-possize" type="number" placeholder="1" step="0.1"></div>
        </div>
        <div class="de-input-group"><label>Your Thesis / Notes</label><textarea class="de-input" id="de-thesis" rows="2" placeholder="Why does this setup make sense right now?"></textarea></div>
      </div>
      <!-- Live Quote Panel -->
      <div id="de-live-quote" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);padding:14px;margin-bottom:14px;min-height:52px;font-size:12px;color:var(--text3)">
        Enter a symbol above, then click <strong style="color:var(--accent2)">Fetch Live Data</strong> to see real-time price, RSI and news sentiment before scoring.
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <button class="btn btn-ghost" onclick="enhanceDecisionEngine()" style="justify-content:center;padding:11px">⚡ Fetch Live Data</button>
        <button class="btn btn-primary" onclick="runDecisionEngine()" style="justify-content:center;padding:11px">🧠 Analyse Trade →</button>
      </div>
      <div id="de-live-status" style="margin-top:12px;min-height:20px"></div>
    </div>

    <!-- Scoring Output -->
    <div class="panel" style="text-align:center">
      <div class="ql-section-title" style="justify-content:center">📊 Systematic Score</div>
      <div class="de-score-ring">
        <svg viewBox="0 0 160 160" width="160" height="160">
          <circle cx="80" cy="80" r="68" fill="none" stroke="var(--bg4)" stroke-width="12"/>
          <circle id="de-score-arc" cx="80" cy="80" r="68" fill="none" stroke="var(--accent)" stroke-width="12" stroke-linecap="round" stroke-dasharray="427" stroke-dashoffset="427" style="transition:stroke-dashoffset 1s ease,stroke 0.5s"/>
        </svg>
        <div class="de-score-center">
          <div class="de-score-val" id="de-score-num">—</div>
          <div class="de-score-lbl">/ 100</div>
        </div>
      </div>
      <div id="de-verdict-badge" class="de-verdict caution" style="display:none">—</div>
      <div id="de-checks" style="text-align:left;margin-top:16px">
        <div style="font-size:12px;color:var(--text3);text-align:center;padding:20px">Fill in the form and click Analyse</div>
      </div>
    </div>

  </div>

  <!-- Self-Analysis Prompt -->
  <div class="panel" style="margin-bottom:20px">
    <div class="ql-section-title">🪞 Self-Analysis Prompts</div>
    <div style="display:flex;flex-direction:column;gap:10px">
      <div style="background:var(--bg3);border-radius:var(--radius2);padding:14px;font-size:13px;color:var(--text2);line-height:1.8">
        <strong style="color:var(--accent2);display:block;margin-bottom:6px">Before you enter, ask yourself:</strong>
        Would I still take this trade if I couldn't check the P&L for 30 days? Am I entering because the setup is strong, or because I want to trade? If my best mentor were watching, would I be comfortable taking this trade?
      </div>
      <div style="background:var(--bg3);border-radius:var(--radius2);padding:14px;font-size:13px;color:var(--text2);line-height:1.8">
        <strong style="color:var(--yellow);display:block;margin-bottom:6px">Red flags that should make you wait:</strong>
        You're entering out of FOMO · You haven't defined your stop · You're sizing up after a loss · You're bored · The setup is "close enough" · You've already traded your daily limit
      </div>
    </div>
  </div>

  <!-- Historical Edge for this Setup -->
  <div class="panel">
    <div class="ql-section-title">📚 Your Historical Edge — This Setup vs All Setups</div>
    <div id="de-setup-stats" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
      <div class="metric-box"><div class="metric-box-val" id="de-hist-wr">—</div><div class="metric-box-lbl">Win Rate (this setup)</div></div>
      <div class="metric-box"><div class="metric-box-val" id="de-hist-pf">—</div><div class="metric-box-lbl">Profit Factor</div></div>
      <div class="metric-box"><div class="metric-box-val" id="de-hist-r">—</div><div class="metric-box-lbl">Avg R-Multiple</div></div>
      <div class="metric-box"><div class="metric-box-val" id="de-hist-n">—</div><div class="metric-box-lbl">Sample Size</div></div>
    </div>
  </div>

</div>

<!-- ══════════════════════════════════════════ -->
<!-- MARKET INTEL / BLACKROCK ALADDIN VIEW -->
<!-- ══════════════════════════════════════════ -->
<div id="view-overview" class="view">
  <div class="section-head">
    <div>
      <div class="section-title">🌐 Market <span>Intel</span></div>
      <div class="section-sub">Institutional-grade multi-timeframe macro forecasts — week to decade</div>
    </div>
    <div class="blackrock-header" style="margin-bottom:0">
      <div class="blackrock-logo">BLK</div>
      <div>
        <div class="blackrock-title">Macro Forecast Engine</div>
        <div class="blackrock-sub" id="aladdingUpdateTime">Systematic macro view · Illustrative, not financial advice</div>
      </div>
    </div>
  </div>

  <!-- Timeframe Selector — ALL horizons -->
  <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:20px">
    <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text3);margin-bottom:12px">SELECT FORECAST HORIZON</div>
    <div class="timeframe-tabs" id="tfTabsOverview">
      <button class="tf-btn" data-tf="week" onclick="switchTF(this)">📅 This Week</button>
      <button class="tf-btn" data-tf="month" onclick="switchTF(this)">🗓️ This Month</button>
      <button class="tf-btn" data-tf="quarter" onclick="switchTF(this)">📆 This Quarter</button>
      <button class="tf-btn" data-tf="thisyear" onclick="switchTF(this)">📊 This Year</button>
      <button class="tf-btn" data-tf="threeyear" onclick="switchTF(this)">📈 3 Year</button>
      <button class="tf-btn" data-tf="fiveyear" onclick="switchTF(this)">📈 5 Year</button>
      <button class="tf-btn active" data-tf="decade" onclick="switchTF(this)">🔭 10 Year</button>
      <button class="tf-btn" data-tf="decadePrediction" onclick="switchTF(this)">🚀 Decade Predictions</button>
    </div>
  </div>

  <!-- Aladdin Label + Regime Badge -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
    <div>
      <span style="font-family:var(--font-head);font-size:18px;font-weight:400" id="aladdingTfLabel">10-Year Macro View</span>
      <span class="ai-badge" style="margin-left:12px;vertical-align:middle">
        <span class="ai-dot"></span><span class="ai-dot"></span><span class="ai-dot"></span>
        ALADDIN LIVE
      </span>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap" id="aladdingRegimeBadges">
      <span style="padding:4px 12px;border-radius:16px;background:rgba(61,220,132,0.1);border:1px solid rgba(61,220,132,0.25);font-size:11px;color:var(--green);font-weight:600">RISK-ON</span>
      <span style="padding:4px 12px;border-radius:16px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.25);font-size:11px;color:var(--cyan);font-weight:600">MID-CYCLE</span>
      <span style="padding:4px 12px;border-radius:16px;background:rgba(246,201,14,0.1);border:1px solid rgba(246,201,14,0.25);font-size:11px;color:var(--yellow);font-weight:600">HIGH CONVICTION</span>
    </div>
  </div>

  <!-- Asset Forecast Cards -->
  <div class="outlook-grid" id="overviewCards" style="margin-bottom:20px"></div>

  <!-- Scenarios + Market Cycle -->
  <div class="forecast-section" style="margin-bottom:20px">
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">📊 Scenario Analysis — <span id="scenarioLabel"></span></span>
        <span class="panel-meta">Probability-weighted</span>
      </div>
      <div style="padding:16px">
        <div class="scenario-grid" id="scenarioCards"></div>
        <div style="margin-top:16px;padding:14px;background:var(--bg3);border-radius:var(--radius2);border-left:2px solid var(--accent)">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:10px">PHASE ANALYSIS</div>
          <div id="phasesBlock" style="display:flex;flex-direction:column;gap:10px"></div>
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-header"><span class="panel-title">🔄 Market Cycle</span></div>
      <div style="padding:16px;display:flex;flex-direction:column;align-items:center">
        <canvas id="cycleChart" width="260" height="260"></canvas>
      </div>
    </div>
  </div>

  <!-- Conviction Calls Section -->
  <div class="blackrock-section">
    <div class="blackrock-header">
      <div class="blackrock-logo">BLK</div>
      <div>
        <div class="blackrock-title">Conviction Positioning — Asset Class Views</div>
        <div class="blackrock-sub">Systematic portfolio weight guidance · Illustrative only</div>
      </div>
    </div>
    <div class="conviction-grid" id="convictionGrid">
      <div class="conviction-card">
        <div class="conviction-asset">Global Equities</div>
        <div class="conviction-call overweight">Overweight</div>
        <div class="conviction-reason">AI productivity boom supports earnings. Prefer US tech and India growth over EU.</div>
        <div class="conviction-bar" style="background:linear-gradient(90deg,var(--green),transparent);width:78%"></div>
      </div>
      <div class="conviction-card">
        <div class="conviction-asset">Government Bonds</div>
        <div class="conviction-call underweight">Underweight</div>
        <div class="conviction-reason">Sticky inflation limits duration appeal. Short-end rates attractive but long-end risky.</div>
        <div class="conviction-bar" style="background:linear-gradient(90deg,var(--red),transparent);width:30%"></div>
      </div>
      <div class="conviction-card">
        <div class="conviction-asset">Gold / Commodities</div>
        <div class="conviction-call overweight">Overweight</div>
        <div class="conviction-reason">Central bank buying, geopolitical hedge, dollar diversification trend intact.</div>
        <div class="conviction-bar" style="background:linear-gradient(90deg,var(--green),transparent);width:72%"></div>
      </div>
      <div class="conviction-card">
        <div class="conviction-asset">Bitcoin / Crypto</div>
        <div class="conviction-call overweight">Overweight</div>
        <div class="conviction-reason">ETF flows, halving cycle, institutional accumulation phase supports 18-month outlook.</div>
        <div class="conviction-bar" style="background:linear-gradient(90deg,var(--green),transparent);width:85%"></div>
      </div>
      <div class="conviction-card">
        <div class="conviction-asset">India (NSE/BSE)</div>
        <div class="conviction-call overweight">Overweight</div>
        <div class="conviction-reason">Strongest GDP trajectory among major economies. Demographics, capex supercycle.</div>
        <div class="conviction-bar" style="background:linear-gradient(90deg,var(--green),transparent);width:88%"></div>
      </div>
      <div class="conviction-card">
        <div class="conviction-asset">Real Estate / REITs</div>
        <div class="conviction-call neutral">Neutral</div>
        <div class="conviction-reason">Rate sensitivity limits upside. Regional divergence significant. Prefer data centers.</div>
        <div class="conviction-bar" style="background:linear-gradient(90deg,var(--yellow),transparent);width:50%"></div>
      </div>
    </div>
  </div>

  <!-- Sector Performance -->
  <div class="panel" style="margin-bottom:20px">
    <div class="panel-header"><span class="panel-title">📊 Sector Rotation Intelligence</span><span class="panel-meta">YTD performance</span></div>
    <div style="padding:20px;height:180px"><canvas id="sectorChart" height="140"></canvas></div>
  </div>

  <!-- Decade Predictions Panel (hidden by default, shown when 'decadePrediction' tf selected) -->
  <div id="decadePredPanel" style="display:none">
    <div class="section-head" style="margin-bottom:16px">
      <div>
        <div class="section-title">🚀 Decade <span>Predictions</span> 2025–2035</div>
        <div class="section-sub">Long-range structural macro forecasts · Illustrative</div>
      </div>
    </div>
    <div class="decade-timeline">
      <div class="decade-card" onclick="this.style.borderColor='var(--accent)'">
        <div class="decade-year">2025–2026</div>
        <div class="decade-val" style="color:var(--green)">S&P 6,200</div>
        <div class="decade-label">AI earnings expansion</div>
      </div>
      <div class="decade-card">
        <div class="decade-year">2026–2027</div>
        <div class="decade-val" style="color:var(--cyan)">BTC $200K</div>
        <div class="decade-label">Halving + ETF adoption cycle</div>
      </div>
      <div class="decade-card">
        <div class="decade-year">2027–2028</div>
        <div class="decade-val" style="color:var(--yellow)">NIFTY 40K</div>
        <div class="decade-label">India GDP $5T milestone</div>
      </div>
      <div class="decade-card">
        <div class="decade-year">2028–2029</div>
        <div class="decade-val" style="color:var(--orange)">Gold $4,000</div>
        <div class="decade-label">De-dollarization accelerates</div>
      </div>
      <div class="decade-card">
        <div class="decade-year">2030–2035</div>
        <div class="decade-val" style="color:var(--accent2)">AGI Era</div>
        <div class="decade-label">Productivity revolution</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
      <div class="panel">
        <div class="panel-header"><span class="panel-title">🌍 Megatrend Themes (2025–2035)</span></div>
        <div style="padding:16px;display:flex;flex-direction:column;gap:10px">
          <div class="de-check-row"><div class="de-check-icon pass">✓</div><div><strong>AI & Automation</strong> — Robotics, LLMs, autonomous systems reshape every industry by 2030</div></div>
          <div class="de-check-row"><div class="de-check-icon pass">✓</div><div><strong>Energy Transition</strong> — Solar, batteries, green hydrogen become cost-competitive globally</div></div>
          <div class="de-check-row"><div class="de-check-icon pass">✓</div><div><strong>Asia Rise</strong> — India, Indonesia, Vietnam absorb manufacturing from China</div></div>
          <div class="de-check-row"><div class="de-check-icon warn">⚠</div><div><strong>Dollar Diversification</strong> — BRICS alternatives, gold, BTC as reserve hedges grow</div></div>
          <div class="de-check-row"><div class="de-check-icon warn">⚠</div><div><strong>Demographic Divergence</strong> — Aging West vs young EM creates divergent demand cycles</div></div>
          <div class="de-check-row"><div class="de-check-icon fail">✗</div><div><strong>Geopolitical Fragmentation</strong> — Trade blocs, deglobalization increases supply chain costs</div></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header"><span class="panel-title">📈 Long-Range Price Targets (Illustrative)</span></div>
        <div style="padding:16px">
          <div class="factor-row" style="font-size:11px">
            <div style="color:var(--text3);font-size:10px;text-transform:uppercase">ASSET</div>
            <div style="color:var(--text3);font-size:10px;text-transform:uppercase">2027</div>
            <div style="color:var(--text3);font-size:10px;text-transform:uppercase">2030</div>
            <div style="color:var(--text3);font-size:10px;text-transform:uppercase">2035</div>
          </div>
          <div class="factor-row"><div>S&P 500</div><div style="color:var(--green);font-family:var(--font-mono)">6,800</div><div style="color:var(--green);font-family:var(--font-mono)">8,500</div><div style="color:var(--green);font-family:var(--font-mono)">12,000</div></div>
          <div class="factor-row"><div>Gold</div><div style="color:var(--green);font-family:var(--font-mono)">$2,800</div><div style="color:var(--green);font-family:var(--font-mono)">$3,800</div><div style="color:var(--green);font-family:var(--font-mono)">$5,500</div></div>
          <div class="factor-row"><div>Bitcoin</div><div style="color:var(--green);font-family:var(--font-mono)">$180K</div><div style="color:var(--green);font-family:var(--font-mono)">$350K</div><div style="color:var(--accent2);font-family:var(--font-mono)">$1M+</div></div>
          <div class="factor-row"><div>NIFTY 50</div><div style="color:var(--green);font-family:var(--font-mono)">32,000</div><div style="color:var(--green);font-family:var(--font-mono)">48,000</div><div style="color:var(--green);font-family:var(--font-mono)">75,000</div></div>
          <div class="factor-row"><div>Crude Oil</div><div style="color:var(--yellow);font-family:var(--font-mono)">$70</div><div style="color:var(--red);font-family:var(--font-mono)">$55</div><div style="color:var(--red);font-family:var(--font-mono)">$40</div></div>
          <div class="factor-row"><div>US10Y Yield</div><div style="color:var(--green);font-family:var(--font-mono)">3.80%</div><div style="color:var(--green);font-family:var(--font-mono)">3.20%</div><div style="color:var(--yellow);font-family:var(--font-mono)">3.50%</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- News + Economic Calendar -->
  <div class="news-grid">
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">📰 Market Intelligence Feed</span>
        <div id="newsFilters" style="display:flex;gap:4px;flex-wrap:wrap">
          <span class="screener-tag active" onclick="filterNews('All',this)">All</span>
          <span class="screener-tag" onclick="filterNews('Macro',this)">Macro</span>
          <span class="screener-tag" onclick="filterNews('Equities',this)">Equities</span>
          <span class="screener-tag" onclick="filterNews('India',this)">India</span>
          <span class="screener-tag" onclick="filterNews('Crypto',this)">Crypto</span>
          <span class="screener-tag" onclick="filterNews('Forex',this)">Forex</span>
        </div>
      </div>
      <div id="newsFeed"></div>
    </div>
    <div>
      <div class="panel" style="margin-bottom:12px">
        <div class="panel-header"><span class="panel-title">😨 Fear & Greed Index</span></div>
        <div style="padding:16px;text-align:center">
          <canvas id="fearGreedGauge" width="200" height="110"></canvas>
          <div style="font-family:var(--font-mono);font-size:32px;font-weight:300;margin-top:8px" id="fgValue">62</div>
          <div style="font-size:12px;margin-top:2px" id="fgLabel">Greed</div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header"><span class="panel-title">📅 Economic Calendar</span></div>
        <div id="economicCalendar" style="padding:4px 0"></div>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════ -->
<!-- SCREENER VIEW -->
<!-- ══════════════════════════════════════════ -->
<div id="view-screener" class="view">
  <div class="section-head">
    <div>
      <div class="section-title">🔍 Stock <span>Screener</span></div>
      <div class="section-sub">Multi-market scanner · Technical + momentum signals across 60+ instruments</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <span style="display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:12px;font-size:10px;font-weight:700;background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.25)">
        <span class="live-status-dot" style="color:var(--yellow)">⟳</span>
        <span class="live-status-text" style="color:var(--green)">LIVE</span>
      </span>
      <span id="screenerCount" style="font-size:12px;color:var(--text3);font-family:var(--font-mono)">— results</span>
      <button class="btn btn-ghost" onclick="renderScreener()" style="font-size:12px">🔄 Refresh Live</button>
      <button class="btn btn-primary" onclick="runScreener()" style="font-size:12px">▶ Filter</button>
    </div>
  </div>

  <!-- Preset Tags -->
  <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px">
    <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text3);margin-bottom:10px">⚡ SMART PRESETS</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap" id="presetTags">
      <span class="screener-tag" onclick="applyPreset('oversold',this)">🟢 Oversold (RSI &lt; 30)</span>
      <span class="screener-tag" onclick="applyPreset('overbought',this)">🔴 Overbought (RSI &gt; 70)</span>
      <span class="screener-tag" onclick="applyPreset('strongBuy',this)">💎 Strong Buy</span>
      <span class="screener-tag" onclick="applyPreset('bullishMomentum',this)">🚀 Bullish Momentum</span>
      <span class="screener-tag" onclick="applyPreset('highVol',this)">⚡ High Volume Surge</span>
      <span class="screener-tag" onclick="applyPreset('uptrend',this)">📈 In Uptrend</span>
      <span class="screener-tag" onclick="applyPreset('cryptoBull',this)">₿ Crypto Bullish</span>
      <span class="screener-tag" onclick="applyPreset('indianMarket',this)">🇮🇳 India Focus</span>
    </div>
  </div>

  <!-- Advanced Filters -->
  <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px">
    <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text3);margin-bottom:12px">🎛️ ADVANCED FILTERS</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;align-items:end">
      <div class="de-input-group">
        <label>Market</label>
        <select class="de-input-select" id="sc-market">
          <option value="">All Markets</option>
          <option>NSE</option><option>US Stocks</option><option>Crypto</option>
          <option>Forex</option><option>Commodity</option>
        </select>
      </div>
      <div class="de-input-group">
        <label>Signal</label>
        <select class="de-input-select" id="sc-signal">
          <option value="">All Signals</option>
          <option>Strong Buy</option><option>Buy</option><option>Neutral</option>
          <option>Sell</option><option>Strong Sell</option>
        </select>
      </div>
      <div class="de-input-group">
        <label>Trend</label>
        <select class="de-input-select" id="sc-trend">
          <option value="">All Trends</option>
          <option>Uptrend</option><option>Downtrend</option><option>Ranging</option>
        </select>
      </div>
      <div class="de-input-group">
        <label>RSI Min</label>
        <input class="de-input" id="sc-rsiMin" type="number" placeholder="0" min="0" max="100">
      </div>
      <div class="de-input-group">
        <label>RSI Max</label>
        <input class="de-input" id="sc-rsiMax" type="number" placeholder="100" min="0" max="100">
      </div>
      <div class="de-input-group">
        <label>Chg% Min</label>
        <input class="de-input" id="sc-chgMin" type="number" placeholder="-100" step="0.1">
      </div>
      <div class="de-input-group">
        <label>Chg% Max</label>
        <input class="de-input" id="sc-chgMax" type="number" placeholder="100" step="0.1">
      </div>
      <div class="de-input-group">
        <label>Min Volume (×)</label>
        <input class="de-input" id="sc-vol" type="number" placeholder="0" step="0.1" min="0">
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn btn-ghost" onclick="resetScreener()" style="width:100%;justify-content:center">↺ Reset</button>
      </div>
    </div>
  </div>

  <!-- Benchmark Strip -->
  <div class="benchmark-grid" id="benchmarkGrid" style="margin-bottom:16px">
    <div class="bm-card">
      <div class="bm-label">S&P 500 YTD</div>
      <div class="bm-value" style="color:var(--green)">+8.2%</div>
      <div class="bm-vs">vs your avg <span id="bm-sp">—</span></div>
      <div class="bm-bar"><div class="bm-bar-you" id="bm-sp-bar" style="width:82%"></div></div>
    </div>
    <div class="bm-card">
      <div class="bm-label">NIFTY 50 YTD</div>
      <div class="bm-value" style="color:var(--green)">+4.1%</div>
      <div class="bm-vs">vs your avg <span id="bm-nifty">—</span></div>
      <div class="bm-bar"><div class="bm-bar-you" id="bm-nifty-bar" style="width:41%"></div></div>
    </div>
    <div class="bm-card">
      <div class="bm-label">Bitcoin YTD</div>
      <div class="bm-value" style="color:var(--green)">+42%</div>
      <div class="bm-vs">vs your avg <span id="bm-btc">—</span></div>
      <div class="bm-bar"><div class="bm-bar-you" id="bm-btc-bar" style="width:100%"></div></div>
    </div>
    <div class="bm-card">
      <div class="bm-label">Gold YTD</div>
      <div class="bm-value" style="color:var(--green)">+14%</div>
      <div class="bm-vs">vs your avg <span id="bm-gold">—</span></div>
      <div class="bm-bar"><div class="bm-bar-you" id="bm-gold-bar" style="width:100%"></div></div>
    </div>
  </div>

  <!-- Results Table -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Market</th>
          <th>Price</th>
          <th>Chg%</th>
          <th style="min-width:130px">RSI</th>
          <th>MACD</th>
          <th>Volume</th>
          <th>Trend</th>
          <th>Signal</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="screenerBody">
        <tr>
          <td colspan="10">
            <div class="empty-state">
              <div class="empty-icon">🔍</div>
              <div class="empty-title">Run the Screener</div>
              <div class="empty-sub">Select your filters above and click Run Screener to find opportunities</div>
              <button class="btn btn-primary" onclick="runScreener()">▶ Run Screener</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Signal Legend -->
  <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:14px;align-items:center">
    <span style="font-size:11px;color:var(--text3)">Signal Legend:</span>
    <span class="signal-badge signal-strong-buy">Strong Buy</span>
    <span class="signal-badge signal-buy">Buy</span>
    <span class="signal-badge signal-neutral">Neutral</span>
    <span class="signal-badge signal-sell">Sell</span>
    <span class="signal-badge signal-strong-sell">Strong Sell</span>
  </div>
</div>

<!-- ══════════════════════════════════════════ -->
<!-- NEWS & ECONOMIC CALENDAR VIEW -->
<!-- ══════════════════════════════════════════ -->
<div id="view-news" class="view">

  <!-- Header -->
  <div class="section-head">
    <div>
      <div class="section-title">📰 News & <span>Economic Calendar</span></div>
      <div class="section-sub">Market intelligence feed · Macro events · Rate monitor · Earnings calendar</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span id="newsLastUpdated" style="font-size:11px;color:var(--text3);font-family:var(--font-mono)"></span>
      <span id="news-status" style="font-size:11px;color:var(--text3)">⚫ No live news</span>
      <span id="calendar-status" style="font-size:11px;color:var(--text3)">⚫ No live calendar</span>
      <button class="btn btn-ghost" onclick="refreshNewsTab()" style="font-size:12px">🔄 Refresh</button>
    </div>
  </div>

  <!-- Live Market Ticker -->
  <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:20px">
    <div style="overflow:hidden;padding:10px 0;position:relative">
      <div class="ticker-track" id="tickerTrack">
        <!-- Filled by JS -->
      </div>
    </div>
  </div>

  <!-- Rate Monitor -->
  <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text3);margin-bottom:12px">🏦 CENTRAL BANK RATE MONITOR</div>
  <div class="rate-grid">
    <div class="rate-card up">
      <div class="rate-lbl">US Fed Funds Rate</div>
      <div class="rate-val">5.25–5.50%</div>
      <div class="rate-chg" style="color:var(--red)">▲ Held — Jan 2026</div>
      <div class="rate-next">Next meeting: Mar 18, 2026</div>
    </div>
    <div class="rate-card flat">
      <div class="rate-lbl">RBI Repo Rate</div>
      <div class="rate-val">6.50%</div>
      <div class="rate-chg" style="color:var(--yellow)">◆ Held — Feb 2026</div>
      <div class="rate-next">Next meeting: Apr 7, 2026</div>
    </div>
    <div class="rate-card dn">
      <div class="rate-lbl">ECB Main Rate</div>
      <div class="rate-val">4.50%</div>
      <div class="rate-chg" style="color:var(--green)">▼ Cut likely Mar 2026</div>
      <div class="rate-next">Next meeting: Mar 5, 2026</div>
    </div>
    <div class="rate-card flat">
      <div class="rate-lbl">Bank of Japan Rate</div>
      <div class="rate-val">0.10%</div>
      <div class="rate-chg" style="color:var(--yellow)">◆ Held — Jan 2026</div>
      <div class="rate-next">Next meeting: Mar 18, 2026</div>
    </div>
    <div class="rate-card flat">
      <div class="rate-lbl">Bank of England</div>
      <div class="rate-val">5.25%</div>
      <div class="rate-chg" style="color:var(--yellow)">◆ Held — Feb 2026</div>
      <div class="rate-next">Next meeting: Mar 19, 2026</div>
    </div>
    <div class="rate-card dn">
      <div class="rate-lbl">PBOC LPR (1Y)</div>
      <div class="rate-val">3.45%</div>
      <div class="rate-chg" style="color:var(--green)">▼ Cut — Jan 2026</div>
      <div class="rate-next">Stimulus bias ongoing</div>
    </div>
    <div class="rate-card up">
      <div class="rate-lbl">US 10Y Yield</div>
      <div class="rate-val">4.35%</div>
      <div class="rate-chg" style="color:var(--red)">▲ +12bps this week</div>
      <div class="rate-next">Watch: Fed minutes Wed</div>
    </div>
    <div class="rate-card up">
      <div class="rate-lbl">India 10Y Yield</div>
      <div class="rate-val">7.12%</div>
      <div class="rate-chg" style="color:var(--red)">▲ +3bps this week</div>
      <div class="rate-next">RBI OMO operations</div>
    </div>
  </div>

  <!-- Main News + Calendar layout -->
  <div style="display:grid;grid-template-columns:1fr 380px;gap:16px;margin-bottom:20px">

    <!-- News Feed -->
    <div>
      <!-- Filters -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
        <div class="ai-badge">
          <span class="ai-dot"></span><span class="ai-dot"></span><span class="ai-dot"></span>
          LIVE INTELLIGENCE FEED
        </div>
        <div style="display:flex;gap:5px;flex-wrap:wrap" id="newsTabFilters">
          <span class="screener-tag active" onclick="filterNewsTab('All',this)">All</span>
          <span class="screener-tag" onclick="filterNewsTab('Macro',this)">🌍 Macro</span>
          <span class="screener-tag" onclick="filterNewsTab('Equities',this)">📊 Equities</span>
          <span class="screener-tag" onclick="filterNewsTab('India',this)">🇮🇳 India</span>
          <span class="screener-tag" onclick="filterNewsTab('Crypto',this)">₿ Crypto</span>
          <span class="screener-tag" onclick="filterNewsTab('Forex',this)">💱 Forex</span>
        </div>
      </div>
      <div class="panel">
        <div id="newsTabFeed" style="max-height:580px;overflow-y:auto"></div>
      </div>
    </div>

    <!-- Economic Calendar -->
    <div>
      <div style="font-size:11px;font-weight:600;color:var(--text2);margin-bottom:12px;display:flex;align-items:center;gap:8px">
        📅 Economic Calendar — This Week
        <span style="margin-left:auto;display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text3)">
          <span style="display:inline-block;width:7px;height:7px;border-radius:2px;background:var(--red)"></span>High
          <span style="display:inline-block;width:7px;height:7px;border-radius:2px;background:var(--yellow)"></span>Med
          <span style="display:inline-block;width:7px;height:7px;border-radius:2px;background:var(--text3)"></span>Low
        </span>
      </div>
      <div class="panel">
        <div id="calendarTabFull" style="max-height:580px;overflow-y:auto"></div>
      </div>

      <!-- Fear & Greed -->
      <div class="panel" style="margin-top:12px">
        <div class="panel-header"><span class="panel-title">😨 Fear & Greed Index</span><span class="panel-meta" id="fgDate">Updated daily</span></div>
        <div style="padding:16px;text-align:center">
          <canvas id="fearGreedGaugeNews" width="200" height="110"></canvas>
          <div style="font-family:var(--font-mono);font-size:36px;font-weight:300;margin:6px 0;color:var(--green)" id="fgValueNews">72</div>
          <div style="font-size:13px;margin-bottom:10px;color:var(--green)" id="fgLabelNews">Greed</div>
          <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:4px;font-size:9px;color:var(--text3);text-align:center">
            <div>Extreme<br>Fear</div><div>Fear</div><div>Neutral</div><div>Greed</div><div>Extreme<br>Greed</div>
          </div>
          <div style="height:4px;border-radius:2px;background:linear-gradient(90deg,var(--red),var(--orange),var(--yellow),var(--green),#22c55e);margin-top:6px"></div>
          <div style="margin-top:12px;font-size:11px;color:var(--text3);line-height:1.6">
            Previous: <span style="color:var(--text);font-family:var(--font-mono)" id="fgHistPrev">68 (Greed)</span><br>
            1 Week Ago: <span style="color:var(--text);font-family:var(--font-mono)" id="fgHistWeek">58 (Greed)</span><br>
            1 Month Ago: <span style="color:var(--yellow);font-family:var(--font-mono)">52 (Neutral)</span>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Earnings Calendar -->
  <div class="panel" style="margin-bottom:20px">
    <div class="panel-header">
      <span class="panel-title">📈 Upcoming Earnings — Next 2 Weeks</span>
      <span id="earnings-status" style="font-size:11px;color:var(--text3)">⚫</span>
      <span class="panel-meta">Next 2 weeks</span>
    </div>
    <div style="overflow-x:auto">
      <table style="width:100%;border-collapse:collapse;font-size:12px">
        <thead>
          <tr>
            <th style="padding:10px 14px;text-align:left;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);border-bottom:1px solid var(--border);background:var(--bg3)">Date</th>
            <th style="padding:10px 14px;text-align:left;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);border-bottom:1px solid var(--border);background:var(--bg3)">Company</th>
            <th style="padding:10px 14px;text-align:left;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);border-bottom:1px solid var(--border);background:var(--bg3)">Time</th>
            <th style="padding:10px 14px;text-align:left;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);border-bottom:1px solid var(--border);background:var(--bg3)">EPS Est.</th>
            <th style="padding:10px 14px;text-align:left;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);border-bottom:1px solid var(--border);background:var(--bg3)">Rev Est.</th>
            <th style="padding:10px 14px;text-align:left;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);border-bottom:1px solid var(--border);background:var(--bg3)">Market Cap</th>
            <th style="padding:10px 14px;text-align:left;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);border-bottom:1px solid var(--border);background:var(--bg3)">Watch</th>
          </tr>
        </thead>
        <tbody id="earningsBody">
          <!-- filled by JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Macro Heatmap -->
  <div class="panel" style="margin-bottom:20px">
    <div class="panel-header">
      <span class="panel-title">🗺️ Global Macro Heatmap</span>
      <span class="panel-meta">Current conditions · Color = Risk level</span>
    </div>
    <div style="padding:16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px" id="macroHeatmap">
      <!-- filled by JS -->
    </div>
  </div>

</div>

<!-- ══════════════════════════════════════════ -->
<!-- 📡 LIVE MARKETS VIEW                     -->
<!-- ══════════════════════════════════════════ -->
<div id="view-livemarkets" class="view">
  <div class="section-head">
    <div>
      <div class="section-title">📡 Live <span>Markets</span></div>
      <div class="section-sub">Real-time NSE/BSE · Indian F&amp;O · US Markets · Crypto · Forex — Angel One + Free APIs</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button class="btn btn-ghost" onclick="openAngelOneSetup()" style="border-color:rgba(255,140,0,0.4);color:#ff8c00;gap:6px">
        <span style="font-size:14px">🔶</span> Angel One Setup
      </button>
      <button class="btn btn-ghost" onclick="refreshLiveMarkets()" style="border-color:rgba(74,222,128,0.3);color:var(--green)">🔄 Refresh All</button>
      <span id="lm-last-updated" style="font-size:10px;color:var(--text3);font-family:var(--font-mono)">Last updated: —</span>
    </div>
  </div>

  <!-- Connection Status Strip -->
  <div class="lm-connection-strip">
    <span style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--text3);margin-right:4px">Data Sources:</span>
    <div class="lm-conn-item" id="conn-angelone">
      <div class="lm-conn-dot offline" id="conn-angelone-dot"></div>
      <span>Angel One</span>
    </div>
    <div class="lm-conn-item" id="conn-coingecko">
      <div class="lm-conn-dot live" id="conn-cg-dot"></div>
      <span>CoinGecko</span>
    </div>
    <div class="lm-conn-item" id="conn-forex">
      <div class="lm-conn-dot live" id="conn-fx-dot"></div>
      <span>Frankfurter</span>
    </div>
    <div class="lm-conn-item" id="conn-finnhub">
      <div class="lm-conn-dot offline" id="conn-fh-dot"></div>
      <span>Finnhub</span>
    </div>
    <div style="margin-left:auto;font-size:10px;color:var(--text3)">
      <span id="lm-angel-status">🔶 Angel One not configured — <a href="#" onclick="openAngelOneSetup()" style="color:var(--accent2)">Set up now →</a></span>
    </div>
  </div>

  <!-- ── ROW 1: NSE Indices + BankNifty + SGX Nifty ── -->
  <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:0.12em;color:var(--text3);margin-bottom:10px">🇮🇳 NSE / BSE INDICES</div>
  <div class="lm-grid" style="margin-bottom:20px">
    <!-- Indian Indices -->
    <div class="lm-panel">
      <div class="lm-panel-head">
        <span class="lm-panel-title">🇮🇳 Indian Indices</span>
        <span class="lm-panel-status" id="lm-nse-status" style="color:var(--text3)">⚫ Offline</span>
      </div>
      <div id="lm-nse-indices">
        <div class="lm-index-card">
          <div><div class="lm-index-name">NIFTY 50</div><div class="lm-index-sub">NSE · Broad Market</div></div>
          <div><div class="lm-index-price" id="idx-nifty50">—</div><div class="lm-index-chg" id="idx-nifty50-chg">—</div></div>
        </div>
        <div class="lm-index-card">
          <div><div class="lm-index-name">BANK NIFTY</div><div class="lm-index-sub">NSE · Banking Sector</div></div>
          <div><div class="lm-index-price" id="idx-banknifty">—</div><div class="lm-index-chg" id="idx-banknifty-chg">—</div></div>
        </div>
        <div class="lm-index-card">
          <div><div class="lm-index-name">NIFTY IT</div><div class="lm-index-sub">NSE · Technology</div></div>
          <div><div class="lm-index-price" id="idx-niftyit">—</div><div class="lm-index-chg" id="idx-niftyit-chg">—</div></div>
        </div>
        <div class="lm-index-card">
          <div><div class="lm-index-name">SENSEX</div><div class="lm-index-sub">BSE · 30 Stocks</div></div>
          <div><div class="lm-index-price" id="idx-sensex">—</div><div class="lm-index-chg" id="idx-sensex-chg">—</div></div>
        </div>
        <div class="lm-index-card">
          <div><div class="lm-index-name">NIFTY MIDCAP</div><div class="lm-index-sub">NSE · Mid Cap 50</div></div>
          <div><div class="lm-index-price" id="idx-midcap">—</div><div class="lm-index-chg" id="idx-midcap-chg">—</div></div>
        </div>
        <div class="lm-index-card">
          <div><div class="lm-index-name">INDIA VIX</div><div class="lm-index-sub">Volatility Index</div></div>
          <div><div class="lm-index-price" id="idx-indiavix">—</div><div class="lm-index-chg" id="idx-indiavix-chg">—</div></div>
        </div>
      </div>
    </div>

    <!-- US Markets -->
    <div class="lm-panel">
      <div class="lm-panel-head">
        <span class="lm-panel-title">🇺🇸 US Markets</span>
        <span class="lm-panel-status" id="lm-us-status" style="color:var(--text3)">⚫ Add Finnhub key</span>
      </div>
      <div id="lm-us-indices">
        <div class="lm-index-card">
          <div><div class="lm-index-name">S&amp;P 500</div><div class="lm-index-sub">SPY ETF · Broad Market</div></div>
          <div><div class="lm-index-price" id="idx-spy">—</div><div class="lm-index-chg" id="idx-spy-chg">—</div></div>
        </div>
        <div class="lm-index-card">
          <div><div class="lm-index-name">NASDAQ 100</div><div class="lm-index-sub">QQQ ETF · Tech Heavy</div></div>
          <div><div class="lm-index-price" id="idx-qqq">—</div><div class="lm-index-chg" id="idx-qqq-chg">—</div></div>
        </div>
        <div class="lm-index-card">
          <div><div class="lm-index-name">DOW JONES</div><div class="lm-index-sub">DIA ETF · Blue Chip</div></div>
          <div><div class="lm-index-price" id="idx-dia">—</div><div class="lm-index-chg" id="idx-dia-chg">—</div></div>
        </div>
        <div class="lm-index-card">
          <div><div class="lm-index-name">RUSSELL 2000</div><div class="lm-index-sub">IWM ETF · Small Cap</div></div>
          <div><div class="lm-index-price" id="idx-iwm">—</div><div class="lm-index-chg" id="idx-iwm-chg">—</div></div>
        </div>
        <div class="lm-index-card">
          <div><div class="lm-index-name">VIX</div><div class="lm-index-sub">CBOE Volatility</div></div>
          <div><div class="lm-index-price" id="idx-vix">—</div><div class="lm-index-chg" id="idx-vix-chg">—</div></div>
        </div>
        <div class="lm-index-card">
          <div><div class="lm-index-name">GOLD</div><div class="lm-index-sub">GLD ETF</div></div>
          <div><div class="lm-index-price" id="idx-gld">—</div><div class="lm-index-chg" id="idx-gld-chg">—</div></div>
        </div>
      </div>
    </div>

    <!-- Crypto Markets -->
    <div class="lm-panel">
      <div class="lm-panel-head">
        <span class="lm-panel-title">₿ Crypto Markets</span>
        <span class="lm-panel-status" id="lm-crypto-status" style="color:var(--yellow)">⟳ Loading…</span>
      </div>
      <div id="lm-crypto-cards">
        <div style="padding:20px;text-align:center;color:var(--text3);font-size:12px">Loading crypto prices…</div>
      </div>
    </div>
  </div>

  <!-- ── ROW 2: F&O Chain + Forex ── -->
  <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:0.12em;color:var(--text3);margin-bottom:10px">📊 F&amp;O OPTION CHAIN + FOREX</div>
  <div class="lm-grid-fo">
    <!-- F&O Chain -->
    <div class="lm-panel">
      <div class="lm-panel-head">
        <span class="lm-panel-title">⛓ F&amp;O Option Chain</span>
        <div style="display:flex;align-items:center;gap:8px">
          <select id="fo-symbol-select" class="de-input-select" style="padding:4px 8px;font-size:11px;width:auto" onchange="loadFOChain()">
            <option value="NIFTY">NIFTY</option>
            <option value="BANKNIFTY">BANKNIFTY</option>
            <option value="FINNIFTY">FINNIFTY</option>
            <option value="MIDCPNIFTY">MIDCPNIFTY</option>
          </select>
          <select id="fo-expiry-select" class="de-input-select" style="padding:4px 8px;font-size:11px;width:auto" onchange="loadFOChain()">
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
          <span class="lm-panel-status" id="lm-fo-status" style="color:var(--text3)">⚫ Needs Angel One</span>
        </div>
      </div>
      <!-- PCR + Max Pain Strip -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;padding:12px 14px;border-bottom:1px solid var(--border);background:var(--bg3)">
        <div style="text-align:center">
          <div style="font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px">Put/Call Ratio</div>
          <div style="font-family:var(--font-mono);font-size:18px" id="fo-pcr">—</div>
          <div style="font-size:9px;color:var(--text3)" id="fo-pcr-signal">—</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px">Max Pain</div>
          <div style="font-family:var(--font-mono);font-size:18px" id="fo-maxpain">—</div>
          <div style="font-size:9px;color:var(--text3)">Strike Level</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px">Total OI</div>
          <div style="font-family:var(--font-mono);font-size:18px" id="fo-total-oi">—</div>
          <div style="font-size:9px;color:var(--text3)" id="fo-oi-change">—</div>
        </div>
      </div>
      <!-- Chain Table -->
      <div style="overflow-x:auto">
        <div class="fo-chain-header">
          <div style="color:var(--green)">OI (CALLS)</div>
          <div style="color:var(--green)">LTP</div>
          <div style="color:var(--green)">Chg%</div>
          <div style="text-align:center">STRIKE</div>
          <div style="color:var(--red)">Chg%</div>
          <div style="color:var(--red)">LTP</div>
          <div style="color:var(--red)">OI (PUTS)</div>
        </div>
        <div id="fo-chain-body">
          <div style="padding:30px;text-align:center;color:var(--text3);font-size:12px">
            Configure Angel One API to see live F&amp;O chain.<br>
            <a href="#" onclick="openAngelOneSetup()" style="color:var(--accent2);font-size:12px">Set up Angel One →</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Forex + Commodities -->
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="lm-panel">
        <div class="lm-panel-head">
          <span class="lm-panel-title">💱 Forex Rates</span>
          <span class="lm-panel-status" id="lm-fx-status" style="color:var(--yellow)">⟳ Loading…</span>
        </div>
        <div id="lm-forex-rates">
          <div style="padding:20px;text-align:center;color:var(--text3);font-size:12px">Loading rates…</div>
        </div>
      </div>
      <div class="lm-panel">
        <div class="lm-panel-head">
          <span class="lm-panel-title">🛢 Commodities</span>
          <span class="lm-panel-status" style="color:var(--text3)">Live · CoinGecko + Finnhub</span>
        </div>
        <div id="lm-commodities">
          <div class="lm-forex-row">
            <div><div style="font-size:12px;font-weight:600">MCX GOLD</div><div style="font-size:10px;color:var(--text3)">₹/10g</div></div>
            <div><div style="font-family:var(--font-mono);font-size:14px" id="com-gold">—</div><div class="lm-index-chg" id="com-gold-chg">—</div></div>
          </div>
          <div class="lm-forex-row">
            <div><div style="font-size:12px;font-weight:600">MCX SILVER</div><div style="font-size:10px;color:var(--text3)">₹/kg</div></div>
            <div><div style="font-family:var(--font-mono);font-size:14px" id="com-silver">—</div><div class="lm-index-chg" id="com-silver-chg">—</div></div>
          </div>
          <div class="lm-forex-row">
            <div><div style="font-size:12px;font-weight:600">CRUDE OIL</div><div style="font-size:10px;color:var(--text3)">MCX ₹/bbl</div></div>
            <div><div style="font-family:var(--font-mono);font-size:14px" id="com-crude">—</div><div class="lm-index-chg" id="com-crude-chg">—</div></div>
          </div>
          <div class="lm-forex-row">
            <div><div style="font-size:12px;font-weight:600">USD/INR</div><div style="font-size:10px;color:var(--text3)">Indian Rupee</div></div>
            <div><div style="font-family:var(--font-mono);font-size:14px" id="com-usdinr">—</div><div class="lm-index-chg" id="com-usdinr-chg">—</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ── ROW 3: Top Movers (NSE + US) ── -->
  <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:0.12em;color:var(--text3);margin-bottom:10px">🔥 TOP MOVERS</div>
  <div class="lm-grid-2" style="margin-bottom:20px">
    <div class="lm-panel">
      <div class="lm-panel-head">
        <span class="lm-panel-title">🇮🇳 NSE Top Movers</span>
        <div style="display:flex;gap:6px">
          <button onclick="setMoverFilter('gainers')" id="mover-gain-btn" class="btn btn-ghost" style="padding:3px 9px;font-size:10px;color:var(--green);border-color:rgba(74,222,128,0.3)">▲ Gainers</button>
          <button onclick="setMoverFilter('losers')" id="mover-loss-btn" class="btn btn-ghost" style="padding:3px 9px;font-size:10px">▼ Losers</button>
        </div>
      </div>
      <div id="lm-nse-movers">
        <div style="padding:20px;text-align:center;color:var(--text3);font-size:12px">Configure Angel One to see live movers.<br><a href="#" onclick="openAngelOneSetup()" style="color:var(--accent2)">Set up →</a></div>
      </div>
    </div>
    <div class="lm-panel">
      <div class="lm-panel-head">
        <span class="lm-panel-title">🇺🇸 US Movers &amp; Crypto</span>
        <span class="lm-panel-status" id="lm-us-movers-status" style="color:var(--text3)">⚫</span>
      </div>
      <div id="lm-us-movers">
        <div style="padding:20px;text-align:center;color:var(--text3);font-size:12px">Loading…</div>
      </div>
    </div>
  </div>

  <!-- ── ANGEL ONE SETUP INFO ── -->
  <div class="angel-config-box" id="ao-config-section">
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:16px">
      <div style="width:44px;height:44px;background:linear-gradient(135deg,#ff8c00,#ff4500);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">🔶</div>
      <div>
        <div style="font-family:var(--font-head);font-size:17px;font-weight:400">Angel One SmartAPI</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">Real-time NSE/BSE WebSocket feed · F&amp;O Chain · Live Indices · Top Movers</div>
      </div>
      <button onclick="openAngelOneSetup()" class="btn btn-primary" style="margin-left:auto;background:linear-gradient(135deg,#ff8c00,#ff6500)">Configure →</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;font-size:12px">
      <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px">
        <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px">Step 1 — Get API Key</div>
        <div style="color:var(--text2);line-height:1.6">Go to <strong style="color:var(--accent2)">smartapi.angelbroking.com</strong> → My Apps → Create App → Copy your API Key</div>
      </div>
      <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px">
        <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px">Step 2 — Install Python Bridge</div>
        <div style="color:var(--text2);line-height:1.6">Run <code style="background:var(--bg4);padding:1px 5px;border-radius:3px;font-size:11px">pip install smartapi-python websockets pyotp</code> in your terminal</div>
      </div>
      <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px">
        <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px">Step 3 — Run Bridge</div>
        <div style="color:var(--text2);line-height:1.6">Download <strong style="color:var(--accent2)">angel_bridge.py</strong> → Fill credentials → Run → This journal auto-connects via WebSocket</div>
      </div>
    </div>
    <div style="margin-top:12px;font-size:11px;color:var(--text3);display:flex;align-items:center;gap:8px">
      <span style="color:var(--green)">✓</span> Free tier data via Finnhub &amp; CoinGecko loads automatically without any setup
      <span style="margin-left:16px;color:var(--yellow)">⚠</span> Angel One WebSocket requires the Python bridge running locally
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════ -->
<!-- CHANGELOG / KNOWN BUGS VIEW              -->
<!-- ══════════════════════════════════════════ -->
<div id="view-changelog" class="view">
  <div class="section-head">
    <div>
      <div class="section-title">🐛 Changelog &amp; <span>Known Issues</span></div>
      <div class="section-sub">v8.0 — All bugs from the original code review have been fixed in this release</div>
    </div>
  </div>

  <!-- v8.0 Summary Banner -->
  <div style="background:linear-gradient(135deg,rgba(34,197,94,0.08),rgba(74,222,128,0.04));border:1px solid rgba(34,197,94,0.25);border-radius:12px;padding:20px 24px;margin-bottom:24px;display:flex;align-items:center;gap:16px">
    <div style="font-size:40px;flex-shrink:0">✅</div>
    <div>
      <div style="font-family:var(--font-head);font-size:17px;font-weight:700;color:var(--green);margin-bottom:4px">v8.0 — All 13 Bugs Fixed</div>
      <div style="font-size:13px;color:var(--text2);line-height:1.6">This release resolves all bugs identified during the production readiness audit. The two critical security issues (hardcoded API keys), the drawdown calculation error, CSV import corruption, and 9 other bugs have all been corrected. No known open issues remain.</div>
    </div>
  </div>

  <!-- v8.0 Fixed Bugs Table -->
  <div class="panel" style="margin-bottom:24px">
    <div class="panel-header">
      <span class="panel-title">🔧 v8.0 — Fixed in This Release</span>
      <span class="panel-meta">February 2026</span>
    </div>
    <div style="padding:0">
      <table class="legend-table" style="width:100%">
        <thead>
          <tr>
            <th style="width:32px">#</th>
            <th style="width:90px">Severity</th>
            <th>Issue</th>
            <th style="width:160px">Location</th>
            <th style="width:80px">Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="color:var(--text3);font-family:var(--font-mono)">B1</td>
            <td><span style="font-size:11px;font-weight:700;color:#ef4444;background:rgba(239,68,68,0.1);padding:2px 8px;border-radius:4px">🔴 Critical</span></td>
            <td><strong>Hardcoded API keys in source code.</strong> Finnhub and Alpha Vantage keys were plaintext in the HTML, visible to anyone who opens DevTools or view-source. Keys would be scraped and rate-limited.</td>
            <td style="font-family:var(--font-mono);font-size:11px;color:var(--text3)">const LIVE { }, line 827</td>
            <td><span style="font-size:11px;font-weight:700;color:var(--green)">✅ Fixed</span></td>
          </tr>
          <tr>
            <td style="color:var(--text3);font-family:var(--font-mono)">B2</td>
            <td><span style="font-size:11px;font-weight:700;color:#ef4444;background:rgba(239,68,68,0.1);padding:2px 8px;border-radius:4px">🔴 Critical</span></td>
            <td><strong>Dual API config objects out of sync.</strong> Two separate objects (LIVE and LIVE_CONFIG) read keys from different locations. Saving keys in Settings updated LIVE_CONFIG but the live screener/ticker kept using stale hardcoded keys — a silent failure.</td>
            <td style="font-family:var(--font-mono);font-size:11px;color:var(--text3)">LIVE vs LIVE_CONFIG, lines 826 &amp; 3581</td>
            <td><span style="font-size:11px;font-weight:700;color:var(--green)">✅ Fixed</span></td>
          </tr>
          <tr>
            <td style="color:var(--text3);font-family:var(--font-mono)">B3</td>
            <td><span style="font-size:11px;font-weight:700;color:#f97316;background:rgba(249,115,22,0.1);padding:2px 8px;border-radius:4px">🟠 High</span></td>
            <td><strong>Max drawdown calculated on reversed PnL array.</strong> getStats() and calcRatios() both called <code style="background:var(--bg3);padding:1px 5px;border-radius:3px">[...pnls].reverse()</code> before building the equity curve. Since trades are in DB insertion order (not date order), this produced a wrong and arbitrary drawdown figure. Now sorts trades chronologically before computing.</td>
            <td style="font-family:var(--font-mono);font-size:11px;color:var(--text3)">getStats(), line 3847; calcRatios(), line 6345</td>
            <td><span style="font-size:11px;font-weight:700;color:var(--green)">✅ Fixed</span></td>
          </tr>
          <tr>
            <td style="color:var(--text3);font-family:var(--font-mono)">B4</td>
            <td><span style="font-size:11px;font-weight:700;color:#f97316;background:rgba(249,115,22,0.1);padding:2px 8px;border-radius:4px">🟠 High</span></td>
            <td><strong>Forex screener signals generated with Math.random().</strong> Prices came from the real Frankfurter API but change %, RSI, and signals were randomly generated. The screener showed "LIVE" badge on statistically meaningless signals. Now shows "PRICE" badge and displays "—" for fields that require OHLC data.</td>
            <td style="font-family:var(--font-mono);font-size:11px;color:var(--text3)">fetchLiveScreenerData(), line 1141</td>
            <td><span style="font-size:11px;font-weight:700;color:var(--green)">✅ Fixed</span></td>
          </tr>
          <tr>
            <td style="color:var(--text3);font-family:var(--font-mono)">B5</td>
            <td><span style="font-size:11px;font-weight:700;color:#f97316;background:rgba(249,115,22,0.1);padding:2px 8px;border-radius:4px">🟠 High</span></td>
            <td><strong>CSV import corrupts trades with commas in fields.</strong> The naive <code style="background:var(--bg3);padding:1px 5px;border-radius:3px">line.split(',')</code> parser split on commas inside quoted fields — any trade with notes like "Breakout, confirmed" would have its values shifted into wrong columns silently. Replaced with a full RFC 4180 quote-aware parser.</td>
            <td style="font-family:var(--font-mono);font-size:11px;color:var(--text3)">importCSV(), lines 4589–4590</td>
            <td><span style="font-size:11px;font-weight:700;color:var(--green)">✅ Fixed</span></td>
          </tr>
          <tr>
            <td style="color:var(--text3);font-family:var(--font-mono)">B6</td>
            <td><span style="font-size:11px;font-weight:700;color:#f97316;background:rgba(249,115,22,0.1);padding:2px 8px;border-radius:4px">🟠 High</span></td>
            <td><strong>Benchmark comparison used hardcoded $100,000 capital.</strong> renderBenchmarks() had <code style="background:var(--bg3);padding:1px 5px;border-radius:3px">const capital = 100000</code> — ignoring the user's actual account size from Settings. All traders with different capital saw wrong return percentages. Now reads userSettings.capital.</td>
            <td style="font-family:var(--font-mono);font-size:11px;color:var(--text3)">renderBenchmarks(), line ~5888</td>
            <td><span style="font-size:11px;font-weight:700;color:var(--green)">✅ Fixed</span></td>
          </tr>
          <tr>
            <td style="color:var(--text3);font-family:var(--font-mono)">B7</td>
            <td><span style="font-size:11px;font-weight:700;color:#eab308;background:rgba(234,179,8,0.1);padding:2px 8px;border-radius:4px">🟡 Medium</span></td>
            <td><strong>Financial Calculators never re-initialized after settings change.</strong> The <code style="background:var(--bg3);padding:1px 5px;border-radius:3px">_calcInited</code> guard prevented calculators from re-seeding their default values when capital or currency was changed in Settings. Now resets on saveSettings() so updated capital appears in calculator inputs.</td>
            <td style="font-family:var(--font-mono);font-size:11px;color:var(--text3)">initCalculators(), line 7304</td>
            <td><span style="font-size:11px;font-weight:700;color:var(--green)">✅ Fixed</span></td>
          </tr>
          <tr>
            <td style="color:var(--text3);font-family:var(--font-mono)">B8</td>
            <td><span style="font-size:11px;font-weight:700;color:#eab308;background:rgba(234,179,8,0.1);padding:2px 8px;border-radius:4px">🟡 Medium</span></td>
            <td><strong>saveTrade() defined twice — dead code risk.</strong> The original async function at line ~4531 was shadowed by a window.saveTrade patch at line ~8073 using _origSaveTrade. The original code was unreachable dead code and created load-order fragility. The dead original has been removed; a single clean implementation now exists.</td>
            <td style="font-family:var(--font-mono);font-size:11px;color:var(--text3)">JS: saveTrade() duplicate</td>
            <td><span style="font-size:11px;font-weight:700;color:var(--green)">✅ Fixed</span></td>
          </tr>
          <tr>
            <td style="color:var(--text3);font-family:var(--font-mono)">B9</td>
            <td><span style="font-size:11px;font-weight:700;color:#eab308;background:rgba(234,179,8,0.1);padding:2px 8px;border-radius:4px">🟡 Medium</span></td>
            <td><strong>ctx.roundRect() crashes on Safari &lt; 15.4 and older Android.</strong> Bar charts in Analytics and Quant Lab used this Canvas API method introduced in Chrome 99 / Safari 15.4 with no fallback — causing completely blank charts on older mobile browsers. A quadratic-curve fallback is now used when roundRect is unavailable.</td>
            <td style="font-family:var(--font-mono);font-size:11px;color:var(--text3)">drawBarChart(), lines 4354 &amp; 5370</td>
            <td><span style="font-size:11px;font-weight:700;color:var(--green)">✅ Fixed</span></td>
          </tr>
          <tr>
            <td style="color:var(--text3);font-family:var(--font-mono)">B10</td>
            <td><span style="font-size:11px;font-weight:700;color:#3b82f6;background:rgba(59,130,246,0.1);padding:2px 8px;border-radius:4px">🔵 Low</span></td>
            <td><strong>Macro outlook data showed stale mid-2024 prices with no disclaimer.</strong> The "Decade Predictions" and 5-Year forecast panels displayed hardcoded prices from June 2024 (S&amp;P 5,430; BTC $67,420; NIFTY 23,200) as if current. All scenario labels now include a clear "Prices as of Jun 2024" notice.</td>
            <td style="font-family:var(--font-mono);font-size:11px;color:var(--text3)">TF_DATA object; decadePredPanel</td>
            <td><span style="font-size:11px;font-weight:700;color:var(--green)">✅ Fixed</span></td>
          </tr>
          <tr>
            <td style="color:var(--text3);font-family:var(--font-mono)">B11</td>
            <td><span style="font-size:11px;font-weight:700;color:#3b82f6;background:rgba(59,130,246,0.1);padding:2px 8px;border-radius:4px">🔵 Low</span></td>
            <td><strong>Version mismatch — Settings panel showed "v3.0".</strong> The about section in Settings displayed v3.0 despite the file being a major v7 rewrite. Now correctly shows v8.0 (this release).</td>
            <td style="font-family:var(--font-mono);font-size:11px;color:var(--text3)">settingsPanel HTML, line ~8217</td>
            <td><span style="font-size:11px;font-weight:700;color:var(--green)">✅ Fixed</span></td>
          </tr>
          <tr>
            <td style="color:var(--text3);font-family:var(--font-mono)">B12</td>
            <td><span style="font-size:11px;font-weight:700;color:#3b82f6;background:rgba(59,130,246,0.1);padding:2px 8px;border-radius:4px">🔵 Low</span></td>
            <td><strong>Static fallback ticker showed stale 2024 prices.</strong> The TICKER_DATA array (shown before live data loads and in offline sessions) had prices from mid-2024 with no "as of" indication. Updated with a dated snapshot label. Live data continues to override these on connection.</td>
            <td style="font-family:var(--font-mono);font-size:11px;color:var(--text3)">TICKER_DATA array, line ~5494</td>
            <td><span style="font-size:11px;font-weight:700;color:var(--green)">✅ Fixed</span></td>
          </tr>
          <tr>
            <td style="color:var(--text3);font-family:var(--font-mono)">B13</td>
            <td><span style="font-size:11px;font-weight:700;color:#3b82f6;background:rgba(59,130,246,0.1);padding:2px 8px;border-radius:4px">🔵 Low</span></td>
            <td><strong>"BlackRock Aladdin" brand used without authorization.</strong> The Forecast Engine, Conviction Calls, and AI Decision Engine prompt all referenced BlackRock's Aladdin® platform. The actual scoring is a systematic weighted checklist — not Aladdin. All references replaced with generic "Macro Forecast Engine" and "institutional-grade" language.</td>
            <td style="font-family:var(--font-mono);font-size:11px;color:var(--text3)">News tab, Forecast view, AI prompt</td>
            <td><span style="font-size:11px;font-weight:700;color:var(--green)">✅ Fixed</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Open Issues -->
  <div class="panel" style="margin-bottom:24px">
    <div class="panel-header">
      <span class="panel-title">⚠️ Known Limitations (Not Bugs)</span>
      <span class="panel-meta">Data coverage gaps · Planned improvements</span>
    </div>
    <div style="padding:20px;display:flex;flex-direction:column;gap:12px">
      <div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);padding:14px">
        <div style="font-weight:700;font-size:13px;margin-bottom:4px;color:var(--yellow)">🇮🇳 NSE/BSE Live Prices — Partial Coverage</div>
        <div style="font-size:12px;color:var(--text2);line-height:1.6">Only 17 BSE-listed stocks have live prices via Finnhub. The broader NSE screener universe uses generated data. Full India equity coverage requires a dedicated Indian market data API (Upstox, Zerodha Kite, or NSE data feed). This is a data availability limitation, not a code bug.</div>
      </div>
      <div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);padding:14px">
        <div style="font-weight:700;font-size:13px;margin-bottom:4px;color:var(--yellow)">🏅 Commodity Prices — Static Snapshot</div>
        <div style="font-size:12px;color:var(--text2);line-height:1.6">Gold, Silver, and Crude Oil prices in the ticker and overview panels are static mid-2024 values. Live commodity data requires an API key for Metals-API or the Alpha Vantage commodities endpoint (BRENT, WTI). Enter your Alpha Vantage key in Settings to enable live commodity data.</div>
      </div>
      <div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);padding:14px">
        <div style="font-weight:700;font-size:13px;margin-bottom:4px;color:var(--yellow)">📴 PWA Offline Mode — Requires HTTP Server</div>
        <div style="font-size:12px;color:var(--text2);line-height:1.6">The Service Worker is registered via a blob: URL which Chrome and Chromium-based browsers reject silently. To enable full offline PWA behaviour and home screen install, serve this file from a real HTTP/HTTPS server (e.g. <code style="background:var(--bg4);padding:1px 5px;border-radius:3px">python -m http.server 8080</code> or any web host). All core journal features work without a server.</div>
      </div>
      <div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);padding:14px">
        <div style="font-weight:700;font-size:13px;margin-bottom:4px;color:var(--text3)">📊 Forex Technical Signals — Price Only</div>
        <div style="font-size:12px;color:var(--text2);line-height:1.6">Forex pairs in the screener show live prices from Frankfurter API but RSI, trend, and signal fields require OHLC candle history, which is not available on the free tier. These cells now correctly show "—" instead of randomly generated values (which was Bug B4, now fixed).</div>
      </div>
    </div>
  </div>

  <!-- Version History -->
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">📋 Version History</span>
    </div>
    <div style="padding:20px;display:flex;flex-direction:column;gap:16px">
      <div>
        <div style="font-family:var(--font-head);font-size:15px;font-weight:700;color:var(--green);margin-bottom:6px">v8.0 — February 2026 <span style="font-size:11px;font-weight:400;color:var(--text3);margin-left:8px">Current</span></div>
        <div style="font-size:12px;color:var(--text2);line-height:1.8">Full security overhaul · Removed hardcoded API keys · Merged dual config systems · Fixed drawdown calculation · RFC 4180 CSV parser · Benchmark capital fix · Calculators re-seed on settings change · Single canonical saveTrade() · Canvas roundRect polyfill · Stale data disclaimers · Version string corrected · BlackRock brand references removed · Changelog view added · 13 bugs fixed total</div>
      </div>
      <div style="border-top:1px solid var(--border);padding-top:16px">
        <div style="font-family:var(--font-head);font-size:15px;font-weight:700;color:var(--text2);margin-bottom:6px">v7.0 — Original Release</div>
        <div style="font-size:12px;color:var(--text3);line-height:1.8">Major architecture rewrite · Single-file PWA · Quant Lab · Decision Engine · Live data integration (Finnhub, CoinGecko, Frankfurter) · Zen psychology tools · Multi-market screener · News &amp; Calendar · Financial calculators · Conviction Calls · Macro forecast engine</div>
      </div>
    </div>
  </div>

</div>

</main>

<!-- ADD/EDIT TRADE MODAL -->
<div class="modal-overlay" id="tradeModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="modalTitle">New Trade</span>
      <button class="modal-close" onclick="closeModal()">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group sym-wrap">
          <label>Symbol</label>
          <input type="text" id="f-symbol" placeholder="Search symbol…" autocomplete="off">
          <div class="sym-dropdown" id="symDropdown"></div>
        </div>
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="f-date">
        </div>
        <div class="form-group">
          <label>Market</label>
          <select id="f-market">
            <option>NSE</option>
            <option>US Stocks</option>
            <option>Index</option>
            <option>Forex</option>
            <option>Crypto</option>
            <option>Commodity</option>
            <option>Futures</option>
            <option>Options</option>
          </select>
        </div>
        <div class="form-group">
          <label>Direction</label>
          <div class="segment-control">
            <button class="seg-btn active" data-dir="Long">Long</button>
            <button class="seg-btn" data-dir="Short">Short</button>
          </div>
        </div>
        <div class="form-group">
          <label>Entry Price</label>
          <input type="number" id="f-entry" placeholder="0.00" step="0.01">
        </div>
        <div class="form-group">
          <label>Exit Price</label>
          <input type="number" id="f-exit" placeholder="0.00" step="0.01">
        </div>
        <div class="form-group">
          <label>Quantity / Contracts</label>
          <input type="number" id="f-qty" placeholder="1" step="1">
        </div>
        <div class="form-group">
          <label>Stop Loss</label>
          <input type="number" id="f-stop" placeholder="0.00" step="0.01">
        </div>
        <div class="form-group">
          <label>Commission / Fees</label>
          <input type="number" id="f-fees" placeholder="0.00" step="0.01">
        </div>
        <div class="form-group">
          <label>Setup / Strategy</label>
          <input type="text" id="f-setup" placeholder="e.g. Breakout, Mean Reversion">
        </div>
        <div class="form-group full">
          <label>Notes</label>
          <textarea id="f-notes" placeholder="Trade reasoning, observations..."></textarea>
        </div>
        <div class="form-group full">
          <label>Emotional State During Trade</label>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px" id="trade-emotion-grid">
            <div class="emotion-tag sm" data-emotion="Calm" onclick="toggleTradeEmotion(this)">🧘 Calm</div>
            <div class="emotion-tag sm" data-emotion="Focused" onclick="toggleTradeEmotion(this)">🎯 Focused</div>
            <div class="emotion-tag sm" data-emotion="Confident" onclick="toggleTradeEmotion(this)">💪 Confident</div>
            <div class="emotion-tag sm" data-emotion="Anxious" onclick="toggleTradeEmotion(this)">😟 Anxious</div>
            <div class="emotion-tag sm" data-emotion="FOMO" onclick="toggleTradeEmotion(this)">🏃 FOMO</div>
            <div class="emotion-tag sm" data-emotion="Overconfident" onclick="toggleTradeEmotion(this)">🦁 Overconfident</div>
            <div class="emotion-tag sm" data-emotion="Revenge" onclick="toggleTradeEmotion(this)">🔥 Revenge</div>
            <div class="emotion-tag sm" data-emotion="Patient" onclick="toggleTradeEmotion(this)">⏳ Patient</div>
          </div>
        </div>
      </div>
      <div style="background:var(--bg3);border-radius:var(--radius2);padding:14px;margin-top:8px;display:flex;gap:20px;align-items:center;flex-wrap:wrap;">
        <div style="font-size:12px;color:var(--text3)">Calculated P&L:</div>
        <div style="font-family:var(--font-mono);font-size:18px;" id="calcPnl">—</div>
        <div style="font-size:12px;color:var(--text3);margin-left:auto">R-Multiple:</div>
        <div style="font-family:var(--font-mono);font-size:18px;" id="calcR">—</div>
      </div>
      <div class="form-footer">
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" id="saveTradeBtn" onclick="initBreathGate()">Save Trade</button>
      </div>
    </div>
  </div>
</div>


<!-- BREATH GATE OVERLAY -->
<div id="breathGate">
  <div class="breath-ring">
    <span style="font-size:36px">🌬️</span>
  </div>
  <div class="breath-text">Take a breath before committing</div>
  <div class="breath-sub" id="breathCountdown">Saving in 3...</div>
</div>

<!-- IMPORT MODAL -->
<div class="modal-overlay" id="importModal">
  <div class="modal" style="max-width:500px">
    <div class="modal-header">
      <span class="modal-title">Import Trades</span>
      <button class="modal-close" onclick="document.getElementById('importModal').classList.remove('open')">✕</button>
    </div>
    <div class="modal-body">
      <div class="import-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <div style="font-size:36px;margin-bottom:12px">📁</div>
        <div style="font-size:15px;color:var(--text2);margin-bottom:6px">Drop CSV file here</div>
        <div style="font-size:13px;color:var(--text3)">or click to browse</div>
      </div>
      <input type="file" id="fileInput" accept=".csv,.json" style="display:none">
      <div style="margin-top:16px;padding:12px;background:var(--bg3);border-radius:var(--radius2);font-size:12px;color:var(--text3);line-height:1.8">
        <strong style="color:var(--text2)">CSV Format:</strong><br>
        date, symbol, market, direction, entry, exit, qty, stop, fees, setup, notes
      </div>
      <div style="margin-top:12px;display:flex;justify-content:flex-end">
        <button class="btn btn-ghost" onclick="document.getElementById('importModal').classList.remove('open')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- TOAST WRAP -->
<div class="toast-wrap" id="toastWrap"></div>


<script>

// ════════════════════════════════════════════════════════════════════
// ⚡ LIVE DATA CONFIG — Enter your free API keys (⚡ Live Data button)
// Both LIVE and LIVE_CONFIG read from the same localStorage keys — always in sync.
// ════════════════════════════════════════════════════════════════════
const LIVE_CONFIG = {
  get FINNHUB_KEY(){ return localStorage.getItem('tj_finnhub_key') || ''; },
  get ALPHAVANTAGE_KEY(){ return localStorage.getItem('tj_av_key') || ''; },
  COINGECKO_BASE: 'https://api.coingecko.com/api/v3',
  FEARGREED_URL: 'https://api.alternative.me/fng/?limit=4',
  FOREX_BASE: 'https://api.frankfurter.app',
  CACHE_TTL: { quotes:120000, news:600000, calendar:3600000, crypto:90000, feargreed:1800000, forex:300000, earnings:21600000 }
};

const LiveData = {
  _cache: {},
  get(key){ const c=this._cache[key]; if(!c) return null; if(Date.now()-c.ts>c.ttl){delete this._cache[key];return null;} return c.data; },
  set(key,data,ttl){ this._cache[key]={data,ts:Date.now(),ttl:ttl||60000}; },
  hasFinnhub(){ return !!LIVE_CONFIG.FINNHUB_KEY; },
  async fetch(url,cacheKey,ttl){
    const cached=this.get(cacheKey); if(cached) return cached;
    try{ const res=await fetch(url); if(!res.ok) throw new Error('HTTP '+res.status); const data=await res.json(); if(cacheKey) this.set(cacheKey,data,ttl); return data; }
    catch(e){ console.warn('LiveData ['+cacheKey+']:',e.message); return null; }
  },
  async fetchFearGreed(){ const d=await this.fetch(LIVE_CONFIG.FEARGREED_URL,'feargreed',1800000); if(!d?.data?.length) return null; return {value:parseInt(d.data[0].value),label:d.data[0].value_classification,prev:parseInt(d.data[1]?.value||0),week:parseInt(d.data[3]?.value||0)}; },
  async fetchCryptoPrices(){ return await this.fetch(LIVE_CONFIG.COINGECKO_BASE+'/simple/price?ids=bitcoin,ethereum,solana,binancecoin,ripple,cardano,avalanche-2,matic-network,chainlink,polkadot&vs_currencies=usd&include_24hr_change=true','crypto_prices',90000); },
  async fetchForexRates(){ const d=await this.fetch(LIVE_CONFIG.FOREX_BASE+'/latest?from=USD&to=EUR,GBP,JPY,AUD,CAD,CHF,INR','forex_rates',300000); return d?.rates||null; },
  async fetchQuote(symbol){ if(!this.hasFinnhub()) return null; return await this.fetch('https://finnhub.io/api/v1/quote?symbol='+encodeURIComponent(symbol)+'&token='+LIVE_CONFIG.FINNHUB_KEY,'quote_'+symbol,120000); },
  async fetchBatchQuotes(symbols){ if(!this.hasFinnhub()) return {}; const r={}; for(let i=0;i<Math.min(symbols.length,12);i++){ const q=await this.fetchQuote(symbols[i]); if(q&&q.c) r[symbols[i]]=q; await new Promise(x=>setTimeout(x,120)); } return r; },
  async fetchNews(cat='general'){ if(!this.hasFinnhub()) return null; return await this.fetch('https://finnhub.io/api/v1/news?category='+cat+'&token='+LIVE_CONFIG.FINNHUB_KEY,'news_'+cat,600000); },
  async fetchSymbolNews(sym){ if(!this.hasFinnhub()) return null; const t=new Date().toISOString().split('T')[0]; const f=new Date(Date.now()-7*86400000).toISOString().split('T')[0]; return await this.fetch('https://finnhub.io/api/v1/company-news?symbol='+encodeURIComponent(sym)+'&from='+f+'&to='+t+'&token='+LIVE_CONFIG.FINNHUB_KEY,'snews_'+sym,600000); },
  async fetchEconomicCalendar(){ if(!this.hasFinnhub()) return null; const d=await this.fetch('https://finnhub.io/api/v1/calendar/economic?token='+LIVE_CONFIG.FINNHUB_KEY,'eco_cal',3600000); return d?.economicCalendar||null; },
  async fetchEarningsCalendar(){ if(!this.hasFinnhub()) return null; const t=new Date().toISOString().split('T')[0]; const to=new Date(Date.now()+14*86400000).toISOString().split('T')[0]; const d=await this.fetch('https://finnhub.io/api/v1/calendar/earnings?from='+t+'&to='+to+'&token='+LIVE_CONFIG.FINNHUB_KEY,'earn_cal',21600000); return d?.earningsCalendar||null; },
  async fetchFinancials(sym){ if(!this.hasFinnhub()) return null; const d=await this.fetch('https://finnhub.io/api/v1/stock/metric?symbol='+encodeURIComponent(sym)+'&metric=all&token='+LIVE_CONFIG.FINNHUB_KEY,'fin_'+sym,3600000); return d?.metric||null; },
  async fetchRecommendations(sym){ if(!this.hasFinnhub()) return null; const d=await this.fetch('https://finnhub.io/api/v1/stock/recommendation?symbol='+encodeURIComponent(sym)+'&token='+LIVE_CONFIG.FINNHUB_KEY,'rec_'+sym,3600000); return Array.isArray(d)?d[0]:null; },
};

function fmtPrice(p,d=2){ if(!p&&p!==0) return '—'; return parseFloat(p).toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d}); }
function fgLabel(v){ return v<25?'Extreme Fear':v<45?'Fear':v<55?'Neutral':v<75?'Greed':'Extreme Greed'; }
function setLiveStatus(id,state,msg){ const el=document.getElementById(id); if(!el) return; const dot={live:'🟢',loading:'🟡',error:'🔴',offline:'⚫'}[state]||'⚫'; el.innerHTML='<span style="font-size:11px;font-family:var(--font-mono)">'+dot+' '+msg+'</span>'; }

async function loadLiveFearGreed(){
  const fg=await LiveData.fetchFearGreed(); if(!fg) return;
  drawFearGreed(fg.value); drawFearGreedNews(fg.value);
  const p=document.getElementById('fgHistPrev'); if(p) p.textContent=fg.prev+' ('+fgLabel(fg.prev)+')';
  const w=document.getElementById('fgHistWeek'); if(w) w.textContent=fg.week+' ('+fgLabel(fg.week)+')';
}

async function loadLiveCrypto(){
  const data=await LiveData.fetchCryptoPrices(); if(!data) return;
  const map={'BTC/USDT':data.bitcoin,'ETH/USDT':data.ethereum,'SOL/USDT':data.solana,'BNB/USDT':data.binancecoin,'XRP/USDT':data.ripple,'ADA/USDT':data.cardano,'AVAX/USDT':data['avalanche-2'],'MATIC/USDT':data['matic-network'],'LINK/USDT':data.chainlink,'DOT/USDT':data.polkadot};
  if(screenerData.length) screenerData.forEach(r=>{ if(map[r.sym]){ r.price=map[r.sym].usd.toFixed(2); r.chg=parseFloat((map[r.sym].usd_24h_change||0).toFixed(2)); }});
  const el=document.getElementById('tickerTrack'); if(el){
    const liveC=[{sym:'BTC',d:data.bitcoin},{sym:'ETH',d:data.ethereum},{sym:'SOL',d:data.solana},{sym:'BNB',d:data.binancecoin},{sym:'XRP',d:data.ripple}].filter(c=>c.d).map(c=>({sym:c.sym,price:'$'+fmtPrice(c.d.usd),chg:(c.d.usd_24h_change>=0?'+':'')+c.d.usd_24h_change?.toFixed(2)+'%',up:c.d.usd_24h_change>=0}));
    const stat=TICKER_DATA.filter(t=>!['BTC','ETH','SOL','BNB','XRP'].includes(t.sym));
    const all=[...stat,...liveC,...stat,...liveC];
    el.innerHTML=all.map(t=>'<div class="ticker-item"><span class="ticker-sym">'+t.sym+'</span><span class="ticker-price">'+t.price+'</span><span class="ticker-chg '+(t.up?'up':'dn')+'">'+(t.up?'▲':'▼')+' '+t.chg+'</span></div>').join('');
  }
  setLiveStatus('crypto-status','live','Live · CoinGecko');
}

async function loadLiveForex(){
  const rates=await LiveData.fetchForexRates(); if(!rates) return;
  const fx={'EUR/USD':rates.EUR?(1/rates.EUR).toFixed(4):null,'GBP/USD':rates.GBP?(1/rates.GBP).toFixed(4):null,'USD/JPY':rates.JPY?.toFixed(2)||null,'AUD/USD':rates.AUD?(1/rates.AUD).toFixed(4):null,'USD/CAD':rates.CAD?.toFixed(4)||null,'USD/CHF':rates.CHF?.toFixed(4)||null};
  if(screenerData.length) screenerData.forEach(r=>{ if(r.mkt==='Forex'&&fx[r.sym]) r.price=fx[r.sym]; });
  setLiveStatus('forex-status','live','Live · Frankfurter');
}

async function loadLiveNews(){
  if(!LiveData.hasFinnhub()){ setLiveStatus('news-status','offline','Add Finnhub key for live news'); return; }
  setLiveStatus('news-status','loading','Fetching headlines…');
  const raw=await LiveData.fetchNews('general'); if(!raw?.length){ setLiveStatus('news-status','error','Failed'); return; }
  const tc={MACRO:{col:'rgba(124,109,250,0.15)',txt:'var(--accent2)'},EQUITIES:{col:'rgba(34,211,238,0.15)',txt:'var(--cyan)'},CRYPTO:{col:'rgba(74,222,128,0.15)',txt:'var(--green)'},FOREX:{col:'rgba(251,146,60,0.15)',txt:'var(--orange)'},GENERAL:{col:'rgba(108,99,255,0.12)',txt:'var(--accent2)'}};
  const items=raw.slice(0,25).map(n=>{
    const cat=n.category==='crypto'?'Crypto':n.category==='forex'?'Forex':'Equities'; const tag=cat.toUpperCase(); const colors=tc[tag]||tc.GENERAL;
    const h=Math.round((Date.now()-n.datetime*1000)/3600000); const time=h<1?'Just now':h<24?h+'h ago':Math.round(h/24)+'d ago';
    const s=/fall|drop|crash|decline|loss|bear|risk|warn/i.test(n.headline)?'-':/rise|gain|surge|rally|bull|beat|grow|boost/i.test(n.headline)?'+':'~';
    return {headline:n.headline,summary:(n.summary||n.headline).slice(0,160)+'…',tag,tagCol:colors.col,tagTxt:colors.txt,time,source:n.source,s,sentCol:s==='+'?'var(--green)':s==='-'?'var(--red)':'var(--yellow)',cat,url:n.url};
  });
  const mkHtml=items=>'<a href="'+(items.url||'#')+'" target="_blank" rel="noopener" style="text-decoration:none;display:block"><div class="news-feed-item"><div class="news-dot" style="background:'+items.tagTxt+'"></div><div class="news-content"><div class="news-headline">'+items.headline+'</div><div style="font-size:11px;color:var(--text3);margin:4px 0 5px;line-height:1.5">'+items.summary+'</div><div class="news-meta"><span class="news-tag" style="background:'+items.tagCol+';color:'+items.tagTxt+'">'+items.tag+'</span><span class="news-source">'+items.source+'</span><span class="news-time">'+items.time+'</span><span style="font-size:9px;color:var(--text3);margin-left:auto">↗</span></div></div><div class="news-sentiment" style="color:'+items.sentCol+'">'+(items.s==='+'?'▲':items.s==='-'?'▼':'◆')+'</div></div></a>';
  ['newsFeed','newsTabFeed'].forEach(id=>{ const el=document.getElementById(id); if(el) el.innerHTML=items.map(mkHtml).join(''); });
  setLiveStatus('news-status','live','Live · '+items.length+' stories · Finnhub');
}

async function loadLiveCalendar(){
  if(!LiveData.hasFinnhub()){ setLiveStatus('calendar-status','offline','Add Finnhub key'); return; }
  setLiveStatus('calendar-status','loading','Fetching…');
  const events=await LiveData.fetchEconomicCalendar(); if(!events?.length){ setLiveStatus('calendar-status','error','Failed'); return; }
  const flags={US:'🇺🇸',EU:'🇪🇺',GB:'🇬🇧',JP:'🇯🇵',CN:'🇨🇳',IN:'🇮🇳',CA:'🇨🇦',AU:'🇦🇺',DE:'🇩🇪',FR:'🇫🇷'};
  const im={high:'high',low:'low',medium:'med'};
  const html=events.slice(0,20).map(e=>{
    const imp=im[e.impact]||'low'; const flag=flags[e.country]||'🌐'; const actual=e.actual!=null?String(e.actual):'—';
    const beat=e.actual&&e.estimate?(parseFloat(e.actual)>parseFloat(e.estimate)?'beat':'miss'):'';
    const dt=e.time?new Date(e.time*1000).toLocaleString('en-US',{weekday:'short',hour:'2-digit',minute:'2-digit'}):'—';
    return '<div class="cal-item"><div class="cal-time">'+dt+'</div><div class="cal-country">'+flag+'</div><div class="cal-event"><div style="display:flex;align-items:center;gap:6px"><div class="cal-impact '+imp+'" style="width:3px;height:28px;border-radius:2px;flex-shrink:0"></div><div><div class="cal-event-name">'+e.event+'</div><div class="cal-event-sub">'+e.country+' · '+imp.toUpperCase()+'</div></div></div></div><div class="cal-vals"><span class="cal-actual '+beat+'" style="font-size:12px">'+actual+'</span><span style="color:var(--text3)">F: '+(e.estimate??'—')+'</span></div></div>';
  }).join('');
  ['economicCalendar','calendarTabFull'].forEach(id=>{ const el=document.getElementById(id); if(el) el.innerHTML=html; });
  setLiveStatus('calendar-status','live','Live · '+events.length+' events');
}

async function loadLiveEarnings(){
  if(!LiveData.hasFinnhub()){ setLiveStatus('earnings-status','offline','Add Finnhub key'); return; }
  const data=await LiveData.fetchEarningsCalendar(); if(!data?.length) return;
  const el=document.getElementById('earningsBody'); if(!el) return;
  el.innerHTML=data.slice(0,15).map(e=>{
    const epsE=e.epsEstimate!=null?'$'+parseFloat(e.epsEstimate).toFixed(2):'—';
    const revE=e.revenueEstimate?'$'+(e.revenueEstimate/1e9).toFixed(1)+'B':'—';
    const epsA=e.epsActual!=null?'$'+parseFloat(e.epsActual).toFixed(2):'—';
    const beat=e.epsActual&&e.epsEstimate?(parseFloat(e.epsActual)>=parseFloat(e.epsEstimate)?'🟢 Beat':'🔴 Miss'):'';
    const col=beat.includes('Beat')?'var(--green)':beat.includes('Miss')?'var(--red)':'var(--text2)';
    return '<tr><td style="padding:10px 14px;border-bottom:1px solid var(--border);font-family:var(--font-mono);font-size:11px;color:var(--text3)">'+e.date+'</td><td style="padding:10px 14px;border-bottom:1px solid var(--border);font-size:12px;font-weight:600;color:var(--text)">'+e.symbol+'</td><td style="padding:10px 14px;border-bottom:1px solid var(--border);font-size:11px;color:var(--text3)">'+(e.hour==='amc'?'After Close':'Before Open')+'</td><td style="padding:10px 14px;border-bottom:1px solid var(--border);font-family:var(--font-mono);font-size:12px;color:var(--accent2)">'+epsE+'</td><td style="padding:10px 14px;border-bottom:1px solid var(--border);font-family:var(--font-mono);font-size:12px;color:'+col+'">'+epsA+' '+beat+'</td><td style="padding:10px 14px;border-bottom:1px solid var(--border);font-family:var(--font-mono);font-size:11px;color:var(--text2)">'+revE+'</td><td style="padding:10px 14px;border-bottom:1px solid var(--border)"><span style="padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:rgba(61,220,132,0.1);color:var(--green)">🟢 Live</span></td></tr>';
  }).join('');
  setLiveStatus('earnings-status','live','Live · '+data.length+' reports');
}

async function enrichDecisionWithLiveData(symbol,market){
  const deStatus=document.getElementById('de-live-status'); if(!deStatus) return;
  deStatus.innerHTML='<span style="color:var(--yellow);font-size:11px">🟡 Fetching live data for '+symbol+'…</span>';
  if(market==='Crypto'){
    const cm={BTC:'bitcoin',ETH:'ethereum',SOL:'solana',BNB:'binancecoin',XRP:'ripple',ADA:'cardano',AVAX:'avalanche-2',MATIC:'matic-network'};
    const base=symbol.replace('/USDT','').replace('/USD',''); const cid=cm[base];
    if(cid){
      const d=await LiveData.fetch(LIVE_CONFIG.COINGECKO_BASE+'/simple/price?ids='+cid+'&vs_currencies=usd&include_24hr_change=true&include_market_cap=true','cg_de_'+cid,90000);
      if(d?.[cid]){ const p=d[cid]; const chg=(p.usd_24h_change||0).toFixed(2); const mc=(p.usd_market_cap/1e9).toFixed(1);
        deStatus.innerHTML='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px"><div class="metric-box"><div class="metric-box-val" style="color:var(--accent2)">$'+fmtPrice(p.usd)+'</div><div class="metric-box-lbl">Live Price</div></div><div class="metric-box"><div class="metric-box-val" style="color:'+(chg>=0?'var(--green)':'var(--red)')+'">'+(chg>=0?'+':'')+chg+'%</div><div class="metric-box-lbl">24h Change</div></div><div class="metric-box"><div class="metric-box-val" style="color:var(--cyan)">$'+mc+'B</div><div class="metric-box-lbl">Market Cap</div></div></div>';
        const en=document.getElementById('de-entry'); if(en&&!en.value) en.value=p.usd.toFixed(2);
      } return;
    }
  }
  if(LiveData.hasFinnhub()&&(market==='US Stocks'||market==='NSE')){
    const [q,recs,fin,news]=await Promise.all([LiveData.fetchQuote(symbol),LiveData.fetchRecommendations(symbol),LiveData.fetchFinancials(symbol),LiveData.fetchSymbolNews(symbol)]);
    let html='';
    if(q?.c){ const chg=q.pc?((q.c-q.pc)/q.pc*100).toFixed(2):0;
      html+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px"><div class="metric-box"><div class="metric-box-val" style="color:var(--accent2)">$'+fmtPrice(q.c)+'</div><div class="metric-box-lbl">Live Price</div></div><div class="metric-box"><div class="metric-box-val" style="color:'+(chg>=0?'var(--green)':'var(--red)')+'">'+(chg>=0?'+':'')+chg+'%</div><div class="metric-box-lbl">Day Change</div></div><div class="metric-box"><div class="metric-box-val">$'+fmtPrice(q.h)+' / $'+fmtPrice(q.l)+'</div><div class="metric-box-lbl">High / Low</div></div></div>';
      const en=document.getElementById('de-entry'); if(en&&!en.value) en.value=q.c.toFixed(2);
    }
    if(recs){ const tot=recs.buy+recs.hold+recs.sell+recs.strongBuy+recs.strongSell; const bull=tot?((recs.buy+recs.strongBuy)/tot*100).toFixed(0):0;
      html+='<div style="background:var(--bg3);border-radius:var(--radius2);padding:10px;margin-bottom:8px"><div style="font-size:10px;color:var(--text3);margin-bottom:6px">Analyst Consensus · '+tot+' analysts</div><div style="display:flex;gap:8px;flex-wrap:wrap"><span style="color:var(--green);font-size:11px;font-weight:700">▲ Buy: '+(recs.buy+recs.strongBuy)+'</span><span style="color:var(--text3);font-size:11px">Hold: '+recs.hold+'</span><span style="color:var(--red);font-size:11px;font-weight:700">▼ Sell: '+(recs.sell+recs.strongSell)+'</span><span style="font-family:var(--font-mono);font-size:11px;color:'+(bull>60?'var(--green)':bull<40?'var(--red)':'var(--yellow)')+';margin-left:auto">'+bull+'% Bullish</span></div></div>';
    }
    if(fin){ const items=[fin['52WeekHigh']?'<div><div style="font-size:11px;font-family:var(--font-mono)">$'+fmtPrice(fin['52WeekHigh'])+'</div><div style="font-size:9px;color:var(--text3)">52W High</div></div>':'',fin['52WeekLow']?'<div><div style="font-size:11px;font-family:var(--font-mono)">$'+fmtPrice(fin['52WeekLow'])+'</div><div style="font-size:9px;color:var(--text3)">52W Low</div></div>':'',fin['peNormalizedAnnual']?'<div><div style="font-size:11px;font-family:var(--font-mono)">'+fin['peNormalizedAnnual'].toFixed(1)+'x</div><div style="font-size:9px;color:var(--text3)">P/E</div></div>':'',fin['revenueGrowthQuarterlyYoy']?'<div><div style="font-size:11px;font-family:var(--font-mono);color:'+(fin['revenueGrowthQuarterlyYoy']>0?'var(--green)':'var(--red)')+'">'+((fin['revenueGrowthQuarterlyYoy']||0)*100).toFixed(1)+'%</div><div style="font-size:9px;color:var(--text3)">Rev Growth</div></div>':''].filter(Boolean).join('');
      if(items) html+='<div style="background:var(--bg3);border-radius:var(--radius2);padding:10px;margin-bottom:8px"><div style="font-size:10px;color:var(--text3);margin-bottom:6px">Key Fundamentals</div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px">'+items+'</div></div>';
    }
    if(news?.length) html+='<div style="background:var(--bg3);border-radius:var(--radius2);padding:10px"><div style="font-size:10px;color:var(--text3);margin-bottom:6px">Recent News</div>'+news.slice(0,3).map(n=>'<a href="'+n.url+'" target="_blank" rel="noopener" style="text-decoration:none;display:block;padding:5px 0;border-bottom:1px solid var(--border)"><div style="font-size:11px;color:var(--text)">'+n.headline+'</div><div style="font-size:9px;color:var(--text3);margin-top:2px">'+n.source+' · '+new Date(n.datetime*1000).toLocaleDateString()+'</div></a>').join('')+'</div>';
    deStatus.innerHTML=html||'<span style="font-size:11px;color:var(--text3)">No live data found for this symbol</span>'; return;
  }
  deStatus.innerHTML='<span style="font-size:11px;color:var(--text3)">💡 Crypto: live without key. US Stocks: <a href="#" onclick="openApiSettings()" style="color:var(--accent2)">add Finnhub key →</a></span>';
}

async function enrichScreenerWithLiveData(){
  setLiveStatus('screener-live-status','loading','Fetching live prices…');
  await Promise.all([loadLiveCrypto(),loadLiveForex()]);
  if(LiveData.hasFinnhub()){
    const usSyms=screenerData.filter(r=>r.mkt==='US Stocks').map(r=>r.sym).slice(0,12);
    const quotes=await LiveData.fetchBatchQuotes(usSyms);
    screenerData.forEach(r=>{ if(quotes[r.sym]){ const q=quotes[r.sym]; r.price=q.c?.toFixed(2)||r.price; r.chg=q.pc?parseFloat(((q.c-q.pc)/q.pc*100).toFixed(2)):r.chg; }});
    setLiveStatus('screener-live-status','live','Live · Crypto + '+Object.keys(quotes).length+' US stocks + Forex rates');
  } else {
    setLiveStatus('screener-live-status','live','Live · Crypto + Forex · <a href="#" onclick="openApiSettings()" style="color:var(--accent2)">Add Finnhub for stocks</a>');
  }
  runScreener();
}

function openApiSettings(){ const o=document.getElementById('apiSettingsOverlay'); if(!o) return; o.style.display='flex'; const fk=document.getElementById('apiKeyFinnhub'); if(fk) fk.value=LIVE_CONFIG.FINNHUB_KEY||''; const ak=document.getElementById('apiKeyAV'); if(ak) ak.value=LIVE_CONFIG.ALPHAVANTAGE_KEY||''; }
function closeApiSettings(){ const o=document.getElementById('apiSettingsOverlay'); if(o) o.style.display='none'; }
function saveApiKeys(){ const fk=document.getElementById('apiKeyFinnhub')?.value.trim(); const ak=document.getElementById('apiKeyAV')?.value.trim(); if(fk) localStorage.setItem('tj_finnhub_key',fk); if(ak) localStorage.setItem('tj_av_key',ak); closeApiSettings(); showToast('✅ API keys saved — loading live data!','success'); LiveData._cache={}; Object.keys(_cache).forEach(k=>delete _cache[k]); loadAllLiveData(); }
function clearApiKeys(){ ['tj_finnhub_key','tj_av_key'].forEach(k=>localStorage.removeItem(k)); LiveData._cache={}; Object.keys(_cache).forEach(k=>delete _cache[k]); showToast('API keys cleared','info'); }
async function loadAllLiveData(){ loadLiveFearGreed(); loadLiveCrypto(); loadLiveForex(); if(LiveData.hasFinnhub()){ loadLiveNews(); loadLiveCalendar(); loadLiveEarnings(); } }

// ═══════════════════════════════════════════════════════════════
//   FLOATING TICKER STRIP — LIVE MULTI-ASSET
// ═══════════════════════════════════════════════════════════════
const FT = {
  ws: null,
  angelData: {},
  lastFtBuild: 0,

  async build() {
    const track = document.getElementById('ftTrack');
    if (!track) return;

    // Gather data from all sources
    const items = [];

    // -- Angel One / NSE indices (from WS if connected, else static)
    const nseItems = [
      { sym:'NIFTY', label:'NIFTY 50', flag:'🇮🇳' },
      { sym:'BANKNIFTY', label:'BANKNIFTY', flag:'🇮🇳' },
      { sym:'SENSEX', label:'SENSEX', flag:'🇮🇳' },
    ];
    nseItems.forEach(n => {
      const d = FT.angelData[n.sym];
      if (d) {
        const up = d.chg >= 0;
        items.push({ flag:n.flag, sym:n.label, price:fmtNum(d.ltp), chg:(up?'+':'')+d.chg.toFixed(2)+'%', up });
      } else {
        items.push({ flag:n.flag, sym:n.label, price:'—', chg:'—', up:true });
      }
    });

    // Section separator
    items.push({ sep:'US MKT' });

    // -- US via Finnhub
    if (LiveData.hasFinnhub()) {
      try {
        const syms = ['SPY','QQQ','DIA','VIX'];
        const labels = { SPY:'S&P 500', QQQ:'NASDAQ', DIA:'DOW', VIX:'VIX' };
        const quotes = await LiveData.fetchBatchQuotes(syms);
        syms.forEach(s => {
          const q = quotes[s];
          if (!q || !q.c) return;
          const chg = q.pc ? ((q.c-q.pc)/q.pc*100) : (q.dp||0);
          const up = chg >= 0;
          items.push({ flag:'🇺🇸', sym:labels[s]||s, price:'$'+q.c.toFixed(2), chg:(up?'+':'')+chg.toFixed(2)+'%', up });
        });
      } catch(e){}
    }

    // Section separator
    items.push({ sep:'CRYPTO' });

    // -- Crypto via CoinGecko
    try {
      const cg = await LiveData.fetchCryptoPrices();
      if (cg) {
        [['bitcoin','BTC'],['ethereum','ETH'],['solana','SOL'],['binancecoin','BNB']].forEach(([id,sym]) => {
          if (!cg[id]) return;
          const p = cg[id];
          const up = p.usd_24h_change >= 0;
          items.push({ flag:'₿', sym, price:'$'+fmtPrice(p.usd), chg:(up?'+':'')+p.usd_24h_change?.toFixed(2)+'%', up });
        });
      }
    } catch(e){}

    // Section separator
    items.push({ sep:'FOREX' });

    // -- Forex via Frankfurter
    try {
      const fx = await LiveData.fetchForexRates();
      if (fx) {
        const fxMap = [
          ['INR','USD/INR', v => v.toFixed(2)],
          ['EUR','EUR/USD', v => (1/v).toFixed(4)],
          ['GBP','GBP/USD', v => (1/v).toFixed(4)],
          ['JPY','USD/JPY', v => v.toFixed(2)],
        ];
        fxMap.forEach(([k,label,fmt]) => {
          if (!fx[k]) return;
          items.push({ flag:'💱', sym:label, price:fmt(fx[k]), chg:'—', up:true });
        });
      }
    } catch(e){}

    if (!items.length) return;

    // Build HTML (doubled for seamless loop)
    const buildItem = it => {
      if (it.sep) return `<div class="ft-section-sep">${it.sep}</div>`;
      return `<div class="ft-item">
        <span class="ft-flag">${it.flag||''}</span>
        <span class="ft-sym">${it.sym}</span>
        <span class="ft-price">${it.price}</span>
        <span class="ft-chg ${it.up?'up':'dn'}">${it.up&&it.chg!=='—'?'▲':'▼'} ${it.chg}</span>
      </div>`;
    };

    const half = items.map(buildItem).join('');
    track.innerHTML = half + half;
    FT.lastFtBuild = Date.now();
  },

  start() {
    FT.build();
    setInterval(FT.build, 60000); // refresh every 60s
    FT.connectAngelWS();
  },

  connectAngelWS() {
    const creds = getAngelCreds();
    if (!creds.apiKey) {
      document.getElementById('ft-angel-dot').className = 'ao-dot';
      document.getElementById('ft-angel-label').textContent = 'Angel One (not set)';
      return;
    }
    const host = localStorage.getItem('ao_bridge_host') || 'localhost';
    const port = localStorage.getItem('ao_bridge_port') || '8765';
    // Use wss:// if connecting to a remote host (GitHub Pages is HTTPS, requires secure WS)
    const isRemote = host !== 'localhost' && host !== '127.0.0.1';
    const proto = isRemote ? 'wss' : 'ws';
    const wsUrl = `${proto}://${host}:${port}`;
    const ws = new WebSocket(wsUrl);
    FT.ws = ws;
    ws.onopen = () => {
      document.getElementById('ft-angel-dot').className = 'ao-dot live';
      document.getElementById('ft-angel-label').textContent = 'Angel One ✓';
      document.getElementById('conn-angelone-dot').className = 'lm-conn-dot live';
      document.getElementById('lm-angel-status').innerHTML = '🟢 Angel One connected via bridge';
      document.getElementById('lm-nse-status').textContent = '🟢 Live · Angel One';
      document.getElementById('lm-nse-status').style.color = 'var(--green)';
      const aoStatus = document.getElementById('ao-ws-dot');
      if(aoStatus) { aoStatus.style.background='var(--green)'; document.getElementById('ao-ws-status-text').textContent='Connected to Python bridge'; }
      ws.send(JSON.stringify({ type:'subscribe', symbols:['NIFTY','BANKNIFTY','SENSEX','NIFTYIT','MIDCPNIFTY','INDIAVIX'] }));
    };
    ws.onmessage = (e) => {
      try {
        const msg = JSON.parse(e.data);
        if (msg.type === 'tick') {
          const ticks = Array.isArray(msg.data) ? msg.data : [msg.data];
          ticks.forEach(t => {
            FT.angelData[t.symbol] = t;
            updateLMIndexFromAngel(t);
          });
          if (Date.now() - FT.lastFtBuild > 5000) FT.build();
        }
        if (msg.type === 'fochain') {
          renderFOChain(msg.data);
        }
        if (msg.type === 'movers') {
          renderNSEMovers(msg.data);
        }
      } catch(err){}
    };
    ws.onerror = () => {
      document.getElementById('ft-angel-dot').className = 'ao-dot';
      document.getElementById('ft-angel-label').textContent = 'Angel One (bridge offline)';
      document.getElementById('conn-angelone-dot').className = 'lm-conn-dot offline';
    };
    ws.onclose = () => {
      document.getElementById('ft-angel-dot').className = 'ao-dot';
      // retry after 10s
      setTimeout(() => FT.connectAngelWS(), 10000);
    };
  }
};

function fmtNum(v) {
  if (v >= 10000) return v.toLocaleString('en-IN', {maximumFractionDigits:2});
  return v?.toFixed(2) ?? '—';
}

// ═══════════════════════════════════════════════════════════════
//   LIVE MARKETS VIEW — POPULATE FUNCTIONS
// ═══════════════════════════════════════════════════════════════
async function refreshLiveMarkets() {
  document.getElementById('lm-last-updated').textContent = 'Updating…';
  await Promise.all([
    loadLMCrypto(),
    loadLMForex(),
    loadLMUSIndices(),
  ]);
  loadFOChain();
  document.getElementById('lm-last-updated').textContent = 'Updated: '+new Date().toLocaleTimeString('en-IN');
}

async function loadLMCrypto() {
  const el = document.getElementById('lm-crypto-cards');
  if (!el) return;
  const st = document.getElementById('lm-crypto-status');
  if(st) { st.textContent='⟳ Loading…'; st.style.color='var(--yellow)'; }
  try {
    const data = await LiveData.fetchCryptoPrices();
    if (!data) throw new Error('no data');
    const coins = [
      {id:'bitcoin',sym:'BTC',name:'Bitcoin',icon:'₿',bg:'#f7931a'},
      {id:'ethereum',sym:'ETH',name:'Ethereum',icon:'Ξ',bg:'#627eea'},
      {id:'solana',sym:'SOL',name:'Solana',icon:'◎',bg:'#9945ff'},
      {id:'binancecoin',sym:'BNB',name:'BNB',icon:'B',bg:'#f3ba2f'},
      {id:'ripple',sym:'XRP',name:'XRP',icon:'✕',bg:'#00aae4'},
      {id:'cardano',sym:'ADA',name:'Cardano',icon:'₳',bg:'#0d1e2d'},
      {id:'polkadot',sym:'DOT',name:'Polkadot',icon:'●',bg:'#e6007a'},
      {id:'chainlink',sym:'LINK',name:'Chainlink',icon:'⬡',bg:'#2a5ada'},
    ];
    el.innerHTML = coins.filter(c => data[c.id]).map(c => {
      const d = data[c.id];
      const up = d.usd_24h_change >= 0;
      const chg = (d.usd_24h_change||0).toFixed(2);
      const mc = d.usd_market_cap >= 1e9 ? '$'+(d.usd_market_cap/1e9).toFixed(1)+'B' : '$'+(d.usd_market_cap/1e6).toFixed(0)+'M';
      return `<div class="lm-crypto-card">
        <div class="lm-crypto-icon" style="background:${c.bg}20;color:${c.bg};font-size:14px">${c.icon}</div>
        <div style="flex:1">
          <div class="lm-crypto-name">${c.name}</div>
          <div class="lm-crypto-sub">${c.sym} · MCap ${mc}</div>
        </div>
        <div style="text-align:right">
          <div style="font-family:var(--font-mono);font-size:13px;font-weight:500">$${fmtPrice(d.usd)}</div>
          <div class="lm-index-chg ${up?'up':'dn'}">${up?'▲':'▼'} ${up?'+':''}${chg}%</div>
        </div>
      </div>`;
    }).join('');
    if(st) { st.textContent='🟢 Live · CoinGecko'; st.style.color='var(--green)'; }
    document.getElementById('conn-cg-dot').className = 'lm-conn-dot live';
  } catch(e) {
    if(st) { st.textContent='⚠ Error'; st.style.color='var(--red)'; }
  }
}

async function loadLMForex() {
  const el = document.getElementById('lm-forex-rates');
  if (!el) return;
  const st = document.getElementById('lm-fx-status');
  try {
    const rates = await LiveData.fetchForexRates();
    if (!rates) throw new Error('no rates');
    const pairs = [
      { label:'USD/INR', flag:'🇮🇳', rate: rates.INR?.toFixed(2) || '—', note:'Indian Rupee' },
      { label:'EUR/USD', flag:'🇪🇺', rate: rates.EUR ? (1/rates.EUR).toFixed(4) : '—', note:'Euro' },
      { label:'GBP/USD', flag:'🇬🇧', rate: rates.GBP ? (1/rates.GBP).toFixed(4) : '—', note:'British Pound' },
      { label:'USD/JPY', flag:'🇯🇵', rate: rates.JPY?.toFixed(2) || '—', note:'Japanese Yen' },
      { label:'AUD/USD', flag:'🇦🇺', rate: rates.AUD ? (1/rates.AUD).toFixed(4) : '—', note:'Aus Dollar' },
      { label:'USD/CAD', flag:'🇨🇦', rate: rates.CAD?.toFixed(4) || '—', note:'Canadian Dollar' },
      { label:'USD/CHF', flag:'🇨🇭', rate: rates.CHF?.toFixed(4) || '—', note:'Swiss Franc' },
      { label:'USD/SGD', flag:'🇸🇬', rate: rates.SGD?.toFixed(4) || '—', note:'Singapore Dollar' },
    ];
    // USD/INR for commodity section
    const usdinr = document.getElementById('com-usdinr');
    if (usdinr && rates.INR) {
      usdinr.textContent = '₹'+rates.INR.toFixed(2);
      const uchg = document.getElementById('com-usdinr-chg');
      if(uchg) { uchg.textContent='Live rate'; uchg.className='lm-index-chg'; }
    }
    el.innerHTML = pairs.map(p => `
      <div class="lm-forex-row">
        <div><span style="font-size:16px;margin-right:6px">${p.flag}</span><span style="font-size:12px;font-weight:600">${p.label}</span><div style="font-size:10px;color:var(--text3)">${p.note}</div></div>
        <div style="font-family:var(--font-mono);font-size:14px;font-weight:500">${p.rate}</div>
      </div>`).join('');
    if(st) { st.textContent='🟢 Live · Frankfurter'; st.style.color='var(--green)'; }
    document.getElementById('conn-fx-dot').className = 'lm-conn-dot live';
  } catch(e) {
    if(st) { st.textContent='⚠ Error'; st.style.color='var(--red)'; }
  }
}

async function loadLMUSIndices() {
  if (!LiveData.hasFinnhub()) {
    const st = document.getElementById('lm-us-status');
    if(st) { st.innerHTML='⚫ <a href="#" onclick="openApiSettings()" style="color:var(--accent2)">Add Finnhub key</a>'; }
    return;
  }
  const st = document.getElementById('lm-us-status');
  if(st) { st.textContent='⟳ Loading…'; st.style.color='var(--yellow)'; }
  const syms = ['SPY','QQQ','DIA','IWM','VIX','GLD'];
  const ids =  ['spy','qqq','dia','iwm','vix','gld'];
  const labels = ['S&P 500','NASDAQ 100','DOW JONES','RUSSELL 2000','VIX','GOLD'];
  try {
    const quotes = await LiveData.fetchBatchQuotes(syms);
    syms.forEach((s,i) => {
      const q = quotes[s];
      const priceEl = document.getElementById(`idx-${ids[i]}`);
      const chgEl = document.getElementById(`idx-${ids[i]}-chg`);
      if (!priceEl || !chgEl) return;
      if (!q || !q.c) { priceEl.textContent='—'; chgEl.textContent='—'; return; }
      const chg = q.pc ? ((q.c-q.pc)/q.pc*100) : (q.dp||0);
      const up = chg >= 0;
      priceEl.textContent = s==='VIX' ? q.c.toFixed(2) : '$'+q.c.toFixed(2);
      chgEl.textContent = (up?'▲':'▼')+' '+(up?'+':'')+chg.toFixed(2)+'%';
      chgEl.className = 'lm-index-chg '+(up?'up':'dn');
    });
    if(st) { st.textContent='🟢 Live · Finnhub'; st.style.color='var(--green)'; }
    document.getElementById('conn-fh-dot').className = 'lm-conn-dot live';
    // US movers
    loadLMUSMovers(quotes, syms, labels);
  } catch(e) {
    if(st) { st.textContent='⚠ Error'; st.style.color='var(--red)'; }
  }
}

async function loadLMUSMovers(usQuotes, syms, labels) {
  const el = document.getElementById('lm-us-movers');
  if (!el) return;
  const st = document.getElementById('lm-us-movers-status');
  try {
    // Augment with more movers
    const moverSyms = ['NVDA','TSLA','AAPL','MSFT','META','GOOGL','AMZN','AMD','NFLX','JPM'];
    const mq = await LiveData.fetchBatchQuotes(moverSyms);
    const allRows = moverSyms.map(s => {
      const q = mq[s];
      if (!q||!q.c) return null;
      const chg = q.pc ? ((q.c-q.pc)/q.pc*100) : (q.dp||0);
      return {sym:s, price:'$'+q.c.toFixed(2), chg, up:chg>=0};
    }).filter(Boolean).sort((a,b)=>Math.abs(b.chg)-Math.abs(a.chg)).slice(0,8);

    el.innerHTML = allRows.map(r => `
      <div class="lm-index-card">
        <div><div class="lm-index-name">${r.sym}</div><div class="lm-index-sub">NASDAQ · US</div></div>
        <div>
          <div class="lm-index-price">${r.price}</div>
          <div class="lm-index-chg ${r.up?'up':'dn'}">${r.up?'▲':'▼'} ${r.up?'+':''}${r.chg.toFixed(2)}%</div>
        </div>
      </div>`).join('');
    if(st) { st.textContent='🟢 Live'; st.style.color='var(--green)'; }
  } catch(e) {
    el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text3);font-size:12px">Add Finnhub key for live movers</div>';
  }
}

function updateLMIndexFromAngel(tick) {
  // Map Angel One symbol to UI element
  const map = {
    'NIFTY': ['idx-nifty50','idx-nifty50-chg'],
    'BANKNIFTY': ['idx-banknifty','idx-banknifty-chg'],
    'SENSEX': ['idx-sensex','idx-sensex-chg'],
    'NIFTYIT': ['idx-niftyit','idx-niftyit-chg'],
    'MIDCPNIFTY': ['idx-midcap','idx-midcap-chg'],
    'INDIAVIX': ['idx-indiavix','idx-indiavix-chg'],
  };
  const ids = map[tick.symbol];
  if (!ids) return;
  const priceEl = document.getElementById(ids[0]);
  const chgEl = document.getElementById(ids[1]);
  if (priceEl) priceEl.textContent = fmtNum(tick.ltp);
  if (chgEl) {
    const up = tick.chg >= 0;
    chgEl.textContent = `${up?'▲':'▼'} ${up?'+':''}${tick.chg?.toFixed(2)}%`;
    chgEl.className = 'lm-index-chg '+(up?'up':'dn');
  }
  // Also update NSE status
  const st = document.getElementById('lm-nse-status');
  if(st) { st.textContent='🟢 Live · Angel One'; st.style.color='var(--green)'; }
}

// ── F&O CHAIN ────────────────────────────────────────────────────
let _foChainMode = 'gainers';
function setMoverFilter(mode) {
  _foChainMode = mode;
  document.getElementById('mover-gain-btn').style.color = mode==='gainers'?'var(--green)':'var(--text3)';
  document.getElementById('mover-loss-btn').style.color = mode==='losers'?'var(--red)':'var(--text3)';
}

function loadFOChain() {
  if (FT.ws && FT.ws.readyState === WebSocket.OPEN) {
    const sym = document.getElementById('fo-symbol-select')?.value || 'NIFTY';
    const exp = document.getElementById('fo-expiry-select')?.value || 'weekly';
    FT.ws.send(JSON.stringify({ type:'fochain', symbol:sym, expiry:exp }));
    const st = document.getElementById('lm-fo-status');
    if(st) { st.textContent='⟳ Requesting…'; st.style.color='var(--yellow)'; }
  } else {
    renderFOChainDemo();
  }
}

function renderFOChainDemo() {
  // Show demo chain with static data when Angel One not connected
  const spot = 22500;
  const strikes = [22000,22100,22200,22300,22400,22500,22600,22700,22800,22900,23000];
  const atm = strikes.reduce((a,b) => Math.abs(b-spot)<Math.abs(a-spot)?b:a);
  let html = strikes.map(strike => {
    const isATM = strike === atm;
    const callOI = Math.floor(Math.random()*8000+500);
    const putOI  = Math.floor(Math.random()*8000+500);
    const callLTP = Math.max(0,(atm-strike+200)*(Math.random()*0.5+0.75));
    const putLTP  = Math.max(0,(strike-atm+200)*(Math.random()*0.5+0.75));
    const callChg = (Math.random()-0.5)*10;
    const putChg  = (Math.random()-0.5)*10;
    return `<div class="fo-chain-row" style="${isATM?'background:rgba(108,99,255,0.06)':''}">
      <div class="fo-call" style="font-size:10px">${callOI.toLocaleString('en-IN')}</div>
      <div class="fo-call">${callLTP.toFixed(1)}</div>
      <div class="fo-call ${callChg>=0?'up':'dn'}">${callChg>=0?'+':''}${callChg.toFixed(1)}%</div>
      <div class="fo-strike${isATM?' atm':''}">${strike}</div>
      <div class="fo-put ${putChg>=0?'up':'dn'}">${putChg>=0?'+':''}${putChg.toFixed(1)}%</div>
      <div class="fo-put">${putLTP.toFixed(1)}</div>
      <div class="fo-put" style="font-size:10px">${putOI.toLocaleString('en-IN')}</div>
    </div>`;
  }).join('');
  const el = document.getElementById('fo-chain-body');
  if (el) el.innerHTML = '<div style="font-size:10px;color:var(--yellow);padding:8px 14px;border-bottom:1px solid var(--border)">⚠ Demo data — connect Angel One for live chain</div>' + html;
  document.getElementById('fo-pcr').textContent = '0.92';
  document.getElementById('fo-pcr-signal').textContent = 'Slightly Bearish';
  document.getElementById('fo-maxpain').textContent = '22,400';
  document.getElementById('fo-total-oi').textContent = '12.4L';
  document.getElementById('fo-oi-change').textContent = '+2.3% today';
}

function renderFOChain(data) {
  if (!data || !data.strikes) { renderFOChainDemo(); return; }
  const rows = data.strikes.map(s => {
    const isATM = s.atm;
    const callChgPct = s.callLTP && s.callPrevLTP ? ((s.callLTP-s.callPrevLTP)/s.callPrevLTP*100) : 0;
    const putChgPct  = s.putLTP  && s.putPrevLTP  ? ((s.putLTP -s.putPrevLTP )/s.putPrevLTP *100) : 0;
    return `<div class="fo-chain-row" style="${isATM?'background:rgba(108,99,255,0.08)':''}">
      <div class="fo-call" style="font-size:10px">${(s.callOI||0).toLocaleString('en-IN')}</div>
      <div class="fo-call">${(s.callLTP||0).toFixed(1)}</div>
      <div class="fo-call ${callChgPct>=0?'up':'dn'}">${callChgPct>=0?'+':''}${callChgPct.toFixed(1)}%</div>
      <div class="fo-strike${isATM?' atm':''}">${s.strike}</div>
      <div class="fo-put ${putChgPct>=0?'up':'dn'}">${putChgPct>=0?'+':''}${putChgPct.toFixed(1)}%</div>
      <div class="fo-put">${(s.putLTP||0).toFixed(1)}</div>
      <div class="fo-put" style="font-size:10px">${(s.putOI||0).toLocaleString('en-IN')}</div>
    </div>`;
  }).join('');
  const el = document.getElementById('fo-chain-body');
  if(el) el.innerHTML = rows;
  if (data.pcr) {
    document.getElementById('fo-pcr').textContent = data.pcr.toFixed(2);
    document.getElementById('fo-pcr-signal').textContent = data.pcr > 1.2 ? 'Bullish' : data.pcr < 0.8 ? 'Bearish' : 'Neutral';
  }
  if (data.maxPain) document.getElementById('fo-maxpain').textContent = fmtNum(data.maxPain);
  if (data.totalOI) document.getElementById('fo-total-oi').textContent = (data.totalOI/100000).toFixed(1)+'L';
  const st = document.getElementById('lm-fo-status');
  if(st) { st.textContent='🟢 Live · Angel One'; st.style.color='var(--green)'; }
}

function renderNSEMovers(data) {
  const el = document.getElementById('lm-nse-movers');
  if (!el || !data) return;
  const list = _foChainMode === 'gainers' ? (data.gainers||[]) : (data.losers||[]);
  el.innerHTML = list.slice(0,10).map(s => {
    const up = s.chg >= 0;
    return `<div class="lm-index-card">
      <div><div class="lm-index-name">${s.symbol}</div><div class="lm-index-sub">NSE · ${s.series||'EQ'}</div></div>
      <div>
        <div class="lm-index-price">₹${fmtNum(s.ltp)}</div>
        <div class="lm-index-chg ${up?'up':'dn'}">${up?'▲':'▼'} ${up?'+':''}${s.chg?.toFixed(2)}%</div>
      </div>
    </div>`;
  }).join('');
}

// ── ANGEL ONE CREDS & OVERLAY ───────────────────────────────────
function getAngelCreds() {
  return {
    clientCode: localStorage.getItem('ao_client_code')||'',
    apiKey:     localStorage.getItem('ao_api_key')||'',
    totpSecret: localStorage.getItem('ao_totp_secret')||'',
    mpin:       localStorage.getItem('ao_mpin')||'',
  };
}
function openAngelOneSetup() {
  const o = document.getElementById('angelOneOverlay');
  if (!o) return;
  o.classList.add('open');
  const c = getAngelCreds();
  document.getElementById('ao-client-code').value = c.clientCode;
  document.getElementById('ao-api-key').value = c.apiKey;
  document.getElementById('ao-totp-secret').value = c.totpSecret;
  document.getElementById('ao-mpin').value = c.mpin;
  document.getElementById('ao-bridge-host').value = localStorage.getItem('ao_bridge_host')||'';
  document.getElementById('ao-bridge-port').value = localStorage.getItem('ao_bridge_port')||'8765';
  // Try pinging bridge
  pingAngelBridge();
}
function closeAngelOneSetup() {
  const o = document.getElementById('angelOneOverlay');
  if (o) o.classList.remove('open');
}
function saveAngelOneCreds() {
  const cc = document.getElementById('ao-client-code')?.value.trim();
  const ak = document.getElementById('ao-api-key')?.value.trim();
  const ts = document.getElementById('ao-totp-secret')?.value.trim();
  const mp = document.getElementById('ao-mpin')?.value.trim();
  const bh = document.getElementById('ao-bridge-host')?.value.trim();
  const bp = document.getElementById('ao-bridge-port')?.value.trim();
  if (cc) localStorage.setItem('ao_client_code', cc);
  if (ak) localStorage.setItem('ao_api_key', ak);
  if (ts) localStorage.setItem('ao_totp_secret', ts);
  if (mp) localStorage.setItem('ao_mpin', mp);
  if (bh) localStorage.setItem('ao_bridge_host', bh);
  if (bp) localStorage.setItem('ao_bridge_port', bp);
  closeAngelOneSetup();
  showToast('✅ Angel One credentials saved — starting bridge connection…', 'success');
  FT.connectAngelWS();
}
function clearAngelOneCreds() {
  ['ao_client_code','ao_api_key','ao_totp_secret','ao_mpin'].forEach(k => localStorage.removeItem(k));
  showToast('Angel One credentials cleared', 'info');
}
function pingAngelBridge() {
  const host = localStorage.getItem('ao_bridge_host') || 'localhost';
  const port = localStorage.getItem('ao_bridge_port')||'8765';
  const isRemote = host !== 'localhost' && host !== '127.0.0.1';
  const proto = isRemote ? 'wss' : 'ws';
  const dot = document.getElementById('ao-ws-dot');
  const txt = document.getElementById('ao-ws-status-text');
  if(!dot||!txt) return;
  try {
    const ws = new WebSocket(`${proto}://${host}:${port}`);
    ws.onopen = () => { dot.style.background='var(--green)'; txt.textContent=`Connected to bridge at ${host}:${port}`; ws.close(); };
    ws.onerror = () => { dot.style.background='var(--red)'; txt.textContent=`Bridge not reachable at ${host}:${port} — is angel_bridge.py running?`; };
  } catch(e) { dot.style.background='var(--red)'; txt.textContent='Cannot connect to bridge'; }
}

function downloadAngelBridge() {
  const creds = getAngelCreds();
  const py = `#!/usr/bin/env python3
"""
Zen Journal — Angel One SmartAPI Bridge
Run this script, then open your Zen Trading Journal in the browser.
The journal auto-connects via WebSocket on localhost:8765.

Install dependencies first:
  pip install smartapi-python websockets pyotp requests

Usage:
  python angel_bridge.py
"""

import asyncio, json, logging, signal, sys, time
import websockets
from SmartApi import SmartConnect
import pyotp

logging.basicConfig(level=logging.INFO, format='%(asctime)s %(levelname)s %(message)s')
log = logging.getLogger('AngelBridge')

# ── CREDENTIALS ─────────────────────────────────────────────────
# Fill these in OR set as environment variables
CLIENT_CODE  = "${creds.clientCode || 'YOUR_CLIENT_CODE'}"
API_KEY      = "${creds.apiKey || 'YOUR_API_KEY'}"
TOTP_SECRET  = "${creds.totpSecret || 'YOUR_TOTP_BASE32_SECRET'}"
MPIN         = "${creds.mpin || 'YOUR_MPIN'}"
BRIDGE_PORT  = 8765

# ── NSE Symbol token mapping (add more as needed) ──────────────
NSE_TOKENS = {
    "NIFTY":       {"token":"99926000","exchange":"NSE","symbolname":"Nifty 50"},
    "BANKNIFTY":   {"token":"99926009","exchange":"NSE","symbolname":"Nifty Bank"},
    "FINNIFTY":    {"token":"99926037","exchange":"NSE","symbolname":"Nifty Fin Service"},
    "MIDCPNIFTY":  {"token":"99926074","exchange":"NSE","symbolname":"Nifty Midcap"},
    "SENSEX":      {"token":"1","exchange":"BSE","symbolname":"Sensex"},
    "INDIAVIX":    {"token":"99919000","exchange":"NSE","symbolname":"India VIX"},
}

# ── Global state ────────────────────────────────────────────────
connected_clients = set()
angel_obj = None
auth_token = None
last_prices = {}

def authenticate():
    """Authenticate with Angel One SmartAPI"""
    global angel_obj, auth_token
    totp = pyotp.TOTP(TOTP_SECRET).now()
    angel_obj = SmartConnect(api_key=API_KEY)
    session = angel_obj.generateSession(CLIENT_CODE, MPIN, totp)
    if not session or session.get('status') == False:
        raise Exception(f"Auth failed: {session}")
    auth_token = session['data']['jwtToken']
    log.info(f"✅ Authenticated as {CLIENT_CODE}")
    return angel_obj

def get_ltp(tokens_list):
    """Fetch LTP for a list of {exchange, symboltoken} dicts"""
    try:
        resp = angel_obj.ltpData(tokens_list[0]['exchange'], tokens_list[0]['symboltoken'], tokens_list[0]['symboltoken'])
        return resp
    except Exception as e:
        log.warning(f"LTP fetch error: {e}")
        return None

async def broadcast(message):
    """Send message to all connected browser clients"""
    if connected_clients:
        dead = set()
        for ws in connected_clients:
            try:
                await ws.send(json.dumps(message))
            except:
                dead.add(ws)
        connected_clients -= dead

async def price_loop():
    """Continuously fetch prices and broadcast to clients"""
    global last_prices
    symbols = list(NSE_TOKENS.keys())
    while True:
        try:
            ticks = []
            for sym, info in NSE_TOKENS.items():
                try:
                    resp = angel_obj.ltpData(info['exchange'], info['symbolname'], info['token'])
                    if resp and resp.get('status'):
                        ltp = float(resp['data']['ltp'])
                        prev = last_prices.get(sym, ltp)
                        chg_pct = ((ltp - prev) / prev * 100) if prev else 0
                        # For proper day change we'd need prev close — approximate here
                        ticks.append({
                            "symbol": sym,
                            "ltp": ltp,
                            "chg": round(chg_pct, 2),
                            "token": info['token'],
                            "exchange": info['exchange']
                        })
                        last_prices[sym] = ltp
                except Exception as e:
                    log.debug(f"Error fetching {sym}: {e}")
                    continue
            if ticks and connected_clients:
                await broadcast({"type": "tick", "data": ticks})
                log.info(f"Broadcast {len(ticks)} ticks to {len(connected_clients)} clients")
        except Exception as e:
            log.error(f"Price loop error: {e}")
            try:
                authenticate()
            except:
                pass
        await asyncio.sleep(5)  # poll every 5 seconds

async def get_fo_chain(symbol, expiry_type='weekly'):
    """Fetch F&O option chain for a symbol"""
    try:
        # Use Angel One option chain API
        resp = angel_obj.optionChain(symbol, expiry_type)
        if not resp or not resp.get('status'):
            return None
        data = resp.get('data', {})
        strikes = []
        spot = data.get('underlyingValue', 0)
        for row in data.get('optionChainData', []):
            call = row.get('CE', {})
            put  = row.get('PE', {})
            strike = row.get('strikePrice', 0)
            diff = abs(strike - spot)
            strikes.append({
                "strike": strike,
                "atm": diff == min(abs(r.get('strikePrice',0)-spot) for r in data.get('optionChainData',[])),
                "callOI":   call.get('openInterest', 0),
                "callLTP":  call.get('lastPrice', 0),
                "callPrevLTP": call.get('previousClose', 0),
                "putOI":    put.get('openInterest', 0),
                "putLTP":   put.get('lastPrice', 0),
                "putPrevLTP": put.get('previousClose', 0),
            })
        total_call_oi = sum(s['callOI'] for s in strikes)
        total_put_oi  = sum(s['putOI']  for s in strikes)
        pcr = total_put_oi / total_call_oi if total_call_oi else 0
        return {
            "strikes": strikes,
            "pcr": round(pcr, 2),
            "totalOI": total_call_oi + total_put_oi,
            "spotPrice": spot,
        }
    except Exception as e:
        log.error(f"F&O chain error: {e}")
        return None

async def handler(websocket, path=None):
    """Handle browser client connections"""
    connected_clients.add(websocket)
    log.info(f"Client connected — {len(connected_clients)} total")
    try:
        async for message in websocket:
            try:
                msg = json.loads(message)
                if msg.get('type') == 'subscribe':
                    syms = msg.get('symbols', [])
                    log.info(f"Subscription: {syms}")
                    await websocket.send(json.dumps({"type":"subscribed","symbols":syms}))

                elif msg.get('type') == 'fochain':
                    sym = msg.get('symbol','NIFTY')
                    exp = msg.get('expiry','weekly')
                    chain = await get_fo_chain(sym, exp)
                    if chain:
                        await websocket.send(json.dumps({"type":"fochain","data":chain}))
                    else:
                        await websocket.send(json.dumps({"type":"fochain","data":None,"error":"No data"}))

            except json.JSONDecodeError:
                pass
    except websockets.exceptions.ConnectionClosed:
        pass
    finally:
        connected_clients.discard(websocket)
        log.info(f"Client disconnected — {len(connected_clients)} total")

async def main():
    log.info("="*60)
    log.info("  Zen Journal — Angel One Bridge")
    log.info(f"  Port: {BRIDGE_PORT}")
    log.info("="*60)

    # Authenticate
    try:
        authenticate()
    except Exception as e:
        log.error(f"❌ Authentication failed: {e}")
        log.error("Check your CLIENT_CODE, API_KEY, TOTP_SECRET, MPIN")
        sys.exit(1)

    # Start WebSocket server + price loop concurrently
    server = await websockets.serve(handler, "localhost", BRIDGE_PORT)
    log.info(f"🟢 Bridge running on ws://localhost:{BRIDGE_PORT}")
    log.info("   Open your Zen Trading Journal — it will auto-connect")
    log.info("   Press Ctrl+C to stop")

    await asyncio.gather(
        server.wait_closed(),
        price_loop()
    )

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        log.info("Bridge stopped.")
`;
  const blob = new Blob([py], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'angel_bridge.py';
  a.click();
  URL.revokeObjectURL(url);
  showToast('📥 Downloaded angel_bridge.py', 'success');
}

// FT.start() and live markets init are called from the boot IIFE below (after app boots)


// ══════════════════════════════════════════════
// DATA LAYER — IndexedDB
// ══════════════════════════════════════════════
const DB_NAME = 'TradingJournal';
const DB_VERSION = 1;
let db = null;

function initDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('trades')) {
        const store = d.createObjectStore('trades', { keyPath: 'id', autoIncrement: true });
        store.createIndex('date', 'date');
        store.createIndex('market', 'market');
        store.createIndex('symbol', 'symbol');
      }
    };
    req.onsuccess = e => { db = e.target.result; resolve(db); };
    req.onerror = e => reject(e);
  });
}

function getAllTrades() {
  return new Promise((resolve, reject) => {
    const tx = db.transaction('trades', 'readonly');
    const req = tx.objectStore('trades').getAll();
    req.onsuccess = e => resolve(e.target.result.sort((a,b) => new Date(b.date) - new Date(a.date)));
    req.onerror = e => reject(e);
  });
}

function addTrade(trade) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction('trades', 'readwrite');
    const req = tx.objectStore('trades').add(trade);
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = e => reject(e);
  });
}

function updateTrade(trade) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction('trades', 'readwrite');
    const req = tx.objectStore('trades').put(trade);
    req.onsuccess = e => resolve();
    req.onerror = e => reject(e);
  });
}

function deleteTrade(id) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction('trades', 'readwrite');
    const req = tx.objectStore('trades').delete(id);
    req.onsuccess = () => resolve();
    req.onerror = e => reject(e);
  });
}

// ══════════════════════════════════════════════
// STATE
// ══════════════════════════════════════════════
let allTrades = [];
let filteredTrades = [];
let currentPage = 1;
const PAGE_SIZE = 20;
let sortCol = 'date';
let sortDir = -1;
let editingId = null;
let selectedDir = 'Long';

// ══════════════════════════════════════════════
// ANALYTICS
// ══════════════════════════════════════════════
function calcPnL(t) {
  const dir = t.direction === 'Long' ? 1 : -1;
  const gross = (t.exit - t.entry) * t.qty * dir;
  return gross - (t.fees || 0);
}

function calcR(t) {
  if (!t.stop || t.stop === 0) return null;
  const risk = Math.abs(t.entry - t.stop) * t.qty;
  if (risk === 0) return null;
  return calcPnL(t) / risk;
}

function getStats(trades) {
  if (!trades.length) return { pnl:0, wr:0, pf:0, r:0, dd:0, best:0, worst:0, wins:0, losses:0, grossW:0, grossL:0 };
  const pnls = trades.map(calcPnL);
  const wins = pnls.filter(p => p > 0);
  const losses = pnls.filter(p => p <= 0);
  const grossW = wins.reduce((a,b) => a+b, 0);
  const grossL = Math.abs(losses.reduce((a,b) => a+b, 0));
  const pnl = pnls.reduce((a,b) => a+b, 0);
  const wr = wins.length / trades.length * 100;
  const pf = grossL > 0 ? grossW / grossL : grossW > 0 ? Infinity : 0;
  const rs = trades.map(calcR).filter(r => r !== null);
  const r = rs.length ? rs.reduce((a,b) => a+b,0) / rs.length : 0;

  // max drawdown — must iterate in chronological order for a correct equity curve
  const chronoPnls = [...trades].sort((a,b) => new Date(a.date) - new Date(b.date)).map(calcPnL);
  let peak = 0, equity = 0, maxDD = 0;
  for (const p of chronoPnls) {
    equity += p;
    if (equity > peak) peak = equity;
    const dd = peak - equity;
    if (dd > maxDD) maxDD = dd;
  }

  return {
    pnl, wr, pf, r, dd: maxDD,
    best: Math.max(...pnls),
    worst: Math.min(...pnls),
    wins: wins.length,
    losses: losses.length,
    grossW, grossL,
    total: trades.length
  };
}

// ══════════════════════════════════════════════
// UI HELPERS
// ══════════════════════════════════════════════
function fmt$(n) {
  // Delegate to fmtCurrency if user has set a currency preference
  if (typeof fmtCurrency === 'function' && typeof userSettings !== 'undefined' && userSettings.currency) {
    const sym = userSettings.currency;
    const sign = n >= 0 ? '+' : '-';
    const abs = Math.abs(n);
    if (sym === '₹') {
      if (abs >= 1e7) return sign + sym + (abs/1e7).toFixed(2) + ' Cr';
      if (abs >= 1e5) return sign + sym + (abs/1e5).toFixed(2) + ' L';
      if (abs >= 1000) return sign + sym + (abs/1000).toFixed(1) + 'K';
      return sign + sym + abs.toFixed(2);
    } else {
      if (abs >= 1e9) return sign + sym + (abs/1e9).toFixed(2) + 'B';
      if (abs >= 1e6) return sign + sym + (abs/1e6).toFixed(2) + 'M';
      if (abs >= 1000) return sign + sym + (abs/1000).toFixed(1) + 'K';
      return sign + sym + abs.toFixed(2);
    }
  }
  // Fallback to $ formatting
  if (Math.abs(n) >= 1000000) return (n >= 0 ? '+$' : '-$') + Math.abs(n/1000000).toFixed(2) + 'M';
  if (Math.abs(n) >= 1000) return (n >= 0 ? '+$' : '-$') + Math.abs(n/1000).toFixed(1) + 'K';
  return (n >= 0 ? '+$' : '-$') + Math.abs(n).toFixed(2);
}

function fmtPct(n) { return (n >= 0 ? '+' : '') + n.toFixed(1) + '%'; }

function getMarketBadge(m) {
  const map = {
    'NSE':'nse', 'US Stocks':'us-stocks', 'Index':'index',
    'Options':'options', 'Futures':'futures', 'Cash':'cash',
    'Forex':'forex', 'Crypto':'crypto', 'Commodity':'commodity'
  };
  return `<span class="badge badge-${map[m] || 'options'}">${m}</span>`;
}

function showToast(msg, type='info') {
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  const icons = { success:'✓', error:'✕', info:'ℹ' };
  t.innerHTML = `<span>${icons[type]}</span><span>${msg}</span>`;
  document.getElementById('toastWrap').appendChild(t);
  setTimeout(() => {
    t.style.animation = 'fadeOut 0.3s forwards';
    setTimeout(() => t.remove(), 300);
  }, 3000);
}

function switchView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`view-${name}`).classList.add('active');
  document.querySelector(`[data-view="${name}"]`).classList.add('active');
  if (name === 'analytics') renderAnalytics();
  if (name === 'trades') renderTradesTable();
  if (name === 'risk') renderRiskView();
  if (name === 'premarket') renderPreMarket();
  if (name === 'postmarket') renderPostMarket();
  if (name === 'overview') renderOverview();
  if (name === 'news') renderNewsTab();
  if (name === 'screener') renderScreener();
  if (name === 'calculators') initCalculators();
  if (name === 'psychology') renderPsychology();
  if (name === 'quantlab') runQuantLab();
  if (name === 'decision') renderDecisionHistory();
  if (name === 'rules') { if (typeof initRules === 'function') initRules(); }
  if (name === 'changelog') {}  // static HTML — no render needed
  if (name === 'philosophy') {}  // static HTML — no render needed
  if (name === 'swot') {}        // static HTML — no render needed
  setTimeout(scrollActiveTabIntoView, 30);
}

// ══════════════════════════════════════════════
// STATS STRIP
// ══════════════════════════════════════════════
function renderStats() {
  const s = getStats(allTrades);

  const pnlEl = document.getElementById('stat-pnl');
  pnlEl.textContent = fmt$(s.pnl);
  pnlEl.className = 'stat-value ' + (s.pnl >= 0 ? 'positive' : 'negative');
  document.querySelector('#statsStrip .stat-card:nth-child(1)').className = 'stat-card ' + (s.pnl >= 0 ? 'positive' : 'negative');
  document.getElementById('stat-pnl-sub').textContent = `${s.total} trades`;

  const wrEl = document.getElementById('stat-wr');
  wrEl.textContent = s.wr.toFixed(1) + '%';
  wrEl.className = 'stat-value ' + (s.wr >= 50 ? 'positive' : 'negative');
  document.getElementById('stat-wr-sub').textContent = `${s.wins}W / ${s.losses}L`;

  const pfEl = document.getElementById('stat-pf');
  pfEl.textContent = isFinite(s.pf) ? s.pf.toFixed(2) : '∞';
  pfEl.className = 'stat-value ' + (s.pf >= 1 ? 'positive' : 'negative');

  document.getElementById('stat-r').textContent = s.r.toFixed(2) + 'R';
  document.getElementById('stat-r').className = 'stat-value ' + (s.r >= 0 ? 'positive' : 'negative');

  document.getElementById('stat-dd').textContent = s.dd > 0 ? '-$' + s.dd.toFixed(2) : '$0.00';
  document.getElementById('stat-dd').className = 'stat-value ' + (s.dd > 0 ? 'negative' : 'neutral');

  const bestEl = document.getElementById('stat-best');
  bestEl.textContent = fmt$(s.best || 0);
  bestEl.className = 'stat-value positive';
  const bestTrade = allTrades.find(t => Math.abs(calcPnL(t) - s.best) < 0.01);
  document.getElementById('stat-best-sub').textContent = bestTrade ? bestTrade.symbol : '—';

  // Market breakdown
  const markets = ['NSE','US Stocks','Index','Forex','Crypto','Commodity','Futures','Options'];
  markets.forEach(m => {
    const mTrades = allTrades.filter(t => t.market === m);
    const pnl = mTrades.reduce((a,t) => a + calcPnL(t), 0);
    const id = 'mkt-' + m.toLowerCase().replace(/ /g,'-');
    const el = document.getElementById(id);
    if (el) {
      el.textContent = pnl === 0 ? '$0' : fmt$(pnl);
      el.style.color = pnl > 0 ? 'var(--green)' : pnl < 0 ? 'var(--red)' : 'var(--text2)';
    }
  });
}

// ══════════════════════════════════════════════
// EQUITY CHART
// ══════════════════════════════════════════════
function renderEquityChart() {
  const canvas = document.getElementById('equityChart');
  const wrap = canvas.parentElement;
  canvas.width = wrap.clientWidth;
  canvas.height = wrap.clientHeight;
  const ctx = canvas.getContext('2d');

  const sorted = [...allTrades].sort((a,b) => new Date(a.date) - new Date(b.date));
  let eq = 0;
  const points = [{ x: 0, y: 0 }];
  sorted.forEach((t, i) => { eq += calcPnL(t); points.push({ x: i+1, y: eq }); });

  if (points.length < 2) {
    ctx.fillStyle = 'rgba(255,255,255,0.05)';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = 'rgba(255,255,255,0.2)';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.fillText('Add trades to see equity curve', canvas.width/2, canvas.height/2);
    return;
  }

  const vals = points.map(p => p.y);
  const minY = Math.min(...vals), maxY = Math.max(...vals);
  const range = maxY - minY || 1;
  const pad = { t:20, b:40, l:60, r:20 };
  const W = canvas.width - pad.l - pad.r;
  const H = canvas.height - pad.t - pad.b;

  const px = i => pad.l + (i / (points.length-1)) * W;
  const py = v => pad.t + H - ((v - minY) / range * H);

  // Grid
  ctx.strokeStyle = 'rgba(255,255,255,0.04)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.t + (H / 4 * i);
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l + W, y); ctx.stroke();
    const val = maxY - (range/4)*i;
    ctx.fillStyle = 'rgba(255,255,255,0.25)';
    ctx.font = '10px JetBrains Mono';
    ctx.textAlign = 'right';
    ctx.fillText((val >= 0 ? '$' : '-$') + Math.abs(val).toFixed(0), pad.l - 8, y + 3);
  }

  // Zero line
  if (minY < 0 && maxY > 0) {
    const zy = py(0);
    ctx.strokeStyle = 'rgba(255,255,255,0.15)';
    ctx.setLineDash([4, 4]);
    ctx.beginPath(); ctx.moveTo(pad.l, zy); ctx.lineTo(pad.l + W, zy); ctx.stroke();
    ctx.setLineDash([]);
  }

  // Gradient fill
  const grad = ctx.createLinearGradient(0, pad.t, 0, pad.t + H);
  const finalVal = points[points.length-1].y;
  const isPos = finalVal >= 0;
  grad.addColorStop(0, isPos ? 'rgba(74,222,128,0.25)' : 'rgba(248,113,113,0.25)');
  grad.addColorStop(1, 'rgba(0,0,0,0)');

  ctx.beginPath();
  ctx.moveTo(px(0), py(points[0].y));
  points.forEach((p, i) => i > 0 && ctx.lineTo(px(i), py(p.y)));
  ctx.lineTo(px(points.length-1), pad.t + H);
  ctx.lineTo(px(0), pad.t + H);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  const lineColor = isPos ? '#4ade80' : '#f87171';
  ctx.beginPath();
  ctx.moveTo(px(0), py(points[0].y));
  points.forEach((p, i) => i > 0 && ctx.lineTo(px(i), py(p.y)));
  ctx.strokeStyle = lineColor;
  ctx.lineWidth = 2;
  ctx.stroke();

  // End dot
  const ex = px(points.length-1), ey = py(finalVal);
  ctx.beginPath(); ctx.arc(ex, ey, 5, 0, Math.PI*2);
  ctx.fillStyle = lineColor; ctx.fill();
  ctx.beginPath(); ctx.arc(ex, ey, 8, 0, Math.PI*2);
  ctx.strokeStyle = lineColor; ctx.globalAlpha = 0.3; ctx.lineWidth = 2; ctx.stroke();
  ctx.globalAlpha = 1;
}

// ══════════════════════════════════════════════
// DONUT CHART
// ══════════════════════════════════════════════
function renderDonut() {
  const s = getStats(allTrades);
  const canvas = document.getElementById('donutChart');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, 140, 140);

  const wr = s.wr / 100;
  document.getElementById('donutValue').textContent = s.wr.toFixed(1) + '%';
  document.getElementById('donutValue').style.color = s.wr >= 50 ? 'var(--green)' : 'var(--red)';

  const cx = 70, cy = 70, r = 52, thick = 14;
  const startAngle = -Math.PI / 2;

  // BG ring
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.strokeStyle = 'rgba(255,255,255,0.06)';
  ctx.lineWidth = thick;
  ctx.stroke();

  if (allTrades.length === 0) return;

  // Loss arc
  ctx.beginPath();
  ctx.arc(cx, cy, r, startAngle, startAngle + Math.PI * 2);
  ctx.strokeStyle = '#f87171';
  ctx.lineWidth = thick;
  ctx.lineCap = 'butt';
  ctx.stroke();

  // Win arc
  ctx.beginPath();
  ctx.arc(cx, cy, r, startAngle, startAngle + Math.PI * 2 * wr);
  ctx.strokeStyle = '#4ade80';
  ctx.lineWidth = thick;
  ctx.lineCap = 'round';
  ctx.stroke();
}

// ══════════════════════════════════════════════
// HEATMAP
// ══════════════════════════════════════════════
function renderHeatmap() {
  const el = document.getElementById('heatmap');
  const byDay = {};
  allTrades.forEach(t => {
    const d = t.date;
    if (!byDay[d]) byDay[d] = 0;
    byDay[d] += calcPnL(t);
  });

  const today = new Date();
  const weeks = 8;
  const days = weeks * 7;
  const rows = ['', 'M','','W','','F',''];
  let html = '';

  for (let r = 0; r < 7; r++) {
    html += `<div class="heatmap-row"><div class="heatmap-label">${rows[r]}</div>`;
    for (let w = 0; w < weeks; w++) {
      const daysAgo = (weeks - 1 - w) * 7 + (6 - r);
      const date = new Date(today);
      date.setDate(date.getDate() - daysAgo);
      const key = date.toISOString().split('T')[0];
      const val = byDay[key] || 0;
      let cls = '';
      if (val > 500) cls = 'win-lg';
      else if (val > 100) cls = 'win-md';
      else if (val > 0) cls = 'win-sm';
      else if (val < -500) cls = 'loss-lg';
      else if (val < -100) cls = 'loss-md';
      else if (val < 0) cls = 'loss-sm';
      const tip = val !== 0 ? `${key}: ${fmt$(val)}` : key;
      html += `<div class="heatmap-cell ${cls}" title="${tip}"></div>`;
    }
    html += '</div>';
  }
  el.innerHTML = html;
}

// ══════════════════════════════════════════════
// RECENT TRADES
// ══════════════════════════════════════════════
function renderRecentTrades() {
  const el = document.getElementById('recentTrades');
  const recent = allTrades.slice(0, 8);

  if (!recent.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">📊</div><div class="empty-title">No trades yet</div><div class="empty-sub">Click "New Trade" to get started</div></div>`;
    return;
  }

  el.innerHTML = recent.map(t => {
    const pnl = calcPnL(t);
    return `<div class="trade-row" onclick="openEditModal(${t.id})">
      <div class="trade-date">${t.date}</div>
      <div>
        <div class="trade-symbol">${t.symbol}</div>
        <div class="trade-type">${t.setup || '—'}</div>
      </div>
      <span class="trade-tag ${t.direction === 'Long' ? 'tag-long' : 'tag-short'}">${t.direction}</span>
      <span class="trade-market">${t.market}</span>
      <div class="trade-pnl ${pnl >= 0 ? 'pos' : 'neg'}">${fmt$(pnl)}</div>
    </div>`;
  }).join('');
}

// ══════════════════════════════════════════════
// TRADES TABLE
// ══════════════════════════════════════════════
function applyFilters() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const market = document.getElementById('marketFilter').value;
  const dir = document.getElementById('directionFilter').value;
  const result = document.getElementById('resultFilter').value;

  filteredTrades = allTrades.filter(t => {
    if (search && !t.symbol.toLowerCase().includes(search)) return false;
    if (market && t.market !== market) return false;
    if (dir && t.direction !== dir) return false;
    if (result) {
      const pnl = calcPnL(t);
      if (result === 'win' && pnl <= 0) return false;
      if (result === 'loss' && pnl > 0) return false;
    }
    return true;
  });

  // Sort
  filteredTrades.sort((a,b) => {
    let va, vb;
    if (sortCol === 'pnl') { va = calcPnL(a); vb = calcPnL(b); }
    else if (sortCol === 'date') { va = new Date(a.date); vb = new Date(b.date); }
    else { va = a[sortCol]; vb = b[sortCol]; }
    return sortDir * (va > vb ? 1 : va < vb ? -1 : 0);
  });

  currentPage = 1;
  renderTradesTable();
}

function renderTradesTable() {
  const tbody = document.getElementById('tradesBody');
  document.getElementById('tradeCount').textContent = `${filteredTrades.length} trades`;

  if (!filteredTrades.length) {
    tbody.innerHTML = `<tr><td colspan="12"><div class="empty-state"><div class="empty-icon">📋</div><div class="empty-title">No trades found</div><div class="empty-sub">Try adjusting your filters</div></div></td></tr>`;
    document.getElementById('pagination').style.display = 'none';
    return;
  }

  const start = (currentPage - 1) * PAGE_SIZE;
  const pageTrades = filteredTrades.slice(start, start + PAGE_SIZE);

  tbody.innerHTML = pageTrades.map(t => {
    const pnl = calcPnL(t);
    const r = calcR(t);
    const pct = t.entry > 0 ? ((t.exit - t.entry) / t.entry * 100 * (t.direction === 'Long' ? 1 : -1)) : 0;
    return `<tr onclick="openEditModal(${t.id})">
      <td>${t.date}</td>
      <td class="symbol">${t.symbol}</td>
      <td>${getMarketBadge(t.market)}</td>
      <td><span class="trade-tag ${t.direction === 'Long' ? 'tag-long' : 'tag-short'}">${t.direction}</span></td>
      <td>$${(+t.entry).toFixed(2)}</td>
      <td>$${(+t.exit).toFixed(2)}</td>
      <td>${t.qty}</td>
      <td class="${pnl >= 0 ? 'pos' : 'neg'}">${fmt$(pnl)}</td>
      <td class="${pct >= 0 ? 'pos' : 'neg'}">${fmtPct(pct)}</td>
      <td class="${r !== null && r >= 0 ? 'pos' : 'neg'}">${r !== null ? r.toFixed(2)+'R' : '—'}</td>
      <td style="color:var(--text3);font-size:11px">${t.setup || '—'}</td>
      <td onclick="event.stopPropagation()">
        <div style="display:flex;gap:6px">
          <button class="btn btn-ghost" style="padding:4px 10px;font-size:11px" onclick="openEditModal(${t.id})">Edit</button>
          <button class="btn btn-ghost" style="padding:4px 10px;font-size:11px;color:var(--red)" onclick="confirmDelete(${t.id})">Del</button>
        </div>
      </td>
    </tr>`;
  }).join('');

  // Pagination
  const totalPages = Math.ceil(filteredTrades.length / PAGE_SIZE);
  const pagEl = document.getElementById('pagination');
  pagEl.style.display = totalPages > 1 ? 'flex' : 'none';
  document.getElementById('pageInfo').textContent = `Showing ${start+1}–${Math.min(start+PAGE_SIZE, filteredTrades.length)} of ${filteredTrades.length}`;

  const pagBtns = document.getElementById('pageBtns');
  pagBtns.innerHTML = '';
  const prev = document.createElement('button');
  prev.className = 'page-btn';
  prev.textContent = '←';
  prev.disabled = currentPage === 1;
  prev.onclick = () => { currentPage--; renderTradesTable(); };
  pagBtns.appendChild(prev);

  for (let i = 1; i <= totalPages; i++) {
    const b = document.createElement('button');
    b.className = 'page-btn' + (i === currentPage ? ' active' : '');
    b.textContent = i;
    const page = i;
    b.onclick = () => { currentPage = page; renderTradesTable(); };
    pagBtns.appendChild(b);
  }

  const next = document.createElement('button');
  next.className = 'page-btn';
  next.textContent = '→';
  next.disabled = currentPage === totalPages;
  next.onclick = () => { currentPage++; renderTradesTable(); };
  pagBtns.appendChild(next);
}

// ══════════════════════════════════════════════
// ANALYTICS
// ══════════════════════════════════════════════
function renderAnalytics() {
  const s = getStats(allTrades);

  // Stats panel
  const stats = [
    ['Total Trades', s.total],
    ['Winners', `${s.wins} (${s.wr.toFixed(1)}%)`],
    ['Losers', `${s.losses} (${(100-s.wr).toFixed(1)}%)`],
    ['Gross Profit', fmt$(s.grossW)],
    ['Gross Loss', '-$' + s.grossL.toFixed(2)],
    ['Profit Factor', isFinite(s.pf) ? s.pf.toFixed(2) : '∞'],
    ['Avg Win', s.wins ? fmt$(s.grossW/s.wins) : '$0'],
    ['Avg Loss', s.losses ? '-$' + (s.grossL/s.losses).toFixed(2) : '$0'],
    ['Avg R-Multiple', s.r.toFixed(2) + 'R'],
    ['Max Drawdown', '-$' + s.dd.toFixed(2)],
    ['Best Trade', fmt$(s.best || 0)],
    ['Worst Trade', '-$' + Math.abs(s.worst || 0).toFixed(2)],
  ];

  document.getElementById('analyticsStats').innerHTML = stats.map(([label, val]) => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:13px;color:var(--text3)">${label}</span>
      <span style="font-family:var(--font-mono);font-size:13px">${val}</span>
    </div>
  `).join('');

  renderMarketBar();
  renderDistChart();
  renderMonthlyChart();
  renderStreaks();
}

function drawBarChart(canvasId, labels, data, colors) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const _bw = canvas.parentElement ? canvas.parentElement.clientWidth - 48 : 400;
  canvas.width = _bw > 50 ? _bw : 400;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (!data.some(d => d !== 0)) {
    ctx.fillStyle = 'rgba(255,255,255,0.15)';
    ctx.font = '13px Inter';
    ctx.textAlign = 'center';
    ctx.fillText('No data', canvas.width/2, canvas.height/2);
    return;
  }

  const H = canvas.height, W = canvas.width;
  const pad = { t:10, b:30, l:10, r:10 };
  const maxAbs = Math.max(...data.map(Math.abs), 1);
  const barW = (W - pad.l - pad.r) / labels.length * 0.6;
  const barGap = (W - pad.l - pad.r) / labels.length;

  data.forEach((val, i) => {
    const x = pad.l + i * barGap + barGap * 0.2;
    const barH = Math.abs(val) / maxAbs * (H - pad.t - pad.b);
    const y = pad.t + (H - pad.t - pad.b) - barH;

    ctx.fillStyle = colors ? colors[i] : (val >= 0 ? '#4ade80' : '#f87171');
    ctx.beginPath();
    // roundRect polyfill for Safari < 15.4 and older Android WebView
    if (ctx.roundRect) {
      ctx.roundRect(x, y, barW, barH, [4, 4, 0, 0]);
    } else {
      const r = 4;
      ctx.moveTo(x + r, y); ctx.lineTo(x + barW - r, y);
      ctx.quadraticCurveTo(x + barW, y, x + barW, y + r);
      ctx.lineTo(x + barW, y + barH); ctx.lineTo(x, y + barH);
      ctx.lineTo(x, y + r); ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
    }
    ctx.fill();

    ctx.fillStyle = 'rgba(255,255,255,0.4)';
    ctx.font = '10px JetBrains Mono';
    ctx.textAlign = 'center';
    ctx.fillText(labels[i], x + barW/2, H - 8);
  });
}

function renderMarketBar() {
  const markets = ['NSE','US Stocks','Index','Forex','Crypto','Commodity','Futures','Options'];
  const labels = markets.map(m => m.length > 5 ? m.slice(0,4) : m);
  const data = markets.map(m => allTrades.filter(t => t.market === m).reduce((a,t) => a + calcPnL(t), 0));
  drawBarChart('marketBarChart', labels, data);
}

function renderDistChart() {
  const canvas = document.getElementById('distChart');
  if (!canvas || !allTrades.length) return;
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.parentElement.clientWidth - 48;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const pnls = allTrades.map(calcPnL);
  const min = Math.min(...pnls), max = Math.max(...pnls);
  const buckets = 10;
  const range = (max - min) || 1;
  const counts = new Array(buckets).fill(0);
  pnls.forEach(p => {
    let b = Math.floor((p - min) / range * (buckets - 0.001));
    counts[b]++;
  });
  const labels = counts.map((_, i) => {
    const v = min + (range/buckets) * i;
    return (v >= 0 ? '+' : '') + (v >= 1000 ? (v/1000).toFixed(0)+'K' : v.toFixed(0));
  });
  const colors = labels.map(l => l.startsWith('-') ? '#f87171' : '#4ade80');
  drawBarChart('distChart', labels, counts, colors);
}

function renderMonthlyChart() {
  const byMonth = {};
  allTrades.forEach(t => {
    const m = t.date.slice(0, 7);
    if (!byMonth[m]) byMonth[m] = 0;
    byMonth[m] += calcPnL(t);
  });
  const sorted = Object.keys(byMonth).sort();
  const labels = sorted.map(m => m.slice(5));
  const data = sorted.map(m => byMonth[m]);
  drawBarChart('monthlyChart', labels, data);
}

function renderStreaks() {
  const sorted = [...allTrades].sort((a,b) => new Date(a.date) - new Date(b.date));
  let curStreak = 0, maxWin = 0, maxLoss = 0;
  let cur = null;
  sorted.forEach(t => {
    const w = calcPnL(t) > 0;
    if (cur === null || w !== cur) { curStreak = 1; cur = w; }
    else curStreak++;
    if (w) maxWin = Math.max(maxWin, curStreak);
    else maxLoss = Math.max(maxLoss, curStreak);
  });

  const isWin = cur === true;
  const el = document.getElementById('streakPanel');
  el.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:12px;padding:8px 0">
      <div style="text-align:center;padding:24px;background:var(--bg3);border-radius:12px">
        <div style="font-size:12px;color:var(--text3);margin-bottom:8px">Current Streak</div>
        <div style="font-family:var(--font-mono);font-size:40px;color:${isWin?'var(--green)':'var(--red)'}">${sorted.length ? curStreak : 0}${sorted.length ? (isWin?'W':'L') : ''}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div style="padding:16px;background:var(--bg3);border-radius:10px;text-align:center">
          <div style="font-size:11px;color:var(--text3);margin-bottom:6px">Best Win Streak</div>
          <div style="font-family:var(--font-mono);font-size:24px;color:var(--green)">${maxWin}W</div>
        </div>
        <div style="padding:16px;background:var(--bg3);border-radius:10px;text-align:center">
          <div style="font-size:11px;color:var(--text3);margin-bottom:6px">Worst Loss Streak</div>
          <div style="font-family:var(--font-mono);font-size:24px;color:var(--red)">${maxLoss}L</div>
        </div>
      </div>
    </div>
  `;
}

// ══════════════════════════════════════════════
// MODAL
// ══════════════════════════════════════════════
function openAddModal() {
  editingId = null;
  document.getElementById('modalTitle').textContent = 'New Trade';
  document.getElementById('f-symbol').value = '';
  document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('f-market').value = 'Options';
  document.getElementById('f-entry').value = '';
  document.getElementById('f-exit').value = '';
  document.getElementById('f-qty').value = '';
  document.getElementById('f-stop').value = '';
  document.getElementById('f-fees').value = '';
  document.getElementById('f-setup').value = '';
  document.getElementById('f-notes').value = '';
  selectedDir = 'Long';
  updateSegment();
  document.getElementById('calcPnl').textContent = '—';
  document.getElementById('calcR').textContent = '—';
  document.getElementById('tradeModal').classList.add('open');
  setTimeout(() => document.getElementById('f-symbol').focus(), 100);
}

function openEditModal(id) {
  const trade = allTrades.find(t => t.id === id);
  if (!trade) return;
  editingId = id;
  document.getElementById('modalTitle').textContent = 'Edit Trade';
  document.getElementById('f-symbol').value = trade.symbol;
  document.getElementById('f-date').value = trade.date;
  document.getElementById('f-market').value = trade.market;
  document.getElementById('f-entry').value = trade.entry;
  document.getElementById('f-exit').value = trade.exit;
  document.getElementById('f-qty').value = trade.qty;
  document.getElementById('f-stop').value = trade.stop || '';
  document.getElementById('f-fees').value = trade.fees || '';
  document.getElementById('f-setup').value = trade.setup || '';
  document.getElementById('f-notes').value = trade.notes || '';
  selectedDir = trade.direction;
  updateSegment();
  updateCalcPnl();
  document.getElementById('tradeModal').classList.add('open');
}

function closeModal() {
  document.getElementById('tradeModal').classList.remove('open');
}

function updateSegment() {
  document.querySelectorAll('.seg-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.dir === selectedDir);
  });
}

function updateCalcPnl() {
  const entry = parseFloat(document.getElementById('f-entry').value);
  const exit = parseFloat(document.getElementById('f-exit').value);
  const qty = parseFloat(document.getElementById('f-qty').value) || 1;
  const fees = parseFloat(document.getElementById('f-fees').value) || 0;
  const stop = parseFloat(document.getElementById('f-stop').value);

  if (!isNaN(entry) && !isNaN(exit)) {
    const dir = selectedDir === 'Long' ? 1 : -1;
    const pnl = (exit - entry) * qty * dir - fees;
    const pnlEl = document.getElementById('calcPnl');
    pnlEl.textContent = fmt$(pnl);
    pnlEl.style.color = pnl >= 0 ? 'var(--green)' : 'var(--red)';

    if (!isNaN(stop)) {
      const risk = Math.abs(entry - stop) * qty;
      if (risk > 0) {
        const r = pnl / risk;
        const rEl = document.getElementById('calcR');
        rEl.textContent = r.toFixed(2) + 'R';
        rEl.style.color = r >= 0 ? 'var(--green)' : 'var(--red)';
      }
    }
  } else {
    document.getElementById('calcPnl').textContent = '—';
    document.getElementById('calcR').textContent = '—';
  }
}

// saveTrade() is defined below (after zen features) with full emotion + breath-gate support

async function confirmDelete(id) {
  showConfirm(
    '🗑️ Delete Trade?',
    'This action cannot be undone. The trade will be permanently removed from your journal.',
    async () => { await deleteTrade(id); showToast('Trade deleted'); await refresh(); }
  );
}

// ══════════════════════════════════════════════
// IMPORT / EXPORT
// ══════════════════════════════════════════════
function exportTrades() {
  if (!allTrades.length) { showToast('No trades to export', 'error'); return; }
  const headers = ['id','date','symbol','market','direction','entry','exit','qty','stop','fees','setup','notes'];
  const csv = [headers.join(','), ...allTrades.map(t => headers.map(h => JSON.stringify(t[h] ?? '')).join(','))].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `trades_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  showToast('Trades exported', 'success');
}

async function importCSV(text) {
  // RFC 4180 compliant CSV parser — handles quoted fields containing commas or newlines
  function parseCSVLine(line) {
    const result = [];
    let cur = '', inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (inQuotes && line[i+1] === '"') { cur += '"'; i++; } // escaped double-quote
        else inQuotes = !inQuotes;
      } else if (ch === ',' && !inQuotes) {
        result.push(cur.trim()); cur = '';
      } else { cur += ch; }
    }
    result.push(cur.trim());
    return result;
  }

  const lines = text.trim().split('\n');
  const headers = parseCSVLine(lines[0]).map(h => h.replace(/^"|"$/g,'').toLowerCase());
  let count = 0;

  for (let i = 1; i < lines.length; i++) {
    if (!lines[i].trim()) continue;
    const vals = parseCSVLine(lines[i]).map(v => v.replace(/^"|"$/g,''));
    const obj = {};
    headers.forEach((h, idx) => obj[h] = vals[idx] || '');

    const trade = {
      symbol: (obj.symbol || '').toUpperCase(),
      date: obj.date || new Date().toISOString().split('T')[0],
      market: obj.market || 'Cash',
      direction: obj.direction || 'Long',
      entry: parseFloat(obj.entry) || 0,
      exit: parseFloat(obj.exit) || 0,
      qty: parseFloat(obj.qty) || 1,
      stop: parseFloat(obj.stop) || null,
      fees: parseFloat(obj.fees) || 0,
      setup: obj.setup || '',
      notes: obj.notes || '',
    };

    if (trade.symbol && trade.entry && trade.exit) {
      await addTrade(trade);
      count++;
    }
  }

  await refresh();
  document.getElementById('importModal').classList.remove('open');
  showToast(`Imported ${count} trades`, 'success');
}



// ══════════════════════════════════════════════
// REFRESH
// ══════════════════════════════════════════════
async function refresh() {
  allTrades = await getAllTrades();
  filteredTrades = [...allTrades];
  renderStats();
  renderEquityChart();
  renderDonut();
  renderHeatmap();
  renderRecentTrades();
  applyFilters();
}

// ══════════════════════════════════════════════
// EVENTS
// ══════════════════════════════════════════════
document.querySelectorAll('.nav-btn').forEach(b => {
  b.addEventListener('click', () => switchView(b.dataset.view));
});

document.getElementById('addTradeBtn').addEventListener('click', openAddModal);
document.getElementById('exportBtn').addEventListener('click', exportTrades);
document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importModal').classList.add('open'));

document.querySelectorAll('.seg-btn').forEach(b => {
  b.addEventListener('click', () => { selectedDir = b.dataset.dir; updateSegment(); updateCalcPnl(); });
});

['f-entry','f-exit','f-qty','f-stop','f-fees'].forEach(id => {
  document.getElementById(id).addEventListener('input', updateCalcPnl);
});

document.getElementById('tradeModal').addEventListener('click', e => {
  if (e.target === document.getElementById('tradeModal')) closeModal();
});

document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('marketFilter').addEventListener('change', applyFilters);
document.getElementById('directionFilter').addEventListener('change', applyFilters);
document.getElementById('resultFilter').addEventListener('change', applyFilters);

document.querySelectorAll('thead th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    if (sortCol === th.dataset.sort) sortDir *= -1;
    else { sortCol = th.dataset.sort; sortDir = -1; }
    applyFilters();
  });
});

// File import
const fileInput = document.getElementById('fileInput');
fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => importCSV(ev.target.result);
  reader.readAsText(file);
});

const dropZone = document.getElementById('dropZone');
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => importCSV(ev.target.result);
  reader.readAsText(file);
});

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeModal(); document.getElementById('importModal').classList.remove('open'); }
  if ((e.metaKey || e.ctrlKey) && e.key === 'n') { e.preventDefault(); openAddModal(); }
});

// Resize handler
window.addEventListener('resize', () => {
  renderEquityChart();
});

// ══════════════════════════════════════════════
// INIT — SEED DEMO DATA IF EMPTY
// ══════════════════════════════════════════════
const DEMO_TRADES = [
  { symbol:'RELIANCE', date:'2025-11-04', market:'NSE', direction:'Long', entry:2850, exit:2980, qty:10, stop:2800, fees:50, setup:'Breakout', notes:'Q2 earnings play' },
  { symbol:'AAPL', date:'2025-11-07', market:'US Stocks', direction:'Long', entry:182.50, exit:191.30, qty:50, stop:178, fees:9.95, setup:'Momentum', notes:'Earnings beat' },
  { symbol:'EUR/USD', date:'2025-11-10', market:'Forex', direction:'Short', entry:1.0920, exit:1.0840, qty:50000, stop:1.0960, fees:5, setup:'Trend follow', notes:'DXY breakout' },
  { symbol:'BTC/USDT', date:'2025-11-12', market:'Crypto', direction:'Long', entry:63200, exit:67800, qty:0.5, stop:61000, fees:25, setup:'Support bounce', notes:'H4 demand zone' },
  { symbol:'GOLD/USD', date:'2025-11-14', market:'Commodity', direction:'Long', entry:2010, exit:2055, qty:2, stop:1990, fees:12, setup:'Macro hedge', notes:'Fed pivot trade' },
  { symbol:'US100', date:'2025-11-18', market:'Index', direction:'Long', entry:19800, exit:19500, qty:1, stop:19600, fees:8, setup:'Gap fill', notes:'Stop triggered' },
  { symbol:'NVDA', date:'2025-11-20', market:'US Stocks', direction:'Long', entry:820, exit:912, qty:15, stop:800, fees:9.95, setup:'Earnings', notes:'Beat consensus' },
  { symbol:'CRUDE OIL', date:'2025-11-22', market:'Commodity', direction:'Short', entry:74.50, exit:71.20, qty:1, stop:76, fees:8, setup:'Supply zone', notes:'OPEC miss' },
  { symbol:'SPY', date:'2025-11-25', market:'Options', direction:'Short', entry:3.80, exit:7.20, qty:5, stop:2, fees:10, setup:'Put spread', notes:'Tech weakness' },
  { symbol:'TCS', date:'2025-11-27', market:'NSE', direction:'Long', entry:3840, exit:3920, qty:5, stop:3800, fees:40, setup:'Dip buy', notes:'IT sector rotation' },
  { symbol:'ETH/USDT', date:'2025-12-02', market:'Crypto', direction:'Short', entry:3500, exit:3200, qty:1, stop:3600, fees:18, setup:'Distribution', notes:'OB rejection' },
  { symbol:'US300', date:'2025-12-05', market:'Index', direction:'Long', entry:21400, exit:21800, qty:1, stop:21200, fees:8, setup:'Trend follow', notes:'Strong breadth' },
  { symbol:'GBP/USD', date:'2025-12-08', market:'Forex', direction:'Long', entry:1.2640, exit:1.2720, qty:30000, stop:1.2600, fees:6, setup:'Range break', notes:'BoE pivot' },
  { symbol:'SILVER/USD', date:'2025-12-11', market:'Commodity', direction:'Long', entry:24.50, exit:26.10, qty:50, stop:23.80, fees:10, setup:'Altcoin season', notes:'Followed gold' },
  { symbol:'/ES', date:'2025-12-14', market:'Futures', direction:'Short', entry:5350, exit:5290, qty:1, stop:5380, fees:8, setup:'Supply zone', notes:'Overextended' },
];

async function seedDemo() {
  if (allTrades.length === 0) {
    for (const t of DEMO_TRADES) await addTrade(t);
    allTrades = await getAllTrades();
    showToast('Demo trades loaded', 'info');
  }
}

// ══════════════════════════════════════════════
// RISK MANAGEMENT
// ══════════════════════════════════════════════
const TRADING_RULES = [
  { text:'Never risk more than 1% per trade', badge:'CORE', color:'var(--accent)', key:'r1' },
  { text:'Always set stop loss before entry', badge:'SAFETY', color:'var(--red)', key:'r2' },
  { text:'Minimum 1:2 Risk-Reward ratio', badge:'EDGE', color:'var(--green)', key:'r3' },
  { text:'No revenge trading after 2 losses', badge:'MINDSET', color:'var(--yellow)', key:'r4' },
  { text:'Max 3 trades open simultaneously', badge:'EXPOSURE', color:'var(--cyan)', key:'r5' },
  { text:'Trade only in planned sessions', badge:'DISCIPLINE', color:'var(--orange)', key:'r6' },
  { text:'Journal every trade before closing', badge:'GROWTH', color:'var(--accent2)', key:'r7' },
  { text:'Cut losses at -2R, let winners run', badge:'MANAGEMENT', color:'var(--green)', key:'r8' },
];

function renderRiskView() {
  renderRulesList();
  calcPosition(); calcRR(); calcEV(); updateDDMonitor();
}

function renderRulesList() {
  const saved = JSON.parse(localStorage.getItem('tj_rules') || '{}');
  document.getElementById('rulesList').innerHTML = TRADING_RULES.map(r => `
    <div class="rule-item" onclick="toggleRule('${r.key}')">
      <div class="rule-check ${saved[r.key] ? 'checked' : ''}">${saved[r.key] ? '✓' : ''}</div>
      <span class="rule-text">${r.text}</span>
      <span class="rule-badge" style="background:${r.color}22;color:${r.color}">${r.badge}</span>
    </div>`).join('');
}

function toggleRule(key) {
  const saved = JSON.parse(localStorage.getItem('tj_rules') || '{}');
  saved[key] = !saved[key];
  localStorage.setItem('tj_rules', JSON.stringify(saved));
  renderRulesList();
}

function addCustomRule() {
  const inp = document.getElementById('customRuleInput');
  const text = inp ? inp.value.trim() : '';
  if (!text) { showToast('Type your rule first', 'error'); if(inp) inp.focus(); return; }
  TRADING_RULES.push({ text, badge:'CUSTOM', color:'var(--accent2)', key:'r'+Date.now() });
  if(inp) inp.value = '';
  renderRulesList();
  showToast('Rule added', 'success');
}

function calcPosition() {
  const acc = parseFloat(document.getElementById('rc-account').value) || 0;
  const rp = parseFloat(document.getElementById('rc-riskpct').value) || 1;
  const entry = parseFloat(document.getElementById('rc-entry').value) || 0;
  const stop = parseFloat(document.getElementById('rc-stop').value) || 0;
  if (!entry || !stop || entry === stop) return;
  const riskDollar = acc * rp / 100;
  const riskPerShare = Math.abs(entry - stop);
  const shares = Math.floor(riskDollar / riskPerShare);
  const posVal = shares * entry;
  document.getElementById('rc-shares').textContent = shares.toLocaleString();
  document.getElementById('rc-riskdollar').textContent = '$' + riskDollar.toFixed(0);
  document.getElementById('rc-posval').textContent = '$' + posVal.toFixed(0);
}

function calcRR() {
  const entry = parseFloat(document.getElementById('rr-entry').value) || 0;
  const stop = parseFloat(document.getElementById('rr-stop').value) || 0;
  const target = parseFloat(document.getElementById('rr-target').value) || 0;
  if (!entry || !stop || !target) return;
  const risk = Math.abs(entry - stop);
  const reward = Math.abs(target - entry);
  const ratio = reward / risk;
  const breakeven = (1 / (1 + ratio) * 100).toFixed(1);
  document.getElementById('rr-riskval').textContent = '$' + risk.toFixed(2);
  document.getElementById('rr-rewardval').textContent = '$' + reward.toFixed(2);
  document.getElementById('rr-ratio').textContent = '1:' + ratio.toFixed(2);
  document.getElementById('rr-breakeven').textContent = breakeven + '%';
  const riskW = Math.round(risk / (risk + reward) * 100);
  document.getElementById('rrVisual').innerHTML = `<div class="rr-risk" style="width:${riskW}%">R</div><div class="rr-reward">1:${ratio.toFixed(1)}</div>`;
}

function calcEV() {
  const wr = parseFloat(document.getElementById('ev-wr').value) / 100 || 0.55;
  const win = parseFloat(document.getElementById('ev-win').value) || 500;
  const loss = parseFloat(document.getElementById('ev-loss').value) || 250;
  const acc = parseFloat(document.getElementById('ev-account').value) || 100000;
  const ev = wr * win - (1 - wr) * loss;
  const kelly = ((wr * win - (1 - wr) * loss) / win * 100);
  const halfKelly = kelly / 2;
  const expRatio = win / loss;
  document.getElementById('ev-result').textContent = (ev >= 0 ? '+$' : '-$') + Math.abs(ev).toFixed(0);
  document.getElementById('ev-result').style.color = ev >= 0 ? 'var(--green)' : 'var(--red)';
  document.getElementById('ev-kelly').textContent = kelly.toFixed(1) + '%';
  document.getElementById('ev-halfkelly').textContent = '$' + (acc * halfKelly / 100).toFixed(0);
  document.getElementById('ev-exp').textContent = expRatio.toFixed(2) + ':1';
}

function updateDDMonitor() {
  const s = getStats(allTrades);
  const sorted = [...allTrades].sort((a,b) => new Date(a.date) - new Date(b.date));
  let peak = 0, equity = 0, curDD = 0;
  for (const t of sorted) { equity += calcPnL(t); if (equity > peak) peak = equity; }
  curDD = Math.max(0, peak - equity);
  const ddPct = peak > 0 ? (curDD / peak * 100) : 0;
  const el_pct = document.getElementById('dd-pct');
  if (el_pct) {
    el_pct.textContent = ddPct.toFixed(1) + '%';
    document.getElementById('dd-fill').style.width = Math.min(ddPct * 6.67, 100) + '%';
    document.getElementById('dd-peak').textContent = '$' + peak.toFixed(0);
    document.getElementById('dd-max').textContent = '$' + s.dd.toFixed(0);
    const consec = getConsecLosses();
    document.getElementById('dd-consecloss').textContent = consec;
    document.getElementById('dd-consecloss').style.color = consec >= 3 ? 'var(--red)' : 'var(--text)';
    const recovery = curDD > 0 ? (curDD / (1 - ddPct/100)).toFixed(0) : '—';
    document.getElementById('dd-recovery').textContent = curDD > 0 ? '$' + recovery : 'At Peak';
  }
}

function getConsecLosses() {
  const sorted = [...allTrades].sort((a,b) => new Date(b.date) - new Date(a.date));
  let c = 0;
  for (const t of sorted) { if (calcPnL(t) < 0) c++; else break; }
  return c;
}

// ══════════════════════════════════════════════
// PRE-MARKET
// ══════════════════════════════════════════════
const PRE_CHECKS = [
  { id:'pc1', label:'Check global market futures', sub:'S&P, Nikkei, DAX pre-market moves', group:1 },
  { id:'pc2', label:'Review overnight news & events', sub:'Central bank, geopolitical, earnings', group:1 },
  { id:'pc3', label:'Check economic calendar', sub:'High-impact events for today', group:1 },
  { id:'pc4', label:'Analyze key index levels', sub:'S&P 500, Nifty 50, key support/resistance', group:1 },
  { id:'pc5', label:'Review currency markets', sub:'USD strength, INR, major forex pairs', group:1 },
  { id:'pc6', label:'Identify today\'s key trades', sub:'Min. 1:2 RR setups only', group:2 },
  { id:'pc7', label:'Mark entry, target & stop levels', sub:'On chart before session starts', group:2 },
  { id:'pc8', label:'Check earnings releases today', sub:'Any holdings reporting?', group:2 },
  { id:'pc9', label:'Review yesterday\'s open positions', sub:'Adjust stops, check thesis still valid', group:2 },
  { id:'pc10', label:'Confirm setup matches your strategy', sub:'No "just feeling it" trades', group:2 },
  { id:'pc11', label:'Calculate max loss for today', sub:'Set daily stop loss limit', group:3 },
  { id:'pc12', label:'Review account exposure', sub:'No single position > 5% of account', group:3 },
  { id:'pc13', label:'Confirm no overleveraged positions', sub:'Margin levels safe?', group:3 },
  { id:'pc14', label:'Check broker platform & data feed', sub:'No technical issues before open', group:3 },
  { id:'pc15', label:'Mindset check — ready to trade?', sub:'Not tired, emotional, or distracted', group:3 },
];

function renderPreMarket() {
  const saved = JSON.parse(localStorage.getItem('tj_pre_checks') || '{}');
  [1,2,3].forEach(g => {
    const checks = PRE_CHECKS.filter(c => c.group === g);
    const done = checks.filter(c => saved[c.id]).length;
    const el = document.getElementById(`preChecklist${g}`);
    if (el) el.innerHTML = checks.map(c => `
      <div class="check-item ${saved[c.id] ? 'done' : ''}" onclick="togglePreCheck('${c.id}')">
        <div class="check-box">${saved[c.id] ? '✓' : ''}</div>
        <div><div class="check-label">${c.label}</div><div class="check-sub">${c.sub}</div></div>
      </div>`).join('');
    const prog = document.getElementById(`pre-prog-${g}`);
    if (prog) prog.style.width = (done / checks.length * 100) + '%';
  });
  // Restore saved text
  ['watchlist','levels','intention'].forEach(k => {
    const el = document.getElementById(`pre-${k}`);
    if (el) el.value = localStorage.getItem(`tj_pre_${k}`) || '';
  });
  // Restore mood
  const savedMood = localStorage.getItem('tj_pre_mood');
  if (savedMood) {
    document.querySelectorAll('#view-premarket .mood-btn').forEach(b => b.classList.toggle('selected', b.dataset.mood === savedMood));
  }
}

function togglePreCheck(id) {
  const saved = JSON.parse(localStorage.getItem('tj_pre_checks') || '{}');
  saved[id] = !saved[id];
  localStorage.setItem('tj_pre_checks', JSON.stringify(saved));
  renderPreMarket();
}

function resetChecklist(type) {
  if (type === 'pre') { localStorage.removeItem('tj_pre_checks'); renderPreMarket(); }
}

function savePreMarket() {
  ['watchlist','levels','intention'].forEach(k => {
    const el = document.getElementById(`pre-${k}`);
    if (el) localStorage.setItem(`tj_pre_${k}`, el.value);
  });
  showToast('Pre-market session saved', 'success');
}

let preMood = '', postMood = '';
function selectMood(el, type) {
  const wrap = type === 'pre' ? '#view-premarket' : '#view-postmarket';
  document.querySelectorAll(`${wrap} .mood-btn`).forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  if (type === 'pre') { preMood = el.dataset.mood; localStorage.setItem('tj_pre_mood', preMood); }
  else { postMood = el.dataset.mood; localStorage.setItem('tj_post_mood', postMood); }
}

// ══════════════════════════════════════════════
// POST-MARKET
// ══════════════════════════════════════════════
let selectedGrade = '';
function renderPostMarket() {
  // Build date selector
  const dates = [...new Set(allTrades.map(t => t.date))].sort().reverse();
  const today = new Date().toISOString().split('T')[0];
  const sel = document.getElementById('post-date-select');
  if (sel) {
    sel.innerHTML = `<option value="${today}">${today} (Today)</option>` +
      dates.filter(d => d !== today).map(d => `<option value="${d}">${d}</option>`).join('');
    sel.onchange = () => updatePostStats(sel.value);
    updatePostStats(sel.value || today);
  }
  // Restore saved
  ['good','improve','lessons'].forEach(k => {
    const el = document.getElementById(`post-${k}`);
    if (el) el.value = localStorage.getItem(`tj_post_${k}`) || '';
  });
  renderAdherence();
}

function updatePostStats(date) {
  const dayTrades = allTrades.filter(t => t.date === date);
  const pnl = dayTrades.reduce((a,t) => a + calcPnL(t), 0);
  const wins = dayTrades.filter(t => calcPnL(t) > 0).length;
  const el = document.getElementById('postSessionStats');
  if (!el) return;
  el.innerHTML = [
    ['Trades', dayTrades.length],
    ['P&L', fmt$(pnl)],
    ['Win Rate', dayTrades.length ? (wins/dayTrades.length*100).toFixed(0)+'%' : '—'],
    ['Best Trade', dayTrades.length ? fmt$(Math.max(...dayTrades.map(calcPnL))) : '—'],
  ].map(([l,v]) => `<div style="background:var(--bg3);border-radius:8px;padding:14px;text-align:center">
    <div style="font-size:11px;color:var(--text3);margin-bottom:4px">${l}</div>
    <div style="font-family:var(--font-mono);font-size:18px">${v}</div>
  </div>`).join('');
}

function savePostMarket() {
  ['good','improve','lessons'].forEach(k => {
    const el = document.getElementById(`post-${k}`);
    if (el) localStorage.setItem(`tj_post_${k}`, el.value);
  });
  localStorage.setItem('tj_post_grade', selectedGrade);
  showToast('Post-market review saved', 'success');
}

function selectGrade(g) {
  selectedGrade = g;
  document.querySelectorAll('#gradeButtons .grade-btn').forEach(b => {
    const isSelected = b.textContent.trim() === g;
    b.style.background = isSelected ? 'var(--accent)' : '';
    b.style.color = isSelected ? 'white' : '';
  });
}

function renderAdherence() {
  const saved = JSON.parse(localStorage.getItem('tj_rules') || '{}');
  const checked = TRADING_RULES.filter(r => saved[r.key]).length;
  const pct = Math.round(checked / TRADING_RULES.length * 100);
  const ring = document.getElementById('adherenceRing');
  if (ring) {
    const circ = 326.7;
    ring.style.strokeDashoffset = circ - (circ * pct / 100);
    ring.style.stroke = pct >= 80 ? 'var(--green)' : pct >= 50 ? 'var(--yellow)' : 'var(--red)';
  }
  const scoreEl = document.getElementById('adherenceScore');
  if (scoreEl) scoreEl.textContent = pct + '%';
  const listEl = document.getElementById('adherenceList');
  if (listEl) listEl.innerHTML = TRADING_RULES.slice(0,4).map(r => `
    <div style="display:flex;align-items:center;gap:8px;font-size:12px;padding:6px 0;border-bottom:1px solid var(--border)">
      <span style="color:${saved[r.key] ? 'var(--green)' : 'var(--red)'}">${saved[r.key] ? '✓' : '✗'}</span>
      <span style="color:var(--text3)">${r.text.slice(0,32)}...</span>
    </div>`).join('');
}

// ══════════════════════════════════════════════
// MARKET OVERVIEW
// ══════════════════════════════════════════════
const TF_DATA = {
  decade: {
    label:'10-Year Macro View (2016–2026) · Prices as of Jun 2024',
    assets:[
      { name:'S&P 500', price:'5,430', chg:'+247%', pos:true, fill:247 },
      { name:'Gold', price:'2,310', chg:'+138%', pos:true, fill:138 },
      { name:'BTC', price:'67,420', chg:'+12,000%', pos:true, fill:100 },
      { name:'NIFTY 50', price:'23,200', chg:'+218%', pos:true, fill:100 },
      { name:'EUR/USD', price:'1.0842', chg:'-8%', pos:false, fill:8 },
      { name:'Crude Oil', price:'74.80', chg:'+22%', pos:true, fill:22 },
      { name:'US10Y Yield', price:'4.35%', chg:'+180bps', pos:false, fill:60 },
      { name:'DXY', price:'104.20', chg:'+22%', pos:true, fill:22 },
    ],
    scenarios:[
      { type:'bull', title:'Secular Bull', prob:'40%', desc:'Tech innovation, AI productivity boom drives multi-decade expansion', col:'var(--green)' },
      { type:'base', title:'Base Case', prob:'45%', desc:'Moderate growth, sticky inflation, geopolitical tension but stable', col:'var(--accent)' },
      { type:'bear', title:'Structural Bear', prob:'15%', desc:'Debt crisis, stagflation, or geopolitical shock reshapes global order', col:'var(--red)' },
    ],
    cycle:'Expansion', cyclePos:0.35,
    phases:[
      { col:'var(--green)', dot:'🟢', text:'We are in mid-cycle expansion — characterized by solid corporate earnings, moderating inflation, and high employment.' },
      { col:'var(--cyan)', dot:'🔵', text:'AI & automation are structural tailwinds driving multi-year productivity gains across sectors.' },
      { col:'var(--yellow)', dot:'🟡', text:'Key risks: US debt ceiling, China slowdown, energy transition costs, geopolitical fragmentation.' },
    ]
  },
  fiveyear: {
    label:'5-Year View (2021–2026) · Prices as of Jun 2024',
    assets:[
      { name:'S&P 500', price:'5,430', chg:'+92%', pos:true, fill:92 },
      { name:'NASDAQ', price:'17,800', chg:'+118%', pos:true, fill:100 },
      { name:'Gold', price:'2,310', chg:'+68%', pos:true, fill:68 },
      { name:'BTC', price:'67,420', chg:'+1,800%', pos:true, fill:100 },
      { name:'NIFTY 50', price:'23,200', chg:'+165%', pos:true, fill:100 },
      { name:'US10Y Yield', price:'4.35%', chg:'+325bps', pos:false, fill:80 },
      { name:'USD/INR', price:'84.20', chg:'+18%', pos:false, fill:18 },
      { name:'Crude Oil', price:'74.80', chg:'+82%', pos:true, fill:82 },
    ],
    scenarios:[
      { type:'bull', title:'Soft Landing', prob:'45%', desc:'Fed cuts rates, inflation normalizes, equities grind higher into 2026', col:'var(--green)' },
      { type:'base', title:'Muddle Through', prob:'40%', desc:'Slow growth, elevated rates for longer, market rangebound with volatility', col:'var(--accent)' },
      { type:'bear', title:'Hard Landing', prob:'15%', desc:'Recession triggers credit stress, equity correction 20–35%', col:'var(--red)' },
    ],
    cycle:'Late Expansion', cyclePos:0.55,
    phases:[
      { col:'var(--yellow)', dot:'🟡', text:'Post-COVID recovery cycle maturing — valuations stretched in mega-caps, rotation to value likely.' },
      { col:'var(--green)', dot:'🟢', text:'Emerging markets and commodities showing relative strength as dollar peaks.' },
    ]
  },
  thisyear: {
    label:'2026 Outlook',
    assets:[
      { name:'S&P 500', price:'5,430', chg:'+8.2%', pos:true, fill:82 },
      { name:'Gold', price:'2,310', chg:'+14%', pos:true, fill:100 },
      { name:'BTC', price:'67,420', chg:'+42%', pos:true, fill:100 },
      { name:'NIFTY 50', price:'23,200', chg:'+4.1%', pos:true, fill:41 },
      { name:'EUR/USD', price:'1.0842', chg:'-1.8%', pos:false, fill:18 },
      { name:'Crude Oil', price:'74.80', chg:'-6.4%', pos:false, fill:64 },
      { name:'Silver', price:'27.50', chg:'+18%', pos:true, fill:100 },
      { name:'BANKNIFTY', price:'49,800', chg:'+2.8%', pos:true, fill:28 },
    ],
    scenarios:[
      { type:'bull', title:'Bull Case', prob:'35%', desc:'Fed rate cuts, AI earnings beat, Nifty 27,000+ by year-end', col:'var(--green)' },
      { type:'base', title:'Base Case', prob:'50%', desc:'S&P 5,600–5,800. Nifty 24,000–25,000. Moderate growth', col:'var(--accent)' },
      { type:'bear', title:'Bear Case', prob:'15%', desc:'Geopolitical shock or credit event triggers 15–20% correction', col:'var(--red)' },
    ],
    cycle:'Mid-Cycle', cyclePos:0.42,
    phases:[
      { col:'var(--green)', dot:'🟢', text:'Q4 2025: Strong AI infrastructure buildout, tech earnings surge.' },
      { col:'var(--yellow)', dot:'🟡', text:'Q1 2026: Fed on hold, sticky services CPI delaying rate cuts.' },
      { col:'var(--cyan)', dot:'🔵', text:'H1 2026: Rate-cut uncertainty and earnings season as key catalysts.' },
    ]
  },
  nextyear: {
    label:'2027 Forecast',
    assets:[
      { name:'S&P 500 Target', price:'6,200', chg:'+14%', pos:true, fill:100 },
      { name:'Gold Target', price:'2,800', chg:'+21%', pos:true, fill:100 },
      { name:'BTC Target', price:'120,000', chg:'+78%', pos:true, fill:100 },
      { name:'NIFTY Target', price:'28,000', chg:'+21%', pos:true, fill:100 },
      { name:'EUR/USD', price:'1.12', chg:'+3%', pos:true, fill:30 },
      { name:'Crude Oil', price:'68.00', chg:'-9%', pos:false, fill:90 },
      { name:'US10Y', price:'3.80%', chg:'-55bps', pos:true, fill:55 },
      { name:'DXY', price:'98.00', chg:'-6%', pos:false, fill:60 },
    ],
    scenarios:[
      { type:'bull', title:'Melt-Up', prob:'30%', desc:'Rate cut cycle accelerates, global liquidity surge, crypto & tech surge', col:'var(--green)' },
      { type:'base', title:'Goldilocks', prob:'50%', desc:'Gradual easing, stable growth, diversified markets outperform', col:'var(--accent)' },
      { type:'bear', title:'Recession', prob:'20%', desc:'Lagged impact of high rates hits credit, earnings fall 15–20%', col:'var(--red)' },
    ],
    cycle:'Early Recovery', cyclePos:0.2,
    phases:[
      { col:'var(--cyan)', dot:'🔵', text:'2026 likely marks beginning of new rate-cut cycle recovery phase.' },
      { col:'var(--green)', dot:'🟢', text:'Emerging markets and small-caps historically outperform in early recovery.' },
    ]
  },
  quarter: {
    label:'Q1 2026 Outlook',
    assets:[
      { name:'S&P 500', price:'5,430', chg:'+2.1%', pos:true, fill:21 },
      { name:'NIFTY 50', price:'23,200', chg:'+1.4%', pos:true, fill:14 },
      { name:'Gold', price:'2,310', chg:'+4.2%', pos:true, fill:42 },
      { name:'BTC/USDT', price:'67,420', chg:'+18%', pos:true, fill:100 },
      { name:'EUR/USD', price:'1.0842', chg:'+0.4%', pos:true, fill:4 },
      { name:'Crude Oil', price:'74.80', chg:'-2.1%', pos:false, fill:21 },
      { name:'US10Y', price:'4.35%', chg:'-12bps', pos:true, fill:12 },
      { name:'VIX', price:'14.2', chg:'-18%', pos:true, fill:100 },
    ],
    scenarios:[
      { type:'bull', title:'Bullish', prob:'40%', desc:'CPI cools, Fed signals June cut, breakout above 5,500 on S&P', col:'var(--green)' },
      { type:'base', title:'Neutral', prob:'45%', desc:'Rangebound. Earnings season mixed. S&P 5,200–5,500 zone.', col:'var(--accent)' },
      { type:'bear', title:'Correction', prob:'15%', desc:'Hot CPI delays cuts, yields spike, equities pull back 8–12%', col:'var(--red)' },
    ],
    cycle:'Expansion', cyclePos:0.38,
    phases:[{ col:'var(--green)', dot:'🟢', text:'Q2 key events: Fed meetings, CPI releases, corporate earnings season. Watch tech sector for leadership confirmation.' }]
  },
  month: {
    label:'February 2026 Forecast',
    assets:[
      { name:'S&P 500', price:'5,430', chg:'+0.8%', pos:true, fill:8 },
      { name:'NIFTY 50', price:'23,200', chg:'+0.3%', pos:true, fill:3 },
      { name:'Gold', price:'2,310', chg:'+1.4%', pos:true, fill:14 },
      { name:'BTC/USDT', price:'67,420', chg:'+5.2%', pos:true, fill:52 },
      { name:'USD/INR', price:'84.20', chg:'-0.2%', pos:true, fill:2 },
      { name:'Crude Oil', price:'74.80', chg:'-1.1%', pos:false, fill:11 },
      { name:'Silver', price:'27.50', chg:'+2.3%', pos:true, fill:23 },
      { name:'BANKNIFTY', price:'49,800', chg:'+0.6%', pos:true, fill:6 },
    ],
    scenarios:[
      { type:'bull', title:'Bullish', prob:'40%', desc:'Nifty sustains above 23,000, S&P pushes toward 5,600', col:'var(--green)' },
      { type:'base', title:'Choppy', prob:'45%', desc:'Consolidation month. Sector rotation. Watch Fed commentary.', col:'var(--accent)' },
      { type:'bear', title:'Pullback', prob:'15%', desc:'Profit-taking after January rally. Down 3–5% possible.', col:'var(--red)' },
    ],
    cycle:'Expansion', cyclePos:0.38,
    phases:[{ col:'var(--cyan)', dot:'🔵', text:'February typically sees profit-booking after January effect. Key economic releases: CPI (Feb 12), FOMC minutes, earnings from major tech companies.' }]
  },
  week: {
    label:'This Week (Feb 17–21, 2026)',
    assets:[
      { name:'S&P 500', price:'5,430', chg:'+0.3%', pos:true, fill:3 },
      { name:'NIFTY 50', price:'23,200', chg:'-0.2%', pos:false, fill:2 },
      { name:'Gold', price:'2,310', chg:'+0.4%', pos:true, fill:4 },
      { name:'BTC/USDT', price:'67,420', chg:'+1.8%', pos:true, fill:18 },
      { name:'EUR/USD', price:'1.0842', chg:'+0.1%', pos:true, fill:1 },
      { name:'Crude Oil', price:'74.80', chg:'-0.5%', pos:false, fill:5 },
      { name:'VIX', price:'14.2', chg:'-3%', pos:true, fill:30 },
      { name:'DXY', price:'104.20', chg:'-0.3%', pos:true, fill:3 },
    ],
    scenarios:[
      { type:'bull', title:'Bullish', prob:'38%', desc:'S&P holds 5,400, tech earnings beats drive momentum', col:'var(--green)' },
      { type:'base', title:'Flat', prob:'47%', desc:'Low conviction week. FOMC minutes Wednesday key event.', col:'var(--accent)' },
      { type:'bear', title:'Pullback', prob:'15%', desc:'Any surprise in FOMC minutes or CPI revision could trigger risk-off', col:'var(--red)' },
    ],
    cycle:'Expansion', cyclePos:0.38,
    phases:[{ col:'var(--yellow)', dot:'🟡', text:'Key events this week: FOMC Meeting Minutes (Wed), Jobless Claims (Thu), PMI Flash (Fri). Watch USD reaction post-minutes.' }]
  },
  threeyear: {
    label:'3-Year View (2023–2026)',
    assets:[
      { name:'S&P 500', price:'5,430', chg:'+38%', pos:true, fill:38 },
      { name:'Gold', price:'2,310', chg:'+52%', pos:true, fill:52 },
      { name:'BTC', price:'67,420', chg:'+180%', pos:true, fill:100 },
      { name:'NIFTY 50', price:'23,200', chg:'+72%', pos:true, fill:72 },
      { name:'US10Y Yield', price:'4.35%', chg:'+200bps', pos:false, fill:80 },
      { name:'BANKNIFTY', price:'49,800', chg:'+68%', pos:true, fill:68 },
      { name:'Silver', price:'27.50', chg:'+35%', pos:true, fill:35 },
      { name:'Crude Oil', price:'74.80', chg:'-12%', pos:false, fill:12 },
    ],
    scenarios:[
      { type:'bull', title:'Continued Rally', prob:'42%', desc:'AI super-cycle, India growth story, rate cuts fuel equity surge', col:'var(--green)' },
      { type:'base', title:'Sideways', prob:'40%', desc:'Elevated valuations cap upside, selective opportunities in value & EM', col:'var(--accent)' },
      { type:'bear', title:'Mean Reversion', prob:'18%', desc:'Valuation compression, earnings disappointments, credit tightening', col:'var(--red)' },
    ],
    cycle:'Late Expansion', cyclePos:0.58,
    phases:[
      { col:'var(--yellow)', dot:'🟡', text:'3-year cycle: recovered from 2022 bear market. Valuations stretched in US tech, but India and commodities have more runway.' },
      { col:'var(--green)', dot:'🟢', text:'India macro story: demographics, manufacturing shift, digital economy powering structural bull market in NIFTY.' },
    ]
  },
  decadePrediction: {
    label:'Decade Predictions 2025–2035',
    assets:[
      { name:'S&P 500 (2035)', price:'12,000', chg:'+121%', pos:true, fill:100 },
      { name:'Gold (2035)', price:'$5,500', chg:'+138%', pos:true, fill:100 },
      { name:'Bitcoin (2035)', price:'$1M+', chg:'+1,400%', pos:true, fill:100 },
      { name:'NIFTY (2035)', price:'75,000', chg:'+223%', pos:true, fill:100 },
      { name:'Crude Oil (2035)', price:'$40', chg:'-46%', pos:false, fill:46 },
      { name:'US10Y (2035)', price:'3.50%', chg:'-85bps', pos:true, fill:55 },
      { name:'DXY (2035)', price:'88.00', chg:'-16%', pos:false, fill:40 },
      { name:'AI Sector ETF', price:'Est. +800%', chg:'+800%', pos:true, fill:100 },
    ],
    scenarios:[
      { type:'bull', title:'AGI Boom', prob:'30%', desc:'Artificial General Intelligence triggers unprecedented productivity surge. S&P 15,000+, Bitcoin $2M+, India $10T GDP.', col:'var(--green)' },
      { type:'base', title:'Transition Decade', prob:'50%', desc:'AI transforms economy gradually. Winners: Tech, India, Commodities. Losers: Legacy finance, fossil fuels.', col:'var(--accent)' },
      { type:'bear', title:'Fragmentation', prob:'20%', desc:'Geopolitical fragmentation, debt crises, or AI disruption causes severe economic dislocation.', col:'var(--red)' },
    ],
    cycle:'New Paradigm', cyclePos:0.15,
    phases:[
      { col:'var(--accent2)', dot:'🟣', text:'2025–2027: AI Deployment Phase — productivity gains begin, tech sector leads, rate cycle reverses.' },
      { col:'var(--green)', dot:'🟢', text:'2027–2030: Global Rebalancing — India/EM ascend, USD loses dominance, gold/BTC as reserve assets.' },
      { col:'var(--cyan)', dot:'🔵', text:'2030–2035: Post-AGI Era — automation reshapes labor markets, new sectors emerge (biotech, space, quantum).' },
    ]
  },
};

let currentTF = 'decade';

function switchTF(btn) {
  document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentTF = btn.dataset.tf;
  const decPanel = document.getElementById('decadePredPanel');
  if (currentTF === 'decadePrediction') {
    if (decPanel) decPanel.style.display = 'block';
    renderOverviewContent();
  } else {
    if (decPanel) decPanel.style.display = 'none';
    renderOverviewContent();
  }
}

function renderOverview() {
  renderOverviewContent();
  renderNews();
  renderCalendar();
  drawFearGreed(62);
}

function renderOverviewContent() {
  const d = TF_DATA[currentTF];
  if (!d) return;

  // Asset cards
  document.getElementById('overviewCards').innerHTML = d.assets.map(a => `
    <div class="outlook-card">
      <div class="outlook-asset">${a.name}</div>
      <div class="outlook-price">${a.price}</div>
      <div class="outlook-chg ${a.pos ? 'pos' : 'neg'}">${a.chg}</div>
      <div class="outlook-bar"><div class="outlook-bar-fill" style="width:${Math.min(a.fill,100)}%;background:${a.pos ? 'var(--green)' : 'var(--red)'}"></div></div>
    </div>`).join('');

  // Scenario cards
  document.getElementById('scenarioLabel').textContent = d.label;
  document.getElementById('scenarioCards').innerHTML = d.scenarios.map(s => `
    <div class="scenario-card scenario-${s.type}">
      <div class="scenario-title" style="color:${s.col}">${s.title}</div>
      <div class="scenario-prob" style="color:${s.col}">${s.prob}</div>
      <div class="scenario-desc">${s.desc}</div>
    </div>`).join('');

  // Phases
  document.getElementById('phasesBlock').innerHTML = d.phases.map(p => `
    <div class="phase-indicator">
      <div class="phase-dot" style="background:${p.col}"></div>
      <div style="font-size:13px;color:var(--text2);line-height:1.5">${p.text}</div>
    </div>`).join('');

  // Market cycle canvas
  drawCycleChart(d.cyclePos, d.cycle);

  // Sector chart
  drawSectorChart();
}

function drawCycleChart(pos, label) {
  const canvas = document.getElementById('cycleChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0, 0, W, H);
  const cx = W/2, cy = H/2, r = 110;

  // Draw cycle ring
  const phases = [
    { label:'Recovery', col:'#22d3ee', start:-Math.PI, end:-Math.PI/2 },
    { label:'Expansion', col:'#4ade80', start:-Math.PI/2, end:0 },
    { label:'Peak', col:'#fbbf24', start:0, end:Math.PI/2 },
    { label:'Contraction', col:'#f87171', start:Math.PI/2, end:Math.PI },
  ];

  phases.forEach(p => {
    ctx.beginPath();
    ctx.arc(cx, cy, r, p.start, p.end);
    ctx.arc(cx, cy, r-28, p.end, p.start, true);
    ctx.closePath();
    ctx.fillStyle = p.col + '30';
    ctx.fill();
    ctx.strokeStyle = p.col + '80';
    ctx.lineWidth = 1;
    ctx.stroke();

    const midAngle = (p.start + p.end) / 2;
    const tx = cx + (r-14) * Math.cos(midAngle);
    const ty = cy + (r-14) * Math.sin(midAngle);
    ctx.fillStyle = p.col;
    ctx.font = '10px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(p.label, tx, ty);
  });

  // Current position dot
  const angle = pos * Math.PI * 2 - Math.PI/2;
  const dotR = r - 14;
  const dx = cx + dotR * Math.cos(angle);
  const dy = cy + dotR * Math.sin(angle);
  ctx.beginPath(); ctx.arc(dx, dy, 8, 0, Math.PI*2);
  ctx.fillStyle = '#fff'; ctx.fill();
  ctx.beginPath(); ctx.arc(dx, dy, 12, 0, Math.PI*2);
  ctx.strokeStyle = 'rgba(255,255,255,0.4)'; ctx.lineWidth=2; ctx.stroke();

  ctx.fillStyle = 'var(--text)';
  ctx.font = '500 13px Inter';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(label, cx, cy-6);
  ctx.font = '10px Inter';
  ctx.fillStyle = 'rgba(255,255,255,0.4)';
  ctx.fillText('Current Phase', cx, cy+10);
}

function drawSectorChart() {
  const canvas = document.getElementById('sectorChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.parentElement.clientWidth - 40;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const sectors = [
    { name:'Technology', val:28.4, col:'#7c6dfa' },
    { name:'Financials', val:14.2, col:'#22d3ee' },
    { name:'Healthcare', val:9.8, col:'#4ade80' },
    { name:'Energy', val:-3.2, col:'#f87171' },
    { name:'Industrials', val:11.4, col:'#fbbf24' },
    { name:'Materials', val:7.6, col:'#fb923c' },
    { name:'Real Estate', val:-1.8, col:'#f87171' },
    { name:'Utilities', val:5.2, col:'#a89cff' },
    { name:'Cons. Disc', val:18.6, col:'#4ade80' },
    { name:'Cons. Staples', val:4.1, col:'#86efac' },
    { name:'Comm. Svcs', val:22.8, col:'#7c6dfa' },
  ];
  const maxAbs = Math.max(...sectors.map(s => Math.abs(s.val)));
  const H = canvas.height, W = canvas.width;
  const pad = { t:10, b:28, l:10, r:10 };
  const barW = (W - pad.l - pad.r) / sectors.length * 0.7;
  const barGap = (W - pad.l - pad.r) / sectors.length;
  const midY = pad.t + (H - pad.t - pad.b) / 2;

  // Zero line
  ctx.strokeStyle = 'rgba(255,255,255,0.1)';
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(pad.l, midY); ctx.lineTo(W - pad.r, midY); ctx.stroke();

  sectors.forEach((s, i) => {
    const x = pad.l + i * barGap + barGap * 0.15;
    const barH = (Math.abs(s.val) / maxAbs) * (H - pad.t - pad.b) / 2;
    const y = s.val >= 0 ? midY - barH : midY;
    ctx.fillStyle = s.col;
    ctx.globalAlpha = 0.8;
    ctx.beginPath();
    if (ctx.roundRect) {
      if (s.val >= 0) ctx.roundRect(x, y, barW, barH, [4, 4, 0, 0]);
      else ctx.roundRect(x, midY, barW, barH, [0, 0, 4, 4]);
    } else {
      // Fallback for Safari < 15.4
      const r = 3;
      if (s.val >= 0) {
        ctx.moveTo(x+r,y); ctx.lineTo(x+barW-r,y); ctx.quadraticCurveTo(x+barW,y,x+barW,y+r);
        ctx.lineTo(x+barW,y+barH); ctx.lineTo(x,y+barH); ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y);
      } else {
        ctx.moveTo(x,midY); ctx.lineTo(x+barW,midY); ctx.lineTo(x+barW,midY+barH-r);
        ctx.quadraticCurveTo(x+barW,midY+barH,x+barW-r,midY+barH);
        ctx.lineTo(x+r,midY+barH); ctx.quadraticCurveTo(x,midY+barH,x,midY+barH-r); ctx.lineTo(x,midY);
      }
      ctx.closePath();
    }
    ctx.fill();
    ctx.globalAlpha = 1;

    ctx.fillStyle = 'rgba(255,255,255,0.4)';
    ctx.font = '9px JetBrains Mono';
    ctx.textAlign = 'center';
    ctx.fillText(s.name.slice(0,5), x + barW/2, H - 6);
    ctx.fillStyle = s.val >= 0 ? '#4ade80' : '#f87171';
    ctx.font = '9px JetBrains Mono';
    const valY = s.val >= 0 ? y - 3 : y + barH + 9;
    ctx.fillText((s.val > 0 ? '+' : '') + s.val + '%', x + barW/2, valY);
  });
}

// ══════════════════════════════════════════════
// NEWS & ECONOMIC CALENDAR
// ══════════════════════════════════════════════
const NEWS_DATA = [
  { headline:'Fed holds rates at 4.25–4.50%, signals patience on sticky services inflation', tag:'MACRO', tagCol:'rgba(124,109,250,0.15)', tagTxt:'var(--accent2)', time:'2h ago', source:'Reuters', sentiment:'~', sentCol:'var(--yellow)', cat:'Macro' },
  { headline:'NVIDIA GB200 shipments accelerate — Wall Street raises PT to $1,000', tag:'EQUITIES', tagCol:'rgba(34,211,238,0.15)', tagTxt:'var(--cyan)', time:'4h ago', source:'Bloomberg', sentiment:'+', sentCol:'var(--green)', cat:'Equities' },
  { headline:'RBI cuts repo rate 25bps to 6.25% — first cut since 2020', tag:'INDIA', tagCol:'rgba(251,191,36,0.15)', tagTxt:'var(--yellow)', time:'5h ago', source:'Mint', sentiment:'+', sentCol:'var(--green)', cat:'India' },
  { headline:'Bitcoin holds near $95K after briefly crossing $100K on ETF inflows', tag:'CRYPTO', tagCol:'rgba(74,222,128,0.15)', tagTxt:'var(--green)', time:'6h ago', source:'CoinDesk', sentiment:'+', sentCol:'var(--green)', cat:'Crypto' },
  { headline:'EUR/USD slides to 1.02 as ECB signals another March cut amid weak PMIs', tag:'FOREX', tagCol:'rgba(251,146,60,0.15)', tagTxt:'var(--orange)', time:'7h ago', source:'FX Street', sentiment:'-', sentCol:'var(--red)', cat:'Forex' },
  { headline:'Reliance Jio 5G base crosses 200M, ARPU up 12% YoY — stock at 52W high', tag:'INDIA', tagCol:'rgba(251,191,36,0.15)', tagTxt:'var(--yellow)', time:'8h ago', source:'ET Markets', sentiment:'+', sentCol:'var(--green)', cat:'India' },
  { headline:'US CPI Jan 2026: headline 2.9%, core 3.2% — both above consensus', tag:'MACRO', tagCol:'rgba(124,109,250,0.15)', tagTxt:'var(--accent2)', time:'10h ago', source:'WSJ', sentiment:'-', sentCol:'var(--red)', cat:'Macro' },
  { headline:'Gold holds above $2,900 — central bank demand and dollar hedging sustain rally', tag:'COMMODITY', tagCol:'rgba(248,113,113,0.15)', tagTxt:'var(--red)', time:'12h ago', source:'Kitco', sentiment:'+', sentCol:'var(--green)', cat:'Equities' },
  { headline:'Ethereum Pectra upgrade confirmed for March 2026 — gas fee improvements coming', tag:'CRYPTO', tagCol:'rgba(74,222,128,0.15)', tagTxt:'var(--green)', time:'1d ago', source:'The Block', sentiment:'+', sentCol:'var(--green)', cat:'Crypto' },
  { headline:'Apple Q1 FY26: Services hits $30B, iPhone 16 above estimates, stock near ATH', tag:'EQUITIES', tagCol:'rgba(34,211,238,0.15)', tagTxt:'var(--cyan)', time:'1d ago', source:'9to5Mac', sentiment:'+', sentCol:'var(--green)', cat:'Equities' },
  { headline:'OPEC+ extends output cuts through Q3 2026, Brent firms near $78', tag:'COMMODITY', tagCol:'rgba(248,113,113,0.15)', tagTxt:'var(--red)', time:'1d ago', source:'OilPrice', sentiment:'~', sentCol:'var(--yellow)', cat:'Macro' },
  { headline:'USD/JPY tests 154 as BOJ signals no rush for further hikes after Dec 2025 move', tag:'FOREX', tagCol:'rgba(251,146,60,0.15)', tagTxt:'var(--orange)', time:'2d ago', source:'Reuters', sentiment:'-', sentCol:'var(--red)', cat:'Forex' },
];

// ── DYNAMIC CALENDAR FALLBACK — always current week ──
function generateFallbackCalendar() {
  const now  = new Date();
  const dow  = now.getDay(); // 0=Sun
  const mon  = new Date(now); mon.setDate(now.getDate() - (dow === 0 ? 6 : dow - 1));
  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const fmt = d => `${dayNames[d.getDay()]} ${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
  const d = i => { const x = new Date(mon); x.setDate(mon.getDate()+i); return x; };
  const monthYear = now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  return [
    { time:`${fmt(d(0))} 08:30`, country:'🇮🇳', name:'India WPI Inflation',            sub:`${monthYear}`, impact:'med',  actual:'Pending', forecast:'3.2%', prev:'2.8%', result:'' },
    { time:`${fmt(d(1))} 08:30`, country:'🇺🇸', name:'US Producer Price Index (PPI)',  sub:`MoM ${monthYear}`, impact:'high', actual:'Pending', forecast:'0.3%', prev:'0.2%', result:'' },
    { time:`${fmt(d(1))} 19:00`, country:'🇺🇸', name:'FOMC Meeting Minutes',           sub:monthYear, impact:'high', actual:'Pending', forecast:'Hawkish hold', prev:'—', result:'' },
    { time:`${fmt(d(2))} 09:30`, country:'🇬🇧', name:'UK CPI YoY',                    sub:monthYear, impact:'high', actual:'Pending', forecast:'2.8%', prev:'2.5%', result:'' },
    { time:`${fmt(d(2))} 14:30`, country:'🇪🇺', name:'ECB Meeting Accounts',           sub:monthYear, impact:'med',  actual:'Pending', forecast:'—',   prev:'—', result:'' },
    { time:`${fmt(d(3))} 08:30`, country:'🇺🇸', name:'US Initial Jobless Claims',      sub:'Weekly',  impact:'med',  actual:'Pending', forecast:'218K', prev:'214K', result:'' },
    { time:`${fmt(d(3))} 10:00`, country:'🇮🇳', name:'India Balance of Trade',         sub:monthYear, impact:'med',  actual:'Pending', forecast:'-$23B', prev:'-$21.9B', result:'' },
    { time:`${fmt(d(4))} 08:30`, country:'🇺🇸', name:'S&P Global US Manufacturing PMI',sub:`${monthYear} Flash`, impact:'high', actual:'Pending', forecast:'51.2', prev:'51.2', result:'' },
    { time:`${fmt(d(4))} 09:45`, country:'🇺🇸', name:'US Services PMI',                sub:`${monthYear} Flash`, impact:'high', actual:'Pending', forecast:'53.0', prev:'52.9', result:'' },
  ];
}
const CALENDAR_DATA = generateFallbackCalendar();


let newsFilter = 'All';
function filterNews(cat, el) {
  newsFilter = cat;
  document.querySelectorAll('#newsFilters .screener-tag').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderNewsFeed();
}

function refreshNews() { showToast('News refreshed (live feed requires API key)', 'info'); renderNewsFeed(); }

// ── EXTENDED NEWS DATA (current as of Feb 2026) ──
const NEWS_DATA_EXTENDED = [
  { headline:'Fed holds rates at 4.25–4.50%, signals patience amid sticky services inflation', tag:'MACRO', tagCol:'rgba(124,109,250,0.15)', tagTxt:'var(--accent2)', time:'3h ago', source:'Reuters', sentiment:'-', sentCol:'var(--yellow)', cat:'Macro', summary:'The Federal Reserve kept rates unchanged at its January 2026 meeting. Chair Powell flagged persistent services CPI above 3% as the key obstacle to further cuts. Markets now price just one cut in 2026.' },
  { headline:'NVIDIA Blackwell GB200 shipments accelerate — analysts raise PT to $1,000', tag:'EQUITIES', tagCol:'rgba(34,211,238,0.15)', tagTxt:'var(--cyan)', time:'5h ago', source:'Bloomberg', sentiment:'+', sentCol:'var(--green)', cat:'Equities', summary:'Multiple Wall Street firms raised NVDA price targets after supply chain checks confirmed strong GB200 rack shipments in Q1 2026. Data center revenues projected to exceed $45B this quarter.' },
  { headline:'RBI cuts repo rate by 25bps to 6.25% — first cut since 2020', tag:'INDIA', tagCol:'rgba(251,191,36,0.15)', tagTxt:'var(--yellow)', time:'6h ago', source:'ET Markets', sentiment:'+', sentCol:'var(--green)', cat:'India', summary:'RBI MPC voted 5-1 to cut. CPI at 4.3% gave cover for easing. NIFTY surged 1.2% on the news. Governor Sanjay Malhotra flagged more cuts possible if inflation stays below 4.5%.' },
  { headline:'Bitcoin consolidates near $95K after breaking above $100K for first time in months', tag:'CRYPTO', tagCol:'rgba(74,222,128,0.15)', tagTxt:'var(--green)', time:'7h ago', source:'CoinDesk', sentiment:'+', sentCol:'var(--green)', cat:'Crypto', summary:'BTC touched $101,200 on strong ETF inflows before retracing. Total ETF AUM now exceeds $110B. Options market shows $120K call as the next major target for March expiry.' },
  { headline:'EUR/USD slides to 1.02 as ECB signals another 25bps cut in March', tag:'FOREX', tagCol:'rgba(251,146,60,0.15)', tagTxt:'var(--orange)', time:'8h ago', source:'FX Street', sentiment:'-', sentCol:'var(--red)', cat:'Forex', summary:'ECB cut rates to 2.50% last week. Lagarde hinted at further easing in March citing Eurozone PMI stuck at 47. EUR under pressure vs a resilient USD.' },
  { headline:'Reliance Jio 5G subscriber base crosses 200M — ARPU rises 12% YoY', tag:'INDIA', tagCol:'rgba(251,191,36,0.15)', tagTxt:'var(--yellow)', time:'9h ago', source:'Mint', sentiment:'+', sentCol:'var(--green)', cat:'India', summary:'RIL Q3 FY26 results beat on revenue. Jio 5G adds surged faster than expected. Retail EBITDA margin improved 80bps. Stock at 52-week high above ₹1,450.' },
  { headline:'US CPI January 2026: headline 2.9%, core 3.2% — both above expectations', tag:'MACRO', tagCol:'rgba(124,109,250,0.15)', tagTxt:'var(--accent2)', time:'11h ago', source:'WSJ', sentiment:'-', sentCol:'var(--red)', cat:'Macro', summary:'Shelter and services drove the upside miss. Dollar strengthened 0.5% on the release. Rate cut expectations for 2026 fell sharply — futures now show only 25bps total for the year.' },
  { headline:'Gold holds above $2,900 — central bank buying and dollar hedging sustain demand', tag:'COMMODITY', tagCol:'rgba(251,146,60,0.15)', tagTxt:'var(--orange)', time:'13h ago', source:'Kitco', sentiment:'+', sentCol:'var(--green)', cat:'Equities', summary:'XAU/USD at $2,912. PBoC, Poland and Turkey led central bank purchases in January. Geopolitical risk premium remains elevated. Next resistance at $3,000 psychological level.' },
  { headline:'Ethereum Pectra upgrade scheduled for March — gas fee improvements expected', tag:'CRYPTO', tagCol:'rgba(74,222,128,0.15)', tagTxt:'var(--green)', time:'1d ago', source:'The Block', sentiment:'+', sentCol:'var(--green)', cat:'Crypto', summary:'Ethereum dev team confirmed Pectra hard fork targeting March 2026. EIP-7702 account abstraction and blob fee improvements key highlights. ETH up 8% this week in anticipation.' },
  { headline:'Apple Q1 FY26 earnings: Services revenue hits $30B, iPhone 16 sales above estimates', tag:'EQUITIES', tagCol:'rgba(34,211,238,0.15)', tagTxt:'var(--cyan)', time:'1d ago', source:'9to5Mac', sentiment:'+', sentCol:'var(--green)', cat:'Equities', summary:'AAPL beat on EPS ($2.42 vs $2.35 est) and revenue ($130B vs $127B est). Services margin at 75%. India iPhone shipments up 34% YoY. Stock trades near all-time highs.' },
  { headline:'OPEC+ holds output cuts through Q3 2026, Brent crude firms near $78', tag:'COMMODITY', tagCol:'rgba(251,146,60,0.15)', tagTxt:'var(--orange)', time:'1d ago', source:'OilPrice', sentiment:'~', sentCol:'var(--yellow)', cat:'Macro', summary:'Saudi Arabia reaffirmed commitment to 2.2M bpd voluntary cuts. Russia compliance improving. Demand concerns from China still cloud the outlook but supply discipline supports the $75–82 range.' },
  { headline:'USD/JPY tests 154 as BOJ signals no urgency for further rate hikes', tag:'FOREX', tagCol:'rgba(251,146,60,0.15)', tagTxt:'var(--orange)', time:'2d ago', source:'Reuters', sentiment:'-', sentCol:'var(--red)', cat:'Forex', summary:'BOJ hiked to 0.50% in December 2025 but governor Ueda struck a cautious tone about the pace of normalization. Market removed March hike bets, sending USD/JPY back toward 154.' },
  { headline:'Microsoft Copilot revenue run-rate crosses $10B — AI monetization accelerating', tag:'EQUITIES', tagCol:'rgba(34,211,238,0.15)', tagTxt:'var(--cyan)', time:'2d ago', source:'Bloomberg', sentiment:'+', sentCol:'var(--green)', cat:'Equities', summary:'MSFT Q2 FY26 showed Copilot seats growing 3x YoY. Azure AI workloads up 157%. Stock at all-time high above $480. Analysts see $550 as the next target if AI margin expansion continues.' },
  { headline:'FII net buyers of ₹12,400 Cr in Indian equities in February 2026', tag:'INDIA', tagCol:'rgba(251,191,36,0.15)', tagTxt:'var(--yellow)', time:'2d ago', source:'SEBI Data', sentiment:'+', sentCol:'var(--green)', cat:'India', summary:'Foreign flows reversing sharply after RBI rate cut. NIFTY back above 24,000. IT and banking sectors seeing highest inflows. DIIs also continued buying at ₹9,200 Cr net.' },
  { headline:'Solana ecosystem TVL hits $15B — meme coins and DePIN drive activity surge', tag:'CRYPTO', tagCol:'rgba(74,222,128,0.15)', tagTxt:'var(--green)', time:'3d ago', source:'DeFiLlama', sentiment:'+', sentCol:'var(--green)', cat:'Crypto', summary:'SOL DeFi TVL crossed $15B for first time. Decentralized Physical Infrastructure (DePIN) projects gaining traction. SOL up 22% YTD, outperforming ETH and BTC on a 3-month basis.' },
];


// ── EARNINGS: always offset from today ──
function generateFallbackEarnings() {
  const now = new Date();
  const fmt = d => d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  const add = n => { const x = new Date(now); x.setDate(now.getDate()+n); return fmt(x); };
  return [
    { date:add(1),  company:'Walmart (WMT)',       time:'Before Open',  eps:'$1.72',  rev:'$178B',     mktcap:'$620B',    importance:'high' },
    { date:add(2),  company:'Home Depot (HD)',      time:'Before Open',  eps:'$3.12',  rev:'$36.8B',    mktcap:'$335B',    importance:'high' },
    { date:add(3),  company:'NVIDIA (NVDA)',        time:'After Close',  eps:'$5.88',  rev:'$37.2B',    mktcap:'$3.1T',    importance:'high' },
    { date:add(3),  company:'Salesforce (CRM)',     time:'After Close',  eps:'$2.61',  rev:'$10.1B',    mktcap:'$310B',    importance:'high' },
    { date:add(4),  company:'Dell Tech (DELL)',     time:'After Close',  eps:'$2.24',  rev:'$24.1B',    mktcap:'$72B',     importance:'med'  },
    { date:add(5),  company:'Workday (WDAY)',       time:'After Close',  eps:'$1.74',  rev:'$2.21B',    mktcap:'$62B',     importance:'med'  },
    { date:add(7),  company:'Broadcom (AVGO)',      time:'After Close',  eps:'$1.42',  rev:'$14.6B',    mktcap:'$780B',    importance:'high' },
    { date:add(8),  company:'Costco (COST)',        time:'After Close',  eps:'$4.08',  rev:'$63.2B',    mktcap:'$418B',    importance:'high' },
    { date:add(9),  company:'MongoDB (MDB)',        time:'After Close',  eps:'$0.68',  rev:'$528M',     mktcap:'$18B',     importance:'med'  },
    { date:add(10), company:'Oracle (ORCL)',        time:'After Close',  eps:'$1.62',  rev:'$14.4B',    mktcap:'$440B',    importance:'high' },
  ];
}
const EARNINGS_DATA = generateFallbackEarnings();


const MACRO_HEATMAP_DATA = [
  { region:'US Economy', signal:'Neutral', color:'var(--yellow)', icon:'🇺🇸', detail:'GDP +2.5%, CPI 3.1%↑' },
  { region:'India Growth', signal:'Bullish', color:'var(--green)', icon:'🇮🇳', detail:'GDP +7.4%, Capex ↑' },
  { region:'China Recovery', signal:'Bearish', color:'var(--red)', icon:'🇨🇳', detail:'Deflation risk, PMI 49.2' },
  { region:'Eurozone', signal:'Bearish', color:'var(--red)', icon:'🇪🇺', detail:'Near-recession, PMI 47.1' },
  { region:'Japan', signal:'Neutral', color:'var(--yellow)', icon:'🇯🇵', detail:'BOJ exit delayed, ¥ weak' },
  { region:'UK', signal:'Neutral', color:'var(--yellow)', icon:'🇬🇧', detail:'Stagflation risk easing' },
  { region:'Brazil', signal:'Bullish', color:'var(--green)', icon:'🇧🇷', detail:'Commodities boom' },
  { region:'Global Trade', signal:'Neutral', color:'var(--yellow)', icon:'🌐', detail:'Shipping costs elevated' },
  { region:'AI / Tech', signal:'Bullish', color:'var(--green)', icon:'🤖', detail:'Capex supercycle' },
  { region:'Energy', signal:'Neutral', color:'var(--yellow)', icon:'⛽', detail:'OPEC+ holds cuts' },
  { region:'Crypto Market', signal:'Bullish', color:'var(--green)', icon:'₿', detail:'BTC near ATH, ETFs' },
  { region:'Gold / PMs', signal:'Bullish', color:'var(--green)', icon:'🥇', detail:'ATH $2,400+ trend' },
];

const TICKER_DATA = [
  { sym:'S&P 500', price:'5,430', chg:'+0.32%', up:true },
  { sym:'NASDAQ', price:'17,464', chg:'+0.51%', up:true },
  { sym:'NIFTY 50', price:'23,204', chg:'-0.18%', up:false },
  { sym:'SENSEX', price:'76,520', chg:'-0.14%', up:false },
  { sym:'GOLD', price:'$2,398', chg:'+0.43%', up:true },
  { sym:'BTC', price:'$67,240', chg:'+1.82%', up:true },
  { sym:'ETH', price:'$3,812', chg:'+0.94%', up:true },
  { sym:'CRUDE OIL', price:'$74.68', chg:'-0.51%', up:false },
  { sym:'EUR/USD', price:'1.0842', chg:'+0.08%', up:true },
  { sym:'USD/INR', price:'83.94', chg:'-0.12%', up:false },
  { sym:'DXY', price:'104.12', chg:'-0.09%', up:false },
  { sym:'VIX', price:'14.2', chg:'-2.74%', up:false },
  { sym:'US 10Y', price:'4.35%', chg:'+2bps', up:false },
  { sym:'SILVER', price:'$27.48', chg:'+0.61%', up:true },
  { sym:'BANKNIFTY', price:'49,812', chg:'-0.22%', up:false },
  { sym:'MSFT', price:'$424.60', chg:'+1.12%', up:true },
  { sym:'NVDA', price:'$788.20', chg:'+3.44%', up:true },
  { sym:'RELIANCE', price:'₹2,934', chg:'+0.68%', up:true },
];

let newsTabFilter = 'All';
function filterNewsTab(cat, el) {
  newsTabFilter = cat;
  document.querySelectorAll('#newsTabFilters .screener-tag').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderNewsTabFeed();
}

function renderNewsTabFeed() {
  const el = document.getElementById('newsTabFeed');
  if (!el) return;
  const filtered = newsTabFilter === 'All' ? NEWS_DATA_EXTENDED : NEWS_DATA_EXTENDED.filter(n => n.cat === newsTabFilter);
  el.innerHTML = filtered.map(n => `
    <div class="news-feed-item">
      <div class="news-dot" style="background:${n.tagTxt}"></div>
      <div class="news-content">
        <div class="news-headline">${n.headline}</div>
        <div style="font-size:11px;color:var(--text3);margin:4px 0 5px;line-height:1.5">${n.summary}</div>
        <div class="news-meta">
          <span class="news-tag" style="background:${n.tagCol};color:${n.tagTxt}">${n.tag}</span>
          <span class="news-source">${n.source}</span>
          <span class="news-time">${n.time}</span>
        </div>
      </div>
      <div class="news-sentiment" style="color:${n.sentCol}">${n.sentiment === '+' ? '▲ Bullish' : n.sentiment === '-' ? '▼ Bearish' : '◆ Neutral'}</div>
    </div>`).join('');
}

function renderEarnings() {
  const el = document.getElementById('earningsBody');
  if (!el) return;
  el.innerHTML = EARNINGS_DATA.map(e => `
    <tr>
      <td style="padding:10px 14px;border-bottom:1px solid var(--border);font-family:var(--font-mono);font-size:11px;color:var(--text3)">${e.date}</td>
      <td style="padding:10px 14px;border-bottom:1px solid var(--border);font-size:12px;font-weight:600;color:var(--text)">${e.company}</td>
      <td style="padding:10px 14px;border-bottom:1px solid var(--border);font-size:11px;color:var(--text3)">${e.time}</td>
      <td style="padding:10px 14px;border-bottom:1px solid var(--border);font-family:var(--font-mono);font-size:12px;color:var(--accent2)">${e.eps}</td>
      <td style="padding:10px 14px;border-bottom:1px solid var(--border);font-family:var(--font-mono);font-size:11px;color:var(--text2)">${e.rev}</td>
      <td style="padding:10px 14px;border-bottom:1px solid var(--border);font-family:var(--font-mono);font-size:11px;color:var(--text3)">${e.mktcap}</td>
      <td style="padding:10px 14px;border-bottom:1px solid var(--border)">
        <span style="padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:${e.importance==='high'?'rgba(245,101,101,0.12)':'rgba(246,201,14,0.1)'};color:${e.importance==='high'?'var(--red)':'var(--yellow)'}">
          ${e.importance === 'high' ? '🔴 High' : '🟡 Med'}
        </span>
      </td>
    </tr>`).join('');
}

function renderMacroHeatmap() {
  const el = document.getElementById('macroHeatmap');
  if (!el) return;
  el.innerHTML = MACRO_HEATMAP_DATA.map(m => `
    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius2);padding:12px;text-align:center;transition:border-color 0.2s;cursor:default;border-left:3px solid ${m.color}" onmouseenter="this.style.borderColor='${m.color}'" onmouseleave="this.style.borderColor='var(--border)'">
      <div style="font-size:22px;margin-bottom:4px">${m.icon}</div>
      <div style="font-size:11px;font-weight:600;color:var(--text);margin-bottom:2px">${m.region}</div>
      <div style="font-size:10px;font-weight:700;color:${m.color};margin-bottom:4px">${m.signal}</div>
      <div style="font-size:9px;color:var(--text3);line-height:1.4">${m.detail}</div>
    </div>`).join('');
}

function renderTicker() {
  const el = document.getElementById('tickerTrack');
  if (!el) return;
  const items = [...TICKER_DATA, ...TICKER_DATA]; // double for seamless loop
  el.innerHTML = items.map(t => `
    <div class="ticker-item">
      <span class="ticker-sym">${t.sym}</span>
      <span class="ticker-price">${t.price}</span>
      <span class="ticker-chg ${t.up ? 'up' : 'dn'}">${t.up ? '▲' : '▼'} ${t.chg}</span>
    </div>`).join('');
}

function drawFearGreedNews(value) {
  const canvas = document.getElementById('fearGreedGaugeNews');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, 200, 110);
  const cx = 100, cy = 100, r = 80;
  const gradient = ctx.createLinearGradient(20, 0, 180, 0);
  gradient.addColorStop(0, '#f87171');
  gradient.addColorStop(0.33, '#fb923c');
  gradient.addColorStop(0.5, '#fbbf24');
  gradient.addColorStop(0.67, '#86efac');
  gradient.addColorStop(1, '#4ade80');
  ctx.beginPath(); ctx.arc(cx, cy, r, Math.PI, 0);
  ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.lineWidth = 18; ctx.stroke();
  ctx.beginPath(); ctx.arc(cx, cy, r, Math.PI, Math.PI + (value / 100) * Math.PI);
  ctx.strokeStyle = gradient; ctx.lineWidth = 18; ctx.lineCap = 'round'; ctx.stroke();
  const angle = Math.PI + (value / 100) * Math.PI;
  const nx = cx + (r - 9) * Math.cos(angle);
  const ny = cy + (r - 9) * Math.sin(angle);
  ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(nx, ny);
  ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();
  ctx.beginPath(); ctx.arc(cx, cy, 4, 0, Math.PI * 2);
  ctx.fillStyle = 'white'; ctx.fill();
  const label = value < 25 ? 'Extreme Fear' : value < 45 ? 'Fear' : value < 55 ? 'Neutral' : value < 75 ? 'Greed' : 'Extreme Greed';
  const col = value < 45 ? 'var(--red)' : value < 55 ? 'var(--yellow)' : 'var(--green)';
  const vEl = document.getElementById('fgValueNews');
  const lEl = document.getElementById('fgLabelNews');
  if (vEl) { vEl.textContent = value; vEl.style.color = col; }
  if (lEl) { lEl.textContent = label; lEl.style.color = col; }
}

function refreshNewsTab() {
  showToast('News & Calendar refreshed', 'success');
  renderNewsTab();
}

function renderNewsTab() {
  // Update timestamp
  const tsEl = document.getElementById('newsLastUpdated');
  if (tsEl) tsEl.textContent = 'Updated ' + new Date().toLocaleTimeString();
  // Render all components
  renderTicker();
  renderNewsTabFeed();
  renderCalendar();
  renderEarnings();
  renderMacroHeatmap();
  drawFearGreedNews(72);
  // Also update the date
  const dateEl = document.getElementById('fgDate');
  if (dateEl) dateEl.textContent = new Date().toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
}

function renderNews() {
  renderNewsFeed();
  renderCalendar();
  drawFearGreed(72);
}

function renderNewsFeed() {
  const el = document.getElementById('newsFeed');
  if (!el) return;
  const filtered = newsFilter === 'All' ? NEWS_DATA : NEWS_DATA.filter(n => n.cat === newsFilter);
  el.innerHTML = filtered.map(n => `
    <div class="news-feed-item">
      <div class="news-dot" style="background:${n.tagTxt}"></div>
      <div class="news-content">
        <div class="news-headline">${n.headline}</div>
        <div class="news-meta">
          <span class="news-tag" style="background:${n.tagCol};color:${n.tagTxt}">${n.tag}</span>
          <span class="news-source">${n.source}</span>
          <span class="news-time">${n.time}</span>
        </div>
      </div>
      <div class="news-sentiment" style="color:${n.sentCol}">${n.sentiment === '+' ? '▲ Bullish' : n.sentiment === '-' ? '▼ Bearish' : '◆ Neutral'}</div>
    </div>`).join('');
  // Also update standalone news view if it exists
  const el2 = document.getElementById('newsTabFeed');
  if (el2) el2.innerHTML = el.innerHTML;
}

function renderCalendar() {
  const calHtml = generateFallbackCalendar().map(e => `
    <div class="cal-item">
      <div class="cal-time">${e.time}</div>
      <div class="cal-country">${e.country}</div>
      <div class="cal-event">
        <div style="display:flex;align-items:center;gap:6px">
          <div class="cal-impact ${e.impact}" style="width:3px;height:28px;border-radius:2px;flex-shrink:0"></div>
          <div>
            <div class="cal-event-name">${e.name}</div>
            <div class="cal-event-sub">${e.sub}</div>
          </div>
        </div>
      </div>
      <div class="cal-vals">
        <span class="cal-actual ${e.result}" style="font-size:12px">${e.actual}</span>
        <span style="color:var(--text3)">F: ${e.forecast}</span>
      </div>
    </div>`).join('');
  const el = document.getElementById('economicCalendar');
  if (el) el.innerHTML = calHtml;
  const el2 = document.getElementById('calendarTabFull');
  if (el2) el2.innerHTML = calHtml;
}

function drawFearGreed(value) {
  const canvas = document.getElementById('fearGreedGauge');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, 200, 110);
  const cx = 100, cy = 100, r = 80;

  const gradient = ctx.createLinearGradient(20, 0, 180, 0);
  gradient.addColorStop(0, '#f87171');
  gradient.addColorStop(0.33, '#fb923c');
  gradient.addColorStop(0.5, '#fbbf24');
  gradient.addColorStop(0.67, '#86efac');
  gradient.addColorStop(1, '#4ade80');

  ctx.beginPath();
  ctx.arc(cx, cy, r, Math.PI, 0);
  ctx.strokeStyle = 'rgba(255,255,255,0.06)';
  ctx.lineWidth = 18;
  ctx.stroke();

  ctx.beginPath();
  ctx.arc(cx, cy, r, Math.PI, Math.PI + (value / 100) * Math.PI);
  ctx.strokeStyle = gradient;
  ctx.lineWidth = 18;
  ctx.lineCap = 'round';
  ctx.stroke();

  // Needle
  const angle = Math.PI + (value / 100) * Math.PI;
  const nx = cx + (r - 9) * Math.cos(angle);
  const ny = cy + (r - 9) * Math.sin(angle);
  ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(nx, ny);
  ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();
  ctx.beginPath(); ctx.arc(cx, cy, 4, 0, Math.PI*2);
  ctx.fillStyle = 'white'; ctx.fill();

  const label = value < 25 ? 'Extreme Fear' : value < 45 ? 'Fear' : value < 55 ? 'Neutral' : value < 75 ? 'Greed' : 'Extreme Greed';
  const col = value < 45 ? 'var(--red)' : value < 55 ? 'var(--yellow)' : 'var(--green)';
  document.getElementById('fgValue').textContent = value;
  document.getElementById('fgLabel').textContent = label;
  document.getElementById('fgLabel').style.color = col;
}

// ══════════════════════════════════════════════
// SCREENER
// ══════════════════════════════════════════════
function generateScreenerData() {
  const universe = [
    ...['RELIANCE','TCS','HDFCBANK','INFY','ICICIBANK','BHARTIARTL','ITC','SBIN','WIPRO','NESTLEIND','BAJFINANCE','LT','HCLTECH','TITAN','KOTAKBANK','ADANIENT','MARUTI','SUNPHARMA','ASIANPAINT','ULTRACEMCO'].map(s => ({ sym:s, mkt:'NSE' })),
    ...['AAPL','MSFT','NVDA','AMZN','META','GOOGL','TSLA','JPM','AMD','NFLX','CRM','PANW','CRWD','PLTR','SNOW','BABA','TSM','V','MA','BRK.B'].map(s => ({ sym:s, mkt:'US Stocks' })),
    ...['BTC/USDT','ETH/USDT','SOL/USDT','BNB/USDT','XRP/USDT','ADA/USDT','AVAX/USDT','MATIC/USDT','LINK/USDT','DOT/USDT'].map(s => ({ sym:s, mkt:'Crypto' })),
    ...['EUR/USD','GBP/USD','USD/JPY','AUD/USD','USD/CAD','USD/CHF','EUR/GBP','GBP/JPY'].map(s => ({ sym:s, mkt:'Forex' })),
    ...['GOLD/USD','SILVER/USD','CRUDE OIL','NATURAL GAS','COPPER','WHEAT','PLATINUM'].map(s => ({ sym:s, mkt:'Commodity' })),
  ];
  return universe.map(u => {
    const rsi = Math.round(15 + Math.random() * 75); // full RSI range 15-90
    const chg = parseFloat(((Math.random() - 0.45) * 10).toFixed(2));
    const vol = parseFloat((0.3 + Math.random() * 5).toFixed(1));
    const macd = Math.random() > 0.5 ? 'Bullish' : 'Bearish';
    const trendRoll = Math.random();
    const trend = trendRoll > 0.55 ? 'Uptrend' : trendRoll > 0.25 ? 'Downtrend' : 'Ranging';
    // More natural signal distribution
    let signal;
    if (rsi < 30) signal = chg < 0 ? 'Strong Buy' : 'Buy';
    else if (rsi < 45 && macd === 'Bullish') signal = 'Buy';
    else if (rsi > 75) signal = chg > 2 ? 'Strong Sell' : 'Sell';
    else if (rsi > 60 && macd === 'Bearish') signal = 'Sell';
    else signal = 'Neutral';
    const bases = { NSE:800, 'US Stocks':180, Crypto:800, Forex:1, Commodity:80 };
    const price = (bases[u.mkt] * (0.4 + Math.random() * 1.2)).toFixed(u.mkt === 'Forex' ? 4 : 2);
    return { ...u, rsi, chg, vol, trend, macd, signal, price };
  });
}

let screenerData = [];
let screenerInitialized = false;

function getNumVal(id, fallback) {
  const v = document.getElementById(id);
  if (!v) return fallback;
  const s = v.value.trim();
  if (s === '' || s === null) return fallback;
  const n = parseFloat(s);
  return isNaN(n) ? fallback : n;
}

function runScreener() {
  if (!screenerData.length) screenerData = generateScreenerData();

  const mkt    = document.getElementById('sc-market').value;
  const sig    = document.getElementById('sc-signal').value;
  const trend  = document.getElementById('sc-trend').value;
  const rsiMin = getNumVal('sc-rsiMin', 0);
  const rsiMax = getNumVal('sc-rsiMax', 100);
  const chgMin = getNumVal('sc-chgMin', -100);
  const chgMax = getNumVal('sc-chgMax', 100);
  const volMin = getNumVal('sc-vol', 0);

  const filtered = screenerData.filter(r =>
    (!mkt   || r.mkt    === mkt)  &&
    (!sig   || r.signal === sig)  &&
    (!trend || r.trend  === trend) &&
    r.rsi >= rsiMin && r.rsi <= rsiMax &&
    r.chg >= chgMin && r.chg <= chgMax &&
    r.vol  >= volMin
  );

  // Sort: Strong Buy first, then Buy, Neutral, Sell, Strong Sell
  const sigOrder = {'Strong Buy':0,'Buy':1,'Neutral':2,'Sell':3,'Strong Sell':4};
  filtered.sort((a,b) => (sigOrder[a.signal]||2) - (sigOrder[b.signal]||2));

  const signalMap = { 'Strong Buy':'signal-strong-buy', 'Buy':'signal-buy', 'Neutral':'signal-neutral', 'Sell':'signal-sell', 'Strong Sell':'signal-strong-sell' };
  const tbody = document.getElementById('screenerBody');

  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text3);font-size:14px">🔍 No results match your filters.<br><span style="font-size:12px;margin-top:4px;display:block">Try widening your RSI / Change % range or removing filters.</span></td></tr>';
  } else {
    tbody.innerHTML = filtered.slice(0, 50).map(r => `
      <tr>
        <td style="font-weight:600;font-family:var(--font-mono);color:var(--text)">${r.sym} ${r.live ? '<span style="font-size:8px;padding:1px 5px;border-radius:3px;background:rgba(74,222,128,0.15);color:var(--green);font-weight:700;margin-left:4px">LIVE</span>' : ''}${r.fxOnly ? '<span style="font-size:8px;padding:1px 5px;border-radius:3px;background:rgba(246,201,14,0.12);color:var(--yellow);font-weight:700;margin-left:3px">PRICE</span>' : ''}</td>
        <td>${getMarketBadge(r.mkt)}</td>
        <td style="font-family:var(--font-mono)">${r.mkt === 'Forex' ? r.price : r.mkt === 'NSE' ? '₹' + Number(r.price).toLocaleString('en-IN') : '$' + Number(r.price).toLocaleString()}</td>
        <td style="font-family:var(--font-mono);font-weight:600;color:${r.fxOnly ? 'var(--text3)' : r.chg >= 0 ? 'var(--green)' : 'var(--red)'}">${r.fxOnly ? '—' : (r.chg >= 0 ? '+' : '') + r.chg + '%'}</td>
        <td>
          ${r.fxOnly ? '<span style="color:var(--text3);font-size:12px;padding-left:8px">—</span>' : `<div style="display:flex;align-items:center;gap:8px;min-width:90px">
            <span style="font-family:var(--font-mono);font-size:12px;font-weight:600;color:${r.rsi < 30 ? 'var(--green)' : r.rsi > 70 ? 'var(--red)' : 'var(--text)'};min-width:28px">${r.rsi}</span>
            <div style="flex:1;height:4px;background:var(--bg4);border-radius:2px;overflow:hidden;min-width:48px"><div style="width:${r.rsi}%;height:100%;background:${r.rsi < 30 ? 'var(--green)' : r.rsi > 70 ? 'var(--red)' : 'var(--accent)'}"></div></div>
          </div>`}
        </td>
        <td>${r.fxOnly ? '<span style="color:var(--text3);font-size:12px">—</span>' : `<span style="font-size:11px;font-weight:600;color:${r.macd==='Bullish'?'var(--green)':'var(--red)'}">${r.macd === 'Bullish' ? '▲' : '▼'} ${r.macd}</span>`}</td>
        <td style="font-family:var(--font-mono);font-size:12px;color:${r.fxOnly ? 'var(--text3)' : r.vol >= 3 ? 'var(--yellow)' : r.vol >= 2 ? 'var(--text2)' : 'var(--text3)'}">${r.fxOnly ? '—' : r.vol + '×'}</td>
        <td>${r.fxOnly ? '<span style="color:var(--text3);font-size:12px">—</span>' : `<span style="font-size:11px;font-weight:500;color:${r.trend==='Uptrend'?'var(--green)':r.trend==='Downtrend'?'var(--red)':'var(--text3)'}">${r.trend==='Uptrend'?'↑':r.trend==='Downtrend'?'↓':'↔'} ${r.trend}</span>`}</td>
        <td>${r.fxOnly ? '<span style="font-size:10px;color:var(--text3);font-style:italic">Price only</span>' : `<span class="signal-badge ${signalMap[r.signal]||'signal-neutral'}">${r.signal}</span>`}</td>
        <td>
          <button class="btn btn-ghost" style="font-size:11px;padding:4px 10px;white-space:nowrap" onclick="loadScreenerTrade('${r.sym.replace(/'/g,"\\'")}','${r.mkt}')">+ Trade</button>
        </td>
      </tr>`).join('');
  }

  // Update result count label
  const countEl = document.getElementById('screenerCount');
  if (countEl) countEl.textContent = `${filtered.length} results`;

  renderBenchmarks();
}

function loadScreenerTrade(sym, mkt) {
  openAddModal();
  // Use rAF to wait for modal to fully render before setting values
  requestAnimationFrame(() => {
    const symEl = document.getElementById('f-symbol');
    const mktEl = document.getElementById('f-market');
    if (symEl) symEl.value = sym;
    if (mktEl) mktEl.value = mkt;
  });
}

function applyPreset(preset, el) {
  document.querySelectorAll('#presetTags .screener-tag').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  const presets = {
    momentum:   { rsiMin:55, rsiMax:75, chgMin:1.5, trend:'Uptrend', vol:0 },
    oversold:   { rsiMin:0,  rsiMax:30, chgMin:-100, chgMax:100, trend:'', vol:0 },
    overbought: { rsiMin:70, rsiMax:100, trend:'', vol:0 },
    breakout:   { vol:2, rsiMin:48, chgMin:2 },
    reversal:   { rsiMin:0,  rsiMax:32, trend:'' },
    volume:     { vol:3 },
    trending:   { trend:'Uptrend', rsiMin:45 },
    nse:        { mkt:'NSE' },
  };
  const p = presets[preset] || {};
  // Reset all filters first
  document.getElementById('sc-market').value  = p.mkt    ?? '';
  document.getElementById('sc-signal').value  = '';
  document.getElementById('sc-trend').value   = p.trend  ?? '';
  document.getElementById('sc-rsiMin').value  = p.rsiMin ?? 0;
  document.getElementById('sc-rsiMax').value  = p.rsiMax ?? 100;
  document.getElementById('sc-chgMin').value  = p.chgMin ?? -100;
  document.getElementById('sc-chgMax').value  = p.chgMax ?? 100;
  document.getElementById('sc-vol').value     = p.vol    ?? 0;
  runScreener();
}

function resetScreener() {
  ['sc-market','sc-signal','sc-trend'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('sc-rsiMin').value = 0;
  document.getElementById('sc-rsiMax').value = 100;
  document.getElementById('sc-chgMin').value = -100;
  document.getElementById('sc-chgMax').value = 100;
  document.getElementById('sc-vol').value = 0;
  document.querySelectorAll('#presetTags .screener-tag').forEach(t => t.classList.remove('active'));
  screenerData = generateScreenerData(); // regenerate fresh data
  runScreener();
}

function renderBenchmarks() {
  const s = getStats(allTrades);
  const capital = (typeof userSettings !== 'undefined' && userSettings.capital) ? userSettings.capital : 100000;
  const myPct = capital > 0 ? (s.pnl / capital * 100) : 0;
  const benchmarks = [
    { label:'vs S&P 500', you: s.pnl !== 0 ? (myPct >= 0 ? '+' : '') + myPct.toFixed(1) + '%' : '—', bench:'+24.2%', youPct: Math.min(Math.max(myPct, 0), 100), benchPct:24.2, col:'var(--accent)', note:'Annual return 2024' },
    { label:'vs NIFTY 50', you: s.pnl !== 0 ? (myPct >= 0 ? '+' : '') + myPct.toFixed(1) + '%' : '—', bench:'+8.4%', youPct: Math.min(Math.max(myPct, 0), 100), benchPct:8.4, col:'var(--cyan)', note:'Annual return 2024' },
    { label:'vs BTC', you: s.pnl !== 0 ? (myPct >= 0 ? '+' : '') + myPct.toFixed(1) + '%' : '—', bench:'+142%', youPct: Math.min(Math.max(myPct/2, 0), 100), benchPct:71, col:'var(--yellow)', note:'Annual return 2024' },
    { label:'Profit Factor', you: isFinite(s.pf) && s.pf > 0 ? s.pf.toFixed(2) : s.pf === Infinity ? '∞' : '—', bench:'> 2.00', youPct: Math.min((s.pf||0) * 25, 100), benchPct:50, col:'var(--green)', note:'Elite threshold' },
    { label:'Win Rate', you: s.total > 0 ? s.wr.toFixed(1) + '%' : '—', bench:'55–65%', youPct: s.wr, benchPct:60, col:'var(--orange)', note:'Top traders avg' },
    { label:'Avg R-Multiple', you: s.total > 0 ? s.r.toFixed(2) + 'R' : '—', bench:'2R+', youPct: Math.min((s.r||0) * 25, 100), benchPct:50, col:'var(--accent2)', note:'Per trade target' },
  ];
  const el = document.getElementById('benchmarkCards');
  if (!el) return;
  el.innerHTML = benchmarks.map(b => `
    <div class="benchmark-card">
      <div class="bm-label">${b.label}</div>
      <div class="bm-value" style="color:${b.col};font-size:22px;font-family:var(--font-mono);font-weight:400;margin:6px 0">${b.you}</div>
      <div class="bm-vs">Benchmark: <span style="color:var(--text2);font-weight:600">${b.bench}</span></div>
      <div style="font-size:10px;color:var(--text3);margin-top:3px">${b.note}</div>
      <div style="margin-top:12px">
        <div style="font-size:10px;color:var(--text3);margin-bottom:3px;text-transform:uppercase;letter-spacing:0.05em">You</div>
        <div class="bm-bar"><div class="bm-bar-you" style="width:${b.youPct}%;background:${b.col};transition:width 0.8s ease"></div></div>
        <div style="font-size:10px;color:var(--text3);margin:6px 0 3px;text-transform:uppercase;letter-spacing:0.05em">Benchmark</div>
        <div class="bm-bar"><div class="bm-bar-you" style="width:${b.benchPct}%;background:rgba(255,255,255,0.15);transition:width 0.8s ease"></div></div>
      </div>
    </div>`).join('');
}

function renderScreener() {
  // Always regenerate fresh data when tab is opened
  screenerData = generateScreenerData();
  runScreener();
}

// ══════════════════════════════════════════════
// PSYCHOLOGY
// ══════════════════════════════════════════════
const QUOTES = [
  { text:'The most important investment you can make is in yourself. The more you learn, the more you earn.', author:'— Warren Buffett' },
  { text:'The stock market is a device for transferring money from the impatient to the patient.', author:'— Warren Buffett' },
  { text:'In trading, the hardest thing is not the analysis. It is sitting on your hands when you have no edge.', author:'— Paul Tudor Jones' },
  { text:'The key to trading success is emotional discipline. If intelligence were the key, there would be a lot more people making money trading.', author:'— Victor Sperandeo' },
  { text:'Risk comes from not knowing what you\'re doing. The less you know, the more risk you take.', author:'— Warren Buffett' },
  { text:'You don\'t need to be right. You just need to have a positive expectancy over many trades.', author:'— Mark Douglas' },
  { text:'The goal of a successful trader is to make the best trades. Money is secondary.', author:'— Alexander Elder' },
  { text:'Trade the market in front of you, not the market you want.', author:'— Ed Seykota' },
  { text:'Cut your losses short and let your profits run. Manage your risk first, profits second.', author:'— Jesse Livermore' },
  { text:'Every battle is won before it is fought. Preparation is everything.', author:'— Sun Tzu' },
  { text:'The single most important thing you can do for your trading is to keep a journal.', author:'— Dr. Brett Steenbarger' },
  { text:'I believe in analysis and not forecasting. A good trader adapts — a bad trader predicts.', author:'— Nicolas Darvas' },
];

const BIASES = [
  { name:'Confirmation Bias', icon:'🔍', desc:'Seeking information that confirms your existing trade thesis while ignoring contradictory signals.', color:'var(--accent)' },
  { name:'Loss Aversion', icon:'😰', desc:'The pain of losses feels 2x stronger than the pleasure of equivalent gains, leading to holding losers too long.', color:'var(--red)' },
  { name:'Overconfidence', icon:'💪', desc:'Overestimating your ability to predict markets after a winning streak. Often precedes major drawdowns.', color:'var(--yellow)' },
  { name:'FOMO', icon:'🏃', desc:'Fear of missing out causes chasing entries late, taking suboptimal setups, and breaking trading rules.', color:'var(--orange)' },
  { name:'Anchoring Bias', icon:'⚓', desc:'Over-relying on the first price seen as a reference point, e.g. "It was at $500, so $400 is cheap."', color:'var(--cyan)' },
  { name:'Recency Bias', icon:'📅', desc:'Overweighting recent events. After a crash, expecting it to continue. After a rally, dismissing risks.', color:'var(--accent2)' },
];

const EMOTION_CYCLE = [
  { label:'Optimism', col:'#86efac' },{ label:'Excitement', col:'#4ade80' },{ label:'Thrill', col:'#fbbf24' },
  { label:'Euphoria', col:'#f59e0b' },{ label:'Complacency', col:'#fb923c' },{ label:'Anxiety', col:'#f87171' },
  { label:'Denial', col:'#ef4444' },{ label:'Panic', col:'#dc2626' },{ label:'Capitulation', col:'#b91c1c' },
  { label:'Despondency', col:'#7f1d1d' },{ label:'Depression', col:'#991b1b' },{ label:'Hope', col:'#60a5fa' },
  { label:'Relief', col:'#93c5fd' },{ label:'Optimism', col:'#86efac' },
];

const IMPROVEMENT_PLAN = [
  { icon:'📖', title:'Daily Journal Review', desc:'Read your last 10 trades every morning — spot patterns in mistakes' },
  { icon:'🧘', title:'Pre-Trade Meditation', desc:'5-min mindfulness before session to enter focused, not reactive' },
  { icon:'📊', title:'Weekly Backtest', desc:'Backtest your setups on historical data — 1 hour every weekend' },
  { icon:'🎯', title:'One Setup Mastery', desc:'Focus only on your highest-probability setup for 30 days' },
  { icon:'🏋️', title:'Simulate Trade Decisions', desc:'Paper trade for 1 week after 2+ consecutive losses' },
  { icon:'📚', title:'Read Market Wizards', desc:'One chapter per week — absorb mindset from the best traders' },
];

function renderPsychology() {
  // Quote
  const q = QUOTES[new Date().getDay() % QUOTES.length];
  document.getElementById('dailyQuote').innerHTML = `<div class="quote-text">"${q.text}"</div><div class="quote-author">${q.author}</div>`;

  // Biases
  const s = getStats(allTrades);
  const biasScores = [
    Math.min(100, s.wr < 40 ? 80 : 40),
    Math.min(100, s.dd > 1000 ? 70 : 30),
    Math.min(100, s.wr > 70 ? 85 : 25),
    Math.min(100, allTrades.length > 30 ? 45 : 60),
    Math.min(100, 35 + Math.random() * 30),
    Math.min(100, 40 + Math.random() * 30),
  ];
  document.getElementById('biasCards').innerHTML = BIASES.map((b, i) => `
    <div class="bias-card">
      <div class="bias-title"><span>${b.icon}</span><span style="color:${b.color}">${b.name}</span></div>
      <div class="bias-desc">${b.desc}</div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="bias-meter" style="flex:1"><div class="bias-fill" style="width:${biasScores[i]}%;background:${b.color}"></div></div>
        <span style="font-family:var(--font-mono);font-size:11px;color:${b.color}">${biasScores[i].toFixed(0)}%</span>
      </div>
    </div>`).join('');

  // Mental score
  const mentalScore = Math.round(
    (s.wr > 40 ? 25 : 10) +
    (s.pf >= 1.5 ? 25 : s.pf >= 1 ? 15 : 5) +
    (s.r >= 1 ? 25 : s.r >= 0 ? 15 : 5) +
    (getConsecLosses() <= 2 ? 25 : 10)
  );
  const circ = 326.7;
  const ring = document.getElementById('mentalRing');
  if (ring) { ring.style.strokeDashoffset = circ - (circ * mentalScore / 100); ring.style.stroke = mentalScore >= 70 ? 'var(--green)' : mentalScore >= 40 ? 'var(--yellow)' : 'var(--red)'; }
  const scoreEl = document.getElementById('mentalScore');
  if (scoreEl) scoreEl.textContent = mentalScore;

  document.getElementById('mentalBreakdown').innerHTML = [
    ['Discipline', s.pf >= 1 ? '✓' : '✗', s.pf >= 1 ? 'var(--green)' : 'var(--red)'],
    ['Patience', s.r >= 1 ? '✓' : '✗', s.r >= 1 ? 'var(--green)' : 'var(--red)'],
    ['Risk Ctrl', getConsecLosses() <= 2 ? '✓' : '✗', getConsecLosses() <= 2 ? 'var(--green)' : 'var(--red)'],
    ['Consistency', s.total >= 10 ? '✓' : '✗', s.total >= 10 ? 'var(--green)' : 'var(--yellow)'],
  ].map(([l,v,c]) => `<div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center"><div style="font-size:10px;color:var(--text3);margin-bottom:4px">${l}</div><div style="font-size:18px;color:${c}">${v}</div></div>`).join('');

  // Behavioral patterns
  const patterns = [];
  if (s.total > 0) {
    const lossAfterWin = allTrades.slice(0,-1).filter((t,i) => calcPnL(t) > 0 && calcPnL(allTrades[i+1]) < 0).length;
    if (lossAfterWin / s.total > 0.3) patterns.push({ icon:'😤', label:'Overtrading After Wins', desc:`${lossAfterWin} trades show loss following a win — possible overconfidence cycle`, col:'var(--red)' });
    const avgWin = s.grossW / (s.wins || 1);
    const avgLoss = s.grossL / (s.losses || 1);
    if (avgWin < avgLoss * 1.2) patterns.push({ icon:'✂️', label:'Not Cutting Losses', desc:'Your average loss exceeds your average win. Tighten stop placement.', col:'var(--red)' });
    if (s.wr > 65) patterns.push({ icon:'🎯', label:'High Win Rate — Check RR', desc:'Strong win rate but verify average win ≥ 1.5x average loss for true edge.', col:'var(--yellow)' });
    if (s.total >= 5 && s.pf >= 1.5) patterns.push({ icon:'✅', label:'Positive Expected Value', desc:'Your system generates positive expectancy. Focus on consistency.', col:'var(--green)' });
  }
  if (!patterns.length) patterns.push({ icon:'📊', label:'Need More Data', desc:'Add at least 10 trades to unlock behavioral pattern analysis.', col:'var(--text3)' });
  document.getElementById('behaviorPanel').innerHTML = patterns.map(p => `
    <div style="display:flex;gap:12px;padding:14px;background:var(--bg3);border-radius:var(--radius2);border:1px solid var(--border);margin-bottom:10px;border-left:3px solid ${p.col}">
      <span style="font-size:20px">${p.icon}</span>
      <div><div style="font-weight:600;font-size:13px;color:${p.col};margin-bottom:4px">${p.label}</div><div style="font-size:12px;color:var(--text3)">${p.desc}</div></div>
    </div>`).join('');

  // Emotion cycle
  const currentPhaseIdx = Math.min(3, Math.max(0, Math.round(4 - (mentalScore / 100) * 4)));
  const phaseNames = ['Euphoria / Optimism (Peak Risk)', 'Complacency', 'Anxiety / Fear', 'Despair / Capitulation'];
  document.getElementById('emotionCycle').innerHTML = EMOTION_CYCLE.map((e, i) => `
    <div style="padding:6px 12px;border-radius:20px;font-size:12px;background:${e.col}22;border:1px solid ${e.col}55;color:${e.col}">${e.label}</div>`).join('');
  document.getElementById('cycleExplain').innerHTML = `<strong style="color:var(--text)">Current Market Phase Indicator: ${phaseNames[currentPhaseIdx]}</strong><br><br>Based on your recent trading performance, market sentiment gauges, and macro indicators, markets appear to be in the <em style="color:var(--yellow)">${phaseNames[currentPhaseIdx]}</em> phase. Historically this phase precedes ${currentPhaseIdx < 2 ? 'increased volatility and potential reversal' : 'a recovery and opportunity'}. Trade accordingly — reduce size during uncertainty, increase size during clarity.`;

  // Emotion log from pre/post sessions
  const moods = [];
  const pm = localStorage.getItem('tj_pre_mood');
  const pom = localStorage.getItem('tj_post_mood');
  if (pm) moods.push({ time:'Pre-Market', mood: pm, date: new Date().toLocaleDateString() });
  if (pom) moods.push({ time:'Post-Market', mood: pom, date: new Date().toLocaleDateString() });
  document.getElementById('emotionLog').innerHTML = moods.length ? moods.map(m => `
    <div class="emotion-log-item">
      <span style="font-size:22px">${m.mood}</span>
      <div style="flex:1"><div style="font-size:13px;font-weight:500">${m.time}</div><div style="font-size:11px;color:var(--text3)">${m.date}</div></div>
    </div>`).join('') : '<div style="padding:16px;text-align:center;color:var(--text3);font-size:13px">Log your mood in Pre/Post market views</div>';

  // Improvement plan
  document.getElementById('improvPlan').innerHTML = IMPROVEMENT_PLAN.map(p => `
    <div style="display:flex;gap:12px;padding:12px;background:var(--bg3);border-radius:var(--radius2);border:1px solid var(--border)">
      <span style="font-size:20px">${p.icon}</span>
      <div><div style="font-size:13px;font-weight:600;margin-bottom:2px">${p.title}</div><div style="font-size:12px;color:var(--text3)">${p.desc}</div></div>
    </div>`).join('');
}

// ══════════════════════════════════════════════
// SYMBOL DATABASE
// ══════════════════════════════════════════════
const SYMBOL_DB = [
  // ── NSE 500 (top 80 representative) ──
  ...['RELIANCE','TCS','HDFCBANK','INFY','ICICIBANK','HINDUNILVR','ITC','SBIN','BHARTIARTL','KOTAKBANK',
      'BAJFINANCE','LT','HCLTECH','ASIANPAINT','AXISBANK','MARUTI','TITAN','SUNPHARMA','WIPRO','NESTLEIND',
      'ULTRACEMCO','BAJAJFINSV','TECHM','POWERGRID','NTPC','ONGC','COALINDIA','JSWSTEEL','TATASTEEL','GRASIM',
      'BRITANNIA','DIVISLAB','EICHERMOT','DRREDDY','CIPLA','HEROMOTOCO','INDUSINDBK','ADANIPORTS','TATACONSUM','UPL',
      'SHREECEM','BAJAJ-AUTO','SBILIFE','HDFCLIFE','PIDILITIND','DABUR','AMBUJACEM','GAIL','HAVELLS','SIEMENS',
      'BERGEPAINT','MUTHOOTFIN','LUPIN','CADILAHC','TORNTPHARM','BIOCON','AUROPHARMA','ALKEM','IPCALAB','NATCOPHARM',
      'CHOLAFIN','MFSL','ICICIGI','HDFCAMC','AAVAS','MANAPPURAM','CANFINHOME','LICHSGFIN','RECLTD','PFC',
      'ADANIENT','ADANIGREEN','ADANITRANS','TATAPOWER','CESC','TORNTPOWER','ATGL','IGL','MGL','GUJGASLTD',
      'PERSISTENT','MPHASIS','LTTS','COFORGE','LTIM','ZOMATO','NYKAA','POLICYBZR','PAYTM','DELHIVERY',
      'IRCTC','RAILTEL','RVNL','IRFC','INDIANB','BANDHANBNK','FEDERALBNK','RBLBANK','IDFCFIRSTB','AUBANK',
      'MARICO','EMAMILTD','COLPAL','GODREJCP','VBL','TATACOMM','MCDOWELL-N','UNITDSPR','RADICO','GLOBUSSP'
  ].map(s => ({ ticker: s, name: s + ' (NSE)', market: 'NSE', cat: 'nse' })),

  // ── FOREX PAIRS ──
  ...[
    ['EUR/USD','Euro / US Dollar'],['GBP/USD','British Pound / US Dollar'],['USD/JPY','US Dollar / Japanese Yen'],
    ['USD/CHF','US Dollar / Swiss Franc'],['AUD/USD','Australian Dollar / US Dollar'],['USD/CAD','US Dollar / Canadian Dollar'],
    ['NZD/USD','New Zealand Dollar / US Dollar'],['EUR/GBP','Euro / British Pound'],['EUR/JPY','Euro / Japanese Yen'],
    ['GBP/JPY','British Pound / Japanese Yen'],['EUR/CHF','Euro / Swiss Franc'],['EUR/AUD','Euro / Australian Dollar'],
    ['EUR/CAD','Euro / Canadian Dollar'],['GBP/AUD','British Pound / Australian Dollar'],['GBP/CAD','British Pound / Canadian Dollar'],
    ['AUD/JPY','Australian Dollar / Japanese Yen'],['CAD/JPY','Canadian Dollar / Japanese Yen'],['CHF/JPY','Swiss Franc / Japanese Yen'],
    ['EUR/NZD','Euro / New Zealand Dollar'],['GBP/NZD','British Pound / New Zealand Dollar'],
    ['USD/SGD','US Dollar / Singapore Dollar'],['USD/HKD','US Dollar / Hong Kong Dollar'],['USD/CNH','US Dollar / Chinese Yuan'],
    ['USD/INR','US Dollar / Indian Rupee'],['USD/MXN','US Dollar / Mexican Peso'],['USD/ZAR','US Dollar / South African Rand'],
    ['USD/SEK','US Dollar / Swedish Krona'],['USD/NOK','US Dollar / Norwegian Krone'],['USD/DKK','US Dollar / Danish Krone'],
    ['USD/TRY','US Dollar / Turkish Lira'],['EUR/SEK','Euro / Swedish Krona'],['EUR/NOK','Euro / Norwegian Krone'],
    ['USD/BRL','US Dollar / Brazilian Real'],['USD/PLN','US Dollar / Polish Zloty'],['EUR/PLN','Euro / Polish Zloty'],
    ['USD/THB','US Dollar / Thai Baht'],['USD/KRW','US Dollar / South Korean Won'],['USD/TWD','US Dollar / Taiwan Dollar'],
    ['XAU/USD','Gold / US Dollar'],['XAG/USD','Silver / US Dollar'],
  ].map(([ticker,name]) => ({ ticker, name, market: 'Forex', cat: 'forex' })),

  // ── COMMODITIES ──
  ...[
    ['GOLD/USD','Gold Spot'],['SILVER/USD','Silver Spot'],['PLATINUM/USD','Platinum Spot'],['PALLADIUM/USD','Palladium Spot'],
    ['CRUDE OIL','WTI Crude Oil'],['BRENT CRUDE','Brent Crude Oil'],['NATURAL GAS','Natural Gas'],['HEATING OIL','Heating Oil'],['RBOB GAS','RBOB Gasoline'],
    ['COPPER','Copper'],['ALUMINIUM','Aluminium'],['ZINC','Zinc'],['NICKEL','Nickel'],['LEAD','Lead'],['TIN','Tin'],
    ['CORN','Corn'],['WHEAT','Wheat'],['SOYBEANS','Soybeans'],['SOYBEAN OIL','Soybean Oil'],['SOYBEAN MEAL','Soybean Meal'],
    ['COTTON','Cotton No.2'],['COFFEE','Coffee Arabica'],['SUGAR','Sugar No.11'],['COCOA','Cocoa'],['ORANGE JUICE','Frozen OJ'],
    ['LUMBER','Lumber'],['FEEDER CATTLE','Feeder Cattle'],['LIVE CATTLE','Live Cattle'],['LEAN HOGS','Lean Hogs'],
    ['RICE','Rough Rice'],['OATS','Oats'],['CANOLA','Canola'],['RUBBER','Natural Rubber'],
    ['MCX GOLD','MCX Gold (India)'],['MCX SILVER','MCX Silver (India)'],['MCX CRUDE','MCX Crude (India)'],['MCX COPPER','MCX Copper (India)'],
  ].map(([ticker,name]) => ({ ticker, name, market: 'Commodity', cat: 'commodity' })),

  // ── INDICES ──
  ...[
    ['US100','NASDAQ 100 Index'],['US300','S&P 500 Index (US300)'],['US30','Dow Jones Industrial Average'],
    ['US2000','Russell 2000 Small Cap'],['SPX','S&P 500 Spot'],['NDX','NASDAQ 100 Spot'],['VIX','CBOE Volatility Index'],
    ['GER40','DAX 40 Germany'],['UK100','FTSE 100 UK'],['FRA40','CAC 40 France'],['ESP35','IBEX 35 Spain'],
    ['ITA40','FTSE MIB Italy'],['EU50','Euro Stoxx 50'],['JPN225','Nikkei 225 Japan'],['HK50','Hang Seng 50'],
    ['CHN50','China A50'],['AUS200','ASX 200 Australia'],['SG30','Singapore STI'],['NIFTY50','NSE Nifty 50'],
    ['BANKNIFTY','NSE Bank Nifty'],['NIFTYIT','NSE Nifty IT'],['MIDCAPNIFTY','NSE Midcap 150'],
  ].map(([ticker,name]) => ({ ticker, name, market: 'Index', cat: 'index' })),

  // ── TOP 100 CRYPTO ──
  ...[
    ['BTC/USDT','Bitcoin'],['ETH/USDT','Ethereum'],['BNB/USDT','BNB'],['XRP/USDT','XRP'],['ADA/USDT','Cardano'],
    ['SOL/USDT','Solana'],['DOGE/USDT','Dogecoin'],['DOT/USDT','Polkadot'],['MATIC/USDT','Polygon'],['SHIB/USDT','Shiba Inu'],
    ['LTC/USDT','Litecoin'],['AVAX/USDT','Avalanche'],['LINK/USDT','Chainlink'],['UNI/USDT','Uniswap'],['ATOM/USDT','Cosmos'],
    ['XMR/USDT','Monero'],['ETC/USDT','Ethereum Classic'],['BCH/USDT','Bitcoin Cash'],['XLM/USDT','Stellar'],['ALGO/USDT','Algorand'],
    ['VET/USDT','VeChain'],['ICP/USDT','Internet Computer'],['FIL/USDT','Filecoin'],['HBAR/USDT','Hedera'],['APT/USDT','Aptos'],
    ['ARB/USDT','Arbitrum'],['OP/USDT','Optimism'],['NEAR/USDT','NEAR Protocol'],['SAND/USDT','The Sandbox'],['MANA/USDT','Decentraland'],
    ['AXS/USDT','Axie Infinity'],['GALA/USDT','Gala'],['ENJ/USDT','Enjin Coin'],['CHZ/USDT','Chiliz'],['FLOW/USDT','Flow'],
    ['EGLD/USDT','Elrond'],['THETA/USDT','Theta Network'],['KLAY/USDT','Klaytn'],['ZIL/USDT','Zilliqa'],['ONE/USDT','Harmony'],
    ['FTM/USDT','Fantom'],['CRO/USDT','Cronos'],['GRT/USDT','The Graph'],['MKR/USDT','Maker'],['AAVE/USDT','Aave'],
    ['SNX/USDT','Synthetix'],['COMP/USDT','Compound'],['YFI/USDT','yearn.finance'],['SUSHI/USDT','SushiSwap'],['1INCH/USDT','1inch'],
    ['CRV/USDT','Curve DAO'],['BAL/USDT','Balancer'],['RUNE/USDT','THORChain'],['INJ/USDT','Injective'],['SUI/USDT','Sui'],
    ['SEI/USDT','Sei'],['TIA/USDT','Celestia'],['JUP/USDT','Jupiter'],['PYTH/USDT','Pyth Network'],['W/USDT','Wormhole'],
    ['STRK/USDT','Starknet'],['MANTA/USDT','Manta Network'],['ALT/USDT','AltLayer'],['DYM/USDT','Dymension'],['PIXEL/USDT','Pixels'],
    ['WLD/USDT','Worldcoin'],['PEPE/USDT','Pepe'],['FLOKI/USDT','Floki'],['BONK/USDT','Bonk'],['WIF/USDT','dogwifhat'],
    ['POPCAT/USDT','Popcat'],['BRETT/USDT','Brett'],['TURBO/USDT','Turbo'],['MOG/USDT','Mog Coin'],['NEIRO/USDT','First Neiro'],
    ['ENA/USDT','Ethena'],['EIGEN/USDT','EigenLayer'],['ETHFI/USDT','ether.fi'],['REZ/USDT','Renzo'],['PUFFER/USDT','Puffer Finance'],
    ['IO/USDT','io.net'],['RENDER/USDT','Render'],['TAO/USDT','Bittensor'],['FET/USDT','Artificial Superintelligence'],['AGIX/USDT','SingularityNET'],
    ['OCEAN/USDT','Ocean Protocol'],['AKT/USDT','Akash Network'],['RNDR/USDT','Render Token'],['NMR/USDT','Numeraire'],['GNO/USDT','Gnosis'],
    ['LDO/USDT','Lido DAO'],['RPL/USDT','Rocket Pool'],['SSV/USDT','ssv.network'],['ANKR/USDT','Ankr'],['FXS/USDT','Frax Share'],
    ['FRAX/USDT','Frax'],['USDD/USDT','USDD'],['GUSD/USDT','Gemini Dollar'],['TUSD/USDT','TrueUSD'],['PAXG/USDT','PAX Gold'],
    ['XAU/USDT','Tether Gold'],['BTC/USD','Bitcoin / USD'],['ETH/USD','Ethereum / USD'],['BNB/BTC','BNB / Bitcoin'],['ETH/BTC','Ethereum / Bitcoin'],
  ].map(([ticker,name]) => ({ ticker, name, market: 'Crypto', cat: 'crypto' })),

  // ── US STOCKS (S&P 500 top 150 + NASDAQ 100 heavy hitters) ──
  ...[
    ['AAPL','Apple Inc.'],['MSFT','Microsoft Corp.'],['NVDA','NVIDIA Corp.'],['AMZN','Amazon.com Inc.'],['GOOGL','Alphabet Inc. Class A'],
    ['GOOG','Alphabet Inc. Class C'],['META','Meta Platforms Inc.'],['TSLA','Tesla Inc.'],['BRK.B','Berkshire Hathaway B'],['LLY','Eli Lilly & Co.'],
    ['JPM','JPMorgan Chase & Co.'],['V','Visa Inc.'],['XOM','Exxon Mobil Corp.'],['UNH','UnitedHealth Group'],['JNJ','Johnson & Johnson'],
    ['MA','Mastercard Inc.'],['PG','Procter & Gamble Co.'],['HD','Home Depot Inc.'],['AVGO','Broadcom Inc.'],['CVX','Chevron Corp.'],
    ['MRK','Merck & Co.'],['ABBV','AbbVie Inc.'],['KO','Coca-Cola Co.'],['PEP','PepsiCo Inc.'],['COST','Costco Wholesale'],
    ['BAC','Bank of America'],['WMT','Walmart Inc.'],['ADBE','Adobe Inc.'],['CRM','Salesforce Inc.'],['MCD','McDonald\'s Corp.'],
    ['ACN','Accenture Plc'],['AMD','Advanced Micro Devices'],['NFLX','Netflix Inc.'],['LIN','Linde Plc'],['TMO','Thermo Fisher Scientific'],
    ['DHR','Danaher Corp.'],['TXN','Texas Instruments'],['ABT','Abbott Laboratories'],['PM','Philip Morris Intl'],['NEE','NextEra Energy'],
    ['UNP','Union Pacific Corp.'],['QCOM','Qualcomm Inc.'],['RTX','RTX Corp.'],['HON','Honeywell Intl'],['LOW','Lowe\'s Companies'],
    ['GE','GE Aerospace'],['IBM','IBM Corp.'],['SPGI','S&P Global Inc.'],['COP','ConocoPhillips'],['AXP','American Express'],
    ['CAT','Caterpillar Inc.'],['INTC','Intel Corp.'],['GS','Goldman Sachs'],['MS','Morgan Stanley'],['AMGN','Amgen Inc.'],
    ['MDT','Medtronic Plc'],['PLD','Prologis Inc.'],['ISRG','Intuitive Surgical'],['DE','Deere & Company'],['BKNG','Booking Holdings'],
    ['BLK','BlackRock Inc.'],['CB','Chubb Ltd.'],['GILD','Gilead Sciences'],['SCHW','Charles Schwab'],['SYK','Stryker Corp.'],
    ['REGN','Regeneron Pharma'],['ZTS','Zoetis Inc.'],['ADI','Analog Devices'],['LRCX','Lam Research'],['MU','Micron Technology'],
    ['KLAC','KLA Corp.'],['AMAT','Applied Materials'],['MRVL','Marvell Technology'],['PANW','Palo Alto Networks'],['CRWD','CrowdStrike Holdings'],
    ['SNOW','Snowflake Inc.'],['PLTR','Palantir Technologies'],['UBER','Uber Technologies'],['LYFT','Lyft Inc.'],['ABNB','Airbnb Inc.'],
    ['SHOP','Shopify Inc.'],['SQ','Block Inc.'],['PYPL','PayPal Holdings'],['COIN','Coinbase Global'],['HOOD','Robinhood Markets'],
    ['RBLX','Roblox Corp.'],['U','Unity Software'],['SNAP','Snap Inc.'],['PINS','Pinterest Inc.'],['TWTR','X Corp.'],
    ['ZM','Zoom Video Comm.'],['DOCU','DocuSign Inc.'],['OKTA','Okta Inc.'],['DDOG','Datadog Inc.'],['NET','Cloudflare Inc.'],
    ['MDB','MongoDB Inc.'],['ESTC','Elastic N.V.'],['ZS','Zscaler Inc.'],['FTNT','Fortinet Inc.'],['GTLB','GitLab Inc.'],
    ['HCP','HashiCorp Inc.'],['TTD','The Trade Desk'],['ROKU','Roku Inc.'],['SPOT','Spotify Technology'],['DASH','DoorDash Inc.'],
    ['ABNB','Airbnb Inc.'],['EXPE','Expedia Group'],['BKNG','Booking Holdings'],['MAR','Marriott Intl'],['HLT','Hilton Worldwide'],
    ['DAL','Delta Air Lines'],['UAL','United Airlines'],['AAL','American Airlines'],['LUV','Southwest Airlines'],['BA','Boeing Co.'],
    ['LMT','Lockheed Martin'],['NOC','Northrop Grumman'],['GD','General Dynamics'],['RTX','Raytheon Tech.'],['L3H','L3Harris Tech.'],
    ['PFE','Pfizer Inc.'],['MRNA','Moderna Inc.'],['BMY','Bristol-Myers Squibb'],['AZN','AstraZeneca Plc'],['NVO','Novo Nordisk'],
    ['F','Ford Motor Co.'],['GM','General Motors'],['RIVN','Rivian Automotive'],['LCID','Lucid Group'],['NIO','NIO Inc.'],
    ['XPEV','XPeng Inc.'],['LI','Li Auto Inc.'],['WFC','Wells Fargo & Co.'],['C','Citigroup Inc.'],['USB','US Bancorp'],
    ['PNC','PNC Financial'],['TFC','Truist Financial'],['RF','Regions Financial'],['KEY','KeyCorp'],['CFG','Citizens Financial'],
    ['SPY','SPDR S&P 500 ETF'],['QQQ','Invesco QQQ Trust'],['IWM','iShares Russell 2000'],['GLD','SPDR Gold Shares'],['SLV','iShares Silver Trust'],
    ['TLT','iShares 20Y Treasury'],['HYG','iShares HY Corp Bond'],['VIX','CBOE Volatility'],['SQQQ','ProShares Ultra Short QQQ'],['SPXU','ProShares Ultra Short S&P'],
  ].map(([ticker,name]) => ({ ticker, name, market: 'US Stocks', cat: 'us' })),
];

// ══════════════════════════════════════════════
// AUTOCOMPLETE ENGINE
// ══════════════════════════════════════════════
let acFocusIdx = -1;
let acResults = [];

const CAT_LABEL = {
  nse:'NSE India', forex:'Forex', crypto:'Crypto', commodity:'Commodity',
  index:'Indices', us:'US Stocks', options:'Options'
};

function searchSymbols(query) {
  if (!query || query.length < 1) return [];
  const q = query.toUpperCase();
  const byTicker = [], byName = [];
  for (const sym of SYMBOL_DB) {
    if (sym.ticker.startsWith(q)) byTicker.push(sym);
    else if (sym.ticker.includes(q) || sym.name.toUpperCase().includes(q)) byName.push(sym);
    if (byTicker.length + byName.length >= 40) break;
  }
  return [...byTicker, ...byName].slice(0, 30);
}

function openDropdown(results) {
  const dd = document.getElementById('symDropdown');
  if (!results.length) { dd.classList.remove('open'); return; }

  // Group by cat
  const groups = {};
  results.forEach(r => {
    if (!groups[r.cat]) groups[r.cat] = [];
    groups[r.cat].push(r);
  });

  let html = '';
  let globalIdx = 0;
  for (const [cat, items] of Object.entries(groups)) {
    html += `<div class="sym-group-label">${CAT_LABEL[cat] || cat}</div>`;
    items.forEach(item => {
      html += `<div class="sym-item" data-idx="${globalIdx}" data-ticker="${item.ticker}" data-market="${item.market}">
        <div class="sym-item-left">
          <span class="sym-ticker">${item.ticker}</span>
          <span class="sym-name">${item.name}</span>
        </div>
        <span class="sym-cat sym-cat-${item.cat}">${item.market}</span>
      </div>`;
      globalIdx++;
    });
  }

  acResults = results;
  acFocusIdx = -1;
  dd.innerHTML = html;
  dd.classList.add('open');

  dd.querySelectorAll('.sym-item').forEach(el => {
    el.addEventListener('mousedown', e => {
      e.preventDefault();
      selectSymbol(el.dataset.ticker, el.dataset.market);
    });
  });
}

function selectSymbol(ticker, market) {
  document.getElementById('f-symbol').value = ticker;
  document.getElementById('f-market').value = market;
  document.getElementById('symDropdown').classList.remove('open');
  acFocusIdx = -1;
}

function initAutocomplete() {
  const input = document.getElementById('f-symbol');
  const dd = document.getElementById('symDropdown');

  input.addEventListener('input', () => {
    const results = searchSymbols(input.value.trim());
    openDropdown(results);
  });

  input.addEventListener('keydown', e => {
    const items = dd.querySelectorAll('.sym-item');
    if (!dd.classList.contains('open')) return;
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      acFocusIdx = Math.min(acFocusIdx + 1, items.length - 1);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      acFocusIdx = Math.max(acFocusIdx - 1, -1);
    } else if (e.key === 'Enter' && acFocusIdx >= 0) {
      e.preventDefault();
      const focused = items[acFocusIdx];
      if (focused) selectSymbol(focused.dataset.ticker, focused.dataset.market);
      return;
    } else if (e.key === 'Escape') {
      dd.classList.remove('open');
      return;
    }
    items.forEach((el, i) => el.classList.toggle('focused', i === acFocusIdx));
    if (acFocusIdx >= 0) items[acFocusIdx].scrollIntoView({ block: 'nearest' });
  });

  input.addEventListener('blur', () => setTimeout(() => dd.classList.remove('open'), 150));
}

// ══════════════════════════════════════════════
// BOOT
// ══════════════════════════════════════════════
(async () => {
  loadSettings();          // Load user prefs first
  initAutocomplete();
  await initDB();
  await initJournalDB();   // Init journal DB for daily reviews
  await seedDemo();
  await refresh();
  initRules();
  initCalculators();
  applySettings();         // Apply name/currency after data loaded
  checkOnboarding();       // Show onboarding or demo banner
  showDemoBannerIfNeeded();
  initDailyReview();       // Init zen features
  checkStreakWarning();
  renderZenQuote();
  renderSitOutCount();
  // Start live data engine
  loadAllLiveData();
  // Start floating ticker strip
  FT.start();
  // Refresh crypto every 90 seconds
  setInterval(loadLiveCrypto, 90000);
  // Refresh forex every 5 minutes
  setInterval(loadLiveForex, 300000);
})();

// ══════════════════════════════════════════════════════════════════
// ⚗️  QUANT LAB — Institutional-grade analytics
// ══════════════════════════════════════════════════════════════════

// ─── Helpers ───────────────────────────────────────────────────────
function getPnLArray(trades) {
  return trades.map(calcPnL);
}

function stdDev(arr) {
  if (!arr || arr.length < 2) return 0;
  const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
  const variance = arr.reduce((a, b) => a + (b - mean) ** 2, 0) / arr.length;
  return Math.sqrt(Math.max(0, variance));
}

function percentile(sorted, p) {
  const idx = Math.floor((p / 100) * (sorted.length - 1));
  return sorted[Math.max(0, Math.min(idx, sorted.length - 1))];
}

function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

// ─── Sharpe / Sortino / Calmar ─────────────────────────────────────
function calcRatios(trades) {
  if (trades.length < 5) return { sharpe: null, sortino: null, calmar: null };
  const pnls = getPnLArray(trades);
  const mean = pnls.reduce((a, b) => a + b, 0) / pnls.length;
  const rf = (userSettings.capital || 100000) * 0.02 / 252; // daily risk-free
  const excessMean = mean - rf;
  const sd = stdDev(pnls);
  const sharpe = sd > 0 ? (excessMean / sd) * Math.sqrt(252) : 0;

  const downside = pnls.filter(p => p < 0);
  const downSd = downside.length > 1 ? stdDev(downside) : sd;
  const sortino = downSd > 0 ? (excessMean / downSd) * Math.sqrt(252) : 0;

  // Calmar = annualised return / max drawdown — must use chronological order
  const totalReturn = pnls.reduce((a, b) => a + b, 0);
  const annReturn = totalReturn * (252 / trades.length);
  const chronoPnlsC = [...trades].sort((a,b) => new Date(a.date) - new Date(b.date)).map(calcPnL);
  let peak = 0, eq = 0, maxDD = 0;
  for (const p of chronoPnlsC) {
    eq += p; if (eq > peak) peak = eq;
    const dd = peak - eq; if (dd > maxDD) maxDD = dd;
  }
  const calmar = maxDD > 0 ? annReturn / maxDD : 0;
  return {
    sharpe: isFinite(sharpe) ? sharpe : null,
    sortino: isFinite(sortino) ? sortino : null,
    calmar: isFinite(calmar) ? calmar : null
  };
}

// ─── Monte Carlo ───────────────────────────────────────────────────
function runMonteCarlo(trades, N = 1000, steps = 100) {
  const pnls = getPnLArray(trades).filter(p => isFinite(p));
  if (pnls.length < 2) return null;
  const startCapital = userSettings.capital || 100000;
  const ruin_threshold = startCapital * 0.5; // 50% drawdown = ruin

  const paths = [];
  let ruinCount = 0;

  for (let i = 0; i < N; i++) {
    let eq = startCapital;
    const path = [eq];
    let ruined = false;
    for (let s = 0; s < steps; s++) {
      // Resample with replacement from actual trade P&L
      const sample = pnls[Math.floor(Math.random() * pnls.length)];
      eq += sample;
      path.push(eq);
      if (eq < ruin_threshold && !ruined) { ruined = true; ruinCount++; }
    }
    paths.push(path);
  }

  // Calculate percentiles at each step
  const p5 = [], p25 = [], p50 = [], p75 = [], p95 = [];
  for (let s = 0; s <= steps; s++) {
    const vals = paths.map(p => p[s]).sort((a, b) => a - b);
    p5.push(percentile(vals, 5));
    p25.push(percentile(vals, 25));
    p50.push(percentile(vals, 50));
    p75.push(percentile(vals, 75));
    p95.push(percentile(vals, 95));
  }

  return { p5, p25, p50, p75, p95, ruinPct: (ruinCount / N) * 100, paths: paths.slice(0, 50) };
}

// ─── Draw Monte Carlo Canvas ────────────────────────────────────────
function drawMonteCarlo(mc) {
  const canvas = document.getElementById('mcCanvas');
  if (!canvas || !mc) return;
  const ctx = canvas.getContext('2d');
  let W = canvas.parentElement ? canvas.parentElement.clientWidth - 48 : 600;
  if (W <= 50) W = 600; // fallback if tab not yet visible
  const H = 220;
  canvas.width = W;
  canvas.height = H;
  ctx.clearRect(0, 0, W, H);

  const steps = mc.p50.length;
  const allVals = [...mc.p5, ...mc.p95];
  const minV = Math.min(...allVals) * 0.98;
  const maxV = Math.max(...allVals) * 1.02;
  const range = maxV - minV || 1;

  const toX = i => (i / (steps - 1)) * (W - 60) + 30;
  const toY = v => H - 30 - ((v - minV) / range) * (H - 50);

  // Draw background bands (P25–P75, P5–P95)
  const drawBand = (upper, lower, color) => {
    ctx.beginPath();
    ctx.moveTo(toX(0), toY(upper[0]));
    for (let i = 1; i < steps; i++) ctx.lineTo(toX(i), toY(upper[i]));
    for (let i = steps - 1; i >= 0; i--) ctx.lineTo(toX(i), toY(lower[i]));
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();
  };
  drawBand(mc.p95, mc.p5, 'rgba(124,109,250,0.07)');
  drawBand(mc.p75, mc.p25, 'rgba(124,109,250,0.12)');

  // Draw P5 and P95 dashed lines
  const drawLine = (series, color, dash) => {
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = 1.5;
    if (dash) ctx.setLineDash(dash); else ctx.setLineDash([]);
    ctx.moveTo(toX(0), toY(series[0]));
    for (let i = 1; i < steps; i++) ctx.lineTo(toX(i), toY(series[i]));
    ctx.stroke();
  };
  drawLine(mc.p5, '#f87171', [4, 3]);
  drawLine(mc.p95, '#4ade80', [4, 3]);
  drawLine(mc.p50, '#7c6dfa', []);

  // Draw sample ghost paths
  ctx.globalAlpha = 0.06;
  for (const path of mc.paths.slice(0, 40)) {
    ctx.beginPath();
    ctx.strokeStyle = '#7c6dfa';
    ctx.lineWidth = 0.8;
    ctx.setLineDash([]);
    ctx.moveTo(toX(0), toY(path[0]));
    for (let i = 1; i < path.length; i++) ctx.lineTo(toX(i), toY(path[i]));
    ctx.stroke();
  }
  ctx.globalAlpha = 1;

  // Draw start capital line
  const cap = userSettings.capital || 100000;
  ctx.setLineDash([3, 3]);
  ctx.strokeStyle = 'rgba(255,255,255,0.15)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(30, toY(cap));
  ctx.lineTo(W - 30, toY(cap));
  ctx.stroke();
  ctx.setLineDash([]);

  // Y axis labels
  ctx.fillStyle = 'rgba(255,255,255,0.3)';
  ctx.font = '10px JetBrains Mono, monospace';
  ctx.textAlign = 'right';
  [minV, (minV + maxV) / 2, maxV].forEach(v => {
    ctx.fillText(fmtCurrency(v), 28, toY(v) + 3);
  });

  // X labels
  ctx.textAlign = 'center';
  ctx.fillText('Start', toX(0), H - 5);
  ctx.fillText(`+${steps} trades`, toX(steps - 1), H - 5);

  // Legend
  const legend = [
    { color: '#4ade80', dash: true, label: 'P95 (Best)' },
    { color: '#7c6dfa', dash: false, label: 'Median (P50)' },
    { color: '#f87171', dash: true, label: 'P5 (Worst)' },
  ];
  legend.forEach((l, i) => {
    const lx = W / 2 - 160 + i * 115;
    ctx.setLineDash(l.dash ? [4, 3] : []);
    ctx.strokeStyle = l.color;
    ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.moveTo(lx, 14); ctx.lineTo(lx + 24, 14); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    ctx.textAlign = 'left';
    ctx.fillText(l.label, lx + 28, 18);
  });
}

// ─── VaR ──────────────────────────────────────────────────────────
function calcVaR(trades) {
  const pnls = getPnLArray(trades).sort((a, b) => a - b);
  const n = pnls.length;
  if (n < 2) return {};
  const h95 = pnls[Math.floor(n * 0.05)];
  const h99 = pnls[Math.floor(n * 0.01)] || pnls[0];
  const mean = pnls.reduce((a, b) => a + b, 0) / n;
  const sd = stdDev(pnls);
  const p95 = mean - 1.645 * sd;
  const p99 = mean - 2.326 * sd;
  const tail = pnls.slice(0, Math.max(1, Math.floor(n * 0.05)));
  const cvar = tail.reduce((a, b) => a + b, 0) / tail.length;
  const wins = pnls.filter(p => p > 0);
  const losses = pnls.filter(p => p <= 0);
  return {
    h95, h99, p95, cvar,
    maxLoss: pnls[0],
    avgW: wins.length ? wins.reduce((a, b) => a + b, 0) / wins.length : 0,
    avgL: losses.length ? losses.reduce((a, b) => a + b, 0) / losses.length : 0,
  };
}

// ─── Stress Tests ─────────────────────────────────────────────────
function calcStressTests(trades) {
  const s = getStats(trades);
  const cap = userSettings.capital || 100000;
  // Historical crisis drawdowns applied to your trading pattern
  const scenarios = [
    { name: '2008 Global Financial Crisis', desc: 'Lehman collapse, credit freeze, -57% on S&P 500 over 17 months', shock: -0.57, sev: 'crisis' },
    { name: 'COVID Crash (March 2020)', desc: 'Fastest 30% S&P 500 decline in history, VIX hit 82, 23 trading days', shock: -0.34, sev: 'crisis' },
    { name: '2022 Bear Market', desc: 'Fed rate hikes, -25% equities, -65% crypto, -15% bonds simultaneously', shock: -0.25, sev: 'crisis' },
    { name: 'Flash Crash (2010/2015)', desc: 'Intraday -9% S&P 500, recovered same day — liquidity risk event', shock: -0.09, sev: 'moderate' },
    { name: 'Dotcom Recovery 2003', desc: '+ Bull market expansion after 3-year bear — your longs benefit strongly', shock: +0.29, sev: 'recovery' },
    { name: 'Custom: -20% Shock', desc: 'Moderate market correction applied to your current position sizing', shock: -0.20, sev: 'moderate' },
  ];

  // Scale impact by your current win rate and avg trade size
  const avgTrade = trades.length > 0 ? s.pnl / trades.length : 0;
  return scenarios.map(sc => {
    // If you're mostly long, crisis hurts more; if you short, crisis helps longs
    const avgDir = trades.filter(t => t.direction === 'Long').length / (trades.length || 1) - 0.5;
    const correlation = avgDir * 0.6; // how correlated your book is to market
    const impact = cap * sc.shock * correlation;
    const pctImpact = impact / cap * 100;
    return { ...sc, impact, pctImpact };
  });
}

// ─── Factor Decomposition ─────────────────────────────────────────
function calcFactorDecomposition(trades) {
  const totalPnL = trades.reduce((a, t) => a + calcPnL(t), 0) || 1;
  const factors = [];

  // By market
  const markets = [...new Set(trades.map(t => t.market))].filter(Boolean);
  const marketPnL = markets.map(m => {
    const ts = trades.filter(t => t.market === m);
    const pnl = ts.reduce((a, t) => a + calcPnL(t), 0);
    const wr = ts.filter(t => calcPnL(t) > 0).length / ts.length * 100;
    return { factor: m, category: 'Market', pnl, wr, count: ts.length, pct: pnl / totalPnL * 100 };
  });

  // By direction
  ['Long', 'Short'].forEach(dir => {
    const ts = trades.filter(t => t.direction === dir);
    if (!ts.length) return;
    const pnl = ts.reduce((a, t) => a + calcPnL(t), 0);
    const wr = ts.filter(t => calcPnL(t) > 0).length / ts.length * 100;
    factors.push({ factor: dir, category: 'Direction', pnl, wr, count: ts.length, pct: pnl / totalPnL * 100 });
  });

  // By setup
  const setups = [...new Set(trades.map(t => t.setup).filter(Boolean))];
  setups.forEach(setup => {
    const ts = trades.filter(t => t.setup === setup);
    const pnl = ts.reduce((a, t) => a + calcPnL(t), 0);
    const wr = ts.filter(t => calcPnL(t) > 0).length / ts.length * 100;
    factors.push({ factor: setup, category: 'Setup', pnl, wr, count: ts.length, pct: pnl / totalPnL * 100 });
  });

  // By day of week
  const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
  days.forEach((day, di) => {
    const ts = trades.filter(t => { try { const d = new Date(t.date + 'T12:00:00'); return !isNaN(d) && d.getDay() === di + 1; } catch(e) { return false; } });
    if (!ts.length) return;
    const pnl = ts.reduce((a, t) => a + calcPnL(t), 0);
    const wr = ts.filter(t => calcPnL(t) > 0).length / ts.length * 100;
    factors.push({ factor: day, category: 'Day', pnl, wr, count: ts.length, pct: pnl / totalPnL * 100 });
  });

  return [...marketPnL, ...factors].sort((a, b) => Math.abs(b.pnl) - Math.abs(a.pnl));
}

// ─── Kelly Allocation ────────────────────────────────────────────
function calcKellyAllocation(trades) {
  const markets = [...new Set(trades.map(t => t.market))].filter(Boolean);
  return markets.map(m => {
    const ts = trades.filter(t => t.market === m);
    if (ts.length < 2) return null;
    const wins = ts.filter(t => calcPnL(t) > 0);
    const losses = ts.filter(t => calcPnL(t) <= 0);
    const p = wins.length / ts.length;
    const avgW = wins.length ? wins.reduce((a, t) => a + calcPnL(t), 0) / wins.length : 0;
    const avgL = losses.length ? Math.abs(losses.reduce((a, t) => a + calcPnL(t), 0) / losses.length) : 1;
    const b = avgL > 0 ? avgW / avgL : avgW > 0 ? 10 : 0.1;
    const kelly = b > 0 ? p - (1 - p) / b : -1;
    const halfKelly = Math.max(0, kelly / 2); // Conservative half-Kelly
    return { market: m, kelly, halfKelly, p, b, count: ts.length, wr: p * 100 };
  }).filter(Boolean);
}

// ─── Time-based analytics ─────────────────────────────────────────
function calcTimeAnalytics(trades) {
  const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
  const dayStats = days.map((day, di) => {
    const ts = trades.filter(t => {
      try {
        const d = new Date(t.date + 'T12:00:00');
        return !isNaN(d) && d.getDay() === di + 1;
      } catch(e) { return false; }
    });
    const wins = ts.filter(t => calcPnL(t) > 0).length;
    const pnl = ts.reduce((a, t) => a + calcPnL(t), 0);
    const wr = ts.length ? wins / ts.length * 100 : 0;
    return { day, count: ts.length, wr, pnl };
  });

  // Monthly breakdown
  const monthData = {};
  trades.forEach(t => {
    const d = new Date(t.date + 'T12:00:00');
    if (isNaN(d)) return;
    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    if (!monthData[key]) monthData[key] = { pnl: 0, count: 0, wins: 0 };
    monthData[key].pnl += calcPnL(t);
    monthData[key].count++;
    if (calcPnL(t) > 0) monthData[key].wins++;
  });

  return { dayStats, monthData };
}

// ─── Setup Matrix ────────────────────────────────────────────────
function calcSetupMatrix(trades) {
  const setups = [...new Set(trades.map(t => t.setup).filter(Boolean))];
  const markets = [...new Set(trades.map(t => t.market).filter(Boolean))].slice(0, 5);
  const matrix = setups.slice(0, 6).map(setup => {
    const row = { setup };
    markets.forEach(mkt => {
      const ts = trades.filter(t => t.setup === setup && t.market === mkt);
      row[mkt] = ts.length ? ts.filter(t => calcPnL(t) > 0).length / ts.length * 100 : null;
    });
    return row;
  });
  return { matrix, markets };
}

// ─── MAIN: runQuantLab ────────────────────────────────────────────
function runQuantLab() {
  if (allTrades.length < 3) {
    document.getElementById('ql-ratios').innerHTML = '<div style="color:var(--text3);font-size:13px;padding:20px;text-align:center;grid-column:1/-1">Add at least 3 trades to run Quant Lab analysis.</div>';
    return;
  }

  // 1. Ratios
  const ratios = calcRatios(allTrades);
  const ratioColor = v => v === null ? 'var(--text3)' : v > 1.5 ? 'var(--green)' : v > 0.5 ? 'var(--yellow)' : 'var(--red)';
  const ratioFmt = v => v === null ? '—' : v.toFixed(2);
  document.getElementById('ql-sharpe').textContent = ratioFmt(ratios.sharpe);
  document.getElementById('ql-sharpe').style.color = ratioColor(ratios.sharpe);
  document.getElementById('ql-sortino').textContent = ratioFmt(ratios.sortino);
  document.getElementById('ql-sortino').style.color = ratioColor(ratios.sortino);
  document.getElementById('ql-calmar').textContent = ratioFmt(ratios.calmar);
  document.getElementById('ql-calmar').style.color = ratioColor(ratios.calmar);

  // 2. Monte Carlo
  const mc = runMonteCarlo(allTrades, 1000, Math.min(100, allTrades.length * 3));
  if (mc) {
    // Store for resize redraws and defer until layout is painted
    window._lastMC = mc;
    requestAnimationFrame(() => drawMonteCarlo(mc));
    const cap = userSettings.capital || 100000;
    document.getElementById('mc-p5').textContent = fmtCurrency(mc.p5[mc.p5.length - 1]);
    document.getElementById('mc-p50').textContent = fmtCurrency(mc.p50[mc.p50.length - 1]);
    document.getElementById('mc-p95').textContent = fmtCurrency(mc.p95[mc.p95.length - 1]);
    const ruinEl = document.getElementById('mc-ruin');
    ruinEl.textContent = mc.ruinPct.toFixed(1) + '%';
    ruinEl.style.color = mc.ruinPct > 20 ? 'var(--red)' : mc.ruinPct > 5 ? 'var(--yellow)' : 'var(--green)';
  }

  // 3. VaR
  const v = calcVaR(allTrades);
  const vFmt = n => n < 0 ? '-' + fmtCurrency(Math.abs(n)) : fmtCurrency(n);
  if (v.h95 !== undefined) {
    document.getElementById('var-h95').textContent = vFmt(v.h95);
    document.getElementById('var-h99').textContent = vFmt(v.h99);
    document.getElementById('var-p95').textContent = vFmt(v.p95);
    document.getElementById('var-cvar').textContent = vFmt(v.cvar);
    document.getElementById('var-max').textContent = vFmt(v.maxLoss);
    document.getElementById('var-avgw').textContent = '+' + fmtCurrency(v.avgW);
    document.getElementById('var-avgl').textContent = '-' + fmtCurrency(Math.abs(v.avgL));
  }

  // 4. Stress Tests
  if (!allTrades.length) return;
  const stresses = calcStressTests(allTrades);
  document.getElementById('ql-stress-cards').innerHTML = stresses.map(sc => {
    const isPos = sc.impact >= 0;
    const col = isPos ? 'var(--green)' : 'var(--red)';
    return `<div class="stress-card ${sc.sev}" style="display:flex;align-items:center;gap:14px">
      <div style="flex:1">
        <div style="font-size:13px;font-weight:700;margin-bottom:2px">${sc.name}</div>
        <div style="font-size:11px;color:var(--text3);line-height:1.4">${sc.desc}</div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div style="font-family:var(--font-mono);font-size:18px;font-weight:600;color:${col}">${isPos ? '+' : ''}${fmtCurrency(sc.impact)}</div>
        <div style="font-size:11px;color:${col}">${sc.pctImpact.toFixed(1)}%</div>
      </div>
    </div>`;
  }).join('');

  // 5. Factor Decomposition
  const factors = calcFactorDecomposition(allTrades);
  const maxAbs = Math.max(...factors.map(f => Math.abs(f.pnl)), 1);
  const catColors = { Market: 'var(--accent)', Direction: 'var(--cyan)', Setup: 'var(--green)', Day: 'var(--yellow)' };
  document.getElementById('ql-factors').innerHTML = `
    <div style="display:grid;grid-template-columns:120px 1fr 70px 80px 70px;gap:10px;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:11px;color:var(--text3);font-weight:700">
      <div>FACTOR</div><div>P&L CONTRIBUTION</div><div>P&L</div><div>WIN RATE</div><div>TRADES</div>
    </div>
    ${factors.slice(0, 16).map(f => {
      const pct = Math.abs(f.pnl) / maxAbs * 100;
      const isPos = f.pnl >= 0;
      const catColor = catColors[f.category] || 'var(--text3)';
      return `<div style="display:grid;grid-template-columns:120px 1fr 70px 80px 70px;gap:10px;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px">
        <div style="display:flex;align-items:center;gap:6px">
          <span style="font-size:9px;background:${catColor}22;color:${catColor};padding:1px 5px;border-radius:3px;white-space:nowrap">${f.category}</span>
          <span style="color:var(--text)">${f.factor}</span>
        </div>
        <div>
          <div style="height:8px;background:var(--bg4);border-radius:4px;overflow:hidden">
            <div style="height:100%;width:${pct}%;background:${isPos ? 'var(--green)' : 'var(--red)'};border-radius:4px"></div>
          </div>
        </div>
        <div style="font-family:var(--font-mono);color:${isPos ? 'var(--green)' : 'var(--red)'};font-size:12px">${isPos ? '+' : ''}${fmtCurrency(f.pnl)}</div>
        <div style="font-family:var(--font-mono);font-size:12px">${f.count > 0 ? f.wr.toFixed(0) + '%' : '—'}</div>
        <div style="font-size:12px;color:var(--text3)">${f.count}x</div>
      </div>`;
    }).join('')}
  `;

  // 6. Time Analytics
  const time = calcTimeAnalytics(allTrades);
  const maxDayPnL = Math.max(...time.dayStats.map(d => Math.abs(d.pnl)), 1);
  document.getElementById('ql-time-grid').innerHTML = time.dayStats.map(d => {
    const intensity = d.count ? clamp(d.wr / 100, 0, 1) : 0;
    const bg = d.count === 0 ? 'var(--bg4)' :
               d.pnl > 0 ? `rgba(74,222,128,${0.1 + intensity * 0.4})` : `rgba(248,113,113,${0.1 + (1-intensity) * 0.4})`;
    return `<div style="background:${bg};border-radius:8px;padding:10px 6px;text-align:center;border:1px solid var(--border)">
      <div style="font-size:11px;font-weight:700;color:var(--text2)">${d.day}</div>
      <div style="font-family:var(--font-mono);font-size:12px;margin:3px 0;color:${d.pnl >= 0 ? 'var(--green)' : 'var(--red)'}">${d.count ? fmtCurrency(d.pnl) : '—'}</div>
      <div style="font-size:10px;color:var(--text3)">${d.count ? d.wr.toFixed(0) + '%' : 'no data'}</div>
    </div>`;
  }).join('');

  // Monthly heatmap
  const monthKeys = Object.keys(time.monthData).sort();
  const pnlVals = monthKeys.map(k => time.monthData[k].pnl);
  const maxMonthPnL = Math.max(...pnlVals.map(Math.abs), 1);
  document.getElementById('ql-monthly-heatmap').innerHTML = monthKeys.slice(-12).map(k => {
    const m = time.monthData[k];
    const intensity = Math.abs(m.pnl) / maxMonthPnL;
    const bg = m.pnl > 0 ? `rgba(74,222,128,${0.15 + intensity * 0.5})` : `rgba(248,113,113,${0.15 + intensity * 0.5})`;
    const label = k.slice(0, 7);
    return `<div style="background:${bg};border-radius:6px;padding:8px 4px;text-align:center;border:1px solid var(--border)" title="${label}: ${fmtCurrency(m.pnl)} (${m.count} trades)">
      <div style="font-size:9px;color:var(--text3)">${k.slice(5, 7)}/${k.slice(2, 4)}</div>
      <div style="font-family:var(--font-mono);font-size:10px;color:${m.pnl >= 0 ? 'var(--green)' : 'var(--red)'}">${fmtCurrency(m.pnl)}</div>
    </div>`;
  }).join('');

  // 7. Setup Matrix
  const sm = calcSetupMatrix(allTrades);
  if (sm.matrix.length > 0) {
    const headerRow = `<div style="display:grid;grid-template-columns:110px ${sm.markets.map(() => '1fr').join(' ')};gap:6px;margin-bottom:6px">
      <div style="font-size:10px;color:var(--text3)">SETUP</div>
      ${sm.markets.map(m => `<div style="font-size:10px;color:var(--text3);text-align:center">${m.slice(0, 6)}</div>`).join('')}
    </div>`;
    const rows = sm.matrix.map(row => `<div style="display:grid;grid-template-columns:110px ${sm.markets.map(() => '1fr').join(' ')};gap:6px;margin-bottom:4px;align-items:center">
      <div style="font-size:12px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${row.setup}</div>
      ${sm.markets.map(mkt => {
        const wr = row[mkt];
        if (wr === null) return '<div style="background:var(--bg4);border-radius:4px;height:32px;display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--text3)">—</div>';
        const bg = wr > 60 ? `rgba(74,222,128,${0.1 + (wr/100)*0.5})` : wr < 40 ? `rgba(248,113,113,${0.1+(1-wr/100)*0.4})` : 'rgba(251,191,36,0.15)';
        return `<div style="background:${bg};border-radius:4px;height:32px;display:flex;align-items:center;justify-content:center;font-family:var(--font-mono);font-size:11px;font-weight:600">${wr.toFixed(0)}%</div>`;
      }).join('')}
    </div>`).join('');
    document.getElementById('ql-setup-matrix').innerHTML = headerRow + rows;
  } else {
    document.getElementById('ql-setup-matrix').innerHTML = '<div style="color:var(--text3);font-size:13px;padding:10px">Add trades with setup labels to see the matrix.</div>';
  }

  // 8. Kelly Allocation
  const kelly = calcKellyAllocation(allTrades);
  const totalKelly = kelly.reduce((a, k) => a + k.halfKelly, 0) || 1;
  const cap = userSettings.capital || 100000;
  document.getElementById('ql-kelly-alloc').innerHTML = kelly.length ? `
    <div style="display:grid;grid-template-columns:120px 1fr 80px 80px 80px 80px;gap:12px;align-items:center;font-size:11px;color:var(--text3);font-weight:700;padding:6px 0;border-bottom:1px solid var(--border)">
      <div>MARKET</div><div>HALF-KELLY ALLOCATION</div><div>CAPITAL</div><div>WIN RATE</div><div>PAYOFF</div><div>TRADES</div>
    </div>
    ${kelly.map(k => {
      const pct = k.halfKelly > 0 ? (k.halfKelly / totalKelly) * 100 : 0;
      const capital = pct / 100 * cap;
      const barW = clamp(pct, 0, 100);
      const col = k.kelly > 0 ? 'var(--green)' : 'var(--red)';
      return `<div style="display:grid;grid-template-columns:120px 1fr 80px 80px 80px 80px;gap:12px;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)">
        <div style="font-size:13px;font-weight:600">${k.market}</div>
        <div>
          <div style="display:flex;align-items:center;gap:8px">
            <div style="flex:1;height:8px;background:var(--bg4);border-radius:4px;overflow:hidden">
              <div style="height:100%;width:${barW}%;background:var(--accent);border-radius:4px"></div>
            </div>
            <span style="font-family:var(--font-mono);font-size:12px;min-width:36px">${pct.toFixed(1)}%</span>
          </div>
        </div>
        <div style="font-family:var(--font-mono);font-size:12px">${fmtCurrency(capital)}</div>
        <div style="font-family:var(--font-mono);font-size:12px">${k.wr.toFixed(0)}%</div>
        <div style="font-family:var(--font-mono);font-size:12px;color:${col}">${k.b.toFixed(1)}x</div>
        <div style="font-size:12px;color:var(--text3)">${k.count}</div>
      </div>`;
    }).join('')}
    <div style="margin-top:12px;font-size:11px;color:var(--text3);line-height:1.6">
      ℹ️ <strong>Half-Kelly</strong> is used (conservative) — full Kelly is theoretically optimal but leads to extreme volatility. Allocate proportionally to your edge per market.
      ${kelly.some(k => k.kelly <= 0) ? ' <span style="color:var(--red)">Markets with negative Kelly have no positive expected value — consider avoiding or paper-trading until your edge improves.</span>' : ''}
    </div>
  ` : '<div style="color:var(--text3);font-size:13px;padding:10px">Need trades in multiple markets to calculate Kelly allocation.</div>';

  showToast('Quant Lab analysis complete ⚗️', 'success');

  // Re-draw canvas on window resize
  if (!window._qlResizeSet) {
    window._qlResizeSet = true;
    window.addEventListener('resize', () => {
      if (document.getElementById('view-quantlab')?.classList.contains('active')) {
        const mc2 = window._lastMC;
        if (mc2) requestAnimationFrame(() => drawMonteCarlo(mc2));
      }
    });
  }
}

// ══════════════════════════════════════════════════════════════════
// 🧠  DECISION ENGINE — Pre-trade systematic scoring
// ══════════════════════════════════════════════════════════════════

function runDecisionEngine() {
  const symbol  = document.getElementById('de-symbol')?.value.trim();
  const dir     = document.getElementById('de-direction')?.value;
  const mkt     = document.getElementById('de-market')?.value;
  const entry   = parseFloat(document.getElementById('de-entry')?.value);
  const stop    = parseFloat(document.getElementById('de-stop')?.value);
  const target  = parseFloat(document.getElementById('de-target')?.value);
  const setup   = document.getElementById('de-setup')?.value;
  const regime  = document.getElementById('de-regime')?.value;
  const accSize = parseFloat(document.getElementById('de-account')?.value) || (userSettings.capital || 100000);
  const posSize = parseFloat(document.getElementById('de-possize')?.value) || 1;

  if (!symbol) { showToast('Enter a symbol first', 'error'); return; }

  // Fetch live data in background
  enrichDecisionWithLiveData(symbol, mkt);

  const checks = [];
  let score = 0;

  // ── Check 1: Symbol entered ──────────────────────────────────
  checks.push({ label: 'Symbol identified', status: 'pass', detail: symbol.toUpperCase() });
  score += 5;

  // ── Check 2: Entry / Stop defined ───────────────────────────
  if (!isNaN(entry) && !isNaN(stop) && entry !== 0 && stop !== 0) {
    checks.push({ label: 'Entry & stop loss defined', status: 'pass', detail: `Entry ${entry} · Stop ${stop}` });
    score += 15;
  } else {
    checks.push({ label: 'Entry & stop loss defined', status: 'fail', detail: 'Required for position sizing' });
  }

  // ── Check 3: Risk-Reward Ratio ───────────────────────────────
  let rr = null;
  if (!isNaN(entry) && !isNaN(stop) && !isNaN(target) && entry && stop) {
    const risk   = Math.abs(entry - stop);
    const reward = Math.abs(target - entry);
    rr = reward / (risk || 1);
    if (rr >= 2) {
      checks.push({ label: `Risk-Reward ≥ 2:1`, status: 'pass', detail: `${rr.toFixed(1)}:1 — Acceptable edge` });
      score += 20;
    } else if (rr >= 1) {
      checks.push({ label: `Risk-Reward < 2:1`, status: 'warn', detail: `${rr.toFixed(1)}:1 — Marginal (aim for 2:1+)` });
      score += 8;
    } else {
      checks.push({ label: `Risk-Reward < 1:1`, status: 'fail', detail: `${rr.toFixed(1)}:1 — Do not take this trade` });
    }
  } else {
    checks.push({ label: 'Risk-Reward', status: 'warn', detail: 'Enter target price to calculate R:R' });
  }

  // ── Check 4: Position sizing ─────────────────────────────────
  if (posSize <= (userSettings.risk || 1)) {
    checks.push({ label: `Position size ≤ ${userSettings.risk || 1}% risk`, status: 'pass', detail: `${posSize}% of capital (within rules)` });
    score += 10;
  } else if (posSize <= 2) {
    checks.push({ label: `Position size elevated`, status: 'warn', detail: `${posSize}% — exceeds default risk rule of ${userSettings.risk || 1}%` });
    score += 4;
  } else {
    checks.push({ label: `Oversized position`, status: 'fail', detail: `${posSize}% — dangerously large. Scale down.` });
  }

  // ── Check 5: Setup selected ──────────────────────────────────
  if (setup) {
    const setupTrades = allTrades.filter(t => t.setup === setup);
    if (setupTrades.length >= 5) {
      const setupWR = setupTrades.filter(t => calcPnL(t) > 0).length / setupTrades.length * 100;
      if (setupWR >= 50) {
        checks.push({ label: `Setup: ${setup}`, status: 'pass', detail: `${setupWR.toFixed(0)}% win rate over ${setupTrades.length} historical trades` });
        score += 15;
      } else {
        checks.push({ label: `Setup: ${setup}`, status: 'warn', detail: `${setupWR.toFixed(0)}% win rate — below 50% historically for you` });
        score += 5;
      }
    } else {
      checks.push({ label: `Setup: ${setup}`, status: 'warn', detail: `Only ${setupTrades.length} historical trades — sample too small to assess edge` });
      score += 8;
    }
  } else {
    checks.push({ label: 'Setup type not selected', status: 'fail', detail: 'Always know WHY you are taking a trade' });
  }

  // ── Check 6: Market Regime Alignment ────────────────────────
  const regimeAlignMap = {
    'Trending Bull':   { Long: 'pass', Short: 'warn' },
    'Trending Bear':   { Long: 'warn', Short: 'pass' },
    'Ranging':         { Long: 'warn', Short: 'warn' },
    'High Volatility': { Long: 'warn', Short: 'warn' },
    'Low Volatility':  { Long: 'pass', Short: 'pass' },
  };
  const regimeStatus = (regimeAlignMap[regime] || {})[dir] || 'warn';
  if (regimeStatus === 'pass') {
    checks.push({ label: `${dir} in ${regime}`, status: 'pass', detail: 'Direction aligns with market regime' });
    score += 10;
  } else {
    checks.push({ label: `${dir} in ${regime}`, status: 'warn', detail: 'Direction is counter-regime — requires stronger justification' });
    score += 3;
  }

  // ── Check 7: Consecutive losses (revenge trade check) ────────
  const consecLoss = getConsecLosses();
  if (consecLoss >= 3) {
    checks.push({ label: 'Revenge trade risk', status: 'fail', detail: `${consecLoss} consecutive losses — consider pausing. Rules say stop at 2.` });
    score -= 10;
  } else if (consecLoss === 2) {
    checks.push({ label: 'Consecutive loss warning', status: 'warn', detail: `2 losses in a row — review your edge before proceeding` });
    score += 0;
  } else {
    checks.push({ label: 'Loss streak OK', status: 'pass', detail: consecLoss === 0 ? 'No recent losses' : `${consecLoss} recent loss — within acceptable range` });
    score += 10;
  }

  // ── Check 8: Trade thesis ─────────────────────────────────────
  const thesis = document.getElementById('de-thesis')?.value.trim();
  if (thesis && thesis.length >= 20) {
    checks.push({ label: 'Trade thesis written', status: 'pass', detail: 'Structured thinking = better discipline' });
    score += 15;
  } else {
    checks.push({ label: 'Trade thesis missing', status: 'warn', detail: 'Write your reason — it forces clarity and accountability' });
    score += 4;
  }

  score = clamp(score, 0, 100);

  // ── Verdict ───────────────────────────────────────────────────
  const verdict = score >= 70 ? 'GO' : score >= 45 ? 'CAUTION' : 'NO-GO';
  const verdictClass = verdict === 'GO' ? 'go' : verdict === 'CAUTION' ? 'caution' : 'nogo';
  const verdictEmoji = verdict === 'GO' ? '🟢' : verdict === 'CAUTION' ? '🟡' : '🔴';

  // Animate score ring
  const scoreColor = score >= 70 ? '#4ade80' : score >= 45 ? '#fbbf24' : '#f87171';
  const arc = document.getElementById('de-score-arc');
  if (arc) {
    const circumference = 427;
    const offset = circumference - (score / 100) * circumference;
    arc.style.strokeDashoffset = offset;
    arc.style.stroke = scoreColor;
  }

  document.getElementById('de-score-num').textContent = score;
  document.getElementById('de-score-num').style.color = scoreColor;

  const verdictEl = document.getElementById('de-verdict-badge');
  verdictEl.textContent = `${verdictEmoji} ${verdict}`;
  verdictEl.className = `de-verdict ${verdictClass}`;
  verdictEl.style.display = 'inline-block';

  document.getElementById('de-checks').innerHTML = checks.map(c => `
    <div class="de-check-row">
      <div class="de-check-icon ${c.status}">${c.status === 'pass' ? '✓' : c.status === 'fail' ? '✗' : '!'}</div>
      <div>
        <div style="font-weight:600;margin-bottom:2px">${c.label}</div>
        <div style="font-size:11px;color:var(--text3)">${c.detail}</div>
      </div>
    </div>
  `).join('');

  // Historical setup stats
  if (setup) {
    const st = allTrades.filter(t => t.setup === setup);
    const sw = st.filter(t => calcPnL(t) > 0);
    const sl = st.filter(t => calcPnL(t) <= 0);
    const spf = sl.length ? (sw.reduce((a,t) => a+calcPnL(t),0) / Math.abs(sl.reduce((a,t) => a+calcPnL(t),0))).toFixed(2) : '∞';
    const srs = st.map(calcR).filter(r => r!==null);
    const sr  = srs.length ? (srs.reduce((a,b)=>a+b,0)/srs.length).toFixed(2) : '—';
    document.getElementById('de-hist-wr').textContent = st.length ? (sw.length/st.length*100).toFixed(0)+'%' : '—';
    document.getElementById('de-hist-pf').textContent = st.length ? spf : '—';
    document.getElementById('de-hist-r').textContent  = sr;
    document.getElementById('de-hist-n').textContent  = st.length;
    const cols = ['de-hist-wr','de-hist-pf','de-hist-r'];
    cols.forEach(id => {
      const v = parseFloat(document.getElementById(id).textContent);
      if (!isNaN(v)) document.getElementById(id).style.color = v > 0 ? 'var(--green)' : 'var(--red)';
    });
  }

  // Store for AI analysis
  window._deContext = { symbol, dir, mkt, entry, stop, target, setup, regime, rr, score, verdict, checks, thesis, consecLoss };

  showToast(`Decision Engine: ${verdictEmoji} ${verdict} (${score}/100)`, verdict === 'GO' ? 'success' : 'info');
}

function renderDecisionHistory() {
  // Pre-fill account size from settings
  const de_acc = document.getElementById('de-account');
  if (de_acc) de_acc.value = (typeof userSettings !== 'undefined' && userSettings.capital) ? userSettings.capital : 100000;
  const de_pos = document.getElementById('de-possize');
  if (de_pos && !de_pos.value) de_pos.value = (typeof userSettings !== 'undefined' && userSettings.risk > 0) ? userSettings.risk : 1;
  // Update historical edge display to blank if no trades
  if (!allTrades.length) {
    ['de-hist-wr','de-hist-pf','de-hist-r','de-hist-n'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.textContent = '—';
    });
  }
}

// ══════════════════════════════════════════════════════════════════
// 🤖  AI TRADE ANALYST — Claude-powered analysis via Anthropic API
// ══════════════════════════════════════════════════════════════════

async function runAIAnalysis() {
  const ctx = window._deContext;
  if (!ctx) { showToast('Run the Decision Engine first', 'error'); return; }

  const box = document.getElementById('aiAnalysisOutput');
  const btn = document.getElementById('aiAnalyseBtn');
  btn.disabled = true;
  btn.textContent = 'Analysing…';

  box.innerHTML = `
    <div class="ai-badge">✦ Claude AI · Analysing</div>
    <div style="display:flex;align-items:center;gap:10px;color:var(--text3);font-size:13px;margin-top:8px">
      <span class="ai-dot"></span><span class="ai-dot"></span><span class="ai-dot"></span>
      <span>Running structured trade analysis…</span>
    </div>`;

  // Build stats summary for Claude
  const s = getStats(allTrades);
  const ratios = calcRatios(allTrades);
  const setupTrades = ctx.setup ? allTrades.filter(t => t.setup === ctx.setup) : [];
  const setupWR = setupTrades.length ? (setupTrades.filter(t => calcPnL(t) > 0).length / setupTrades.length * 100).toFixed(0) : 'unknown';

  const prompt = `You are a systematic trading analyst using an institutional-grade risk framework. Analyse this specific trade setup concisely and precisely.

TRADER PROFILE:
- Total trades: ${allTrades.length}
- Overall win rate: ${s.wr.toFixed(1)}%
- Profit factor: ${s.pf.toFixed(2)}
- Avg R-multiple: ${s.r.toFixed(2)}R
- Sharpe ratio: ${ratios.sharpe?.toFixed(2) ?? 'insufficient data'}
- Consecutive losses: ${ctx.consecLoss}

PROPOSED TRADE:
- Symbol: ${ctx.symbol} | Market: ${ctx.mkt} | Direction: ${ctx.dir}
- Entry: ${ctx.entry || 'not specified'} | Stop: ${ctx.stop || 'not specified'} | Target: ${ctx.target || 'not specified'}
- Risk-Reward: ${ctx.rr ? ctx.rr.toFixed(1) + ':1' : 'not calculated'}
- Setup: ${ctx.setup || 'not specified'}
- Market regime: ${ctx.regime}
- Systematic score: ${ctx.score}/100 → ${ctx.verdict}
- Thesis: "${ctx.thesis || 'none provided'}"
- Historical win rate for this setup: ${setupWR}% (${setupTrades.length} trades)

Provide a structured analysis with these EXACT sections:
1. **Setup Quality** (2-3 sentences: is the setup well-defined? Is the thesis clear?)
2. **Risk Assessment** (2-3 sentences: R:R adequacy, position sizing, stop placement logic)
3. **Edge Evaluation** (2-3 sentences: does historical data support this setup in this regime?)
4. **Psychological Flags** (1-2 sentences: any revenge trading, FOMO, or bias signals?)
5. **Improvement Suggestions** (2-3 specific, actionable improvements)
6. **Final Verdict** (1 sentence: GO / CAUTION / NO-GO with the single most important reason)

Be direct, specific, and institutional — no generic advice. Reference the actual numbers provided.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{ role: 'user', content: prompt }],
      }),
    });

    const data = await response.json();
    if (data.error) throw new Error(data.error.message);

    const text = data.content?.map(b => b.text || '').join('') || 'No analysis returned.';

    // Format markdown-ish output
    const formatted = text
      .replace(/\*\*(.+?)\*\*/g, '<strong style="color:var(--text)">$1</strong>')
      .replace(/^(\d+\.\s)/gm, '<span style="color:var(--accent2);font-weight:700">$1</span>')
      .split('\n').filter(l => l.trim()).join('<br>');

    box.innerHTML = `
      <div class="ai-badge">✦ Claude AI Analysis</div>
      <div style="margin-top:10px;line-height:1.9">${formatted}</div>
      <div style="margin-top:14px;padding-top:10px;border-top:1px solid var(--border);font-size:11px;color:var(--text3)">
        Analysis based on ${allTrades.length} journal trades · Systematic score ${ctx.score}/100 · Generated ${new Date().toLocaleTimeString()}
      </div>`;

  } catch (err) {
    box.innerHTML = `
      <div class="ai-badge" style="background:rgba(248,113,113,0.1);border-color:rgba(248,113,113,0.3);color:var(--red)">⚠ AI Unavailable</div>
      <div style="margin-top:10px;font-size:13px;color:var(--text2)">
        <strong>Systematic Score: ${ctx.score}/100 → ${ctx.verdict}</strong><br><br>
        AI analysis requires an active Anthropic API connection. Your systematic score and checklist above provide the same structured framework.<br><br>
        <strong>Key findings from your ${allTrades.length} trade history:</strong><br>
        • Win rate: ${s.wr.toFixed(1)}% · Profit factor: ${s.pf.toFixed(2)}<br>
        • This setup (${ctx.setup || 'unspecified'}): ${setupWR}% win rate over ${setupTrades.length} trades<br>
        • Consecutive losses: ${ctx.consecLoss} · R:R: ${ctx.rr ? ctx.rr.toFixed(1)+'x' : 'not set'}
      </div>`;
  }

  btn.disabled = false;
  btn.textContent = 'Re-analyse →';
}

// ── TAB SCROLL HELPERS ──
function scrollTabs(delta) {
  const el = document.getElementById('tabScrollInner');
  if (el) el.scrollLeft += delta;
}

function scrollActiveTabIntoView() {
  const inner = document.getElementById('tabScrollInner');
  const active = document.querySelector('.nav-btn.active');
  if (inner && active) {
    const btnLeft = active.offsetLeft;
    const btnWidth = active.offsetWidth;
    const innerWidth = inner.offsetWidth;
    inner.scrollLeft = btnLeft - (innerWidth / 2) + (btnWidth / 2);
  }
}

const DEFAULT_RULES = {
  'swing-entry': [
    { text: 'Only enter after market confirms trend on daily chart (higher highs/higher lows for longs).', priority: 'must' },
    { text: 'Setup must have minimum 2:1 risk/reward ratio before entry.', priority: 'must' },
    { text: 'Volume must be above 20-day average at breakout point.', priority: 'should' },
    { text: 'Do not enter on Friday afternoon — avoid weekend gap risk.', priority: 'should' },
    { text: 'Check sector relative strength before entering individual stock.', priority: 'can' },
  ],
  'swing-exit': [
    { text: 'Set stop loss at logical support level BEFORE entry — never widen it.', priority: 'must' },
    { text: 'Take partial profit (50%) at 1:1 R/R to ensure breakeven floor.', priority: 'should' },
    { text: 'Trail remaining position using 10-period EMA after 2R is achieved.', priority: 'should' },
    { text: 'Full exit on close below 20-day EMA for positional trades.', priority: 'must' },
  ],
  'swing-risk': [
    { text: 'Maximum 2% account risk per swing trade.', priority: 'must' },
    { text: 'Maximum 5 open swing positions simultaneously.', priority: 'must' },
    { text: 'Reduce position size by 50% during drawdown exceeding 5%.', priority: 'must' },
    { text: 'No leveraged ETFs held overnight beyond 3 days.', priority: 'should' },
  ],
  'swing-mental': [
    { text: 'Review trade setup the night before. No impulsive entries at open.', priority: 'must' },
    { text: 'If experiencing 3 consecutive losses, reduce size by 50% and take 1 day off.', priority: 'must' },
    { text: 'Never revenge trade after a loss. Close computer and return tomorrow.', priority: 'must' },
    { text: 'Rate emotional state 1-10 before each trade. Do not trade below 6.', priority: 'should' },
  ],
  'intraday-time': [
    { text: 'No trades in first 15 minutes of market open (9:15–9:30 NSE / 9:30–9:45 NYSE).', priority: 'must' },
    { text: 'Avoid trading between 12:00–1:30 PM — low volume, choppy action.', priority: 'should' },
    { text: 'No new positions in last 30 minutes if already up on the day.', priority: 'should' },
    { text: 'All positions flat by close — no intraday positions carried overnight.', priority: 'must' },
  ],
  'intraday-entry': [
    { text: 'Only trade setups with clear support/resistance levels identifiable on 5-min chart.', priority: 'must' },
    { text: 'Confirm entry on 15-min chart before executing on 5-min.', priority: 'should' },
    { text: 'Never trade against the 30-min trend direction.', priority: 'must' },
    { text: 'Maximum 3 intraday trades per session. Quality over quantity.', priority: 'should' },
  ],
  'intraday-pnl': [
    { text: 'Daily loss limit: 2% of account. If hit, stop trading immediately.', priority: 'must' },
    { text: 'Daily profit target: 1.5% of account. Optional to stop after hitting target.', priority: 'can' },
    { text: 'If down 1% before 11AM, switch to observation mode only.', priority: 'should' },
    { text: 'Never try to "make back" losses in one trade. Scale is the enemy.', priority: 'must' },
  ],
  'intraday-risk': [
    { text: 'Maximum 1% account risk per intraday trade.', priority: 'must' },
    { text: 'Maximum 2 concurrent open intraday positions.', priority: 'must' },
    { text: 'No trading during high-impact news events (FOMC, RBI policy, earnings).', priority: 'must' },
    { text: 'Use bracket orders / SL-M orders to automate exits.', priority: 'should' },
  ],
  'investing-selection': [
    { text: 'Only invest in businesses you can explain in 2 sentences: what they do and how they make money.', priority: 'must' },
    { text: 'ROCE > 15% for at least 5 consecutive years.', priority: 'must' },
    { text: 'Debt/Equity < 0.5 for non-financial companies.', priority: 'should' },
    { text: 'Promoter holding > 50% and increasing over past 3 years.', priority: 'should' },
    { text: 'Avoid companies in terminal industries unless there\'s a clear transformation narrative.', priority: 'can' },
  ],
  'investing-valuation': [
    { text: 'Never pay > 40× earnings for any company regardless of growth rate.', priority: 'must' },
    { text: 'PEG ratio < 1.5 preferred. Compare P/E to 5-yr earnings growth CAGR.', priority: 'should' },
    { text: 'Buy in tranches: 25% at target, 25% at -10%, 25% at -20%, 25% at -30%.', priority: 'should' },
    { text: 'Require margin of safety: buy at 70% of intrinsic value estimate.', priority: 'must' },
  ],
  'investing-portfolio': [
    { text: 'Maximum 10% allocation to any single stock. Maintain diversification.', priority: 'must' },
    { text: 'Rebalance annually. Do not let any position exceed 15% due to appreciation.', priority: 'should' },
    { text: 'Keep 10-15% in cash/liquid funds for opportunistic buying during corrections.', priority: 'should' },
    { text: 'Review all holdings semi-annually against original investment thesis.', priority: 'must' },
  ],
  'investing-exit': [
    { text: 'Sell when original investment thesis is broken — not because price fell.', priority: 'must' },
    { text: 'Consider LTCG tax implications before selling — hold minimum 1 year for equity.', priority: 'should' },
    { text: 'Harvest tax losses in underperformers before year-end to offset gains.', priority: 'can' },
    { text: 'Never sell a great business just because it looks "expensive" if thesis is intact.', priority: 'can' },
  ],
};

let userRules = {};

function initRules() {
  const saved = localStorage.getItem('tradingRules');
  userRules = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(DEFAULT_RULES));
  renderAllRules();
}

function renderAllRules() {
  Object.keys(userRules).forEach(key => renderRuleSet(key));
}

function renderRuleSet(key) {
  const container = document.getElementById(`${key}-rules`);
  if (!container) return;
  container.innerHTML = userRules[key].map((rule, idx) => `
    <div class="editable-rule" data-key="${key}" data-idx="${idx}">
      <div class="rule-num">${String(idx+1).padStart(2,'0')}</div>
      <div class="rule-content" contenteditable="true" onblur="updateRule('${key}',${idx},this.innerText)">${rule.text}</div>
      <span class="rule-priority priority-${rule.priority}">${rule.priority.toUpperCase()}</span>
      <button onclick="deleteRule('${key}',${idx})" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;padding:0 4px" title="Delete">✕</button>
    </div>`).join('');
}

function addRule(key) {
  if (!userRules[key]) userRules[key] = [];
  userRules[key].push({ text: 'Click to edit this rule...', priority: 'should' });
  renderRuleSet(key);
}

function deleteRule(key, idx) {
  userRules[key].splice(idx, 1);
  renderRuleSet(key);
}

function updateRule(key, idx, text) {
  if (userRules[key] && userRules[key][idx]) {
    userRules[key][idx].text = text;
  }
}

function saveRules() {
  localStorage.setItem('tradingRules', JSON.stringify(userRules));
  showToast('Rules saved to local storage', 'success');
}

function switchRulesTab(tab, btn) {
  document.querySelectorAll('.rules-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.rule-tab').forEach(b => b.classList.remove('active'));
  document.getElementById(`rules-${tab}`).classList.add('active');
  btn.classList.add('active');
}

// ══════════════════════════════════════════════
// CALCULATORS
// ══════════════════════════════════════════════
let nwAssets = [], nwLiabilities = [];

let _calcInited = false;
function initCalculators() {
  if (_calcInited) return;
  _calcInited = true;
  calcSIP(); calcLumpSum(); calcLoan(); calcWealth(); calcFIRE(); calcCI();
}

function switchCalcTab(tab, btn) {
  document.querySelectorAll('.calc-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.calc-tab').forEach(b => b.classList.remove('active'));
  document.getElementById(`calc-${tab}`).classList.add('active');
  btn.classList.add('active');
}

// fmtINR: overridden below by currency-aware fmtCurrency after settings load
function fmtINR(n) {
  if (typeof fmtCurrency === 'function') return fmtCurrency(n);
  if (Math.abs(n) >= 1e7) return '₹' + (n/1e7).toFixed(2) + ' Cr';
  if (Math.abs(n) >= 1e5) return '₹' + (n/1e5).toFixed(2) + ' L';
  return '₹' + n.toLocaleString('en-IN', {maximumFractionDigits:0});
}

function addNWItem(type) {
  const nameEl = document.getElementById(type === 'asset' ? 'assetName' : 'liabName');
  const valEl = document.getElementById(type === 'asset' ? 'assetVal' : 'liabVal');
  const name = nameEl.value.trim();
  const val = parseFloat(valEl.value);
  if (!name || isNaN(val) || val <= 0) { showToast('Enter name and value', 'error'); return; }
  if (type === 'asset') nwAssets.push({ name, val });
  else nwLiabilities.push({ name, val });
  nameEl.value = ''; valEl.value = '';
  renderNW();
}

function renderNW() {
  const totalA = nwAssets.reduce((s, i) => s + i.val, 0);
  const totalL = nwLiabilities.reduce((s, i) => s + i.val, 0);
  const nw = totalA - totalL;
  document.getElementById('assetsBreakdown').innerHTML = nwAssets.map((a, i) => `
    <div class="networth-category" onclick="nwAssets.splice(${i},1);renderNW()">
      <span style="font-size:13px">${a.name}</span>
      <div style="text-align:right">
        <span style="font-family:var(--font-mono);color:var(--green)">${fmtINR(a.val)}</span>
        <div class="nw-bar" style="background:var(--green);width:${totalA?Math.min(100,(a.val/totalA)*100):0}%"></div>
      </div>
    </div>`).join('');
  document.getElementById('liabilitiesBreakdown').innerHTML = nwLiabilities.map((l, i) => `
    <div class="networth-category" onclick="nwLiabilities.splice(${i},1);renderNW()">
      <span style="font-size:13px">${l.name}</span>
      <div style="text-align:right">
        <span style="font-family:var(--font-mono);color:var(--red)">${fmtINR(l.val)}</span>
        <div class="nw-bar" style="background:var(--red);width:${totalL?Math.min(100,(l.val/totalL)*100):0}%"></div>
      </div>
    </div>`).join('');
  document.getElementById('totalAssetsVal').textContent = fmtINR(totalA);
  document.getElementById('totalLiabVal').textContent = fmtINR(totalL);
  document.getElementById('netWorthVal').textContent = fmtINR(nw);
  document.getElementById('netWorthVal').style.color = nw >= 0 ? 'var(--green)' : 'var(--red)';
  const ratio = totalL > 0 ? (totalA / totalL).toFixed(2) : '∞';
  document.getElementById('nwRatioLabel').textContent = `A:L = ${ratio}:1`;
  const pct = totalA + totalL > 0 ? Math.min(100, (totalA / (totalA + totalL)) * 100) : 50;
  document.getElementById('nwBar').style.width = pct + '%';
}

function calcSIP() {
  const P = parseFloat(document.getElementById('sipAmount').value) || 0;
  const r = (parseFloat(document.getElementById('sipReturn').value) || 0) / 100 / 12;
  const n = (parseFloat(document.getElementById('sipYears').value) || 0) * 12;
  const invested = P * n;
  const maturity = r > 0 ? P * ((Math.pow(1+r, n) - 1) / r) * (1+r) : invested;
  const returns = maturity - invested;
  document.getElementById('sipInvested').textContent = fmtINR(invested);
  document.getElementById('sipReturns').textContent = fmtINR(returns);
  document.getElementById('sipMaturity').textContent = fmtINR(maturity);
  document.getElementById('sipRatio').textContent = invested > 0 ? (maturity/invested).toFixed(2) + '×' : '—';
}

function calcLumpSum() {
  const P = parseFloat(document.getElementById('lsAmount').value) || 0;
  const r = (parseFloat(document.getElementById('lsReturn').value) || 0) / 100;
  const n = parseFloat(document.getElementById('lsYears').value) || 0;
  const maturity = P * Math.pow(1+r, n);
  const returns = maturity - P;
  document.getElementById('lsInvested').textContent = fmtINR(P);
  document.getElementById('lsReturns').textContent = fmtINR(returns);
  document.getElementById('lsMaturity').textContent = fmtINR(maturity);
  document.getElementById('lsCagr').textContent = r*100 + '% p.a. CAGR';
}

function calcLoan() {
  const P = parseFloat(document.getElementById('loanAmount').value) || 0;
  const r = (parseFloat(document.getElementById('loanRate').value) || 0) / 100 / 12;
  const n = (parseFloat(document.getElementById('loanYears').value) || 0) * 12;
  const emi = r > 0 ? P * r * Math.pow(1+r, n) / (Math.pow(1+r, n) - 1) : P / n;
  const total = emi * n;
  const interest = total - P;
  document.getElementById('emiVal').textContent = fmtINR(Math.round(emi));
  document.getElementById('totalPayment').textContent = fmtINR(Math.round(total));
  document.getElementById('totalInterest').textContent = fmtINR(Math.round(interest));
  document.getElementById('interestRatio').textContent = P > 0 ? (interest/P*100).toFixed(1) + '% of principal' : '—';
  calcPrepayment();
}

function calcPrepayment() {
  const P = parseFloat(document.getElementById('loanAmount').value) || 0;
  const r = (parseFloat(document.getElementById('loanRate').value) || 0) / 100 / 12;
  const n = (parseFloat(document.getElementById('loanYears').value) || 0) * 12;
  const extra = parseFloat(document.getElementById('extraPayment').value) || 0;
  const emi = r > 0 ? P * r * Math.pow(1+r, n) / (Math.pow(1+r, n) - 1) : 0;
  if (emi <= 0) return;
  let bal = P, months = 0, interest = 0;
  while (bal > 0 && months < n * 3) {
    const int = bal * r; interest += int;
    bal = bal + int - emi - (extra > 0 ? extra : 0);
    months++;
    if (bal < 0) bal = 0;
  }
  const saved = (emi * n - P) - interest;
  const savedMonths = n - months;
  document.getElementById('monthsSaved').textContent = savedMonths > 0 ? savedMonths + ' months' : '0 months';
  document.getElementById('interestSaved').textContent = fmtINR(Math.max(0, saved));
  const payoffDate = new Date(); payoffDate.setMonth(payoffDate.getMonth() + months);
  document.getElementById('newPayoff').textContent = payoffDate.toLocaleDateString('en-IN', {month:'short',year:'numeric'});
}

function calcWealth() {
  const target = parseFloat(document.getElementById('wealthTarget').value) || 0;
  const current = parseFloat(document.getElementById('wealthCurrent').value) || 0;
  const monthly = parseFloat(document.getElementById('wealthMonthly').value) || 0;
  const r = (parseFloat(document.getElementById('wealthReturn').value) || 0) / 100 / 12;
  let bal = current, months = 0;
  while (bal < target && months < 600) {
    bal = bal * (1 + r) + monthly;
    months++;
  }
  const yrs = (months / 12).toFixed(1);
  const invested = current + monthly * months;
  const byMarket = target - invested;
  document.getElementById('yearsToGoal').textContent = months < 600 ? yrs + ' years' : '>50 years';
  const date = new Date(); date.setMonth(date.getMonth() + months);
  document.getElementById('targetDate').textContent = date.toLocaleDateString('en-IN', {month:'short',year:'numeric'});
  document.getElementById('wealthTotalInvested').textContent = fmtINR(invested);
  document.getElementById('wealthByMarket').textContent = fmtINR(Math.max(0, byMarket));
  document.getElementById('wealthProgress').style.width = Math.min(100, (current/target)*100) + '%';
  document.getElementById('wealthTargetLabel').textContent = fmtINR(target);
  document.getElementById('wealthMid').textContent = fmtINR(target/2);
}

function calcFIRE() {
  const expenses = parseFloat(document.getElementById('fireExpenses').value) || 0;
  const currentNW = parseFloat(document.getElementById('fireCurrentNW').value) || 0;
  const savings = parseFloat(document.getElementById('fireSavings').value) || 0;
  const r = (parseFloat(document.getElementById('fireReturn').value) || 0) / 100;
  const fireNum = expenses * 25;
  const gap = Math.max(0, fireNum - currentNW);
  document.getElementById('fireNumber').textContent = fmtINR(fireNum);
  document.getElementById('fireGap').textContent = fmtINR(gap);
  document.getElementById('firePercent').textContent = fireNum > 0 ? (currentNW/fireNum*100).toFixed(1) + '%' : '0%';
  let bal = currentNW, years = 0;
  while (bal < fireNum && years < 50) {
    bal = bal * (1 + r) + savings;
    years++;
  }
  document.getElementById('fireYears').textContent = years < 50 ? years + ' years' : '>50 years';
  const d = new Date(); d.setFullYear(d.getFullYear() + years);
  document.getElementById('fireDate').textContent = d.getFullYear();
}

function calcCI() {
  const P = parseFloat(document.getElementById('ciPrincipal').value) || 0;
  const r = (parseFloat(document.getElementById('ciRate').value) || 0) / 100;
  const n = parseFloat(document.getElementById('ciYears').value) || 0;
  const freq = parseInt(document.getElementById('ciFreq').value) || 12;
  const FV = P * Math.pow(1 + r/freq, freq * n);
  const interest = FV - P;
  const EAR = (Math.pow(1 + r/freq, freq) - 1) * 100;
  const doubling = r > 0 ? (72 / (r * 100)).toFixed(1) : '∞';
  document.getElementById('ciFV').textContent = fmtINR(FV);
  document.getElementById('ciInterest').textContent = fmtINR(interest);
  document.getElementById('ciEAR').textContent = EAR.toFixed(3) + '%';
  document.getElementById('ciDouble').textContent = doubling + ' years';
  const breakdown = document.getElementById('ciYearBreakdown');
  let rows = '';
  for (let y = 1; y <= Math.min(n, 20); y++) {
    const yv = P * Math.pow(1 + r/freq, freq * y);
    rows += `<div style="display:flex;justify-content:space-between;font-size:12px;padding:4px 0;border-bottom:1px solid var(--border);color:var(--text2)"><span style="color:var(--text3)">Year ${y}</span><span style="font-family:var(--font-mono)">${fmtINR(yv)}</span><span style="color:var(--green);font-family:var(--font-mono)">+${fmtINR(yv-P)}</span></div>`;
  }
  breakdown.innerHTML = rows;
}

// ══════════════════════════════════════════════
// SETTINGS & USER PROFILE
// ══════════════════════════════════════════════
let userSettings = { name:'', currency:'₹', capital:100000, risk:1, onboarded:false, demoCleared:false, lastExport:null };

function loadSettings() {
  try { const s = JSON.parse(localStorage.getItem('tj_settings')||'{}'); userSettings = {...userSettings,...s}; } catch(e) {}
  applySettings();
}

function saveSettings() {
  userSettings.name     = (document.getElementById('settingName')?.value||'').trim();
  userSettings.currency = document.getElementById('settingCurrency')?.value||'₹';
  userSettings.capital  = parseFloat(document.getElementById('settingCapital')?.value)||100000;
  userSettings.risk     = parseFloat(document.getElementById('settingRisk')?.value)||1;
  localStorage.setItem('tj_settings', JSON.stringify(userSettings));
  _calcInited = false; // allow calculators to re-seed with updated capital/currency
  applySettings();
  showToast('Settings saved ✓', 'success');
}

function applySettings() {
  const greet = document.getElementById('greetingSpan');
  if (greet && userSettings.name) {
    const h = new Date().getHours();
    const tod = h<12?'🌅 Morning':h<17?'☀️ Afternoon':'🌙 Evening';
    greet.textContent = `${tod}, ${userSettings.name}`;
  } else if (greet) { greet.textContent=''; }
  const sn=document.getElementById('settingName'), sc=document.getElementById('settingCurrency'),
        sk=document.getElementById('settingCapital'), sr=document.getElementById('settingRisk');
  if(sn&&sn!==document.activeElement) sn.value=userSettings.name;
  if(sc) sc.value=userSettings.currency;
  if(sk&&sk!==document.activeElement) sk.value=userSettings.capital;
  if(sr&&sr!==document.activeElement) sr.value=userSettings.risk;
  const rcA=document.getElementById('rc-account'); if(rcA&&!rcA.value) rcA.value=userSettings.capital;
  const evA=document.getElementById('ev-account'); if(evA&&!evA.value) evA.value=userSettings.capital;
  // Update risk% default
  const rcR=document.getElementById('rc-riskpct'); if(rcR&&!rcR.value) rcR.value=userSettings.risk;
}

function openSettings() {
  document.getElementById('settingsPanel').style.right='0';
  document.getElementById('settingsOverlay').style.display='block';
  applySettings();
}
function closeSettings() {
  document.getElementById('settingsPanel').style.right='-380px';
  document.getElementById('settingsOverlay').style.display='none';
}
function remindBackup() { closeSettings(); showToast('💾 Use Settings → Export CSV to backup your trades monthly','info'); }

// Currency-aware formatter (replaces fmtINR)
function fmtCurrency(n) {
  if (isNaN(n) || n === undefined || n === null) return '—';
  const sym = (typeof userSettings !== 'undefined' && userSettings.currency) || '₹';
  const abs = Math.abs(n);
  if (sym==='₹') {
    if(abs>=1e7) return sym+(n/1e7).toFixed(2)+' Cr';
    if(abs>=1e5) return sym+(n/1e5).toFixed(2)+' L';
    if(abs>=1000) return sym+(n/1000).toFixed(1)+'K';
    return sym+Math.round(n).toLocaleString('en-IN');
  } else {
    if(abs>=1e9) return sym+(n/1e9).toFixed(2)+'B';
    if(abs>=1e6) return sym+(n/1e6).toFixed(2)+'M';
    if(abs>=1000) return sym+(n/1000).toFixed(1)+'K';
    return sym+Math.abs(n).toFixed(2);
  }
}
// fmtINR is now currency-aware via fmtCurrency (see fmtCurrency function above)

// ══════════════════════════════════════════════
// ONBOARDING
// ══════════════════════════════════════════════
function checkOnboarding() {
  if (!userSettings.onboarded) {
    const ov=document.getElementById('onboardingOverlay');
    if(ov){ ov.style.display='flex'; setTimeout(()=>document.getElementById('onboardNameInput')?.focus(),300); }
  } else {
    showDemoBannerIfNeeded();
    checkBackupReminder();
  }
}

function finishOnboarding() {
  const n=document.getElementById('onboardNameInput')?.value.trim()||'Trader';
  const c=document.getElementById('onboardCurrency')?.value||'₹';
  userSettings.name=n; userSettings.currency=c; userSettings.onboarded=true;
  localStorage.setItem('tj_settings',JSON.stringify(userSettings));
  const ov=document.getElementById('onboardingOverlay'); if(ov) ov.style.display='none';
  applySettings(); showDemoBannerIfNeeded();
  showToast(`Welcome, ${n}! 🚀 Demo trades loaded — explore or clear them to start fresh.`,'success');
}

const DEMO_SYMBOLS = ['RELIANCE','AAPL','EUR/USD','BTC/USDT','GOLD/USD','US100','NVDA','CRUDE OIL','SPY','TCS','ETH/USDT','US300','GBP/USD','SILVER/USD','/ES'];

function showDemoBannerIfNeeded() {
  if (userSettings.demoCleared) return;
  const isDemoOnly = allTrades.length>0 && allTrades.every(t=>DEMO_SYMBOLS.includes(t.symbol));
  const b=document.getElementById('demoBanner'); if(b) b.style.display=isDemoOnly?'flex':'none';
}

async function clearDemoData() {
  showConfirm('🗑️ Clear Demo Trades?','Remove all pre-loaded demo trades to start fresh with real trades.',
    async()=>{
      for(const t of [...allTrades]) if(DEMO_SYMBOLS.includes(t.symbol)) await deleteTrade(t.id);
      userSettings.demoCleared=true; localStorage.setItem('tj_settings',JSON.stringify(userSettings));
      const b=document.getElementById('demoBanner'); if(b) b.style.display='none';
      await refresh(); showToast('Demo cleared. Add your first real trade! 🎯','success');
    },'🗑️','Clear Demo Trades','var(--accent)');
}

// ══════════════════════════════════════════════
// CONFIRM DIALOG (replaces native confirm())
// ══════════════════════════════════════════════
let _confirmCb = null;
function showConfirm(title, msg, onOk, icon='⚠️', btnLabel='Confirm', btnColor='var(--red)') {
  document.getElementById('confirmIcon').textContent=icon;
  document.getElementById('confirmTitle').textContent=title;
  document.getElementById('confirmMsg').textContent=msg;
  const okBtn=document.getElementById('confirmOkBtn');
  okBtn.textContent=btnLabel; okBtn.style.background=btnColor;
  _confirmCb=onOk;
  const d=document.getElementById('confirmDialog'); d.style.display='flex';
  setTimeout(()=>okBtn.focus(),50);
}
function executeConfirm(){ closeConfirm(); if(_confirmCb){_confirmCb();_confirmCb=null;} }
function closeConfirm(){ document.getElementById('confirmDialog').style.display='none'; _confirmCb=null; }

// ══════════════════════════════════════════════
// CLEAR ALL DATA
// ══════════════════════════════════════════════
async function clearAllData() {
  closeSettings();
  showConfirm('💣 Delete ALL Data?',
    'Permanently deletes every trade, setting, and checklist. Export first — this CANNOT be undone.',
    async()=>{
      for(const t of [...allTrades]) await deleteTrade(t.id);
      localStorage.clear();
      showToast('All data cleared ✨','info');
      setTimeout(()=>location.reload(),1500);
    },'💣','Delete Everything','var(--red)');
}

// ══════════════════════════════════════════════
// BACKUP REMINDER
// ══════════════════════════════════════════════
function checkBackupReminder() {
  if (!userSettings.lastExport || !allTrades.length) return;
  const days=(Date.now()-new Date(userSettings.lastExport).getTime())/86400000;
  if(days>30) setTimeout(()=>showToast("💾 30 days since last export. Go Settings → Export CSV!",'info'),3000);
}

// Patch exportTrades to track last export
const _origExport = typeof exportTrades==='function' ? exportTrades : null;
if(_origExport) {
  window.exportTrades = function(){
    _origExport();
    userSettings.lastExport=new Date().toISOString();
    localStorage.setItem('tj_settings',JSON.stringify(userSettings));
  };
}
document.addEventListener('keydown',e=>{ if((e.metaKey||e.ctrlKey)&&e.key==='e'){e.preventDefault();exportTrades();} });

// ══════════════════════════════════════════════
// PWA — INSTALL PROMPT + SERVICE WORKER
// ══════════════════════════════════════════════
let _deferredInstall=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault(); _deferredInstall=e;
  if(!localStorage.getItem('tj_pwa_dismissed')) {
    const b=document.getElementById('installBanner'); if(b) b.style.display='flex';
  }
});
async function doInstall(){
  if(!_deferredInstall) return;
  _deferredInstall.prompt();
  const {outcome}=await _deferredInstall.userChoice;
  _deferredInstall=null;
  document.getElementById('installBanner').style.display='none';
  if(outcome==='accepted') showToast('App installed! Launch from home screen 🎉','success');
  localStorage.setItem('tj_pwa_dismissed','1');
}
window.addEventListener('appinstalled',()=>{
  document.getElementById('installBanner').style.display='none';
  showToast('Trading Journal installed 📱','success');
});

// Service worker via blob (works on GitHub Pages)
if('serviceWorker' in navigator){
  const SW=`
const VER='tj-v2';
const FILES=[self.registration.scope];
self.addEventListener('install',e=>{
  e.waitUntil(caches.open(VER).then(c=>c.addAll(FILES)).then(()=>self.skipWaiting()));
});
self.addEventListener('activate',e=>{
  e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==VER).map(k=>caches.delete(k)))).then(()=>self.clients.claim()));
});
self.addEventListener('fetch',e=>{
  if(e.request.method!=='GET') return;
  e.respondWith(caches.match(e.request).then(hit=>{
    const net=fetch(e.request).then(r=>{ if(r.ok) caches.open(VER).then(c=>c.put(e.request,r.clone())); return r; }).catch(()=>hit);
    return hit||net;
  }));
});`;
  const swURL=URL.createObjectURL(new Blob([SW],{type:'text/javascript'}));
  navigator.serviceWorker.register(swURL,{scope:'./'}).catch(()=>{});
}

// PWA manifest blob
(()=>{
  const M={name:'Zen Journal',short_name:'Zen',description:'Private, offline-ready trade journal',
    start_url:'./',display:'standalone',background_color:'#0a0a0f',theme_color:'#0a0a0f',
    icons:[
      {src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='28' fill='%230a0a0f'/%3E%3Ctext y='145' x='16' font-size='130' font-family='monospace' fill='%237c6dfa'%3ETJ%3C/text%3E%3C/svg%3E",sizes:'192x192',type:'image/svg+xml',purpose:'any maskable'},
      {src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='64' fill='%230a0a0f'/%3E%3Ctext y='385' x='38' font-size='340' font-family='monospace' fill='%237c6dfa'%3ETJ%3C/text%3E%3C/svg%3E",sizes:'512x512',type:'image/svg+xml',purpose:'any maskable'}
    ]};
  const lnk=document.createElement('link'); lnk.rel='manifest';
  lnk.href=URL.createObjectURL(new Blob([JSON.stringify(M)],{type:'application/json'}));
  document.head.appendChild(lnk);
})();

// ══════════════════════════════════════════════
// ZEN FEATURES — Daily Review, Breath Gate, Streaks
// ══════════════════════════════════════════════

// ─── Journal DB (for daily reviews) ────────────────────────────────
const JOURNAL_DB_NAME = 'TradingJournalZen';
let journalDb = null;

function initJournalDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(JOURNAL_DB_NAME, 1);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('reviews')) {
        d.createObjectStore('reviews', { keyPath: 'date' });
      }
      if (!d.objectStoreNames.contains('sitouts')) {
        d.createObjectStore('sitouts', { keyPath: 'date' });
      }
    };
    req.onsuccess = e => { journalDb = e.target.result; resolve(); };
    req.onerror = e => reject(e);
  });
}

function saveReview(review) {
  return new Promise((resolve, reject) => {
    if (!journalDb) { resolve(); return; }
    const tx = journalDb.transaction('reviews', 'readwrite');
    tx.objectStore('reviews').put(review).onsuccess = () => resolve();
    tx.onerror = e => reject(e);
  });
}

function getAllReviews() {
  return new Promise((resolve) => {
    if (!journalDb) { resolve([]); return; }
    const tx = journalDb.transaction('reviews', 'readonly');
    tx.objectStore('reviews').getAll().onsuccess = e => resolve(e.target.result || []);
  });
}

function getReviewByDate(date) {
  return new Promise((resolve) => {
    if (!journalDb) { resolve(null); return; }
    const tx = journalDb.transaction('reviews', 'readonly');
    const req = tx.objectStore('reviews').get(date);
    req.onsuccess = e => resolve(e.target.result || null);
    req.onerror = () => resolve(null);
  });
}

function getSitOutCount() {
  return new Promise((resolve) => {
    if (!journalDb) { resolve(0); return; }
    const tx = journalDb.transaction('sitouts', 'readonly');
    tx.objectStore('sitouts').count().onsuccess = e => resolve(e.target.result || 0);
  });
}

function addSitOut(date) {
  return new Promise((resolve) => {
    if (!journalDb) { resolve(); return; }
    const tx = journalDb.transaction('sitouts', 'readwrite');
    tx.objectStore('sitouts').put({ date }).onsuccess = () => resolve();
  });
}

// ─── Daily Review ────────────────────────────────────────────────────
let drSelectedEmotions = [];

function initDailyReview() {
  const today = new Date().toISOString().split('T')[0];
  const dateEl = document.getElementById('dr-date');
  if (dateEl) {
    dateEl.value = today;
    dateEl.addEventListener('change', () => loadDailyReview(dateEl.value));
  }
  loadDailyReview(today);
}

async function loadDailyReview(date) {
  const review = await getReviewByDate(date);
  drSelectedEmotions = [];

  // Reset emotion tags
  document.querySelectorAll('#dr-emotion-grid .emotion-tag').forEach(t => t.classList.remove('selected'));

  if (review) {
    document.getElementById('dr-good').value = review.good || '';
    document.getElementById('dr-force').value = review.force || '';
    document.getElementById('dr-tomorrow').value = review.tomorrow || '';
    document.getElementById('dr-mindnotes').value = review.mindnotes || '';
    drSelectedEmotions = review.emotions || [];
    drSelectedEmotions.forEach(em => {
      const tag = document.querySelector(`#dr-emotion-grid [data-emotion="${em}"]`);
      if (tag) tag.classList.add('selected');
    });
  } else {
    ['dr-good','dr-force','dr-tomorrow','dr-mindnotes'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
  }

  renderDrTodayStats(date);
  renderPastReviews();
  renderEmotionPattern();
}

async function saveDailyReview() {
  const date = document.getElementById('dr-date').value;
  if (!date) { showToast('Select a date first', 'error'); return; }

  const review = {
    date,
    good: document.getElementById('dr-good').value.trim(),
    force: document.getElementById('dr-force').value.trim(),
    tomorrow: document.getElementById('dr-tomorrow').value.trim(),
    mindnotes: document.getElementById('dr-mindnotes').value.trim(),
    emotions: [...drSelectedEmotions],
    savedAt: new Date().toISOString()
  };

  await saveReview(review);
  showToast('Review saved 🪷', 'success');
  renderPastReviews();
  renderEmotionPattern();
}

function toggleEmotion(el) {
  const emotion = el.dataset.emotion;
  if (el.classList.contains('selected')) {
    el.classList.remove('selected');
    drSelectedEmotions = drSelectedEmotions.filter(e => e !== emotion);
  } else {
    el.classList.add('selected');
    drSelectedEmotions.push(emotion);
  }
}

let tradeSelectedEmotions = [];

function toggleTradeEmotion(el) {
  const emotion = el.dataset.emotion;
  if (el.classList.contains('selected')) {
    el.classList.remove('selected');
    tradeSelectedEmotions = tradeSelectedEmotions.filter(e => e !== emotion);
  } else {
    el.classList.add('selected');
    tradeSelectedEmotions.push(emotion);
  }
}

function renderDrTodayStats(date) {
  const el = document.getElementById('dr-today-stats');
  if (!el) return;
  const dayTrades = allTrades.filter(t => t.date === date);
  if (!dayTrades.length) {
    el.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text3);font-size:13px">No trades logged on this date</div>';
    return;
  }
  const pnls = dayTrades.map(calcPnL);
  const total = pnls.reduce((a,b)=>a+b,0);
  const wins = pnls.filter(p=>p>0).length;
  el.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div style="background:var(--bg3);border-radius:8px;padding:12px;text-align:center">
        <div style="font-size:10px;color:var(--text3);margin-bottom:4px">P&L</div>
        <div style="font-family:var(--font-mono);font-size:18px;color:${total>=0?'var(--green)':'var(--red)'}">${fmt$(total)}</div>
      </div>
      <div style="background:var(--bg3);border-radius:8px;padding:12px;text-align:center">
        <div style="font-size:10px;color:var(--text3);margin-bottom:4px">Trades</div>
        <div style="font-family:var(--font-mono);font-size:18px">${dayTrades.length}</div>
      </div>
      <div style="background:var(--bg3);border-radius:8px;padding:12px;text-align:center">
        <div style="font-size:10px;color:var(--text3);margin-bottom:4px">Win Rate</div>
        <div style="font-family:var(--font-mono);font-size:18px">${dayTrades.length ? Math.round(wins/dayTrades.length*100) : 0}%</div>
      </div>
      <div style="background:var(--bg3);border-radius:8px;padding:12px;text-align:center">
        <div style="font-size:10px;color:var(--text3);margin-bottom:4px">Best</div>
        <div style="font-family:var(--font-mono);font-size:18px;color:var(--green)">${fmt$(Math.max(...pnls))}</div>
      </div>
    </div>
  `;
}

async function renderPastReviews() {
  const el = document.getElementById('dr-past-list');
  if (!el) return;
  const reviews = await getAllReviews();
  reviews.sort((a,b) => b.date.localeCompare(a.date));
  if (!reviews.length) {
    el.innerHTML = '<div style="padding:16px;text-align:center;font-size:13px;color:var(--text3)">No reviews yet</div>';
    return;
  }
  el.innerHTML = reviews.slice(0, 10).map(r => `
    <div onclick="loadAndScrollReview('${r.date}')" style="padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='none'">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
        <div style="font-family:var(--font-mono);font-size:12px;color:var(--text2)">${r.date}</div>
        <div style="display:flex;gap:4px;flex-wrap:wrap">
          ${(r.emotions||[]).slice(0,3).map(e => `<span style="font-size:9px;padding:1px 6px;background:var(--bg4);border-radius:10px;color:var(--text3)">${e}</span>`).join('')}
        </div>
      </div>
      <div style="font-size:12px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${r.good || r.force || '—'}</div>
    </div>
  `).join('');
}

function loadAndScrollReview(date) {
  const dateEl = document.getElementById('dr-date');
  if (dateEl) dateEl.value = date;
  loadDailyReview(date);
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function renderEmotionPattern() {
  const el = document.getElementById('emotion-pattern-chart');
  if (!el) return;
  const reviews = await getAllReviews();
  if (reviews.length < 3) return;

  // Count emotions across reviews
  const counts = {};
  reviews.forEach(r => {
    (r.emotions || []).forEach(em => {
      counts[em] = (counts[em] || 0) + 1;
    });
  });

  const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0, 8);
  if (!sorted.length) return;

  const positiveEmotions = ['Calm','Focused','Confident','Patient','Disciplined'];
  const maxCount = sorted[0][1];

  el.innerHTML = sorted.map(([em, count]) => {
    const isPositive = positiveEmotions.includes(em);
    const pct = Math.round(count / maxCount * 100);
    const color = isPositive ? 'var(--green)' : 'var(--red)';
    return `
      <div style="display:grid;grid-template-columns:110px 1fr 30px;gap:8px;align-items:center;margin-bottom:10px">
        <div style="font-size:12px;color:var(--text2)">${em}</div>
        <div style="background:var(--bg3);border-radius:4px;height:6px;overflow:hidden">
          <div style="height:100%;width:${pct}%;background:${color};border-radius:4px;transition:width 0.8s ease"></div>
        </div>
        <div style="font-family:var(--font-mono);font-size:11px;color:var(--text3);text-align:right">${count}</div>
      </div>
    `;
  }).join('');
}

// ─── Sit Out Counter ────────────────────────────────────────────────
async function renderSitOutCount() {
  const count = await getSitOutCount();
  const el = document.getElementById('sitout-count');
  if (el) el.textContent = count;
}

async function logSitOut() {
  const today = new Date().toISOString().split('T')[0];
  await addSitOut(today);
  await renderSitOutCount();
  showToast('Sit-out logged. Capital protected. 🧘', 'success');
}

// ─── Breath Gate ────────────────────────────────────────────────────
function initBreathGate() {
  const gate = document.getElementById('breathGate');
  const countdown = document.getElementById('breathCountdown');
  if (!gate || !countdown) { saveTrade(); return; }

  gate.classList.add('open');
  let count = 3;
  countdown.textContent = `Saving in ${count}...`;
  const interval = setInterval(() => {
    count--;
    if (count > 0) {
      countdown.textContent = `Saving in ${count}...`;
    } else {
      clearInterval(interval);
      gate.classList.remove('open');
      saveTrade();
    }
  }, 1000);

  // Allow early save on click
  gate.onclick = () => {
    clearInterval(interval);
    gate.classList.remove('open');
    gate.onclick = null;
    saveTrade();
  };
}

// ─── Streak Warning ────────────────────────────────────────────────
function checkStreakWarning() {
  if (!allTrades.length) return;
  const sorted = [...allTrades].sort((a,b) => new Date(b.date)-new Date(a.date));
  let streak = 0;
  for (const t of sorted) {
    if (calcPnL(t) < 0) streak++;
    else break;
  }

  const panel = document.getElementById('streak-warning-panel');
  const text = document.getElementById('streak-warning-text');
  if (!panel || !text) return;

  if (streak >= 3) {
    panel.style.display = 'block';
    const msgs = {
      3: `You have ${streak} consecutive losses. Consider reducing position size or taking a short break to review your setups.`,
      5: `${streak} consecutive losses. This is a signal, not noise. Step back, review your last trades, and ask: am I in the right conditions to trade?`,
      7: `${streak} consecutive losses. The market may be telling you something. Taking a break is not weakness — it is wisdom.`,
    };
    const threshold = streak >= 7 ? 7 : streak >= 5 ? 5 : 3;
    text.textContent = msgs[threshold];
  } else {
    panel.style.display = 'none';
  }
}

// ─── Zen Quotes ────────────────────────────────────────────────────
const ZEN_QUOTES = [
  { icon:'🌊', text:'The market is always right. Your opinion of where it should go is irrelevant.' },
  { icon:'🍃', text:'Do nothing when there is nothing to do. Patience is not inaction — it is mastery.' },
  { icon:'🏔️', text:'A trade taken out of boredom is a tax on undisciplined attention.' },
  { icon:'🌙', text:'Review with curiosity, not judgment. Your past trades are teachers, not failures.' },
  { icon:'🌱', text:'Process over outcome. A good trade can lose. A bad trade can win. Only the process compounds.' },
  { icon:'🌊', text:'Cut losses quickly, not because you were wrong, but because preserving capital is the point.' },
  { icon:'🎯', text:'The best traders take fewer trades, not more. Edge is rare. Honor it when you see it.' },
  { icon:'🧘', text:'Sitting out is a position. Sometimes it is the best position available.' },
  { icon:'🌿', text:'Your stop loss is your promise to yourself. Keep it.' },
  { icon:'🔮', text:'Every loss contains a lesson. Every win contains a risk of overconfidence.' },
];

let zenIdx = Math.floor(Math.random() * ZEN_QUOTES.length);

function renderZenQuote() {
  const q = ZEN_QUOTES[zenIdx];
  const iconEl = document.getElementById('zen-icon');
  const textEl = document.getElementById('zen-quote');
  if (iconEl) iconEl.textContent = q.icon;
  if (textEl) textEl.textContent = q.text;
}

function nextZenQuote() {
  zenIdx = (zenIdx + 1) % ZEN_QUOTES.length;
  renderZenQuote();
}

// ─── Patch switchView to init Daily Review when navigating to it ──
const _origSwitchView = switchView;
window.switchView = function(name) {
  _origSwitchView(name);
  if (name === 'dailyreview') {
    initDailyReview();
    checkStreakWarning();
    renderSitOutCount();
  }
  if (name === 'livemarkets') {
    setTimeout(() => {
      refreshLiveMarkets();
      renderFOChainDemo();
      if (LiveData.hasFinnhub()) {
        const dot = document.getElementById('conn-fh-dot');
        if (dot) dot.className = 'lm-conn-dot live';
      }
    }, 80);
  }
};

// ─── saveTrade — canonical implementation with emotion state & streak check ─
async function saveTrade() {
  const emotions = [...tradeSelectedEmotions];

  const symbol = document.getElementById('f-symbol').value.trim().toUpperCase();
  if (!symbol) { showToast('Symbol is required', 'error'); return; }
  const entry = parseFloat(document.getElementById('f-entry').value);
  const exit = parseFloat(document.getElementById('f-exit').value);
  if (isNaN(entry) || isNaN(exit)) { showToast('Entry and exit prices are required', 'error'); return; }

  const trade = {
    symbol,
    date: document.getElementById('f-date').value || new Date().toISOString().split('T')[0],
    market: document.getElementById('f-market').value,
    direction: selectedDir,
    entry, exit,
    qty: parseFloat(document.getElementById('f-qty').value) || 1,
    stop: parseFloat(document.getElementById('f-stop').value) || null,
    fees: parseFloat(document.getElementById('f-fees').value) || 0,
    setup: document.getElementById('f-setup').value.trim(),
    notes: document.getElementById('f-notes').value.trim(),
    emotions,
  };

  if (editingId) {
    trade.id = editingId;
    await updateTrade(trade);
    showToast('Trade updated', 'success');
  } else {
    await addTrade(trade);
    showToast('Trade saved ✓', 'success');
  }

  closeModal();
  tradeSelectedEmotions = [];
  document.querySelectorAll('#trade-emotion-grid .emotion-tag').forEach(t => t.classList.remove('selected'));
  await refresh();
  checkStreakWarning();
}


</script>

</div>

<!-- ══ ONBOARDING OVERLAY ══ -->
<div id="onboardingOverlay" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.94);backdrop-filter:blur(12px);align-items:center;justify-content:center;padding:20px">
  <div style="background:var(--bg2);border:1px solid var(--border2);border-radius:20px;padding:36px 32px;max-width:500px;width:100%;text-align:center;animation:fadeSlideUp 0.4s ease">
    <div style="font-size:48px;margin-bottom:12px">禅</div>
    <div style="font-family:var(--font-head);font-size:26px;font-weight:800;margin-bottom:8px">Welcome to <span style="color:var(--accent2)">ZenJournal</span></div>
    <div style="font-size:14px;color:var(--text2);line-height:1.7;margin-bottom:24px">Your private, offline-ready trading & investing journal.<br>All data stays on <strong style="color:var(--text)">your device only</strong> — nothing is sent to any server.</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:28px;text-align:left">
      <div style="background:var(--bg3);border-radius:10px;padding:12px 14px;font-size:12px;color:var(--text2);display:flex;align-items:center;gap:8px"><span style="font-size:20px">📋</span>Log every trade with full detail</div>
      <div style="background:var(--bg3);border-radius:10px;padding:12px 14px;font-size:12px;color:var(--text2);display:flex;align-items:center;gap:8px"><span style="font-size:20px">📊</span>Analytics, P&L and equity curve</div>
      <div style="background:var(--bg3);border-radius:10px;padding:12px 14px;font-size:12px;color:var(--text2);display:flex;align-items:center;gap:8px"><span style="font-size:20px">🛡️</span>Risk calc, position sizing, EV</div>
      <div style="background:var(--bg3);border-radius:10px;padding:12px 14px;font-size:12px;color:var(--text2);display:flex;align-items:center;gap:8px"><span style="font-size:20px">🧮</span>SIP, FIRE, loan & wealth calcs</div>
      <div style="background:var(--bg3);border-radius:10px;padding:12px 14px;font-size:12px;color:var(--text2);display:flex;align-items:center;gap:8px"><span style="font-size:20px">🌅</span>Pre & post market checklists</div>
      <div style="background:var(--bg3);border-radius:10px;padding:12px 14px;font-size:12px;color:var(--text2);display:flex;align-items:center;gap:8px"><span style="font-size:20px">💡</span>Philosophy, rules & psychology</div>
    </div>
    <div style="margin-bottom:16px">
      <div style="font-size:12px;color:var(--text3);margin-bottom:8px">What should we call you?</div>
      <input id="onboardNameInput" type="text" placeholder="Your name or nickname" maxlength="30"
        style="width:100%;background:var(--bg3);border:1px solid var(--border2);border-radius:10px;color:var(--text);font-family:var(--font-body);font-size:15px;padding:11px 16px;outline:none;text-align:center;margin-bottom:8px"
        onkeydown="if(event.key==='Enter')finishOnboarding()">
      <div style="font-size:12px;color:var(--text3);margin-bottom:4px">Currency preference</div>
      <select id="onboardCurrency" style="background:var(--bg3);border:1px solid var(--border2);border-radius:10px;color:var(--text);font-family:var(--font-body);font-size:14px;padding:9px 16px;outline:none;width:100%;text-align:center">
        <option value="₹">₹ Indian Rupee (INR)</option>
        <option value="$">$ US Dollar (USD)</option>
        <option value="€">€ Euro (EUR)</option>
        <option value="£">£ British Pound (GBP)</option>
        <option value="¥">¥ Japanese Yen (JPY)</option>
        <option value="A$">A$ Australian Dollar (AUD)</option>
        <option value="S$">S$ Singapore Dollar (SGD)</option>
        <option value="AED">AED UAE Dirham</option>
      </select>
    </div>
    <button class="btn btn-primary" onclick="finishOnboarding()" style="width:100%;padding:13px;font-size:15px;font-weight:700">Start My Journal 🚀</button>
    <div style="font-size:11px;color:var(--text3);margin-top:14px;line-height:1.6">Demo trades are pre-loaded so you can explore.<br>Export your trades anytime as CSV for backup.</div>
  </div>
</div>

<!-- ══ SETTINGS PANEL ══ -->
<div id="settingsOverlay" onclick="closeSettings()" style="display:none;position:fixed;inset:0;z-index:199;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px)"></div>
<div id="settingsPanel" style="position:fixed;top:0;right:-380px;width:340px;height:100vh;background:var(--bg2);border-left:1px solid var(--border);z-index:200;transition:right 0.3s ease;overflow-y:auto;padding:24px 20px;box-sizing:border-box">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px">
    <div style="font-family:var(--font-head);font-size:18px;font-weight:700">⚙️ Settings</div>
    <button onclick="closeSettings()" style="background:none;border:none;color:var(--text3);font-size:22px;cursor:pointer">×</button>
  </div>

  <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:10px">PROFILE</div>
  <div style="margin-bottom:20px">
    <div style="font-size:12px;color:var(--text3);margin-bottom:5px">Your name</div>
    <input id="settingName" type="text" placeholder="Name or nickname" maxlength="30"
      style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);color:var(--text);font-family:var(--font-body);font-size:13px;padding:9px 12px;outline:none;box-sizing:border-box"
      oninput="saveSettings()">
    <div style="font-size:12px;color:var(--text3);margin:10px 0 5px">Currency symbol</div>
    <select id="settingCurrency" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);color:var(--text);font-family:var(--font-body);font-size:13px;padding:9px 12px;outline:none;cursor:pointer;box-sizing:border-box" onchange="saveSettings();applySettings()">
      <option value="₹">₹ Rupee (INR)</option>
      <option value="$">$ Dollar (USD)</option>
      <option value="€">€ Euro (EUR)</option>
      <option value="£">£ Pound (GBP)</option>
      <option value="¥">¥ Yen (JPY)</option>
      <option value="A$">A$ AUD</option>
      <option value="S$">S$ SGD</option>
      <option value="AED">AED Dirham</option>
    </select>
    <div style="font-size:12px;color:var(--text3);margin:10px 0 5px">Account capital</div>
    <input id="settingCapital" type="number" placeholder="e.g. 500000"
      style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);color:var(--text);font-family:var(--font-body);font-size:13px;padding:9px 12px;outline:none;box-sizing:border-box"
      oninput="saveSettings()">
    <div style="font-size:12px;color:var(--text3);margin:10px 0 5px">Default risk per trade (%)</div>
    <input id="settingRisk" type="number" step="0.1" min="0.1" max="10" placeholder="e.g. 1"
      style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);color:var(--text);font-family:var(--font-body);font-size:13px;padding:9px 12px;outline:none;box-sizing:border-box"
      oninput="saveSettings()">
  </div>

  <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:10px">DATA</div>
  <div style="margin-bottom:20px;display:flex;flex-direction:column;gap:8px">
    <button class="btn btn-ghost" onclick="exportTrades()" style="width:100%;justify-content:center">↓ Export All Trades (CSV)</button>
    <button class="btn btn-ghost" onclick="document.getElementById('importBtn').click()" style="width:100%;justify-content:center">↑ Import Trades (CSV)</button>
    <button class="btn btn-ghost" onclick="remindBackup()" style="width:100%;justify-content:center">📅 Set Backup Reminder</button>
  </div>

  <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:10px">KEYBOARD SHORTCUTS</div>
  <div style="margin-bottom:20px;font-size:12px;color:var(--text3);display:flex;flex-direction:column;gap:6px">
    <div style="display:flex;justify-content:space-between"><span>New trade</span><code style="background:var(--bg3);padding:2px 7px;border-radius:4px;color:var(--text2)">Ctrl/⌘ + N</code></div>
    <div style="display:flex;justify-content:space-between"><span>Close modal</span><code style="background:var(--bg3);padding:2px 7px;border-radius:4px;color:var(--text2)">Esc</code></div>
    <div style="display:flex;justify-content:space-between"><span>Export CSV</span><code style="background:var(--bg3);padding:2px 7px;border-radius:4px;color:var(--text2)">Ctrl/⌘ + E</code></div>
  </div>

  <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:10px">DANGER ZONE</div>
  <div style="background:rgba(248,113,113,0.06);border:1px solid rgba(248,113,113,0.2);border-radius:var(--radius2);padding:14px;margin-bottom:24px">
    <div style="font-size:12px;color:var(--text3);margin-bottom:10px;line-height:1.5">Permanently delete all trades and reset your journal. This cannot be undone — export first!</div>
    <button class="btn" onclick="clearAllData()" style="width:100%;background:rgba(248,113,113,0.15);border:1px solid rgba(248,113,113,0.3);color:var(--red);justify-content:center;font-size:13px">🗑️ Clear All Data & Reset</button>
  </div>

  <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:8px">ABOUT</div>
  <div style="font-size:12px;color:var(--text3);line-height:1.6">
    Zen Trading Journal v8.0<br>
    All data stored locally on your device.<br>
    No accounts. No cloud. No noise.<br><br>
    <em style="color:var(--text3)">Presence · Process · Progress</em>
  </div>
</div>

<!-- ══ CONFIRM DIALOG ══ -->
<div id="confirmDialog" style="display:none;position:fixed;inset:0;z-index:500;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);padding:20px">
  <div style="background:var(--bg2);border:1px solid var(--border2);border-radius:16px;padding:28px;max-width:340px;width:100%;text-align:center;animation:fadeSlideUp 0.2s ease">
    <div id="confirmIcon" style="font-size:36px;margin-bottom:12px">⚠️</div>
    <div id="confirmTitle" style="font-family:var(--font-head);font-size:17px;font-weight:700;margin-bottom:8px"></div>
    <div id="confirmMsg" style="font-size:13px;color:var(--text3);margin-bottom:24px;line-height:1.6"></div>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn btn-ghost" onclick="closeConfirm()" style="flex:1;justify-content:center">Cancel</button>
      <button id="confirmOkBtn" class="btn" onclick="executeConfirm()" style="flex:1;background:var(--red);color:white;border:none;justify-content:center">Confirm</button>
    </div>
  </div>
</div>

<style>
@keyframes fadeSlideUp {
  from { opacity:0; transform:translateY(16px); }
  to   { opacity:1; transform:none; }
}
#onboardingOverlay { display:none; }
#onboardingOverlay.open { display:flex !important; }
#installBanner.visible { display:flex !important; }

/* ══════════════════════════════════════════
   QUANT LAB & DECISION ENGINE STYLES
══════════════════════════════════════════ */
.ql-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
.ql-full { grid-column: 1/-1; }
.ql-section-title { font-family: var(--font-head); font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text3); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
.stress-card { background: var(--bg3); border-radius: var(--radius2); padding: 16px; border: 1px solid var(--border); position: relative; overflow: hidden; }
.stress-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
.stress-card.crisis::before { background: var(--red); }
.stress-card.moderate::before { background: var(--yellow); }
.stress-card.recovery::before { background: var(--green); }
.factor-row { display: grid; grid-template-columns: 130px 1fr 60px 70px; gap: 10px; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
.factor-row:last-child { border-bottom: none; }
.metric-trio { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.metric-box { background: var(--bg3); border-radius: var(--radius2); padding: 16px; text-align: center; border: 1px solid var(--border); }
.metric-box-val { font-family: var(--font-mono); font-size: 24px; font-weight: 400; margin-bottom: 4px; }
.metric-box-lbl { font-size: 11px; color: var(--text3); }
.metric-box-sub { font-size: 10px; color: var(--text3); margin-top: 3px; }
.de-score-ring { width: 160px; height: 160px; position: relative; margin: 0 auto 20px; }
.de-score-ring svg { transform: rotate(-90deg); overflow: visible; }
.de-score-center { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.de-score-val { font-family: var(--font-mono); font-size: 42px; font-weight: 300; line-height: 1; }
.de-score-lbl { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.1em; margin-top: 4px; }
.de-verdict { display: inline-block; padding: 8px 24px; border-radius: 50px; font-family: var(--font-head); font-size: 16px; font-weight: 800; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 12px; }
.de-verdict.go { background: rgba(74,222,128,0.12); color: var(--green); border: 1px solid rgba(74,222,128,0.25); }
.de-verdict.nogo { background: rgba(248,113,113,0.12); color: var(--red); border: 1px solid rgba(248,113,113,0.25); }
.de-verdict.caution { background: rgba(251,191,36,0.12); color: var(--yellow); border: 1px solid rgba(251,191,36,0.25); }
.de-check-row { display: flex; align-items: center; gap: 10px; padding: 9px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
.de-check-row:last-child { border-bottom: none; }
.de-check-icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; flex-shrink: 0; font-weight: 700; }
.de-check-icon.pass { background: rgba(74,222,128,0.15); color: var(--green); }
.de-check-icon.fail { background: rgba(248,113,113,0.15); color: var(--red); }
.de-check-icon.warn { background: rgba(251,191,36,0.15); color: var(--yellow); }
.de-input-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 110px; }
.de-input-group label { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.06em; }
.de-input { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius2); color: var(--text); font-family: var(--font-mono); font-size: 14px; padding: 9px 12px; outline: none; width: 100%; }
.de-input:focus { border-color: var(--accent); }
.de-input-select { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius2); color: var(--text); font-family: var(--font-body); font-size: 13px; padding: 9px 12px; outline: none; width: 100%; cursor: pointer; }
.ai-analysis-box { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; min-height: 100px; font-size: 13px; color: var(--text2); line-height: 1.9; }
.ai-badge { display: inline-flex; align-items: center; gap: 5px; background: linear-gradient(135deg,rgba(124,109,250,0.2),rgba(34,211,238,0.1)); border: 1px solid rgba(124,109,250,0.3); border-radius: 20px; padding: 3px 10px; font-size: 10px; font-weight: 700; color: var(--accent2); letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 10px; }
@keyframes aiBlink { 0%,100%{opacity:0.2} 50%{opacity:1} }
.ai-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: aiBlink 1.2s infinite; display: inline-block; margin: 0 2px; }
.ai-dot:nth-child(2){animation-delay:.3s}.ai-dot:nth-child(3){animation-delay:.6s}
@media (max-width: 768px) {
  .ql-grid,.de-grid { grid-template-columns: 1fr; }
  .metric-trio { grid-template-columns: 1fr 1fr; }
  .factor-row { grid-template-columns: 90px 1fr 50px; }
}
</style>


<!-- ══ API SETTINGS OVERLAY ══ -->
<div id="apiSettingsOverlay" style="display:none;position:fixed;inset:0;z-index:600;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);backdrop-filter:blur(12px);padding:20px">
  <div style="background:var(--bg2);border:1px solid var(--border2);border-radius:16px;padding:28px;max-width:480px;width:100%;animation:fadeSlideUp 0.2s ease">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <div>
        <div style="font-family:var(--font-head);font-size:18px;font-weight:400">⚡ Live Data Config</div>
        <div style="font-size:12px;color:var(--text3);margin-top:3px">Connect free APIs for real-time prices, news & calendar</div>
      </div>
      <button onclick="closeApiSettings()" style="background:none;border:none;color:var(--text3);font-size:22px;cursor:pointer;line-height:1">×</button>
    </div>

    <!-- Status Row -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:20px">
      <div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center;border:1px solid rgba(74,222,128,0.25)">
        <div style="font-size:16px;margin-bottom:3px">₿</div>
        <div style="font-size:10px;font-weight:700;color:var(--green)">LIVE</div>
        <div style="font-size:9px;color:var(--text3)">Crypto · CoinGecko</div>
      </div>
      <div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center;border:1px solid rgba(74,222,128,0.25)">
        <div style="font-size:16px;margin-bottom:3px">💱</div>
        <div style="font-size:10px;font-weight:700;color:var(--green)">LIVE</div>
        <div style="font-size:9px;color:var(--text3)">Forex · Frankfurter</div>
      </div>
      <div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center;border:1px solid rgba(74,222,128,0.25)">
        <div style="font-size:16px;margin-bottom:3px">😨</div>
        <div style="font-size:10px;font-weight:700;color:var(--green)">LIVE</div>
        <div style="font-size:9px;color:var(--text3)">Fear &amp; Greed</div>
      </div>
    </div>

    <!-- Finnhub Key -->
    <div style="margin-bottom:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
        <label style="font-size:12px;font-weight:600;color:var(--text)">Finnhub API Key</label>
        <a href="https://finnhub.io/register" target="_blank" rel="noopener" style="font-size:11px;color:var(--accent2);text-decoration:none">Get free key →</a>
      </div>
      <input id="apiKeyFinnhub" type="text" placeholder="Paste your Finnhub key here (e.g. ck_xxx...)"
        style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);color:var(--text);font-family:var(--font-mono);font-size:12px;padding:10px 12px;outline:none;transition:border-color 0.2s;box-sizing:border-box"
        onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
      <div style="font-size:11px;color:var(--text3);margin-top:5px">Unlocks: Real-time stock quotes · Live news · Economic calendar · Earnings · Analyst ratings</div>
    </div>

    <!-- Alpha Vantage Key -->
    <div style="margin-bottom:20px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
        <label style="font-size:12px;font-weight:600;color:var(--text)">Alpha Vantage Key <span style="color:var(--text3);font-weight:400">(optional)</span></label>
        <a href="https://www.alphavantage.co/support/#api-key" target="_blank" rel="noopener" style="font-size:11px;color:var(--accent2);text-decoration:none">Get free key →</a>
      </div>
      <input id="apiKeyAV" type="text" placeholder="Paste your Alpha Vantage key (e.g. ABCDEFGHIJ...)"
        style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);color:var(--text);font-family:var(--font-mono);font-size:12px;padding:10px 12px;outline:none;transition:border-color 0.2s;box-sizing:border-box"
        onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
      <div style="font-size:11px;color:var(--text3);margin-top:5px">Unlocks: Technical indicators · Macro data (CPI, GDP, unemployment)</div>
    </div>

    <!-- How to get keys guide -->
    <div style="background:rgba(108,99,255,0.08);border:1px solid rgba(108,99,255,0.2);border-radius:var(--radius2);padding:12px;margin-bottom:18px;font-size:11px;color:var(--text3);line-height:1.7">
      <strong style="color:var(--accent2)">Quick Setup Guide:</strong><br>
      1. Go to <strong>finnhub.io/register</strong> → create free account → copy your API key<br>
      2. Paste it above → click Save → live data loads instantly<br>
      3. Free tier: 60 API calls/minute · No credit card needed
    </div>

    <div style="display:flex;gap:10px">
      <button onclick="clearApiKeys()" class="btn btn-ghost" style="flex:1;justify-content:center;color:var(--red);border-color:rgba(245,101,101,0.3)">🗑 Clear Keys</button>
      <button onclick="closeApiSettings()" class="btn btn-ghost" style="flex:1;justify-content:center">Cancel</button>
      <button onclick="saveApiKeys()" class="btn btn-primary" style="flex:2;justify-content:center;background:var(--green);border:none">⚡ Save & Activate</button>
    </div>
  </div>
</div>

<!-- ══ FLOATING TICKER STRIP ══ -->
<div id="floatingTicker">
  <div class="ft-label">
    <span class="ft-status-dot" id="ft-live-dot"></span>
    LIVE
  </div>
  <div class="ft-scroll-wrap">
    <div class="ft-track" id="ftTrack">
      <!-- JS populated -->
      <div class="ft-item"><span class="ft-sym">NIFTY 50</span><span class="ft-price">—</span><span class="ft-chg">—</span></div>
      <div class="ft-item"><span class="ft-sym">BTC</span><span class="ft-price">—</span><span class="ft-chg">—</span></div>
    </div>
  </div>
  <div class="ft-angel-badge" onclick="openAngelOneSetup()" title="Angel One status">
    <div class="ao-dot" id="ft-angel-dot"></div>
    <span id="ft-angel-label">Angel One</span>
  </div>
  <button class="ft-close" onclick="document.getElementById('floatingTicker').style.display='none';document.body.style.paddingBottom='0'" title="Hide ticker">×</button>
</div>

<!-- ══ ANGEL ONE SETUP OVERLAY ══ -->
<div id="angelOneOverlay">
  <div style="background:var(--bg2);border:1px solid rgba(255,140,0,0.3);border-radius:16px;padding:28px;max-width:520px;width:100%;animation:fadeSlideUp 0.2s ease;max-height:90vh;overflow-y:auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:42px;height:42px;background:linear-gradient(135deg,#ff8c00,#ff4500);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">🔶</div>
        <div>
          <div style="font-family:var(--font-head);font-size:18px">Angel One SmartAPI</div>
          <div style="font-size:11px;color:var(--text3);margin-top:2px">Live NSE/BSE feed via local Python bridge</div>
        </div>
      </div>
      <button onclick="closeAngelOneSetup()" style="background:none;border:none;color:var(--text3);font-size:22px;cursor:pointer">×</button>
    </div>

    <!-- Bridge Status -->
    <div id="ao-bridge-status" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:18px;font-size:12px;color:var(--text2)">
      <div style="display:flex;align-items:center;gap:8px">
        <div style="width:8px;height:8px;border-radius:50%;background:var(--red)" id="ao-ws-dot"></div>
        <span id="ao-ws-status-text">Python bridge not detected — run angel_bridge.py to connect</span>
      </div>
    </div>

    <div style="display:flex;flex-direction:column;gap:14px">
      <div>
        <label style="font-size:11px;font-weight:700;color:var(--text);text-transform:uppercase;letter-spacing:0.05em;display:block;margin-bottom:6px">Angel One Client Code</label>
        <input id="ao-client-code" type="text" placeholder="Your Angel One login ID" class="ao-form-input">
      </div>
      <div>
        <label style="font-size:11px;font-weight:700;color:var(--text);text-transform:uppercase;letter-spacing:0.05em;display:block;margin-bottom:6px">API Key</label>
        <input id="ao-api-key" type="text" placeholder="From smartapi.angelbroking.com → My Apps" class="ao-form-input">
      </div>
      <div>
        <label style="font-size:11px;font-weight:700;color:var(--text);text-transform:uppercase;letter-spacing:0.05em;display:block;margin-bottom:6px">TOTP Secret <span style="font-weight:400;color:var(--text3)">(base32 from QR code)</span></label>
        <input id="ao-totp-secret" type="password" placeholder="e.g. JBSWY3DPEHPK3PXP..." class="ao-form-input">
        <div style="font-size:10px;color:var(--text3);margin-top:4px">The base32 secret string shown when you set up TOTP in Angel One app → Settings → 2FA</div>
      </div>
      <div>
        <label style="font-size:11px;font-weight:700;color:var(--text);text-transform:uppercase;letter-spacing:0.05em;display:block;margin-bottom:6px">MPIN</label>
        <input id="ao-mpin" type="password" placeholder="Your 4-digit MPIN" class="ao-form-input">
      </div>
      <div>
        <label style="font-size:11px;font-weight:700;color:var(--text);text-transform:uppercase;letter-spacing:0.05em;display:block;margin-bottom:6px">Bridge Host <span style="font-weight:400;color:var(--text3)">(your Oracle VPS IP or domain)</span></label>
        <input id="ao-bridge-host" type="text" placeholder="e.g. 152.67.x.x or yourdomain.com" class="ao-form-input">
        <div style="font-size:10px;color:var(--text3);margin-top:4px">Leave blank to use localhost (local PC mode)</div>
      </div>
      <div>
        <label style="font-size:11px;font-weight:700;color:var(--text);text-transform:uppercase;letter-spacing:0.05em;display:block;margin-bottom:6px">Bridge Port <span style="font-weight:400;color:var(--text3)">(default: 8765)</span></label>
        <input id="ao-bridge-port" type="number" value="8765" class="ao-form-input">
      </div>
    </div>

    <!-- Info box -->
    <div style="background:rgba(108,99,255,0.08);border:1px solid rgba(108,99,255,0.2);border-radius:8px;padding:12px;margin:16px 0;font-size:11px;color:var(--text3);line-height:1.7">
      <strong style="color:var(--accent2)">How it works:</strong><br>
      1. Save credentials → Download <strong>angel_bridge.py</strong> below<br>
      2. Install: <code style="background:var(--bg4);padding:1px 5px;border-radius:3px">pip install smartapi-python websockets pyotp</code><br>
      3. Run: <code style="background:var(--bg4);padding:1px 5px;border-radius:3px">python angel_bridge.py</code> — keep it running in background<br>
      4. This journal auto-connects via WebSocket on localhost:8765<br>
      <br><strong style="color:var(--yellow)">⚠ Security:</strong> Credentials stored locally in your browser only. Never sent to any server.
    </div>

    <div style="display:flex;gap:10px">
      <button onclick="clearAngelOneCreds()" class="btn btn-ghost" style="flex:1;justify-content:center;color:var(--red);border-color:rgba(245,101,101,0.3)">🗑 Clear</button>
      <button onclick="downloadAngelBridge()" class="btn btn-ghost" style="flex:1;justify-content:center;color:var(--cyan);border-color:rgba(34,211,238,0.3)">⬇ Download Bridge</button>
      <button onclick="saveAngelOneCreds()" class="btn btn-primary" style="flex:2;justify-content:center">🔶 Save &amp; Connect</button>
    </div>
  </div>
</div>

</body>
</html>