name: Fetch NSE Market Data

on:
  schedule:
    # Every minute during IST market hours (Mon-Fri 03:30-10:00 UTC = 09:00-15:30 IST)
    - cron: '* 3-10 * * 1-5'
  workflow_dispatch:   # Allow manual trigger for testing

permissions:
  contents: write      # Needed to push data.json

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # No pip install needed â€” fetch_market.py uses only stdlib

      - name: Fetch market data
        env:
          AO_CLIENT_CODE:  ${{ secrets.AO_CLIENT_CODE }}
          AO_API_KEY:      ${{ secrets.AO_API_KEY }}
          AO_TOTP_SECRET:  ${{ secrets.AO_TOTP_SECRET }}
          AO_MPIN:         ${{ secrets.AO_MPIN }}
          GH_PAT:          ${{ secrets.GH_PAT }}
          GH_BRANCH:       main
        run: python fetch_market.py
